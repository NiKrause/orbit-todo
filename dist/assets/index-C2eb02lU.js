(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const gC="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(gC);let Gh=!1,mC=!1;function yC(){Gh=!0}yC();const Qp=1,Xp=2,kv=4,wC=8,bC=16,vC=1,EC=2,sr=Symbol(),SC="http://www.w3.org/1999/xhtml",Cv=!1;var m4=Array.isArray,_C=Array.prototype.indexOf,Pv=Array.from,Sm=Object.defineProperty,j2=Object.getOwnPropertyDescriptor,xC=Object.getOwnPropertyDescriptors,AC=Object.prototype,IC=Array.prototype,Dv=Object.getPrototypeOf;function TC(r){return r()}function _m(r){for(var e=0;e<r.length;e++)r[e]()}function kC(){var r,e,t=new Promise((n,s)=>{r=n,e=s});return{promise:t,resolve:r,reject:e}}const wn=2,Rv=4,Zp=8,Yh=16,Pi=32,Qh=64,Nv=128,gn=256,r1=512,Xt=1024,mn=2048,ec=4096,os=8192,Kl=16384,y4=32768,w4=65536,p8=1<<17,CC=1<<18,b4=1<<19,v4=1<<20,xm=1<<21,E4=1<<22,ya=1<<23,Gu=Symbol("$state"),S4=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function PC(){throw new Error("https://svelte.dev/e/await_outside_boundary")}function DC(r){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function RC(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function NC(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function OC(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function MC(r){throw new Error("https://svelte.dev/e/effect_orphan")}function LC(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function BC(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function $C(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function UC(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let FC=!1;function Ov(r){return r===this.v}function VC(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function Mv(r){return!VC(r,this.v)}let zt=null;function n1(r){zt=r}function KC(r,e=!1,t){zt={p:zt,c:null,e:null,s:r,x:null,l:Gh&&!e?{s:null,u:null,$:[]}:null}}function qC(r){var e=zt,t=e.e;if(t!==null){e.e=null;for(var n of t)zv(n)}return zt=e.p,{}}function ql(){return!Gh||zt!==null&&zt.l===null}const HC=new WeakMap;function zC(r){var e=ze;if(e===null)return He.f|=ya,r;if(e.f&y4)_4(r,e);else{if(!(e.f&Nv))throw!e.parent&&r instanceof Error&&Lv(r),r;e.b.error(r)}}function _4(r,e){for(;e!==null;){if(e.f&Nv)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r instanceof Error&&Lv(r),r}function Lv(r){const e=HC.get(r);e&&(Sm(r,"message",{value:e.message}),Sm(r,"stack",{value:e.stack}))}let s1=[];function WC(){var r=s1;s1=[],_m(r)}function Bv(r){s1.length===0&&queueMicrotask(WC),s1.push(r)}function jC(){for(var r=ze.b;r!==null&&!r.has_pending_snippet();)r=r.parent;return r===null&&PC(),r}function x4(r){var e=wn|mn,t=He!==null&&He.f&wn?He:null;return ze===null||t!==null&&t.f&gn?e|=gn:ze.f|=b4,{ctx:zt,deps:null,effects:null,equals:Ov,f:e,fn:r,reactions:null,rv:0,v:sr,wv:0,parent:t??ze,ac:null}}function GC(r,e){let t=ze;t===null&&RC();var n=t.b,s=void 0,i=fh(sr),o=null,a=!He;return oP(()=>{try{var c=r()}catch(g){c=Promise.reject(g)}var l=()=>c;s=o?.then(l,l)??Promise.resolve(c),o=s;var u=Yt,h=n.pending;a&&(n.update_pending_count(1),h||u.increment());const d=(g,m=void 0)=>{o=null,h||u.activate(),m?m!==S4&&(i.f|=ya,ph(i,m)):(i.f&ya&&(i.f^=ya),ph(i,g)),a&&(n.update_pending_count(-1),h||u.decrement()),Vv()};if(s.then(d,g=>d(null,g||"unknown")),u)return()=>{queueMicrotask(()=>u.neuter())}}),new Promise(c=>{function l(u){function h(){u===s?c(i):l(s)}u.then(h,h)}l(s)})}function $v(r){const e=x4(r);return e.equals=Mv,e}function Uv(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)tc(e[t])}}function YC(r){for(var e=r.parent;e!==null;){if(!(e.f&wn))return e;e=e.parent}return null}function A4(r){var e,t=ze;mo(YC(r));try{Uv(r),e=tE(r)}finally{mo(t)}return e}function Fv(r){var e=A4(r);if(r.equals(e)||(r.v=e,r.wv=Jv()),!Hl)if(ol!==null)ol.set(r,r.v);else{var t=(Ji||r.f&gn)&&r.deps!==null?ec:Xt;or(r,t)}}function QC(r,e,t){const n=ql()?x4:$v;if(e.length===0){t(r.map(n));return}var s=Yt,i=ze,o=XC(),a=jC();Promise.all(e.map(c=>GC(c))).then(c=>{s?.activate(),o();try{t([...r.map(n),...c])}catch(l){i.f&Kl||_4(l,i)}s?.deactivate(),Vv()}).catch(c=>{a.error(c)})}function XC(){var r=ze,e=He,t=zt;return function(){mo(r),Bs(e),n1(t)}}function Vv(){mo(null),Bs(null),n1(null)}const Vd=new Set;let Yt=null,ol=null,g8=new Set,Fu=[],I4=null,Am=!1;class T4{#e=new Map;#t=new Map;#r=new Set;#o=0;#a=null;#u=!1;#s=[];#h=[];#n=[];#c=[];#i=[];skipped_effects=new Set;#d(e){Fu=[];var t=null;if(Vd.size>1){t=new Map,ol=new Map;for(const[i,o]of this.#e)t.set(i,{v:i.v,wv:i.wv}),i.v=o;for(const i of Vd)if(i!==this)for(const[o,a]of i.#t)t.has(o)||(t.set(o,{v:o.v,wv:o.wv}),o.v=a)}for(const i of e)this.#l(i);if(this.#s.length===0&&this.#o===0){var n=this.#n,s=this.#c;this.#n=[],this.#c=[],this.#i=[],this.#f(),m8(n),m8(s),this.#a?.resolve()}else{for(const i of this.#n)or(i,Xt);for(const i of this.#c)or(i,Xt);for(const i of this.#i)or(i,Xt)}if(t){for(const[i,{v:o,wv:a}]of t)i.wv<=a&&(i.v=o);ol=null}for(const i of this.#s)Yu(i);for(const i of this.#h)Yu(i);this.#s=[],this.#h=[]}#l(e){e.f^=Xt;for(var t=e.first;t!==null;){var n=t.f,s=(n&(Pi|Qh))!==0,i=s&&(n&Xt)!==0,o=i||(n&os)!==0||this.skipped_effects.has(t);if(!o&&t.fn!==null){if(s)t.f^=Xt;else if(n&Rv)this.#c.push(t);else if(t0(t))if(n&E4){var a=t.b?.pending?this.#h:this.#s;a.push(t)}else t.f&Yh&&this.#i.push(t),Yu(t);var c=t.first;if(c!==null){t=c;continue}}var l=t.parent;for(t=t.next;t===null&&l!==null;)t=l.next,l=l.parent}}capture(e,t){this.#t.has(e)||this.#t.set(e,t),this.#e.set(e,e.v)}activate(){Yt=this}deactivate(){Yt=null;for(const e of g8)if(g8.delete(e),e(),Yt!==null)break}neuter(){this.#u=!0}flush(){Fu.length>0?this.flush_effects():this.#f(),Yt===this&&(this.#o===0&&Vd.delete(this),this.deactivate())}flush_effects(){var e=zc;Am=!0;try{var t=0;for(y8(!0);Fu.length>0;){if(t++>1e3){var n,s;ZC()}this.#d(Fu),wa.clear()}}finally{Am=!1,y8(e),I4=null}}#f(){if(!this.#u)for(const e of this.#r)e();this.#r.clear()}increment(){this.#o+=1}decrement(){if(this.#o-=1,this.#o===0){for(const e of this.#n)or(e,mn),co(e);for(const e of this.#c)or(e,mn),co(e);for(const e of this.#i)or(e,mn),co(e);this.#n=[],this.#c=[],this.flush()}else this.deactivate()}add_callback(e){this.#r.add(e)}settled(){return(this.#a??=kC()).promise}static ensure(e=!0){if(Yt===null){const t=Yt=new T4;Vd.add(Yt),e&&queueMicrotask(()=>{Yt===t&&t.flush()})}return Yt}}function ZC(){try{LC()}catch(r){_4(r,I4)}}function m8(r){var e=r.length;if(e!==0){for(var t=0;t<e;t++){var n=r[t];if(!(n.f&(Kl|os))&&t0(n)){var s=a1;if(Yu(n),n.deps===null&&n.first===null&&n.nodes_start===null&&(n.teardown===null&&n.ac===null?Yv(n):n.fn=null),a1>s&&n.f&v4)break}}for(;t<e;t+=1)co(r[t])}}function co(r){for(var e=I4=r;e.parent!==null;){e=e.parent;var t=e.f;if(Am&&e===ze&&t&Yh)return;if(t&(Qh|Pi)){if(!(t&Xt))return;e.f^=Xt}}Fu.push(e)}const wa=new Map;function fh(r,e){var t={f:0,v:r,reactions:null,equals:Ov,rv:0,wv:0};return t}function Ui(r,e){const t=fh(r);return uP(t),t}function Xi(r,e=!1,t=!0){const n=fh(r);return e||(n.equals=Mv),Gh&&t&&zt!==null&&zt.l!==null&&(zt.l.s??=[]).push(n),n}function At(r,e,t=!1){He!==null&&(!ks||He.f&p8)&&ql()&&He.f&(wn|Yh|E4|p8)&&!di?.includes(r)&&UC();let n=t?Vu(e):e;return ph(r,n)}function ph(r,e){if(!r.equals(e)){var t=r.v;Hl?wa.set(r,e):wa.set(r,t),r.v=e,T4.ensure().capture(r,t),r.f&wn&&(r.f&mn&&A4(r),or(r,r.f&gn?ec:Xt)),r.wv=Jv(),Kv(r,mn),ql()&&ze!==null&&ze.f&Xt&&!(ze.f&(Pi|Qh))&&(Cn===null?hP([r]):Cn.push(r))}return e}function G2(r){At(r,r.v+1)}function Kv(r,e){var t=r.reactions;if(t!==null)for(var n=ql(),s=t.length,i=0;i<s;i++){var o=t[i],a=o.f;a&mn||!n&&o===ze||(or(o,e),a&(Xt|gn)&&(a&wn?Kv(o,ec):co(o)))}}function Vu(r){if(typeof r!="object"||r===null||Gu in r)return r;const e=Dv(r);if(e!==AC&&e!==IC)return r;var t=new Map,n=m4(r),s=Ui(0),i=ba,o=a=>{if(ba===i)return a();var c=He,l=ba;Bs(null),b8(i);var u=a();return Bs(c),b8(l),u};return n&&t.set("length",Ui(r.length)),new Proxy(r,{defineProperty(a,c,l){(!("value"in l)||l.configurable===!1||l.enumerable===!1||l.writable===!1)&&BC();var u=t.get(c);return u===void 0?u=o(()=>{var h=Ui(l.value);return t.set(c,h),h}):At(u,l.value,!0),!0},deleteProperty(a,c){var l=t.get(c);if(l===void 0){if(c in a){const u=o(()=>Ui(sr));t.set(c,u),G2(s)}}else At(l,sr),G2(s);return!0},get(a,c,l){if(c===Gu)return r;var u=t.get(c),h=c in a;if(u===void 0&&(!h||j2(a,c)?.writable)&&(u=o(()=>{var g=Vu(h?a[c]:sr),m=Ui(g);return m}),t.set(c,u)),u!==void 0){var d=Le(u);return d===sr?void 0:d}return Reflect.get(a,c,l)},getOwnPropertyDescriptor(a,c){var l=Reflect.getOwnPropertyDescriptor(a,c);if(l&&"value"in l){var u=t.get(c);u&&(l.value=Le(u))}else if(l===void 0){var h=t.get(c),d=h?.v;if(h!==void 0&&d!==sr)return{enumerable:!0,configurable:!0,value:d,writable:!0}}return l},has(a,c){if(c===Gu)return!0;var l=t.get(c),u=l!==void 0&&l.v!==sr||Reflect.has(a,c);if(l!==void 0||ze!==null&&(!u||j2(a,c)?.writable)){l===void 0&&(l=o(()=>{var d=u?Vu(a[c]):sr,g=Ui(d);return g}),t.set(c,l));var h=Le(l);if(h===sr)return!1}return u},set(a,c,l,u){var h=t.get(c),d=c in a;if(n&&c==="length")for(var g=l;g<h.v;g+=1){var m=t.get(g+"");m!==void 0?At(m,sr):g in a&&(m=o(()=>Ui(sr)),t.set(g+"",m))}if(h===void 0)(!d||j2(a,c)?.writable)&&(h=o(()=>Ui(void 0)),At(h,Vu(l)),t.set(c,h));else{d=h.v!==sr;var b=o(()=>Vu(l));At(h,b)}var y=Reflect.getOwnPropertyDescriptor(a,c);if(y?.set&&y.set.call(u,l),!d){if(n&&typeof c=="string"){var _=t.get("length"),A=Number(c);Number.isInteger(A)&&A>=_.v&&At(_,A+1)}G2(s)}return!0},ownKeys(a){Le(s);var c=Reflect.ownKeys(a).filter(h=>{var d=t.get(h);return d===void 0||d.v!==sr});for(var[l,u]of t)u.v!==sr&&!(l in a)&&c.push(l);return c},setPrototypeOf(){$C()}})}var JC,eP,tP;function Jp(r=""){return document.createTextNode(r)}function i1(r){return eP.call(r)}function e0(r){return tP.call(r)}function gt(r,e){return i1(r)}function Kd(r,e){{var t=i1(r);return t instanceof Comment&&t.data===""?e0(t):t}}function Gt(r,e=1,t=!1){let n=r;for(;e--;)n=e0(n);return n}function rP(r){r.textContent=""}function qv(){return!1}function Hv(r){ze===null&&He===null&&MC(),He!==null&&He.f&gn&&ze===null&&OC(),Hl&&NC()}function nP(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function Do(r,e,t,n=!0){var s=ze;s!==null&&s.f&os&&(r|=os);var i={ctx:zt,deps:null,nodes_start:null,nodes_end:null,f:r|mn,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,transitions:null,wv:0,ac:null};if(t)try{Yu(i),i.f|=y4}catch(c){throw tc(i),c}else e!==null&&co(i);var o=t&&i.deps===null&&i.first===null&&i.nodes_start===null&&i.teardown===null&&(i.f&b4)===0;if(!o&&n&&(s!==null&&nP(i,s),He!==null&&He.f&wn)){var a=He;(a.effects??=[]).push(i)}return i}function sP(r){const e=Do(Zp,null,!1);return or(e,Xt),e.teardown=r,e}function Im(r){Hv();var e=ze.f,t=!He&&(e&Pi)!==0&&(e&y4)===0;if(t){var n=zt;(n.e??=[]).push(r)}else return zv(r)}function zv(r){return Do(Rv|v4,r,!1)}function iP(r){return Hv(),Do(Zp|v4,r,!0)}function oP(r){return Do(E4|b4,r,!0)}function aP(r,e=0){return Do(Zp|e,r,!0)}function Fo(r,e=[],t=[]){QC(e,t,n=>{Do(Zp,()=>r(...n.map(Le)),!0)})}function Wv(r,e=0){var t=Do(Yh|e,r,!0);return t}function o1(r,e=!0){return Do(Pi,r,!0,e)}function jv(r){var e=r.teardown;if(e!==null){const t=Hl,n=He;w8(!0),Bs(null);try{e.call(null)}finally{w8(t),Bs(n)}}}function Gv(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){t.ac?.abort(S4);var n=t.next;t.f&Qh?t.parent=null:tc(t,e),t=n}}function cP(r){for(var e=r.first;e!==null;){var t=e.next;e.f&Pi||tc(e),e=t}}function tc(r,e=!0){var t=!1;(e||r.f&CC)&&r.nodes_start!==null&&r.nodes_end!==null&&(lP(r.nodes_start,r.nodes_end),t=!0),Gv(r,e&&!t),c1(r,0),or(r,Kl);var n=r.transitions;if(n!==null)for(const i of n)i.stop();jv(r);var s=r.parent;s!==null&&s.first!==null&&Yv(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes_start=r.nodes_end=r.ac=null}function lP(r,e){for(;r!==null;){var t=r===e?null:e0(r);r.remove(),r=t}}function Yv(r){var e=r.parent,t=r.prev,n=r.next;t!==null&&(t.next=n),n!==null&&(n.prev=t),e!==null&&(e.first===r&&(e.first=n),e.last===r&&(e.last=t))}function Qv(r,e){var t=[];k4(r,t,!0),Xv(t,()=>{tc(r),e&&e()})}function Xv(r,e){var t=r.length;if(t>0){var n=()=>--t||e();for(var s of r)s.out(n)}else e()}function k4(r,e,t){if(!(r.f&os)){if(r.f^=os,r.transitions!==null)for(const o of r.transitions)(o.is_global||t)&&e.push(o);for(var n=r.first;n!==null;){var s=n.next,i=(n.f&w4)!==0||(n.f&Pi)!==0;k4(n,e,i?t:!1),n=s}}}function C4(r){Zv(r,!0)}function Zv(r,e){if(r.f&os){r.f^=os,r.f&Xt||(or(r,mn),co(r));for(var t=r.first;t!==null;){var n=t.next,s=(t.f&w4)!==0||(t.f&Pi)!==0;Zv(t,s?e:!1),t=n}if(r.transitions!==null)for(const i of r.transitions)(i.is_global||e)&&i.in()}}let zc=!1;function y8(r){zc=r}let Hl=!1;function w8(r){Hl=r}let He=null,ks=!1;function Bs(r){He=r}let ze=null;function mo(r){ze=r}let di=null;function uP(r){He!==null&&(di===null?di=[r]:di.push(r))}let Tr=null,on=0,Cn=null;function hP(r){Cn=r}let a1=1,gh=0,ba=gh;function b8(r){ba=r}let Ji=!1;function Jv(){return++a1}function t0(r){var e=r.f;if(e&mn)return!0;if(e&ec){var t=r.deps,n=(e&gn)!==0;if(t!==null){var s,i,o=(e&r1)!==0,a=n&&ze!==null&&!Ji,c=t.length;if((o||a)&&(ze===null||!(ze.f&Kl))){var l=r,u=l.parent;for(s=0;s<c;s++)i=t[s],(o||!i?.reactions?.includes(l))&&(i.reactions??=[]).push(l);o&&(l.f^=r1),a&&u!==null&&!(u.f&gn)&&(l.f^=gn)}for(s=0;s<c;s++)if(i=t[s],t0(i)&&Fv(i),i.wv>r.wv)return!0}(!n||ze!==null&&!Ji)&&or(r,Xt)}return!1}function eE(r,e,t=!0){var n=r.reactions;if(n!==null&&!di?.includes(r))for(var s=0;s<n.length;s++){var i=n[s];i.f&wn?eE(i,e,!1):e===i&&(t?or(i,mn):i.f&Xt&&or(i,ec),co(i))}}function tE(r){var e=Tr,t=on,n=Cn,s=He,i=Ji,o=di,a=zt,c=ks,l=ba,u=r.f;Tr=null,on=0,Cn=null,Ji=(u&gn)!==0&&(ks||!zc||He===null),He=u&(Pi|Qh)?null:r,di=null,n1(r.ctx),ks=!1,ba=++gh,r.ac!==null&&(r.ac.abort(S4),r.ac=null);try{r.f|=xm;var h=(0,r.fn)(),d=r.deps;if(Tr!==null){var g;if(c1(r,on),d!==null&&on>0)for(d.length=on+Tr.length,g=0;g<Tr.length;g++)d[on+g]=Tr[g];else r.deps=d=Tr;if(!Ji||u&wn&&r.reactions!==null)for(g=on;g<d.length;g++)(d[g].reactions??=[]).push(r)}else d!==null&&on<d.length&&(c1(r,on),d.length=on);if(ql()&&Cn!==null&&!ks&&d!==null&&!(r.f&(wn|ec|mn)))for(g=0;g<Cn.length;g++)eE(Cn[g],r);return s!==null&&s!==r&&(gh++,Cn!==null&&(n===null?n=Cn:n.push(...Cn))),r.f&ya&&(r.f^=ya),h}catch(m){return zC(m)}finally{r.f^=xm,Tr=e,on=t,Cn=n,He=s,Ji=i,di=o,n1(a),ks=c,ba=l}}function dP(r,e){let t=e.reactions;if(t!==null){var n=_C.call(t,r);if(n!==-1){var s=t.length-1;s===0?t=e.reactions=null:(t[n]=t[s],t.pop())}}t===null&&e.f&wn&&(Tr===null||!Tr.includes(e))&&(or(e,ec),e.f&(gn|r1)||(e.f^=r1),Uv(e),c1(e,0))}function c1(r,e){var t=r.deps;if(t!==null)for(var n=e;n<t.length;n++)dP(r,t[n])}function Yu(r){var e=r.f;if(!(e&Kl)){or(r,Xt);var t=ze,n=zc;ze=r,zc=!0;try{e&Yh?cP(r):Gv(r),jv(r);var s=tE(r);r.teardown=typeof s=="function"?s:null,r.wv=a1;var i;Cv&&mC&&r.f&mn&&r.deps}finally{zc=n,ze=t}}}function Le(r){var e=r.f,t=(e&wn)!==0;if(He!==null&&!ks){var n=ze!==null&&(ze.f&Kl)!==0;if(!n&&!di?.includes(r)){var s=He.deps;if(He.f&xm)r.rv<gh&&(r.rv=gh,Tr===null&&s!==null&&s[on]===r?on++:Tr===null?Tr=[r]:(!Ji||!Tr.includes(r))&&Tr.push(r));else{(He.deps??=[]).push(r);var i=r.reactions;i===null?r.reactions=[He]:i.includes(He)||i.push(He)}}}else if(t&&r.deps===null&&r.effects===null){var o=r,a=o.parent;a!==null&&!(a.f&gn)&&(o.f^=gn)}if(Hl){if(wa.has(r))return wa.get(r);if(t){o=r;var c=o.v;return(o.f&Xt||rE(o))&&(c=A4(o)),wa.set(o,c),c}}else if(t){if(o=r,ol?.has(o))return ol.get(o);t0(o)&&Fv(o)}if(r.f&ya)throw r.v;return r.v}function rE(r){if(r.v===sr)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(wa.has(e)||e.f&wn&&rE(e))return!0;return!1}function P4(r){var e=ks;try{return ks=!0,r()}finally{ks=e}}const fP=-7169;function or(r,e){r.f=r.f&fP|e}function pP(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(Gu in r)Tm(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&Gu in t&&Tm(t)}}}function Tm(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let n in r)try{Tm(r[n],e)}catch{}const t=Dv(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const n=xC(t);for(let s in n){const i=n[s].get;if(i)try{i.call(r)}catch{}}}}}let v8=!1;function gP(){v8||(v8=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function nE(r){var e=He,t=ze;Bs(null),mo(null);try{return r()}finally{Bs(e),mo(t)}}function mP(r,e,t,n=t){r.addEventListener(e,()=>nE(t));const s=r.__on_r;s?r.__on_r=()=>{s(),n(!0)}:r.__on_r=()=>n(!0),gP()}function yP(r,e,t,n={}){function s(i){if(n.capture||wP.call(e,i),!i.cancelBubble)return nE(()=>t?.call(this,i))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?Bv(()=>{e.addEventListener(r,s,n)}):e.addEventListener(r,s,n),s}function wu(r,e,t,n,s){var i={capture:n,passive:s},o=yP(r,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&sP(()=>{e.removeEventListener(r,o,i)})}function wP(r){var e=this,t=e.ownerDocument,n=r.type,s=r.composedPath?.()||[],i=s[0]||r.target,o=0,a=r.__root;if(a){var c=s.indexOf(a);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var l=s.indexOf(e);if(l===-1)return;c<=l&&(o=c)}if(i=s[o]||r.target,i!==e){Sm(r,"currentTarget",{configurable:!0,get(){return i||t}});var u=He,h=ze;Bs(null),mo(null);try{for(var d,g=[];i!==null;){var m=i.assignedSlot||i.parentNode||i.host||null;try{var b=i["__"+n];if(b!=null&&(!i.disabled||r.target===i))if(m4(b)){var[y,..._]=b;y.apply(i,[r,..._])}else b.call(i,r)}catch(A){d?g.push(A):d=A}if(r.cancelBubble||m===e||m===null)break;i=m}if(d){for(let A of g)queueMicrotask(()=>{throw A});throw d}}finally{r.__root=e,delete r.currentTarget,Bs(u),mo(h)}}}function bP(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function km(r,e){var t=ze;t.nodes_start===null&&(t.nodes_start=r,t.nodes_end=e)}function Ir(r,e){var t=(e&vC)!==0,n=(e&EC)!==0,s,i=!r.startsWith("<!>");return()=>{s===void 0&&(s=bP(i?r:"<!>"+r),t||(s=i1(s)));var o=n||JC?document.importNode(s,!0):s.cloneNode(!0);if(t){var a=i1(o),c=o.lastChild;km(a,c)}else km(o,o);return o}}function vP(){var r=document.createDocumentFragment(),e=document.createComment(""),t=Jp();return r.append(e,t),km(e,t),r}function er(r,e){r!==null&&r.before(e)}function js(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??=r.nodeValue)&&(r.__t=t,r.nodeValue=t+"")}function EP(r){zt===null&&DC(),Gh&&zt.l!==null?SP(zt).m.push(r):Im(()=>{const e=P4(r);if(typeof e=="function")return e})}function SP(r){var e=r.l;return e.u??={a:[],b:[],m:[]}}function Vo(r,e,t=!1){var n=r,s=null,i=null,o=sr,a=t?w4:0,c=!1;const l=(g,m=!0)=>{c=!0,d(m,g)};var u=null;function h(){u!==null&&(u.lastChild.remove(),n.before(u),u=null);var g=o?s:i,m=o?i:s;g&&C4(g),m&&Qv(m,()=>{o?i=null:s=null})}const d=(g,m)=>{if(o!==(o=g)){var b=qv(),y=n;if(b&&(u=document.createDocumentFragment(),u.append(y=Jp())),o?s??=m&&o1(()=>m(y)):i??=m&&o1(()=>m(y)),b){var _=Yt,A=o?s:i,R=o?i:s;A&&_.skipped_effects.delete(A),R&&_.skipped_effects.add(R),_.add_callback(h)}else h()}};Wv(()=>{c=!1,e(l),c||d(null,null)},a)}function Y2(r,e){return e}function _P(r,e,t){for(var n=r.items,s=[],i=e.length,o=0;o<i;o++)k4(e[o].e,s,!0);var a=i>0&&s.length===0&&t!==null;if(a){var c=t.parentNode;rP(c),c.append(t),n.clear(),Ss(r,e[0].prev,e[i-1].next)}Xv(s,()=>{for(var l=0;l<i;l++){var u=e[l];a||(n.delete(u.k),Ss(r,u.prev,u.next)),tc(u.e,!a)}})}function Q2(r,e,t,n,s,i=null){var o=r,a={flags:e,items:new Map,first:null},c=(e&kv)!==0;if(c){var l=r;o=l.appendChild(Jp())}var u=null,h=!1,d=new Map,g=$v(()=>{var _=t();return m4(_)?_:_==null?[]:Pv(_)}),m,b;function y(){xP(b,m,a,d,o,s,e,n,t),i!==null&&(m.length===0?u?C4(u):u=o1(()=>i(o)):u!==null&&Qv(u,()=>{u=null}))}Wv(()=>{b??=ze,m=Le(g);var _=m.length;if(!(h&&_===0)){h=_===0;var A,R,I,T;if(qv()){var k=new Set,D=Yt;for(R=0;R<_;R+=1){I=m[R],T=n(I,R);var F=a.items.get(T)??d.get(T);F?e&(Qp|Xp)&&sE(F,I,R,e):(A=iE(null,a,null,null,I,T,R,s,e,t,!0),d.set(T,A)),k.add(T)}for(const[O,C]of a.items)k.has(O)||D.skipped_effects.add(C.e);D.add_callback(y)}else y();Le(g)}})}function xP(r,e,t,n,s,i,o,a,c){var l=(o&wC)!==0,u=(o&(Qp|Xp))!==0,h=e.length,d=t.items,g=t.first,m=g,b,y=null,_,A=[],R=[],I,T,k,D;if(l)for(D=0;D<h;D+=1)I=e[D],T=a(I,D),k=d.get(T),k!==void 0&&(k.a?.measure(),(_??=new Set).add(k));for(D=0;D<h;D+=1){if(I=e[D],T=a(I,D),k=d.get(T),k===void 0){var F=n.get(T);if(F!==void 0){n.delete(T),d.set(T,F);var O=y?y.next:m;Ss(t,y,F),Ss(t,F,O),X2(F,O,s),y=F}else{var C=m?m.e.nodes_start:s;y=iE(C,t,y,y===null?t.first:y.next,I,T,D,i,o,c)}d.set(T,y),A=[],R=[],m=y.next;continue}if(u&&sE(k,I,D,o),k.e.f&os&&(C4(k.e),l&&(k.a?.unfix(),(_??=new Set).delete(k))),k!==m){if(b!==void 0&&b.has(k)){if(A.length<R.length){var N=R[0],P;y=N.prev;var M=A[0],K=A[A.length-1];for(P=0;P<A.length;P+=1)X2(A[P],N,s);for(P=0;P<R.length;P+=1)b.delete(R[P]);Ss(t,M.prev,K.next),Ss(t,y,M),Ss(t,K,N),m=N,y=K,D-=1,A=[],R=[]}else b.delete(k),X2(k,m,s),Ss(t,k.prev,k.next),Ss(t,k,y===null?t.first:y.next),Ss(t,y,k),y=k;continue}for(A=[],R=[];m!==null&&m.k!==T;)m.e.f&os||(b??=new Set).add(m),R.push(m),m=m.next;if(m===null)continue;k=m}A.push(k),y=k,m=k.next}if(m!==null||b!==void 0){for(var H=b===void 0?[]:Pv(b);m!==null;)m.e.f&os||H.push(m),m=m.next;var $=H.length;if($>0){var B=o&kv&&h===0?s:null;if(l){for(D=0;D<$;D+=1)H[D].a?.measure();for(D=0;D<$;D+=1)H[D].a?.fix()}_P(t,H,B)}}l&&Bv(()=>{if(_!==void 0)for(k of _)k.a?.apply()}),r.first=t.first&&t.first.e,r.last=y&&y.e;for(var z of n.values())tc(z.e);n.clear()}function sE(r,e,t,n){n&Qp&&ph(r.v,e),n&Xp?ph(r.i,t):r.i=t}function iE(r,e,t,n,s,i,o,a,c,l,u){var h=(c&Qp)!==0,d=(c&bC)===0,g=h?d?Xi(s,!1,!1):fh(s):s,m=c&Xp?fh(o):o,b={i:m,v:g,k:i,a:null,e:null,prev:t,next:n};try{if(r===null){var y=document.createDocumentFragment();y.append(r=Jp())}return b.e=o1(()=>a(r,g,m,l),FC),b.e.prev=t&&t.e,b.e.next=n&&n.e,t===null?u||(e.first=b):(t.next=b,t.e.next=b.e),n!==null&&(n.prev=b,n.e.prev=b.e),b}finally{}}function X2(r,e,t){for(var n=r.next?r.next.e.nodes_start:t,s=e?e.e.nodes_start:t,i=r.e.nodes_start;i!==null&&i!==n;){var o=e0(i);s.before(i),i=o}}function Ss(r,e,t){e===null?r.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}function oE(r){var e,t,n="";if(typeof r=="string"||typeof r=="number")n+=r;else if(typeof r=="object")if(Array.isArray(r)){var s=r.length;for(e=0;e<s;e++)r[e]&&(t=oE(r[e]))&&(n&&(n+=" "),n+=t)}else for(t in r)r[t]&&(n&&(n+=" "),n+=t);return n}function AP(){for(var r,e,t=0,n="",s=arguments.length;t<s;t++)(r=arguments[t])&&(e=oE(r))&&(n&&(n+=" "),n+=e);return n}function IP(r){return typeof r=="object"?AP(r):r??""}function TP(r,e,t){var n=r==null?"":""+r;return n===""?null:n}function kP(r,e,t,n,s,i){var o=r.__className;if(o!==t||o===void 0){var a=TP(t);a==null?r.removeAttribute("class"):r.className=a,r.__className=t}return i}const CP=Symbol("is custom element"),PP=Symbol("is html");function DP(r,e){var t=RP(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function RP(r){return r.__attributes??={[CP]:r.nodeName.includes("-"),[PP]:r.namespaceURI===SC}}function E8(r,e,t=e){var n=ql(),s=new WeakSet;mP(r,"input",i=>{var o=i?r.defaultValue:r.value;if(o=Z2(r)?J2(o):o,t(o),Yt!==null&&s.add(Yt),n&&o!==(o=e())){var a=r.selectionStart,c=r.selectionEnd;r.value=o??"",c!==null&&(r.selectionStart=a,r.selectionEnd=Math.min(c,r.value.length))}}),P4(e)==null&&r.value&&(t(Z2(r)?J2(r.value):r.value),Yt!==null&&s.add(Yt)),aP(()=>{var i=e();r===document.activeElement&&s.has(Yt)||Z2(r)&&i===J2(r.value)||r.type==="date"&&!i&&!r.value||i!==r.value&&(r.value=i??"")})}function Z2(r){var e=r.type;return e==="number"||e==="range"}function J2(r){return r===""?null:+r}function NP(r=!1){const e=zt,t=e.l.u;if(!t)return;let n=()=>pP(e.s);if(r){let s=0,i={};const o=x4(()=>{let a=!1;const c=e.s;for(const l in c)c[l]!==i[l]&&(i[l]=c[l],a=!0);return a&&s++,s});n=()=>Le(o)}t.b.length&&iP(()=>{S8(e,n),_m(t.b)}),Im(()=>{const s=P4(()=>t.m.map(TC));return()=>{for(const i of s)typeof i=="function"&&i()}}),t.a.length&&Im(()=>{S8(e,n),_m(t.a)})}function S8(r,e){if(r.l.s)for(const t of r.l.s)Le(t);e()}const OP=Symbol.for("@libp2p/connection"),al=Symbol.for("@libp2p/content-routing"),mh=Symbol.for("@libp2p/peer-discovery"),D4=Symbol.for("@libp2p/peer-id");function va(r){return!!r?.[D4]}const cl=Symbol.for("@libp2p/peer-routing"),r0="keep-alive",l1="StrictSign",R4="StrictNoSign";var On;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(On||(On={}));const n0=Symbol.for("@libp2p/transport");var yh;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(yh||(yh={}));let wi=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class MP extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let LP=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},te=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class u1 extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class aE extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class BP extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class cE extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class lE extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Bc extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class $P extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class Cm extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}let Ut=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class uE extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let N4=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class UP extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class O4 extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class s0 extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class mt extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}class FP extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}let Xh=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class ll extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class Qu extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class Pm extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class hE extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class VP extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class M4 extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class zl extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class Tt extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function L4(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function bi(...r){const e=[];for(const t of r)L4(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Ro(...r){const e=[];for(const t of r)L4(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const Jt=Symbol.for("@libp2p/service-capabilities"),yo=Symbol.for("@libp2p/service-dependencies");function KP(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Wl(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function qP(r){return new TextEncoder().encode(r)}function HP(r){return new TextDecoder().decode(r)}function zP(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var b=0,y=0,_=0,A=m.length;_!==A&&m[_]===0;)_++,b++;for(var R=(A-_)*u+1>>>0,I=new Uint8Array(R);_!==A;){for(var T=m[_],k=0,D=R-1;(T!==0||k<y)&&D!==-1;D--,k++)T+=256*I[D]>>>0,I[D]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");y=k,_++}for(var F=R-y;F!==R&&I[F]===0;)F++;for(var O=c.repeat(b);F<R;++F)O+=r.charAt(I[F]);return O}function d(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var b=0;if(m[b]!==" "){for(var y=0,_=0;m[b]===c;)y++,b++;for(var A=(m.length-b)*l+1>>>0,R=new Uint8Array(A);m[b];){var I=t[m.charCodeAt(b)];if(I===255)return;for(var T=0,k=A-1;(I!==0||T<_)&&k!==-1;k--,T++)I+=a*R[k]>>>0,R[k]=I%256>>>0,I=I/256>>>0;if(I!==0)throw new Error("Non-zero carry");_=T,b++}if(m[b]!==" "){for(var D=A-_;D!==A&&R[D]===0;)D++;for(var F=new Uint8Array(y+(A-D)),O=y;D!==A;)F[O++]=R[D++];return F}}}function g(m){var b=d(m);if(b)return b;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:d,decode:g}}var WP=zP,jP=WP;let GP=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},YP=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return dE(this,e)}},QP=class{decoders;constructor(e){this.decoders=e}or(e){return dE(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function dE(r,e){return new QP({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let XP=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new GP(e,t,n),this.decoder=new YP(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function i0({name:r,prefix:e,encode:t,decode:n}){return new XP(r,e,t,n)}function Zh({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=jP(t,r);return i0({prefix:e,name:r,encode:n,decode:i=>Wl(s(i))})}function ZP(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,a=0,c=0;for(let l=0;l<s;++l){const u=e[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|u,o+=t,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return i}function JP(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o!==0&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i}function eD(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function fr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=eD(n);return i0({prefix:e,name:r,encode(i){return JP(i,n,t)},decode(i){return ZP(i,s,t,r)}})}const $t=Zh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),tD=Zh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),rD=Object.freeze(Object.defineProperty({__proto__:null,base58btc:$t,base58flickr:tD},Symbol.toStringTag,{value:"Module"})),hn=fr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),nD=fr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),sD=fr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),iD=fr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),oD=fr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),aD=fr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),cD=fr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),lD=fr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),uD=fr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),hD=Object.freeze(Object.defineProperty({__proto__:null,base32:hn,base32hex:oD,base32hexpad:cD,base32hexpadupper:lD,base32hexupper:aD,base32pad:sD,base32padupper:iD,base32upper:nD,base32z:uD},Symbol.toStringTag,{value:"Module"})),Ea=Zh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),dD=Zh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),fD=Object.freeze(Object.defineProperty({__proto__:null,base36:Ea,base36upper:dD},Symbol.toStringTag,{value:"Module"}));var pD=fE,_8=128,gD=-128,mD=Math.pow(2,31);function fE(r,e,t){e=e||[],t=t||0;for(var n=t;r>=mD;)e[t++]=r&255|_8,r/=128;for(;r&gD;)e[t++]=r&255|_8,r>>>=7;return e[t]=r|0,fE.bytes=t-n+1,e}var yD=Dm,wD=128,x8=127;function Dm(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Dm.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&x8)<<s:(o&x8)*Math.pow(2,s),s+=7}while(o>=wD);return Dm.bytes=i-n,t}var bD=Math.pow(2,7),vD=Math.pow(2,14),ED=Math.pow(2,21),SD=Math.pow(2,28),_D=Math.pow(2,35),xD=Math.pow(2,42),AD=Math.pow(2,49),ID=Math.pow(2,56),TD=Math.pow(2,63),kD=function(r){return r<bD?1:r<vD?2:r<ED?3:r<SD?4:r<_D?5:r<xD?6:r<AD?7:r<ID?8:r<TD?9:10},CD={encode:pD,decode:yD,encodingLength:kD},h1=CD;function Rm(r,e=0){return[h1.decode(r,e),h1.decode.bytes]}function d1(r,e,t=0){return h1.encode(r,e,t),e}function f1(r){return h1.encodingLength(r)}function vi(r,e){const t=e.byteLength,n=f1(r),s=n+f1(t),i=new Uint8Array(s+t);return d1(r,i,0),d1(t,i,n),i.set(e,s),new B4(r,t,e,i)}function pr(r){const e=Wl(r),[t,n]=Rm(e),[s,i]=Rm(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new B4(t,s,o,e)}function PD(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&KP(r.bytes,t.bytes)}}let B4=class{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function A8(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return RD(t,Nm(r),e??$t.encoder);default:return ND(t,Nm(r),e??hn.encoder)}}const I8=new WeakMap;function Nm(r){const e=I8.get(r);if(e==null){const t=new Map;return I8.set(r,t),t}return e}let Ne=class mr{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==bu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==OD)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return mr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=vi(e,t);return mr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return mr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&PD(e.multihash,n.multihash)}toString(e){return A8(this,e)}toJSON(){return{"/":A8(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof mr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new mr(n,s,i,o??T8(n,s,i.bytes))}else if(t[MD]===!0){const{version:n,multihash:s,code:i}=t,o=pr(s);return mr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==bu)throw new Error(`Version 0 CID must use dag-pb (code: ${bu}) block encoding`);return new mr(e,t,n,n.bytes)}case 1:{const s=T8(e,t,n.bytes);return new mr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return mr.create(0,bu,e)}static createV1(e,t){return mr.create(1,e,t)}static decode(e){const[t,n]=mr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=mr.inspectBytes(e),n=t.size-t.multihashSize,s=Wl(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new B4(t.multihashCode,t.digestSize,i,s);return[t.version===0?mr.createV0(o):mr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,d]=Rm(e.subarray(t));return t+=d,h};let s=n(),i=bu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){const[n,s]=DD(e,t),i=mr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Nm(i).set(n,e),i}};function DD(r,e){switch(r[0]){case"Q":{const t=e??$t;return[$t.prefix,t.decode(`${$t.prefix}${r}`)]}case $t.prefix:{const t=e??$t;return[$t.prefix,t.decode(r)]}case hn.prefix:{const t=e??hn;return[hn.prefix,t.decode(r)]}case Ea.prefix:{const t=e??Ea;return[Ea.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function RD(r,e,t){const{prefix:n}=t;if(n!==$t.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function ND(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const bu=112,OD=18;function T8(r,e,t){const n=f1(r),s=n+f1(e),i=new Uint8Array(s+t.byteLength);return d1(r,i,0),d1(e,i,n),i.set(t,s),i}const MD=Symbol.for("@ipld/js-cid/CID"),pE=0,LD="identity",gE=Wl;function BD(r){return vi(pE,gE(r))}const wo={code:pE,name:LD,encode:gE,digest:BD};function $e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Be(r=0){return new Uint8Array(r)}function xr(r=0){return new Uint8Array(r)}function Rr(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=xr(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const mE=Symbol.for("@achingbrain/uint8arraylist");function k8(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Ku(r){return!!r?.[mE]}class Pe{bufs;length;[mE]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Ku(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Ku(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=k8(this.bufs,e);return t.buf[t.index]}set(e,t){const n=k8(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Ku(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return Rr(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:Rr(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Pe;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(o);break}const h=e-a;n.push(o.subarray(h,h+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(u){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Ku(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let h=0;h<i;h++)o[h]=-1;for(let h=0;h<s;h++)o[n[h]]=h;const a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1;let u;for(let h=t;h<=c;h+=u){u=0;for(let d=l;d>=0;d--){const g=this.get(h+d);if(n[d]!==g){u=Math.max(1,d-a[g]);break}}if(u===0)return h}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=xr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=Be(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=Be(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=Be(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=xr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=Be(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=Be(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=Be(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=Be(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=Be(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Pe)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!$e(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Pe;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const $D=Zh({prefix:"9",name:"base10",alphabet:"0123456789"}),UD=Object.freeze(Object.defineProperty({__proto__:null,base10:$D},Symbol.toStringTag,{value:"Module"})),FD=fr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),VD=fr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),KD=Object.freeze(Object.defineProperty({__proto__:null,base16:FD,base16upper:VD},Symbol.toStringTag,{value:"Module"})),qD=fr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),HD=Object.freeze(Object.defineProperty({__proto__:null,base2:qD},Symbol.toStringTag,{value:"Module"})),yE=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),zD=yE.reduce((r,e,t)=>(r[t]=e,r),[]),WD=yE.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function jD(r){return r.reduce((e,t)=>(e+=zD[t],e),"")}function GD(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=WD[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const YD=i0({prefix:"🚀",name:"base256emoji",encode:jD,decode:GD}),QD=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:YD},Symbol.toStringTag,{value:"Module"})),$n=fr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),XD=fr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Jh=fr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ZD=fr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),JD=Object.freeze(Object.defineProperty({__proto__:null,base64:$n,base64pad:XD,base64url:Jh,base64urlpad:ZD},Symbol.toStringTag,{value:"Module"})),eR=fr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),tR=Object.freeze(Object.defineProperty({__proto__:null,base8:eR},Symbol.toStringTag,{value:"Module"})),rR=i0({prefix:"\0",name:"identity",encode:r=>HP(r),decode:r=>qP(r)}),nR=Object.freeze(Object.defineProperty({__proto__:null,identity:rR},Symbol.toStringTag,{value:"Module"})),sR=new TextEncoder,iR=new TextDecoder,oR="json",wE=512;function aR(r){return sR.encode(JSON.stringify(r))}function cR(r){return JSON.parse(iR.decode(r))}const lR=Object.freeze(Object.defineProperty({__proto__:null,code:wE,decode:cR,encode:aR,name:oR},Symbol.toStringTag,{value:"Module"})),uR="raw",o0=85;function hR(r){return Wl(r)}function dR(r){return Wl(r)}const fR=Object.freeze(Object.defineProperty({__proto__:null,code:o0,decode:dR,encode:hR,name:uR},Symbol.toStringTag,{value:"Module"}));function bE({name:r,code:e,encode:t}){return new pR(r,e,t)}let pR=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?vi(this.code,t):t.then(n=>vi(this.code,n))}else throw Error("Unknown type, must be binary type")}};function vE(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const Qr=bE({name:"sha2-256",code:18,encode:vE("SHA-256")}),C8=bE({name:"sha2-512",code:19,encode:vE("SHA-512")}),p1={...nR,...HD,...tR,...UD,...KD,...hD,...fD,...rD,...JD,...QD};function EE(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const P8=EE("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),eg=EE("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=xr(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),SE={utf8:P8,"utf-8":P8,hex:p1.base16,latin1:eg,ascii:eg,binary:eg,...p1};function ne(r,e="utf8"){const t=SE[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function re(r,e="utf8"){const t=SE[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const gR=parseInt("11111",2),Om=parseInt("10000000",2),mR=parseInt("01111111",2),D8={0:vu,1:vu,2:yR,3:vR,4:ER,5:bR,6:wR,16:vu,22:vu,48:vu};function No(r,e={offset:0}){const t=r[e.offset]&gR;if(e.offset++,D8[t]!=null)return D8[t](r,e);throw new Error("No decoder for tag "+t)}function ed(r,e){let t=0;if((r[e.offset]&Om)===Om){const n=r[e.offset]&mR;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function vu(r,e){ed(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=No(r,e);if(n===null)break;t.push(n)}return t}function yR(r,e){const t=ed(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function wR(r,e){const t=ed(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let h=0;h<c.length;h++)u+=c[h]<<h*7;a+=`.${u}`,c=[]}}return a}function bR(r,e){return e.offset++,null}function vR(r,e){const t=ed(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function ER(r,e){const t=ed(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function SR(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Pe;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function a0(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=SR(r.byteLength);return new Pe(Uint8Array.from([e.byteLength|Om]),e)}function cn(r){const e=new Pe,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Pe(Uint8Array.from([2]),a0(e),e)}function $4(r){const e=Uint8Array.from([0]),t=new Pe(e,r);return new Pe(Uint8Array.from([3]),a0(t),t)}function _R(r){return new Pe(Uint8Array.from([4]),a0(r),r)}function fi(r,e=48){const t=new Pe;for(const n of r)t.append(n);return new Pe(Uint8Array.from([e]),a0(t),t)}const _E="1.2.840.10045.3.1.7",xE="1.3.132.0.34",AE="1.3.132.0.35";async function xR(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function AR(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function IR(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const TR=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),kR=Uint8Array.from([6,5,43,129,4,0,34]),CR=Uint8Array.from([6,5,43,129,4,0,35]),IE={ext:!0,kty:"EC",crv:"P-256"},TE={ext:!0,kty:"EC",crv:"P-384"},kE={ext:!0,kty:"EC",crv:"P-521"},Wc=32,jc=48,Gc=66;function PR(r){const e=No(r);return CE(e)}function CE(r){const e=r[1],t=re(e,"base64url"),n=r[2][1][0],s=1;let i,o;if(e.byteLength===Wc)return i=re(n.subarray(s,s+Wc),"base64url"),o=re(n.subarray(s+Wc),"base64url"),new Vf({...IE,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===jc)return i=re(n.subarray(s,s+jc),"base64url"),o=re(n.subarray(s+jc),"base64url"),new Vf({...TE,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Gc)return i=re(n.subarray(s,s+Gc),"base64url"),o=re(n.subarray(s+Gc),"base64url"),new Vf({...kE,key_ops:["sign"],d:t,x:i,y:o});throw new te(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function PE(r){const e=No(r);return DE(e)}function DE(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===Wc*2+1)return n=re(e.subarray(t,t+Wc),"base64url"),s=re(e.subarray(t+Wc),"base64url"),new Ff({...IE,key_ops:["verify"],x:n,y:s});if(e.byteLength===jc*2+1)return n=re(e.subarray(t,t+jc),"base64url"),s=re(e.subarray(t+jc),"base64url"),new Ff({...TE,key_ops:["verify"],x:n,y:s});if(e.byteLength===Gc*2+1)return n=re(e.subarray(t,t+Gc),"base64url"),s=re(e.subarray(t+Gc),"base64url"),new Ff({...kE,key_ops:["verify"],x:n,y:s});throw new te(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function DR(r){return fi([cn(Uint8Array.from([1])),_R(ne(r.d??"","base64url")),fi([RE(r.crv)],160),fi([$4(new Pe(Uint8Array.from([4]),ne(r.x??"","base64url"),ne(r.y??"","base64url")))],161)]).subarray()}function RR(r){return fi([cn(Uint8Array.from([1])),fi([RE(r.crv)],160),fi([$4(new Pe(Uint8Array.from([4]),ne(r.x??"","base64url"),ne(r.y??"","base64url")))],161)]).subarray()}function RE(r){if(r==="P-256")return TR;if(r==="P-384")return kR;if(r==="P-521")return CR;throw new te(`Invalid curve ${r}`)}async function NR(r="P-256"){const e=await xR(r);return new Vf(e.privateKey)}class Ff{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=RR(this.jwk)),this._raw}toMultihash(){return wo.digest(yn(this))}toCID(){return Ne.createV1(114,this.toMultihash())}toString(){return $t.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}async verify(e,t,n){return IR(this.jwk,t,e,n)}}class Vf{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new Ff({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=DR(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}async sign(e,t){return AR(this.jwk,e,t)}}const vc=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function g1(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Sa(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Xr(r,...e){if(!g1(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function td(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Sa(r.outputLen),Sa(r.blockLen)}function m1(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function OR(r,e){Xr(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function $s(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Xu(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function ms(r,e){return r<<32-e|r>>>e}function tg(r,e){return r<<e|r>>>32-e>>>0}const NE=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",MR=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function _a(r){if(Xr(r),NE)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=MR[r[t]];return e}const Gs={_0:48,_9:57,A:65,F:70,a:97,f:102};function R8(r){if(r>=Gs._0&&r<=Gs._9)return r-Gs._0;if(r>=Gs.A&&r<=Gs.F)return r-(Gs.A-10);if(r>=Gs.a&&r<=Gs.f)return r-(Gs.a-10)}function y1(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(NE)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=R8(r.charCodeAt(i)),a=R8(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}const LR=async()=>{};async function BR(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);const i=Date.now()-n;i>=0&&i<e||(await LR(),n+=i)}}function OE(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function wh(r){return typeof r=="string"&&(r=OE(r)),Xr(r),r}function N8(r){return typeof r=="string"&&(r=OE(r)),Xr(r),r}function ci(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];Xr(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function $R(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}class ME{}function U4(r){const e=n=>r().update(wh(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function c0(r=32){if(vc&&typeof vc.getRandomValues=="function")return vc.getRandomValues(new Uint8Array(r));if(vc&&typeof vc.randomBytes=="function")return Uint8Array.from(vc.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function UR(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function LE(r,e,t){return r&e^~r&t}function BE(r,e,t){return r&e^r&t^e&t}class F4 extends ME{constructor(e,t,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Xu(this.buffer)}update(e){m1(this),e=wh(e),Xr(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=Xu(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){m1(this),OR(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,$s(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let h=o;h<s;h++)t[h]=0;UR(n,s-8,BigInt(this.length*8),i),this.process(n,0);const a=Xu(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,u[h],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const Fi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),gr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),qd=BigInt(2**32-1),O8=BigInt(32);function FR(r,e=!1){return e?{h:Number(r&qd),l:Number(r>>O8&qd)}:{h:Number(r>>O8&qd)|0,l:Number(r&qd)|0}}function VR(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=FR(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const M8=(r,e,t)=>r>>>t,L8=(r,e,t)=>r<<32-t|e>>>t,Ec=(r,e,t)=>r>>>t|e<<32-t,Sc=(r,e,t)=>r<<32-t|e>>>t,Hd=(r,e,t)=>r<<64-t|e>>>t-32,zd=(r,e,t)=>r>>>t-32|e<<64-t;function Ys(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const KR=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),qR=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,HR=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),zR=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,WR=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),jR=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,GR=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Vi=new Uint32Array(64);class YR extends F4{constructor(e=32){super(64,e,8,!1),this.A=Fi[0]|0,this.B=Fi[1]|0,this.C=Fi[2]|0,this.D=Fi[3]|0,this.E=Fi[4]|0,this.F=Fi[5]|0,this.G=Fi[6]|0,this.H=Fi[7]|0}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)Vi[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const d=Vi[h-15],g=Vi[h-2],m=ms(d,7)^ms(d,18)^d>>>3,b=ms(g,17)^ms(g,19)^g>>>10;Vi[h]=b+Vi[h-7]+m+Vi[h-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:u}=this;for(let h=0;h<64;h++){const d=ms(a,6)^ms(a,11)^ms(a,25),g=u+d+LE(a,c,l)+GR[h]+Vi[h]|0,b=(ms(n,2)^ms(n,13)^ms(n,22))+BE(n,s,i)|0;u=l,l=c,c=a,a=o+g|0,o=i,i=s,s=n,n=g+b|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,s,i,o,a,c,l,u)}roundClean(){$s(Vi)}destroy(){this.set(0,0,0,0,0,0,0,0),$s(this.buffer)}}const $E=VR(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),QR=$E[0],XR=$E[1],Ki=new Uint32Array(80),qi=new Uint32Array(80);class ZR extends F4{constructor(e=64){super(128,e,16,!1),this.Ah=gr[0]|0,this.Al=gr[1]|0,this.Bh=gr[2]|0,this.Bl=gr[3]|0,this.Ch=gr[4]|0,this.Cl=gr[5]|0,this.Dh=gr[6]|0,this.Dl=gr[7]|0,this.Eh=gr[8]|0,this.El=gr[9]|0,this.Fh=gr[10]|0,this.Fl=gr[11]|0,this.Gh=gr[12]|0,this.Gl=gr[13]|0,this.Hh=gr[14]|0,this.Hl=gr[15]|0}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:h,Fl:d,Gh:g,Gl:m,Hh:b,Hl:y}=this;return[e,t,n,s,i,o,a,c,l,u,h,d,g,m,b,y]}set(e,t,n,s,i,o,a,c,l,u,h,d,g,m,b,y){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=h|0,this.Fl=d|0,this.Gh=g|0,this.Gl=m|0,this.Hh=b|0,this.Hl=y|0}process(e,t){for(let R=0;R<16;R++,t+=4)Ki[R]=e.getUint32(t),qi[R]=e.getUint32(t+=4);for(let R=16;R<80;R++){const I=Ki[R-15]|0,T=qi[R-15]|0,k=Ec(I,T,1)^Ec(I,T,8)^M8(I,T,7),D=Sc(I,T,1)^Sc(I,T,8)^L8(I,T,7),F=Ki[R-2]|0,O=qi[R-2]|0,C=Ec(F,O,19)^Hd(F,O,61)^M8(F,O,6),N=Sc(F,O,19)^zd(F,O,61)^L8(F,O,6),P=HR(D,N,qi[R-7],qi[R-16]),M=zR(P,k,C,Ki[R-7],Ki[R-16]);Ki[R]=M|0,qi[R]=P|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:h,El:d,Fh:g,Fl:m,Gh:b,Gl:y,Hh:_,Hl:A}=this;for(let R=0;R<80;R++){const I=Ec(h,d,14)^Ec(h,d,18)^Hd(h,d,41),T=Sc(h,d,14)^Sc(h,d,18)^zd(h,d,41),k=h&g^~h&b,D=d&m^~d&y,F=WR(A,T,D,XR[R],qi[R]),O=jR(F,_,I,k,QR[R],Ki[R]),C=F|0,N=Ec(n,s,28)^Hd(n,s,34)^Hd(n,s,39),P=Sc(n,s,28)^zd(n,s,34)^zd(n,s,39),M=n&i^n&a^i&a,K=s&o^s&c^o&c;_=b|0,A=y|0,b=g|0,y=m|0,g=h|0,m=d|0,{h,l:d}=Ys(l|0,u|0,O|0,C|0),l=a|0,u=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const H=KR(C,P,K);n=qR(H,O,N,M),s=H|0}({h:n,l:s}=Ys(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=Ys(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=Ys(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Ys(this.Dh|0,this.Dl|0,l|0,u|0),{h,l:d}=Ys(this.Eh|0,this.El|0,h|0,d|0),{h:g,l:m}=Ys(this.Fh|0,this.Fl|0,g|0,m|0),{h:b,l:y}=Ys(this.Gh|0,this.Gl|0,b|0,y|0),{h:_,l:A}=Ys(this.Hh|0,this.Hl|0,_|0,A|0),this.set(n,s,i,o,a,c,l,u,h,d,g,m,b,y,_,A)}roundClean(){$s(Ki,qi)}destroy(){$s(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const UE=U4(()=>new YR),FE=U4(()=>new ZR);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const V4=BigInt(0),Mm=BigInt(1);function Da(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function Wd(r){const e=r.toString(16);return e.length&1?"0"+e:e}function VE(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?V4:BigInt("0x"+r)}function l0(r){return VE(_a(r))}function Ra(r){return Xr(r),VE(_a(Uint8Array.from(r).reverse()))}function K4(r,e){return y1(r.toString(16).padStart(e*2,"0"))}function rd(r,e){return K4(r,e).reverse()}function bt(r,e,t){let n;if(typeof e=="string")try{n=y1(e)}catch(i){throw new Error(r+" must be hex string or Uint8Array, cause: "+i)}else if(g1(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");const s=n.length;if(typeof t=="number"&&s!==t)throw new Error(r+" of length "+t+" expected, got "+s);return n}const rg=r=>typeof r=="bigint"&&V4<=r;function JR(r,e,t){return rg(r)&&rg(e)&&rg(t)&&e<=r&&r<t}function eo(r,e,t,n){if(!JR(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function KE(r){let e;for(e=0;r>V4;r>>=Mm,e+=1);return e}const nd=r=>(Mm<<BigInt(r))-Mm;function eN(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const n=g=>new Uint8Array(g),s=g=>Uint8Array.of(g);let i=n(r),o=n(r),a=0;const c=()=>{i.fill(1),o.fill(0),a=0},l=(...g)=>t(o,i,...g),u=(g=n(0))=>{o=l(s(0),g),i=l(),g.length!==0&&(o=l(s(1),g),i=l())},h=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let g=0;const m=[];for(;g<e;){i=l();const b=i.slice();m.push(b),g+=i.length}return ci(...m)};return(g,m)=>{c(),u(g);let b;for(;!(b=m(h()));)u();return c(),b}}function jl(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,i,o){const a=r[s];if(o&&a===void 0)return;const c=typeof a;if(c!==i||a===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${c}`)}Object.entries(e).forEach(([s,i])=>n(s,i,!1)),Object.entries(t).forEach(([s,i])=>n(s,i,!0))}function w1(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Gr=BigInt(0),lr=BigInt(1),aa=BigInt(2),qE=BigInt(3),HE=BigInt(4),zE=BigInt(5),tN=BigInt(7),WE=BigInt(8),rN=BigInt(9),jE=BigInt(16);function Pt(r,e){const t=r%e;return t>=Gr?t:e+t}function It(r,e,t){let n=r;for(;e-- >Gr;)n*=n,n%=t;return n}function B8(r,e){if(r===Gr)throw new Error("invert: expected non-zero number");if(e<=Gr)throw new Error("invert: expected positive modulus, got "+e);let t=Pt(r,e),n=e,s=Gr,i=lr;for(;t!==Gr;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==lr)throw new Error("invert: does not exist");return Pt(s,e)}function q4(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function GE(r,e){const t=(r.ORDER+lr)/HE,n=r.pow(e,t);return q4(r,n,e),n}function nN(r,e){const t=(r.ORDER-zE)/WE,n=r.mul(e,aa),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,aa),s),a=r.mul(i,r.sub(o,r.ONE));return q4(r,a,e),a}function sN(r){const e=rc(r),t=YE(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+tN)/jE;return(a,c)=>{let l=a.pow(c,o),u=a.mul(l,n);const h=a.mul(l,s),d=a.mul(l,i),g=a.eql(a.sqr(u),c),m=a.eql(a.sqr(h),c);l=a.cmov(l,u,g),u=a.cmov(d,h,m);const b=a.eql(a.sqr(u),c),y=a.cmov(l,u,b);return q4(a,y,c),y}}function YE(r){if(r<qE)throw new Error("sqrt is not defined for small field");let e=r-lr,t=0;for(;e%aa===Gr;)e/=aa,t++;let n=aa;const s=rc(r);for(;$8(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return GE;let i=s.pow(n,e);const o=(e+lr)/aa;return function(c,l){if(c.is0(l))return l;if($8(c,l)!==1)throw new Error("Cannot find square root");let u=t,h=c.mul(c.ONE,i),d=c.pow(l,e),g=c.pow(l,o);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let m=1,b=c.sqr(d);for(;!c.eql(b,c.ONE);)if(m++,b=c.sqr(b),m===u)throw new Error("Cannot find square root");const y=lr<<BigInt(u-m-1),_=c.pow(h,y);u=m,h=c.sqr(_),d=c.mul(d,h),g=c.mul(g,_)}return g}}function iN(r){return r%HE===qE?GE:r%WE===zE?nN:r%jE===rN?sN(r):YE(r)}const oN=(r,e)=>(Pt(r,e)&lr)===lr,aN=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function cN(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=aN.reduce((n,s)=>(n[s]="function",n),e);return jl(r,t),r}function lN(r,e,t){if(t<Gr)throw new Error("invalid exponent, negatives unsupported");if(t===Gr)return r.ONE;if(t===lr)return e;let n=r.ONE,s=e;for(;t>Gr;)t&lr&&(n=r.mul(n,s)),s=r.sqr(s),t>>=lr;return n}function QE(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function $8(r,e){const t=(r.ORDER-lr)/aa,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function uN(r,e){e!==void 0&&Sa(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function rc(r,e,t=!1,n={}){if(r<=Gr)throw new Error("invalid field: expected ORDER > 0, got "+r);let s,i,o=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");const d=e;d.BITS&&(s=d.BITS),d.sqrt&&(i=d.sqrt),typeof d.isLE=="boolean"&&(t=d.isLE),typeof d.modOnDecode=="boolean"&&(o=d.modOnDecode),a=d.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(i=n.sqrt);const{nBitLength:c,nByteLength:l}=uN(r,s);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let u;const h=Object.freeze({ORDER:r,isLE:t,BITS:c,BYTES:l,MASK:nd(c),ZERO:Gr,ONE:lr,allowedLengths:a,create:d=>Pt(d,r),isValid:d=>{if(typeof d!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof d);return Gr<=d&&d<r},is0:d=>d===Gr,isValidNot0:d=>!h.is0(d)&&h.isValid(d),isOdd:d=>(d&lr)===lr,neg:d=>Pt(-d,r),eql:(d,g)=>d===g,sqr:d=>Pt(d*d,r),add:(d,g)=>Pt(d+g,r),sub:(d,g)=>Pt(d-g,r),mul:(d,g)=>Pt(d*g,r),pow:(d,g)=>lN(h,d,g),div:(d,g)=>Pt(d*B8(g,r),r),sqrN:d=>d*d,addN:(d,g)=>d+g,subN:(d,g)=>d-g,mulN:(d,g)=>d*g,inv:d=>B8(d,r),sqrt:i||(d=>(u||(u=iN(r)),u(h,d))),toBytes:d=>t?rd(d,l):K4(d,l),fromBytes:(d,g=!0)=>{if(a){if(!a.includes(d.length)||d.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+d.length);const b=new Uint8Array(l);b.set(d,t?0:b.length-d.length),d=b}if(d.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+d.length);let m=t?Ra(d):l0(d);if(o&&(m=Pt(m,r)),!g&&!h.isValid(m))throw new Error("invalid field element: outside of range 0..ORDER");return m},invertBatch:d=>QE(h,d),cmov:(d,g,m)=>m?g:d});return Object.freeze(h)}function XE(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function ZE(r){const e=XE(r);return e+Math.ceil(e/2)}function hN(r,e,t=!1){const n=r.length,s=XE(e),i=ZE(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?Ra(r):l0(r),a=Pt(o,e-lr)+lr;return t?rd(a,s):K4(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ul=BigInt(0),ca=BigInt(1);function b1(r,e){const t=e.negate();return r?t:e}function la(r,e){const t=QE(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function JE(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function ng(r,e){JE(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=nd(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function U8(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=ca);const l=e*n,u=l+Math.abs(a)-1,h=a===0,d=a<0,g=e%2!==0;return{nextN:c,offset:u,isZero:h,isNeg:d,isNegF:g,offsetF:l}}function dN(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function fN(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}const sg=new WeakMap,eS=new WeakMap;function ig(r){return eS.get(r)||1}function F8(r){if(r!==ul)throw new Error("invalid wNAF")}class tS{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>ul;)t&ca&&(n=n.add(s)),s=s.double(),t>>=ca;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=ng(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=ng(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:u,isNeg:h,isNegF:d,offsetF:g}=U8(n,a,o);n=c,u?i=i.add(b1(d,t[g])):s=s.add(b1(h,t[l]))}return F8(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=ng(e,this.bits);for(let o=0;o<i.windows&&n!==ul;o++){const{nextN:a,offset:c,isZero:l,isNeg:u}=U8(n,o,i);if(n=a,!l){const h=t[c];s=s.add(u?h.negate():h)}}return F8(n),s}getPrecomputes(e,t,n){let s=sg.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),sg.set(t,s))),s}cached(e,t,n){const s=ig(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=ig(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){JE(t,this.bits),eS.set(e,t),sg.delete(e)}hasCache(e){return ig(e)!==1}}function pN(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>ul||n>ul;)t&ca&&(i=i.add(s)),n&ca&&(o=o.add(s)),s=s.double(),t>>=ca,n>>=ca;return{p1:i,p2:o}}function rS(r,e,t,n){dN(t,r),fN(n,e);const s=t.length,i=n.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const o=r.ZERO,a=KE(BigInt(s));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const l=nd(c),u=new Array(Number(l)+1).fill(o),h=Math.floor((e.BITS-1)/c)*c;let d=o;for(let g=h;g>=0;g-=c){u.fill(o);for(let b=0;b<i;b++){const y=n[b],_=Number(y>>BigInt(g)&l);u[_]=u[_].add(t[b])}let m=o;for(let b=u.length-1,y=o;b>0;b--)y=y.add(u[b]),m=m.add(y);if(d=d.add(m),g!==0)for(let b=0;b<c;b++)d=d.double()}return d}function V8(r,e){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return cN(e),e}else return rc(r)}function nS(r,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const a of["p","n","h"]){const c=e[a];if(!(typeof c=="bigint"&&c>ul))throw new Error(`CURVE.${a} must be positive bigint`)}const n=V8(e.p,t.Fp),s=V8(e.n,t.Fn),o=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const a of o)if(!n.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return{Fp:n,Fn:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Es=BigInt(0),Vt=BigInt(1),og=BigInt(2),gN=BigInt(8);function mN(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function yN(r,e={}){const{Fp:t,Fn:n}=nS("edwards",r,e),{h:s,n:i}=r;jl(e,{},{uvRatio:"function"});const o=og<<BigInt(n.BYTES*8)-Vt,a=b=>t.create(b),c=e.uvRatio||((b,y)=>{try{return{isValid:!0,value:t.sqrt(t.div(b,y))}}catch{return{isValid:!1,value:Es}}});if(!mN(t,r,r.Gx,r.Gy))throw new Error("bad curve params: generator point");function l(b,y,_=!1){const A=_?Vt:Es;return eo("coordinate "+b,y,A,o),y}function u(b){if(!(b instanceof g))throw new Error("ExtendedPoint expected")}const h=w1((b,y)=>{const{X:_,Y:A,Z:R}=b,I=b.is0();y==null&&(y=I?gN:t.inv(R));const T=a(_*y),k=a(A*y),D=t.mul(R,y);if(I)return{x:Es,y:Vt};if(D!==Vt)throw new Error("invZ was invalid");return{x:T,y:k}}),d=w1(b=>{const{a:y,d:_}=r;if(b.is0())throw new Error("bad point: ZERO");const{X:A,Y:R,Z:I,T}=b,k=a(A*A),D=a(R*R),F=a(I*I),O=a(F*F),C=a(k*y),N=a(F*a(C+D)),P=a(O+a(_*a(k*D)));if(N!==P)throw new Error("bad point: equation left != right (1)");const M=a(A*R),K=a(I*T);if(M!==K)throw new Error("bad point: equation left != right (2)");return!0});class g{constructor(y,_,A,R){this.X=l("x",y),this.Y=l("y",_),this.Z=l("z",A,!0),this.T=l("t",R),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(y){return la(g,y)}static msm(y,_){return rS(g,n,y,_)}_setWindowSize(y){this.precompute(y)}static fromAffine(y){if(y instanceof g)throw new Error("extended point not allowed");const{x:_,y:A}=y||{};return l("x",_),l("y",A),new g(_,A,Vt,a(_*A))}precompute(y=8,_=!0){return m.createCache(this,y),_||this.multiply(og),this}assertValidity(){d(this)}equals(y){u(y);const{X:_,Y:A,Z:R}=this,{X:I,Y:T,Z:k}=y,D=a(_*k),F=a(I*R),O=a(A*k),C=a(T*R);return D===F&&O===C}is0(){return this.equals(g.ZERO)}negate(){return new g(a(-this.X),this.Y,this.Z,a(-this.T))}double(){const{a:y}=r,{X:_,Y:A,Z:R}=this,I=a(_*_),T=a(A*A),k=a(og*a(R*R)),D=a(y*I),F=_+A,O=a(a(F*F)-I-T),C=D+T,N=C-k,P=D-T,M=a(O*N),K=a(C*P),H=a(O*P),$=a(N*C);return new g(M,K,$,H)}add(y){u(y);const{a:_,d:A}=r,{X:R,Y:I,Z:T,T:k}=this,{X:D,Y:F,Z:O,T:C}=y,N=a(R*D),P=a(I*F),M=a(k*A*C),K=a(T*O),H=a((R+I)*(D+F)-N-P),$=K-M,B=K+M,z=a(P-_*N),q=a(H*$),Y=a(B*z),Q=a(H*z),j=a($*B);return new g(q,Y,j,Q)}subtract(y){return this.add(y.negate())}multiply(y){const _=y;eo("scalar",_,Vt,i);const{p:A,f:R}=m.cached(this,_,I=>la(g,I));return la(g,[A,R])[0]}multiplyUnsafe(y,_=g.ZERO){const A=y;return eo("scalar",A,Es,i),A===Es?g.ZERO:this.is0()||A===Vt?this:m.unsafe(this,A,R=>la(g,R),_)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}isTorsionFree(){return m.unsafe(this,i).is0()}toAffine(y){return h(this,y)}clearCofactor(){return s===Vt?this:this.multiplyUnsafe(s)}static fromBytes(y,_=!1){return Xr(y),g.fromHex(y,_)}static fromHex(y,_=!1){const{d:A,a:R}=r,I=t.BYTES;y=bt("pointHex",y,I),Da("zip215",_);const T=y.slice(),k=y[I-1];T[I-1]=k&-129;const D=Ra(T),F=_?o:t.ORDER;eo("pointHex.y",D,Es,F);const O=a(D*D),C=a(O-Vt),N=a(A*O-R);let{isValid:P,value:M}=c(C,N);if(!P)throw new Error("Point.fromHex: invalid y coordinate");const K=(M&Vt)===Vt,H=(k&128)!==0;if(!_&&M===Es&&H)throw new Error("Point.fromHex: x=0 and x_0=1");return H!==K&&(M=a(-M)),g.fromAffine({x:M,y:D})}toBytes(){const{x:y,y:_}=this.toAffine(),A=rd(_,t.BYTES);return A[A.length-1]|=y&Vt?128:0,A}toRawBytes(){return this.toBytes()}toHex(){return _a(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}g.BASE=new g(r.Gx,r.Gy,Vt,a(r.Gx*r.Gy)),g.ZERO=new g(Es,Vt,Vt,Es),g.Fp=t,g.Fn=n;const m=new tS(g,n.BYTES*8);return g}function wN(r,e,t){if(typeof e!="function")throw new Error('"hash" function param is required');jl(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=o.ORDER,c=t.randomBytes||c0,l=t.adjustScalarBytes||(N=>N),u=t.domain||((N,P,M)=>{if(Da("phflag",M),P.length||M)throw new Error("Contexts/pre-hash are not supported");return N});function h(N){return o.create(N)}function d(N){return h(Ra(N))}function g(N){const P=i.BYTES;N=bt("private key",N,P);const M=bt("hashed private key",e(N),2*P),K=l(M.slice(0,P)),H=M.slice(P,2*P),$=d(K);return{head:K,prefix:H,scalar:$}}function m(N){const{head:P,prefix:M,scalar:K}=g(N),H=s.multiply(K),$=H.toBytes();return{head:P,prefix:M,scalar:K,point:H,pointBytes:$}}function b(N){return m(N).pointBytes}function y(N=Uint8Array.of(),...P){const M=ci(...P);return d(e(u(M,bt("context",N),!!n)))}function _(N,P,M={}){N=bt("message",N),n&&(N=n(N));const{prefix:K,scalar:H,pointBytes:$}=m(P),B=y(M.context,K,N),z=s.multiply(B).toBytes(),q=y(M.context,z,$,N),Y=h(B+q*H);eo("signature.s",Y,Es,a);const Q=i.BYTES,j=ci(z,rd(Y,Q));return bt("result",j,Q*2)}const A={zip215:!0};function R(N,P,M,K=A){const{context:H,zip215:$}=K,B=i.BYTES;N=bt("signature",N,2*B),P=bt("message",P),M=bt("publicKey",M,B),$!==void 0&&Da("zip215",$),n&&(P=n(P));const z=Ra(N.slice(B,2*B));let q,Y,Q;try{q=r.fromHex(M,$),Y=r.fromHex(N.slice(0,B),$),Q=s.multiplyUnsafe(z)}catch{return!1}if(!$&&q.isSmallOrder())return!1;const j=y(H,Y.toBytes(),q.toBytes(),P);return Y.add(q.multiplyUnsafe(j)).subtract(Q).clearCofactor().is0()}s.precompute(8);const I=i.BYTES,T={secret:I,public:I,signature:2*I,seed:I};function k(N=c(T.seed)){return N}const D={getExtendedPublicKey:m,randomSecretKey:k,isValidSecretKey:O,isValidPublicKey:C,randomPrivateKey:k,toMontgomery(N){const{y:P}=r.fromBytes(N),M=I===32;if(!M&&I!==57)throw new Error("only defined for 25519 and 448");const K=M?i.div(Vt+P,Vt-P):i.div(P-Vt,P+Vt);return i.toBytes(K)},toMontgomeryPriv(N){Xr(N,I);const P=e(N.subarray(0,I));return l(P).subarray(0,I)},precompute(N=8,P=r.BASE){return P.precompute(N,!1)}};function F(N){const P=D.randomSecretKey(N);return{secretKey:P,publicKey:b(P)}}function O(N){try{return!!o.fromBytes(N,!1)}catch{return!1}}function C(N,P){try{return!!r.fromBytes(N,P)}catch{return!1}}return Object.freeze({keygen:F,getPublicKey:b,sign:_,verify:R,utils:D,Point:r,info:{type:"edwards",lengths:T}})}function bN(r){const e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=rc(e.n,r.nBitLength,!0),s={Fp:t,Fn:n,uvRatio:r.uvRatio},i={randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:s,hash:r.hash,eddsaOpts:i}}function vN(r,e){return Object.assign({},e,{ExtendedPoint:e.Point,CURVE:r})}function EN(r){const{CURVE:e,curveOpts:t,hash:n,eddsaOpts:s}=bN(r),i=yN(e,t),o=wN(i,n,s);return vN(r,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Eu=BigInt(0),_c=BigInt(1),jd=BigInt(2);function SN(r){return jl(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function _N(r){const e=SN(r),{P:t,type:n,adjustScalarBytes:s,powPminus2:i,randomBytes:o}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");const c=o||c0,l=a?255:448,u=a?32:56,h=BigInt(a?9:5),d=BigInt(a?121665:39081),g=a?jd**BigInt(254):jd**BigInt(447),m=a?BigInt(8)*jd**BigInt(251)-_c:BigInt(4)*jd**BigInt(445)-_c,b=g+m+_c,y=M=>Pt(M,t),_=A(h);function A(M){return rd(y(M),u)}function R(M){const K=bt("u coordinate",M,u);return a&&(K[31]&=127),y(Ra(K))}function I(M){return Ra(s(bt("scalar",M,u)))}function T(M,K){const H=F(R(K),I(M));if(H===Eu)throw new Error("invalid private or public key received");return A(H)}function k(M){return T(M,_)}function D(M,K,H){const $=y(M*(K-H));return K=y(K-$),H=y(H+$),{x_2:K,x_3:H}}function F(M,K){eo("u",M,Eu,t),eo("scalar",K,g,b);const H=K,$=M;let B=_c,z=Eu,q=M,Y=_c,Q=Eu;for(let we=BigInt(l-1);we>=Eu;we--){const ue=H>>we&_c;Q^=ue,{x_2:B,x_3:q}=D(Q,B,q),{x_2:z,x_3:Y}=D(Q,z,Y),Q=ue;const fe=B+z,ce=y(fe*fe),ke=B-z,Oe=y(ke*ke),ot=ce-Oe,lt=q+Y,Te=q-Y,Ke=y(Te*fe),Mt=y(lt*ke),Ft=Ke+Mt,Dt=Ke-Mt;q=y(Ft*Ft),Y=y($*y(Dt*Dt)),B=y(ce*Oe),z=y(ot*(ce+y(d*ot)))}({x_2:B,x_3:q}=D(Q,B,q)),{x_2:z,x_3:Y}=D(Q,z,Y);const j=i(z);return y(B*j)}const O=(M=c(u))=>M,C={randomSecretKey:O,randomPrivateKey:O};function N(M){const K=C.randomSecretKey(M);return{secretKey:K,publicKey:k(K)}}const P={secret:u,public:u,seed:u};return{keygen:N,getSharedSecret:(M,K)=>T(M,K),getPublicKey:M=>k(M),scalarMult:T,scalarMultBase:k,utils:C,GuBytes:_.slice(),info:{type:"montgomery",lengths:P}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */BigInt(0);const xN=BigInt(1),K8=BigInt(2),AN=BigInt(3),IN=BigInt(5),TN=BigInt(8),sd={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:TN,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function sS(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=sd.p,a=r*r%i*r%i,c=It(a,K8,i)*a%i,l=It(c,xN,i)*r%i,u=It(l,IN,i)*l%i,h=It(u,e,i)*u%i,d=It(h,t,i)*h%i,g=It(d,n,i)*d%i,m=It(g,s,i)*g%i,b=It(m,s,i)*g%i,y=It(b,e,i)*u%i;return{pow_p_5_8:It(y,K8,i)*r%i,b2:a}}function iS(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const q8=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function kN(r,e){const t=sd.p,n=Pt(e*e*e,t),s=Pt(n*n*e,t),i=sS(r*s).pow_p_5_8;let o=Pt(r*n*i,t);const a=Pt(e*o*o,t),c=o,l=Pt(o*q8,t),u=a===r,h=a===Pt(-r,t),d=a===Pt(-r*q8,t);return u&&(o=c),(h||d)&&(o=l),oN(o,t)&&(o=Pt(-o,t)),{isValid:u||h,value:o}}const CN=rc(sd.p,{isLE:!0}),PN={...sd,Fp:CN,hash:FE,adjustScalarBytes:iS,uvRatio:kN},v1=EN(PN),Gd=(()=>{const r=sd.p;return _N({P:r,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:n}=sS(e);return Pt(It(t,AN,r)*n,r)},adjustScalarBytes:iS})})();class H8 extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class z8 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class DN extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Nr={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new DN("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}},bh=32,Ts=64,Lm=32;let Yc;const oS=(async()=>{try{return await Nr.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function RN(){const r=v1.utils.randomPrivateKey(),e=v1.getPublicKey(r);return{privateKey:UN(r,e),publicKey:e}}async function NN(r,e){let t;r.length===Ts?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:re(r.subarray(32),"base64url"),d:re(t,"base64url"),ext:!0,key_ops:["sign"]},s=await Nr.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Nr.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function ON(r,e){const t=r.subarray(0,Lm);return v1.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function MN(r,e){return Yc==null&&(Yc=await oS),Yc?NN(r,e):ON(r,e)}async function LN(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Nr.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Nr.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function BN(r,e,t){return v1.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function $N(r,e,t){return Yc==null&&(Yc=await oS),Yc?LN(r,e,t):BN(r,e,t)}function UN(r,e){const t=new Uint8Array(Ts);for(let n=0;n<Lm;n++)t[n]=r[n],t[Lm+n]=e[n];return t}function u0(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class aS{type="Ed25519";raw;constructor(e){this.raw=vh(e,bh)}toMultihash(){return wo.digest(yn(this))}toCID(){return Ne.createV1(114,this.toMultihash())}toString(){return $t.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=$N(this.raw,t,e);return u0(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}class Bm{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=vh(e,Ts),this.publicKey=new aS(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=MN(this.raw,e);return u0(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function cS(r){if(r.length>Ts){r=vh(r,Ts+bh);const n=r.subarray(0,Ts),s=r.subarray(Ts,r.length);return new Bm(n,s)}r=vh(r,Ts);const e=r.subarray(0,Ts),t=r.subarray(bh);return new Bm(e,t)}function H4(r){return r=vh(r,bh),new aS(r)}async function FN(){const{privateKey:r,publicKey:e}=RN();return new Bm(r,e)}function vh(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new te(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const VN=Math.pow(2,7),KN=Math.pow(2,14),qN=Math.pow(2,21),z4=Math.pow(2,28),W4=Math.pow(2,35),j4=Math.pow(2,42),G4=Math.pow(2,49),Ze=128,wr=127;function tt(r){if(r<VN)return 1;if(r<KN)return 2;if(r<qN)return 3;if(r<z4)return 4;if(r<W4)return 5;if(r<j4)return 6;if(r<G4)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function E1(r,e,t=0){switch(tt(r)){case 8:e[t++]=r&255|Ze,r/=128;case 7:e[t++]=r&255|Ze,r/=128;case 6:e[t++]=r&255|Ze,r/=128;case 5:e[t++]=r&255|Ze,r/=128;case 4:e[t++]=r&255|Ze,r>>>=7;case 3:e[t++]=r&255|Ze,r>>>=7;case 2:e[t++]=r&255|Ze,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function HN(r,e,t=0){switch(tt(r)){case 8:e.set(t++,r&255|Ze),r/=128;case 7:e.set(t++,r&255|Ze),r/=128;case 6:e.set(t++,r&255|Ze),r/=128;case 5:e.set(t++,r&255|Ze),r/=128;case 4:e.set(t++,r&255|Ze),r>>>=7;case 3:e.set(t++,r&255|Ze),r>>>=7;case 2:e.set(t++,r&255|Ze),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function lS(r,e){let t=r[e],n=0;if(n+=t&wr,t<Ze||(t=r[e+1],n+=(t&wr)<<7,t<Ze)||(t=r[e+2],n+=(t&wr)<<14,t<Ze)||(t=r[e+3],n+=(t&wr)<<21,t<Ze)||(t=r[e+4],n+=(t&wr)*z4,t<Ze)||(t=r[e+5],n+=(t&wr)*W4,t<Ze)||(t=r[e+6],n+=(t&wr)*j4,t<Ze)||(t=r[e+7],n+=(t&wr)*G4,t<Ze))return n;throw new RangeError("Could not decode varint")}function zN(r,e){let t=r.get(e),n=0;if(n+=t&wr,t<Ze||(t=r.get(e+1),n+=(t&wr)<<7,t<Ze)||(t=r.get(e+2),n+=(t&wr)<<14,t<Ze)||(t=r.get(e+3),n+=(t&wr)<<21,t<Ze)||(t=r.get(e+4),n+=(t&wr)*z4,t<Ze)||(t=r.get(e+5),n+=(t&wr)*W4,t<Ze)||(t=r.get(e+6),n+=(t&wr)*j4,t<Ze)||(t=r.get(e+7),n+=(t&wr)*G4,t<Ze))return n;throw new RangeError("Could not decode varint")}function Yr(r,e,t=0){return e==null&&(e=xr(tt(r))),e instanceof Uint8Array?E1(r,e,t):HN(r,e,t)}function Di(r,e=0){return r instanceof Uint8Array?lS(r,e):zN(r,e)}const Y4=new Float32Array([-0]),to=new Uint8Array(Y4.buffer);function WN(r,e,t){Y4[0]=r,e[t]=to[0],e[t+1]=to[1],e[t+2]=to[2],e[t+3]=to[3]}function jN(r,e){return to[0]=r[e],to[1]=r[e+1],to[2]=r[e+2],to[3]=r[e+3],Y4[0]}const Q4=new Float64Array([-0]),br=new Uint8Array(Q4.buffer);function GN(r,e,t){Q4[0]=r,e[t]=br[0],e[t+1]=br[1],e[t+2]=br[2],e[t+3]=br[3],e[t+4]=br[4],e[t+5]=br[5],e[t+6]=br[6],e[t+7]=br[7]}function YN(r,e){return br[0]=r[e],br[1]=r[e+1],br[2]=r[e+2],br[3]=r[e+3],br[4]=r[e+4],br[5]=r[e+5],br[6]=r[e+6],br[7]=r[e+7],Q4[0]}const QN=BigInt(Number.MAX_SAFE_INTEGER),XN=BigInt(Number.MIN_SAFE_INTEGER);class vr{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return xa;if(e<QN&&e>XN)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>W8&&(s=0n,++n>W8&&(n=0n))),new vr(Number(s),Number(n))}static fromNumber(e){if(e===0)return xa;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new vr(n,s)}static from(e){return typeof e=="number"?vr.fromNumber(e):typeof e=="bigint"?vr.fromBigInt(e):typeof e=="string"?vr.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new vr(e.low>>>0,e.high>>>0):xa}}const xa=new vr(0,0);xa.toBigInt=function(){return 0n};xa.zzEncode=xa.zzDecode=function(){return this};xa.length=function(){return 1};const W8=4294967296n;function ZN(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function JN(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,a;for(;e<t;)a=r[e++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function uS(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function Gn(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Yd(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class eO{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Gn(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Gn(this,4);return Yd(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Gn(this,4);return Yd(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Gn(this,4);const e=jN(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Gn(this,4);const e=YN(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Gn(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return JN(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Gn(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Gn(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new vr(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Gn(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Gn(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Gn(this,8);const e=Yd(this.buf,this.pos+=4),t=Yd(this.buf,this.pos+=4);return new vr(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=lS(this.buf,this.pos);return this.pos+=tt(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function tO(r){return new eO(r instanceof Uint8Array?r:r.subarray())}function _e(r,e,t){const n=tO(r);return e.decode(n,void 0,t)}function rO(r){let n,s=8192;return function(o){if(o<1||o>4096)return xr(o);s+o>8192&&(n=xr(8192),s=0);const a=n.subarray(s,s+=o);return s&7&&(s=(s|7)+1),a}}class qu{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function ag(){}class nO{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const sO=rO();function iO(r){return globalThis.Buffer!=null?xr(r):sO(r)}class $m{len;head;tail;states;constructor(){this.len=0,this.head=new qu(ag,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new qu(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new aO((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Qd,10,vr.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=vr.fromBigInt(e);return this._push(Qd,t.length(),t)}uint64Number(e){return this._push(E1,tt(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=vr.fromBigInt(e).zzEncode();return this._push(Qd,t.length(),t)}sint64Number(e){const t=vr.fromNumber(e).zzEncode();return this._push(Qd,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(cg,1,e?1:0)}fixed32(e){return this._push(Su,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=vr.fromBigInt(e);return this._push(Su,4,t.lo)._push(Su,4,t.hi)}fixed64Number(e){const t=vr.fromNumber(e);return this._push(Su,4,t.lo)._push(Su,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(WN,4,e)}double(e){return this._push(GN,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(cg,1,0):this.uint32(t)._push(cO,t,e)}string(e){const t=ZN(e);return t!==0?this.uint32(t)._push(uS,t,e):this._push(cg,1,0)}fork(){return this.states=new nO(this),this.head=this.tail=new qu(ag,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new qu(ag,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=iO(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function cg(r,e,t){e[t]=r&255}function oO(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class aO extends qu{next;constructor(e,t){super(oO,e,t),this.next=void 0}}function Qd(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Su(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function cO(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&($m.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(lO,e,r),this},$m.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(uO,e,r),this});function lO(r,e,t){e.set(r,t)}function uO(r,e,t){r.length<40?uS(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(ne(r),t)}function hO(){return new $m}function xe(r,e){const t=hO();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var S1;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(S1||(S1={}));function hS(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Zr(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const a=e(i);o.int32(a)},n=function(i){const o=i.int32();return e(o)};return hS("enum",S1.VARINT,t,n)}function Ae(r,e){return hS("message",S1.LENGTH_DELIMITED,r,e)}class nt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class j8 extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var Et;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Et||(Et={}));var Um;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Um||(Um={}));(function(r){r.codec=()=>Zr(Um)})(Et||(Et={}));var bo;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Et.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Et.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(bo||(bo={}));var _1;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Et.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Et.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(_1||(_1={}));function vo(r){if(isNaN(r)||r<=0)throw new te("random bytes length must be a Number bigger than 0");return c0(r)}const Aa=UE;let X4=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=J4(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return Ne.createV1(114,this._multihash)}toString(){return $t.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}verify(e,t,n){return AO(this.jwk,t,e,n)}},dS=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=gO(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}sign(e,t){return xO(this.jwk,e,t)}};const fS=8192,Z4=18,dO=1062,fO=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function pO(r){return{n:re(r[1],"base64url"),e:re(r[2],"base64url"),d:re(r[3],"base64url"),p:re(r[4],"base64url"),q:re(r[5],"base64url"),dp:re(r[6],"base64url"),dq:re(r[7],"base64url"),qi:re(r[8],"base64url"),kty:"RSA"}}function gO(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new te("JWK was missing components");return fi([cn(Uint8Array.from([0])),cn(ne(r.n,"base64url")),cn(ne(r.e,"base64url")),cn(ne(r.d,"base64url")),cn(ne(r.p,"base64url")),cn(ne(r.q,"base64url")),cn(ne(r.dp,"base64url")),cn(ne(r.dq,"base64url")),cn(ne(r.qi,"base64url"))]).subarray()}function mO(r){const e=No(r[1],{offset:0});return{kty:"RSA",n:re(e[0],"base64url"),e:re(e[1],"base64url")}}function J4(r){if(r.n==null||r.e==null)throw new te("JWK was missing components");return fi([fO,$4(fi([cn(ne(r.n,"base64url")),cn(ne(r.e,"base64url"))]))]).subarray()}function yO(r){const e=No(r);return pS(e)}function pS(r){const e=pO(r);return bO(e)}function wO(r,e){if(r.byteLength>=dO)throw new u1("Key size is too large");const t=No(r,{offset:0});return gS(t,r,e)}function gS(r,e,t){const n=mO(r);if(t==null){const s=Aa(bo.encode({Type:Et.RSA,Data:e}));t=vi(Z4,s)}return new X4(n,t)}function bO(r){if(TO(r)>fS)throw new te("Key size is too large");const e=EO(r),t=Aa(bo.encode({Type:Et.RSA,Data:J4(e.publicKey)})),n=vi(Z4,t);return new dS(e.privateKey,new X4(e.publicKey,n))}async function vO(r){if(r>fS)throw new te("Key size is too large");const e=await _O(r),t=Aa(bo.encode({Type:Et.RSA,Data:J4(e.publicKey)})),n=vi(Z4,t);return new dS(e.privateKey,new X4(e.publicKey,n))}function EO(r){if(r==null)throw new te("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const SO="1.2.840.113549.1.1.1";async function _O(r,e){const t=await Nr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await IO(t);return{privateKey:n[0],publicKey:n[1]}}async function xO(r,e,t){const n=await Nr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const s=await Nr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function AO(r,e,t,n){const s=await Nr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Nr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function IO(r,e){if(r.privateKey==null||r.publicKey==null)throw new te("Private and public key are required");return await Promise.all([Nr.get().subtle.exportKey("jwk",r.privateKey),Nr.get().subtle.exportKey("jwk",r.publicKey)])}function TO(r){if(r.kty!=="RSA")throw new te("invalid key type");if(r.n==null)throw new te("invalid key modulus");return ne(r.n,"base64url").length*8}class mS extends ME{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,td(e);const n=wh(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(n.length>s?e.create().update(n).digest():n);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),$s(i)}update(e){return m1(this),this.iHash.update(e),this}digestInto(e){m1(this),Xr(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const id=(r,e,t)=>new mS(r,e).update(t).digest();id.create=(r,e)=>new mS(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const G8=(r,e)=>(r+(r>=0?e:-e)/yS)/e;function kO(r,e,t){const[[n,s],[i,o]]=e,a=G8(o*r,t),c=G8(-s*r,t);let l=r-a*n-c*i,u=-a*s-c*o;const h=l<li,d=u<li;h&&(l=-l),d&&(u=-u);const g=nd(Math.ceil(KE(t)/2))+Qc;if(l<li||l>=g||u<li||u>=g)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:l,k2neg:d,k2:u}}function Y8(r){r.lowS!==void 0&&Da("lowS",r.lowS),r.prehash!==void 0&&Da("prehash",r.prehash)}class CO extends Error{constructor(e=""){super(e)}}const si={Err:CO,_tlv:{encode:(r,e)=>{const{Err:t}=si;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=Wd(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?Wd(s.length/2|128):"";return Wd(r)+i+s+e},decode(r,e){const{Err:t}=si;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const u of l)o=o<<8|u;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=si;if(r<li)throw new e("integer: negative integers are not allowed");let t=Wd(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=si;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return l0(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=si,s=bt("signature",r),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=si,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},li=BigInt(0),Qc=BigInt(1),yS=BigInt(2),Xd=BigInt(3),PO=BigInt(4);function DO(r,e,t){function n(s){const i=r.sqr(s),o=r.mul(i,s);return r.add(r.add(o,r.mul(s,e)),t)}return n}function $c(r,e){const{BYTES:t}=r;let n;if(typeof e=="bigint")n=e;else{let s=bt("private key",e);try{n=r.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!r.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function RO(r,e={}){const{Fp:t,Fn:n}=nS("weierstrass",r,e),{h:s,n:i}=r;jl(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:o}=e;if(o&&(!t.is0(r.a)||typeof o.beta!="bigint"||!Array.isArray(o.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(O,C,N){const{x:P,y:M}=C.toAffine(),K=t.toBytes(P);if(Da("isCompressed",N),N){a();const H=!t.isOdd(M);return ci(wS(H),K)}else return ci(Uint8Array.of(4),K,t.toBytes(M))}function l(O){Xr(O);const C=t.BYTES,N=C+1,P=2*C+1,M=O.length,K=O[0],H=O.subarray(1);if(M===N&&(K===2||K===3)){const $=t.fromBytes(H);if(!t.isValid($))throw new Error("bad point: is not on curve, wrong x");const B=d($);let z;try{z=t.sqrt(B)}catch(Q){const j=Q instanceof Error?": "+Q.message:"";throw new Error("bad point: is not on curve, sqrt error"+j)}a();const q=t.isOdd(z);return(K&1)===1!==q&&(z=t.neg(z)),{x:$,y:z}}else if(M===P&&K===4){const $=t.fromBytes(H.subarray(C*0,C*1)),B=t.fromBytes(H.subarray(C*1,C*2));if(!g($,B))throw new Error("bad point: is not on curve");return{x:$,y:B}}else throw new Error(`bad point: got length ${M}, expected compressed=${N} or uncompressed=${P}`)}const u=e.toBytes||c,h=e.fromBytes||l,d=DO(t,r.a,r.b);function g(O,C){const N=t.sqr(C),P=d(O);return t.eql(N,P)}if(!g(r.Gx,r.Gy))throw new Error("bad curve params: generator point");const m=t.mul(t.pow(r.a,Xd),PO),b=t.mul(t.sqr(r.b),BigInt(27));if(t.is0(t.add(m,b)))throw new Error("bad curve params: a or b");function y(O,C,N=!1){if(!t.isValid(C)||N&&t.is0(C))throw new Error(`bad point coordinate ${O}`);return C}function _(O){if(!(O instanceof k))throw new Error("ProjectivePoint expected")}function A(O){if(!o||!o.basises)throw new Error("no endo");return kO(O,o.basises,n.ORDER)}const R=w1((O,C)=>{const{X:N,Y:P,Z:M}=O;if(t.eql(M,t.ONE))return{x:N,y:P};const K=O.is0();C==null&&(C=K?t.ONE:t.inv(M));const H=t.mul(N,C),$=t.mul(P,C),B=t.mul(M,C);if(K)return{x:t.ZERO,y:t.ZERO};if(!t.eql(B,t.ONE))throw new Error("invZ was invalid");return{x:H,y:$}}),I=w1(O=>{if(O.is0()){if(e.allowInfinityPoint&&!t.is0(O.Y))return;throw new Error("bad point: ZERO")}const{x:C,y:N}=O.toAffine();if(!t.isValid(C)||!t.isValid(N))throw new Error("bad point: x or y not field elements");if(!g(C,N))throw new Error("bad point: equation left != right");if(!O.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function T(O,C,N,P,M){return N=new k(t.mul(N.X,O),N.Y,N.Z),C=b1(P,C),N=b1(M,N),C.add(N)}class k{constructor(C,N,P){this.X=y("x",C),this.Y=y("y",N,!0),this.Z=y("z",P),Object.freeze(this)}static fromAffine(C){const{x:N,y:P}=C||{};if(!C||!t.isValid(N)||!t.isValid(P))throw new Error("invalid affine point");if(C instanceof k)throw new Error("projective point not allowed");return t.is0(N)&&t.is0(P)?k.ZERO:new k(N,P,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}static normalizeZ(C){return la(k,C)}static fromBytes(C){return Xr(C),k.fromHex(C)}static fromHex(C){const N=k.fromAffine(h(bt("pointHex",C)));return N.assertValidity(),N}static fromPrivateKey(C){return k.BASE.multiply($c(n,C))}static msm(C,N){return rS(k,n,C,N)}_setWindowSize(C){this.precompute(C)}precompute(C=8,N=!0){return F.createCache(this,C),N||this.multiply(Xd),this}assertValidity(){I(this)}hasEvenY(){const{y:C}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(C)}equals(C){_(C);const{X:N,Y:P,Z:M}=this,{X:K,Y:H,Z:$}=C,B=t.eql(t.mul(N,$),t.mul(K,M)),z=t.eql(t.mul(P,$),t.mul(H,M));return B&&z}negate(){return new k(this.X,t.neg(this.Y),this.Z)}double(){const{a:C,b:N}=r,P=t.mul(N,Xd),{X:M,Y:K,Z:H}=this;let $=t.ZERO,B=t.ZERO,z=t.ZERO,q=t.mul(M,M),Y=t.mul(K,K),Q=t.mul(H,H),j=t.mul(M,K);return j=t.add(j,j),z=t.mul(M,H),z=t.add(z,z),$=t.mul(C,z),B=t.mul(P,Q),B=t.add($,B),$=t.sub(Y,B),B=t.add(Y,B),B=t.mul($,B),$=t.mul(j,$),z=t.mul(P,z),Q=t.mul(C,Q),j=t.sub(q,Q),j=t.mul(C,j),j=t.add(j,z),z=t.add(q,q),q=t.add(z,q),q=t.add(q,Q),q=t.mul(q,j),B=t.add(B,q),Q=t.mul(K,H),Q=t.add(Q,Q),q=t.mul(Q,j),$=t.sub($,q),z=t.mul(Q,Y),z=t.add(z,z),z=t.add(z,z),new k($,B,z)}add(C){_(C);const{X:N,Y:P,Z:M}=this,{X:K,Y:H,Z:$}=C;let B=t.ZERO,z=t.ZERO,q=t.ZERO;const Y=r.a,Q=t.mul(r.b,Xd);let j=t.mul(N,K),we=t.mul(P,H),ue=t.mul(M,$),fe=t.add(N,P),ce=t.add(K,H);fe=t.mul(fe,ce),ce=t.add(j,we),fe=t.sub(fe,ce),ce=t.add(N,M);let ke=t.add(K,$);return ce=t.mul(ce,ke),ke=t.add(j,ue),ce=t.sub(ce,ke),ke=t.add(P,M),B=t.add(H,$),ke=t.mul(ke,B),B=t.add(we,ue),ke=t.sub(ke,B),q=t.mul(Y,ce),B=t.mul(Q,ue),q=t.add(B,q),B=t.sub(we,q),q=t.add(we,q),z=t.mul(B,q),we=t.add(j,j),we=t.add(we,j),ue=t.mul(Y,ue),ce=t.mul(Q,ce),we=t.add(we,ue),ue=t.sub(j,ue),ue=t.mul(Y,ue),ce=t.add(ce,ue),j=t.mul(we,ce),z=t.add(z,j),j=t.mul(ke,ce),B=t.mul(fe,B),B=t.sub(B,j),j=t.mul(fe,we),q=t.mul(ke,q),q=t.add(q,j),new k(B,z,q)}subtract(C){return this.add(C.negate())}is0(){return this.equals(k.ZERO)}multiply(C){const{endo:N}=e;if(!n.isValidNot0(C))throw new Error("invalid scalar: out of range");let P,M;const K=H=>F.cached(this,H,$=>la(k,$));if(N){const{k1neg:H,k1:$,k2neg:B,k2:z}=A(C),{p:q,f:Y}=K($),{p:Q,f:j}=K(z);M=Y.add(j),P=T(N.beta,q,Q,H,B)}else{const{p:H,f:$}=K(C);P=H,M=$}return la(k,[P,M])[0]}multiplyUnsafe(C){const{endo:N}=e,P=this;if(!n.isValid(C))throw new Error("invalid scalar: out of range");if(C===li||P.is0())return k.ZERO;if(C===Qc)return P;if(F.hasCache(this))return this.multiply(C);if(N){const{k1neg:M,k1:K,k2neg:H,k2:$}=A(C),{p1:B,p2:z}=pN(k,P,K,$);return T(N.beta,B,z,M,H)}else return F.unsafe(P,C)}multiplyAndAddUnsafe(C,N,P){const M=this.multiplyUnsafe(N).add(C.multiplyUnsafe(P));return M.is0()?void 0:M}toAffine(C){return R(this,C)}isTorsionFree(){const{isTorsionFree:C}=e;return s===Qc?!0:C?C(k,this):F.unsafe(this,i).is0()}clearCofactor(){const{clearCofactor:C}=e;return s===Qc?this:C?C(k,this):this.multiplyUnsafe(s)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}toBytes(C=!0){return Da("isCompressed",C),this.assertValidity(),u(k,this,C)}toRawBytes(C=!0){return this.toBytes(C)}toHex(C=!0){return _a(this.toBytes(C))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}k.BASE=new k(r.Gx,r.Gy,t.ONE),k.ZERO=new k(t.ZERO,t.ONE,t.ZERO),k.Fp=t,k.Fn=n;const D=n.BITS,F=new tS(k,e.endo?Math.ceil(D/2):D);return k}function wS(r){return Uint8Array.of(r?2:3)}function NO(r,e,t={}){td(e),jl(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=t.randomBytes||c0,s=t.hmac||(($,...B)=>id(e,$,ci(...B))),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,l=ZE(a),u={secret:o.BYTES,public:1+i.BYTES,publicUncompressed:1+2*i.BYTES,signature:2*o.BYTES,seed:l};function h($){const B=a>>Qc;return $>B}function d($){return h($)?o.neg($):$}function g($,B){if(!o.isValidNot0(B))throw new Error(`invalid signature ${$}: out of range 1..CURVE.n`)}class m{constructor(B,z,q){g("r",B),g("s",z),this.r=B,this.s=z,q!=null&&(this.recovery=q),Object.freeze(this)}static fromBytes(B,z="compact"){if(z==="compact"){const q=o.BYTES;Xr(B,q*2);const Y=B.subarray(0,q),Q=B.subarray(q,q*2);return new m(o.fromBytes(Y),o.fromBytes(Q))}if(z==="der"){Xr(B);const{r:q,s:Y}=si.toSig(B);return new m(q,Y)}throw new Error("invalid format")}static fromHex(B,z){return this.fromBytes(y1(B),z)}addRecoveryBit(B){return new m(this.r,this.s,B)}recoverPublicKey(B){const z=i.ORDER,{r:q,s:Y,recovery:Q}=this;if(Q==null||![0,1,2,3].includes(Q))throw new Error("recovery id invalid");if(a*yS<z&&Q>1)throw new Error("recovery id is ambiguous for h>1 curve");const we=Q===2||Q===3?q+a:q;if(!i.isValid(we))throw new Error("recovery id 2 or 3 invalid");const ue=i.toBytes(we),fe=r.fromHex(ci(wS((Q&1)===0),ue)),ce=o.inv(we),ke=D(bt("msgHash",B)),Oe=o.create(-ke*ce),ot=o.create(Y*ce),lt=r.BASE.multiplyUnsafe(Oe).add(fe.multiplyUnsafe(ot));if(lt.is0())throw new Error("point at infinify");return lt.assertValidity(),lt}hasHighS(){return h(this.s)}normalizeS(){return this.hasHighS()?new m(this.r,o.neg(this.s),this.recovery):this}toBytes(B="compact"){if(B==="compact")return ci(o.toBytes(this.r),o.toBytes(this.s));if(B==="der")return y1(si.hexFromSig(this));throw new Error("invalid format")}toHex(B){return _a(this.toBytes(B))}assertValidity(){}static fromCompact(B){return m.fromBytes(bt("sig",B),"compact")}static fromDER(B){return m.fromBytes(bt("sig",B),"der")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return _a(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return _a(this.toBytes("compact"))}}function b($){try{return!!$c(o,$)}catch{return!1}}function y($,B){try{const z=$.length;return B===!0&&z!==u.public||B===!1&&z!==u.publicUncompressed?!1:!!r.fromBytes($)}catch{return!1}}function _($=n(l)){return hN($,a)}const A={isValidSecretKey:b,isValidPublicKey:y,randomSecretKey:_,isValidPrivateKey:b,randomPrivateKey:_,normPrivateKeyToScalar:$=>$c(o,$),precompute($=8,B=r.BASE){return B.precompute($,!1)}};function R($,B=!0){return r.BASE.multiply($c(o,$)).toBytes(B)}function I($){if(typeof $=="bigint")return!1;if($ instanceof r)return!0;if(o.allowedLengths||u.secret===u.public)return;const B=bt("key",$).length;return B===u.public||B===u.publicUncompressed}function T($,B,z=!0){if(I($)===!0)throw new Error("first arg must be private key");if(I(B)===!1)throw new Error("second arg must be public key");const q=$c(o,$);return r.fromHex(B).multiply(q).toBytes(z)}const k=t.bits2int||function($){if($.length>8192)throw new Error("input is too large");const B=l0($),z=$.length*8-c;return z>0?B>>BigInt(z):B},D=t.bits2int_modN||function($){return o.create(k($))},F=nd(c);function O($){return eo("num < 2^"+c,$,li,F),o.toBytes($)}function C($,B,z=N){if(["recovered","canonical"].some(Oe=>Oe in z))throw new Error("sign() legacy options not supported");let{lowS:q,prehash:Y,extraEntropy:Q}=z;q==null&&(q=!0),$=bt("msgHash",$),Y8(z),Y&&($=bt("prehashed msgHash",e($)));const j=D($),we=$c(o,B),ue=[O(we),O(j)];if(Q!=null&&Q!==!1){const Oe=Q===!0?n(u.secret):Q;ue.push(bt("extraEntropy",Oe))}const fe=ci(...ue),ce=j;function ke(Oe){const ot=k(Oe);if(!o.isValidNot0(ot))return;const lt=o.inv(ot),Te=r.BASE.multiply(ot).toAffine(),Ke=o.create(Te.x);if(Ke===li)return;const Mt=o.create(lt*o.create(ce+Ke*we));if(Mt===li)return;let Ft=(Te.x===Ke?0:2)|Number(Te.y&Qc),Dt=Mt;return q&&h(Mt)&&(Dt=d(Mt),Ft^=1),new m(Ke,Dt,Ft)}return{seed:fe,k2sig:ke}}const N={lowS:t.lowS,prehash:!1},P={lowS:t.lowS,prehash:!1};function M($,B,z=N){const{seed:q,k2sig:Y}=C($,B,z);return eN(e.outputLen,o.BYTES,s)(q,Y)}r.BASE.precompute(8);function K($,B,z,q=P){const Y=$;B=bt("msgHash",B),z=bt("publicKey",z),Y8(q);const{lowS:Q,prehash:j,format:we}=q;if("strict"in q)throw new Error("options.strict was renamed to lowS");let ue,fe;if(we===void 0){const ce=typeof Y=="string"||g1(Y),ke=!ce&&Y!==null&&typeof Y=="object"&&typeof Y.r=="bigint"&&typeof Y.s=="bigint";if(!ce&&!ke)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(ke)ue=new m(Y.r,Y.s);else if(ce){try{ue=m.fromDER(Y)}catch(Oe){if(!(Oe instanceof si.Err))throw Oe}if(!ue)try{ue=m.fromCompact(Y)}catch{return!1}}}else if(we==="compact"||we==="der"){if(typeof Y!="string"&&!g1(Y))throw new Error('"der" / "compact" format expects Uint8Array signature');ue=m.fromBytes(bt("sig",Y),we)}else if(we==="js"){if(!(Y instanceof m))throw new Error('"js" format expects Signature instance');ue=Y}else throw new Error('format must be "compact", "der" or "js"');if(!ue)return!1;try{if(fe=r.fromHex(z),Q&&ue.hasHighS())return!1;j&&(B=e(B));const{r:ce,s:ke}=ue,Oe=D(B),ot=o.inv(ke),lt=o.create(Oe*ot),Te=o.create(ce*ot),Ke=r.BASE.multiplyUnsafe(lt).add(fe.multiplyUnsafe(Te));return Ke.is0()?!1:o.create(Ke.x)===ce}catch{return!1}}function H($){const B=A.randomSecretKey($);return{secretKey:B,publicKey:R(B)}}return Object.freeze({keygen:H,getPublicKey:R,sign:M,verify:K,getSharedSecret:T,utils:A,Point:r,Signature:m,info:{type:"weierstrass",lengths:u,publicKeyHasPrefix:!0}})}function OO(r){const e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp;let n=r.allowedPrivateKeyLengths?Array.from(new Set(r.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0;const s=rc(e.n,{BITS:r.nBitLength,allowedLengths:n,modOnDecode:r.wrapPrivateKey}),i={Fp:t,Fn:s,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:i}}function MO(r){const{CURVE:e,curveOpts:t}=OO(r),n={hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,hash:r.hash,ecdsaOpts:n}}function LO(r,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:r})}function BO(r){const{CURVE:e,curveOpts:t,hash:n,ecdsaOpts:s}=MO(r),i=RO(e,t),o=NO(i,n,s);return LO(r,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function $O(r,e){const t=n=>BO({...r,hash:n});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const e6={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},UO={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Q8=BigInt(2);function FO(r){const e=e6.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,h=It(u,t,e)*u%e,d=It(h,t,e)*u%e,g=It(d,Q8,e)*l%e,m=It(g,s,e)*g%e,b=It(m,i,e)*m%e,y=It(b,a,e)*b%e,_=It(y,c,e)*y%e,A=It(_,a,e)*b%e,R=It(A,t,e)*u%e,I=It(R,o,e)*m%e,T=It(I,n,e)*l%e,k=It(T,Q8,e);if(!Fm.eql(Fm.sqr(k),r))throw new Error("Cannot find square root");return k}const Fm=rc(e6.p,void 0,void 0,{sqrt:FO}),Ei=$O({...e6,Fp:Fm,lowS:!0,endo:UO},UE),VO=33,KO=32;function qO(r,e,t){const n=Qr.digest(e instanceof Uint8Array?e:e.subarray());if(u0(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),Ei.sign(s,r).toDERRawBytes())).catch(s=>{throw s.name==="AbortError"?s:new H8(String(s))});try{return Ei.sign(n.digest,r).toDERRawBytes()}catch(s){throw new H8(String(s))}}function HO(r,e,t,n){const s=Qr.digest(t instanceof Uint8Array?t:t.subarray());if(u0(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),Ei.verify(e,i,r))).catch(i=>{throw i.name==="AbortError"?i:new z8(String(i))});try{return n?.signal?.throwIfAborted(),Ei.verify(e,s.digest,r)}catch(i){throw new z8(String(i))}}class bS{type="secp256k1";raw;_key;constructor(e){this._key=GO(e),this.raw=WO(this._key)}toMultihash(){return wo.digest(yn(this))}toCID(){return Ne.createV1(114,this.toMultihash())}toString(){return $t.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}verify(e,t,n){return HO(this._key,t,e,n)}}class vS{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=jO(e),this.publicKey=new bS(t??YO(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:$e(this.raw,e.raw)}sign(e,t){return qO(this.raw,e,t)}}function ES(r){return new vS(r)}function t6(r){return new bS(r)}async function zO(){const r=QO();return new vS(r)}function WO(r){return Ei.ProjectivePoint.fromHex(r).toRawBytes(!0)}function jO(r){try{return Ei.getPublicKey(r,!0),r}catch(e){throw new aE(String(e))}}function GO(r){try{return Ei.ProjectivePoint.fromHex(r),r}catch(e){throw new u1(String(e))}}function YO(r){try{return Ei.getPublicKey(r,!0)}catch(e){throw new aE(String(e))}}function QO(){return Ei.utils.randomPrivateKey()}async function h0(r,e){if(r==="Ed25519")return FN();if(r==="secp256k1")return zO();if(r==="RSA")return vO(ZO(e));if(r==="ECDSA")return NR(JO(e));throw new zl}function Or(r,e){const{Type:t,Data:n}=bo.decode(r),s=n??new Uint8Array;switch(t){case Et.RSA:return wO(s,e);case Et.Ed25519:return H4(s);case Et.secp256k1:return t6(s);case Et.ECDSA:return PE(s);default:throw new zl}}function XO(r){if(r.byteLength===bh)return H4(r);if(r.byteLength===VO)return t6(r);const e=No(r),t=e[1]?.[0];if(t===_E||t===xE||t===AE)return DE(e);if(e[0]?.[0]===SO)return gS(e,r);throw new te("Could not extract public key from raw bytes")}function SS(r){const{Type:e,Data:t}=bo.decode(r.digest),n=t??new Uint8Array;switch(e){case Et.Ed25519:return H4(n);case Et.secp256k1:return t6(n);case Et.ECDSA:return PE(n);default:throw new zl}}function yn(r){return bo.encode({Type:Et[r.type],Data:r.raw})}function _S(r){const e=_1.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Et.RSA:return yO(t);case Et.Ed25519:return cS(t);case Et.secp256k1:return ES(t);case Et.ECDSA:return PR(t);default:throw new zl}}function Vm(r){if(r.byteLength===Ts)return cS(r);if(r.byteLength===KO)return ES(r);const e=No(r),t=e[2]?.[0];if(t===_E||t===xE||t===AE)return CE(e);if(e.length>8)return pS(e);throw new te("Could not extract private key from raw bytes")}function od(r){return _1.encode({Type:Et[r.type],Data:r.raw})}function ZO(r){return r==null?2048:parseInt(r,10)}function JO(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new te("Unsupported curve, should be P-256, P-384 or P-521")}async function xS(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new te("Only RSA and ECDSA keys are supported")}const AS=Symbol.for("nodejs.util.inspect.custom"),eM=114;class r6{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[D4]=!0;toString(){return this.string==null&&(this.string=$t.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ne.createV1(eM,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return $e(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return $e(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[AS](){return`PeerId(${this.toString()})`}}class IS extends r6{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class TS extends r6{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class kS extends r6{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const tM=2336;class CS{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=wo.digest(ne(this.url))}[AS](){return`PeerId(${this.url})`}[D4]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ne.createV1(tM,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=re(e)),e.toString()===this.toString())}}const rM=114,X8=2336;function Ht(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=pr($t.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Gl(Ne.parse(r));throw new te('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return En(t)}function Na(r){if(r.type==="Ed25519")return new TS({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new kS({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new IS({multihash:r.toCID().multihash,publicKey:r});throw new zl}function nM(r){return Na(r.publicKey)}function En(r){if(iM(r))return new IS({multihash:r});if(sM(r))try{const e=SS(r);if(e.type==="Ed25519")return new TS({multihash:r,publicKey:e});if(e.type==="secp256k1")return new kS({multihash:r,publicKey:e})}catch{const t=re(r.digest);return new CS(new URL(t))}throw new O4("Supplied PeerID Multihash is invalid")}function Gl(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==rM&&r.code!==X8)throw new UP("Supplied PeerID CID is invalid");if(r.code===X8){const e=re(r.multihash.digest);return new CS(new URL(e))}return En(r.multihash)}function sM(r){return r.code===wo.code}function iM(r){return r.code===Qr.code}function x1(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}const{hasOwnProperty:PS}=Object.prototype,{propertyIsEnumerable:oM}=Object,hl=(r,e,t)=>{Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},aM=void 0,Z8={concatArrays:!1,ignoreUndefined:!1},d0=r=>{const e=[];for(const t in r)PS.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)oM.call(r,n)&&e.push(n)}return e};function Yl(r){return Array.isArray(r)?cM(r):x1(r)?lM(r):r}function cM(r){const e=r.slice(0,0);return d0(r).forEach(t=>{hl(e,t,Yl(r[t]))}),e}function lM(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return d0(r).forEach(t=>{hl(e,t,Yl(r[t]))}),e}const DS=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?hl(r,s,Km(r[s],e[s],n)):hl(r,s,Yl(e[s])))}),r),uM=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)PS.call(i,a)&&(o.push(String(a)),i===r?hl(n,s++,i[a]):hl(n,s++,Yl(i[a])));n=DS(n,i,d0(i).filter(a=>!o.includes(a)),t)}),n};function Km(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?uM(r,e,t):!x1(e)||!x1(r)?Yl(e):DS(r,e,d0(e),t)}function n6(...r){const e=Km(Yl(Z8),this!==aM&&this||{},Z8);let t={_:{}};for(const n of r)if(n!==void 0){if(!x1(n))throw new TypeError("`"+n+"` is not an Option Object");t=Km(t,{_:n},e)}return t._}class ve extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}var A1=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function nc(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function hM(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var RS={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,h,d){if(typeof u!="function")throw new TypeError("The listener must be a function");var g=new s(u,h||c,d),m=t?t+l:l;return c._events[m]?c._events[m].fn?c._events[m]=[c._events[m],g]:c._events[m].push(g):(c._events[m]=g,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,h;if(this._eventsCount===0)return l;for(h in u=this._events)e.call(u,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=t?t+l:l,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var d=0,g=h.length,m=new Array(g);d<g;d++)m[d]=h[d].fn;return m},a.prototype.listenerCount=function(l){var u=t?t+l:l,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,u,h,d,g,m){var b=t?t+l:l;if(!this._events[b])return!1;var y=this._events[b],_=arguments.length,A,R;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),_){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,u),!0;case 3:return y.fn.call(y.context,u,h),!0;case 4:return y.fn.call(y.context,u,h,d),!0;case 5:return y.fn.call(y.context,u,h,d,g),!0;case 6:return y.fn.call(y.context,u,h,d,g,m),!0}for(R=1,A=new Array(_-1);R<_;R++)A[R-1]=arguments[R];y.fn.apply(y.context,A)}else{var I=y.length,T;for(R=0;R<I;R++)switch(y[R].once&&this.removeListener(l,y[R].fn,void 0,!0),_){case 1:y[R].fn.call(y[R].context);break;case 2:y[R].fn.call(y[R].context,u);break;case 3:y[R].fn.call(y[R].context,u,h);break;case 4:y[R].fn.call(y[R].context,u,h,d);break;default:if(!A)for(T=1,A=new Array(_-1);T<_;T++)A[T-1]=arguments[T];y[R].fn.apply(y[R].context,A)}}return!0},a.prototype.on=function(l,u,h){return i(this,l,u,h,!1)},a.prototype.once=function(l,u,h){return i(this,l,u,h,!0)},a.prototype.removeListener=function(l,u,h,d){var g=t?t+l:l;if(!this._events[g])return this;if(!u)return o(this,g),this;var m=this._events[g];if(m.fn)m.fn===u&&(!d||m.once)&&(!h||m.context===h)&&o(this,g);else{for(var b=0,y=[],_=m.length;b<_;b++)(m[b].fn!==u||d&&!m[b].once||h&&m[b].context!==h)&&y.push(m[b]);y.length?this._events[g]=y.length===1?y[0]:y:o(this,g)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&o(this,u)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(RS);var dM=RS.exports;const fM=nc(dM);class NS extends Error{constructor(e){super(e),this.name="TimeoutError"}}let pM=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const J8=r=>globalThis.DOMException===void 0?new pM(r):new DOMException(r),ew=r=>{const e=r.reason===void 0?J8("This operation was aborted."):r.reason;return e instanceof Error?e:J8(e)};function f0(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((u,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:g}=e;g.aborted&&h(ew(g)),a=()=>{h(ew(g))},g.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,h);return}const d=new NS;o=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(g){h(g)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?u():s instanceof Error?h(s):(d.message=s??`Promise timed out after ${t} milliseconds`,h(d))},t),(async()=>{try{u(await r)}catch(g){h(g)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},l}function gM(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}let mM=class{#e=[];enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}const s=gM(this.#e,n,(i,o)=>o.priority-i.priority);this.#e.splice(s,0,n)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class dl extends fM{#e;#t;#r=0;#o;#a;#u=0;#s;#h;#n;#c;#i=0;#d;#l;#f;#b=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:mM,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#o=e.intervalCap,this.#a=e.interval,this.#n=new e.queueClass,this.#c=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#f=e.throwOnTimeout===!0,this.#l=e.autoStart===!1}get#v(){return this.#t||this.#r<this.#o}get#E(){return this.#i<this.#d}#S(){this.#i--,this.#p(),this.emit("next")}#_(){this.#w(),this.#y(),this.#h=void 0}get#x(){const e=Date.now();if(this.#s===void 0){const t=this.#u-e;if(t<0)this.#r=this.#e?this.#i:0;else return this.#h===void 0&&(this.#h=setTimeout(()=>{this.#_()},t)),!0}return!1}#p(){if(this.#n.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#i===0&&this.emit("idle"),!1;if(!this.#l){const e=!this.#x;if(this.#v&&this.#E){const t=this.#n.dequeue();return t?(this.emit("active"),t(),e&&this.#y(),!0):!1}}return!1}#y(){this.#t||this.#s!==void 0||(this.#s=setInterval(()=>{this.#w()},this.#a),this.#u=Date.now()+this.#a)}#w(){this.#r===0&&this.#i===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#r=this.#e?this.#i:0,this.#g()}#g(){for(;this.#p(););}get concurrency(){return this.#d}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#d=e,this.#g()}async#A(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#b++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#f,...t},new Promise((n,s)=>{this.#n.enqueue(async()=>{this.#i++,this.#r++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=f0(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#A(t.signal)]));const o=await i;n(o),this.emit("completed",o)}catch(i){if(i instanceof NS&&!t.throwOnTimeout){n();return}s(i),this.emit("error",i)}finally{this.#S()}},t),this.emit("add"),this.#p()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#l?(this.#l=!1,this.#g(),this):this}pause(){this.#l=!0}clear(){this.#n=new this.#c}async onEmpty(){this.#n.size!==0&&await this.#m("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#m("next",()=>this.#n.size<e)}async onIdle(){this.#i===0&&this.#n.size===0||await this.#m("idle")}async#m(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#l}}function OS(r){const e=[Eo.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const MS=60;function LS(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Eo[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Eo[e.type],TTL:e.TTL??e.ttl??MS,data:e.data instanceof Uint8Array?re(e.data):e.data}))}}const yM=4;function tw(r,e={}){const t=new dl({concurrency:e.queryConcurrency??yM});return async(n,s={})=>{const i=new URLSearchParams;i.set("name",n),OS(s.types).forEach(a=>{i.append("type",Eo[a])}),s.onProgress?.(new ve("dns:query",{detail:n}));const o=await t.add(async()=>{const a=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const c=LS(await a.json());return s.onProgress?.(new ve("dns:response",{detail:c})),c},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function wM(){return[tw("https://cloudflare-dns.com/dns-query"),tw("https://dns.google/resolve")]}var bM=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};const vM=nc(bM);class EM{lru;constructor(e){this.lru=vM(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return LS({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Eo[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??MS)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function SM(r){return new EM(r)}const _M=1e3;let xM=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=SM(e.cacheSize??_M),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=wM())}async query(e,t={}){const n=OS(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new ve("dns:cache",{detail:s})),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const l=await c(e,{...t,types:n});for(const u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new ve("dns:error",{detail:l}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var Eo;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Eo||(Eo={}));function BS(r={}){return new xM(r)}class Mn extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class Eh extends Error{static name="ValidationError";name="ValidationError"}class AM extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class IM extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}class TM{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*s)-1;for(;;){const u=this.readAtomically(()=>{const h=this.readChar();if(h===void 0)return;const d=Number.parseInt(h,e);if(!Number.isNaN(d))return d});if(u===void 0)break;if(i*=e,i+=u,i>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const $S=45,kM=15,fl=new TM;function US(r){if(!(r.length>kM))return fl.new(r).parseWith(()=>fl.readIPv4Addr())}function FS(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>$S))return fl.new(r).parseWith(()=>fl.readIPv6Addr())}function qm(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>$S)return;const t=fl.new(r).parseWith(()=>fl.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function Oa(r){return!!US(r)}function s6(r){return!!FS(r)}const Ma=4,pi=6,I1=273,CM=33,Un=41,sc=42,i6=43,ad=53,cd=54,Ql=55,ld=56,PM=132,DM=301,RM=302,VS=400,st=421,NM=444,OM=445,MM=446,LM=447,Xc=448,KS=449,BM=454,qS=460,HS=461,zS=465,Sh=466,Zc=480,$M=481,Hm=443,o6=477,WS=478,UM=479,FM=277,VM=275,KM=276,jS=280,Kf=281,ic=290,GS=777;function rw(r){return e=>re(e,r)}function nw(r){return e=>ne(e,r)}function Hu(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Uc(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function qM(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=ne(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Uc(n);return Rr([t,s],t.length+s.length)}function HM(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=hn.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Uc(n);return Rr([t,s],t.length+s.length)}function sw(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=re(e,"base32"),s=Hu(t);return`${n}:${s}`}const YS=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new Mn("Invalid byte value in IP address");e[n]=s}),e},zM=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=Oa(t[n]);let o;i&&(o=YS(t[n]),t[n]=re(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,re(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new Mn("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},WM=function(r){if(r.byteLength!==4)throw new Mn("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},jM=function(r){if(r.byteLength!==16)throw new Mn("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new Mn(`Invalid IPv6 address "${t}"`)}};function GM(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Mn(`Invalid IPv6 address "${r}"`)}}const lg=Object.values(p1).map(r=>r.decoder),YM=function(){let r=lg[0].or(lg[1]);return lg.slice(2).forEach(e=>r=r.or(e)),r}();function QM(r){return YM.decode(r)}function XM(r){return e=>r.encoder.encode(e)}function ZM(r){if(parseInt(r).toString()!==r)throw new Eh("Value must be an integer")}function JM(r){if(r<0)throw new Eh("Value must be a positive integer, or zero")}function eL(r){return e=>{if(e>r)throw new Eh(`Value must be smaller than or equal to ${r}`)}}function tL(...r){return e=>{for(const t of r)t(e)}}const Zd=tL(ZM,JM,eL(65535)),yr=-1;let rL=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new IM(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}};const as=new rL,nL=[{code:Ma,name:"ip4",size:32,valueToBytes:YS,bytesToValue:WM,validate:r=>{if(!Oa(r))throw new Eh(`Invalid IPv4 address "${r}"`)}},{code:pi,name:"tcp",size:16,valueToBytes:Uc,bytesToValue:Hu,validate:Zd},{code:I1,name:"udp",size:16,valueToBytes:Uc,bytesToValue:Hu,validate:Zd},{code:CM,name:"dccp",size:16,valueToBytes:Uc,bytesToValue:Hu,validate:Zd},{code:Un,name:"ip6",size:128,valueToBytes:zM,bytesToValue:jM,stringToValue:GM,validate:r=>{if(!s6(r))throw new Eh(`Invalid IPv6 address "${r}"`)}},{code:sc,name:"ip6zone",size:yr},{code:i6,name:"ipcidr",size:8,bytesToValue:rw("base10"),valueToBytes:nw("base10")},{code:ad,name:"dns",size:yr,resolvable:!0},{code:cd,name:"dns4",size:yr,resolvable:!0},{code:Ql,name:"dns6",size:yr,resolvable:!0},{code:ld,name:"dnsaddr",size:yr,resolvable:!0},{code:PM,name:"sctp",size:16,valueToBytes:Uc,bytesToValue:Hu,validate:Zd},{code:DM,name:"udt"},{code:RM,name:"utp"},{code:VS,name:"unix",size:yr,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:st,name:"p2p",aliases:["ipfs"],size:yr,bytesToValue:rw("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?nw("base58btc")(r):Ne.parse(r).multihash.bytes},{code:NM,name:"onion",size:96,bytesToValue:sw,valueToBytes:qM},{code:OM,name:"onion3",size:296,bytesToValue:sw,valueToBytes:HM},{code:MM,name:"garlic64",size:yr},{code:LM,name:"garlic32",size:yr},{code:Xc,name:"tls"},{code:KS,name:"sni",size:yr},{code:BM,name:"noise"},{code:qS,name:"quic"},{code:HS,name:"quic-v1"},{code:zS,name:"webtransport"},{code:Sh,name:"certhash",size:yr,bytesToValue:XM(Jh),valueToBytes:QM},{code:Zc,name:"http"},{code:$M,name:"http-path",size:yr,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:Hm,name:"https"},{code:o6,name:"ws"},{code:WS,name:"wss"},{code:UM,name:"p2p-websocket-star"},{code:FM,name:"p2p-stardust"},{code:VM,name:"p2p-webrtc-star"},{code:KM,name:"p2p-webrtc-direct"},{code:jS,name:"webrtc-direct"},{code:Kf,name:"webrtc"},{code:ic,name:"p2p-circuit"},{code:GS,name:"memory",size:yr}];nL.forEach(r=>{as.addProtocol(r)});function sL(r){const e=[];let t=0;for(;t<r.length;){const n=Di(r,t),s=as.getProtocol(n),i=tt(n),o=cL(s,r,t+i);let a=0;o>0&&s.size===yr&&(a=tt(o));const c=i+a+o,l={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const u=t+i+a,h=r.subarray(u,u+o);l.value=s.bytesToValue?.(h)??re(h)}e.push(l),t+=c}return e}function iL(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=as.getProtocol(n.code),i=tt(n.code);let o,a=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??ne(n.value),a=o.byteLength,s.size===yr&&(c=tt(a)));const l=new Uint8Array(i+c+a);let u=0;E1(n.code,l,u),u+=i,o!=null&&(s.size===yr&&(E1(a,l,u),u+=c),l.set(o,u)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return Rr(t,e)}function oL(r){if(r.charAt(0)!=="/")throw new Mn('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const a=i===r.length-1;if(o==="/"||a){const c=as.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new Mn(`Component ${s} was missing value`);t="value"}else if(t==="value"){const l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new Mn(`Component ${s} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new Mn("Incomplete multiaddr");return e}function aL(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=as.getProtocol(e.code);if(t==null)throw new Mn(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function cL(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Di(e,t)}const lL=Symbol.for("nodejs.util.inspect.custom"),QS=Symbol.for("@multiformats/multiaddr"),uL=[ad,cd,Ql,ld];class hL extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function dL(r){if(r==null&&(r="/"),p0(r))return r.getComponents();if(r instanceof Uint8Array)return sL(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),oL(r);if(Array.isArray(r))return r;throw new Mn("Must be a string, Uint8Array, Component[], or another Multiaddr")}class Fc{[QS]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=dL(e),t.validate!==!1&&fL(this)}get bytes(){return this.#r==null&&(this.#r=iL(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=aL(this.#e)),this.#t}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";for(const{code:a,name:c,value:l}of this.#e)a===sc&&(i=`%${l??""}`),uL.includes(a)&&(t="tcp",s=443,n=`${l??""}${i}`,e=a===Ql?6:4),(a===pi||a===I1)&&(t=c==="tcp"?"tcp":"udp",s=parseInt(l??"")),(a===Ma||a===Un)&&(t="tcp",n=`${l??""}${i}`,e=a===Un?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{const n=as.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];const n=as.getProtocol(e),s=[e];return t!=null&&s.push(n.valueToBytes?.(t)??ne(t)),s})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){const t=new Fc(e);return new Fc([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new AM(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Fc(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new Fc(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:n,value:s})=>{n===st&&e.push([n,s]),n===ic&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?re($t.decode(`z${n}`),"base58btc"):re(Ne.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(const e of this.#e)if(as.getProtocol(e.code).path)return e.value??null;return null}equals(e){return $e(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=AL.get(t.name);if(n==null)throw new hL(`no available resolver for ${t.name}`);return(await n(this,e)).map(i=>Ie(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==Ma&&this.#e[0].code!==Un||this.#e[1].code!==pi&&this.#e[1].code!==I1)}[lL](){return`Multiaddr(${this.toString()})`}}function fL(r){r.getComponents().forEach(e=>{const t=as.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function pL(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function gL(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function mL(r){switch(r.length){case _h:return r.join(".");case xh:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function yL(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;n&128;)e++,n=n<<1;if(n&128)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function wL(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const _h=4,xh=16,bL=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function XS(r,e){e.length===xh&&r.length===_h&&pL(e,0,11)&&(e=e.slice(12)),e.length===_h&&r.length===xh&&gL(r,bL,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function vL(r,e){if(typeof e=="string"&&(e=qm(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function EL(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=_h,s=US(e);if(s==null&&(n=xh,s=FS(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=ZS(i,8*n);return{network:XS(s,o),mask:o}}function ZS(r,e){if(e!==8*_h&&e!==8*xh)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class JS{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=EL(e));else{const n=qm(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=qm(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=ZS(s,8*n.length);this.network=XS(n,this.mask)}}contains(e){return vL({network:this.network,mask:this.mask},e)}toString(){const e=yL(this.mask),t=e!==-1?String(e):wL(this.mask);return mL(this.network)+"/"+t}}function SL(r,e){return new JS(r).contains(e)}function _L(r){let e,t;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(t=n.value),n.name==="ipcidr"&&(e=n.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new JS(t,e)}function xL(r,e){return as.getProtocol(r).bytesToValue?.(e)??re(e,"base16")}const AL=new Map;function p0(r){return!!r?.[QS]}function Ie(r){return new Fc(r)}function Xl(r){const e=as.getProtocol(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}class IL{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Eo.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(const c of i.Answer){const l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(o!=null&&!l.includes(o)||a.push(Ie(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=BS()),this.dns)}}const a6=new IL,TL={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:a6}},transportManager:{faultTolerance:yh.FATAL_ALL}};async function kL(r){const e=n6(TL,r);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new te("Private network is enforced, but no protector was provided");return e}const pl=1e3,gl=pl*60,ml=gl*60,La=ml*24,CL=La*7,PL=La*365.25;function e_(r,e){try{if(typeof r=="string"&&r.length>0)return DL(r);if(typeof r=="number"&&isFinite(r))return e?.long?NL(r):RL(r);throw new Error("Value is not a string or number.")}catch(t){const n=OL(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function DL(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;const t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*PL;case"weeks":case"week":case"w":return t*CL;case"days":case"day":case"d":return t*La;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ml;case"minutes":case"minute":case"mins":case"min":case"m":return t*gl;case"seconds":case"second":case"secs":case"sec":case"s":return t*pl;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}function RL(r){const e=Math.abs(r);return e>=La?`${Math.round(r/La)}d`:e>=ml?`${Math.round(r/ml)}h`:e>=gl?`${Math.round(r/gl)}m`:e>=pl?`${Math.round(r/pl)}s`:`${r}ms`}function NL(r){const e=Math.abs(r);return e>=La?Jd(r,e,La,"day"):e>=ml?Jd(r,e,ml,"hour"):e>=gl?Jd(r,e,gl,"minute"):e>=pl?Jd(r,e,pl,"second"):`${r} ms`}function Jd(r,e,t,n){const s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function OL(r){return typeof r=="object"&&r!==null&&"message"in r}function ML(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=e_,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let h=0;for(let d=0;d<u.length;d++)h=(h<<5)-h+u.charCodeAt(d),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(u){let h,d=null,g,m;function b(...y){if(!b.enabled)return;const _=b,A=Number(new Date),R=A-(h||A);_.diff=R,_.prev=h,_.curr=A,h=A,y[0]=t.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let I=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(k,D)=>{if(k==="%%")return"%";I++;const F=t.formatters[D];if(typeof F=="function"){const O=y[I];k=F.call(_,O),y.splice(I,1),I--}return k}),t.formatArgs.call(_,y),(_.log||t.log).apply(_,y)}return b.namespace=u,b.useColors=t.useColors(),b.color=t.selectColor(u),b.extend=n,b.destroy=t.destroy,Object.defineProperty(b,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(g!==t.namespaces&&(g=t.namespaces,m=t.enabled(u)),m),set:y=>{d=y}}),typeof t.init=="function"&&t.init(b),b}function n(u,h){const d=t(this.namespace+(typeof h>"u"?":":h)+u);return d.log=this.log,d}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let h;const d=(typeof u=="string"?u:"").split(/[\s,]+/),g=d.length;for(h=0;h<g;h++)d[h]&&(u=d[h].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function i(){const u=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let h,d;for(h=0,d=t.skips.length;h<d;h++)if(t.skips[h].test(u))return!1;for(h=0,d=t.names.length;h<d;h++)if(t.names[h].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var LL={};const T1=qL(),BL=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function $L(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function UL(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+e_(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const FL=console.debug??console.log??(()=>{});function VL(r){try{r?T1?.setItem("debug",r):T1?.removeItem("debug")}catch{}}function KL(){let r;try{r=T1?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=LL.DEBUG),r}function qL(){try{return localStorage}catch{}}function HL(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const dn=ML({formatArgs:UL,save:VL,load:KL,useColors:$L,setupFormatters:HL,colors:BL,storage:T1,log:FL});dn.formatters.b=r=>r==null?"undefined":$t.baseEncode(r);dn.formatters.t=r=>r==null?"undefined":hn.baseEncode(r);dn.formatters.m=r=>r==null?"undefined":$n.baseEncode(r);dn.formatters.p=r=>r==null?"undefined":r.toString();dn.formatters.c=r=>r==null?"undefined":r.toString();dn.formatters.k=r=>r==null?"undefined":r.toString();dn.formatters.a=r=>r==null?"undefined":r.toString();dn.formatters.e=r=>r==null?"undefined":iw(r.stack)??iw(r.message)??r.toString();function zL(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function g0(){return{forComponent(r){return Zl(r)}}}function Zl(r){let e=zL(`${r}:trace`);return dn.enabled(`${r}:trace`)&&dn.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=dn(`${r}:trace`)),Object.assign(dn(r),{error:dn(`${r}:error`),trace:e})}function iw(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function Zu(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function ug(r){const e=pr($t.decode(`z${r}`));return En(e)}class oc{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Zu(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Zu(this.map.values(),e=>e.key)}values(){return Zu(this.map.values(),e=>e.value)}get size(){return this.map.size}}class Ds{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Zu(this.set.entries(),e=>{const t=ug(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=ug(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Zu(this.set.values(),e=>ug(e))}intersection(e){const t=new Ds;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new Ds;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new Ds;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function WL(){return new Ds}function t_(r,e,t,n){td(r);const s=$R({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:a}=s;if(Sa(i),Sa(o),Sa(a),i<1)throw new Error("iterations (c) should be >= 1");const c=N8(e),l=N8(t),u=new Uint8Array(o),h=id.create(r,c),d=h._cloneInto().update(l);return{c:i,dkLen:o,asyncTick:a,DK:u,PRF:h,PRFSalt:d}}function r_(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),$s(s),t}function jL(r,e,t,n){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:c}=t_(r,e,t,n);let l;const u=new Uint8Array(4),h=Xu(u),d=new Uint8Array(a.outputLen);for(let g=1,m=0;m<i;g++,m+=a.outputLen){const b=o.subarray(m,m+a.outputLen);h.setInt32(0,g,!1),(l=c._cloneInto(l)).update(u).digestInto(d),b.set(d.subarray(0,b.length));for(let y=1;y<s;y++){a._cloneInto(l).update(d).digestInto(d);for(let _=0;_<b.length;_++)b[_]^=d[_]}}return r_(a,c,o,l,d)}async function n_(r,e,t,n){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=t_(r,e,t,n);let u;const h=new Uint8Array(4),d=Xu(h),g=new Uint8Array(c.outputLen);for(let m=1,b=0;b<i;m++,b+=c.outputLen){const y=a.subarray(b,b+c.outputLen);d.setInt32(0,m,!1),(u=l._cloneInto(u)).update(h).digestInto(g),y.set(g.subarray(0,y.length)),await BR(s-1,o,()=>{c._cloneInto(u).update(g).digestInto(g);for(let _=0;_<y.length;_++)y[_]^=g[_]})}return r_(c,l,a,u,g)}const _u=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),Hi=new Uint32Array(80);class GL extends F4{constructor(){super(64,20,8,!1),this.A=_u[0]|0,this.B=_u[1]|0,this.C=_u[2]|0,this.D=_u[3]|0,this.E=_u[4]|0}get(){const{A:e,B:t,C:n,D:s,E:i}=this;return[e,t,n,s,i]}set(e,t,n,s,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)Hi[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)Hi[c]=tg(Hi[c-3]^Hi[c-8]^Hi[c-14]^Hi[c-16],1);let{A:n,B:s,C:i,D:o,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=LE(s,i,o),u=1518500249):c<40?(l=s^i^o,u=1859775393):c<60?(l=BE(s,i,o),u=2400959708):(l=s^i^o,u=3395469782);const h=tg(n,5)+l+a+u+Hi[c]|0;a=o,o=i,i=tg(s,30),s=n,n=h}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(n,s,i,o,a)}roundClean(){$s(Hi)}destroy(){this.set(0,0,0,0,0),$s(this.buffer)}}const YL=U4(()=>new GL),QL=YL,c6=FE,ow={sha1:QL,"sha2-256":Aa,"sha2-512":c6};function aw(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(ow).join(" / ");throw new te(`Hash '${s}' is unknown or not supported. Must be ${a}`)}const i=ow[s],o=jL(i,r,e,{c:t,dkLen:n});return $n.encode(o).substring(1)}const l6={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},s_={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},i_=new globalThis.TextEncoder;function XL(r,e){const t=l6[e];let n=s_[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function ZL(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=l6[e];let s=s_[e],i=r;for(;i.length>0;){const o=i_.encodeInto(i,t);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(t[a]),s=BigInt.asUintN(e,s*n)}return s}function JL(r,{size:e=32,utf8Buffer:t}={}){if(!l6[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return ZL(r,e,t);r=i_.encode(r)}return XL(r,e)}const u6={hash:r=>Number(JL(r,{size:32})),hashV:(r,e)=>eB(u6.hash(r,e))};function eB(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),ne(e,"base16")}const o_=64;class ua{fp;h;seed;constructor(e,t,n,s=2){if(s>o_)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=Be(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?$e(this.fp,e.fp):!1}}function k1(r,e){return Math.floor(Math.random()*(e-r))+r}class ef{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof ua))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof ua))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof ua))throw new TypeError("Invalid Fingerprint");const t=k1(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof ua))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const tB=500;class cw{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??u6,this.seed=e.seed??k1(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=ne(e));const t=new ua(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new ef(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new ef(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[k1(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new ef(this.bucketSize));for(let a=0;a<tB;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new ef(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=ne(e));const t=new ua(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=ne(e));const t=new ua(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const rB={1:.5,2:.84,4:.95,8:.98};function nB(r=.001){return r>.002?2:r>1e-5?4:8}function sB(r,e=.001){const t=nB(e),n=rB[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),o_);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class iB{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??u6,this.seed=e.seed??k1(0,Math.pow(2,10)),this.filterSeries=[new cw({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=ne(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new cw({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=ne(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=ne(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function So(r,e=.001,t){return new iB({...sB(r,e)})}class oB{filter;constructor(e,t){this.filter=So(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function aB(r,e=.001){return new oB(r,e)}class cB extends oc{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function m0(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new cB({name:e,metrics:t}):n=new oc,n}var C1;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Be(0),payloadType:Be(0),payload:Be(0),signature:Be(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(C1||(C1={}));class lB extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class Rs{static createFromProtobuf=e=>{const t=C1.decode(e),n=Or(t.publicKey);return new Rs({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),a=lw(s,i,o),c=await t.sign(a.subarray(),n);return new Rs({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=Rs.createFromProtobuf(e);if(!await s.validate(t,n))throw new lB("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=C1.encode({publicKey:yn(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:$e(this.marshal(),e.marshal())}async validate(e,t){const n=lw(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const lw=(r,e,t)=>{const n=ne(r),s=Yr(n.byteLength),i=Yr(e.length),o=Yr(t.length);return new Pe(s,n,i,e,o,t)};function uB(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}const hB="libp2p-peer-record",dB=Uint8Array.from([3,1]);var P1;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:Be(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.multiaddr=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:Be(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new nt('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(P1||(P1={}));class pn{static createFromProtobuf=e=>{const t=P1.decode(e),n=En(pr(t.peerId)),s=(t.addresses??[]).map(o=>Ie(o.multiaddr)),i=t.seq;return new pn({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=hB;static CODEC=dB;peerId;multiaddrs;seqNumber;domain=pn.DOMAIN;codec=pn.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=P1.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof pn)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!uB(this.multiaddrs,e.multiaddrs))}}function fB(r){return r[Symbol.asyncIterator]!=null}function D1(r){if(fB(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}let yl=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function Fe(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class uw{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class hg{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new uw(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new uw(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let pB=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Vn(r={}){return gB(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function gB(r,e){e=e??{};let t=e.onEnd,n=new hg,s,i,o,a=Fe();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((y,_)=>{i=A=>{i=null,n.push(A);try{y(r(n))}catch(R){_(R)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Fe()})}},l=y=>i!=null?i(y):(n.push(y),s),u=y=>(n=new hg,i!=null?i({error:y}):(n.push({error:y}),s)),h=y=>{if(o)return s;if(e?.objectMode!==!0&&y?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:y})},d=y=>o?s:(o=!0,y!=null?u(y):l({done:!0})),g=()=>(n=new hg,d(),{done:!0}),m=y=>(d(y),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:g,throw:m,push:h,end:d,get readableLength(){return n.size},onEmpty:async y=>{const _=y?.signal;if(_?.throwIfAborted(),n.isEmpty())return;let A,R;_!=null&&(A=new Promise((I,T)=>{R=()=>{T(new pB)},_.addEventListener("abort",R)}));try{await Promise.race([a.promise,A])}finally{R!=null&&_!=null&&_?.removeEventListener("abort",R)}}},t==null)return s;const b=s;return s={[Symbol.asyncIterator](){return this},next(){return b.next()},throw(y){return b.throw(y),t!=null&&(t(y),t=void 0),{done:!0}},return(){return b.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(y){return b.end(y),t!=null&&(t(y),t=void 0),s},get readableLength(){return b.readableLength},onEmpty:y=>b.onEmpty(y)},s}async function Pr(r,e,t,n){const s=new yl(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((o,a)=>{function c(){fg(t,"abort",h),fg(r,e,l),fg(r,i,u)}const l=d=>{try{if(n?.filter?.(d)===!1)return}catch(g){c(),a(g);return}c(),o(d)},u=d=>{if(c(),d instanceof Error){a(d);return}a(d.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},h=()=>{c(),a(s)};dg(t,"abort",h),dg(r,e,l),dg(r,i,u)})}function dg(r,e,t){r!=null&&(a_(r)?r.addListener(e,t):r.addEventListener(e,t))}function fg(r,e,t){r!=null&&(a_(r)?r.removeListener(e,t):r.removeEventListener(e,t))}function a_(r){return typeof r.on=="function"&&typeof r.emit=="function"}let mB=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},hw=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function Zt(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new hw(t?.errorMessage,t?.errorCode,t?.errorName));let n;const s=new hw(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((i,o)=>{n=()=>{o(s)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}let yB=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new yl)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function wB(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let bB=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=wB(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new yl),this.cleanup())}async join(e={}){const t=new yB(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Zt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function dw(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}let fw=class extends Tt{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=dw(this.emitEmpty.bind(this),1),this.emitIdle=dw(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new mB;const n=new bB(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new yl)}),this.clear()}async onEmpty(e){this.size!==0&&await Pr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Pr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Pr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Vn({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new yl("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}};const c_="lock:worker:request-read",l_="lock:worker:abort-read-request",u_="lock:worker:release-read",h_="lock:master:grant-read",d_="lock:master:error-read",f_="lock:worker:request-write",p_="lock:worker:abort-write-request",g_="lock:worker:release-write",m_="lock:master:grant-write",y_="lock:master:error-write",w_="lock:worker:finalize",b_="mortice",vB={singleProcess:!1},pw=(r,e,t,n,s,i,o,a,c)=>l=>{if(l.data==null)return;const u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===s&&r.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(h=>{const d=g=>{if(g?.data==null)return;const m={type:g.data.type,name:g.data.name,identifier:g.data.identifier};m.type===a&&m.identifier===u.identifier&&(e.removeEventListener("message",d),h())};e.addEventListener("message",d)})},onError:h=>{e.postMessage({type:o,name:u.name,identifier:u.identifier,error:{message:h.message,name:h.name,stack:h.stack}})}}}),u.type===i&&r.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===w_&&r.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})},EB=(r=10)=>Math.random().toString().substring(2,r+2);class SB{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(b_)}readLock(e){return this.sendRequest(c_,l_,h_,d_,u_,e)}writeLock(e){return this.sendRequest(f_,p_,m_,y_,g_,e)}finalize(){this.channel.postMessage({type:w_,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const a=EB();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{const u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};o?.signal?.addEventListener("abort",u,{once:!0});const h=d=>{if(d.data?.identifier===a&&(d.data?.type===n&&(this.channel.removeEventListener("message",h),o?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),d.data.type===s)){this.channel.removeEventListener("message",h),o?.signal?.removeEventListener("abort",u);const g=new Error;d.data.error!=null&&(g.message=d.data.error.message,g.name=d.data.error.name,g.stack=d.data.error.stack),l(g)}};this.channel.addEventListener("message",h)})}}const _B=r=>{if(r=Object.assign({},vB,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(b_),n=new Tt;return t.addEventListener("message",pw(n,t,"requestReadLock","abortReadLockRequest",c_,l_,d_,u_,h_)),t.addEventListener("message",pw(n,t,"requestWriteLock","abortWriteLockRequest",f_,p_,y_,g_,m_)),n}return new SB(r.name)},ha=new Map;let xu;function v_(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function xB(r){if(xu==null&&(xu=_B(r),!v_(xu))){const e=xu;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=ha.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=ha.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=ha.get(n);s?.finalize()})}return xu}async function pg(r,e){let t,n;const s=new Promise((o,a)=>{t=o,n=a}),i=()=>{n(new yl)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const AB=(r,e)=>{let t=ha.get(r);if(t!=null)return t;const n=xB(e);if(v_(n))return t=n,ha.set(r,t),t;const s=new fw({concurrency:1});let i;return t={async readLock(o){if(i!=null)return pg(i,o);i=new fw({concurrency:e.concurrency,autoStart:!1});const a=i,c=pg(i,o);return s.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(o){return i=null,pg(s,o)},finalize:()=>{ha.delete(r)},queue:s},ha.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},IB={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function E_(r){const e=Object.assign({},IB,r);return AB(e.name,e)}const TB=36e5,kB=216e5;var da;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:Be(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),N1.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=N1.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),R1.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new nt('Decode error - map field "addresses" had too many elements');i.addresses.push(R1.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new nt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new j8('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new j8('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(da||(da={}));var R1;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:Be(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(R1||(R1={}));var N1;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(N1||(N1={}));function CB(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=Or(e.publicKey,t);return Na(n)}function PB(r,e,t){const n=da.decode(e);return zu(r,n,t)}function zu(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:CB(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:Ie(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function DB(r,e){return RB(r.addresses,e.addresses)&&NB(r.protocols,e.protocols)&&OB(r.publicKey,e.publicKey)&&MB(r.peerRecordEnvelope,e.peerRecordEnvelope)&&LB(r.metadata,e.metadata)&&BB(r.tags,e.tags)}function RB(r,e){return __(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!$e(t.multiaddr,n.multiaddr)))}function NB(r,e){return __(r,e,(t,n)=>t===n)}function OB(r,e){return S_(r,e)}function MB(r,e){return S_(r,e)}function LB(r,e){return x_(r,e,(t,n)=>$e(t,n))}function BB(r,e){return x_(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function S_(r,e){return r==null&&e==null?!0:r!=null&&e!=null?$e(r,e):!1}function __(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function x_(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const ri="/",A_=new TextEncoder().encode(ri),tf=A_[0];class ft{_buf;constructor(e,t){if(typeof e=="string")this._buf=ne(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==tf)throw new Error("Invalid key")}toString(e="utf8"){return re(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ft(e.join(ri))}static random(){return new ft(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new ft(e):typeof e.uint8Array=="function"?new ft(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=A_),this._buf[0]!==tf){const e=new Uint8Array(this._buf.byteLength+1);e.fill(tf,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===tf;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return ft.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(ri).slice(1)}type(){return $B(this.baseNamespace())}name(){return UB(this.baseNamespace())}instance(e){return new ft(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(ri)||(e+=ri),e+=this.type(),new ft(e)}parent(){const e=this.list();return e.length===1?new ft(ri):new ft(e.slice(0,-1).join(ri))}child(e){return this.toString()===ri?e:e.toString()===ri?this:new ft(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return ft.withNamespaces([...this.namespaces(),...FB(e.map(t=>t.namespaces()))])}}function $B(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function UB(r){const e=r.split(":");return e[e.length-1]}function FB(r){return[].concat(...r)}const I_="/peers/";function rf(r){if(!va(r)||r.type==null)throw new te("Invalid PeerId");const e=r.toCID().toString();return new ft(`${I_}${e}`)}async function VB(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=Ie(o.multiaddr)),!p0(o.multiaddr))throw new te("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),l=i.get(c);l!=null?o.isCertified=l.isCertified||a:i.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...i.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(Ie(`/p2p/${r}`))),{isCertified:o,multiaddr:a.bytes}})}async function gg(r,e,t,n){if(e==null)throw new te("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new te("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new te("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,l=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=nf(d,{validate:gw})}if(e.tags!=null){const d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=nf(d,{validate:mw,map:yw})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[g,m]of d)m==null?a.delete(g):a.set(g,m);a=nf([...a.entries()],{validate:gw})}if(e.tags!=null){const d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),g=new Map(c);for(const[m,b]of d)b==null?g.delete(m):g.set(m,b);c=nf([...g.entries()],{validate:mw,map:yw})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;s?.id.publicKey!=null?u=yn(s.id.publicKey):e.publicKey!=null?u=yn(e.publicKey):r.publicKey!=null&&(u=yn(r.publicKey));const h={addresses:await VB(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((d,g)=>d.localeCompare(g)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return h.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(g=>$e(g.multiaddr,g.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete h.publicKey,h}function nf(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function gw(r,e){if(typeof r!="string")throw new te("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new te("Metadata value must be a Uint8Array")}function mw(r,e){if(typeof r!="string")throw new te("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new te("Tag value must be an integer");if(e.value<0||e.value>100)throw new te("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new te("Tag ttl must be an integer");if(e.ttl<0)throw new te("Tag ttl must be between greater than 0")}}function yw(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function T_(r){const e=r.toString().split("/")[2],t=Ne.parse(e,hn);return Gl(t)}function mg(r,e,t){const n=T_(r);return PB(n,e,t)}function KB(r,e){return{prefix:I_,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(mg(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(mg(n.key,n.value,e),mg(s.key,s.value,e)))}}class qB{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=m0({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??TB,this.maxPeerAge=t.maxPeerAge??kB}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:E_({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(rf(e),t)}async load(e,t){const n=rf(e),s=await this.datastore.get(n,t),i=da.decode(s);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Ut;return zu(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await gg(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await gg(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await gg(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(KB(e??{},this.maxAddressAge),e)){const s=T_(t);if(s.equals(this.peerId))continue;const i=da.decode(n);if(this.#r(s,i)){await this.datastore.delete(t,e);continue}yield zu(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=rf(e),s=await this.datastore.get(n,t),i=da.decode(s);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Ut;return{peerPB:i,peer:zu(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,s){t.updated=Date.now();const i=da.encode(t);return await this.datastore.put(rf(e),i,s),{peer:zu(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!DB(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class HB{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new qB(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return D1(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=va(t)?t:va(t?.expectedPeer)?t.expectedPeer:void 0,i=va(t)||t===void 0?n:t,o=await Rs.openAndCertify(e,pn.DOMAIN,i),a=Gl(o.publicKey.toCID());if(s?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,a),!1;const c=pn.createFromProtobuf(o.payload);let l;try{l=await this.get(a,i)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){const u=Rs.createFromProtobuf(l.peerRecordEnvelope),h=pn.createFromProtobuf(u.payload);if(h.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",h.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function zB(r,e={}){return new HB(r,e)}class wl extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=wl.name;code=wl.code;constructor(e="Not Found"){super(e)}}function WB(r){return r[Symbol.asyncIterator]!=null}function Si(r){if(WB(r))return(async()=>{for await(const e of r);})();for(const e of r);}function h6(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function jB(r){return r[Symbol.asyncIterator]!=null}function Zo(r,e){let t=0;if(jB(r))return async function*(){for await(const c of r)await e(c,t++)&&(yield c)}();const n=h6(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield s);for(const c of n)a(c,t++)&&(yield c)}()}function GB(r){return r[Symbol.asyncIterator]!=null}function ww(r,e){return GB(r)?async function*(){yield*(await D1(r)).sort(e)}():function*(){yield*D1(r).sort(e)}()}function YB(r){return r[Symbol.asyncIterator]!=null}function O1(r,e){return YB(r)?async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}}()}class QB{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Si(this.putMany(e,n)),e=[],await Si(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=Zo(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>Zo(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>ww(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=Zo(n,()=>s++>=i)}return e.limit!=null&&(n=O1(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=Zo(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>Zo(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>ww(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=Zo(n,()=>i++>=s)}return e.limit!=null&&(n=O1(n,e.limit)),n}}class d6 extends QB{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new wl;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new ft(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new ft(n),t?.signal?.throwIfAborted()}}function Ah(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var k_;(function(){var r,e,t,n,s,i,o,a;a=function(c){var l,u,h,d;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,h=(c&65280)>>>8,d=c&255,[l,u,h,d].join(".")},o=function(c){var l,u,h,d,g,m;for(l=[],h=d=0;d<=3&&c.length!==0;h=++d){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),g=m[0],u=m[1],c=c.substring(u),l.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var l,u,h,d,g;for(d=0,l=10,u="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,l=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,l=8,u="7")),g=h;h<c.length;){if("0"<=c[h]&&c[h]<=u)d=d*l+(t(c[h])-n)>>>0;else if(l===16)if("a"<=c[h]&&c[h]<="f")d=d*l+(10+t(c[h])-i)>>>0;else if("A"<=c[h]&&c[h]<="F")d=d*l+(10+t(c[h])-s)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");h++}if(h===g)throw new Error("empty octet");return[d,h]},r=function(){function c(l,u){var h,d,g;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(g=l.split("/",2),l=g[0],u=g[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,h,d;for(d=o(this.first),h=o(this.last),u=0;d<=h;)l(a(d),d,u),u++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),k_=r}).call(A1);const XB=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],ZB=XB.map(r=>new k_(r));function f6(r){for(const e of ZB)if(e.contains(r))return!0;return!1}function JB(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function e$(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return f6(s)}function t$(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function r$(r){const e=r.split(":"),t=e[e.length-1];return f6(t)}function n$(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Oo(r){if(Oa(r))return f6(r);if(JB(r))return e$(r);if(t$(r))return r$(r);if(s6(r))return n$(r)}const pt=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),Se=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),Ye=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),Mr=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),et=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function dt(...r){function e(s){if(s==null)return!1;let i=s.getComponents();for(const o of r){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const s$=Se(st),i$=dt(s$),y0=Se(cd),w0=Se(Ql),b0=Se(ld),p6=Se(ad);dt(y0,Ye(Se(st)));dt(w0,Ye(Se(st)));dt(b0,Ye(Se(st)));const o$=dt(Mr(p6,b0,y0,w0),Ye(Se(st))),C_=et(Se(Ma),Ye(Se(i6))),P_=et(Ye(Se(sc)),Se(Un),Ye(Se(i6))),g6=Mr(C_,P_),Ba=Mr(g6,p6,y0,w0,b0),a$=dt(Mr(g6,et(Mr(p6,b0,y0,w0),Ye(Se(st))))),bw=dt(C_),vw=dt(P_),c$=dt(g6),m6=et(Ba,Se(pi)),ud=et(Ba,Se(I1)),M1=dt(et(m6,Ye(Se(st))));dt(ud);const y6=et(ud,pt(qS),Ye(Se(st))),v0=et(ud,pt(HS),Ye(Se(st))),l$=Mr(y6,v0);dt(y6);const u$=dt(v0),zm=Mr(Ba,m6,ud,y6,v0),D_=Mr(et(zm,pt(o6),Ye(Se(st)))),Ih=dt(D_),R_=Mr(et(zm,pt(WS),Ye(Se(st))),et(zm,pt(Xc),Ye(Se(KS)),pt(o6),Ye(Se(st)))),L1=dt(R_),N_=et(ud,pt(jS),Ye(Se(Sh)),Ye(Se(Sh)),Ye(Se(st))),Wm=dt(N_),O_=et(v0,pt(zS),Ye(Se(Sh)),Ye(Se(Sh)),Ye(Se(st))),Ew=dt(O_),B1=Mr(D_,R_,et(m6,Ye(Se(st))),et(l$,Ye(Se(st))),et(Ba,Ye(Se(st))),N_,O_,Se(st)),M_=dt(B1),h$=et(B1,pt(ic),Se(st)),_o=dt(h$),d$=Mr(et(B1,pt(ic),pt(Kf),Ye(Se(st))),et(B1,pt(Kf),Ye(Se(st))),et(pt(Kf),Ye(Se(st)))),jm=dt(d$),f$=Mr(et(Ba,Se(pi),pt(Zc),Ye(Se(st))),et(Ba,pt(Zc),Ye(Se(st))));dt(f$);const p$=et(Ba,Mr(et(Se(pi,"443"),pt(Zc)),et(Se(pi),pt(Hm)),et(Se(pi),pt(Xc),pt(Zc)),et(pt(Xc),pt(Zc)),pt(Xc),pt(Hm)),Ye(Se(st)));dt(p$);const g$=Mr(et(Se(GS),Ye(Se(st))));dt(g$);const m$=Mr(et(Se(VS),Ye(Se(st))));dt(m$);class y$ extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function hs(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new y$({name:e,metrics:t}):n=new Map,n}const Sw=864e13,w$=448,yg=449,b$=53,v$=54,E$=55,S$=56;class _${log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=hs({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=Oo(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?Sw-Date.now():0,lastVerified:s?Sw-Date.now():void 0})})}remove(e){const t=this.findHost(e);let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:Ie(`/${i.map(u=>[Xl(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===w$&&e[n+1]?.[0]!==yg)return e.splice(n+1,0,[yg,t]),!0;return!1}confirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+t);return s}findHost(e){for(const t of e.stringTuples())if(t[0]===yg||t[0]===b$||t[0]===v$||t[0]===E$||t[0]===S$)return t[1]}}const wg=4,bg=41,vg=6,x$=273;class A${log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=hs({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:Oa(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),n=t[0][1]??"",s=t[1][0]===vg?"tcp":"udp",i=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===n&&u.externalPort===i&&u.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,n,i,s),o=o||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:n}of e){const s=n.stringTuples();let i;if((s[0][0]===wg||s[0][0]===bg)&&s[1][0]===vg?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===wg||s[0][0]===bg)&&s[1][0]===x$&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?wg:bg,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,t.push({multiaddr:Ie(`/${s.map(c=>[Xl(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){const n=e.stringTuples(),s=n[0][1]??"",i=n[1][0]===vg?"tcp":"udp",o=parseInt(n[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===s&&u.externalPort===o&&u.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,s,o,i),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}}function I$(r){try{for(const{code:e,value:t}of r.getComponents())if(e!==sc&&t!=null){if(e===Ma)return t.startsWith("169.254.");if(e===Un)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function L_(r){try{for(const{code:e}of r.getComponents())if(e!==sc)return e===Ma||e===Un}catch{}return!1}function $a(r){try{if(!L_(r))return!1;const[[,e]]=r.stringTuples();return e==null?!1:Oo(e)??!1}catch{}return!0}const T$={maxObservedAddresses:10};class k${log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=hs({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??T$.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&($a(e)||I$(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:Ie(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const C$=[Ma,Un,ad,cd,Ql,ld];function _w(r){try{for(const{code:e}of r.getComponents())if(e!==sc)return C$.includes(e)}catch{}return!1}const P$={maxObservedAddresses:10};class D${log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=hs({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??P$.maxObservedAddresses}get(e,t){if($a(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!_w(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(_w(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const xw=6e4,Aw={addressVerificationTTL:xw*10,addressVerificationRetry:xw*5},R$=r=>r;function Eg(r,e){const t=r.getPeerId();return t!=null&&Ht(t).equals(e)&&(r=r.decapsulate(Ie(`/p2p/${e.toString()}`))),r}class N${log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new k$(e,t),this.dnsMappings=new _$(e,t),this.ipMappings=new A$(e,t),this.transportAddresses=new D$(e,t),this.announceFilter=t.announceFilter??R$,this.observedAddressFilter=So(1024),this.addressVerificationTTL=t.addressVerificationTTL??Aw.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??Aw.addressVerificationRetry,this._updatePeerStoreAddresses=Ah(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>Ie(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>Ie(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>Ie(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=Eg(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Eg(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Eg(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=Ie(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(Ie(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${Oa(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(Ie(`/ip${Oa(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||Oo(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>Ih.exactMatch(i)||L1.exactMatch(i),i=>M1.exactMatch(i),i=>u$.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&i(u)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var Iw;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(Iw||(Iw={}));class O$ extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class M$ extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Sg extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class Tw extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class L$ extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class B$ extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class $$ extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class kw extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class U$ extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class F$ extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class V$ extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class K$ extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class q$ extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class sf extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class of extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class H$ extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class z$ extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class W${components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=g0())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>L4(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const j$=["metrics","connectionProtector","dns"],G$=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Y$(r={}){const e=new W$(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!G$.includes(s)){const o=e.components[s];if(o==null&&!j$.includes(s))throw new O$(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function Q$(r){const e={};for(const t of Object.values(r.components))for(const n of X$(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of Z$(t))if(e[n]!==!0)throw new M$(`Service "${J$(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function X$(r){return Array.isArray(r?.[Jt])?r[Jt]:[]}function Z$(r){return Array.isArray(r?.[yo])?r[yo]:[]}function J$(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}const eU=4,tU=41;function rU(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Ih.matches(e))return!1;const t=e.stringTuples();return t[0][0]===eU||t[0][0]===tU?!!Oo(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}const Cw=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},nU=new WeakMap;function sU({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(Cw());let i,o,a;const c=r??clearTimeout,l=()=>{c(i),a(Cw())},u=()=>{s&&s.removeEventListener("abort",l)},h=new Promise((d,g)=>{o=()=>{u(),d(n)},a=g,i=(e??setTimeout)(o,t)});return s&&s.addEventListener("abort",l,{once:!0}),nU.set(h,()=>{c(i),i=null,o()}),h}}const B_=sU();class iU extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}class oU extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class $_{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new aU}async consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new iU("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await B_(a)}return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}let aU=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};function U_(r){if(va(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getPeerId();t=n==null?void 0:Ht(n),e.forEach(s=>{if(!p0(s))throw new N4("Invalid multiaddr");const i=s.getPeerId();if(i==null){if(t!=null)throw new te("Multiaddrs must all have the same peer id or have no peer id")}else{const o=Ht(i);if(t?.equals(o)!==!0)throw new te("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!i$.exactMatch(n)),{peerId:t,multiaddrs:e}}const cU=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function lU(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??cU;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function Gm(r){try{let e;typeof r=="string"?e=Ie(r):e=r;const t=new Set([...e.getComponents().map(n=>n.name)]);if(!t.has("ipcidr")){const s=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(s)}return _L(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}class uU{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Gm(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new oc;for(const c of e){const l=c.remotePeer;if(!s.has(l)){s.set(l,0);try{const u=await this.peerStore.get(l);s.set(l,[...u.tags.values()].reduce((h,d)=>h+d.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),a=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>u.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await lU(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const F_=1e4,hU=1e4,Pw=1e4,V_=25,dU=5,fU=10,pU=5,gU="last-dial-failure",mU="last-dial-success",K_=500,yU=32,wU=100,q_=50;class bU{deferred;signal;constructor(e){this.signal=e,this.deferred=Fe(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new wi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function vU(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class EU{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=vU(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new wi),this.cleanup())}async join(e={}){const t=new bU(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Zt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}class xo extends Tt{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Ah(this.emitEmpty.bind(this),1),this.emitIdle=Ah(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new oU;const n=new EU(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:s}),this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new wi)}),this.clear()}async onEmpty(e){this.size!==0&&await Pr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Pr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Pr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Vn({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail)},o=()=>{n()},a=()=>{n(new wi("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("error",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}}class SU extends xo{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}function Je(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}function _U(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Dw(r){if(!L_(r))return!1;const{address:e}=r.nodeAddress();return _U(e)}function xU(r,e){const t=M1.exactMatch(r.multiaddr),n=M1.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=L1.exactMatch(r.multiaddr),i=L1.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=Ih.exactMatch(r.multiaddr),a=Ih.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=jm.exactMatch(r.multiaddr),l=jm.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const u=Wm.exactMatch(r.multiaddr),h=Wm.exactMatch(e.multiaddr);if(u&&!h)return-1;if(!u&&h)return 1;const d=Ew.exactMatch(r.multiaddr),g=Ew.exactMatch(e.multiaddr);return d&&!g?-1:!d&&g?1:0}function AU(r,e){const t=Dw(r.multiaddr),n=Dw(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function IU(r,e){const t=$a(r.multiaddr),n=$a(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function TU(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function kU(r,e){const t=_o.exactMatch(r.multiaddr),n=_o.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function CU(r){return r.sort(xU).sort(TU).sort(kU).sort(IU).sort(AU)}async function H_(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??yU))throw new z$("Max recursive depth reached");let s=!1;const i=[];for(const o of Object.values(e))if(o.canResolve(r)){s=!0;const a=await o.resolve(r,t);for(const c of a)i.push(...await H_(c,e,{...t,depth:n+1}))}return s===!1&&i.push(r),i}const Au={maxParallelDials:q_,maxDialQueueLength:K_,maxPeerAddrsToDial:V_,dialTimeout:F_,resolvers:{dnsaddr:a6}};class PU{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Au.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Au.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Au.dialTimeout,this.connections=t.connections??new oc,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Au.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new SU({concurrency:t.maxParallelDials??Au.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==wi.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=U_(e),i=Array.from(this.connections.values()).flat().find(a=>t.force===!0||a.limits!=null?!1:a.remotePeer.equals(n)?!0:s.find(c=>c.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new ve("dial-queue:already-connected")),i;const o=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;const c=a.options.multiaddrs;if(c==null)return!1;for(const l of s)if(c.has(l.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(const a of s)o.options.multiaddrs.add(a.toString());return t.onProgress?.(new ve("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Qu("Dial queue is full");return this.log("creating dial target for %p",n,s.map(a=>a.toString())),t.onProgress?.(new ve("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new ve("dial-queue:start-dial"));const c=Je([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??W_,multiaddrs:new Set(s.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const u=[],h=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...h]);const d=await this.calculateMultiaddrs(n,h,{...e,signal:t});for(const g of d){if(i.has(g.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",g.multiaddr,n);continue}u.push(g)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(g=>g.multiaddr.toString())),e?.onProgress?.(new ve("dial-queue:calculated-addresses",u));for(const g of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new Qu("Peer had more than maxPeerAddrsToDial");a++;try{const m=await this.components.transportManager.dial(g.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",g.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[mU]:ne(Date.now().toString())}})}catch(b){this.log.error("could not update last dial failure key for %p",n,b)}return m}catch(m){if(this.log.error("dial failed to %a",g.multiaddr,m),i.add(g.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[gU]:ne(Date.now().toString())}})}catch(b){this.log.error("could not update last dial failure key for %p",n,b)}if(t.aborted)throw new Xh(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(h=>({multiaddr:Ie(h),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Qu("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new kw("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const h=await this.components.peerStore.get(e);s.push(...h.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:d})=>d.toString()))}catch(h){if(h.name!=="NotFoundError")throw h}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const h=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:d})=>d.toString())),s.push(...h.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(h){h.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,h)}}}let i=(await Promise.all(s.map(async h=>{const d=await H_(h.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return d.length===1&&d[0].equals(h.multiaddr)?h:d.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(e!=null){const h=`/p2p/${e.toString()}`;i=i.map(d=>d.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:d.multiaddr.encapsulate(h),isCertified:d.isCertified}:d)}const o=i.filter(h=>{if(this.components.transportManager.dialTransportForMultiaddr(h.multiaddr)==null)return!1;const d=h.multiaddr.getPeerId();return e!=null&&d!=null?e.equals(d):!0}),a=new Map;for(const h of o){const d=h.multiaddr.toString(),g=a.get(d);if(g!=null){g.isCertified=g.isCertified||h.isCertified||!1;continue}a.set(d,h)}const c=[...a.values()];if(c.length===0)throw new V$("The dial request has no valid addresses");const l=[];for(const h of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(h.multiaddr)||l.push(h);const u=this.addressSorter==null?CU(l):l.sort(this.addressSorter);if(u.length===0)throw new kw("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:h})=>h.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:h})=>h.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!_o.matches(s.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}}class Ao extends xo{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}var z_={};function Kn(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var DU=Kn;Kn.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Kn.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Kn.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Kn.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Kn.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Kn.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Kn.prototype.start=Kn.prototype.try;Kn.prototype.errors=function(){return this._errors};Kn.prototype.attempts=function(){return this._attempts};Kn.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var s=this._errors[n],i=s.message,o=(r[i]||0)+1;r[i]=o,o>=t&&(e=s,t=o)}return e};(function(r){var e=DU;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)n[s]=t[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<n.retries;o++)i.push(this.createTimeout(o,n));return t&&t.forever&&!i.length&&i.push(this.createTimeout(o,n)),i.sort(function(a,c){return a-c}),i},r.createTimeout=function(t,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return i=Math.min(i,n.maxTimeout),i},r.wrap=function(t,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],c=t[a];t[a]=function(u){var h=r.operation(n),d=Array.prototype.slice.call(arguments,1),g=d.pop();d.push(function(m){h.retry(m)||(m&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){u.apply(t,d)})}.bind(t,c),t[a].options=n}}})(z_);var RU=z_;const NU=nc(RU),OU=Object.prototype.toString,MU=r=>OU.call(r)==="[object Error]",LU=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function BU(r){return r&&MU(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:LU.has(r.message):!1}class $U extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Rw=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function UU(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;const s=NU.operation(e),i=()=>{s.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});const o=()=>{e.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const c=await r(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof $U)throw c.originalError;if(c instanceof TypeError&&!BU(c))throw c;if(Rw(c,a,e),await e.shouldRetry(c)||(s.stop(),n(c)),await e.onFailedAttempt(c),!s.retry(c))throw s.mainError()}catch(l){Rw(l,a,e),o(),n(l)}}})})}class FU{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Ao({concurrency:t.maxParallelReconnects??pU,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Nw(t)&&(this.queue.has(e)||this.queue.add(async n=>{await UU(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(r0)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>Nw(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function Nw(r){for(const e of r.tags.keys())if(e.startsWith(r0))return!0;return!1}const W_=50,_g={maxConnections:wU,inboundConnectionThreshold:dU,maxIncomingPendingConnections:fU};class VU{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??_g.maxConnections,this.maxConnections<1)throw new te("Connection Manager maxConnections must be greater than 0");this.connections=new oc,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Gm(n)),this.deny=(t.deny??[]).map(n=>Gm(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??_g.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new $_({points:t.inboundConnectionThreshold??_g.inboundConnectionThreshold,duration:1}),this.connectionPruner=new uU({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>Ie(n))}),this.dialQueue=new PU(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??q_,maxDialQueueLength:t.maxDialQueueLength??K_,maxPeerAddrsToDial:t.maxPeerAddrsToDial??V_,dialTimeout:t.dialTimeout??F_,resolvers:t.resolvers??{dnsaddr:a6},connections:this.connections}),this.reconnectQueue=new FU({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await bi(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Ro(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new te("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new ll("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n}=U_(e);if(this.peerId.equals(n))throw new uE("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),t.onProgress?.(new ve("dial-queue:already-connected")),a}const s=await this.dialQueue.dial(e,{...t,priority:t.priority??W_});if(s.status!=="open")throw new cE("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const a of i)if(a.id===s.id&&(o=!0),t.force!==!0&&a.id!==s.id&&a.remoteAddr.equals(s.remoteAddr))return s.abort(new N4("Duplicate multiaddr connection")),a;return o||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>Ie(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class xg{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const KU=1.2,qU=2,HU=5e3,zU=6e4,WU=5e3;class Th{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??WU;this.success=new xg(t),this.failure=new xg(t),this.next=new xg(t),this.failureMultiplier=e.failureMultiplier??qU,this.timeoutMultiplier=e.timeoutMultiplier??KU,this.minTimeout=e.minTimeout??HU,this.maxTimeout=e.maxTimeout??zU,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=Je([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class jU{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=Fe(),this.haveNext=Fe()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Fe(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Fe(),await Zt(this.readNext.promise,t?.signal,t)}}function j_(){return new jU}let GU=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function $1(r,e){const t=j_();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const s=new Pe;return{read:async o=>{if(o?.signal?.throwIfAborted(),o?.bytes==null){const{done:c,value:l}=await Zt(n.next(),o?.signal);return c===!0?null:l}for(;s.byteLength<o.bytes;){const{value:c,done:l}=await Zt(n.next(),o?.signal);if(l===!0)throw new GU("unexpected end of input");s.append(c)}const a=s.sublist(0,o.bytes);return s.consume(o.bytes),a},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=r.source;r.source=async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*o}()}return r}}}const YU=1e4,QU="1.0.0",XU="ping",ZU="ipfs",Ow=32,JU=!0;class eF{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??ZU}/${XU}/${QU}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??YU,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??JU,this.timeout=new Th({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[Jt]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=$1(s);t=Date.now(),await Promise.all([i.write(vo(Ow),{signal:n}),i.read({bytes:Ow,signal:n})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}function tF(r){return r[Symbol.asyncIterator]!=null}async function rF(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*nF(r){const e=new AbortController,t=j_();rF(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*sF(r){for(const e of r)yield*e}function lo(...r){const e=[];for(const t of r)tF(t)||e.push(t);return e.length===r.length?sF(e):nF(r)}class iF{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:re(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:re(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Sg("No content routers available");const n=this,s=new Ds;for await(const i of lo(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new Sg("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Sg("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new ll;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new ll;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}const af=globalThis.CustomEvent??Event;async function*E0(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=Fe(),a=Fe(),c=!1,l,u=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const m of r){if(i.length===t&&(o=Fe(),await o.promise),u)break;const b={done:!1};i.push(b),m().then(y=>{b.done=!0,b.ok=!0,b.value=y,s.dispatchEvent(new af("task-complete"))},y=>{b.done=!0,b.err=y,s.dispatchEvent(new af("task-complete"))})}c=!0,s.dispatchEvent(new af("task-complete"))}catch(m){l=m,s.dispatchEvent(new af("task-complete"))}});function h(){return n?i[0]?.done:!!i.find(m=>m.done)}function*d(){for(;i.length>0&&i[0].done;){const m=i[0];if(i.shift(),m.ok)yield m.value;else throw u=!0,o.resolve(),m.err;o.resolve()}}function*g(){for(;h();)for(let m=0;m<i.length;m++)if(i[m].done){const b=i[m];if(i.splice(m,1),m--,b.ok)yield b.value;else throw u=!0,o.resolve(),b.err;o.resolve()}}for(;;){if(h()||(a=Fe(),await a.promise),l!=null||(n?yield*d():yield*g(),l!=null))throw l;if(c&&i.length===0)break}}class oF{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:re(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Tw("No peer routers available");if(e.toString()===this.peerId.toString())throw new L$("Should not try to find self");const n=this,s=lo(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new Ut}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Tw("No peer routers available");const n=this,s=So(1024);for await(const i of E0(async function*(){const o=lo(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class aF extends Tt{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=Je([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=Fe(),yield(await Pr(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=Je([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=vo(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Zt(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const G_=32,Y_=64;class cF{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=hs({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new B$(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new $$(`Handler already registered for protocol ${e}`);const s=n6.bind({ignoreUndefined:!0})({maxInboundStreams:G_,maxOutboundStreams:Y_},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new te("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,n).then(s=>{for(const i of s.protocols){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(s=>{s.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,s)})}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));for(const i of s){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;for(const i of t){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),a.onConnect?.(s,n))}}}class lF{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=hs({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=hs({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??yh.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new te("Transport must have a valid tag");if(this.transports.has(t))throw new te(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new H$(`No transport available for address ${String(e)}`);return t?.onProgress?.(new ve("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new ll("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new U$)});const n=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",i,c);const l=o.createListener({upgrader:this.components.upgrader});let u=this.listeners.get(i)??[];u==null&&(u=[],this.listeners.set(i,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const h=u.findIndex(d=>d===l);u.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),bw.matches(c)?t.ipv4.attempts++:vw.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),bw.matches(c)&&t.ipv4.success++,vw.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,h),t.errors.set(c.toString(),h),h}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===yh.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new F$(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Hr="/multistream/1.0.0",w6=1024;let uF=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},hF=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},dF=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function ds(r,e={}){const t=$1(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=tt(e.maxDataLength));const n=e?.lengthDecoder??Di,s=e?.lengthEncoder??Yr;return{read:async o=>{let a=-1;const c=new Pe;for(;;){c.append(await t.read({...o,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new uF("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new dF("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new hF("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Pe(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Pe(...o.flatMap(l=>[s(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}const fF=ne(`
`);async function Wu(r,e,t){await r.write(e,t)}async function pF(r,e,t){await r.writeV(e,t)}async function gF(r,e){const t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==fF[0])throw e.log.error("Invalid mss message - missing newline",t),new mt("Missing newline");return t.sublist(0,-1)}async function Jc(r,e){const t=await gF(r,e);return re(t.subarray())}async function Ag(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return mF(r,e[0],t);const n=ds(r,{...t,maxDataLength:w6}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Hr,s);const i=ne(`${Hr}
`),o=ne(`${s}
`);await pF(n,[i,o],t),t.log.trace("select: reading multistream-select header");let a=await Jc(n,t);if(t.log.trace('select: read "%s"',a),a===Hr&&(t.log.trace("select: reading protocol response"),a=await Jc(n,t),t.log.trace('select: read "%s"',a)),a===s)return{stream:n.unwrap(),protocol:s};for(const c of e){t.log.trace('select: write "%s"',c),await Wu(n,ne(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await Jc(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new s0("protocol selection failed")}function mF(r,e,t){const n=r.sink.bind(r),s=r.source;let i=!1,o=!1;const a=Fe();let c=!1,l=!1;const u=Fe();let h=!1,d=!1;const g=Fe(),m=ds({sink:n,source:s},{...t,maxDataLength:w6});r.sink=async A=>{const{sink:R}=m.unwrap();await R(async function*(){let I=!1;for await(const T of A){if(l&&await u.promise,c)yield T;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Hr,e,T.byteLength);const k=`${e}
`;yield new Pe(Uint8Array.from([19]),ne(`${Hr}
`),Yr(k.length),ne(k),T).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Hr,e,T.byteLength),c=!0,l=!1,u.resolve(),b().catch(D=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,D)})}I=!0}I||await b()}())};async function b(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await y()),h||(t.log.trace("optimistic: doing read protocol for %s stream",e),await _())}finally{o=!1,i=!0,a.resolve()}}async function y(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Hr,e),await m.writeV([ne(`${Hr}
`),ne(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Hr,e)}finally{c=!0,l=!1,u.resolve()}}async function _(){if(d){await g.promise;return}d=!0;try{t.log.trace("optimistic: reading multistream select header");let A=await Jc(m,t);if(t.log.trace('optimistic: read multistream select header "%s"',A),A===Hr&&(A=await Jc(m,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',A,e),A!==e)throw new s0("protocol selection failed")}finally{h=!0,d=!1,g.resolve()}}if(r.source=async function*(){await b(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*m.unwrap().source}(),r.closeRead!=null){const A=r.closeRead.bind(r);r.closeRead=async R=>{i||await b().catch(I=>{t.log.error("could not negotiate protocol before close read",I)}),await A(R)}}if(r.closeWrite!=null){const A=r.closeWrite.bind(r);r.closeWrite=async R=>{i||await b().catch(I=>{t.log.error("could not negotiate protocol before close write",I)}),await A(R)}}if(r.close!=null){const A=r.close.bind(r);r.close=async R=>{const I=[];l&&I.push(u.promise),d&&I.push(g.promise),I.length>0?await Zt(Promise.all(I),R?.signal):(i=!0,o=!1,a.resolve()),await A(R)}}return{stream:r,protocol:e}}const Q_=1024*1024*4;let yF=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"};function wF(r){return r[Symbol.asyncIterator]!=null}function X_(r,e){if(r.byteLength>e)throw new yF("Message length too long")}const S0=r=>{const e=tt(r),t=xr(e);return Yr(r,t),S0.bytes=e,t};S0.bytes=0;function Z_(r,e){e=e??{};const t=e.lengthEncoder??S0,n=e?.maxDataLength??Q_;function*s(i){X_(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return wF(r)?async function*(){for await(const i of r)yield*s(i)}():function*(){for(const i of r)yield*s(i)}()}Z_.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??S0,n=e?.maxDataLength??Q_;return X_(r,n),new Pe(t(r.byteLength),r)};var Mw;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Mw||(Mw={}));async function Ig(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const n=ds(r,{...t,maxDataLength:w6,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const s=await Jc(n,t);if(t.log.trace('handle: read "%s"',s),s===Hr){t.log.trace('handle: respond with "%s" for "%s"',Hr,s),await Wu(n,ne(`${Hr}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Hr,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await Wu(n,ne(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:n.unwrap(),protocol:s};if(s==="ls"){const i=new Pe(...e.map(o=>Z_.single(ne(`${o}
`))),ne(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await Wu(n,i,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log.trace('handle: respond with "na" for "%s"',s),await Wu(n,ne(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}const bF=500;class vF{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:i,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[OP]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new BP("the connection is being closed");if(this.status==="closed")throw new cE("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new hE("Cannot open protocol stream on limited connection");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(bF);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function EF(r){return new vF(r)}function SF(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return G_}function _F(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??Y_}function Lw(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class xF{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=hs({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=hs({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??hU,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??Pw,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??Pw,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new K$(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return Je([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await Zt(this.components.connectionManager.acceptIncomingConnection(e),s),!n)throw new q$("Connection denied");await Zt(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getPeerId();let s;n!=null&&(s=Ht(n),await Zt(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s,i,o,a,c;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if(n?.skipProtection!==!0){const u=this.components.connectionProtector;u!=null&&(e.log("protecting the %s connection",t),l=await u.protect(e,n))}try{if(s=l,n?.skipEncryption!==!0){n?.onProgress?.(new ve(`upgrader:encrypt-${t}-connection`)),{conn:s,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));const u={...l,...s};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,u)}else{const u=e.remoteAddr.getPeerId();if(u==null)throw new N4(`${t} connection that skipped encryption must have a peer id`);const h=Ht(u);c="native",i=h}if(i.equals(this.components.peerId)){const u=new uE("Can not dial self");throw e.abort(u),u}if(o=s,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new ve(`upgrader:multiplex-${t}-connection`));const u=await(t==="inbound"?this._multiplexInbound({...l,...s},this.streamMuxers,n):this._multiplexOutbound({...l,...s},this.streamMuxers,n));a=u.muxerFactory,o=u.stream}}catch(u){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,u),u}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:n?.limits})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,limits:c}=e;let l,u,h;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:m=>{if(h==null)return;const b=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const y=this.components.registrar.getProtocols(),{stream:_,protocol:A}=await Ig(m,y,{signal:b,log:m.log,yieldBytes:!1});if(h==null)return;h.log("incoming stream opened on %s",A);const R=SF(A,this.components.registrar);if(Lw(A,"inbound",h)===R){const T=new VP(`Too many inbound protocol streams for protocol "${A}" - limit ${R}`);throw m.abort(T),T}m.source=_.source,m.sink=_.sink,m.protocol=A,_.closeWrite!=null&&(m.closeWrite=_.closeWrite),_.closeRead!=null&&(m.closeRead=_.closeRead),_.close!=null&&(m.close=_.close),await this.components.peerStore.merge(o,{protocols:[A]},{signal:b}),this.components.metrics?.trackProtocolStream(m,h),this._onStream({connection:h,stream:m,protocol:A})}).catch(async y=>{h.log.error("error handling incoming stream id %s - %e",m.id,y),m.timeline.close==null&&await m.close({signal:b}).catch(_=>m.abort(_))})}}),u=async(m,b={})=>{if(l==null)throw new sf("Connection is not multiplexed");h.log.trace("starting new stream for protocols %s",m);const y=await l.newStream();h.log.trace("started new stream %s for protocols %s",y.id,m);try{if(b.signal==null){y.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",m);const T=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);b={...b,signal:T}}y.log.trace("selecting protocol from protocols %s",m);const{stream:_,protocol:A}=await Ag(y,m,{...b,log:y.log,yieldBytes:!0});y.log.trace("selected protocol %s",A);const R=_F(A,this.components.registrar,b),I=Lw(A,"outbound",h);if(I>=R){const T=new M4(`Too many outbound protocol streams for protocol "${A}" - ${I}/${R}`);throw y.abort(T),T}return await this.components.peerStore.merge(o,{protocols:[A]}),y.source=_.source,y.sink=_.sink,y.protocol=A,_.closeWrite!=null&&(y.closeWrite=_.closeWrite),_.closeRead!=null&&(y.closeRead=_.closeRead),_.close!=null&&(y.close=_.close),this.components.metrics?.trackProtocolStream(y,h),y}catch(_){throw h.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,m,_),y.timeline.close==null&&y.abort(_),_}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(m=>{h.log.error("error piping data through muxer - %e",m)}));const d=s.timeline;s.timeline=new Proxy(d,{set:(...m)=>(m[1]==="close"&&m[2]!=null&&d.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(b){h.log.error("error closing connection after timeline close %e",b)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(b=>{h.log.error("error thrown while dispatching connection:close event %e",b)}),Reflect.set(...m))}),s.timeline.upgraded=Date.now();const g=()=>{throw new sf("Connection is not multiplexed")};return h=EF({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:s.timeline,multiplexer:l?.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:u??g,getStreams:()=>l?.streams??[],close:async m=>{await l?.close(m),await s.close(m)},abort:m=>{s.abort(m),l?.abort(m)}}),this.events.safeDispatchEvent("connection:open",{detail:h}),h.__maConnTimeline=d,h}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:i,options:o}=this.components.registrar.getHandler(s);if(t.limits!=null&&o.runOnLimitedConnection!==!0)throw new hE("Cannot open protocol stream on limited connection");i({connection:t,stream:n})}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await Ig(e,n,{...t,log:e.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new of(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await o.secureInbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,s),new of(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const{stream:s,protocol:i}=await Ag(e,n,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new of(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await o.secureOutbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,s),new of(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await Ag(e,s,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new sf(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await Ig(e,s,{...n,log:e.log}),a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new sf(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const J_="2.9.0",ex="js-libp2p";function tx(r,e){return`${r??ex}/${e??J_} browser/${globalThis.navigator.userAgent}`}class AF extends Tt{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new Tt,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{const u=n(l),h=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||h},this.peerId=e.peerId,this.logger=e.logger??g0(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??ex,i=e.nodeInfo?.version??J_,o=this.components=Y$({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??tx(s,i)},logger:this.logger,events:t,datastore:e.datastore??new d6,connectionGater:rU(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",zB(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){const u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(h=>h.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new xF(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new lF(this.components,e.transportManager)),this.configureComponent("connectionManager",new VU(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new eF(this.components,e.connectionMonitor)),this.configureComponent("registrar",new cF(this.components)),this.configureComponent("addressManager",new N$(this.components,e.addresses));const a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new oF(this.components,{routers:a}));const c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new iF(this.components,{routers:c})),this.configureComponent("randomWalk",new aF(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",d=>{this.#e(d)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(const l of Object.keys(e.services)){const u=e.services[l],h=u(this.components);if(h==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=h,this.configureComponent(l,h),h[al]!=null&&(this.log("registering service %s for content routing",l),c.push(h[al])),h[cl]!=null&&(this.log("registering service %s for peer routing",l),a.push(h[cl])),h[mh]!=null&&(this.log("registering service %s for peer discovery",l),h[mh].addEventListener?.("peer",d=>{this.#e(d)}))}Q$(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new Ds;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new te("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new te("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){p0(e)&&(e=Ht(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=Rr([ne("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=Or(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}}async function rx(r={}){r.privateKey??=await h0("Ed25519");const e=new AF({...await kL(r),peerId:nM(r.privateKey)});return r.start!==!1&&await e.start(),e}const IF=["string","number","bigint","symbol"],TF=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function kF(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";const e=typeof r;if(IF.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(CF(r))return"Buffer";const t=PF(r);return t||"Object"}function CF(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function PF(r){const e=Object.prototype.toString.call(r).slice(8,-1);if(TF.includes(e))return e}class V{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}V.uint=new V(0,"uint",!0);V.negint=new V(1,"negint",!0);V.bytes=new V(2,"bytes",!0);V.string=new V(3,"string",!0);V.array=new V(4,"array",!1);V.map=new V(5,"map",!1);V.tag=new V(6,"tag",!1);V.float=new V(7,"float",!0);V.false=new V(7,"false",!0);V.true=new V(7,"true",!0);V.null=new V(7,"null",!0);V.undefined=new V(7,"undefined",!0);V.break=new V(7,"break",!0);class se{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const Jl=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",DF=new TextDecoder,RF=new TextEncoder;function U1(r){return Jl&&globalThis.Buffer.isBuffer(r)}function b6(r){return r instanceof Uint8Array?U1(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}const NF=Jl?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):$w(r,e,t):(r,e,t)=>t-e>64?DF.decode(r.subarray(e,t)):$w(r,e,t),nx=Jl?r=>r.length>64?globalThis.Buffer.from(r):Bw(r):r=>r.length>64?RF.encode(r):Bw(r),Qs=r=>Uint8Array.from(r),v6=Jl?(r,e,t)=>U1(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),OF=Jl?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),b6(globalThis.Buffer.concat(r,e))):(r,e)=>{const t=new Uint8Array(e);let n=0;for(let s of r)n+s.length>t.length&&(s=s.subarray(0,t.length-n)),t.set(s,n),n+=s.length;return t},MF=Jl?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function LF(r,e){if(U1(r)&&U1(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function Bw(r){const e=[];let t=0;for(let n=0;n<r.length;n++){let s=r.charCodeAt(n);s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(s=65536+((s&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128)}return e}function $w(r,e,t){const n=[];for(;e<t;){const s=r[e];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(e+o<=t){let a,c,l,u;switch(o){case 1:s<128&&(i=s);break;case 2:a=r[e+1],(a&192)===128&&(u=(s&31)<<6|a&63,u>127&&(i=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(s&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(i=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(s&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(i=u))}}i===null?(i=65533,o=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=o}return sx(n)}const Uw=4096;function sx(r){const e=r.length;if(e<=Uw)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=Uw));return t}const BF=256;class ix{constructor(e=BF){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const s=t.length-(this.maxCursor-this.cursor)-1;t.set(e,s)}else{if(t){const s=t.length-(this.maxCursor-this.cursor)-1;s<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,s),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=MF(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=v6(n,0,this.cursor)}else t=OF(this.chunks,this.cursor);return e&&this.reset(),t}}const be="CBOR decode error:",Ia="CBOR encode error:";function eu(r,e,t){if(r.length-e<t)throw new Error(`${be} not enough data for type`)}const ar=[24,256,65536,4294967296,BigInt("18446744073709551616")];function ac(r,e,t){eu(r,e,1);const n=r[e];if(t.strict===!0&&n<ar[0])throw new Error(`${be} integer encoded in more bytes than necessary (strict decode)`);return n}function cc(r,e,t){eu(r,e,2);const n=r[e]<<8|r[e+1];if(t.strict===!0&&n<ar[1])throw new Error(`${be} integer encoded in more bytes than necessary (strict decode)`);return n}function lc(r,e,t){eu(r,e,4);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<ar[2])throw new Error(`${be} integer encoded in more bytes than necessary (strict decode)`);return n}function uc(r,e,t){eu(r,e,8);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],s=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(s);if(t.strict===!0&&i<ar[3])throw new Error(`${be} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${be} integers outside of the safe integer range are not supported`)}function $F(r,e,t,n){return new se(V.uint,ac(r,e+1,n),2)}function UF(r,e,t,n){return new se(V.uint,cc(r,e+1,n),3)}function FF(r,e,t,n){return new se(V.uint,lc(r,e+1,n),5)}function VF(r,e,t,n){return new se(V.uint,uc(r,e+1,n),9)}function hc(r,e){return Hn(r,0,e.value)}function Hn(r,e,t){if(t<ar[0]){const n=Number(t);r.push([e|n])}else if(t<ar[1]){const n=Number(t);r.push([e|24,n])}else if(t<ar[2]){const n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<ar[3]){const n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{const n=BigInt(t);if(n<ar[4]){const s=[e|27,0,0,0,0,0,0,0];let i=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));s[8]=i&255,i=i>>8,s[7]=i&255,i=i>>8,s[6]=i&255,i=i>>8,s[5]=i&255,s[4]=o&255,o=o>>8,s[3]=o&255,o=o>>8,s[2]=o&255,o=o>>8,s[1]=o&255,r.push(s)}else throw new Error(`${be} encountered BigInt larger than allowable range`)}}hc.encodedSize=function(e){return Hn.encodedSize(e.value)};Hn.encodedSize=function(e){return e<ar[0]?1:e<ar[1]?2:e<ar[2]?3:e<ar[3]?5:9};hc.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function KF(r,e,t,n){return new se(V.negint,-1-ac(r,e+1,n),2)}function qF(r,e,t,n){return new se(V.negint,-1-cc(r,e+1,n),3)}function HF(r,e,t,n){return new se(V.negint,-1-lc(r,e+1,n),5)}const E6=BigInt(-1),ox=BigInt(1);function zF(r,e,t,n){const s=uc(r,e+1,n);if(typeof s!="bigint"){const i=-1-s;if(i>=Number.MIN_SAFE_INTEGER)return new se(V.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${be} integers outside of the safe integer range are not supported`);return new se(V.negint,E6-BigInt(s),9)}function S6(r,e){const t=e.value,n=typeof t=="bigint"?t*E6-ox:t*-1-1;Hn(r,e.type.majorEncoded,n)}S6.encodedSize=function(e){const t=e.value,n=typeof t=="bigint"?t*E6-ox:t*-1-1;return n<ar[0]?1:n<ar[1]?2:n<ar[2]?3:n<ar[3]?5:9};S6.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function hd(r,e,t,n){eu(r,e,t+n);const s=v6(r,e+t,e+t+n);return new se(V.bytes,s,t+n)}function WF(r,e,t,n){return hd(r,e,1,t)}function jF(r,e,t,n){return hd(r,e,2,ac(r,e+1,n))}function GF(r,e,t,n){return hd(r,e,3,cc(r,e+1,n))}function YF(r,e,t,n){return hd(r,e,5,lc(r,e+1,n))}function QF(r,e,t,n){const s=uc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${be} 64-bit integer bytes lengths not supported`);return hd(r,e,9,s)}function F1(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===V.string?nx(r.value):r.value),r.encodedBytes}function _0(r,e){const t=F1(e);Hn(r,e.type.majorEncoded,t.length),r.push(t)}_0.encodedSize=function(e){const t=F1(e);return Hn.encodedSize(t.length)+t.length};_0.compareTokens=function(e,t){return XF(F1(e),F1(t))};function XF(r,e){return r.length<e.length?-1:r.length>e.length?1:LF(r,e)}function dd(r,e,t,n,s){const i=t+n;eu(r,e,i);const o=new se(V.string,NF(r,e+t,e+i),i);return s.retainStringBytes===!0&&(o.byteValue=v6(r,e+t,e+i)),o}function ZF(r,e,t,n){return dd(r,e,1,t,n)}function JF(r,e,t,n){return dd(r,e,2,ac(r,e+1,n),n)}function eV(r,e,t,n){return dd(r,e,3,cc(r,e+1,n),n)}function tV(r,e,t,n){return dd(r,e,5,lc(r,e+1,n),n)}function rV(r,e,t,n){const s=uc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${be} 64-bit integer string lengths not supported`);return dd(r,e,9,s,n)}const nV=_0;function tu(r,e,t,n){return new se(V.array,n,t)}function sV(r,e,t,n){return tu(r,e,1,t)}function iV(r,e,t,n){return tu(r,e,2,ac(r,e+1,n))}function oV(r,e,t,n){return tu(r,e,3,cc(r,e+1,n))}function aV(r,e,t,n){return tu(r,e,5,lc(r,e+1,n))}function cV(r,e,t,n){const s=uc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${be} 64-bit integer array lengths not supported`);return tu(r,e,9,s)}function lV(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${be} indefinite length items not allowed`);return tu(r,e,1,1/0)}function _6(r,e){Hn(r,V.array.majorEncoded,e.value)}_6.compareTokens=hc.compareTokens;_6.encodedSize=function(e){return Hn.encodedSize(e.value)};function ru(r,e,t,n){return new se(V.map,n,t)}function uV(r,e,t,n){return ru(r,e,1,t)}function hV(r,e,t,n){return ru(r,e,2,ac(r,e+1,n))}function dV(r,e,t,n){return ru(r,e,3,cc(r,e+1,n))}function fV(r,e,t,n){return ru(r,e,5,lc(r,e+1,n))}function pV(r,e,t,n){const s=uc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${be} 64-bit integer map lengths not supported`);return ru(r,e,9,s)}function gV(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${be} indefinite length items not allowed`);return ru(r,e,1,1/0)}function x6(r,e){Hn(r,V.map.majorEncoded,e.value)}x6.compareTokens=hc.compareTokens;x6.encodedSize=function(e){return Hn.encodedSize(e.value)};function mV(r,e,t,n){return new se(V.tag,t,1)}function yV(r,e,t,n){return new se(V.tag,ac(r,e+1,n),2)}function wV(r,e,t,n){return new se(V.tag,cc(r,e+1,n),3)}function bV(r,e,t,n){return new se(V.tag,lc(r,e+1,n),5)}function vV(r,e,t,n){return new se(V.tag,uc(r,e+1,n),9)}function A6(r,e){Hn(r,V.tag.majorEncoded,e.value)}A6.compareTokens=hc.compareTokens;A6.encodedSize=function(e){return Hn.encodedSize(e.value)};const EV=20,SV=21,_V=22,xV=23;function AV(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${be} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new se(V.null,null,1):new se(V.undefined,void 0,1)}function IV(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${be} indefinite length items not allowed`);return new se(V.break,void 0,1)}function I6(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${be} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${be} Infinity values are not supported`)}return new se(V.float,r,e)}function TV(r,e,t,n){return I6(k6(r,e+1),3,n)}function kV(r,e,t,n){return I6(C6(r,e+1),5,n)}function CV(r,e,t,n){return I6(ux(r,e+1),9,n)}function T6(r,e,t){const n=e.value;if(n===!1)r.push([V.float.majorEncoded|EV]);else if(n===!0)r.push([V.float.majorEncoded|SV]);else if(n===null)r.push([V.float.majorEncoded|_V]);else if(n===void 0)r.push([V.float.majorEncoded|xV]);else{let s,i=!1;(!t||t.float64!==!0)&&(cx(n),s=k6(Zn,1),n===s||Number.isNaN(n)?(Zn[0]=249,r.push(Zn.slice(0,3)),i=!0):(lx(n),s=C6(Zn,1),n===s&&(Zn[0]=250,r.push(Zn.slice(0,5)),i=!0))),i||(PV(n),s=ux(Zn,1),Zn[0]=251,r.push(Zn.slice(0,9)))}}T6.encodedSize=function(e,t){const n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){cx(n);let s=k6(Zn,1);if(n===s||Number.isNaN(n))return 3;if(lx(n),s=C6(Zn,1),n===s)return 5}return 9};const ax=new ArrayBuffer(9),kn=new DataView(ax,1),Zn=new Uint8Array(ax,0);function cx(r){if(r===1/0)kn.setUint16(0,31744,!1);else if(r===-1/0)kn.setUint16(0,64512,!1);else if(Number.isNaN(r))kn.setUint16(0,32256,!1);else{kn.setFloat32(0,r);const e=kn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)kn.setUint16(0,31744,!1);else if(t===0)kn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{const s=t-127;s<-24?kn.setUint16(0,0):s<-14?kn.setUint16(0,(e&2147483648)>>16|1<<24+s,!1):kn.setUint16(0,(e&2147483648)>>16|s+15<<10|n>>13,!1)}}}function k6(r,e){if(r.length-e<2)throw new Error(`${be} not enough data for float16`);const t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const n=t>>10&31,s=t&1023;let i;return n===0?i=s*2**-24:n!==31?i=(s+1024)*2**(n-25):i=s===0?1/0:NaN,t&32768?-i:i}function lx(r){kn.setFloat32(0,r,!1)}function C6(r,e){if(r.length-e<4)throw new Error(`${be} not enough data for float32`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function PV(r){kn.setFloat64(0,r,!1)}function ux(r,e){if(r.length-e<8)throw new Error(`${be} not enough data for float64`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}T6.compareTokens=hc.compareTokens;function Qe(r,e,t){throw new Error(`${be} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function x0(r){return()=>{throw new Error(`${be} ${r}`)}}const ae=[];for(let r=0;r<=23;r++)ae[r]=Qe;ae[24]=$F;ae[25]=UF;ae[26]=FF;ae[27]=VF;ae[28]=Qe;ae[29]=Qe;ae[30]=Qe;ae[31]=Qe;for(let r=32;r<=55;r++)ae[r]=Qe;ae[56]=KF;ae[57]=qF;ae[58]=HF;ae[59]=zF;ae[60]=Qe;ae[61]=Qe;ae[62]=Qe;ae[63]=Qe;for(let r=64;r<=87;r++)ae[r]=WF;ae[88]=jF;ae[89]=GF;ae[90]=YF;ae[91]=QF;ae[92]=Qe;ae[93]=Qe;ae[94]=Qe;ae[95]=x0("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ae[r]=ZF;ae[120]=JF;ae[121]=eV;ae[122]=tV;ae[123]=rV;ae[124]=Qe;ae[125]=Qe;ae[126]=Qe;ae[127]=x0("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ae[r]=sV;ae[152]=iV;ae[153]=oV;ae[154]=aV;ae[155]=cV;ae[156]=Qe;ae[157]=Qe;ae[158]=Qe;ae[159]=lV;for(let r=160;r<=183;r++)ae[r]=uV;ae[184]=hV;ae[185]=dV;ae[186]=fV;ae[187]=pV;ae[188]=Qe;ae[189]=Qe;ae[190]=Qe;ae[191]=gV;for(let r=192;r<=215;r++)ae[r]=mV;ae[216]=yV;ae[217]=wV;ae[218]=bV;ae[219]=vV;ae[220]=Qe;ae[221]=Qe;ae[222]=Qe;ae[223]=Qe;for(let r=224;r<=243;r++)ae[r]=x0("simple values are not supported");ae[244]=Qe;ae[245]=Qe;ae[246]=Qe;ae[247]=AV;ae[248]=x0("simple values are not supported");ae[249]=TV;ae[250]=kV;ae[251]=CV;ae[252]=Qe;ae[253]=Qe;ae[254]=Qe;ae[255]=IV;const Fs=[];for(let r=0;r<24;r++)Fs[r]=new se(V.uint,r,1);for(let r=-1;r>=-24;r--)Fs[31-r]=new se(V.negint,r,1);Fs[64]=new se(V.bytes,new Uint8Array(0),1);Fs[96]=new se(V.string,"",1);Fs[128]=new se(V.array,0,1);Fs[160]=new se(V.map,0,1);Fs[244]=new se(V.false,!1,1);Fs[245]=new se(V.true,!0,1);Fs[246]=new se(V.null,null,1);function DV(r){switch(r.type){case V.false:return Qs([244]);case V.true:return Qs([245]);case V.null:return Qs([246]);case V.bytes:return r.value.length?void 0:Qs([64]);case V.string:return r.value===""?Qs([96]):void 0;case V.array:return r.value===0?Qs([128]):void 0;case V.map:return r.value===0?Qs([160]):void 0;case V.uint:return r.value<24?Qs([Number(r.value)]):void 0;case V.negint:if(r.value>=-24)return Qs([31-Number(r.value)])}}const RV={float64:!1,mapSorter:MV,quickEncodeToken:DV};function NV(){const r=[];return r[V.uint.major]=hc,r[V.negint.major]=S6,r[V.bytes.major]=_0,r[V.string.major]=nV,r[V.array.major]=_6,r[V.map.major]=x6,r[V.tag.major]=A6,r[V.float.major]=T6,r}const hx=NV(),Tg=new ix;class V1{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Ia} object contains circular references`);return new V1(t,e)}}const zi={null:new se(V.null,null),undefined:new se(V.undefined,void 0),true:new se(V.true,!0),false:new se(V.false,!1),emptyArray:new se(V.array,0),emptyMap:new se(V.map,0)},Io={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new se(V.float,r):r>=0?new se(V.uint,r):new se(V.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new se(V.uint,r):new se(V.negint,r)},Uint8Array(r,e,t,n){return new se(V.bytes,r)},string(r,e,t,n){return new se(V.string,r)},boolean(r,e,t,n){return r?zi.true:zi.false},null(r,e,t,n){return zi.null},undefined(r,e,t,n){return zi.undefined},ArrayBuffer(r,e,t,n){return new se(V.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new se(V.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[zi.emptyArray,new se(V.break)]:zi.emptyArray;n=V1.createCheck(n,r);const s=[];let i=0;for(const o of r)s[i++]=qf(o,t,n);return t.addBreakTokens?[new se(V.array,r.length),s,new se(V.break)]:[new se(V.array,r.length),s]},Object(r,e,t,n){const s=e!=="Object",i=s?r.keys():Object.keys(r),o=s?r.size:i.length;if(!o)return t.addBreakTokens===!0?[zi.emptyMap,new se(V.break)]:zi.emptyMap;n=V1.createCheck(n,r);const a=[];let c=0;for(const l of i)a[c++]=[qf(l,t,n),qf(s?r.get(l):r[l],t,n)];return OV(a,t),t.addBreakTokens?[new se(V.map,o),a,new se(V.break)]:[new se(V.map,o),a]}};Io.Map=Io.Object;Io.Buffer=Io.Uint8Array;for(const r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Io[`${r}Array`]=Io.DataView;function qf(r,e={},t){const n=kF(r),s=e&&e.typeEncoders&&e.typeEncoders[n]||Io[n];if(typeof s=="function"){const o=s(r,n,e,t);if(o!=null)return o}const i=Io[n];if(!i)throw new Error(`${Ia} unsupported type: ${n}`);return i(r,n,e,t)}function OV(r,e){e.mapSorter&&r.sort(e.mapSorter)}function MV(r,e){const t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);const s=t.type.major,i=hx[s].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function dx(r,e,t,n){if(Array.isArray(e))for(const s of e)dx(r,s,t,n);else t[e.type.major](r,e,n)}function fx(r,e,t){const n=qf(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){const s=t.quickEncodeToken(n);if(s)return s;const i=e[n.type.major];if(i.encodedSize){const o=i.encodedSize(n,t),a=new ix(o);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return b6(a.chunks[0])}}return Tg.reset(),dx(Tg,n,e,t),Tg.toBytes(!0)}function Hf(r,e){return e=Object.assign({},RV,e),fx(r,hx,e)}const LV={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class BV{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=Fs[e];if(t===void 0){const n=ae[e];if(!n)throw new Error(`${be} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const s=e&31;t=n(this.data,this._pos,s,this.options)}return this._pos+=t.encodedLength,t}}const kh=Symbol.for("DONE"),A0=Symbol.for("BREAK");function $V(r,e,t){const n=[];for(let s=0;s<r.value;s++){const i=Ch(e,t);if(i===A0){if(r.value===1/0)break;throw new Error(`${be} got unexpected break to lengthed array`)}if(i===kh)throw new Error(`${be} found array but not enough entries (got ${s}, expected ${r.value})`);n[s]=i}return n}function UV(r,e,t){const n=t.useMaps===!0,s=n?void 0:{},i=n?new Map:void 0;for(let o=0;o<r.value;o++){const a=Ch(e,t);if(a===A0){if(r.value===1/0)break;throw new Error(`${be} got unexpected break to lengthed map`)}if(a===kh)throw new Error(`${be} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${be} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in s))throw new Error(`${be} found repeat map key "${a}"`);const c=Ch(e,t);if(c===kh)throw new Error(`${be} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?i.set(a,c):s[a]=c}return n?i:s}function Ch(r,e){if(r.done())return kh;const t=r.next();if(t.type===V.break)return A0;if(t.type.terminal)return t.value;if(t.type===V.array)return $V(t,r,e);if(t.type===V.map)return UV(t,r,e);if(t.type===V.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const n=Ch(r,e);return e.tags[t.value](n)}throw new Error(`${be} tag not supported (${t.value})`)}throw new Error("unsupported")}function FV(r,e){if(!(r instanceof Uint8Array))throw new Error(`${be} data to decode must be a Uint8Array`);e=Object.assign({},LV,e);const t=e.tokenizer||new BV(r,e),n=Ch(t,e);if(n===kh)throw new Error(`${be} did not find any content to decode`);if(n===A0)throw new Error(`${be} got unexpected break`);return[n,r.subarray(t.pos())]}function Zi(r,e){const[t,n]=FV(r,e);if(n.length>0)throw new Error(`${be} too many terminals, data makes no sense`);return t}function cf({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*VV(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=Ne.asCID(n);i!=null?yield[s.join("/"),i]:typeof n=="object"&&(yield*Ym(n,s))}else{const t=Ne.asCID(e);t!=null?yield[r.join("/"),t]:yield*Ym(e,r)}}function*Ym(r,e){if(r==null||r instanceof Uint8Array)return;const t=Ne.asCID(r);t!=null&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*VV(i,s)}}function*KV(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&Ne.asCID(n)==null&&(yield*Qm(n,s))}else yield*Qm(e,r)}function*Qm(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&Ne.asCID(n)==null&&(yield*KV(s,n))}}function qV(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=Ne.asCID(t);if(i!=null)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}let HV=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:cf(),bytes:cf(),value:cf(),asBlock:cf()})}links(){return Ym(this.value,[])}tree(){return Qm(this.value,[])}get(e="/"){return qV(this.value,e.split("/").filter(Boolean))}};function zV({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n?.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new HV({cid:e,bytes:r,value:s})}const px="/pin/",Fw="/pinned-block/",Xm=Ea,Vw=1;function lf(r){return r.version===0&&(r=r.toV1()),new ft(`${px}${r.toString(Xm)}`)}class WV{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){const n=lf(e);if(await this.datastore.has(n))throw new Error("Already pinned");const s=Math.round(t.depth??1/0);if(s<0)throw new Error("Depth must be greater than or equal to 0");const i=new xo({concurrency:Vw});for await(const a of this.#e(e,i,{...t,depth:s}))await this.#t(a,c=>c.pinnedBy.find(l=>$e(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:s,metadata:t.metadata??{}};await this.datastore.put(n,Hf(o),t)}async*#e(e,t,n){if(n.depth===-1)return;const s=await this.getCodec(e.code),i=await this.blockstore.get(e,n),o=zV({bytes:i,cid:e,codec:s});yield e;for(const[,a]of o.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){const s=new ft(`${Fw}${Xm.encode(e.multihash.bytes)}`);let i={pinCount:0,pinnedBy:[]};try{i=Zi(await this.datastore.get(s,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(i)){if(i.pinCount===0&&await this.datastore.has(s)){await this.datastore.delete(s);return}await this.datastore.put(s,Hf(i),n),n.onProgress?.(new ve("helia:pin:add",e))}}async*rm(e,t={}){const n=lf(e),s=await this.datastore.get(n,t),i=Zi(s);await this.datastore.delete(n,t);const o=new xo({concurrency:Vw});for await(const a of this.#e(e,o,{...t,depth:i.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>$e(l,e.bytes)),!0),{...t,depth:i.depth}),yield a}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:px+(e.cid!=null?`${e.cid.toString(Ea)}`:"")},e)){const s=Ne.parse(t.toString().substring(5),Ea),i=Zi(n);yield{cid:s,...i}}}async isPinned(e,t={}){const n=new ft(`${Fw}${Xm.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){const n=lf(e),s=await this.datastore.get(n,t);return Zi(s)}async setMetadata(e,t,n){const s=lf(e),i=await this.datastore.get(s,n),o=Zi(i);o.metadata=t??{},await this.datastore.put(s,Hf(o),n)}}const jV=1,GV=5;class YV extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}class uf extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}class QV extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}class XV extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}const ZV=5;class JV{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??ZV,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await bi(...this.routers)}async stop(){await Ro(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new uf("No content routers available");const n=new Ao({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(const s of lo(n.toGenerator(),...Ko(this.routers,"findProviders").map(i=>i.findProviders(e,t))))if(s!=null){if(s.multiaddrs.length===0){if(n.find(s.id)!=null)continue;n.add(async()=>{try{const i=await this.findPeer(s.id,t);return i.multiaddrs.length===0?null:i}catch(i){return this.log.error("could not load multiaddrs for peer %p",s.id,i),null}},{peerId:s.id,signal:t.signal}).catch(i=>{this.log.error("could not load multiaddrs for peer %p",s.id,i)})}yield s}}async provide(e,t={}){if(this.routers.length===0)throw new uf("No content routers available");await Promise.all(Ko(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Ko(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Ko(this.routers,"put").map(async s=>{await s.put(e,t,n)}))}async get(e,t){return Promise.any(Ko(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new uf("No peer routers available");const n=this,s=lo(...Ko(this.routers,"findPeer").map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const i of s)if(i!=null)return i;throw new Ut("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new uf("No peer routers available");for await(const n of lo(...Ko(this.routers,"getClosestPeers").map(s=>s.getClosestPeers(e,t))))n!=null&&(yield n)}}function Ko(r,e){return r.filter(t=>t[e]!=null)}class eK{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=E_({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await bi(this.child),this.started=!0}async stop(){await Ro(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();const s=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{s()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{const s=this;yield*this.child.deleteMany(async function*(){for await(const i of e){if(await s.pins.isPinned(i))throw new Error("CID was pinned");yield i}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}}const kg=new ft("/version"),Kw=1;async function tK(r){if(!await r.has(kg)){await r.put(kg,ne(`${Kw}`));return}const e=await r.get(kg),t=re(e);if(parseInt(t,10)!==Kw)throw new Error("Unknown datastore version, a datastore migration may be required")}const gx=42;function mx(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function rK(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=Ne.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new se(V.tag,gx),new se(V.bytes,t)]}function nK(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function sK(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const Zm={float64:!0,typeEncoders:{Object:rK,undefined:nK,number:sK}},iK={...Zm,typeEncoders:{...Zm.typeEncoders}};function oK(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return Ne.decode(r.subarray(1))}const K1={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};K1.tags[gx]=oK;const aK={...K1,tags:K1.tags.slice()},cK="dag-cbor",yx=113,lK=r=>Hf(r,Zm),uK=r=>Zi(mx(r),K1),fd=Object.freeze(Object.defineProperty({__proto__:null,code:yx,decode:uK,decodeOptions:aK,encode:lK,encodeOptions:iK,name:cK,toByteView:mx},Symbol.toStringTag,{value:"Module"}));class hK extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===V.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===V.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[V.uint.major](e,t){this.prefix(e);const n=String(t.value),s=[];for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i);e.push(s)}[V.negint.major](e,t){this[V.uint.major](e,t)}[V.bytes.major](e,t){throw new Error(`${Ia} unsupported type: Uint8Array`)}[V.string.major](e,t){this.prefix(e);const n=nx(JSON.stringify(t.value));e.push(n.length>32?b6(n):n)}[V.array.major](e,t){this.prefix(e),this.inRecursive.push({type:V.array,elements:0}),e.push([91])}[V.map.major](e,t){this.prefix(e),this.inRecursive.push({type:V.map,elements:0}),e.push([123])}[V.tag.major](e,t){}[V.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===V.array)e.push([93]);else if(o.type===V.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Ia} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),s=[];let i=!1;for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),e.push(s)}}function dK(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Ia} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==V.string||n.type!==V.string)throw new Error(`${Ia} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Ia} unexpected duplicate map keys, this is not supported`)}const fK={addBreakTokens:!0,mapSorter:dK};function pK(r,e){return e=Object.assign({},fK,e),fx(r,new hK,e)}class wx{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${be} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${be} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const s=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new se(V.uint,0,this._pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${be} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${be} unexpected token at position ${this._pos}`);n=!0,this._pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,s([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(i);return n?new se(V.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new se(o>=0?V.uint:V.negint,o,this._pos-e):new se(o>=0?V.uint:V.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${be} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,o=0;i<this.data.length&&o<65536;i++,o++){const a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new se(V.string,c,o)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${be} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${be} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},s=()=>{const i=this.ch();let o=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${be} unexpected unicode sequence at position ${this._pos}`);let c,l,u,h;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(h=(i&31)<<6|c&63,h>127&&(o=h));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(h=(i&15)<<12|(c&63)<<6|l&63,h>2047&&(h<55296||h>57343)&&(o=h));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(h=(i&15)<<18|(c&63)<<12|(l&63)<<6|u&63,h>65535&&h<1114112&&(o=h))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${be} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${be} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new se(V.string,sx(t),this._pos-e);default:if(i<32)throw new Error(`${be} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):s()}}throw new Error(`${be} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new se(V.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new se(V.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new se(V.null,null,4);case 102:return this.expect([102,97,108,115,101]),new se(V.false,!1,5);case 116:return this.expect([116,114,117,101]),new se(V.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${be} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new se(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${be} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new se(V.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new se(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${be} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new se(V.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${be} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${be} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function gK(r,e){return e=Object.assign({tokenizer:new wx(r,e)},e),Zi(r,e)}function mK(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function yK(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=Ne.asCID(r);if(!e)return null;const t=e.toString();return[new se(V.map,1/0,1),new se(V.string,"/",1),new se(V.string,t,t.length),new se(V.break,void 0,1)]}function q1(r){const e=$n.encode(r).slice(1);return[new se(V.map,1/0,1),new se(V.string,"/",1),new se(V.map,1/0,1),new se(V.string,"bytes",5),new se(V.string,e,e.length),new se(V.break,void 0,1),new se(V.break,void 0,1)]}function Yn(r){return q1(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function wK(r){return q1(new Uint8Array(r))}function bK(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function vK(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const EK={typeEncoders:{Object:yK,Buffer:q1,Uint8Array:q1,Int8Array:Yn,Uint16Array:Yn,Int16Array:Yn,Uint32Array:Yn,Int32Array:Yn,Float32Array:Yn,Float64Array:Yn,Uint8ClampedArray:Yn,BigInt64Array:Yn,BigUint64Array:Yn,DataView:Yn,ArrayBuffer:wK,undefined:bK,number:vK}};class SK extends wx{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===V.map){const t=this._next();if(t.type===V.string&&t.value==="/"){const n=this._next();if(n.type===V.string){if(this._next().type!==V.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new se(V.tag,42,0)}if(n.type===V.map){const s=this._next();if(s.type===V.string&&s.value==="bytes"){const i=this._next();if(i.type===V.string){for(let a=0;a<2;a++)if(this._next().type!==V.break)throw new Error("Invalid encoded Bytes form");const o=$n.decode(`m${i.value}`);return new se(V.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const Jm={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Jm.tags[42]=Ne.parse;const _K="dag-json",bx=297,vx=r=>pK(r,EK),Ex=r=>{const e=mK(r),t=Object.assign(Jm,{tokenizer:new SK(e,Jm)});return gK(e,t)},qw=r=>xK.decode(vx(r)),xK=new TextDecoder,AK=r=>Ex(IK.encode(r)),IK=new TextEncoder,TK=Object.freeze(Object.defineProperty({__proto__:null,code:bx,decode:Ex,encode:vx,format:qw,name:_K,parse:AK,stringify:qw},Symbol.toStringTag,{value:"Module"})),kK=new TextDecoder;function P6(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");const s=r[e++];if(t+=n<28?(s&127)<<n:(s&127)*2**n,s<128)break}return[t,e]}function H1(r,e){let t;[t,e]=P6(r,e);const n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function Sx(r,e){let t;return[t,e]=P6(r,e),[t&7,t>>3,e]}function CK(r){const e={},t=r.length;let n=0;for(;n<t;){let s,i;if([s,i,n]=Sx(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=H1(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=H1(r,n),e.Name=kK.decode(o)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(s!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Tsize`);[e.Tsize,n]=P6(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function PK(r){const e=r.length;let t=0,n,s=!1,i;for(;t<e;){let a,c;if([a,c,t]=Sx(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=H1(r,t),n&&(s=!0)}else if(c===2){if(s)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=H1(r,t),n.push(CK(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return i&&(o.Data=i),o.Links=n||[],o}const _x=new TextEncoder,Hw=2**32,DK=2**31;function RK(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=Ju(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){const n=_x.encode(r.Name);t-=n.length,e.set(n,t),t=Ju(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=Ju(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function NK(r){const e=MK(r),t=new Uint8Array(e);let n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=Ju(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let s=r.Links.length-1;s>=0;s--){const i=RK(r.Links[s],t.subarray(0,n));n-=i,n=Ju(t,n,i)-1,t[n]=18}return t}function OK(r){let e=0;if(r.Hash){const t=r.Hash.length;e+=1+t+el(t)}if(typeof r.Name=="string"){const t=_x.encode(r.Name).length;e+=1+t+el(t)}return typeof r.Tsize=="number"&&(e+=1+el(r.Tsize)),e}function MK(r){let e=0;if(r.Data){const t=r.Data.length;e+=1+t+el(t)}if(r.Links)for(const t of r.Links){const n=OK(t);e+=1+n+el(n)}return e}function Ju(r,e,t){e-=el(t);const n=e;for(;t>=DK;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function el(r){return r%2===0&&r++,Math.floor((LK(r)+6)/7)}function LK(r){let e=0;return r>=Hw&&(r=Math.floor(r/Hw),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+BK[r]}const BK=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],$K=["Data","Links"],UK=["Hash","Name","Tsize"],ey=new TextEncoder;function xx(r,e){if(r===e)return 0;const t=r.Name?ey.encode(r.Name):[],n=e.Name?ey.encode(e.Name):[];let s=t.length,i=n.length;for(let o=0,a=Math.min(s,i);o<a;++o)if(t[o]!==n[o]){s=t[o],i=n[o];break}return s<i?-1:i<s?1:0}function zw(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function Ax(r){if(typeof r.asCID=="object"){const t=Ne.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Hash){let t=Ne.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=Ne.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=Ne.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function Ix(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=ey.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(Ax),e.Links.sort(xx);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function Tx(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!zw(r,$K))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){const t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!zw(t,UK))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&xx(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function FK(r,e=[]){return Ix({Data:r,Links:e})}function VK(r,e,t){return Ax({Hash:t,Name:r,Tsize:e})}function KK(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}const qK="dag-pb",kx=112;function HK(r){Tx(r);const e={};return r.Links&&(e.Links=r.Links.map(t=>{const n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),NK(e)}function zK(r){const e=KK(r),t=PK(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(s=>{const i={};try{i.Hash=Ne.decode(s.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return s.Name!==void 0&&(i.Name=s.Name),s.Tsize!==void 0&&(i.Tsize=s.Tsize),i})),n}const WK=Object.freeze(Object.defineProperty({__proto__:null,code:kx,createLink:VK,createNode:FK,decode:zK,encode:HK,name:qK,prepare:Ix,validate:Tx},Symbol.toStringTag,{value:"Module"}));function D6(r){return r?.then!=null}function jK(r=[],e){const t={[kx]:WK,[o0]:fR,[yx]:fd,[bx]:TK,[wE]:lR};return r.forEach(n=>{t[n.code]=n}),async n=>{let s=t[n];if(s==null&&e!=null){const i=e(n);D6(i)?s=await i:s=i,t[s.code]=s}if(s!=null)return s;throw new XV(`Could not load codec for ${n}`)}}function GK(r=[],e){const t={[Qr.code]:Qr,[C8.code]:C8,[wo.code]:wo};return r.forEach(n=>{t[n.code]=n}),async n=>{let s=t[n];if(s==null&&e!=null){const i=e(n);D6(i)?s=await i:s=i,t[s.code]=s}if(s!=null)return s;throw new QV(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}class Cx{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,block:s}of e)await this.put(n,s,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}const hf=0;class YK extends Cx{child;constructor(e){super(),this.child=e}put(e,t,n){return e.multihash.code===hf||this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}get(e,t){if(e.multihash.code===hf)return t?.signal?.throwIfAborted(),e.multihash.digest;if(this.child==null)throw t?.signal?.throwIfAborted(),new wl;return this.child.get(e,t)}has(e,t){return e.multihash.code===hf?(t?.signal?.throwIfAborted(),!0):this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===hf){t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}getAll(e){return this.child!=null?this.child.getAll(e):(e?.signal?.throwIfAborted(),[])}}function QK(r){return r[Symbol.asyncIterator]!=null}function Ww(r){return r?.then!=null}function z1(r,e){let t=0;if(QK(r))return async function*(){for await(const c of r){const l=e(c,t++);Ww(l)&&await l,yield c}}();const n=h6(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();if(typeof e(s,t++)?.then=="function")return async function*(){yield s;for(const c of n){const l=e(c,t++);Ww(l)&&await l,yield c}}();const a=e;return function*(){yield s;for(const c of n)a(c,t++),yield c}()}class Px{child;getHasher;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new YK(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new ve("blocks:put:duplicate",e)),e):(n.onProgress?.(new ve("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(e,t,n))),n.onProgress?.(new ve("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){const n=Zo(e,async({cid:i})=>{const o=await this.child.has(i,t);return o&&t.onProgress?.(new ve("blocks:put-many:duplicate",i)),!o}),s=z1(n,async({cid:i,block:o})=>{t.onProgress?.(new ve("blocks:put-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(i,o,t)))});t.onProgress?.(new ve("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(s,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){const n=await this.getHasher(e.multihash.code);t.onProgress?.(new ve("blocks:get:providers:get",e));const s=await jw(e,this.components.blockBrokers,n,{...t,log:this.log});return t.onProgress?.(new ve("blocks:get:blockstore:put",e)),await this.child.put(e,s,t),t.onProgress?.(new ve("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,s,t))),s}return t.onProgress?.(new ve("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new ve("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(z1(e,async n=>{if(t.offline!==!0&&!await this.child.has(n,t)){const s=await this.getHasher(n.multihash.code);t.onProgress?.(new ve("blocks:get-many:providers:get",n));const i=await jw(n,this.components.blockBrokers,s,{...t,log:this.log});t.onProgress?.(new ve("blocks:get-many:blockstore:put",n)),await this.child.put(n,i,t),t.onProgress?.(new ve("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(n,i,t)))}}))}async delete(e,t={}){t.onProgress?.(new ve("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new ve("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new ve("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class XK extends Px{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await bi(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Ro(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){const n=this.components.blockBrokers.map(s=>s.createSession==null?s:s.createSession(t));return new ZK({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}}class ZK extends Px{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){const s=Je([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:s})}finally{s.clear()}}async*putMany(e,t={}){const n=Je([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){const n=Je([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){const n=Je([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){const n=Je([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){const n=Je([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){const n=Je([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){const t=Je([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}}function JK(r){return typeof r.retrieve=="function"}const eq=(r,e)=>{if(e==null)throw new te(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n;const s=e.digest(t);if(D6(s)?n=await s:n=s,!$e(n.digest,r.multihash.digest))throw new O4("Hash of downloaded block did not match multihash from passed CID")}};async function jw(r,e,t,n){const s=eq(r,t),i=new AbortController,o=Je([i.signal,n.signal]);i.signal;const a=[];for(const c of e)JK(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1;const u=await c.retrieve(r,{...n,signal:o,validateFn:async h=>{await s(h),l=!0}});return l||await s(u),u}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{i.abort(),o.clear()}}class Dx extends Tt{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??jV,this.maxProviders=t.maxProviders??GV,this.providers=[],this.evictionFilter=So(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){const n=$n.encode(e.multihash.bytes),s=this.requests.get(n);if(s!=null)return this.log("join existing request for %c",e),s;const i=Fe();if(this.requests.set(n,i.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.initialPeerSearchComplete,u&&this.log("found initial session peers for %c",e)}let o=!1;const a=new xo({concurrency:this.maxProviders});a.addEventListener("error",()=>{}),a.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{o=!0,i.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(o||t.signal?.aborted===!0){this.log.trace("session idle, found block");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){const h=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(h)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),i.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c",e,u),i.reject(u)})});const c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(h=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,h)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,u)});const l=()=>{i.reject(new wi(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await i.promise}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){const s=Fe();let i=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;i<t&&this.initialProviders.length>0;){const o=this.initialProviders.pop();if(o==null)break;const a=await this.convertToProvider(o,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),i++,i===t&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(i<this.maxProviders)for await(const o of this.findNewProviders(e,n)){if(i===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(o)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(o),this.safeDispatchEvent("provider",{detail:o}),i++,i===t&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new YV(`Found ${i} of ${t} ${this.name} providers for ${e}`)}).catch(o=>{this.log.error("error searching routing for potential session peers for %c",e,o.errors??o),s.reject(o)}),s.promise}}class tq{blockstore;datastore;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??g0(),this.log=this.logger.forComponent("helia"),this.getHasher=GK(e.hashers,e.loadHasher),this.getCodec=jK(e.codecs,e.loadCodec),this.dns=e.dns??BS(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new JV(t,{routers:(e.routers??[]).flatMap(s=>{const i=[s];return s[al]!=null&&i.push(s[al]),s[cl]!=null&&i.push(s[cl]),i}),providerLookupConcurrency:e.providerLookupConcurrency});const n=new XK(t);this.pins=new WV(e.datastore,n,this.getCodec),this.blockstore=new eK(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(s=>s(t))}async start(){await tK(this.datastore),await bi(this.blockstore,this.datastore,this.routing)}async stop(){await Ro(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const n=this,s=this.blockstore.unwrap();this.log("gc start"),await Si(s.deleteMany(async function*(){for await(const{cid:i}of s.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new ve("helia:gc:deleted",i))}catch(o){n.log.error("Error during gc",o),e.onProgress?.(new ve("helia:gc:error",o))}}()))}finally{t()}this.log("gc finished")}}class rq extends tq{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}const nq=8,R6=1024*1024*4;let sq=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Rx=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},iq=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Gw=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Nx(r){return r[Symbol.asyncIterator]!=null}function Ox(r,e){if(r.byteLength>e)throw new Rx("Message length too long")}const I0=r=>{const e=tt(r),t=xr(e);return Yr(r,t),I0.bytes=e,t};I0.bytes=0;function Mx(r,e){e=e??{};const t=e.lengthEncoder??I0,n=e?.maxDataLength??R6;function*s(i){Ox(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return Nx(r)?async function*(){for await(const i of r)yield*s(i)}():function*(){for(const i of r)yield*s(i)}()}Mx.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??I0,n=e?.maxDataLength??R6;return Ox(r,n),new Pe(t(r.byteLength),r)};var Jo;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Jo||(Jo={}));const N6=r=>{const e=Di(r);return N6.bytes=tt(e),e};N6.bytes=0;function ty(r,e){const t=new Pe;let n=Jo.LENGTH,s=-1;const i=e?.lengthDecoder??N6,o=e?.maxLengthLength??nq,a=e?.maxDataLength??R6;function*c(){for(;t.byteLength>0;){if(n===Jo.LENGTH)try{if(s=i(t),s<0)throw new sq("Invalid message length");if(s>a)throw new Rx("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=Jo.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new iq("Message length length too long");break}throw l}if(n===Jo.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=Jo.LENGTH}}}return Nx(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new Gw("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new Gw("Unexpected end of input")}()}ty.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return ty(n,{...e??{},onLength:i=>{t=i}})};function oq(r){return r[Symbol.asyncIterator]!=null}function pd(r,e){let t=0;if(oq(r))return async function*(){for await(const c of r)yield e(c,t++)}();const n=h6(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){yield await o;for(const c of n)yield e(c,t++)}();const a=e;return function*(){yield o;for(const c of n)yield a(c,t++)}()}function bn(r,...e){if(r==null)throw new Error("Empty pipeline");if(Cg(r)){const n=r;r=()=>n.source}else if(Bx(r)||Lx(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&Cg(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Cg(t[n])&&(t[n]=cq(t[n]));return aq(...t)}const aq=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},Lx=r=>r?.[Symbol.asyncIterator]!=null,Bx=r=>r?.[Symbol.iterator]!=null,Cg=r=>r==null?!1:r.sink!=null&&r.source!=null,cq=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=Vn({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s;const i=r.source;if(Lx(i))s=async function*(){yield*i,n.end()};else if(Bx(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return lo(n,s())}return r.source},df="/ipfs/bitswap/1.2.0",lq=1024,uq=1024,hq=1024,dq=5e3,fq=10,pq=50,gq=!1,mq=3,$x=1024*1024*4,yq=$x;var Qt;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(Qt||(Qt={}));var ry;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(ry||(ry={}));(function(r){r.codec=()=>Zr(ry)})(Qt||(Qt={}));var Ph;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),Qt.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={cid:Be(0),priority:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.priority=t.int32();break}case 3:{i.cancel=t.bool();break}case 4:{i.wantType=Qt.codec().decode(t);break}case 5:{i.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Ph||(Ph={}));var W1;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(const i of t.entries)n.uint32(10),Ph.codec().encode(i,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={entries:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.entries!=null&&i.entries.length===s.limits.entries)throw new nt('Decode error - map field "entries" had too many elements');i.entries.push(Ph.codec().decode(t,t.uint32(),{limits:s.limits?.entries$}));break}case 2:{i.full=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(W1||(W1={}));var Dh;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={prefix:Be(0),data:Be(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.prefix=t.bytes();break}case 2:{i.data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Dh||(Dh={}));var Ns;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(Ns||(Ns={}));var j1;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(j1||(j1={}));(function(r){r.codec=()=>Zr(j1)})(Ns||(Ns={}));var Rh;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&j1[t.type]!==0&&(n.uint32(16),Ns.codec().encode(t.type,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={cid:Be(0),type:Ns.HaveBlock},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.type=Ns.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Rh||(Rh={}));var Nh;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),W1.codec().encode(t.wantlist,n)),t.blocks!=null)for(const i of t.blocks)n.uint32(26),Dh.codec().encode(i,n);if(t.blockPresences!=null)for(const i of t.blockPresences)n.uint32(34),Rh.codec().encode(i,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={blocks:[],blockPresences:[],pendingBytes:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.wantlist=W1.codec().decode(t,t.uint32(),{limits:s.limits?.wantlist});break}case 3:{if(s.limits?.blocks!=null&&i.blocks.length===s.limits.blocks)throw new nt('Decode error - map field "blocks" had too many elements');i.blocks.push(Dh.codec().decode(t,t.uint32(),{limits:s.limits?.blocks$}));break}case 4:{if(s.limits?.blockPresences!=null&&i.blockPresences.length===s.limits.blockPresences)throw new nt('Decode error - map field "blockPresences" had too many elements');i.blockPresences.push(Rh.codec().decode(t,t.uint32(),{limits:s.limits?.blockPresences$}));break}case 5:{i.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Nh||(Nh={}));function wq(r,e){for(const[t,n]of e.wantlist.entries()){const s=r.wantlist.get(t);s!=null&&(s.priority>n.priority&&(n.priority=s.priority),n.cancel=n.cancel??s.cancel,n.wantType=n.wantType??s.wantType,n.sendDontHave=n.sendDontHave??s.sendDontHave),r.wantlist.set(t,n)}for(const[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(const[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}class bq extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}const vq=4193648,Eq=vq+16;function*Sq(r,e){const t=[...r.wantlist.values()],n=[...r.blockPresences.values()],s=[...r.blocks.values()];let i=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=Nh.encode(l).byteLength,{added:h,hasMore:d,newSize:g}=Pg(s,l.blocks,a,e,u,_q);a+=h,u=g;const m=d;({added:h,hasMore:d,newSize:g}=Pg(n,l.blockPresences,o,e,u,xq)),o+=h,u=g;const b=d;if({added:h,hasMore:d,newSize:g}=Pg(t,l.wantlist.entries,i,e,u,Aq),i+=h,u=g,c=!m&&!b&&!d,c||(l.wantlist.full=!1),yield Nh.encode(l),c)break}}function Pg(r,e,t,n,s,i){let o=0,a=!1;for(let c=t;c<r.length;c++){const l=r[c],u=i(l);if(u>Eq)throw new bq("Cannot send block as after encoding it is over the max message size");const h=s+u;if(h>n){a=!0;break}e.push(l),o++,s=h}return{hasMore:a,added:o,newSize:s}}function _q(r){return O6(3,Dh.encode(r))}function xq(r){return O6(4,Rh.encode(r))}function Aq(r){return O6(1,Ph.encode(r))}function O6(r,e){const t=tt(r),n=tt(e.byteLength);return t+n+e.byteLength}let Iq=class extends Tt{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[df],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??uq,this.maxOutboundStreams=t.maxOutboundStreams??hq,this.messageReceiveTimeout=t.messageReceiveTimeout??dq,this.runOnLimitedConnections=t.runOnLimitedConnections??gq,this.maxIncomingMessageSize=t.maxIncomingMessageSize??$x,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??yq,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Ao({concurrency:t.messageSendConcurrency??pq,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",n=>{this.log.error("error sending wantlist to peer",n.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(const t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;const{stream:t,connection:n}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);const s=()=>{t.status==="open"?t.abort(new Xh(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)};let i=AbortSignal.timeout(this.messageReceiveTimeout);i.addEventListener("abort",s),await t.closeWrite(),await bn(t,o=>ty(o,{maxDataLength:this.maxIncomingMessageSize}),async o=>{for await(const a of o)try{const c=Nh.decode(a);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:c}}),i.removeEventListener("abort",s),i=AbortSignal.timeout(this.messageReceiveTimeout),i.addEventListener("abort",s)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,c),t.abort(c);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",n.remotePeer,s),t.abort(s)})}async*findProviders(e,t){t?.onProgress?.(new ve("bitswap:network:find-providers",e));for await(const n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield n)}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(s=>{this.log.error("could not connect to supplied provider - %e",s)}))),await Si(pd(O1(this.findProviders(e,t),t?.maxProviders??mq),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");const s=this.sendQueue.queue.find(i=>e.equals(i.options.peerId)&&i.status==="queued");if(s!=null){s.options.message=wq(s.options.message,t),await s.join({signal:n?.signal});return}await this.sendQueue.add(async i=>{const o=i?.message;if(o==null)throw new te("No message to send");this.log("sendMessage to %p",e),i?.onProgress?.(new ve("bitswap:network:send-wantlist",e));const a=await this.libp2p.dialProtocol(e,df,i);await a.closeRead();try{await bn(Sq(o,this.maxOutgoingMessageSize),c=>Mx(c),a),await a.close(i)}catch(c){i?.onProgress?.(new ve("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p",e,c),a.abort(c)}this._updateSentStats(o.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new ll("Network isn't running");t?.onProgress?.(new ve("bitswap:network:dial",e));const[n]=await Promise.all([this.libp2p.dial(e,t),Pr(this.libp2p,"peer:identify",t?.signal,{filter:s=>{if(!s.detail.peerId.equals(e))return!1;if(s.detail.protocols.includes(df))return!0;throw new s0(`${e} did not support ${df}`)}})]);return n}_updateSentStats(e){let t=0;for(const n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};class ju{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=$n.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=$n.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=$n.encode(e.multihash.bytes);this.blocks.set(n,t)}}function Tq(r){let e=new Uint8Array(r.reduce((n,s)=>n+tt(s),0)),t=0;for(const n of r)e=Yr(n,e,t),t+=tt(n);return e}function Yw(r){return Tq([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}class kq{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??lq}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new ju,n=new Set;for(const[s,i]of this.wants.entries())try{const o=await this.blockstore.get(i.cid,e);i.wantType===Qt.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),n.add(s),t.addBlock(i.cid,{data:o,prefix:Yw(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:Ns.HaveBlock})):(this.log("sending block for %c",i.cid),n.add(s),t.addBlock(i.cid,{data:o,prefix:Yw(i.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDoNotHave===!0)continue;i.sentDoNotHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:Ns.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((s,i)=>s+i.data.byteLength,0));for(const s of n)this.wants.delete(s)}}}class Cq{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=m0({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,s)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new kq({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((s,i)=>s+i.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(const s of t.wantlist.entries){const i=Ne.decode(s.cid),o=re(i.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,i),n.wants.delete(o)):(s.wantType===Qt.WantHave?this.log("peer %p wanted block presence for %c",e,i):this.log("peer %p wanted block for %c",e,i),n.wants.set(o,{cid:i,priority:s.priority,wantType:s.wantType??Qt.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=re(e.multihash.bytes,"base64"),s=[];for(const i of this.ledgerMap.values())i.wants.has(n)&&s.push(i);await Promise.all(s.map(async i=>i.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}class Pq extends Dx{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);const s=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,s.has?"has":"does not have",e),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(const n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return va(e)?e:(await this.libp2p.dial(e,t)).remotePeer}}function Dq(r,e){return new Pq(r,e)}class Rq{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}}function Nq(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=Di(r);e.push(t),r=r.slice(tt(t))}return e}class Oq extends Tt{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=m0({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=hs({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??fq,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,s)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",n.detail,s)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){const n=re(e.multihash.bytes,"base64");let s=this.wants.get(n);s==null&&(s={cid:e,priority:t.priority??1,wantType:t.wantType??Qt.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,s)),s.wantType===Qt.WantHave&&t.wantType===Qt.WantBlock&&(s.wantType=Qt.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===Qt.WantBlock?(await Pr(this,"block",t?.signal,{filter:a=>$e(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Pr(this,"presence",t?.signal,{filter:o=>$e(e.multihash.digest,o.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Fe(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{const n=new Set,s=new ju;for(const[i,o]of this.wants.entries())t.has(i)||o.cancel||(n.add(i),s.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:o.priority,wantType:o.wantType,cancel:o.cancel,sendDontHave:o.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(e,s);for(const i of n)t.add(i)}catch(i){this.log.error("error sending full wantlist to new peer",i)}})).catch(e=>{this.log.error("error sending messages",e)});for(const[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(const n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){const t=re(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){const s=new ju;return s.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Qt.WantHave,priority:1}),await this.network.sendMessage(t,s),(await Pr(this,"presence",n.signal,{filter:o=>t.equals(o.detail.sender)&&$e(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:Qt.WantBlock})}async wantSessionBlock(e,t,n={}){const s=new ju;return s.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Qt.WantBlock,priority:1}),await this.network.sendMessage(t,s),(await Pr(this,"presence",n.signal,{filter:o=>t.equals(o.detail.sender)&&$e(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){const n=re(e.multihash.bytes,"base64"),s=this.wants.get(n);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(const s of t.blocks){if(s.prefix==null||s.data==null)continue;const i=Nq(s.prefix),o=i[0],a=i[1],c=i[2],l=c===Qr.code?Qr:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(s.data);u.then!=null&&(u=await u);const h=Ne.create(o===0?0:1,a,u);this.log("received block from %p for %c",e,h),this.safeDispatchEvent("block",{detail:{sender:e,cid:h,block:s.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:h,has:!0,block:s.data}});const d=re(h.multihash.bytes,"base64"),g=this.wants.get(d);g!=null&&(g.cancel=!0,n=!0)}for(const{cid:s,type:i}of t.blockPresences){const o=Ne.decode(s);this.log("received %s from %p for %c",i,e,o),this.safeDispatchEvent("presence",{detail:{sender:e,cid:o,has:i===Ns.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){const t=new Set,n=new ju(!0);for(const[s,i]of this.wants.entries())i.cancel||(t.add(s),n.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:1,wantType:Qt.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(s){this.log.error("error sending full wantlist to new peer %p",e,s)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class Mq{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new Rq(e),this.network=new Iq(e,t),this.peerWantLists=new Cq({...e,network:this.network},t),this.wantList=new Oq({...e,network:this.network},t)}createSession(e={}){return Dq({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){const n=new AbortController,s=Je([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:s}).catch(i=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,i)});try{return(await this.wantList.wantBlock(e,{...t,signal:s})).block}finally{n.abort(),s.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const Lq=(r,e={})=>new Mq(r,e);class Bq{bitswap;started;constructor(e,t={}){const{getHasher:n}=e;this.bitswap=Lq(e,{hashLoader:{getHasher:async s=>n(s)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(n,s,i)=>{await this.bitswap.notify(n,s,i)},retrieve:async(n,s)=>t.retrieve(n,s)}}}function $q(r={}){return e=>new Bq(e,r)}const Uq=[pi,ad,ld,cd,Ql];function Qw(r){return Ux("sni",r)?.value}function Xw(r){const e=Ux("tcp",r)?.value;return e==null?"":`:${e}`}function Ux(r,e){return e.find(t=>t.name===r)}function Zw(r){return r.some(({code:e})=>e===Xc)}function Qn(r,e){const t=Fx[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===Un?`[${n}]`:n}const Fx={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Qn(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${Qn(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Qn(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Qn(t,e)}`},http:(r,e)=>{const t=Zw(e),n=Qw(e),s=Xw(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Qn(o,e);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=Qn(t,e),s=decodeURIComponent(r.value??"");return`${n}${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Qn(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Qn(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Qn(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=Zw(e),n=Qw(e),s=Xw(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Qn(o,e);return a=a?.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Qn(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function M6(r,e){const n=Ie(r).getComponents(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=Fx[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let o=i(s,n)??"";return Uq.includes(s.code)&&(o=o.replace(/^.*:\/\//,""),s.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}class Vx{url;#e=0;#t=0;#r=0;#o=0;#a=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#u(e){const t=e.multihash.bytes;return $n.encode(t)}async getRawBlock(e,t){const n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const s=this.#u(e),i=new AbortController,o=()=>{i.abort()};t?.addEventListener("abort",o);try{let a=this.#a.get(s);if(a==null){this.#e++;const c={signal:i.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},l=this.transformRequestInit!=null?await this.transformRequestInit(c):c;a=fetch(n.toString(),l).then(async u=>{if(this.log("GET %s %d",n,u.status),!u.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#o++,new Uint8Array(await u.arrayBuffer())}),this.#a.set(s,a)}return await a}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",o),this.#a.delete(s)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#o/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#o,pendingResponses:this.#a.size}}}const Fq=r=>r.toString().split("/").slice(1),gd=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Ue=r=>({match:e=>gd(t=>t===r).match(e),pattern:r}),dc=()=>({match:r=>gd(e=>typeof e=="string").match(r),pattern:"{string}"}),Oh=()=>({match:r=>gd(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),it=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{$t.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),G1=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{Jh.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),Xe=r=>({match:e=>{const t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),Ar=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Ve=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function St(...r){function e(s){let i=Fq(s);for(const o of r){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const Vq=it();St(Vq);const T0=Ve(Ue("dns4"),dc()),k0=Ve(Ue("dns6"),dc()),C0=Ve(Ue("dnsaddr"),dc()),L6=Ve(Ue("dns"),dc());St(T0,Xe(it()));St(k0,Xe(it()));St(C0,Xe(it()));const Kq=St(Ar(L6,C0,T0,k0),Xe(it())),Kx=Ve(Ue("ip4"),gd(Oa)),qx=Ve(Ue("ip6"),gd(s6)),B6=Ar(Kx,qx),gi=Ar(B6,L6,T0,k0,C0);St(Ar(B6,Ve(Ar(L6,C0,T0,k0),Xe(it()))));St(Kx);St(qx);St(B6);const $6=Ve(gi,Ue("tcp"),Oh()),md=Ve(gi,Ue("udp"),Oh());St(Ve($6,Xe(it())));St(md);const U6=Ve(md,Ue("quic"),Xe(it())),P0=Ve(md,Ue("quic-v1"),Xe(it())),qq=Ar(U6,P0);St(U6);St(P0);const ny=Ar(gi,$6,md,U6,P0),Hx=Ar(Ve(ny,Ue("ws"),Xe(it())));St(Hx);const zx=Ar(Ve(ny,Ue("wss"),Xe(it())),Ve(ny,Ue("tls"),Xe(Ve(Ue("sni"),dc())),Ue("ws"),Xe(it())));St(zx);const Wx=Ve(md,Ue("webrtc-direct"),Xe(G1()),Xe(G1()),Xe(it()));St(Wx);const jx=Ve(P0,Ue("webtransport"),Xe(G1()),Xe(G1()),Xe(it()));St(jx);const Y1=Ar(Hx,zx,Ve($6,Xe(it())),Ve(qq,Xe(it())),Ve(gi,Xe(it())),Wx,jx,it());St(Y1);const Hq=Ve(Y1,Ue("p2p-circuit"),it());St(Hq);const zq=Ar(Ve(Y1,Ue("p2p-circuit"),Ue("webrtc"),Xe(it())),Ve(Y1,Ue("webrtc"),Xe(it())),Ve(Ue("webrtc"),Xe(it())));St(zq);const Wq=Ar(Ve(gi,Ue("tcp"),Oh(),Ue("http"),Xe(it())),Ve(gi,Ue("http"),Xe(it()))),jq=St(Wq),Gq=Ar(Ve(gi,Ue("tcp"),Ar(Ve(Ue("443"),Ue("http")),Ve(Oh(),Ue("https")),Ve(Oh(),Ue("tls"),Ue("http"))),Xe(it())),Ve(gi,Ue("tls"),Ue("http"),Xe(it())),Ve(gi,Ue("https"),Xe(it()))),Yq=St(Gq),Qq=Ar(Ve(Ue("memory"),dc(),Xe(it())));St(Qq);const Xq=Ar(Ve(Ue("unix"),dc(),Xe(it())));St(Xq);function Gx(r,e,t){return r.filter(n=>{if(Yq.matches(n)||e&&jq.matches(n))return t||Kq.matches(n)?!0:Oo(n.toOptions().host)===!1;if(!e&&t){const{host:s}=n.toOptions();if(s==="127.0.0.1"||s==="localhost"||s.endsWith(".localhost"))return!0}return!1})}async function*Yx(r,e,t,n,s,i={}){for await(const o of e.findProviders(r,i)){const a=Gx(o.multiaddrs,n,s);if(a.length===0)continue;const c=M6(a[0]);yield new Vx(c,{logger:t,transformRequestInit:i.transformRequestInit})}}class Zq extends Dx{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??Qx,this.allowLocal=t.allowLocal??Xx,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);const s=await t.getRawBlock(e,n.signal);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(s),s}async*findNewProviders(e,t={}){yield*Yx(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(va(e))return;const n=Gx(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;const s=M6(n[0]);return new Vx(s,{logger:this.logger,transformRequestInit:this.transformRequestInit})}}function Jq(r,e){return new Zq(r,e)}class eH{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??Qx,this.allowLocal=t.allowLocal??Xx,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){const n=[];for await(const s of Yx(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,s.url);try{const i=await s.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,s.url);try{await t.validateFn?.(i)}catch(o){this.log.error("failed to validate block for %c from %s",e,s.url,o);continue}return i}catch(i){if(this.log.error("failed to get block for %c from %s",e,s.url,i),i instanceof Error?n.push(i):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${s.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,s.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return Jq({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const Qx=!1,Xx=!1;function tH(r={}){return e=>new eH(e,r)}async function*Jw(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var Zx={exports:{}};(function(r){(function(){r.exports=y;var e=86400,t=3200,n=146097*t/400,s=e*n,i=1e3*s,o=864e13,a=4294967296,c=1e6,l="000000000",u=Math.trunc||function(O){var C=O-O%1;return C==0&&(O<0||O===0&&1/O!=1/0)?-0:C},h=y.prototype,d=(y.fromDate=function(O){return new y(+O)},y.fromInt64BE=T(0,1,2,3,0,4),y.fromInt64LE=T(3,2,1,0,4,0),y.fromString=function(P){var C,N=new y,P=(P+="").replace(/^\s*[+\-]?\d+/,function(K){var K=+K,H=1970+(K-1970)%400;return N.year=K-H,H}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(M,K,H){return K<0&&(H*=-1),C=6e4*(60*+K+ +H),""}).replace(/\.\d+$/,function(M){return N.nano=+(M+l).substr(1,9),""}).split(/\D+/);if(1<P.length?P[1]--:P[1]=0,N.time=C=Date.UTC.apply(Date,P)-(C||0),isNaN(C))throw new TypeError("Invalid Date");return _(N)},y.fromTimeT=function(O){return R(O,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(O){return this.nano+=+O||0,this},h.getNano=function(){var O=_(this);return(O.time%1e3*c+ +O.nano+1e9)%1e9},h.getTimeT=function(){var C=_(this),O=Math.floor(C.time/1e3),C=C.year;return C&&(O+=C*n*e/t),O},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return A(_(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(O){var C=this,N=C.toDate(),P={H:function(){return D(N.getUTCHours())},L:function(){return F(N.getUTCMilliseconds(),3)},M:function(){return D(N.getUTCMinutes())},N:function(){return F(C.getNano(),9)},S:function(){return D(N.getUTCSeconds())},Y:function(){var M=C.getYear();return 999999<M?"+"+M:9999<M?"+"+F(M,6):0<=M?F(M,4):-999999<=M?"-"+F(-M,6):M},a:function(){return m[N.getUTCDay()]},b:function(){return g[N.getUTCMonth()]},d:function(){return D(N.getUTCDate())},e:function(){return function(M){return(9<M?"":" ")+(0|M)}(N.getUTCDate())},m:function(){return D(N.getUTCMonth()+1)}};return function M(K){return K.replace(/%./g,function(H){var B=H[1],$=b[B],B=P[B];return $?M($):B?B():H})}(O||d)},h.writeInt64BE=I(0,1,2,3,0,4),h.writeInt64LE=I(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],b={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return y;function y(O,C,N){var P=this;if(!(P instanceof y))return new y(O,C,N);P.time=+O||0,P.nano=+C||0,P.year=+N||0,_(P)}function _(O){var C,N,P,M=O.year,K=O.time,H=O.nano,$=((H<0||c<=H)&&(H-=(N=Math.floor(H/c))*c,K+=N,N=1),M%t);return(K<-o||o<K||$)&&((C=u(K/i))&&(M+=C*t,K-=C*i),(P=A(K)).setUTCFullYear($+P.getUTCFullYear()),P=(K=+P)+(C=u((M-=$)/t))*i,C&&-o<=P&&P<=o&&(M-=C*t,K=P),N=1),N&&(O.year=M,O.time=K,O.nano=H),O}function A(O){var C=new Date(0);return C.setTime(O),C}function R(M,P){M=+M||0;var N=u((P=(P|0)*a)/s)+u(M/s),P=P%s+M%s,M=u(P/s);return M&&(N+=M,P-=M*s),new y(1e3*P,0,N*t)}function I(O,C,N,P,M,K){return function($,B){var q=_(this);$=$||new Array(8),k($,B|=0);var Y=Math.floor(q.time/1e3),q=q.year*(n*e/t),z=u(q/a)+u(Y/a),q=q%a+Y%a,Y=Math.floor(q/a);return Y&&(z+=Y,q-=Y*a),H($,B+M,z),H($,B+K,q),$};function H($,B,z){$[B+O]=z>>24&255,$[B+C]=z>>16&255,$[B+N]=z>>8&255,$[B+P]=255&z}}function T(O,C,N,P,M,K){return function($,B){k($,B|=0);var z=H($,B+M);return R(H($,B+K),z)};function H($,B){return 16777216*$[B+O]+($[B+C]<<16|$[B+N]<<8|$[B+P])}}function k(O,C){if(O=O&&O.length,O==null)throw new TypeError("Invalid Buffer");if(O<C+8)throw new RangeError("Out of range")}function D(O){return(9<O?"":"0")+(0|O)}function F(O,C){return(l+(0|O)).substr(-C)}})()})(Zx);var rH=Zx.exports;const sy=nc(rH);class ea extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}class nH extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}class Jx extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}class sH extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}class iH extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}}class oH extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}class e7 extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}var cs;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>Zr(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=Ae((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.value!=null&&(s.uint32(10),s.bytes(n.value)),n.signatureV1!=null&&(s.uint32(18),s.bytes(n.signatureV1)),n.validityType!=null&&(s.uint32(24),r.ValidityType.codec().encode(n.validityType,s)),n.validity!=null&&(s.uint32(34),s.bytes(n.validity)),n.sequence!=null&&(s.uint32(40),s.uint64(n.sequence)),n.ttl!=null&&(s.uint32(48),s.uint64(n.ttl)),n.pubKey!=null&&(s.uint32(58),s.bytes(n.pubKey)),n.signatureV2!=null&&(s.uint32(66),s.bytes(n.signatureV2)),n.data!=null&&(s.uint32(74),s.bytes(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.value=n.bytes();break}case 2:{o.signatureV1=n.bytes();break}case 3:{o.validityType=r.ValidityType.codec().decode(n);break}case 4:{o.validity=n.bytes();break}case 5:{o.sequence=n.uint64();break}case 6:{o.ttl=n.uint64();break}case 7:{o.pubKey=n.bytes();break}case 8:{o.signatureV2=n.bytes();break}case 9:{o.data=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,s)=>_e(n,r.codec(),s)})(cs||(cs={}));const aH=Zl("ipns:utils"),eA=ne("/ipns/"),cH=0,lH=18;function uH(r){let e;if(r.pubKey!=null)try{e=Or(r.pubKey)}catch(t){throw aH.error(t),t}if(e!=null)return e}function hH(r){const e=ne("ipns-signature:");return Rr([e,r])}function tA(r){return"signatureV1"in r?cs.encode({value:ne(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:ne(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):cs.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function yd(r){const e=cs.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new ea("Missing data or signatureV2");const t=nA(e.data),n=dH(t.Value),s=re(t.Validity);if(e.value!=null&&e.signatureV1!=null)return fH(e),{value:n,validityType:cs.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:cs.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function rA(r){return Rr([eA,r.bytes])}function iy(r){const e=pr(r.slice(eA.length));if(!oy(e,cH)&&!oy(e,lH))throw new O4("Multihash in IPNS key was not identity or sha2-256");return e}function nA(r){const e=Zi(r);if(e.ValidityType===0)e.ValidityType=cs.ValidityType.EOL;else throw new Jx("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function dH(r){const e=re(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${Ne.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${Ne.parse(e).toV1().toString()}`}catch{}throw new iH("Value must be a valid content path starting with /")}function fH(r){if(r.data==null)throw new oH("Record data is missing");const e=nA(r.data);if(!$e(e.Value,r.value??new Uint8Array(0)))throw new ea('Field "value" did not match between protobuf and CBOR');if(!$e(e.Validity,r.validity??new Uint8Array(0)))throw new ea('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new ea('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new ea('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new ea('Field "ttl" did not match between protobuf and CBOR')}function oy(r,e){return r.code===e}const ff=Zl("ipns:validator"),pH=1024*10;async function gH(r,e){const t=yd(e);let n;try{const s=hH(t.data);n=await r.verify(s,t.signatureV2)}catch{n=!1}if(!n)throw ff.error("record signature verification failed"),new ea("Record signature verification failed");if(t.validityType===cs.ValidityType.EOL){if(sy.fromString(t.validity).toDate().getTime()<Date.now())throw ff.error("record has expired"),new nH("record has expired")}else if(t.validityType!=null)throw ff.error("the validity type is unsupported"),new Jx("The validity type is unsupported");ff("ipns record for %s is valid",t.value)}async function sA(r,e){if(e.byteLength>pH)throw new sH("The record is too large");const t=iy(r);let n;oy(t,0)&&(n=SS(t));const s=yd(e),i=uH(s)??n;if(i==null)throw new e7("Could not extract public key from IPNS record or routing key");const o=rA(i.toMultihash());if(!$e(o,r))throw new e7("Embedded public key did not match routing key");await gH(i,e)}let mH=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*t7(r,e={}){const t=/\r?\n/,n=new TextDecoder("utf8");let s="";for await(let i of r){if(typeof i=="string"&&(i=new TextEncoder().encode(i)),Ku(i)&&(i=i.subarray()),s+=n.decode(i,{stream:!0}),s.length>(e?.maxMessageLength??s.length))throw new mH("Incoming message too long");const o=s.split(t);s=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}s+=n.decode(),s!==""&&(yield JSON.parse(s))}class Dg extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}class Wi extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}}function yH(r){return r[Symbol.asyncIterator]!=null}function wH(r){if(yH(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}const r7=ne("/ipns/");function n7(r){return $e(r.subarray(0,r7.byteLength),r7)}class bH{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*pd(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!n7(e))return;const s=iy(e),i=Ne.createV1(114,s),o=yd(t);await this.client.putIPNS(i,o,n)}async get(e,t){if(!n7(e))throw new Ut("Not found");const n=iy(e),s=Ne.createV1(114,n);try{const i=await this.client.getIPNS(s,t);return tA(i)}catch(i){throw i.name==="BadResponseError"?new Ut("Not found"):i}}}class vH{client;constructor(e){this.client=e}async findPeer(e,t={}){const n=await wH(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new Ut("Not found")}async*getClosestPeers(e,t={}){}}const tr=Zl("delegated-routing-v1-http-api-client"),pf={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"};class EH{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new dl({concurrency:t.concurrentRequests??pf.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??pf.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new bH(this),this.peerRouting=new vH(this),this.cacheName=t.cacheName??pf.cacheName,this.cacheTTL=t.cacheTTL??pf.cacheTTL}get[al](){return this.contentRouting}get[cl](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&tr("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){tr("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),s=Je([this.shutDownController.signal,n,t.signal]),i=Fe(),o=Fe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:s},l=await this.#r(a.toString(),c);if(l==null)throw new Wi("No response received");if(!l.ok)throw l.status===404?new Ut("No matching records found"):l.status===422?new Dg("Request does not conform to schema or semantic constraints"):new Wi(`Unexpected status code: ${l.status}`);if(l.body==null)throw new Wi("Routing response had no body");const u=l.headers.get("Content-Type");if(u==null)throw new Wi("No Content-Type header received");if(u?.startsWith("application/json")){const h=await l.json();for(const d of h.Providers){const g=this.#e(d);g!=null&&(yield g)}}else if(u.includes("application/x-ndjson"))for await(const h of t7(Jw(l.body))){const d=this.#e(h);d!=null&&(yield d)}else throw new Wi(`Unsupported Content-Type: ${u}`)}finally{s.clear(),o.resolve(),tr("getProviders finished: %c",e)}}async*getPeers(e,t={}){tr("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),s=Je([this.shutDownController.signal,n,t.signal]),i=Fe(),o=Fe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:s},l=await this.#r(a.toString(),c);if(l.status===404)throw new Ut("No matching records found");if(l.status===422)throw new Dg("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Wi("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){const h=await l.json();for(const d of h.Peers){const g=this.#e(d);g!=null&&(yield g)}}else for await(const h of t7(Jw(l.body))){const d=this.#e(h);d!=null&&(yield d)}}catch(a){tr.error("getPeers errored:",a)}finally{s.clear(),o.resolve(),tr("getPeers finished: %c",e)}}async getIPNS(e,t={}){tr("getIPNS starts: %s",e);const n=AbortSignal.timeout(this.timeout),s=Je([this.shutDownController.signal,n,t.signal]),i=Fe(),o=Fe();this.httpQueue.add(async()=>(i.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await i.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:s},l=await this.#r(a,c);if(tr("getIPNS GET %s %d",a,l.status),l.status===404)throw new Ut("No matching records found");if(l.status===422)throw new Dg("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Wi("GET ipns response had no body");const u=await l.arrayBuffer(),h=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await sA(rA(e.multihash),h),yd(h)}catch(c){throw tr.error("getIPNS GET %s error:",a,c),c}finally{s.clear(),o.resolve(),tr("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){tr("putIPNS starts: %c",e);const s=AbortSignal.timeout(this.timeout),i=Je([this.shutDownController.signal,s,n.signal]),o=Fe(),a=Fe();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;const l=tA(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i},h=await this.#r(c,u);if(tr("putIPNS PUT %s %d",c,h.status),h.status!==200)throw new Wi("PUT ipns response had status other than 200")}catch(l){throw tr.error("putIPNS PUT %s error:",c,l.stack),l}finally{i.clear(),a.resolve(),tr("putIPNS finished: %c",e)}}#e(e){try{const t=[],n=e.Addrs?.map(Ie)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:Ht(e.ID),Addrs:n,Protocols:t}}catch(t){tr.error("could not conform record to peer schema",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){const s=t?.join(",")??this.filterAddrs?.join(",")??"";s!==""&&e.searchParams.set("filter-addrs",s)}if(n!=null||this.filterProtocols!=null){const s=n?.join(",")??this.filterProtocols?.join(",")??"";s!==""&&e.searchParams.set("filter-protocols",s)}}async#r(e,t){const n=t.method??"GET",s=`${n}-${e}`;if(n==="GET"){const c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return tr("returning cached response for %s",s),c;await this.cache?.delete(e)}}const i=this.inFlightRequests.get(s);if(i!=null){const c=await i;return tr("deduplicating outgoing request for %s",s),c.clone()}const o=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&n==="GET"){const l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());const h=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,h)}return c}).finally(()=>{this.inFlightRequests.delete(s)});return this.inFlightRequests.set(s,o),await o}}function SH(r,e={}){return new EH(new URL(r),e)}function _H(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const s7="[a-fA-F\\d:]",ro=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${s7})|(?<=${s7})(?=\\s|$))`:"",ts="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Lt="[a-fA-F\\d]{1,4}",D0=`
(?:
(?:${Lt}:){7}(?:${Lt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Lt}:){6}(?:${ts}|:${Lt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Lt}:){5}(?::${ts}|(?::${Lt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Lt}:){4}(?:(?::${Lt}){0,1}:${ts}|(?::${Lt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Lt}:){3}(?:(?::${Lt}){0,2}:${ts}|(?::${Lt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Lt}:){2}(?:(?::${Lt}){0,3}:${ts}|(?::${Lt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Lt}:){1}(?:(?::${Lt}){0,4}:${ts}|(?::${Lt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Lt}){0,5}:${ts}|(?::${Lt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),xH=new RegExp(`(?:^${ts}$)|(?:^${D0}$)`),AH=new RegExp(`^${ts}$`),IH=new RegExp(`^${D0}$`),R0=r=>r&&r.exact?xH:new RegExp(`(?:${ro(r)}${ts}${ro(r)})|(?:${ro(r)}${D0}${ro(r)})`,"g");R0.v4=r=>r&&r.exact?AH:new RegExp(`${ro(r)}${ts}${ro(r)}`,"g");R0.v6=r=>r&&r.exact?IH:new RegExp(`${ro(r)}${D0}${ro(r)}`,"g");function TH(r){const e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}const{toString:kH}=Object.prototype;function CH(r){return kH.call(r)==="[object RegExp]"}const i7={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function PH(r,e={}){if(!CH(r))throw new TypeError("Expected a RegExp instance");const t=Object.keys(i7).map(s=>(typeof e[s]=="boolean"?e[s]:r[s])?i7[s]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function iA(r,e,{timeout:t}={}){try{return TH(()=>PH(r).test(e),{timeout:t})()}catch(n){throw n}}const DH=15,RH=45,oA={timeout:400};function o7(r){return r.length>RH?!1:iA(R0.v6({exact:!0}),r,oA)}function NH(r){return r.length>DH?!1:iA(R0.v4({exact:!0}),r,oA)}const a7={http:"80",https:"443",ws:"80",wss:"443"},OH=["http","https","ws","wss"];function MH(r,e){e=e??{};const t=e.defaultDnsType??"dns",{scheme:n,hostname:s,port:i,path:o}=LH(r),a=[BH(s,t),$H(i,n),UH(n)];o!=null&&a.push(FH(o));const c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return Ie(c)}function LH(r){const[e]=r.split(":");OH.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:s,pathname:i,search:o}=new URL(r);if(s==null||s===""){const c=VH(e);c!=null&&(s=c),c==null&&t==="http:"&&(s="80")}let a;return i!=null&&i!==""&&i!=="/"&&(i.startsWith("/")&&(i=i.substring(1)),a=i),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:n,port:s,path:a}}function BH(r,e){if(!(r==null||r==="")){if(NH(r))return["ip4",r];if(o7(r))return["ip6",r];if(r[0]==="["){const t=r.substring(1,r.length-1);if(o7(t))return["ip6",t]}return[e,r]}}function $H(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function UH(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function FH(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function VH(r){if(!(r==null||r===""||a7[r]==null))return a7[r]}const KH=["https://trustless-gateway.link","https://4everland.io"],qH=2336;function HH(r){return r=r.toString(),{id:Gl(Ne.createV1(qH,wo.digest(ne(r)))),multiaddrs:[MH(r)]}}class zH{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??KH).map(t=>HH(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}}function WH(r={}){return new zH(r)}class jH{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function GH(r){return new jH(r)}class aA extends Cx{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(hn.encode(e.multihash.bytes),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(hn.encode(e.multihash.bytes));if(n==null)throw new wl;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(hn.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(hn.encode(e.multihash.bytes))}async*getAll(e){e?.signal?.throwIfAborted();for(const[t,n]of this.data.entries())yield{cid:Ne.createV1(o0,pr(hn.decode(t))),block:n},e?.signal?.throwIfAborted()}}Zl("blockstore:core:tiered");const YH="SHARDING";new ft(YH);Zl("datastore:core:tiered");function QH(r){return r>=55296&&r<=56319}function XH(r){return r>=56320&&r<=57343}var ZH=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,i=0,o,a,c=0;c<s;c+=1){if(o=t.charCodeAt(c),a=t[c],QH(o)&&XH(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t};function JH(r){return r>=55296&&r<=56319}function ez(r){return r>=56320&&r<=57343}var tz=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,i=null,o=0;o<t;o++)s=e.charCodeAt(o),ez(s)?i!=null&&JH(i)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),i=s;return n},rz=ZH,nz=tz,sz=rz.bind(null,nz),iz=sz,oz=/[\/\?<>\\:\*\|"]/g,az=/[\x00-\x1f\x80-\x9f]/g,cz=/^\.+$/,lz=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,uz=/[\. ]+$/;function c7(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(oz,e).replace(az,e).replace(cz,e).replace(lz,e).replace(uz,e);return iz(t,255)}var hz=function(r,e){var t=e&&e.replacement||"",n=c7(r,t);return t===""?n:c7(n,"")};const dz=nc(hz),Rg={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function cA(r){const e="AES-GCM";let t=16;const n=12,s="SHA-256",i=16,o=32767,a=Nr.get();t*=8;async function c(h,d){const g=a.getRandomValues(new Uint8Array(i)),m=a.getRandomValues(new Uint8Array(n)),b={name:e,iv:m};typeof d=="string"&&(d=ne(d));let y;if(d.length===0){y=await a.subtle.importKey("jwk",Rg,{name:"AES-GCM"},!0,["encrypt"]);try{const A={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},R=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(A,R,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",Rg,{name:"AES-GCM"},!0,["encrypt"])}}else{const A={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},R=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(A,R,{name:e,length:t},!0,["encrypt"])}const _=await a.subtle.encrypt(b,y,h);return Rr([g,b.iv,new Uint8Array(_)])}async function l(h,d){const g=h.subarray(0,i),m=h.subarray(i,i+n),b=h.subarray(i+n),y={name:e,iv:m};typeof d=="string"&&(d=ne(d));let _;if(d.length===0)try{const R={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},I=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);_=await a.subtle.deriveKey(R,I,{name:e,length:t},!0,["decrypt"])}catch{_=await a.subtle.importKey("jwk",Rg,{name:"AES-GCM"},!0,["decrypt"])}else{const R={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},I=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);_=await a.subtle.deriveKey(R,I,{name:e,length:t},!0,["decrypt"])}const A=await a.subtle.decrypt(y,_,b);return new Uint8Array(A)}return{encrypt:c,decrypt:l}}var Wt={},N0={};N0.byteLength=gz;N0.toByteArray=yz;N0.fromByteArray=vz;var Cs=[],Pn=[],fz=typeof Uint8Array<"u"?Uint8Array:Array,Ng="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var xc=0,pz=Ng.length;xc<pz;++xc)Cs[xc]=Ng[xc],Pn[Ng.charCodeAt(xc)]=xc;Pn[45]=62;Pn[95]=63;function lA(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function gz(r){var e=lA(r),t=e[0],n=e[1];return(t+n)*3/4-n}function mz(r,e,t){return(e+t)*3/4-t}function yz(r){var e,t=lA(r),n=t[0],s=t[1],i=new fz(mz(r,n,s)),o=0,a=s>0?n-4:n,c;for(c=0;c<a;c+=4)e=Pn[r.charCodeAt(c)]<<18|Pn[r.charCodeAt(c+1)]<<12|Pn[r.charCodeAt(c+2)]<<6|Pn[r.charCodeAt(c+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return s===2&&(e=Pn[r.charCodeAt(c)]<<2|Pn[r.charCodeAt(c+1)]>>4,i[o++]=e&255),s===1&&(e=Pn[r.charCodeAt(c)]<<10|Pn[r.charCodeAt(c+1)]<<4|Pn[r.charCodeAt(c+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function wz(r){return Cs[r>>18&63]+Cs[r>>12&63]+Cs[r>>6&63]+Cs[r&63]}function bz(r,e,t){for(var n,s=[],i=e;i<t;i+=3)n=(r[i]<<16&16711680)+(r[i+1]<<8&65280)+(r[i+2]&255),s.push(wz(n));return s.join("")}function vz(r){for(var e,t=r.length,n=t%3,s=[],i=16383,o=0,a=t-n;o<a;o+=i)s.push(bz(r,o,o+i>a?a:o+i));return n===1?(e=r[t-1],s.push(Cs[e>>2]+Cs[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],s.push(Cs[e>>10]+Cs[e>>4&63]+Cs[e<<2&63]+"=")),s.join("")}var F6={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */F6.read=function(r,e,t,n,s){var i,o,a=s*8-n-1,c=(1<<a)-1,l=c>>1,u=-7,h=t?s-1:0,d=t?-1:1,g=r[e+h];for(h+=d,i=g&(1<<-u)-1,g>>=-u,u+=a;u>0;i=i*256+r[e+h],h+=d,u-=8);for(o=i&(1<<-u)-1,i>>=-u,u+=n;u>0;o=o*256+r[e+h],h+=d,u-=8);if(i===0)i=1-l;else{if(i===c)return o?NaN:(g?-1:1)*(1/0);o=o+Math.pow(2,n),i=i-l}return(g?-1:1)*o*Math.pow(2,i-n)};F6.write=function(r,e,t,n,s,i){var o,a,c,l=i*8-s-1,u=(1<<l)-1,h=u>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,g=n?0:i-1,m=n?1:-1,b=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=u):(o=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-o))<1&&(o--,c*=2),o+h>=1?e+=d/c:e+=d*Math.pow(2,1-h),e*c>=2&&(o++,c/=2),o+h>=u?(a=0,o=u):o+h>=1?(a=(e*c-1)*Math.pow(2,s),o=o+h):(a=e*Math.pow(2,h-1)*Math.pow(2,s),o=0));s>=8;r[t+g]=a&255,g+=m,a/=256,s-=8);for(o=o<<s|a,l+=s;l>0;r[t+g]=o&255,g+=m,o/=256,l-=8);r[t+g-m]|=b*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(r){const e=N0,t=F6,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=u,r.SlowBuffer=T,r.INSPECT_MAX_BYTES=50;const s=2147483647;r.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:o,SharedArrayBuffer:a}=globalThis;u.TYPED_ARRAY_SUPPORT=c(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const E=new i(1),f={foo:function(){return 42}};return Object.setPrototypeOf(f,i.prototype),Object.setPrototypeOf(E,f),E.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function l(E){if(E>s)throw new RangeError('The value "'+E+'" is invalid for option "size"');const f=new i(E);return Object.setPrototypeOf(f,u.prototype),f}function u(E,f,p){if(typeof E=="number"){if(typeof f=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(E)}return h(E,f,p)}u.poolSize=8192;function h(E,f,p){if(typeof E=="string")return b(E,f);if(o.isView(E))return _(E);if(E==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof E);if(Br(E,o)||E&&Br(E.buffer,o)||typeof a<"u"&&(Br(E,a)||E&&Br(E.buffer,a)))return A(E,f,p);if(typeof E=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const v=E.valueOf&&E.valueOf();if(v!=null&&v!==E)return u.from(v,f,p);const x=R(E);if(x)return x;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof E[Symbol.toPrimitive]=="function")return u.from(E[Symbol.toPrimitive]("string"),f,p);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof E)}u.from=function(E,f,p){return h(E,f,p)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function d(E){if(typeof E!="number")throw new TypeError('"size" argument must be of type number');if(E<0)throw new RangeError('The value "'+E+'" is invalid for option "size"')}function g(E,f,p){return d(E),E<=0?l(E):f!==void 0?typeof p=="string"?l(E).fill(f,p):l(E).fill(f):l(E)}u.alloc=function(E,f,p){return g(E,f,p)};function m(E){return d(E),l(E<0?0:I(E)|0)}u.allocUnsafe=function(E){return m(E)},u.allocUnsafeSlow=function(E){return m(E)};function b(E,f){if((typeof f!="string"||f==="")&&(f="utf8"),!u.isEncoding(f))throw new TypeError("Unknown encoding: "+f);const p=k(E,f)|0;let v=l(p);const x=v.write(E,f);return x!==p&&(v=v.slice(0,x)),v}function y(E){const f=E.length<0?0:I(E.length)|0,p=l(f);for(let v=0;v<f;v+=1)p[v]=E[v]&255;return p}function _(E){if(Br(E,i)){const f=new i(E);return A(f.buffer,f.byteOffset,f.byteLength)}return y(E)}function A(E,f,p){if(f<0||E.byteLength<f)throw new RangeError('"offset" is outside of buffer bounds');if(E.byteLength<f+(p||0))throw new RangeError('"length" is outside of buffer bounds');let v;return f===void 0&&p===void 0?v=new i(E):p===void 0?v=new i(E,f):v=new i(E,f,p),Object.setPrototypeOf(v,u.prototype),v}function R(E){if(u.isBuffer(E)){const f=I(E.length)|0,p=l(f);return p.length===0||E.copy(p,0,0,f),p}if(E.length!==void 0)return typeof E.length!="number"||Wn(E.length)?l(0):y(E);if(E.type==="Buffer"&&Array.isArray(E.data))return y(E.data)}function I(E){if(E>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return E|0}function T(E){return+E!=E&&(E=0),u.alloc(+E)}u.isBuffer=function(f){return f!=null&&f._isBuffer===!0&&f!==u.prototype},u.compare=function(f,p){if(Br(f,i)&&(f=u.from(f,f.offset,f.byteLength)),Br(p,i)&&(p=u.from(p,p.offset,p.byteLength)),!u.isBuffer(f)||!u.isBuffer(p))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(f===p)return 0;let v=f.length,x=p.length;for(let L=0,W=Math.min(v,x);L<W;++L)if(f[L]!==p[L]){v=f[L],x=p[L];break}return v<x?-1:x<v?1:0},u.isEncoding=function(f){switch(String(f).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(f,p){if(!Array.isArray(f))throw new TypeError('"list" argument must be an Array of Buffers');if(f.length===0)return u.alloc(0);let v;if(p===void 0)for(p=0,v=0;v<f.length;++v)p+=f[v].length;const x=u.allocUnsafe(p);let L=0;for(v=0;v<f.length;++v){let W=f[v];if(Br(W,i))L+W.length>x.length?(u.isBuffer(W)||(W=u.from(W)),W.copy(x,L)):i.prototype.set.call(x,W,L);else if(u.isBuffer(W))W.copy(x,L);else throw new TypeError('"list" argument must be an Array of Buffers');L+=W.length}return x};function k(E,f){if(u.isBuffer(E))return E.length;if(o.isView(E)||Br(E,o))return E.byteLength;if(typeof E!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof E);const p=E.length,v=arguments.length>2&&arguments[2]===!0;if(!v&&p===0)return 0;let x=!1;for(;;)switch(f){case"ascii":case"latin1":case"binary":return p;case"utf8":case"utf-8":return Ws(E).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return p*2;case"hex":return p>>>1;case"base64":return wc(E).length;default:if(x)return v?-1:Ws(E).length;f=(""+f).toLowerCase(),x=!0}}u.byteLength=k;function D(E,f,p){let v=!1;if((f===void 0||f<0)&&(f=0),f>this.length||((p===void 0||p>this.length)&&(p=this.length),p<=0)||(p>>>=0,f>>>=0,p<=f))return"";for(E||(E="utf8");;)switch(E){case"hex":return j(this,f,p);case"utf8":case"utf-8":return B(this,f,p);case"ascii":return Y(this,f,p);case"latin1":case"binary":return Q(this,f,p);case"base64":return $(this,f,p);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return we(this,f,p);default:if(v)throw new TypeError("Unknown encoding: "+E);E=(E+"").toLowerCase(),v=!0}}u.prototype._isBuffer=!0;function F(E,f,p){const v=E[f];E[f]=E[p],E[p]=v}u.prototype.swap16=function(){const f=this.length;if(f%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let p=0;p<f;p+=2)F(this,p,p+1);return this},u.prototype.swap32=function(){const f=this.length;if(f%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let p=0;p<f;p+=4)F(this,p,p+3),F(this,p+1,p+2);return this},u.prototype.swap64=function(){const f=this.length;if(f%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let p=0;p<f;p+=8)F(this,p,p+7),F(this,p+1,p+6),F(this,p+2,p+5),F(this,p+3,p+4);return this},u.prototype.toString=function(){const f=this.length;return f===0?"":arguments.length===0?B(this,0,f):D.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(f){if(!u.isBuffer(f))throw new TypeError("Argument must be a Buffer");return this===f?!0:u.compare(this,f)===0},u.prototype.inspect=function(){let f="";const p=r.INSPECT_MAX_BYTES;return f=this.toString("hex",0,p).replace(/(.{2})/g,"$1 ").trim(),this.length>p&&(f+=" ... "),"<Buffer "+f+">"},n&&(u.prototype[n]=u.prototype.inspect),u.prototype.compare=function(f,p,v,x,L){if(Br(f,i)&&(f=u.from(f,f.offset,f.byteLength)),!u.isBuffer(f))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof f);if(p===void 0&&(p=0),v===void 0&&(v=f?f.length:0),x===void 0&&(x=0),L===void 0&&(L=this.length),p<0||v>f.length||x<0||L>this.length)throw new RangeError("out of range index");if(x>=L&&p>=v)return 0;if(x>=L)return-1;if(p>=v)return 1;if(p>>>=0,v>>>=0,x>>>=0,L>>>=0,this===f)return 0;let W=L-x,pe=v-p;const ge=Math.min(W,pe),X=this.slice(x,L),Z=f.slice(p,v);for(let J=0;J<ge;++J)if(X[J]!==Z[J]){W=X[J],pe=Z[J];break}return W<pe?-1:pe<W?1:0};function O(E,f,p,v,x){if(E.length===0)return-1;if(typeof p=="string"?(v=p,p=0):p>2147483647?p=2147483647:p<-2147483648&&(p=-2147483648),p=+p,Wn(p)&&(p=x?0:E.length-1),p<0&&(p=E.length+p),p>=E.length){if(x)return-1;p=E.length-1}else if(p<0)if(x)p=0;else return-1;if(typeof f=="string"&&(f=u.from(f,v)),u.isBuffer(f))return f.length===0?-1:C(E,f,p,v,x);if(typeof f=="number")return f=f&255,typeof i.prototype.indexOf=="function"?x?i.prototype.indexOf.call(E,f,p):i.prototype.lastIndexOf.call(E,f,p):C(E,[f],p,v,x);throw new TypeError("val must be string, number or Buffer")}function C(E,f,p,v,x){let L=1,W=E.length,pe=f.length;if(v!==void 0&&(v=String(v).toLowerCase(),v==="ucs2"||v==="ucs-2"||v==="utf16le"||v==="utf-16le")){if(E.length<2||f.length<2)return-1;L=2,W/=2,pe/=2,p/=2}function ge(Z,J){return L===1?Z[J]:Z.readUInt16BE(J*L)}let X;if(x){let Z=-1;for(X=p;X<W;X++)if(ge(E,X)===ge(f,Z===-1?0:X-Z)){if(Z===-1&&(Z=X),X-Z+1===pe)return Z*L}else Z!==-1&&(X-=X-Z),Z=-1}else for(p+pe>W&&(p=W-pe),X=p;X>=0;X--){let Z=!0;for(let J=0;J<pe;J++)if(ge(E,X+J)!==ge(f,J)){Z=!1;break}if(Z)return X}return-1}u.prototype.includes=function(f,p,v){return this.indexOf(f,p,v)!==-1},u.prototype.indexOf=function(f,p,v){return O(this,f,p,v,!0)},u.prototype.lastIndexOf=function(f,p,v){return O(this,f,p,v,!1)};function N(E,f,p,v){p=Number(p)||0;const x=E.length-p;v?(v=Number(v),v>x&&(v=x)):v=x;const L=f.length;v>L/2&&(v=L/2);let W;for(W=0;W<v;++W){const pe=parseInt(f.substr(W*2,2),16);if(Wn(pe))return W;E[p+W]=pe}return W}function P(E,f,p,v){return gs(Ws(f,E.length-p),E,p,v)}function M(E,f,p,v){return gs($i(f),E,p,v)}function K(E,f,p,v){return gs(wc(f),E,p,v)}function H(E,f,p,v){return gs(Uo(f,E.length-p),E,p,v)}u.prototype.write=function(f,p,v,x){if(p===void 0)x="utf8",v=this.length,p=0;else if(v===void 0&&typeof p=="string")x=p,v=this.length,p=0;else if(isFinite(p))p=p>>>0,isFinite(v)?(v=v>>>0,x===void 0&&(x="utf8")):(x=v,v=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const L=this.length-p;if((v===void 0||v>L)&&(v=L),f.length>0&&(v<0||p<0)||p>this.length)throw new RangeError("Attempt to write outside buffer bounds");x||(x="utf8");let W=!1;for(;;)switch(x){case"hex":return N(this,f,p,v);case"utf8":case"utf-8":return P(this,f,p,v);case"ascii":case"latin1":case"binary":return M(this,f,p,v);case"base64":return K(this,f,p,v);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return H(this,f,p,v);default:if(W)throw new TypeError("Unknown encoding: "+x);x=(""+x).toLowerCase(),W=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function $(E,f,p){return f===0&&p===E.length?e.fromByteArray(E):e.fromByteArray(E.slice(f,p))}function B(E,f,p){p=Math.min(E.length,p);const v=[];let x=f;for(;x<p;){const L=E[x];let W=null,pe=L>239?4:L>223?3:L>191?2:1;if(x+pe<=p){let ge,X,Z,J;switch(pe){case 1:L<128&&(W=L);break;case 2:ge=E[x+1],(ge&192)===128&&(J=(L&31)<<6|ge&63,J>127&&(W=J));break;case 3:ge=E[x+1],X=E[x+2],(ge&192)===128&&(X&192)===128&&(J=(L&15)<<12|(ge&63)<<6|X&63,J>2047&&(J<55296||J>57343)&&(W=J));break;case 4:ge=E[x+1],X=E[x+2],Z=E[x+3],(ge&192)===128&&(X&192)===128&&(Z&192)===128&&(J=(L&15)<<18|(ge&63)<<12|(X&63)<<6|Z&63,J>65535&&J<1114112&&(W=J))}}W===null?(W=65533,pe=1):W>65535&&(W-=65536,v.push(W>>>10&1023|55296),W=56320|W&1023),v.push(W),x+=pe}return q(v)}const z=4096;function q(E){const f=E.length;if(f<=z)return String.fromCharCode.apply(String,E);let p="",v=0;for(;v<f;)p+=String.fromCharCode.apply(String,E.slice(v,v+=z));return p}function Y(E,f,p){let v="";p=Math.min(E.length,p);for(let x=f;x<p;++x)v+=String.fromCharCode(E[x]&127);return v}function Q(E,f,p){let v="";p=Math.min(E.length,p);for(let x=f;x<p;++x)v+=String.fromCharCode(E[x]);return v}function j(E,f,p){const v=E.length;(!f||f<0)&&(f=0),(!p||p<0||p>v)&&(p=v);let x="";for(let L=f;L<p;++L)x+=bc[E[L]];return x}function we(E,f,p){const v=E.slice(f,p);let x="";for(let L=0;L<v.length-1;L+=2)x+=String.fromCharCode(v[L]+v[L+1]*256);return x}u.prototype.slice=function(f,p){const v=this.length;f=~~f,p=p===void 0?v:~~p,f<0?(f+=v,f<0&&(f=0)):f>v&&(f=v),p<0?(p+=v,p<0&&(p=0)):p>v&&(p=v),p<f&&(p=f);const x=this.subarray(f,p);return Object.setPrototypeOf(x,u.prototype),x};function ue(E,f,p){if(E%1!==0||E<0)throw new RangeError("offset is not uint");if(E+f>p)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(f,p,v){f=f>>>0,p=p>>>0,v||ue(f,p,this.length);let x=this[f],L=1,W=0;for(;++W<p&&(L*=256);)x+=this[f+W]*L;return x},u.prototype.readUintBE=u.prototype.readUIntBE=function(f,p,v){f=f>>>0,p=p>>>0,v||ue(f,p,this.length);let x=this[f+--p],L=1;for(;p>0&&(L*=256);)x+=this[f+--p]*L;return x},u.prototype.readUint8=u.prototype.readUInt8=function(f,p){return f=f>>>0,p||ue(f,1,this.length),this[f]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(f,p){return f=f>>>0,p||ue(f,2,this.length),this[f]|this[f+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(f,p){return f=f>>>0,p||ue(f,2,this.length),this[f]<<8|this[f+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(f,p){return f=f>>>0,p||ue(f,4,this.length),(this[f]|this[f+1]<<8|this[f+2]<<16)+this[f+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(f,p){return f=f>>>0,p||ue(f,4,this.length),this[f]*16777216+(this[f+1]<<16|this[f+2]<<8|this[f+3])},u.prototype.readBigUInt64LE=In(function(f){f=f>>>0,rn(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&nn(f,this.length-8);const x=p+this[++f]*2**8+this[++f]*2**16+this[++f]*2**24,L=this[++f]+this[++f]*2**8+this[++f]*2**16+v*2**24;return BigInt(x)+(BigInt(L)<<BigInt(32))}),u.prototype.readBigUInt64BE=In(function(f){f=f>>>0,rn(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&nn(f,this.length-8);const x=p*2**24+this[++f]*2**16+this[++f]*2**8+this[++f],L=this[++f]*2**24+this[++f]*2**16+this[++f]*2**8+v;return(BigInt(x)<<BigInt(32))+BigInt(L)}),u.prototype.readIntLE=function(f,p,v){f=f>>>0,p=p>>>0,v||ue(f,p,this.length);let x=this[f],L=1,W=0;for(;++W<p&&(L*=256);)x+=this[f+W]*L;return L*=128,x>=L&&(x-=Math.pow(2,8*p)),x},u.prototype.readIntBE=function(f,p,v){f=f>>>0,p=p>>>0,v||ue(f,p,this.length);let x=p,L=1,W=this[f+--x];for(;x>0&&(L*=256);)W+=this[f+--x]*L;return L*=128,W>=L&&(W-=Math.pow(2,8*p)),W},u.prototype.readInt8=function(f,p){return f=f>>>0,p||ue(f,1,this.length),this[f]&128?(255-this[f]+1)*-1:this[f]},u.prototype.readInt16LE=function(f,p){f=f>>>0,p||ue(f,2,this.length);const v=this[f]|this[f+1]<<8;return v&32768?v|4294901760:v},u.prototype.readInt16BE=function(f,p){f=f>>>0,p||ue(f,2,this.length);const v=this[f+1]|this[f]<<8;return v&32768?v|4294901760:v},u.prototype.readInt32LE=function(f,p){return f=f>>>0,p||ue(f,4,this.length),this[f]|this[f+1]<<8|this[f+2]<<16|this[f+3]<<24},u.prototype.readInt32BE=function(f,p){return f=f>>>0,p||ue(f,4,this.length),this[f]<<24|this[f+1]<<16|this[f+2]<<8|this[f+3]},u.prototype.readBigInt64LE=In(function(f){f=f>>>0,rn(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&nn(f,this.length-8);const x=this[f+4]+this[f+5]*2**8+this[f+6]*2**16+(v<<24);return(BigInt(x)<<BigInt(32))+BigInt(p+this[++f]*2**8+this[++f]*2**16+this[++f]*2**24)}),u.prototype.readBigInt64BE=In(function(f){f=f>>>0,rn(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&nn(f,this.length-8);const x=(p<<24)+this[++f]*2**16+this[++f]*2**8+this[++f];return(BigInt(x)<<BigInt(32))+BigInt(this[++f]*2**24+this[++f]*2**16+this[++f]*2**8+v)}),u.prototype.readFloatLE=function(f,p){return f=f>>>0,p||ue(f,4,this.length),t.read(this,f,!0,23,4)},u.prototype.readFloatBE=function(f,p){return f=f>>>0,p||ue(f,4,this.length),t.read(this,f,!1,23,4)},u.prototype.readDoubleLE=function(f,p){return f=f>>>0,p||ue(f,8,this.length),t.read(this,f,!0,52,8)},u.prototype.readDoubleBE=function(f,p){return f=f>>>0,p||ue(f,8,this.length),t.read(this,f,!1,52,8)};function fe(E,f,p,v,x,L){if(!u.isBuffer(E))throw new TypeError('"buffer" argument must be a Buffer instance');if(f>x||f<L)throw new RangeError('"value" argument is out of bounds');if(p+v>E.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(f,p,v,x){if(f=+f,p=p>>>0,v=v>>>0,!x){const pe=Math.pow(2,8*v)-1;fe(this,f,p,v,pe,0)}let L=1,W=0;for(this[p]=f&255;++W<v&&(L*=256);)this[p+W]=f/L&255;return p+v},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(f,p,v,x){if(f=+f,p=p>>>0,v=v>>>0,!x){const pe=Math.pow(2,8*v)-1;fe(this,f,p,v,pe,0)}let L=v-1,W=1;for(this[p+L]=f&255;--L>=0&&(W*=256);)this[p+L]=f/W&255;return p+v},u.prototype.writeUint8=u.prototype.writeUInt8=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,1,255,0),this[p]=f&255,p+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,2,65535,0),this[p]=f&255,this[p+1]=f>>>8,p+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,2,65535,0),this[p]=f>>>8,this[p+1]=f&255,p+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,4,4294967295,0),this[p+3]=f>>>24,this[p+2]=f>>>16,this[p+1]=f>>>8,this[p]=f&255,p+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,4,4294967295,0),this[p]=f>>>24,this[p+1]=f>>>16,this[p+2]=f>>>8,this[p+3]=f&255,p+4};function ce(E,f,p,v,x){Dt(f,v,x,E,p,7);let L=Number(f&BigInt(4294967295));E[p++]=L,L=L>>8,E[p++]=L,L=L>>8,E[p++]=L,L=L>>8,E[p++]=L;let W=Number(f>>BigInt(32)&BigInt(4294967295));return E[p++]=W,W=W>>8,E[p++]=W,W=W>>8,E[p++]=W,W=W>>8,E[p++]=W,p}function ke(E,f,p,v,x){Dt(f,v,x,E,p,7);let L=Number(f&BigInt(4294967295));E[p+7]=L,L=L>>8,E[p+6]=L,L=L>>8,E[p+5]=L,L=L>>8,E[p+4]=L;let W=Number(f>>BigInt(32)&BigInt(4294967295));return E[p+3]=W,W=W>>8,E[p+2]=W,W=W>>8,E[p+1]=W,W=W>>8,E[p]=W,p+8}u.prototype.writeBigUInt64LE=In(function(f,p=0){return ce(this,f,p,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=In(function(f,p=0){return ke(this,f,p,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(f,p,v,x){if(f=+f,p=p>>>0,!x){const ge=Math.pow(2,8*v-1);fe(this,f,p,v,ge-1,-ge)}let L=0,W=1,pe=0;for(this[p]=f&255;++L<v&&(W*=256);)f<0&&pe===0&&this[p+L-1]!==0&&(pe=1),this[p+L]=(f/W>>0)-pe&255;return p+v},u.prototype.writeIntBE=function(f,p,v,x){if(f=+f,p=p>>>0,!x){const ge=Math.pow(2,8*v-1);fe(this,f,p,v,ge-1,-ge)}let L=v-1,W=1,pe=0;for(this[p+L]=f&255;--L>=0&&(W*=256);)f<0&&pe===0&&this[p+L+1]!==0&&(pe=1),this[p+L]=(f/W>>0)-pe&255;return p+v},u.prototype.writeInt8=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,1,127,-128),f<0&&(f=255+f+1),this[p]=f&255,p+1},u.prototype.writeInt16LE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,2,32767,-32768),this[p]=f&255,this[p+1]=f>>>8,p+2},u.prototype.writeInt16BE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,2,32767,-32768),this[p]=f>>>8,this[p+1]=f&255,p+2},u.prototype.writeInt32LE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,4,2147483647,-2147483648),this[p]=f&255,this[p+1]=f>>>8,this[p+2]=f>>>16,this[p+3]=f>>>24,p+4},u.prototype.writeInt32BE=function(f,p,v){return f=+f,p=p>>>0,v||fe(this,f,p,4,2147483647,-2147483648),f<0&&(f=4294967295+f+1),this[p]=f>>>24,this[p+1]=f>>>16,this[p+2]=f>>>8,this[p+3]=f&255,p+4},u.prototype.writeBigInt64LE=In(function(f,p=0){return ce(this,f,p,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=In(function(f,p=0){return ke(this,f,p,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Oe(E,f,p,v,x,L){if(p+v>E.length)throw new RangeError("Index out of range");if(p<0)throw new RangeError("Index out of range")}function ot(E,f,p,v,x){return f=+f,p=p>>>0,x||Oe(E,f,p,4),t.write(E,f,p,v,23,4),p+4}u.prototype.writeFloatLE=function(f,p,v){return ot(this,f,p,!0,v)},u.prototype.writeFloatBE=function(f,p,v){return ot(this,f,p,!1,v)};function lt(E,f,p,v,x){return f=+f,p=p>>>0,x||Oe(E,f,p,8),t.write(E,f,p,v,52,8),p+8}u.prototype.writeDoubleLE=function(f,p,v){return lt(this,f,p,!0,v)},u.prototype.writeDoubleBE=function(f,p,v){return lt(this,f,p,!1,v)},u.prototype.copy=function(f,p,v,x){if(!u.isBuffer(f))throw new TypeError("argument should be a Buffer");if(v||(v=0),!x&&x!==0&&(x=this.length),p>=f.length&&(p=f.length),p||(p=0),x>0&&x<v&&(x=v),x===v||f.length===0||this.length===0)return 0;if(p<0)throw new RangeError("targetStart out of bounds");if(v<0||v>=this.length)throw new RangeError("Index out of range");if(x<0)throw new RangeError("sourceEnd out of bounds");x>this.length&&(x=this.length),f.length-p<x-v&&(x=f.length-p+v);const L=x-v;return this===f&&typeof i.prototype.copyWithin=="function"?this.copyWithin(p,v,x):i.prototype.set.call(f,this.subarray(v,x),p),L},u.prototype.fill=function(f,p,v,x){if(typeof f=="string"){if(typeof p=="string"?(x=p,p=0,v=this.length):typeof v=="string"&&(x=v,v=this.length),x!==void 0&&typeof x!="string")throw new TypeError("encoding must be a string");if(typeof x=="string"&&!u.isEncoding(x))throw new TypeError("Unknown encoding: "+x);if(f.length===1){const W=f.charCodeAt(0);(x==="utf8"&&W<128||x==="latin1")&&(f=W)}}else typeof f=="number"?f=f&255:typeof f=="boolean"&&(f=Number(f));if(p<0||this.length<p||this.length<v)throw new RangeError("Out of range index");if(v<=p)return this;p=p>>>0,v=v===void 0?this.length:v>>>0,f||(f=0);let L;if(typeof f=="number")for(L=p;L<v;++L)this[L]=f;else{const W=u.isBuffer(f)?f:u.from(f,x),pe=W.length;if(pe===0)throw new TypeError('The value "'+f+'" is invalid for argument "value"');for(L=0;L<v-p;++L)this[L+p]=W[L%pe]}return this};const Te={};function Ke(E,f,p){Te[E]=class extends p{constructor(){super(),Object.defineProperty(this,"message",{value:f.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${E}]`,this.stack,delete this.name}get code(){return E}set code(x){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:x,writable:!0})}toString(){return`${this.name} [${E}]: ${this.message}`}}}Ke("ERR_BUFFER_OUT_OF_BOUNDS",function(E){return E?`${E} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Ke("ERR_INVALID_ARG_TYPE",function(E,f){return`The "${E}" argument must be of type number. Received type ${typeof f}`},TypeError),Ke("ERR_OUT_OF_RANGE",function(E,f,p){let v=`The value of "${E}" is out of range.`,x=p;return Number.isInteger(p)&&Math.abs(p)>2**32?x=Mt(String(p)):typeof p=="bigint"&&(x=String(p),(p>BigInt(2)**BigInt(32)||p<-(BigInt(2)**BigInt(32)))&&(x=Mt(x)),x+="n"),v+=` It must be ${f}. Received ${x}`,v},RangeError);function Mt(E){let f="",p=E.length;const v=E[0]==="-"?1:0;for(;p>=v+4;p-=3)f=`_${E.slice(p-3,p)}${f}`;return`${E.slice(0,p)}${f}`}function Ft(E,f,p){rn(f,"offset"),(E[f]===void 0||E[f+p]===void 0)&&nn(f,E.length-(p+1))}function Dt(E,f,p,v,x,L){if(E>p||E<f){const W=typeof f=="bigint"?"n":"";let pe;throw f===0||f===BigInt(0)?pe=`>= 0${W} and < 2${W} ** ${(L+1)*8}${W}`:pe=`>= -(2${W} ** ${(L+1)*8-1}${W}) and < 2 ** ${(L+1)*8-1}${W}`,new Te.ERR_OUT_OF_RANGE("value",pe,E)}Ft(v,x,L)}function rn(E,f){if(typeof E!="number")throw new Te.ERR_INVALID_ARG_TYPE(f,"number",E)}function nn(E,f,p){throw Math.floor(E)!==E?(rn(E,p),new Te.ERR_OUT_OF_RANGE("offset","an integer",E)):f<0?new Te.ERR_BUFFER_OUT_OF_BOUNDS:new Te.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${f}`,E)}const $o=/[^+/0-9A-Za-z-_]/g;function yc(E){if(E=E.split("=")[0],E=E.trim().replace($o,""),E.length<2)return"";for(;E.length%4!==0;)E=E+"=";return E}function Ws(E,f){f=f||1/0;let p;const v=E.length;let x=null;const L=[];for(let W=0;W<v;++W){if(p=E.charCodeAt(W),p>55295&&p<57344){if(!x){if(p>56319){(f-=3)>-1&&L.push(239,191,189);continue}else if(W+1===v){(f-=3)>-1&&L.push(239,191,189);continue}x=p;continue}if(p<56320){(f-=3)>-1&&L.push(239,191,189),x=p;continue}p=(x-55296<<10|p-56320)+65536}else x&&(f-=3)>-1&&L.push(239,191,189);if(x=null,p<128){if((f-=1)<0)break;L.push(p)}else if(p<2048){if((f-=2)<0)break;L.push(p>>6|192,p&63|128)}else if(p<65536){if((f-=3)<0)break;L.push(p>>12|224,p>>6&63|128,p&63|128)}else if(p<1114112){if((f-=4)<0)break;L.push(p>>18|240,p>>12&63|128,p>>6&63|128,p&63|128)}else throw new Error("Invalid code point")}return L}function $i(E){const f=[];for(let p=0;p<E.length;++p)f.push(E.charCodeAt(p)&255);return f}function Uo(E,f){let p,v,x;const L=[];for(let W=0;W<E.length&&!((f-=2)<0);++W)p=E.charCodeAt(W),v=p>>8,x=p%256,L.push(x),L.push(v);return L}function wc(E){return e.toByteArray(yc(E))}function gs(E,f,p,v){let x;for(x=0;x<v&&!(x+p>=f.length||x>=E.length);++x)f[x+p]=E[x];return x}function Br(E,f){return E instanceof f||E!=null&&E.constructor!=null&&E.constructor.name!=null&&E.constructor.name===f.name}function Wn(E){return E!==E}const bc=function(){const E="0123456789abcdef",f=new Array(256);for(let p=0;p<16;++p){const v=p*16;for(let x=0;x<16;++x)f[v+x]=E[p]+E[x]}return f}();function In(E){return typeof BigInt>"u"?yu:E}function yu(){throw new Error("BigInt not supported")}})(Wt);const ay=Wt.Buffer,Ez=Wt.Blob,Sz=Wt.BlobOptions,_z=Wt.Buffer,xz=Wt.File,Az=Wt.FileOptions,Iz=Wt.INSPECT_MAX_BYTES,Tz=Wt.SlowBuffer,kz=Wt.TranscodeEncoding,Cz=Wt.atob,Pz=Wt.btoa,Dz=Wt.constants,Rz=Wt.isAscii,Nz=Wt.isUtf8,Oz=Wt.kMaxLength,Mz=Wt.kStringMaxLength,Lz=Wt.resolveObjectURL,Bz=Wt.transcode,$z=Object.freeze(Object.defineProperty({__proto__:null,Blob:Ez,BlobOptions:Sz,Buffer:_z,File:xz,FileOptions:Az,INSPECT_MAX_BYTES:Iz,SlowBuffer:Tz,TranscodeEncoding:kz,atob:Cz,btoa:Pz,constants:Dz,default:ay,isAscii:Rz,isUtf8:Nz,kMaxLength:Oz,kStringMaxLength:Mz,resolveObjectURL:Lz,transcode:Bz},Symbol.toStringTag,{value:"Module"}));/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const Uz="[object ArrayBuffer]";class oe{static isArrayBuffer(e){return Object.prototype.toString.call(e)===Uz}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=oe.toUint8Array(e),s=oe.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const s=new Uint8Array(n);let i=0;for(const o of t){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Og="string",Fz=/^[0-9a-f\s]+$/i,Vz=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,Kz=/^[a-zA-Z0-9-_]+$/;class l7{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){const t=oe.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}}class ys{static toString(e,t=!1){const n=oe.toArrayBuffer(e),s=new DataView(n);let i="";for(let o=0;o<n.byteLength;o+=2){const a=s.getUint16(o,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return n}}class ye{static isHex(e){return typeof e===Og&&Fz.test(e)}static isBase64(e){return typeof e===Og&&Vz.test(e)}static isBase64Url(e){return typeof e===Og&&Kz.test(e)}static ToString(e,t="utf8"){const n=oe.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return ys.toString(n,!0);case"utf16":case"utf16be":return ys.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return ys.fromString(e,!0);case"utf16":case"utf16be":return ys.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=oe.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return ay.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ye.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(ay.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ye.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return l7.fromString(e);case"utf16":case"utf16be":return ys.fromString(e);case"utf16le":case"usc2":return ys.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return l7.toString(e);case"utf16":case"utf16be":return ys.toString(e);case"utf16le":case"usc2":return ys.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){const t=oe.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){const t=oe.toUint8Array(e);let n="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ye.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);n[s/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return ys.toString(e,t)}static FromUtf16String(e,t=!1){return ys.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}ye.DEFAULT_UTF8_ENCODING="utf8";function qz(...r){const e=r.map(s=>s.byteLength).reduce((s,i)=>s+i),t=new Uint8Array(e);let n=0;return r.map(s=>new Uint8Array(s)).forEach(s=>{for(const i of s)t[n++]=i}),t.buffer}function uA(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<r.byteLength;s++)if(t[s]!==n[s])return!1;return!0}/*!
 Copyright (c) Peculiar Ventures, LLC
*/function bl(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Ua(r,e,t=-1){const n=t;let s=r,i=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(r<o){let c;if(n<0)c=new ArrayBuffer(a),i=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}const l=new Uint8Array(c);for(let u=a-1;u>=0;u--){const h=Math.pow(2,u*e);l[i-u-1]=Math.floor(s/h),s-=l[i-u-1]*h}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function cy(...r){let e=0,t=0;for(const i of r)e+=i.length;const n=new ArrayBuffer(e),s=new Uint8Array(n);for(const i of r)s.set(i,t),t+=i.length;return s}function hA(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;const n=bl(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=r[a];return i[0]&=127,bl(i,8)-n}function Hz(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,a=Ua(o,8,n),c=new Uint8Array(a);return c[0]|=128,a}let s=Ua(e,8,n),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=a[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function zz(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function un(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,s=new Array(n);for(let o=0;o<n;o++)s[o]="0";return s.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function Q1(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function V6(r){let e=0,t=0;for(let s=0;s<r.length;s++){const i=r[s];e+=i.byteLength}const n=new Uint8Array(e);for(let s=0;s<r.length;s++){const i=r[s];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function Ri(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class O0{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return V6(this.items)}}const Iu=[new Uint8Array([1])],u7="0123456789",Mg="name",h7="valueHexView",Wz="isHexOnly",jz="idBlock",Gz="tagClass",Yz="tagNumber",Qz="isConstructed",Xz="fromBER",Zz="toBER",Jz="local",zr="",fs=new ArrayBuffer(0),M0=new Uint8Array(0),Mh="EndOfContent",dA="OCTET STRING",fA="BIT STRING";function Vs(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);const i=n[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?oe.toUint8Array(i.valueHex):M0}fromBER(n,s,i){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!Ri(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",fs)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:ye.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class fc{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=zr,warnings:n=[],valueBeforeDecode:s=M0}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=oe.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:ye.ToHex(this.valueBeforeDecodeView)}}}fc.NAME="baseBlock";class Lr extends fc{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Lr.NAME="valueBlock";class pA extends Vs(fc){constructor({idBlock:e={}}={}){var t,n,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?oe.toUint8Array(e.valueHex):M0,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",fs}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=Ua(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=i[c]|128;a[o]=i[o-1]}return a.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)n[i+1]=s[i]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){const s=oe.toUint8Array(e);if(!Ri(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;const d=new Uint8Array(u);for(let g=0;g<l.length;g++)d[g]=l[g];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=i[c]&127;const h=new Uint8Array(c);for(let d=0;d<c;d++)h[d]=l[d];l=this.valueHexView=new Uint8Array(c),l.set(h),this.blockLength<=9?this.tagNumber=bl(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}pA.NAME="identificationBlock";class gA extends fc{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){const s=oe.toUint8Array(e);if(!Ri(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=s.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=bl(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const s=Ua(this.length,8);if(s.byteLength>127)return this.error="Too big length",fs;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)n[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}gA.NAME="lengthBlock";const de={};class ur extends fc{constructor({name:e=zr,optional:t=!1,primitiveSchema:n,...s}={},i){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new pA(s),this.lenBlock=new gA(s),this.valueBlock=i?new i(s):new Lr(s)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const n=t||new O0;t||mA(this);const s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(i)}return t?fs:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():ye.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=ye.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return zz(t,n)}}ur.NAME="BaseBlock";function mA(r){var e;if(r instanceof de.Constructed)for(const t of r.valueBlock.value)mA(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class K6 extends ur{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=zr,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}K6.NAME="BaseStringBlock";class yA extends Vs(Lr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}yA.NAME="PrimitiveValueBlock";var wA;class wd extends ur{constructor(e={}){super(e,yA),this.idBlock.isConstructed=!1}}wA=wd;de.Primitive=wA;wd.NAME="PRIMITIVE";function eW(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function nu(r,e=0,t=r.length){const n=e;let s=new ur({},Lr);const i=new fc;if(!Ri(i,r,e,t))return s.error=i.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=a,t-=s.idBlock.blockLength,a=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=a,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=ur;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=de.EndOfContent;break;case 1:c=de.Boolean;break;case 2:c=de.Integer;break;case 3:c=de.BitString;break;case 4:c=de.OctetString;break;case 5:c=de.Null;break;case 6:c=de.ObjectIdentifier;break;case 10:c=de.Enumerated;break;case 12:c=de.Utf8String;break;case 13:c=de.RelativeObjectIdentifier;break;case 14:c=de.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=de.Sequence;break;case 17:c=de.Set;break;case 18:c=de.NumericString;break;case 19:c=de.PrintableString;break;case 20:c=de.TeletexString;break;case 21:c=de.VideotexString;break;case 22:c=de.IA5String;break;case 23:c=de.UTCTime;break;case 24:c=de.GeneralizedTime;break;case 25:c=de.GraphicString;break;case 26:c=de.VisibleString;break;case 27:c=de.GeneralString;break;case 28:c=de.UniversalString;break;case 29:c=de.CharacterString;break;case 30:c=de.BmpString;break;case 31:c=de.DATE;break;case 32:c=de.TimeOfDay;break;case 33:c=de.DateTime;break;case 34:c=de.Duration;break;default:{const l=s.idBlock.isConstructed?new de.Constructed:new de.Primitive;l.idBlock=s.idBlock,l.lenBlock=s.lenBlock,l.warnings=s.warnings,s=l}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?de.Constructed:de.Primitive}return s=eW(s,c),a=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:a,result:s}}function mi(r){if(!r.byteLength){const e=new ur({},Lr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return nu(oe.toUint8Array(r).slice(),0,r.byteLength)}function tW(r,e){return r?1:e}class uo extends Lr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const s=oe.toUint8Array(e);if(!Ri(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;tW(this.isIndefiniteForm,n)>0;){const o=nu(s,i,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Mh)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Mh?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new O0;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?fs:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}uo.NAME="ConstructedValueBlock";var bA;class Dr extends ur{constructor(e={}){super(e,uo),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}bA=Dr;de.Constructed=bA;Dr.NAME="CONSTRUCTED";class vA extends Lr{fromBER(e,t,n){return t}toBER(e){return fs}}vA.override="EndOfContentValueBlock";var EA;class q6 extends ur{constructor(e={}){super(e,vA),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}EA=q6;de.EndOfContent=EA;q6.NAME=Mh;var SA;class _i extends ur{constructor(e={}){super(e,Lr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}SA=_i;de.Null=SA;_i.NAME="NULL";class _A extends Vs(Lr){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=oe.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const s=oe.toUint8Array(e);return Ri(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,hA.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}_A.NAME="BooleanValueBlock";var xA;let L0=class extends ur{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,_A),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};xA=L0;de.Boolean=xA;L0.NAME="BOOLEAN";class AA extends Vs(uo){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=uo.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===Mh){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==dA)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?uo.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}AA.NAME="OctetStringValueBlock";var H6;let ns=class extends ur{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},AA),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){const o=nu(i,0,i.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Dr.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=ye.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof H6&&e.push(t.valueBlock.valueHexView);return oe.concat(e)}};H6=ns;de.OctetString=H6;ns.NAME=dA;class IA extends Vs(uo){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=uo.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(const a of this.value){const c=a.constructor.NAME;if(c===Mh){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==fA)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return s}const i=oe.toUint8Array(e);if(!Ri(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=nu(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return uo.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return fs;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}IA.NAME="BitStringValueBlock";var TA;let Ta=class extends ur{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},IA),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Dr.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),s=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}};TA=Ta;de.BitString=TA;Ta.NAME=fA;var kA;function rW(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e);let i=n.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let l=0;const u=c<o?o:c;let h=0;for(let d=u;d>=0;d--,h++){switch(!0){case h<a.length:l=i[o-h]+a[c-h]+t[0];break;default:l=i[o-h]+t[0]}switch(t[0]=l/10,!0){case h>=i.length:i=cy(new Uint8Array([l%10]),i);break;default:i[o-h]=l%10}}return t[0]>0&&(i=cy(t,i)),i}function d7(r){if(r>=Iu.length)for(let e=Iu.length;e<=r;e++){const t=new Uint8Array([0]);let n=Iu[e-1].slice(0);for(let s=n.length-1;s>=0;s--){const i=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=i[0]/10,n[s]=i[0]%10}t[0]>0&&(n=cy(t,n)),Iu.push(n)}return Iu[r]}function nW(r,e){let t=0;const n=new Uint8Array(r),s=new Uint8Array(e),i=n.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let l,u=0;for(let h=c;h>=0;h--,u++)switch(l=i[o-u]-a[c-u]-t,!0){case l<0:t=1,i[o-u]=l+10;break;default:t=0,i[o-u]=l}if(t>0)for(let h=o-c+1;h>=0;h--,u++)if(l=i[o-u]-t,l<0)t=1,i[o-u]=l+10;else{t=0,i[o-u]=l;break}return i.slice()}class z6 extends Vs(Lr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=hA.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(Hz(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){const i=this.fromBER(e,t,n);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,s;const i=this.valueHexView;let o="",a=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let l=0;l<8;l++){if((s&1)===1)switch(n){case e:t=nW(d7(n),t),o="-";break;default:t=rW(t,d7(n))}n++,s>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=u7.charAt(t[c]));return a===!1&&(o+=u7.charAt(0)),o}}kA=z6;z6.NAME="IntegerValueBlock";Object.defineProperty(kA.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var eh;class yi extends ur{constructor(e={}){super(e,z6),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Q1(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Q1();const t=BigInt(e),n=new O0,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(ye.FromHex(s));if(t<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${ye.ToHex(a)}`)+t,u=oe.toUint8Array(ye.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new eh({valueHex:n.final()})}convertToDER(){const e=new eh({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new eh({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}eh=yi;de.Integer=eh;yi.NAME="INTEGER";var CA;class B0 extends yi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}CA=B0;de.Enumerated=CA;B0.NAME="ENUMERATED";class ly extends Vs(Lr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const s=oe.toUint8Array(e);if(!Ri(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=bl(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Q1();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Ua(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",fs;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n}toString(){let e="";if(this.isHexOnly)e=ye.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}ly.NAME="sidBlock";class PA extends Lr{constructor({value:e=zr,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new ly;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,fs;t.push(s)}return V6(t)}fromString(e){this.value=[];let t=0,n=0,s="",i=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+a,i=!1}else{const o=new ly;if(s>Number.MAX_SAFE_INTEGER){Q1();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}PA.NAME="ObjectIdentifierValueBlock";var DA;class ai extends ur{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,PA),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}DA=ai;de.ObjectIdentifier=DA;ai.NAME="OBJECT IDENTIFIER";class uy extends Vs(fc){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const s=oe.toUint8Array(e);if(!Ri(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=bl(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Ua(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",fs;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=ye.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}uy.NAME="relativeSidBlock";class RA extends Lr{constructor({value:e=zr,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new uy;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const n=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,fs;n.push(i)}return V6(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;const i=new uy;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}RA.NAME="RelativeObjectIdentifierValueBlock";var NA;class W6 extends ur{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,RA),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}NA=W6;de.RelativeObjectIdentifier=NA;W6.NAME="RelativeObjectIdentifier";var OA;class Bt extends Dr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}OA=Bt;de.Sequence=OA;Bt.NAME="SEQUENCE";var MA;let Os=class extends Dr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};MA=Os;de.Set=MA;Os.NAME="SET";class LA extends Vs(Lr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=zr}toJSON(){return{...super.toJSON(),value:this.value}}}LA.NAME="StringValueBlock";class BA extends LA{}BA.NAME="SimpleStringValueBlock";class Sn extends K6{constructor({...e}={}){super(e,BA)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,oe.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}}Sn.NAME="SIMPLE STRING";class $A extends Sn{fromBuffer(e){this.valueBlock.valueHexView=oe.toUint8Array(e);try{this.valueBlock.value=ye.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=ye.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(ye.FromUtf8String(e)),this.valueBlock.value=e}}$A.NAME="Utf8StringValueBlock";var UA;class Ni extends $A{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}UA=Ni;de.Utf8String=UA;Ni.NAME="UTF8String";class FA extends Sn{fromBuffer(e){this.valueBlock.value=ye.ToUtf16String(e),this.valueBlock.valueHexView=oe.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(ye.FromUtf16String(e))}}FA.NAME="BmpStringValueBlock";var VA;class $0 extends FA{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}VA=$0;de.BmpString=VA;$0.NAME="BMPString";class KA extends Sn{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=Ua(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)n[s*4+c+a]=o[c]}this.valueBlock.value=e}}KA.NAME="UniversalStringValueBlock";var qA;class U0 extends KA{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}qA=U0;de.UniversalString=qA;U0.NAME="UniversalString";var HA;class F0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}HA=F0;de.NumericString=HA;F0.NAME="NumericString";var zA;class V0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}zA=V0;de.PrintableString=zA;V0.NAME="PrintableString";var WA;class K0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}WA=K0;de.TeletexString=WA;K0.NAME="TeletexString";var jA;class q0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}jA=q0;de.VideotexString=jA;q0.NAME="VideotexString";var GA;class H0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}GA=H0;de.IA5String=GA;H0.NAME="IA5String";var YA;class z0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}YA=z0;de.GraphicString=YA;z0.NAME="GraphicString";var QA;class bd extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}QA=bd;de.VisibleString=QA;bd.NAME="VisibleString";var XA;class W0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}XA=W0;de.GeneralString=XA;W0.NAME="GeneralString";var ZA;class j0 extends Sn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}ZA=j0;de.CharacterString=ZA;j0.NAME="CharacterString";var JA;class vd extends bd{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,oe.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=un(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=un(this.month,2),t[2]=un(this.day,2),t[3]=un(this.hour,2),t[4]=un(this.minute,2),t[5]=un(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}JA=vd;de.UTCTime=JA;vd.NAME="UTCTime";var eI;class G0 extends vd{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",i=0,o,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,d=n.indexOf("+"),g="";if(d===-1&&(d=n.indexOf("-"),h=-1),d!==-1){if(g=n.substring(d+1),n=n.substring(0,d),g.length!==2&&g.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(g.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*m,g.length===4){if(m=parseInt(g.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=h*m}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){const h=new Number(`0${n.substring(l)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");i=h.valueOf(),s=n.substring(0,l)}else s=n;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*i;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*i;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const h=1e3*i;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(s);if(u===null)throw new Error("Wrong input string for conversion");for(let h=1;h<u.length;h++)switch(h){case 1:this.year=parseInt(u[h],10);break;case 2:this.month=parseInt(u[h],10);break;case 3:this.day=parseInt(u[h],10);break;case 4:this.hour=parseInt(u[h],10)+a;break;case 5:this.minute=parseInt(u[h],10)+c;break;case 6:this.second=parseInt(u[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(un(this.year,4)),t.push(un(this.month,2)),t.push(un(this.day,2)),t.push(un(this.hour,2)),t.push(un(this.minute,2)),t.push(un(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(un(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}eI=G0;de.GeneralizedTime=eI;G0.NAME="GeneralizedTime";var tI;class j6 extends Ni{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}tI=j6;de.DATE=tI;j6.NAME="DATE";var rI;class G6 extends Ni{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}rI=G6;de.TimeOfDay=rI;G6.NAME="TimeOfDay";var nI;class Y6 extends Ni{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}nI=Y6;de.DateTime=nI;Y6.NAME="DateTime";var sI;class Q6 extends Ni{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}sI=Q6;de.Duration=sI;Q6.NAME="Duration";var iI;class X6 extends Ni{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}iI=X6;de.TIME=iI;X6.NAME="TIME";class Fa{constructor({name:e=zr,optional:t=!1}={}){this.name=e,this.optional=t}}class Z6 extends Fa{constructor({value:e=[],...t}={}){super(t),this.value=e}}class X1 extends Fa{constructor({value:e=new Fa,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}}class sW{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=oe.toUint8Array(e)}constructor({data:e=M0}={}){this.dataView=oe.toUint8Array(e)}fromBER(e,t,n){const s=t+n;return this.dataView=oe.toUint8Array(e).subarray(t,s),s}toBER(e){return this.dataView.slice().buffer}}function no(r,e,t){if(t instanceof Z6){for(const i of t.value)if(no(r,e,i).verified)return{verified:!0,result:r};{const i={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(Mg)&&(i.name=t.name),i}}if(t instanceof Fa)return t.hasOwnProperty(Mg)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(jz in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(Xz in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(Zz in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(Gz)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(Yz)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(Qz)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(Wz in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(h7 in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const i=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(i.length!==o.length)return{verified:!1,result:r};for(let a=0;a<i.length;a++)if(i[a]!==o[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&(r[t.name]=e)),t instanceof de.Constructed){let i=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof X1&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-i>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof X1){if(o=no(r,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&delete r[t.name]),o;if(Mg in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};Jz in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=no(r,e.valueBlock.value[c-i],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&delete r[t.name]),o;if(o.verified===!1){const c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&h7 in e.valueBlock){const i=nu(e.valueBlock.valueHexView);if(i.offset===-1){const o={verified:!1,result:i.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,zr),t.name&&(delete r[t.name],o.name=t.name)),o}return no(r,i.result,t.primitiveSchema)}return{verified:!0,result:r}}function iW(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=nu(oe.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:no(t.result,t.result,e)}const oI=Object.freeze(Object.defineProperty({__proto__:null,Any:Fa,BaseBlock:ur,BaseStringBlock:K6,BitString:Ta,BmpString:$0,Boolean:L0,CharacterString:j0,Choice:Z6,Constructed:Dr,DATE:j6,DateTime:Y6,Duration:Q6,EndOfContent:q6,Enumerated:B0,GeneralString:W0,GeneralizedTime:G0,GraphicString:z0,HexBlock:Vs,IA5String:H0,Integer:yi,Null:_i,NumericString:F0,ObjectIdentifier:ai,OctetString:ns,Primitive:wd,PrintableString:V0,RawData:sW,RelativeObjectIdentifier:W6,Repeated:X1,Sequence:Bt,Set:Os,TIME:X6,TeletexString:K0,TimeOfDay:G6,UTCTime:vd,UniversalString:U0,Utf8String:Ni,ValueBlock:Lr,VideotexString:q0,ViewWriter:O0,VisibleString:bd,compareSchema:no,fromBER:mi,verifySchema:iW},Symbol.toStringTag,{value:"Module"})),oW=16,hy=32,dy=1e4;async function Y0(r,e){const n=await cA().encrypt(r,e);return $n.encode(n)}async function f7(r,e,t){if(r.type==="RSA")return uW(r,e,t);if(r.type==="Ed25519")return aW(r,e,t);if(r.type==="secp256k1")return cW(r,e,t);if(r.type==="ECDSA")return lW(r,e,t);throw new zl}async function aW(r,e,t="libp2p-key"){if(t==="libp2p-key")return Y0(od(r),e);throw new te(`export format '${t}' is not supported`)}async function cW(r,e,t="libp2p-key"){if(t==="libp2p-key")return Y0(od(r),e);throw new te("Export format is not supported")}async function lW(r,e,t="libp2p-key"){if(t==="libp2p-key")return Y0(od(r),e);throw new te(`export format '${t}' is not supported`)}async function uW(r,e,t="pkcs-8"){if(t==="pkcs-8")return hW(r,e);if(t==="libp2p-key")return Y0(od(r),e);throw new te("Export format is not supported")}async function hW(r,e){const t=Nr.get(),s=new Bt({value:[new yi({value:0}),new Bt({value:[new ai({value:"1.2.840.113549.1.1.1"}),new _i]}),new ns({valueHex:r.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=vo(oW),a=await n_(c6,e,o,{c:dy,dkLen:hy}),c=vo(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,i),h=new Bt({value:[new ns({valueHex:o}),new yi({value:dy}),new yi({value:hy}),new Bt({value:[new ai({value:"1.2.840.113549.2.11"}),new _i]})]}),d=new Bt({value:[new ai({value:"1.2.840.113549.1.5.13"}),new Bt({value:[new Bt({value:[new ai({value:"1.2.840.113549.1.5.12"}),h]}),new Bt({value:[new ai({value:"2.16.840.1.101.3.4.1.42"}),new ns({valueHex:c})]})]})]}),m=new Bt({value:[d,new ns({valueHex:u})]}).toBER(),b=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...re(b,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function p7(r,e){try{const t=await dW(r,e);return _S(t)}catch{}if(!r.includes("BEGIN"))throw new te("Encrypted key was not a libp2p-key or a PEM file");return fW(r,e)}async function dW(r,e){const t=$n.decode(r);return cA().decrypt(t,e)}async function fW(r,e){const t=Nr.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=ne(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=mi(i),{iv:a,salt:c,iterations:l,keySize:u,cipherText:h}=pW(o),d=await n_(c6,e,c,{c:l,dkLen:u}),g=await t.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),m=th(await t.subtle.decrypt({name:"AES-CBC",iv:a},g,h)),{result:b}=mi(m);n=g7(b)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const i=ne(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=mi(i);n=g7(o)}else throw new te("Could not parse private key from PEM data");const s=Vm(n);if(s.type!=="RSA")throw new te("Could not parse RSA private key from PEM data");return s}function pW(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new te("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new te("Only pkcs5PBKDF2 key derivation functions are supported");const i=n.valueBlock.value[1],o=th(i.valueBlock.value[0].getValue());let a=dy,c=hy;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new te("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new te("Only AES-CBC encryption schemes are supported")}}}}const h=th(l.valueBlock.value[1].getValue());return{cipherText:th(r.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:h}}function g7(r){return th(r.valueBlock.value[2].getValue())}function th(r){return new Uint8Array(r,0,r.byteLength)}const gW="/pkcs8/",fy="/info/",Tu=new WeakMap,qo={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Lg={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Ac(r){return r==null||typeof r!="string"?!1:r===dz(r.trim())&&r.length>0}async function rr(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Ho(r){return new ft(gW+r)}function Ic(r){return new ft(fy+r)}async function mW(r){const e=od(r),t=await Qr.digest(e);return $t.encode(t.bytes).substring(1)}class yW{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=n6(Lg,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<qo.minKeyLength)throw new Error(`dek.keyLength must be least ${qo.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<qo.minSaltLength)throw new Error(`dek.saltLength must be least ${qo.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<qo.minIterationCount)throw new Error(`dek.iterationCount must be least ${qo.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?aw(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Tu.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[Jt]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},Lg),t=Math.ceil(qo.minSaltLength/3)*3;return e.dek.salt=re(vo(t),"base64"),e}static get options(){return Lg}async findKeyByName(e){if(!Ac(e))throw await rr(),new te(`Invalid key name '${e}'`);const t=Ic(e);try{const n=await this.components.datastore.get(t);return JSON.parse(re(n))}catch(n){throw await rr(),this.log.error(n),new Ut(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:fy};for await(const n of this.components.datastore.query(t)){const s=JSON.parse(re(n.value));if(s.id===e)return s}throw new te(`Key with id '${e}' does not exist.`)}catch(t){throw await rr(),t}}async importKey(e,t){if(!Ac(e))throw await rr(),new te(`Invalid key name '${e}'`);if(t==null)throw await rr(),new te("Key is required");const n=Ho(e);if(await this.components.datastore.has(n))throw await rr(),new te(`Key '${e}' already exists`);let i,o;try{i=await mW(t);const l=Tu.get(this);if(l==null)throw new te("dek missing");const u=l.dek;o=await f7(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await rr(),l}const a={name:e,id:i},c=this.components.datastore.batch();return c.put(n,ne(o)),c.put(Ic(e),ne(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!Ac(e))throw await rr(),new te(`Invalid key name '${e}'`);const t=Ho(e);try{const n=await this.components.datastore.get(t),s=re(n),i=Tu.get(this);if(i==null)throw new te("dek missing");const o=i.dek;return await p7(s,o)}catch(n){throw await rr(),n}}async removeKey(e){if(!Ac(e)||e===this.self)throw await rr(),new te(`Invalid key name '${e}'`);const t=Ho(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Ic(e)),await s.commit(),n}async listKeys(){const e={prefix:fy},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(re(n.value)));return t}async renameKey(e,t){if(!Ac(e)||e===this.self)throw await rr(),new te(`Invalid old key name '${e}'`);if(!Ac(t)||t===this.self)throw await rr(),new te(`Invalid new key name '${t}'`);const n=Ho(e),s=Ho(t),i=Ic(e),o=Ic(t);if(await this.components.datastore.has(s))throw await rr(),new te(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),l=await this.components.datastore.get(i),u=JSON.parse(re(l));u.name=t;const h=this.components.datastore.batch();return h.put(s,c),h.put(o,ne(JSON.stringify(u))),h.delete(n),h.delete(i),await h.commit(),u}catch(c){throw await rr(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await rr(),new te(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await rr(),new te(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await rr(),new te(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=Tu.get(this);if(n==null)throw new te("dek missing");const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?aw(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Tu.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(Ho(a.name)),l=re(c),u=await p7(l,s),h=i.toString(),d=await f7(u,h,u.type==="RSA"?"pkcs-8":"libp2p-key"),g=this.components.datastore.batch(),m={name:a.name,id:a.id};g.put(Ho(a.name),ne(d)),g.put(Ic(a.name),ne(JSON.stringify(m))),await g.commit()}this.log("keychain reconstructed")}}function aI(r={}){return e=>new yW(e,r)}async function wW(r,e={}){const t=e.selfKey??"self",n=aI(e)({datastore:r,logger:g0()});let s;return await r.has(new ft(`/pkcs8/${t}`))?s=await n.exportKey(t):(s=await h0(e.keyType??"Ed25519"),await n.importKey(t,s)),s}const bW=8,vW=1024*1024*4;let EW=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},SW=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},_W=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},m7=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function xW(r){return r[Symbol.asyncIterator]!=null}var ta;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ta||(ta={}));const J6=r=>{const e=Di(r);return J6.bytes=tt(e),e};J6.bytes=0;function py(r,e){const t=new Pe;let n=ta.LENGTH,s=-1;const i=e?.lengthDecoder??J6,o=e?.maxLengthLength??bW,a=e?.maxDataLength??vW;function*c(){for(;t.byteLength>0;){if(n===ta.LENGTH)try{if(s=i(t),s<0)throw new EW("Invalid message length");if(s>a)throw new SW("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=ta.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new _W("Message length length too long");break}throw l}if(n===ta.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=ta.LENGTH}}}return xW(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new m7("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new m7("Unexpected end of input")}()}py.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return py(n,{...e??{},onLength:i=>{t=i}})};function y7(){const r=Fe();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function AW(){const r=y7(),e=y7();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const Lh=65535,w7=Lh-16,Ed=!!globalThis.process?.env?.DUMP_SESSION_KEYS;/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function cI(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function gy(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function Bg(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Wr(r,...e){if(!cI(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function b7(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function IW(r,e){Wr(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ho(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function vl(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function TW(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}const kW=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function CW(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function my(r){if(typeof r=="string")r=CW(r);else if(cI(r))r=yy(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function PW(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function DW(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const RW=(r,e)=>{function t(n,...s){if(Wr(n),!kW)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){const u=s[0];if(!u)throw new Error("nonce / iv required");r.varSizeNonce?Wr(u):Wr(u,r.nonceLength)}const i=r.tagLength;i&&s[1]!==void 0&&Wr(s[1]);const o=e(n,...s),a=(u,h)=>{if(h!==void 0){if(u!==2)throw new Error("cipher output not supported");Wr(h)}};let c=!1;return{encrypt(u,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Wr(u),a(o.encrypt.length,h),o.encrypt(u,h)},decrypt(u,h){if(Wr(u),i&&u.length<i)throw new Error("invalid ciphertext length: smaller than tagLength="+i);return a(o.decrypt.length,h),o.decrypt(u,h)}}}return Object.assign(t,r),t};function v7(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!OW(e))throw new Error("invalid output, must be aligned");return e}function E7(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=4,l=0;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function NW(r,e,t){gy(t);const n=new Uint8Array(16),s=TW(n);return E7(s,0,BigInt(e),t),E7(s,8,BigInt(r),t),n}function OW(r){return r.byteOffset%4===0}function yy(r){return Uint8Array.from(r)}const lI=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),MW=lI("expand 16-byte k"),LW=lI("expand 32-byte k"),BW=ho(MW),$W=ho(LW);function We(r,e){return r<<e|r>>>32-e}function wy(r){return r.byteOffset%4===0}const gf=64,UW=16,uI=2**32-1,S7=new Uint32Array;function FW(r,e,t,n,s,i,o,a){const c=s.length,l=new Uint8Array(gf),u=ho(l),h=wy(s)&&wy(i),d=h?ho(s):S7,g=h?ho(i):S7;for(let m=0;m<c;o++){if(r(e,t,n,u,o,a),o>=uI)throw new Error("arx: counter overflow");const b=Math.min(gf,c-m);if(h&&b===gf){const y=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let _=0,A;_<UW;_++)A=y+_,g[A]=d[A]^u[_];m+=gf;continue}for(let y=0,_;y<b;y++)_=m+y,i[_]=s[_]^l[y];m+=b}}function VW(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:i,rounds:o}=PW({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return Bg(s),Bg(o),gy(i),gy(t),(a,c,l,u,h=0)=>{Wr(a),Wr(c),Wr(l);const d=l.length;if(u===void 0&&(u=new Uint8Array(d)),Wr(u),Bg(h),h<0||h>=uI)throw new Error("arx: counter overflow");if(u.length<d)throw new Error(`arx: output (${u.length}) is shorter than data (${d})`);const g=[];let m=a.length,b,y;if(m===32)g.push(b=yy(a)),y=$W;else if(m===16&&t)b=new Uint8Array(32),b.set(a),b.set(a,16),y=BW,g.push(b);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);wy(c)||g.push(c=yy(c));const _=ho(b);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(y,_,ho(c.subarray(0,16)),_),c=c.subarray(16)}const A=16-s;if(A!==c.length)throw new Error(`arx: nonce must be ${A} or 16 bytes`);if(A!==12){const I=new Uint8Array(12);I.set(c,i?0:12-c.length),c=I,g.push(c)}const R=ho(c);return FW(r,y,_,R,l,u,h,o),vl(...g),u}}const nr=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class KW{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=my(e),Wr(e,32);const t=nr(e,0),n=nr(e,2),s=nr(e,4),i=nr(e,6),o=nr(e,8),a=nr(e,10),c=nr(e,12),l=nr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=nr(e,16+2*u)}process(e,t,n=!1){const s=n?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],h=o[4],d=o[5],g=o[6],m=o[7],b=o[8],y=o[9],_=nr(e,t+0),A=nr(e,t+2),R=nr(e,t+4),I=nr(e,t+6),T=nr(e,t+8),k=nr(e,t+10),D=nr(e,t+12),F=nr(e,t+14);let O=i[0]+(_&8191),C=i[1]+((_>>>13|A<<3)&8191),N=i[2]+((A>>>10|R<<6)&8191),P=i[3]+((R>>>7|I<<9)&8191),M=i[4]+((I>>>4|T<<12)&8191),K=i[5]+(T>>>1&8191),H=i[6]+((T>>>14|k<<2)&8191),$=i[7]+((k>>>11|D<<5)&8191),B=i[8]+((D>>>8|F<<8)&8191),z=i[9]+(F>>>5|s),q=0,Y=q+O*a+C*(5*y)+N*(5*b)+P*(5*m)+M*(5*g);q=Y>>>13,Y&=8191,Y+=K*(5*d)+H*(5*h)+$*(5*u)+B*(5*l)+z*(5*c),q+=Y>>>13,Y&=8191;let Q=q+O*c+C*a+N*(5*y)+P*(5*b)+M*(5*m);q=Q>>>13,Q&=8191,Q+=K*(5*g)+H*(5*d)+$*(5*h)+B*(5*u)+z*(5*l),q+=Q>>>13,Q&=8191;let j=q+O*l+C*c+N*a+P*(5*y)+M*(5*b);q=j>>>13,j&=8191,j+=K*(5*m)+H*(5*g)+$*(5*d)+B*(5*h)+z*(5*u),q+=j>>>13,j&=8191;let we=q+O*u+C*l+N*c+P*a+M*(5*y);q=we>>>13,we&=8191,we+=K*(5*b)+H*(5*m)+$*(5*g)+B*(5*d)+z*(5*h),q+=we>>>13,we&=8191;let ue=q+O*h+C*u+N*l+P*c+M*a;q=ue>>>13,ue&=8191,ue+=K*(5*y)+H*(5*b)+$*(5*m)+B*(5*g)+z*(5*d),q+=ue>>>13,ue&=8191;let fe=q+O*d+C*h+N*u+P*l+M*c;q=fe>>>13,fe&=8191,fe+=K*a+H*(5*y)+$*(5*b)+B*(5*m)+z*(5*g),q+=fe>>>13,fe&=8191;let ce=q+O*g+C*d+N*h+P*u+M*l;q=ce>>>13,ce&=8191,ce+=K*c+H*a+$*(5*y)+B*(5*b)+z*(5*m),q+=ce>>>13,ce&=8191;let ke=q+O*m+C*g+N*d+P*h+M*u;q=ke>>>13,ke&=8191,ke+=K*l+H*c+$*a+B*(5*y)+z*(5*b),q+=ke>>>13,ke&=8191;let Oe=q+O*b+C*m+N*g+P*d+M*h;q=Oe>>>13,Oe&=8191,Oe+=K*u+H*l+$*c+B*a+z*(5*y),q+=Oe>>>13,Oe&=8191;let ot=q+O*y+C*b+N*m+P*g+M*d;q=ot>>>13,ot&=8191,ot+=K*h+H*u+$*l+B*c+z*a,q+=ot>>>13,ot&=8191,q=(q<<2)+q|0,q=q+Y|0,Y=q&8191,q=q>>>13,Q+=q,i[0]=Y,i[1]=Q,i[2]=j,i[3]=we,i[4]=ue,i[5]=fe,i[6]=ce,i[7]=ke,i[8]=Oe,i[9]=ot}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;vl(n)}update(e){b7(this),e=my(e),Wr(e);const{buffer:t,blockLen:n}=this,s=e.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);if(o===n){for(;n<=s-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){vl(this.h,this.r,this.buffer,this.pad)}digestInto(e){b7(this),IW(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)e[i++]=n[o]>>>0,e[i++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function qW(r){const e=(n,s)=>r(s).update(my(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const HW=qW(r=>new KW(r));function zW(r,e,t,n,s,i=20){let o=r[0],a=r[1],c=r[2],l=r[3],u=e[0],h=e[1],d=e[2],g=e[3],m=e[4],b=e[5],y=e[6],_=e[7],A=s,R=t[0],I=t[1],T=t[2],k=o,D=a,F=c,O=l,C=u,N=h,P=d,M=g,K=m,H=b,$=y,B=_,z=A,q=R,Y=I,Q=T;for(let we=0;we<i;we+=2)k=k+C|0,z=We(z^k,16),K=K+z|0,C=We(C^K,12),k=k+C|0,z=We(z^k,8),K=K+z|0,C=We(C^K,7),D=D+N|0,q=We(q^D,16),H=H+q|0,N=We(N^H,12),D=D+N|0,q=We(q^D,8),H=H+q|0,N=We(N^H,7),F=F+P|0,Y=We(Y^F,16),$=$+Y|0,P=We(P^$,12),F=F+P|0,Y=We(Y^F,8),$=$+Y|0,P=We(P^$,7),O=O+M|0,Q=We(Q^O,16),B=B+Q|0,M=We(M^B,12),O=O+M|0,Q=We(Q^O,8),B=B+Q|0,M=We(M^B,7),k=k+N|0,Q=We(Q^k,16),$=$+Q|0,N=We(N^$,12),k=k+N|0,Q=We(Q^k,8),$=$+Q|0,N=We(N^$,7),D=D+P|0,z=We(z^D,16),B=B+z|0,P=We(P^B,12),D=D+P|0,z=We(z^D,8),B=B+z|0,P=We(P^B,7),F=F+M|0,q=We(q^F,16),K=K+q|0,M=We(M^K,12),F=F+M|0,q=We(q^F,8),K=K+q|0,M=We(M^K,7),O=O+C|0,Y=We(Y^O,16),H=H+Y|0,C=We(C^H,12),O=O+C|0,Y=We(Y^O,8),H=H+Y|0,C=We(C^H,7);let j=0;n[j++]=o+k|0,n[j++]=a+D|0,n[j++]=c+F|0,n[j++]=l+O|0,n[j++]=u+C|0,n[j++]=h+N|0,n[j++]=d+P|0,n[j++]=g+M|0,n[j++]=m+K|0,n[j++]=b+H|0,n[j++]=y+$|0,n[j++]=_+B|0,n[j++]=A+z|0,n[j++]=R+q|0,n[j++]=I+Y|0,n[j++]=T+Q|0}const WW=VW(zW,{counterRight:!1,counterLength:4,allowShortKeys:!1}),jW=new Uint8Array(16),_7=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(jW.subarray(t))},GW=new Uint8Array(32);function x7(r,e,t,n,s){const i=r(e,t,GW),o=HW.create(i);s&&_7(o,s),_7(o,n);const a=NW(n.length,s?s.length:0,!0);o.update(a);const c=o.digest();return vl(i,a),c}const YW=r=>(e,t,n)=>({encrypt(i,o){const a=i.length;o=v7(a+16,o,!1),o.set(i);const c=o.subarray(0,-16);r(e,t,c,c,1);const l=x7(r,e,t,c,n);return o.set(l,a),vl(l),o},decrypt(i,o){o=v7(i.length-16,o,!1);const a=i.subarray(0,-16),c=i.subarray(-16),l=x7(r,e,t,a,n);if(!DW(c,l))throw new Error("invalid tag");return o.set(i.subarray(0,-16)),r(e,t,o,o,1),vl(l),o}}),A7=RW({blockSize:64,nonceLength:12,tagLength:16},YW(WW));function QW(r,e,t){return td(r),t===void 0&&(t=new Uint8Array(r.outputLen)),id(r,wh(t),wh(e))}const $g=Uint8Array.from([0]),I7=Uint8Array.of();function XW(r,e,t,n=32){td(r),Sa(n);const s=r.outputLen;if(n>255*s)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(n/s);t===void 0&&(t=I7);const o=new Uint8Array(i*s),a=id.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<i;u++)$g[0]=u+1,c.update(u===0?I7:l).update(t).update($g).digestInto(l),o.set(l,s*u),a._cloneInto(c);return a.destroy(),c.destroy(),$s(l,$g),o.slice(0,n)}const ZW={hashSHA256(r){return Aa(r.subarray())},getHKDF(r,e){const t=QW(Aa,e,r),s=XW(Aa,t,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const r=Gd.utils.randomPrivateKey();return{publicKey:Gd.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:Gd.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return Gd.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return A7(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,s){return A7(n,e,t).decrypt(r.subarray(),s)}},JW=ZW;function ej(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const Z1=r=>{const e=xr(2);return e[0]=r>>8,e[1]=r,e};Z1.bytes=2;const zf=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};zf.bytes=2;function tj(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function hI(r,e){!e.enabled||!Ed||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${re(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${re(r.privateKey,"hex")}`)):e("Missing local static keys."))}function dI(r,e){!e.enabled||!Ed||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${re(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${re(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function rj(r,e){!e.enabled||!Ed||e(r?`REMOTE_STATIC_PUBLIC_KEY ${re(r.subarray(),"hex")}`:"Missing remote static public key.")}function fI(r,e){!e.enabled||!Ed||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${re(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function pI(r,e,t){!t.enabled||!Ed||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&re(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&re(e.k,"hex")}`))}function El(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=xr(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}function nj(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}class rh extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=rh.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const sj=0,ij=4294967295,oj="Cipherstate has reached maximum n, a new handshake must be performed";class aj{n;bytes;view;constructor(e=sj){this.n=e,this.bytes=Be(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>ij)throw new Error(oj)}}const tl=Be(0);class mf{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new aj(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const s=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),s}}class cj{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=ne(t,"utf-8");this.h=uj(e,n),this.ck=this.h,this.cs=new mf(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new mf(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Pe(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,tl);return[new mf(this.crypto,e),new mf(this.crypto,t)]}}class lj{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:s,initiator:i,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new cj(t,n),this.ss.mixHash(s),this.initiator=i,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const s=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(s),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class gI extends lj{writeMessageA(e){return new Pe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new Pe(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Pe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new rh(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new rh(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new rh(`handshake stage 2 validation fail: ${t.message}`)}}}function uj(r,e){if(e.length<=32){const t=Be(32);return t.set(e),t}else return r.hash(e)}var J1;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(const i of t.streamMuxers)n.uint32(18),n.string(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===s.limits.webtransportCerthashes)throw new nt('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(s.limits?.streamMuxers!=null&&i.streamMuxers.length===s.limits.streamMuxers)throw new nt('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(J1||(J1={}));var ep;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),J1.codec().encode(t.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={identityKey:Be(0),identitySig:Be(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=J1.codec().decode(t,t.uint32(),{limits:s.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(ep||(ep={}));async function mI(r,e,t){const n=await r.sign(wI(e));return ep.encode({identityKey:yn(r.publicKey),identitySig:n,extensions:t})}async function yI(r,e,t){try{const n=ep.decode(r),s=Or(n.identityKey);if(t?.equals(s)===!1)throw new Error(`Payload identity key ${s} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const i=wI(e);if(!await s.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new MP(n.message)}}function wI(r){const e=ne("noise-libp2p-static-key:");return r instanceof Uint8Array?Rr([e,r],e.length+r.length):(r.prepend(e),r)}async function hj(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,u=await mI(i,a.publicKey,l),h=new gI({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});hI(h.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(tl),e),t.trace("Stage 0 - Initiator finished sending first message."),dI(h.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const d=h.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),fI(h.re,t),rj(h.rs,t),t.trace("Initiator going to check remote's signature...");const g=await yI(d,h.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[m,b]=h.ss.split();return pI(m,b,t),{payload:g,encrypt:y=>m.encryptWithAd(tl,y),decrypt:(y,_)=>b.decryptWithAd(tl,y,_)}}async function dj(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,u=await mI(i,a.publicKey,l),h=new gI({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});hI(h.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),fI(h.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),dI(h.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const d=h.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const g=await yI(d,h.rs,c),[m,b]=h.ss.split();return pI(m,b,t),{payload:g,encrypt:y=>b.encryptWithAd(tl,y),decrypt:(y,_)=>m.decryptWithAd(tl,y,_)}}const T7=16;function fj(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=w7){let i=s+w7;i>n.length&&(i=n.length);let o;n instanceof Uint8Array?o=r.encrypt(n.subarray(s,i)):o=r.encrypt(n.sublist(s,i)),e?.encryptedPackets.increment(),yield new Pe(Z1(o.byteLength),o)}}}function pj(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=Lh){let i=s+Lh;if(i>n.length&&(i=n.length),i-T7<s)throw new Error("Invalid chunk");const o=n.sublist(s,i),a=n.subarray(s,i-T7);try{const c=r.decrypt(o,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}class gj{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:n,extensions:s,crypto:i,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=i??JW;this.crypto=ej(c),this.extensions={webtransportCerthashes:[],...s},this.metrics=a?tj(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Be(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[Jt]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const n=ds(e,{lengthEncoder:Z1,lengthDecoder:zf,maxDataLength:Lh}),s=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=Or(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:Na(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const s=t.get(n);if(s!=null)return s}if(e.length)throw new LP("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const n=ds(e,{lengthEncoder:Z1,lengthDecoder:zf,maxDataLength:Lh}),s=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=Or(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:Na(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await hj({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await dj({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){const[n,s]=AW(),i=e.unwrap();return await bn(n,fj(t,this.metrics),i,o=>py(o,{lengthDecoder:zf}),pj(t,this.metrics),n),s}}function e5(r={}){return e=>new gj(e,r)}function bI(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}class Vc extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}class vI extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}class EI extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}class mj extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}class yj extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}class wj extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}class bj extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}}class SI extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}const vj=new Set([Vc.name,vI.name,EI.name,yj.name,wj.name,bj.name,SI.name]),t5=256*1024,Ej=16*1024*1024,Sj={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:t5,maxStreamWindowSize:Ej,maxMessageSize:64*1024};function _j(r){if(r.keepAliveInterval<=0)throw new te("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new te("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new te("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<t5)throw new te("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new te("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new te("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new te("MaxMessageSize must be greater than a kilobyte")}var Kt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Kt||(Kt={}));var Ct;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Ct||(Ct={}));Object.values(Ct).filter(r=>typeof r!="string");const xj=0;var _s;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(_s||(_s={}));const nh=12,k7=2**24;function Aj(r){if(r[0]!==xj)throw new Vc("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*k7+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*k7+(r[9]<<16)+(r[10]<<8)+r[11]}}let Ij=class{source;buffer;frameInProgress;constructor(e){this.source=Tj(e),this.buffer=new Pe,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:n,length:s}=t;n===Kt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new mj("decoding frame already in progress");if(this.buffer.length<nh)return;const e=Aj(this.buffer.subarray(0,nh));return this.buffer.consume(nh),e}async readBytes(e){if(this.buffer.length<e){for await(const n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function Tj(r){if(r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){const e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function C7(r){const e=new Uint8Array(nh);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function kj(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function _I(r,e){const t=bI(r).return?.();kj(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}const Cj=5e3;function Ug(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class r5{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=Fe(),this.closed=Fe(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??Cj,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=Vn({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new Cm(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(t);Ug(s)&&await s}const n=()=>{_I(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Pe(s):s;const i=this.sendData(s,t);Ug(i)&&(this.sendingData=Fe(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await Zt(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Zt(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Zt(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Zt(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();Ug(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new $P("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var rs;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(rs||(rs={}));class Pj extends r5{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=rs.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=t5,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=z1(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-nh,e.length),s=this.getSendFlags();this.sendFrame({type:Kt.Data,flag:s,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:Kt.WindowUpdate,flag:Ct.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Ct.FIN;this.sendFrame({type:Kt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n;const s=()=>{this.status==="open"||this.status==="closing"?n(new wi("Stream aborted")):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,o)=>{this.sendWindowCapacityUpdate=()=>{i()},n=o,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new SI("Receive window exceeded");const n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Ct.ACK)===Ct.ACK&&this.state===rs.SYNSent&&(this.state=rs.Established),(e&Ct.FIN)===Ct.FIN&&this.remoteCloseWrite(),(e&Ct.RST)===Ct.RST&&this.reset()}getSendFlags(){switch(this.state){case rs.Init:return this.state=rs.SYNSent,Ct.SYN;case rs.SYNReceived:return this.state=rs.Established,Ct.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Kt.WindowUpdate,flag:e,streamID:this._id,length:s})}}const xI="/yamux/1.0.0",Dj=500;class Rj{protocol=xI;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[Jt]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new Nj(this._components,{...this._init,...e})}}class Nj{protocol=xI;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...Sj,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),_j(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=Vn({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{const s=()=>{const a=bI(n);if(a.return!=null){const c=a.return();Oj(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}};let i,o;try{const a=new Ij(n);try{this.closeController.signal.addEventListener("abort",s);for await(const c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=_s.NormalTermination}catch(a){vj.has(a.name)?(this.log?.error("protocol error in sink",a),i=_s.ProtocolError):(this.log?.error("internal error in sink",a),i=_s.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new Bc("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Bc("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new M4("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,rs.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new Bc("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Bc("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new Bc("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??_s.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){const n=AbortSignal.timeout(Dj);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??_s.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new te("Stream already exists with that id");const i=new Pj({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await Zt(new Promise(t=>{e=setTimeout(t,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(t=>this.log?.error("ping error: %s",t))}catch{clearInterval(e);return}}}async handleFrame(e,t){const{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %o",e),n===0)switch(s){case Kt.Ping:{this.handlePing(e);return}case Kt.GoAway:{this.handleGoAway(i);return}default:throw new Vc("Invalid frame type")}else switch(e.type){case Kt.Data:case Kt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new Vc("Invalid frame type")}}handlePing(e){if(e.flag===Ct.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Ct.ACK);else if(e.flag===Ct.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Vc("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new vI("ping not requested");if(this.activePing.id!==e)throw new EI("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",_s[e]??"unknown"),this.remoteGoAway=e;for(const t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:n,flag:s,type:i}=e;(s&Ct.SYN)===Ct.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(o===void 0){if(i===Kt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(i){case Kt.WindowUpdate:{o.handleWindowUpdate(e);return}case Kt.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new te("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Kt.WindowUpdate,flag:Ct.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Kt.WindowUpdate,flag:Ct.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,rs.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===Kt.Data){if(t===void 0)throw new Vc("Invalid frame");this.source.push(new Pe(C7(e),t))}else this.source.push(C7(e))}sendPing(e,t=Ct.SYN){t===Ct.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:Kt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=_s.NormalTermination){this.log?.("sending GoAway reason=%s",_s[e]),this.localGoAway=e,this.sendFrame({type:Kt.GoAway,flag:0,streamID:0,length:e})}}function Oj(r){return r!=null&&typeof r.then=="function"}function AI(r={}){return e=>new Rj(e,r)}function II(r){try{for(const{code:e,value:t}of r.getComponents())if(t!=null&&e===Un)return SL("2000::/3",t)}catch{}return!1}function Mj(r,e,t){let n,s,i=!1;function o(){const l={signal:s.signal};if(t?.timeout!=null){const u=Je([s.signal,AbortSignal.timeout(t.timeout)]);l.signal=u}i=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{i=!1,!s.signal.aborted&&(n=setTimeout(o,e))})}const a=Ah(o,t?.debounce??100);let c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{i||(clearTimeout(n),a())},start:()=>{c||(c=!0,s=new AbortController,s.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),s?.abort(),c=!1}}}function P7(r,e){const t=ds(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const Lj="libp2p",Bj="autonat",$j="1.0.0",Uj=3e4,Fj=2,Vj=20,Kj=80,qj=8192;var wt;(function(r){(function(s){s.DIAL="DIAL",s.DIAL_RESPONSE="DIAL_RESPONSE"})(r.MessageType||(r.MessageType={}));let e;(function(s){s[s.DIAL=0]="DIAL",s[s.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),function(s){s.codec=()=>Zr(e)}(r.MessageType||(r.MessageType={})),function(s){s.OK="OK",s.E_DIAL_ERROR="E_DIAL_ERROR",s.E_DIAL_REFUSED="E_DIAL_REFUSED",s.E_BAD_REQUEST="E_BAD_REQUEST",s.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(r.ResponseStatus||(r.ResponseStatus={}));let t;(function(s){s[s.OK=0]="OK",s[s.E_DIAL_ERROR=100]="E_DIAL_ERROR",s[s.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",s[s.E_BAD_REQUEST=200]="E_BAD_REQUEST",s[s.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),function(s){s.codec=()=>Zr(t)}(r.ResponseStatus||(r.ResponseStatus={})),function(s){let i;s.codec=()=>(i==null&&(i=Ae((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const h=o.uint32();switch(h>>>3){case 1:{l.id=o.bytes();break}case 2:{if(c.limits?.addrs!=null&&l.addrs.length===c.limits.addrs)throw new nt('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(h&7);break}}}return l})),i),s.encode=o=>xe(o,s.codec()),s.decode=(o,a)=>_e(o,s.codec(),a)}(r.PeerInfo||(r.PeerInfo={})),function(s){let i;s.codec=()=>(i==null&&(i=Ae((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),r.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const h=o.uint32();switch(h>>>3){case 1:{l.peer=r.PeerInfo.codec().decode(o,o.uint32(),{limits:c.limits?.peer});break}default:{o.skipType(h&7);break}}}return l})),i),s.encode=o=>xe(o,s.codec()),s.decode=(o,a)=>_e(o,s.codec(),a)}(r.Dial||(r.Dial={})),function(s){let i;s.codec=()=>(i==null&&(i=Ae((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),r.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const h=o.uint32();switch(h>>>3){case 1:{l.status=r.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(h&7);break}}}return l})),i),s.encode=o=>xe(o,s.codec()),s.decode=(o,a)=>_e(o,s.codec(),a)}(r.DialResponse||(r.DialResponse={}));let n;r.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.MessageType.codec().encode(s.type,i)),s.dial!=null&&(i.uint32(18),r.Dial.codec().encode(s.dial,i)),s.dialResponse!=null&&(i.uint32(26),r.DialResponse.codec().encode(s.dialResponse,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.type=r.MessageType.codec().decode(s);break}case 2:{a.dial=r.Dial.codec().decode(s,s.uint32(),{limits:o.limits?.dial});break}case 3:{a.dialResponse=r.DialResponse.codec().decode(s,s.uint32(),{limits:o.limits?.dialResponse});break}default:{s.skipType(l&7);break}}}return a})),n),r.encode=s=>xe(s,r.codec()),r.decode=(s,i)=>_e(s,r.codec(),i)})(wt||(wt={}));const Hj=4,zj=8;class Wj{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??Lj}/${Bj}/${$j}`,this.timeout=t.timeout??Uj,this.maxInboundStreams=t.maxInboundStreams??Fj,this.maxOutboundStreams=t.maxOutboundStreams??Vj,this.connectionThreshold=t.connectionThreshold??Kj,this.maxMessageSize=t.maxMessageSize??qj,this.dialResults=hs({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=Mj(this.findRandomPeers.bind(this),6e4),this.addressFilter=So(1024)}[Symbol.toStringTag]="@libp2p/autonat";[Jt]=["@libp2p/autonat"];get[yo](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=Je([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(s=>s.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=P7(e.stream,{maxDataLength:this.maxMessageSize}).pb(wt);try{const s=await n.read({signal:t}),i=await this.handleAutonatMessage(s,e.connection,{signal:t});await n.write(i,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(s){this.log.error("error handling incoming autonat stream - %e",s),e.stream.abort(s)}}async handleAutonatMessage(e,t,n){const s=this.components.addressManager.getAddresses().map(h=>h.toOptions().host),i=e.dial;if(i==null)return this.log.error("dial was missing from message"),{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=i.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const h=pr(a.id);o=En(h)}catch(h){return this.log.error("invalid PeerId - %e",h),{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(h=>Ie(h)).filter(h=>{const d=h.toOptions();return $a(h)?!1:d.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",h,t.remoteAddr),!1):s.includes(d.host)?!1:this.components.transportManager.dialTransportForMultiaddr(h)==null?(this.log.trace("not dialing %a - transport unsupported",h),!1):!0}).map(h=>(h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${o.toString()}`)),h));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(h=>h.toString()).join(", "),o);let l="",u=c[0];for(const h of c){let d;u=h;try{if(d=await this.components.connectionManager.openConnection(h,n),!d.remoteAddr.equals(h))throw this.log.error("tried to dial %a but dialed %a",h,d.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,h),{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.OK,addr:d.remoteAddr.decapsulateCode(Xl("p2p").code).bytes}}}catch(g){this.log.error("could not dial %p - %e",o,g),l=g.message}finally{d!=null&&await d.close()}}return{type:wt.MessageType.DIAL_RESPONSE,dialResponse:{status:wt.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){const n=this.components.addressManager.getAddressesWithMetadata().sort((s,i)=>s.type==="observed"&&i.type!=="observed"?1:i.type==="observed"&&s.type!=="observed"?-1:0).filter(s=>!(!(s.expires<Date.now())||s.multiaddr.toOptions().family===6&&(!t||!II(s.multiaddr))||$a(s.multiaddr)));for(const s of n){const i=s.multiaddr.toString();let o=this.dialResults.get(i);if(o!=null){if(o.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",o.multiaddr,e);continue}if(o.queue.size>10){this.log.trace("%a already has enough peers queued",o.multiaddr);continue}}if(o==null){const a=s.expires<Date.now();if(a&&this.addressFilter.remove?.(i),this.addressFilter.has(i))continue;this.addressFilter.add(i),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",i),o={multiaddr:s.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:WL(),queue:new Ao({concurrency:3,maxSize:50}),type:s.type,lastVerified:s.lastVerified},this.dialResults.set(i,o)}return o}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),s=this.getNetworkSegment(e.remoteAddr),i=this.getFirstUnverifiedMultiaddr(s,n);if(i==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){i.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",i.multiaddr),this.confirmAddress(i)):this.log("skipping verifying %a because we are too close to the connection limit",i.multiaddr);return}i.queue.add(async o=>{await this.askPeerToVerify(e,s,o)},{peerId:e.remotePeer,multiaddr:i.multiaddr}).catch(o=>{i?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,i?.multiaddr,o)})}async askPeerToVerify(e,t,n){let s=this.dialResults.get(n.multiaddr.toString());if(s==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}const i=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);const o=await e.newStream(this.protocol,{signal:i});try{const a=P7(o).pb(wt),[,c]=await Promise.all([a.write({type:wt.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:i}),a.read({signal:i})]);if(c.type!==wt.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==wt.ResponseStatus.OK&&l!==wt.ResponseStatus.E_DIAL_ERROR)return;if(s=this.dialResults.get(n.multiaddr.toString()),s==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(s.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(s.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(s.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(s.verifyingPeers.add(e.remotePeer),s.networkSegments.push(t),l===wt.ResponseStatus.OK){if(s.success++,s.type!=="observed"){this.confirmAddress(s);return}}else l===wt.ResponseStatus.E_DIAL_ERROR&&s.failure++;this.log("%a success %d failure %d",s.multiaddr,s.success,s.failure),s.success===Hj&&this.confirmAddress(s),s.failure===zj&&this.unconfirmAddress(s)}finally{try{await o.close({signal:i})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function TI(r={}){return e=>new Wj(e,r)}const jj=le("dns4"),Gj=le("dns6"),Yj=le("dnsaddr"),Va=Nt(le("dns"),Yj,jj,Gj),Q0=Nt(le("ip4"),le("ip6")),Sl=Nt(Ee(Q0,le("tcp")),Ee(Va,le("tcp"))),X0=Ee(Q0,le("udp")),Qj=Ee(X0,le("utp")),Xj=Ee(X0,le("quic")),Zj=Ee(X0,le("quic-v1")),by=Nt(Ee(Sl,le("ws")),Ee(Va,le("ws"))),tp=Nt(Ee(by,le("p2p")),by),vy=Nt(Ee(Sl,le("wss")),Ee(Va,le("wss")),Ee(Sl,le("tls"),le("ws")),Ee(Va,le("tls"),le("ws"))),rp=Nt(Ee(vy,le("p2p")),vy),Ey=Nt(Ee(Sl,le("http")),Ee(Q0,le("http")),Ee(Va,le("http"))),Sy=Nt(Ee(Sl,le("https")),Ee(Q0,le("https")),Ee(Va,le("https"))),D7=Ee(X0,le("webrtc-direct"),le("certhash")),kI=Nt(Ee(D7,le("p2p")),D7),R7=Ee(Zj,le("webtransport"),le("certhash"),le("certhash")),CI=Nt(Ee(R7,le("p2p")),R7),PI=Nt(Ee(tp,le("p2p-webrtc-star"),le("p2p")),Ee(rp,le("p2p-webrtc-star"),le("p2p")),Ee(tp,le("p2p-webrtc-star")),Ee(rp,le("p2p-webrtc-star")));Nt(Ee(tp,le("p2p-websocket-star"),le("p2p")),Ee(rp,le("p2p-websocket-star"),le("p2p")),Ee(tp,le("p2p-websocket-star")),Ee(rp,le("p2p-websocket-star")));const DI=Nt(Ee(Ey,le("p2p-webrtc-direct"),le("p2p")),Ee(Sy,le("p2p-webrtc-direct"),le("p2p")),Ee(Ey,le("p2p-webrtc-direct")),Ee(Sy,le("p2p-webrtc-direct"))),Ka=Nt(by,vy,Ey,Sy,PI,DI,Sl,Qj,Xj,Va,kI,CI);Nt(Ee(Ka,le("p2p-stardust"),le("p2p")),Ee(Ka,le("p2p-stardust")));const so=Nt(Ee(Ka,le("p2p")),PI,DI,kI,CI,le("p2p")),N7=Nt(Ee(so,le("p2p-circuit"),so),Ee(so,le("p2p-circuit")),Ee(le("p2p-circuit"),so),Ee(Ka,le("p2p-circuit")),Ee(le("p2p-circuit"),Ka),le("p2p-circuit")),RI=()=>Nt(Ee(N7,RI),N7),ra=RI(),Jj=Nt(Ee(ra,so,ra),Ee(so,ra),Ee(ra,so),ra,so);Nt(Ee(ra,le("webrtc"),le("p2p")),Ee(ra,le("webrtc")),Ee(Ka,le("webrtc"),le("p2p")),Ee(Ka,le("webrtc")),le("webrtc"));function NI(r){function e(t){let n;try{n=Ie(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function Ee(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:NI(e),partialMatch:e}}function Nt(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:NI(e),partialMatch:e}}function le(r){const e=r;function t(s){let i;try{i=Ie(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const eG="bootstrap",tG=50,rG=1e3;class nG extends Tt{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??rG,this.list=[];for(const n of t.list){if(!Jj.matches(n)){this.log.error("Invalid multiaddr");continue}const s=Ie(n),i=s.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:Ht(i),multiaddrs:[s]};this.list.push(o)}this._init=t}[mh]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[Jt]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??eG]:{value:this._init.tagValue??tG,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function sG(r){return e=>new nG(e,r)}function _y(r,e){const t=ds(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const iG=290,oG=1,OI=2e3,aG=100,yf=`${r0}-circuit-relay`;BigInt(1<<17);const np="/libp2p/circuit/relay/0.2.0/hop",O7="/libp2p/circuit/relay/0.2.0/stop",M7=300,cG=4096,lG=.001;var _l;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),function(n){n.codec=()=>Zr(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ae((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),xl.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),sp.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),Al.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),kr.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=xl.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=sp.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=Al.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=kr.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,s)=>_e(n,r.codec(),s)})(_l||(_l={}));var ni;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),function(n){n.codec=()=>Zr(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ae((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),xl.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),Al.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),kr.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=xl.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=Al.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=kr.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,s)=>_e(n,r.codec(),s)})(ni||(ni={}));var xl;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:Be(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new nt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(xl||(xl={}));var sp;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),op.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new nt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=op.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(sp||(sp={}));var Al;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Al||(Al={}));var kr;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(kr||(kr={}));var xy;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(xy||(xy={}));(function(r){r.codec=()=>Zr(xy)})(kr||(kr={}));var ip;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:Be(0),peer:Be(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(ip||(ip={}));var op;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),ip.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Be(0),payloadType:Be(0),signature:Be(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=ip.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(op||(op={}));class L7 extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class uG extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class hG extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function B7(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class $7{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const MI=dt(et(M_.matchers[0],pt(ic))),LI=dt(pt(ic));function U7(r){const{stream:e,remoteAddr:t,logger:n,onDataRead:s,onDataWrite:i}=r,o=n.forComponent("libp2p:stream:converter");let a=!1,c=!1;const l=e.close.bind(e);e.close=async m=>{await l(m),g(!0)};const u=e.abort.bind(e);e.abort=m=>{u(m),g(!0)};const h=e.sink.bind(e);e.sink=async m=>{try{await h(bn(m,b=>z1(b,y=>i?.(y))))}catch(b){b.type!=="aborted"&&o.error("%s error in sink",t,b)}finally{c=!0,g()}};const d={log:o,sink:e.sink,source:async function*(){try{for await(const m of e.source)s?.(m),yield m}finally{a=!0,g()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function g(m){m===!0&&(a=!0,c=!0),a&&c&&d.timeline.close==null&&(d.timeline.close=Date.now())}return d}class dG extends Tt{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(np,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(np)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=F7(n),o=F7(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new Ao({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=Je([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function F7(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(re(e)).getTime()}class fG extends Tt{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??OI,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(LI.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(MI.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new Pm(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>Ie(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function pG(r){return new fG(r)}const gG="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let mG=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=gG[t[r]&63];return e};const yG=60*1e3*10,wG=60*1e3*5,bG=30*1e3;class vG extends Tt{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new oc,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??aG,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??OI,this.started=!1,this.relayFilter=So(100),this.reserveQueue=new Ao({concurrency:t?.reservationConcurrency??oG,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(yf)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[yf]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=mG();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Pm("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new hG("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Pm("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const m=this.connectionManager.getConnections(e);let b=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(y=>y.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),b=!0),b&&B7(i.reservation.expire)>yG)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new L7("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const a=await this.connectionManager.openConnection(e,{signal:o});if(_o.matches(a.remoteAddr))throw new uG("not creating reservation over relayed connection");const c=await this.#e(a,{signal:o}),l=B7(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());const u=Math.min(Math.max(l-wG,bG),Math.pow(2,31)-1),h=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#t(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},u);let d;if(t==="discovered"){const m=this.pendingReservations.pop();if(m==null)throw new L7("Made reservation on relay but did not need any more discovered relays");d={timeout:h,reservation:c,type:t,connection:a.id,id:m}}else d={timeout:h,reservation:c,type:t,connection:a.id};this.reservations.set(e,d),await this.peerStore.merge(e,{tags:{[yf]:{value:1,ttl:l}}}),this.#r();const g={relay:e,details:d};return this.safeDispatchEvent("relay:created-reservation",{detail:g}),g}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(np,t),i=_y(n).pb(_l);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:_l.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",o),o.status===kr.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const l of o.reservation.addrs){let u=Ie(l);u.getPeerId()==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=Ie(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return o.reservation.addrs=[...c].map(l=>Ie(l).bytes),o.reservation}const a=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[yf]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=So(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}const EG=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(Ie)}catch{return!1}return!0},V7={maxInboundStopStreams:M7,maxOutboundStopStreams:M7};class SG{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??V7.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??V7.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new dG(e,{filter:t.discoveryFilter??aB(cG,lG)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,s)})}),this.reservationStore=new vG(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[Jt]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[yo](){return this.discovery!=null?["@libp2p/identify"]:[]}[n0]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(O7,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await bi(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Ro(this.discovery,this.reservationStore),await this.registrar.unhandle(O7),this.started=!1}async dial(e,t){if(e.protoCodes().filter(g=>g===iG).length!==1){const g="Invalid circuit relay address";throw this.log.error(g,e),new Qu(g)}const n=e.toString().split("/p2p-circuit"),s=Ie(n[0]),i=Ie(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const g=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${g}`),new Qu(`C${g}`)}const c=Ht(o),l=Ht(a);let h=this.connectionManager.getConnections(c)[0];h==null?(await this.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new ve("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new ve("circuit-relay:reuse-connection"));let d;try{t.onProgress?.(new ve("circuit-relay:open-hop-stream")),d=await h.newStream(np,t);const g=_y(d),m=g.pb(_l);t.onProgress?.(new ve("circuit-relay:write-connect-message")),await m.write({type:_l.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[Ie(i).bytes]}},t),t.onProgress?.(new ve("circuit-relay:read-connect-response"));const b=await m.read(t);if(b.status!==kr.OK)throw new mt(`failed to connect via relay with status ${b?.status?.toString()??"undefined"}`);const y=new $7(b.limit),_=U7({stream:g.unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:y.onData,onDataWrite:y.onData});return this.log("new outbound relayed connection %a",_.remoteAddr),await this.upgrader.upgradeOutbound(_,{...t,limits:y.getLimits()})}catch(g){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,g),d?.abort(g),g}}createListener(e){return pG({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>MI.exactMatch(t)||LI.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>_o.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(u){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",u)}const s=_y(t).pb(ni),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:ni.Type.STATUS,status:kr.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==ni.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:ni.Type.STATUS,status:kr.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!EG(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:ni.Type.STATUS,status:kr.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}const o=En(pr(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:ni.Type.STATUS,status:kr.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:ni.Type.STATUS,status:kr.OK},{signal:n});const a=new $7(i.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=U7({stream:s.unwrap().unwrap(),remoteAddr:c,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function BI(r={}){return e=>new SG(e,r)}function K7(r,e){const t=ds(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var xs;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),function(n){n.codec=()=>Zr(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ae((n,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.observedAddresses!=null)for(const o of n.observedAddresses)s.uint32(18),s.bytes(o);i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={observedAddresses:[]},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(i.limits?.observedAddresses!=null&&o.observedAddresses.length===i.limits.observedAddresses)throw new nt('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,s)=>_e(n,r.codec(),s)})(xs||(xs={}));function q7(r,e){return _o.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:o$.matches(r)?!0:c$.matches(r)?Oo(r.toOptions().host)===!1:!1}const H7=1024*4,z7=100,wf={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};class _G{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??wf.timeout,this.retries=t.retries??wf.retries,this.maxInboundStreams=t.maxInboundStreams??wf.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??wf.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[yo]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(bf,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{_o.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(bf,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(bf),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const s={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([bf],{signal:s.signal,runOnLimitedConnection:!0});const i=K7(t,{maxDataLength:H7}).pb(xs);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await i.write({type:xs.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(h=>h.bytes)},s),this.log("B receiving connect from %p",e.remotePeer);const a=await i.read(s);if(a.type!==xs.Type.CONNECT)throw this.log("A sent wrong message type"),new mt("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new mt("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await i.write({type:xs.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await B_(l/2),this.log("B dialing",c);const u=await this.connectionManager.openConnection(c,{signal:s.signal,priority:z7,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(s);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(s)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(s=>{const i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(s=>q7(s,this.transportManager));if(n.length>0){const s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const i=await this.connectionManager.openConnection(n,{signal:s,force:!0});if(_o.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:s}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const s=K7(e,{maxDataLength:H7}).pb(xs);this.log("A receiving connect");const i=await s.read(n);if(i.type!==xs.Type.CONNECT)throw this.log("B sent wrong message type"),new mt("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new mt("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new mt("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await s.write({type:xs.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await s.read(n)).type!==xs.Type.SYNC)throw new mt("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:z7,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(s){this.log.error("incoming DCUtR from %p failed",t.remotePeer,s),e.abort(s)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const s=Ie(n);if(!q7(s,this.transportManager))continue;t.push(s)}catch{}return t}}const bf="/libp2p/dcutr";function $I(r={}){return e=>new _G(e,r)}function ap(r,e){const t=ds(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const xG="0.1.0",AG="id",IG="id/push",TG="1.0.0",kG="1.0.0",CG=1024*8,PG=32,DG=1e3;var Il;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new nt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new nt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Il||(Il={}));const Dn={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:CG,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:PG};function RG(r){if(r!=null&&r.length>0)try{return Ie(r)}catch{}}function NG(r,e){return e??r.userAgent}async function UI(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new mt("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:Ie(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=Or(s.publicKey);if(!Na(c).equals(n.remotePeer))throw new mt("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const l=await Rs.openAndCertify(c,pn.DOMAIN);let u=pn.createFromProtobuf(l.payload);const h=Gl(l.publicKey.toCID());if(!u.peerId.equals(h))throw new mt("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new mt("signing key does not match remote PeerId");let d;try{d=await r.get(u.peerId)}catch(g){if(g.name!=="NotFoundError")throw g}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){const g=Rs.createFromProtobuf(d.peerRecordEnvelope),m=pn.createFromProtobuf(g.payload);m.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,u.seqNumber),u=m,c=d.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=u.multiaddrs.map(g=>({isCertified:!0,multiaddr:g})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=ne(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=ne(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>Ie(c)),observedAddr:s.observedAddr==null?void 0:Ie(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class FI{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Dn.timeout,this.maxInboundStreams=t.maxInboundStreams??Dn.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Dn.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Dn.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Dn.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Dn.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Dn.protocolPrefix}/${xG}`,agentVersion:NG(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:ne(this.host.agentVersion),ProtocolVersion:ne(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class OG extends FI{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Dn.protocolPrefix}/${IG}/${kG}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??Dn.concurrency,this._push=Ah(this.sendPushMessage.bind(this),t.debounce??DG),(t.runOnSelfUpdate??Dn.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(s=>{this.log.error("error pushing updates to peers - %e",s)})})}[Jt]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{const e=this.addressManager.getAddresses().map(u=>u.decapsulateCode(Xl("p2p").code)),t=new pn({peerId:this.peerId,multiaddrs:e}),n=await Rs.seal(t,this.privateKey),s=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),o=re(i.metadata.get("AgentVersion")??ne(this.host.agentVersion)),a=re(i.metadata.get("ProtocolVersion")??ne(this.host.protocolVersion)),c=this;async function*l(){for(const u of c.connectionManager.getConnections())(await c.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let d;const g=AbortSignal.timeout(c.timeout);try{d=await u.newStream(c.protocol,{signal:g,runOnLimitedConnection:c.runOnLimitedConnection}),await ap(d,{maxDataLength:c.maxMessageSize}).pb(Il).write({listenAddrs:e.map(b=>b.bytes),signedPeerRecord:n.marshal(),protocols:s,agentVersion:o,protocolVersion:a},{signal:g}),await d.close({signal:g})}catch(m){c.log.error("could not push identify update to peer",m),d?.abort(m)}})}await Si(E0(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e){const{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},o=await ap(n,{maxDataLength:this.maxMessageSize}).pb(Il).read(s);await n.close(s),await UI(this.peerStore,this.events,this.log,t,o)}catch(s){this.log.error("received invalid message",s),n.abort(s);return}this.log.trace("handled push from %p",t.remotePeer)}}class MG extends FI{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Dn.protocolPrefix}/${AG}/${TG}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Dn.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(i=>{i.name!==s0.name&&this.log.error("error during identify trigged by connection:open",i)})})}[Jt]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){const s=AbortSignal.timeout(this.timeout);t={...t,signal:s}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const i=await ap(n,{maxDataLength:this.maxMessageSize}).pb(Il).read(t);return await n.close(t),i}catch(s){throw n?.abort(s),s}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new mt("public key was missing from identify message");const a=Or(s),c=Gl(a.toCID());if(!e.remotePeer.equals(c))throw new mt("identified peer does not match the expected peer");if(this.peerId.equals(c))throw new mt("identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("identify completed for peer %p and protocols %o",c,i),UI(this.peerStore,this.events,this.log,e,n)}maybeAddObservedAddress(e){const t=RG(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),$a(t)){this.log.trace("our observed address was private");return}const n=t.getComponents();if((n[0].code===Un||n[0].code===sc&&n[1].code===Un)&&!II(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}M1.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){const{connection:t,stream:n}=e,s=AbortSignal.timeout(this.timeout);try{const i=await this.peerStore.get(this.peerId),o=this.addressManager.getAddresses().map(u=>u.decapsulateCode(Xl("p2p").code));let a=i.peerRecordEnvelope;if(o.length>0&&a==null){const u=new pn({peerId:this.peerId,multiaddrs:o});a=(await Rs.seal(u,this.privateKey)).marshal().subarray()}let c=t.remoteAddr.bytes;a$.matches(t.remoteAddr)||(c=void 0),await ap(n).pb(Il).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:yn(this.privateKey.publicKey),listenAddrs:o.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:i.protocols},{signal:s}),await n.close({signal:s})}catch(i){this.log.error("could not respond to identify request",i),n.abort(i)}}}function VI(r={}){return e=>new MG(e,r)}function LG(r={}){return e=>new OG(e,r)}const su=1e3,n5=60*su,Sd=60*n5,BG=36*Sd,$G="/ipfs/kad/1.0.0",UG=48*Sd,FG=24*Sd,VG=10,KG=16384,qG=Sd,W7=Sd,HG=10*su,KI=20,Z0=10,zG=5*n5,WG=su,jG=5*su,GG=5*n5,YG=30*su,QG=180*su,j7=`${r0}-kad-dht`;var cp;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={key:Be(0),value:Be(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(cp||(cp={}));function XG(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function ZG(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}class Fn{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return cp.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:XG(this.timeReceived)}}static deserialize(e){const t=cp.decode(e);return new Fn(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=ZG(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Fn(e.key,e.value,t)}}class lp extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class JG extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class eY extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var G7;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(G7||(G7={}));var vt;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(vt||(vt={}));var up;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(up||(up={}));(function(r){r.codec=()=>Zr(up)})(vt||(vt={}));var Tl;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Tl||(Tl={}));var Ay;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(Ay||(Ay={}));(function(r){r.codec=()=>Zr(Ay)})(Tl||(Tl={}));var Kc;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),Tl.codec().encode(t.connection,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:Be(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.multiaddrs!=null&&i.multiaddrs.length===s.limits.multiaddrs)throw new nt('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=Tl.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Kc||(Kc={}));var rl;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.type!=null&&up[t.type]!==0&&(n.uint32(8),vt.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const i of t.closer)n.uint32(66),Kc.codec().encode(i,n);if(t.providers!=null)for(const i of t.providers)n.uint32(74),Kc.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={type:vt.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.type=vt.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(s.limits?.closer!=null&&i.closer.length===s.limits.closer)throw new nt('Decode error - map field "closer" had too many elements');i.closer.push(Kc.codec().decode(t,t.uint32(),{limits:s.limits?.closer$}));break}case 9:{if(s.limits?.providers!=null&&i.providers.length===s.limits.providers)throw new nt('Decode error - map field "providers" had too many elements');i.providers.push(Kc.codec().decode(t,t.uint32(),{limits:s.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(rl||(rl={}));function Y7(r,e={}){const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function Iy(r,e={}){const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Fg(r,e={}){const t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function kl(r,e={}){const t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function Q7(r,e={}){const t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function Ty(r,e={}){const t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function X7(r,e={}){const t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function tY(r,e={}){const t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function rY(r,e,t){if(t.length===0)throw new te("No records given");const s=re(e).split("/");if(s.length<3)throw new te("Record key does not have a selector function");const i=r[s[1].toString()];if(i==null)throw new eY(`No selector function configured for key type "${s[1]}"`);return t.length===1?0:i(e,t)}function nY(r,e){return 0}const sY={pk:nY};async function s5(r,e,t){const n=e.key,i=re(n).split("/");if(i.length<3)return;const o=r[i[1].toString()];if(o==null)throw new te(`No validator available for key type "${i[1]}"`);await o(n,e.value,t)}const iY=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new te('"key" must be a Uint8Array');if(r.byteLength<5)throw new te("Invalid public key record");if(re(r.subarray(0,4))!=="/pk/")throw new te("key was not prefixed with /pk/");const s=Or(e),i=r.slice(4);if(!$e(i,s.toMultihash().bytes))throw new te("public key does not match passed in key")},oY={pk:iY},aY=ne("/pk/");function cY(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const s=Oo(n);return s==null?!0:!s})}}async function Bh(r,e){const t=await Qr.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function xi(r,e){return Bh(r.toMultihash().bytes,e)}function sh(r,e){return new ft(`${r}/${re(e,"base32")}`,!1)}function lY(r){return Rr([aY,r.toMultihash().bytes])}function uY(r){return re(r.subarray(0,4))==="/pk/"}function hY(r){const e=pr(r.subarray(4));return En(e)}function Z7(r,e){const t=new Date;return new Fn(r,e,t).serialize()}const dY=290,fY=54,pY=55,gY=56,mY=4,yY=41;function wY(r){const e=r.stringTuples();for(const t of e)if(t[0]===dY)return!1;if(e[0][0]===fY||e[0][0]===pY||e[0][0]===gY)return!0;if(e[0][0]===mY||e[0][0]===yY){const t=Oo(`${e[0][1]}`);return t==null||!t}return!1}function qI(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:Ne.createV1(o0,pr(ne(n,"base32"))),peerId:Ht(t)}}function Vg(r,e,t){const n=typeof e=="string"?e:re(e.multihash.bytes,"base32"),s=[r,n];return t!=null&&s.push(t.toString()),new ft(s.join("/"))}function HI(r){return new Date(Di(r))}function Tc(r,e,t){return async function*(...n){const s=e.queryTime?.timer(t),i=e.errorTime?.timer(t);let o=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}function zI(r,e,t){return async function(...n){const s=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t);let o=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}class bY{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const n=sh(this.datastorePrefix,e);this.log("fetching record for key %k",n);const s=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);const i=Fn.deserialize(s);return await s5(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,s){this.log("sendCorrection for %b",e);const i=Z7(e,n);for(const{value:o,from:a}of t){if($e(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=sh(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray(),s)}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1;const l={type:vt.PUT_VALUE,key:e,record:i};for await(const u of this.network.sendRequest(a,l,s))u.name==="PEER_RESPONSE"&&u.record!=null&&$e(u.record.value,Fn.deserialize(i).value)&&(c=!0),yield u;if(!c)throw new lp("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);const s=Z7(e,t),i=sh(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray(),n),yield*bn(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>pd(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:vt.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&$e(u.record.value,Fn.deserialize(s).value)||c.push(kl({from:a.peer.id,error:new lp("Value not put correctly"),path:u.path},n)));return c}),o=>E0(o,{ordered:!1,concurrency:Z0}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=rY(this.selectors,e,s)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new Ut("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const i=await this.getLocal(e,t);yield Ty({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}const n=this,s=async function*({peer:i,signal:o,path:a}){for await(const c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield Ty({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,s,t)}}function vY(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function vf(r){if(r.id==null)throw new Error("Invalid peer in message");const e=pr(r.id);return{id:En(e),multiaddrs:(r.multiaddrs??[]).map(t=>Ie(t))}}class EY{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(h=>h.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);const i={type:vt.ADD_PROVIDER,key:s,providers:[vY({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(h){try{a.log("sending provider record for %s to %p",e,h.peer.id);for await(const d of a.network.sendMessage(h.peer.id,i,{...n,path:h.path}))d.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,h.peer.id),o++),yield d}catch(d){a.log.error("error sending provide record to peer %p",h.peer.id,d),yield kl({from:h.peer.id,error:d,path:h.path},n)}}const l=Vn({objectMode:!0}),u=new xo({concurrency:Z0});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("error",h=>{this.log.error("error publishing provider record to peer - %e",h)}),u.add(async()=>{const h=[];for await(const d of this.peerRouting.getClosestPeers(s,n))l.push(d),d.name==="FINAL_PEER"&&h.push(d);h.forEach(d=>{u.add(async()=>{for await(const g of c(d))l.push(g)}).catch(g=>{this.log.error("error publishing provider record to peer - %e",g)})})}).catch(h=>{l.end(h)}),yield*l,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let s=0;const i=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const u=[];for(const h of a.slice(0,n))try{const d=await this.components.peerStore.get(h,t);u.push({id:h,multiaddrs:d.addresses.map(({multiaddr:g})=>g)})}catch(d){if(d.name!=="NotFoundError")throw d;this.log("no peer store entry for %p",h)}if(yield Iy({from:this.components.peerId,messageType:vt.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield Q7({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),s+=u.length,s>=n)return}const c=async function*({peer:u,signal:h,path:d}){const g={type:vt.GET_PROVIDERS,key:i};yield*o.network.sendRequest(u.id,g,{...t,signal:h,path:d})},l=new Ds(a);for await(const u of this.queryManager.run(i,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);const h=[];for(const d of u.providers)l.has(d.id)||(l.add(d.id),h.push(d));if(h.length>0&&(yield Q7({from:u.from,providers:h,path:u.path},t),s+=h.length,s>=n))return}}}function ky(r,e){const t=ds(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class SY extends Tt{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new Th({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new te("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield X7({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield Y7({to:e,type:s,path:n.path},n);const c=await this._writeReadMessage(i,t,n);i.close(n).catch(l=>{this.log.error("error closing stream to %p",e,l),i?.abort(l)}),yield Iy({from:e,messageType:c.type,closer:c.closer.map(vf),providers:c.providers.map(vf),record:c.record==null?void 0:Fn.deserialize(c.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield kl({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new te("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield X7({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield Y7({to:e,type:s,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),i?.abort(c)}),yield Iy({from:e,messageType:s,path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),yield kl({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,n){await ky(e).write(t,rl,n)}async _writeReadMessage(e,t,n){const s=ky(e);await s.write(t,rl,n);const i=await s.read(rl,n);return i.closer.forEach(o=>{this.safeDispatchEvent("peer",{detail:vf(o)})}),i.providers.forEach(o=>{this.safeDispatchEvent("peer",{detail:vf(o)})}),i}}function ih(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class i5{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){const s=await xi(e.id,n);this.addWithKadId(e,s,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const s={peer:e,distance:El(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&ih(s.distance,o.distance)!==-1)return}let i=!1;for(let o=0;o<this.peerDistances.length;o++){const a=ih(this.peerDistances[o].distance,s.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(o,0,s);break}}i||this.peerDistances.push(s),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const n=await xi(e,t),s=El(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return ih(s,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}}class _Y{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n;const s=await this.routingTable.find(e,t);if(s!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(s,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){const s={type:vt.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=lY(e),s={index:-1,queued:0,running:0,total:0};for await(const i of this._getValueSingle(e,n,{...t,path:s}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const o=Or(i.record.value),a=Na(o);if(!a.equals(e))throw new u1("public key does not match id");if(a.publicKey==null)throw new u1("public key missing");yield Ty({from:e,value:i.record.value,path:s},t)}throw new lp(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const s=await this.findPeerLocal(e,t);if(s!=null){this.log("found local"),yield Fg({from:this.components.peerId,peer:s,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a,path:c}){const l={type:vt.FIND_NODE,key:e.toMultihash().bytes};for await(const u of s.network.sendRequest(o.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){const h=u.closer.find(d=>d.id.equals(e));h!=null&&(yield Fg({from:u.from,peer:h,path:u.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,i,t))o.name==="FINAL_PEER"&&(n=!0),yield o}if(!n)throw new Ut("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await Bh(e,t),s=new i5(n,this.routingTable.kBucketSize),i=this,o=async function*({peer:a,path:c,peerKadId:l,signal:u}){i.log("getClosestPeers asking %p",a.id);const h={type:vt.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,h,{...t,signal:u,path:c}),s.addWithKadId(a,l,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",s.length,e);for(let{peer:a,path:c}of s.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield Fg({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record,n)}catch{const o="invalid record received, discarded";this.log(o),yield kl({from:s.from,error:new lp(o),path:n.path},n);continue}yield s}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new JG("invalid record received");await s5(this.validators,new Fn(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const n=[];try{const o=pr(e),a=En(o),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}const s=await Bh(e,t),i=this.routingTable.closestPeers(s,t);for(const o of i)try{n.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}}class xY{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){const s=Vg(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(s,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);const n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){const s=Vg(this.datastorePrefix,e,t),i=Yr(n?.time?.getTime()??Date.now());await this.datastore.put(s,i,n)}async loadProviders(e,t){const n=new oc,s=Vg(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:s.toString()},t)){const{peerId:o}=qI(i.key);n.set(o,HI(i.value))}return n}}const AY=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function IY(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:u}=AY(r),h=(...g)=>{const m=t.multiArgs?g:g[0];t.filter&&!t.filter(m)||(c.push(m),t.count===c.length&&(n(),i(c)))},d=g=>{n(),o(g)};n=()=>{for(const g of a)u(g,h);for(const g of t.rejectionEvents)u(g,d)};for(const g of a)l(g,h);for(const g of t.rejectionEvents)l(g,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=f0(s,{milliseconds:t.timeout});return i.cancel=n,i}return s}function TY(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=IY(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}async function*kY(r){const{key:e,startingPeers:t,ourPeerId:n,query:s,alpha:i,path:o,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:h}=r,d=Vn({objectMode:!0}),g=new xo({concurrency:i,sort:(y,_)=>ih(y.options.distance,_.options.distance)});g.addEventListener("idle",()=>{d.push(tY({path:{index:o,queued:g.queued,running:g.running,total:g.size}},r)),d.end()}),g.addEventListener("error",y=>{c.error("error during query - %e",y.detail)});const m=()=>{g.abort(),d.end(new wi)};h.addEventListener("abort",m);try{let _=function(A,R){if(A==null)return;l.add(A.id.toMultihash().bytes);const I=El(R,y);g.add(async()=>{try{for await(const T of s({...r,key:e,peer:A,path:{index:o,queued:g.queued,running:g.running,total:g.size},numPaths:a,peerKadId:R,signal:h})){if(T.name==="PEER_RESPONSE")for(const k of T.closer){if(l.has(k.id.toMultihash().bytes)){c("already seen %p in query",k.id);continue}if(n.equals(k.id)){c("not querying ourselves");continue}if(!await u.isDialable(k.multiaddrs)){c("not querying undialable peer");continue}const D=await xi(k.id,{signal:h}),F=El(D,y);if(ih(F,I)!==-1){c("skipping %p as they are not closer to %b than %p",k.id,e,A);continue}c("querying closer peer %p",k.id),_(k,D)}d.push({...T,path:{index:o,queued:g.queued,running:g.running,total:g.size}})}}catch(T){d.push(kl({from:A.id,error:T,path:{index:o,queued:g.queued,running:g.running-1,total:g.size-1}},r))}},{distance:I}).catch(T=>{c.error("error during query - %e",T)})};var b=_;const y=await Bh(e,{signal:h});await Promise.all(t.map(async A=>{_({id:A,multiaddrs:[]},await xi(A,{signal:h}))})),yield*d}finally{h.removeEventListener("abort",m)}}class CY{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??KI,this.alpha=t.alpha??Z0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(QG);n={...n,signal:c}}const s=new AbortController,i=Je([this.shutDownController.signal,s.signal,n.signal]);s.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+re(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await TY(this.routingTable,"peer:add",{signal:i,filter:g=>!this.peerId.equals(g.detail)}),o("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await Zt(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await Bh(e,{signal:i}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((g,m,b)=>(g[b%this.disjointPaths].push(m),g),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(g=>g.length>0);if(l.length===0){o.error("running query with no peers");return}const h=So(1024),d=u.map((g,m)=>kY({...n,key:e,startingPeers:g,ourPeerId:this.peerId,signal:i,query:t,path:m,numPaths:u.length,alpha:this.alpha,log:o,peersSeen:h,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const g of lo(...d)){if(g.name==="QUERY_ERROR"&&o.error("query error",g.error),g.name==="PEER_RESPONSE")for(const m of[...g.closer,...g.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:i})&&await this.routingTable.add(m.id,{signal:i});i.throwIfAborted(),yield g}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),s.abort()),i.clear(),o("query finished")}}}function PY(r){return r[Symbol.asyncIterator]!=null}function WI(r){if(PY(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}class DY{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??KI,this.interval=t.interval??zG,this.initialInterval=t.initialInterval??WG,this.queryTimeout=t.queryTimeout??jG,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=zI(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Fe(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=Je(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),s=await bn(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>O1(o,this.count),async o=>WI(o));t?.throwIfAborted();const i=Date.now()-n;this.log("self-query found %d peers in %dms",s,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:s,duration:i}}))}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class RY extends Tt{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new xo({concurrency:t.concurrency??VG,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Th({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??FG,this.maxQueueSize=t.maxQueueSize??KG,this.validity=t.validity??UG,this.interval=t.interval??qG,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=zI(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(W7)}).catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(e){try{this.safeDispatchEvent("reprovide:start");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:n,peerId:s}=qI(t.key),i=HI(t.value).getTime(),o=i+this.validity,a=Date.now(),c=a>o;this.log.trace("comparing: %d < %d = %s %s",i,a-this.validity,c,c?"(expired)":""),c&&await this.datastore.delete(t.key,e),this.peerId.equals(s)&&a-o<this.reprovideThreshold&&this.queueReprovide(n).catch(l=>{this.log.error("could not reprovide %c - %e",n,l)})}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(W7)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const n=this.reprovideQueue.queue.find(s=>s.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async s=>{if(s.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const i=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(s=>{this.log.error("could not re-provide key %c - %e",e,s)})}async reprovide(e,t){await Si(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const NY=20,OY=5e3,MY="kad-close",LY=50;class BY{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??OY,this.peerSetSize=t.peerSetSize??NY,this.closeTagName=t.closeTagName??MY,this.closeTagValue=t.closeTagValue??LY,this.closestPeers=new Ds,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await xi(this.components.peerId);this.newPeers=new i5(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new Ds(this.newPeers?.peers.map(({peer:s})=>s.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[j7]:{value:1}}})}),...[...n].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[j7]:void 0}})})])}}function Wf(r){return Array.isArray(r?.peers)}class $Y{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??VY,this.kBucketSize=t.kBucketSize??o5,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??HY,this.lastPingThreshold=t.lastPingThreshold??GY,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=m0({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await xi(e,t),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await xi(e,t),lastPing:0},s=this.addingPeerMap.get(e);if(s!=null)return s;try{const i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!FY(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const s=n.peers.filter(o=>!(o.peerId.equals(this.localPeer?.peerId)||o.lastPing>Date.now()-this.lastPingThreshold)).sort((o,a)=>o.lastPing<a.lastPing?-1:o.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing);let i=!1;for await(const o of this.ping(s,t))i=!0,await this.remove(o.kadId,t);i&&await this._add(e,t)}*closest(e,t){const n=new i5(e,t?.count??this.kBucketSize);for(const s of this.toIterable())t?.exclude?.some(i=>i.equals(s.peerId))!==!0&&n.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*pd(n.peers,({peer:s})=>s.id)}count(){function e(t){if(Wf(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){const n=this._determineBucket(e),s=this._indexOf(n,e);if(s>-1){const i=n.peers.splice(s,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(Wf(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+re(El(e,t),"base16"))}_determineBucket(e){const t=re(e,"base2");function n(s,i=0){return Wf(s)?s:t[i]==="0"?n(s.left,i+1):n(s.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>$e(n.kadId,t))}async _split(e,t){const n={prefix:"0",depth:e.depth+1,peers:[]},s={prefix:"1",depth:e.depth+1,peers:[]};for(const i of e.peers)re(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(s.peers.push(i),await this.onMove?.(i,e,s,t));UY(e,n,s)}}function UY(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function FY(r,e){return r.lastPing<Date.now()-e}const o5=20,VY=6,KY=20,qY=100,HY=3,zY=20,WY=100,J7="kad-peer",jY=1,GY=6e5,YY=!0,QY=1e3;class XY extends Tt{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??o5,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??J7,this.peerTagValue=t.peerTagValue??jY,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??YY,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??QY,this.shutdownController=new AbortController,this.pingOldContactQueue=new Ao({concurrency:t.pingOldContactConcurrency??zY,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??WY}),this.pingOldContactTimeout=new Th({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Ao({concurrency:t.pingNewContactConcurrency??KY,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??qY}),this.pingNewContactTimeout=new Th({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new $Y(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new BY(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,await bi(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=Je([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const n of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(J7)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await Ro(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const n=[];for(const s of e){if(this.kb.get(s.kadId)==null){this.log("asked to ping contact %p that was not in routing table",s.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{const i=this.pingOldContactQueue.find(s.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",s.peerId),await i.join(t)?void 0:s;if(!await this.pingOldContactQueue.add(async a=>{const c=this.pingOldContactTimeout.getTimeoutSignal(),l=Je([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(s,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:s.peerId,signal:t?.signal}))return s})}for await(const s of E0(n))s!=null&&(yield s)}async verifyNewContact(e,t){const n=this.pingNewContactTimeout.getTimeoutSignal(),s=Je([n,this.shutdownController.signal,t?.signal]);try{const i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:s})):await this.pingNewContactQueue.add(async o=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,o)),{peerId:e.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),s.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(n){return this.log("error pinging old contact %p - %e",e.peerId,n),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const n=await xi(e,t);return this.kb.get(n)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await xi(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,s=20,i=0;function o(a){if(Wf(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<s&&(s=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}o(a.left),o(a.right)}o(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}}const ZY=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Ef=15;class JY{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=s,this.refreshInterval=i??GG,this.refreshQueryTimeout=o??YG,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const n=this._maxCommonPrefix(),s=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${s.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(s.map(async(i,o)=>{try{if(await this._refreshCommonPrefixLength(o,i,e,t),this._numPeersForCpl(n)===0){const a=Math.min(2*(o+1),s.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(l){this.log.error(l)}}}catch(a){this.log.error(a)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n,s){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const o=Je([s?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await WI(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Ef&&(e=Ef);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=vo(2),n=(t[1]<<8)+t[0],s=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=pr(s);return En(i)}_makePeerId(e,t,n){if(n>Ef)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Ef}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=ZY[c],u=new ArrayBuffer(34),h=new DataView(u,0,u.byteLength);return h.setUint8(0,Qr.code),h.setUint8(1,32),h.setUint32(2,l,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=El(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}class eQ{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new mt("Missing key");let n;try{n=Ne.decode(t.key)}catch{throw new mt("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async s=>{const i=pr(s.id),o=En(i),a=s.multiaddrs.map(c=>Ie(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class tQ{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new mt("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});$e(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(Xl("p2p").code))});const s={type:vt.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",s.closer.length,t.key,e),s}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}}class rQ{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:s,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new mt("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=Ne.decode(t.key)}catch{throw new mt("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([D1(pd(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:vt.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class nQ{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new mt("Invalid key");const s={type:vt.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(uY(n)){this.log("is public key");const a=hY(n);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new Ut("No public key found in key book");c=yn(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),s.record=new Fn(n,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=sh(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}const s=Fn.deserialize(n);if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>BG){await this.datastore.delete(t);return}return s}}class sQ{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class iQ{components;validators;log;datastorePrefix;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){const s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new mt(s)}try{const s=Fn.deserialize(t.record);await s5(this.validators,s),s.timeReceived=new Date;const i=sh(this.datastorePrefix,s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}}let oQ=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[vt.GET_VALUE.toString()]:new nQ(e,t),[vt.PUT_VALUE.toString()]:new iQ(e,t),[vt.FIND_NODE.toString()]:new tQ(e,t),[vt.ADD_PROVIDER.toString()]:new eQ(e,t),[vt.GET_PROVIDERS.toString()]:new rQ(e,t),[vt.PING.toString()]:new sQ(e,t)}}async handleMessage(e,t){const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{const{stream:n,connection:s}=e,i=()=>{n.abort(new Xh)};let o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",i);const a=ky(n).pb(rl);try{for(;;){const c=await a.read({signal:o}),l=this.metrics?.rpcTime?.timer(c.type.toString()),u=this.metrics?.rpcTime?.timer(c.type.toString());let h=!1;try{this.log("incoming %s from %p",c.type,s.remotePeer);const d=await this.handleMessage(s.remotePeer,c);d!=null&&await a.write(d,{signal:o})}catch(d){throw h=!0,u?.(),d}finally{h||l?.()}o.removeEventListener("abort",i),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",i)}}catch(c){n.abort(c)}}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};class aQ extends Tt{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:s}=t;this.components=e,this.log=e.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class cQ{dht;constructor(e){this.dht=e}async provide(e,t={}){await Si(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Si(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new Ut("Could not find value for key")}}class lQ{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new Ut("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const uQ=32,hQ=64;class dQ extends Tt{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const n=t.logPrefix??"libp2p:kad-dht",s=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",o={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??o5,this.a=t.alpha??Z0,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??$G,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??uQ,this.maxOutboundStreams=t.maxOutboundStreams??hQ,this.peerInfoMapper=t.peerInfoMapper??cY,this.onPeerConnectTimeout=t.onPeerConnectTimeout??HG,this.providers=new xY(e,{...t.providers,logPrefix:n,datastorePrefix:s}),this.validators={...oY,...t.validators},this.selectors={...sY,...t.selectors},this.network=new SY(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new XY(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const a=Fe();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new CY(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new _Y(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new bY(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:s}),this.contentRouting=new EY(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new JY(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new oQ(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new aQ(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new DY(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:o}),this.reprovider=new RY(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:s,contentRouting:this.contentRouting,operationMetrics:o}),this.network.addEventListener("peer",c=>{const l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{const l=c.detail;Promise.resolve().then(async()=>{const u=await this.components.peerStore.get(l),h={id:l,multiaddrs:u.addresses.map(({multiaddr:d})=>d),protocols:u.protocols};await this.onPeerConnect(h)}).catch(u=>{this.log.error("could not add %p to routing table - %e - %e",l,u)})}),this.dhtPeerRouting=new lQ(this),this.dhtContentRouting=new cQ(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const l=c.detail.peer.addresses.some(({multiaddr:h})=>wY(h)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode",l)})}),this.get=Tc(this.get.bind(this),o,"GET_VALUE"),this.findProviders=Tc(this.findProviders.bind(this),o,"FIND_PROVIDERS"),this.findPeer=Tc(this.findPeer.bind(this),o,"FIND_PEER"),this.getClosestPeers=Tc(this.getClosestPeers.bind(this),o,"GET_CLOSEST_PEERS"),this.provide=Tc(this.provide.bind(this),o,"PROVIDE"),this.put=Tc(this.put.bind(this),o,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[Jt]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[yo]=["@libp2p/identify","@libp2p/ping"];get[al](){return this.dhtContentRouting}get[cl](){return this.dhtPeerRouting}get[mh](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await bi(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await bi(this.querySelf))}async stop(){this.running=!1,await Ro(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var eb;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(eb||(eb={}));function fQ(r={}){return e=>new dQ(e,r)}var je;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(je||(je={}));const a5=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),tb=Object.freeze({NEW_STREAM:je.NEW_STREAM,MESSAGE:je.MESSAGE_INITIATOR,CLOSE:je.CLOSE_INITIATOR,RESET:je.RESET_INITIATOR}),pQ=Object.freeze({MESSAGE:je.MESSAGE_RECEIVER,CLOSE:je.CLOSE_RECEIVER,RESET:je.RESET_RECEIVER}),jI=1<<20,gQ=4<<20;let mQ=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=jI,t=gQ){this._buffer=new Pe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new mt("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}const{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:n,type:s};(s===je.NEW_STREAM||s===je.MESSAGE_INITIATOR||s===je.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=nb(e),{value:s,offset:i}=nb(e,n),o=t&7;if(a5[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw new mt("Message size too large");return{id:t>>3,type:o,offset:n+i,length:s}}};const yQ=128,rb=127;function nb(r,e=0){let t=0,n=0,s=e,i;const o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&rb)<<n:(i&rb)*Math.pow(2,n),n+=7}while(i>=yQ);return e=s-e,{value:t,offset:e}}const Kg=10*1024;let wQ=class{_pool;_poolOffset;constructor(){this._pool=xr(Kg),this._poolOffset=0}write(e,t){const n=this._pool;let s=this._poolOffset;Yr(e.id<<3|e.type,n,s),s+=tt(e.id<<3|e.type),(e.type===je.NEW_STREAM||e.type===je.MESSAGE_INITIATOR||e.type===je.MESSAGE_RECEIVER)&&e.data!=null?(Yr(e.data.length,n,s),s+=tt(e.data.length)):(Yr(0,n,s),s+=tt(0));const i=n.subarray(this._poolOffset,s);Kg-s<100?(this._pool=xr(Kg),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===je.NEW_STREAM||e.type===je.MESSAGE_INITIATOR||e.type===je.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const bQ=new wQ;async function*vQ(r){for await(const e of r){const t=new Pe;bQ.write(e,t),yield t}}class EQ extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}class SQ extends r5{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?tb:pQ,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:tb.NEW_STREAM,data:new Pe(ne(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function _Q(r){const{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=jI}=r;return new SQ({id:i==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:s,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${i}:${e}`)})}const xQ=1024,AQ=1024,IQ=1024*1024*4,TQ=5,kQ=500;function sb(r){const e={...r,type:`${a5[r.type]} (${r.type})`};return r.type===je.NEW_STREAM&&(e.data=re(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===je.MESSAGE_INITIATOR||r.type===je.MESSAGE_RECEIVER)&&(e.data=re(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class CQ{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??kQ,this.sink=this._createSink(),this._source=Vn({objectMode:!0,onEnd:()=>{for(const n of this._streams.initiators.values())n.destroy();for(const n of this._streams.receivers.values())n.destroy()}}),this.source=bn(this._source,n=>vQ(n)),this.closeController=new AbortController,this.rateLimiter=new $_({points:t.disconnectThreshold??TQ,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Bc("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;const t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){const{id:t,name:n,type:s,registry:i}=e;if(this.log("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??AQ))throw new M4("Too many outbound streams open");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);const c=_Q({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",s,t,sb(l)),this._source.push(l)},type:s,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",s,t,c.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(t,c),c}_createSink(){return async t=>{const n=()=>{_I(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{const s=new mQ(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of t)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){this.log("error in sink",s),this._source.end(s)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){const{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",sb(e)),e.type===je.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??xQ)){this.log("too many inbound streams open"),this._source.push({id:t,type:je.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:re(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){this.log("missing stream %s for message type %s",t,a5[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??IQ;try{switch(n){case je.MESSAGE_INITIATOR:case je.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o)throw this._source.push({id:e.id,type:n===je.MESSAGE_INITIATOR?je.RESET_RECEIVER:je.RESET_INITIATOR}),new EQ("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");i.sourcePush(e.data);break;case je.CLOSE_INITIATOR:case je.CLOSE_RECEIVER:i.remoteCloseWrite();break;case je.RESET_INITIATOR:case je.RESET_RECEIVER:i.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),i.abort(a)}}}class PQ{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[Jt]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new CQ(this.components,{...e,...this._init})}}function DQ(r={}){return e=>new PQ(e,r)}const qg=32,RQ="1.0.0",NQ="ping",OQ="ipfs",MQ=1e4,LQ=2,BQ=1;class $Q{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??OQ}/${NQ}/${RQ}`,this.timeout=t.timeout??MQ,this.maxInboundStreams=t.maxInboundStreams??LQ,this.maxOutboundStreams=t.maxOutboundStreams??BQ,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[Jt]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now(),s=$1(t);let i=!1;Promise.resolve().then(async()=>{for(;;){const o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{t?.abort(new Xh("ping timeout"))});const a=await s.read({bytes:qg,signal:o});await s.write(a,{signal:o}),i=!0}}).catch(o=>{i&&o.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,o),t?.abort(o))}).finally(()=>{const o=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o);const a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t?.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),s=vo(qg),i=await this.components.connectionManager.openConnection(e,t);let o;if(t.signal==null){const a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{o=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const a=$1(o),[,c]=await Promise.all([a.write(s,t),a.read({...t,bytes:qg})]),l=Date.now()-n;if(!$e(s,c.subarray()))throw new FP(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",i.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",i.remotePeer,a),o?.abort(a),a}finally{o!=null&&await o.close(t)}}}function GI(r={}){return e=>new $Q(e,r)}var Ur;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(n){n.codec=()=>Zr(e)}(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=Ae((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.flag!=null&&(s.uint32(8),r.Flag.codec().encode(n.flag,s)),n.message!=null&&(s.uint32(18),s.bytes(n.message)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.flag=r.Flag.codec().decode(n);break}case 2:{o.message=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,s)=>_e(n,r.codec(),s)})(Ur||(Ur={}));const UQ=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],ib=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),FQ="libp2p+webrtc+v1/",VQ=466,KQ=2*1024*1024,qQ=30*1e3,J0=16*1024;function HQ(r=J0){const e=tt(r-tt(r)),t=1+tt(Object.keys(Ur.Flag).length-1),n=1,s=r-e-t-n,i=tt(s);return e+t+n+i}const zQ=HQ(),WQ=5e3,jQ=5e3,GQ=3e4,YI="/webrtc",Cy="/webrtc-signaling/0.0.1",YQ="/libp2p/webrtc-direct/certificate",QQ="webrtc-direct-certificate-private-key",XQ=12096e5,ob=864e5;function ZQ(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var QI={exports:{}},Ot=QI.exports={},As,Is;function Py(){throw new Error("setTimeout has not been defined")}function Dy(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?As=setTimeout:As=Py}catch{As=Py}try{typeof clearTimeout=="function"?Is=clearTimeout:Is=Dy}catch{Is=Dy}})();function XI(r){if(As===setTimeout)return setTimeout(r,0);if((As===Py||!As)&&setTimeout)return As=setTimeout,setTimeout(r,0);try{return As(r,0)}catch{try{return As.call(null,r,0)}catch{return As.call(this,r,0)}}}function JQ(r){if(Is===clearTimeout)return clearTimeout(r);if((Is===Dy||!Is)&&clearTimeout)return Is=clearTimeout,clearTimeout(r);try{return Is(r)}catch{try{return Is.call(null,r)}catch{return Is.call(this,r)}}}var ui=[],nl=!1,fa,jf=-1;function eX(){!nl||!fa||(nl=!1,fa.length?ui=fa.concat(ui):jf=-1,ui.length&&ZI())}function ZI(){if(!nl){var r=XI(eX);nl=!0;for(var e=ui.length;e;){for(fa=ui,ui=[];++jf<e;)fa&&fa[jf].run();jf=-1,e=ui.length}fa=null,nl=!1,JQ(r)}}Ot.nextTick=function(r){var e=new Array(arguments.length-1);if(arguments.length>1)for(var t=1;t<arguments.length;t++)e[t-1]=arguments[t];ui.push(new JI(r,e)),ui.length===1&&!nl&&XI(ZI)};function JI(r,e){this.fun=r,this.array=e}JI.prototype.run=function(){this.fun.apply(null,this.array)};Ot.title="browser";Ot.browser=!0;Ot.env={};Ot.argv=[];Ot.version="";Ot.versions={};function Oi(){}Ot.on=Oi;Ot.addListener=Oi;Ot.once=Oi;Ot.off=Oi;Ot.removeListener=Oi;Ot.removeAllListeners=Oi;Ot.emit=Oi;Ot.prependListener=Oi;Ot.prependOnceListener=Oi;Ot.listeners=function(r){return[]};Ot.binding=function(r){throw new Error("process.binding is not supported")};Ot.cwd=function(){return"/"};Ot.chdir=function(r){throw new Error("process.chdir is not supported")};Ot.umask=function(){return 0};var tX=QI.exports;const Gf=ZQ(tX);var ab=function(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},rX=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}(),nX=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=Gf.platform}return r}(),sX=function(){function r(e,t,n,s){this.name=e,this.version=t,this.os=n,this.bot=s,this.type="bot-device"}return r}(),iX=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}(),oX=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}(),aX=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,cX=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,cb=3,lX=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",aX]],lb=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function uX(r){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new oX:typeof navigator<"u"?dX(navigator.userAgent):pX()}function hX(r){return r!==""&&lX.reduce(function(e,t){var n=t[0],s=t[1];if(e)return e;var i=s.exec(r);return!!i&&[n,i]},!1)}function dX(r){var e=hX(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new iX;var s=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);s?s.length<cb&&(s=ab(ab([],s,!0),gX(cb-s.length),!0)):s=[];var i=s.join("."),o=fX(r),a=cX.exec(r);return a&&a[1]?new sX(t,i,o,a[1]):new rX(t,i,o)}function fX(r){for(var e=0,t=lb.length;e<t;e++){var n=lb[e],s=n[0],i=n[1],o=i.exec(r);if(o)return s}return null}function pX(){var r=typeof Gf<"u"&&Gf.version;return r?new nX(Gf.version.slice(1)):null}function gX(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}const ub=uX(),c5=ub!=null&&ub.name==="firefox",eT=async function*(){},tT=async r=>{};function mX(r,e,t=GQ,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);const s=Fe();let i=!1;r.bufferedAmountLowThreshold=0;const o=()=>{i||(n.log("%s drain channel closed before drain",e),s.resolve())};r.addEventListener("close",o,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",o),s.resolve()}),await f0(s.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(s=>{n.log.error("error closing outbound stream",s)})}async function hb(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??UQ.map(e=>({urls:[e]})),r}const yX=(r=32)=>FQ+[...Array(r)].map(()=>ib.at(Math.floor(Math.random()*ib.length))).join("");class Ry{log;peerConnection;remoteAddr;timeline;metrics;source=eT();sink=tT;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection,s=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",s),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}const wX=8,l5=1024*1024*4;let bX=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},rT=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},vX=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},db=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function nT(r){return r[Symbol.asyncIterator]!=null}function sT(r,e){if(r.byteLength>e)throw new rT("Message length too long")}const e2=r=>{const e=tt(r),t=xr(e);return Yr(r,t),e2.bytes=e,t};e2.bytes=0;function Ny(r,e){e=e??{};const t=e.lengthEncoder??e2,n=e?.maxDataLength??l5;function*s(i){sT(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return nT(r)?async function*(){for await(const i of r)yield*s(i)}():function*(){for(const i of r)yield*s(i)}()}Ny.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??e2,n=e?.maxDataLength??l5;return sT(r,n),new Pe(t(r.byteLength),r)};var na;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(na||(na={}));const u5=r=>{const e=Di(r);return u5.bytes=tt(e),e};u5.bytes=0;function Oy(r,e){const t=new Pe;let n=na.LENGTH,s=-1;const i=e?.lengthDecoder??u5,o=e?.maxLengthLength??wX,a=e?.maxDataLength??l5;function*c(){for(;t.byteLength>0;){if(n===na.LENGTH)try{if(s=i(t),s<0)throw new bX("Invalid message length");if(s>a)throw new rT("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=na.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new vX("Message length length too long");break}throw l}if(n===na.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=na.LENGTH}}}return nT(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new db("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new db("Unexpected end of input")}()}Oy.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return Oy(n,{...e??{},onLength:i=>{t=i}})};class EX extends r5{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){const t=e.onEnd;switch(e.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await f0(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),t?.(s)}).catch(i=>{this.log.error("error ending stream",i)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=Vn(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??qQ,this.maxBufferedAmount=e.maxBufferedAmount??KQ,this.maxMessageSize=(e.maxMessageSize??J0)-zQ,this.receiveFinAck=Fe(),this.finAckTimeout=e.closeTimeout??WQ,this.openTimeout=e.openTimeout??jQ,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new Cm("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const i=s.error;this.abort(i)},this.channel.onmessage=async s=>{const{data:i}=s;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};const n=this;Promise.resolve().then(async()=>{for await(const s of Oy(this.incomingData)){const i=n.processIncomingProtobuf(s);i!=null&&n.sourcePush(new Pe(i))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new Cm(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const n=AbortSignal.timeout(this.openTimeout),s=Je([this.closeController.signal,n]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Pr(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){const n=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=Je([this.closeController.signal,n]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Pr(this.channel,"bufferedamountlow",s)}catch(i){throw n.aborted?new Xh(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):i}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(n){this.log.error("error while sending message",n)}}async sendData(e){const t=e.byteLength;for(e=e.sublist();e.byteLength>0;){const n=Math.min(e.byteLength,this.maxMessageSize),s=e.subarray(0,n),i=Ur.encode({message:s}),o=Ny.single(i);this.log.trace("sending %d/%d bytes on channel",s.byteLength,t),await this._sendMessage(o),e.consume(n)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(Ur.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(Ur.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Zt(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(Ur.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=Ur.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===Ur.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Ur.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===Ur.Flag.RESET&&this.reset(),t.flag===Ur.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===Ur.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=Ur.encode({flag:e}),n=Ny.single(t);try{return await this._sendMessage(n,!1),!0}catch(s){this.log.error("could not send flag %s - %e",e.toString(),s)}return!1}}function hp(r){const{channel:e,direction:t,handshake:n}=r;return new EX({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}class h5{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??YI,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}const s={},i=hp({channel:n,direction:"inbound",onEnd:o=>{s.onEnd(o)},logger:e.logger,...this.dataChannelOptions});s.stream=i,s.channel=n,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==i.id)},this.bufferedStreams.push(s)}}createStreamMuxer(e){return new SX(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class SX{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??YI,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}const s=n.id,i=hp({channel:n,direction:"inbound",onEnd:()=>{this.#e(i,n),this.log("incoming channel %s ended",s)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),mX(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}source=eT();sink=tT;newStream(){const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const n=hp({channel:e,direction:"outbound",onEnd:()=>{this.#e(n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),this.metrics?.increment({outgoing_stream:!0}),n}}const iT=globalThis.RTCPeerConnection,oT=globalThis.RTCSessionDescription,_X=globalThis.RTCIceCandidate;function aT(r,e){const t=ds(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class _d extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class io extends _d{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class xX extends _d{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class AX extends _d{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class IX extends _d{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var ss;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(n){n.codec=()=>Zr(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ae((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.data!=null&&(s.uint32(18),s.string(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.data=n.string();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,s)=>_e(n,r.codec(),s)})(ss||(ss={}));const cT=async(r,e,t)=>{try{const n=Fe();for(TX(r,n);;){const s=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(s==null){t.signal?.throwIfAborted();break}if(s.type!==ss.Type.ICE_CANDIDATE)throw new mt("ICE candidate message expected");const i=JSON.parse(s.data??"null");if(i===""||i===null){t.onProgress?.(new ve("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const o=new _X(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new ve("webrtc:add-ice-candidate",o.candidate)),await r.addIceCandidate(o)}catch(a){t.log.error("%s bad candidate received",t.direction,i,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0&&d5(r)!=="connected")throw n}};function d5(r){return c5?r.iceConnectionState:r.connectionState}function TX(r,e){r[c5?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(d5(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new lE("RTCPeerConnection was closed"));break}}}async function kX({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:s,connectionManager:i,transportManager:o,log:a,logger:c,onProgress:l}){const{circuitAddress:u,targetPeer:h}=DX(s);n?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",u);const d=i.getConnections(h);let g;d.length===0?(l?.(new ve("webrtc:dial-relay")),g=await o.dial(u,{signal:t,onProgress:l})):(l?.(new ve("webrtc:reuse-relay-connection")),g=d[0]),l?.(new ve("webrtc:open-signaling-stream"));const m=await g.newStream(Cy,{signal:t,runOnLimitedConnection:!0}),b=aT(m).pb(ss),y=new iT(r),_=new h5({logger:c},{peerConnection:y,dataChannelOptions:e});try{const A=y.createDataChannel("init");y.onicecandidate=({candidate:k})=>{const D=JSON.stringify(k?.toJSON()??null);a.trace("initiator sending ICE candidate %o",k),b.write({type:ss.Type.ICE_CANDIDATE,data:D},{signal:t}).catch(F=>{a.error("error sending ICE candidate",F)})},y.onicecandidateerror=k=>{a.error("initiator ICE candidate error",k)};const R=await y.createOffer().catch(k=>{throw a.error("could not execute createOffer",k),new io("Failed to set createOffer")});a.trace("initiator send SDP offer %s",R.sdp),l?.(new ve("webrtc:send-sdp-offer")),await b.write({type:ss.Type.SDP_OFFER,data:R.sdp},{signal:t}),await y.setLocalDescription(R).catch(k=>{throw a.error("could not execute setLocalDescription",k),new io("Failed to set localDescription")}),l?.(new ve("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const I=await b.read({signal:t});if(I.type!==ss.Type.SDP_ANSWER)throw new io("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",I.data);const T=new oT({type:"answer",sdp:I.data});return await y.setRemoteDescription(T).catch(k=>{throw a.error("could not execute setRemoteDescription",k),new io("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new ve("webrtc:read-ice-candidates")),await cT(y,b,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),A.close(),l?.(new ve("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:y,muxerFactory:_}}catch(A){throw a.error("outgoing signaling error",A),y.close(),m.abort(A),A}finally{y.onicecandidate=null,y.onicecandidateerror=null}}const fb=dt(M_.matchers[0],pt(ic));class f5 extends Tt{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>fb.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof f5)).map(e=>e.getAddrs().filter(t=>fb.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function CX({peerConnection:r,stream:e,signal:t,connection:n,log:s}){s.trace("new inbound signaling stream");const i=aT(e).pb(ss);try{r.onicecandidate=({candidate:u})=>{const h=JSON.stringify(u?.toJSON()??null);s.trace("recipient sending ICE candidate %s",h),i.write({type:ss.Type.ICE_CANDIDATE,data:h},{signal:t}).catch(d=>{s.error("error sending ICE candidate",d)})},s.trace("recipient read SDP offer");const a=await i.read({signal:t});if(a.type!==ss.Type.SDP_OFFER)throw new io(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);s.trace("recipient received SDP offer %s",a.data);const c=new oT({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(u=>{throw s.error("could not execute setRemoteDescription",u),new io("Failed to set remoteDescription")});const l=await r.createAnswer().catch(u=>{throw s.error("could not execute createAnswer",u),new io("Failed to create answer")});s.trace("recipient send SDP answer %s",l.sdp),await i.write({type:ss.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(u=>{throw s.error("could not execute setLocalDescription",u),new io("Failed to set localDescription")}),s.trace("recipient read candidates until connected"),await cT(r,i,{direction:"recipient",signal:t,log:s})}catch(a){if(d5(r)!=="connected")throw s.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}const o=Ie(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",o),{remoteAddress:o}}class PX{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[n0]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[Jt]=["@libp2p/transport"];[yo]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(Cy,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(Cy),this._started=!1}createListener(e){return new f5(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(jm.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:s,muxerFactory:i}=await kX({rtcConfiguration:await hb(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new Ry(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(s,o),a}async _onProtocol({connection:e,stream:t},n){const s=new iT(await hb(this.init.rtcConfiguration)),i=new h5(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o}=await CX({peerConnection:s,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const a=new Ry(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:o,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:i,signal:n}),this._closeOnShutdown(s,a)}catch(o){throw this.log.error("incoming signaling error",o),s.close(),t.abort(o),o}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function DX(r){const e=r.getComponents().filter(({name:n})=>n==="p2p").map(({value:n})=>n).pop();if(e==null)throw new te("Destination peer id was missing");return{circuitAddress:Ie(r.getComponents().filter(({name:n})=>n!=="webrtc")),targetPeer:Ht(e)}}const Sf=globalThis||void 0||self;/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var pb;(function(r){(function(e){var t=typeof globalThis=="object"?globalThis:typeof A1=="object"?A1:typeof self=="object"?self:typeof this=="object"?this:a(),n=s(r);typeof t.Reflect<"u"&&(n=s(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function s(c,l){return function(u,h){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:h}),l&&l(u,h)}}function i(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||o()}})(function(e,t){var n=Object.prototype.hasOwnProperty,s=typeof Symbol=="function",i=s&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=s&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return E(Object.create(null))}:c?function(){return E({__proto__:null})}:function(){return E({})},has:l?function(f,p){return n.call(f,p)}:function(f,p){return p in f},get:l?function(f,p){return n.call(f,p)?f[p]:void 0}:function(f,p){return f[p]}},h=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:bc(),g=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:In(),m=typeof WeakMap=="function"?WeakMap:yu(),b=s?Symbol.for("@reflect-metadata:registry"):void 0,y=wc(),_=gs(y);function A(f,p,v,x){if(j(v)){if(!Te(f))throw new TypeError;if(!Mt(p))throw new TypeError;return P(f,p)}else{if(!Te(f))throw new TypeError;if(!fe(p))throw new TypeError;if(!fe(x)&&!j(x)&&!we(x))throw new TypeError;return we(x)&&(x=void 0),v=lt(v),M(f,p,v,x)}}e("decorate",A);function R(f,p){function v(x,L){if(!fe(x))throw new TypeError;if(!j(L)&&!Ft(L))throw new TypeError;z(f,p,x,L)}return v}e("metadata",R);function I(f,p,v,x){if(!fe(v))throw new TypeError;return j(x)||(x=lt(x)),z(f,p,v,x)}e("defineMetadata",I);function T(f,p,v){if(!fe(p))throw new TypeError;return j(v)||(v=lt(v)),K(f,p,v)}e("hasMetadata",T);function k(f,p,v){if(!fe(p))throw new TypeError;return j(v)||(v=lt(v)),H(f,p,v)}e("hasOwnMetadata",k);function D(f,p,v){if(!fe(p))throw new TypeError;return j(v)||(v=lt(v)),$(f,p,v)}e("getMetadata",D);function F(f,p,v){if(!fe(p))throw new TypeError;return j(v)||(v=lt(v)),B(f,p,v)}e("getOwnMetadata",F);function O(f,p){if(!fe(f))throw new TypeError;return j(p)||(p=lt(p)),q(f,p)}e("getMetadataKeys",O);function C(f,p){if(!fe(f))throw new TypeError;return j(p)||(p=lt(p)),Y(f,p)}e("getOwnMetadataKeys",C);function N(f,p,v){if(!fe(p))throw new TypeError;if(j(v)||(v=lt(v)),!fe(p))throw new TypeError;j(v)||(v=lt(v));var x=Wn(p,v,!1);return j(x)?!1:x.OrdinaryDeleteMetadata(f,p,v)}e("deleteMetadata",N);function P(f,p){for(var v=f.length-1;v>=0;--v){var x=f[v],L=x(p);if(!j(L)&&!we(L)){if(!Mt(L))throw new TypeError;p=L}}return p}function M(f,p,v,x){for(var L=f.length-1;L>=0;--L){var W=f[L],pe=W(p,v,x);if(!j(pe)&&!we(pe)){if(!fe(pe))throw new TypeError;x=pe}}return x}function K(f,p,v){var x=H(f,p,v);if(x)return!0;var L=$i(p);return we(L)?!1:K(f,L,v)}function H(f,p,v){var x=Wn(p,v,!1);return j(x)?!1:Oe(x.OrdinaryHasOwnMetadata(f,p,v))}function $(f,p,v){var x=H(f,p,v);if(x)return B(f,p,v);var L=$i(p);if(!we(L))return $(f,L,v)}function B(f,p,v){var x=Wn(p,v,!1);if(!j(x))return x.OrdinaryGetOwnMetadata(f,p,v)}function z(f,p,v,x){var L=Wn(v,x,!0);L.OrdinaryDefineOwnMetadata(f,p,v,x)}function q(f,p){var v=Y(f,p),x=$i(f);if(x===null)return v;var L=q(x,p);if(L.length<=0)return v;if(v.length<=0)return L;for(var W=new g,pe=[],ge=0,X=v;ge<X.length;ge++){var Z=X[ge],J=W.has(Z);J||(W.add(Z),pe.push(Z))}for(var me=0,Re=L;me<Re.length;me++){var Z=Re[me],J=W.has(Z);J||(W.add(Z),pe.push(Z))}return pe}function Y(f,p){var v=Wn(f,p,!1);return v?v.OrdinaryOwnMetadataKeys(f,p):[]}function Q(f){if(f===null)return 1;switch(typeof f){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return f===null?1:6;default:return 6}}function j(f){return f===void 0}function we(f){return f===null}function ue(f){return typeof f=="symbol"}function fe(f){return typeof f=="object"?f!==null:typeof f=="function"}function ce(f,p){switch(Q(f)){case 0:return f;case 1:return f;case 2:return f;case 3:return f;case 4:return f;case 5:return f}var v="string",x=rn(f,i);if(x!==void 0){var L=x.call(f,v);if(fe(L))throw new TypeError;return L}return ke(f)}function ke(f,p){var v,x,L;{var W=f.toString;if(Ke(W)){var x=W.call(f);if(!fe(x))return x}var v=f.valueOf;if(Ke(v)){var x=v.call(f);if(!fe(x))return x}}throw new TypeError}function Oe(f){return!!f}function ot(f){return""+f}function lt(f){var p=ce(f);return ue(p)?p:ot(p)}function Te(f){return Array.isArray?Array.isArray(f):f instanceof Object?f instanceof Array:Object.prototype.toString.call(f)==="[object Array]"}function Ke(f){return typeof f=="function"}function Mt(f){return typeof f=="function"}function Ft(f){switch(Q(f)){case 3:return!0;case 4:return!0;default:return!1}}function Dt(f,p){return f===p||f!==f&&p!==p}function rn(f,p){var v=f[p];if(v!=null){if(!Ke(v))throw new TypeError;return v}}function nn(f){var p=rn(f,o);if(!Ke(p))throw new TypeError;var v=p.call(f);if(!fe(v))throw new TypeError;return v}function $o(f){return f.value}function yc(f){var p=f.next();return p.done?!1:p}function Ws(f){var p=f.return;p&&p.call(f)}function $i(f){var p=Object.getPrototypeOf(f);if(typeof f!="function"||f===h||p!==h)return p;var v=f.prototype,x=v&&Object.getPrototypeOf(v);if(x==null||x===Object.prototype)return p;var L=x.constructor;return typeof L!="function"||L===f?p:L}function Uo(){var f;!j(b)&&typeof t.Reflect<"u"&&!(b in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(f=Br(t.Reflect));var p,v,x,L=new m,W={registerProvider:pe,getProvider:X,setProvider:J};return W;function pe(me){if(!Object.isExtensible(W))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case f===me:break;case j(p):p=me;break;case p===me:break;case j(v):v=me;break;case v===me:break;default:x===void 0&&(x=new g),x.add(me);break}}function ge(me,Re){if(!j(p)){if(p.isProviderFor(me,Re))return p;if(!j(v)){if(v.isProviderFor(me,Re))return p;if(!j(x))for(var at=nn(x);;){var _t=yc(at);if(!_t)return;var jn=$o(_t);if(jn.isProviderFor(me,Re))return Ws(at),jn}}}if(!j(f)&&f.isProviderFor(me,Re))return f}function X(me,Re){var at=L.get(me),_t;return j(at)||(_t=at.get(Re)),j(_t)&&(_t=ge(me,Re),j(_t)||(j(at)&&(at=new d,L.set(me,at)),at.set(Re,_t))),_t}function Z(me){if(j(me))throw new TypeError;return p===me||v===me||!j(x)&&x.has(me)}function J(me,Re,at){if(!Z(at))throw new Error("Metadata provider not registered.");var _t=X(me,Re);if(_t!==at){if(!j(_t))return!1;var jn=L.get(me);j(jn)&&(jn=new d,L.set(me,jn)),jn.set(Re,at)}return!0}}function wc(){var f;return!j(b)&&fe(t.Reflect)&&Object.isExtensible(t.Reflect)&&(f=t.Reflect[b]),j(f)&&(f=Uo()),!j(b)&&fe(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,b,{enumerable:!1,configurable:!1,writable:!1,value:f}),f}function gs(f){var p=new m,v={isProviderFor:function(Z,J){var me=p.get(Z);return j(me)?!1:me.has(J)},OrdinaryDefineOwnMetadata:pe,OrdinaryHasOwnMetadata:L,OrdinaryGetOwnMetadata:W,OrdinaryOwnMetadataKeys:ge,OrdinaryDeleteMetadata:X};return y.registerProvider(v),v;function x(Z,J,me){var Re=p.get(Z),at=!1;if(j(Re)){if(!me)return;Re=new d,p.set(Z,Re),at=!0}var _t=Re.get(J);if(j(_t)){if(!me)return;if(_t=new d,Re.set(J,_t),!f.setProvider(Z,J,v))throw Re.delete(J),at&&p.delete(Z),new Error("Wrong provider for target.")}return _t}function L(Z,J,me){var Re=x(J,me,!1);return j(Re)?!1:Oe(Re.has(Z))}function W(Z,J,me){var Re=x(J,me,!1);if(!j(Re))return Re.get(Z)}function pe(Z,J,me,Re){var at=x(me,Re,!0);at.set(Z,J)}function ge(Z,J){var me=[],Re=x(Z,J,!1);if(j(Re))return me;for(var at=Re.keys(),_t=nn(at),jn=0;;){var f8=yc(_t);if(!f8)return me.length=jn,me;var fC=$o(f8);try{me[jn]=fC}catch(pC){try{Ws(_t)}finally{throw pC}}jn++}}function X(Z,J,me){var Re=x(J,me,!1);if(j(Re)||!Re.delete(Z))return!1;if(Re.size===0){var at=p.get(J);j(at)||(at.delete(me),at.size===0&&p.delete(at))}return!0}}function Br(f){var p=f.defineMetadata,v=f.hasOwnMetadata,x=f.getOwnMetadata,L=f.getOwnMetadataKeys,W=f.deleteMetadata,pe=new m,ge={isProviderFor:function(X,Z){var J=pe.get(X);return!j(J)&&J.has(Z)?!0:L(X,Z).length?(j(J)&&(J=new g,pe.set(X,J)),J.add(Z),!0):!1},OrdinaryDefineOwnMetadata:p,OrdinaryHasOwnMetadata:v,OrdinaryGetOwnMetadata:x,OrdinaryOwnMetadataKeys:L,OrdinaryDeleteMetadata:W};return ge}function Wn(f,p,v){var x=y.getProvider(f,p);if(!j(x))return x;if(v){if(y.setProvider(f,p,_))return _;throw new Error("Illegal state.")}}function bc(){var f={},p=[],v=function(){function ge(X,Z,J){this._index=0,this._keys=X,this._values=Z,this._selector=J}return ge.prototype["@@iterator"]=function(){return this},ge.prototype[o]=function(){return this},ge.prototype.next=function(){var X=this._index;if(X>=0&&X<this._keys.length){var Z=this._selector(this._keys[X],this._values[X]);return X+1>=this._keys.length?(this._index=-1,this._keys=p,this._values=p):this._index++,{value:Z,done:!1}}return{value:void 0,done:!0}},ge.prototype.throw=function(X){throw this._index>=0&&(this._index=-1,this._keys=p,this._values=p),X},ge.prototype.return=function(X){return this._index>=0&&(this._index=-1,this._keys=p,this._values=p),{value:X,done:!0}},ge}(),x=function(){function ge(){this._keys=[],this._values=[],this._cacheKey=f,this._cacheIndex=-2}return Object.defineProperty(ge.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),ge.prototype.has=function(X){return this._find(X,!1)>=0},ge.prototype.get=function(X){var Z=this._find(X,!1);return Z>=0?this._values[Z]:void 0},ge.prototype.set=function(X,Z){var J=this._find(X,!0);return this._values[J]=Z,this},ge.prototype.delete=function(X){var Z=this._find(X,!1);if(Z>=0){for(var J=this._keys.length,me=Z+1;me<J;me++)this._keys[me-1]=this._keys[me],this._values[me-1]=this._values[me];return this._keys.length--,this._values.length--,Dt(X,this._cacheKey)&&(this._cacheKey=f,this._cacheIndex=-2),!0}return!1},ge.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=f,this._cacheIndex=-2},ge.prototype.keys=function(){return new v(this._keys,this._values,L)},ge.prototype.values=function(){return new v(this._keys,this._values,W)},ge.prototype.entries=function(){return new v(this._keys,this._values,pe)},ge.prototype["@@iterator"]=function(){return this.entries()},ge.prototype[o]=function(){return this.entries()},ge.prototype._find=function(X,Z){if(!Dt(this._cacheKey,X)){this._cacheIndex=-1;for(var J=0;J<this._keys.length;J++)if(Dt(this._keys[J],X)){this._cacheIndex=J;break}}return this._cacheIndex<0&&Z&&(this._cacheIndex=this._keys.length,this._keys.push(X),this._values.push(void 0)),this._cacheIndex},ge}();return x;function L(ge,X){return ge}function W(ge,X){return X}function pe(ge,X){return[ge,X]}}function In(){var f=function(){function p(){this._map=new d}return Object.defineProperty(p.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),p.prototype.has=function(v){return this._map.has(v)},p.prototype.add=function(v){return this._map.set(v,v),this},p.prototype.delete=function(v){return this._map.delete(v)},p.prototype.clear=function(){this._map.clear()},p.prototype.keys=function(){return this._map.keys()},p.prototype.values=function(){return this._map.keys()},p.prototype.entries=function(){return this._map.entries()},p.prototype["@@iterator"]=function(){return this.keys()},p.prototype[o]=function(){return this.keys()},p}();return f}function yu(){var f=16,p=u.create(),v=x();return function(){function X(){this._key=x()}return X.prototype.has=function(Z){var J=L(Z,!1);return J!==void 0?u.has(J,this._key):!1},X.prototype.get=function(Z){var J=L(Z,!1);return J!==void 0?u.get(J,this._key):void 0},X.prototype.set=function(Z,J){var me=L(Z,!0);return me[this._key]=J,this},X.prototype.delete=function(Z){var J=L(Z,!1);return J!==void 0?delete J[this._key]:!1},X.prototype.clear=function(){this._key=x()},X}();function x(){var X;do X="@@WeakMap@@"+ge();while(u.has(p,X));return p[X]=!0,X}function L(X,Z){if(!n.call(X,v)){if(!Z)return;Object.defineProperty(X,v,{value:u.create()})}return X[v]}function W(X,Z){for(var J=0;J<Z;++J)X[J]=Math.random()*255|0;return X}function pe(X){if(typeof Uint8Array=="function"){var Z=new Uint8Array(X);return typeof crypto<"u"?crypto.getRandomValues(Z):typeof msCrypto<"u"?msCrypto.getRandomValues(Z):W(Z,X),Z}return W(new Array(X),X)}function ge(){var X=pe(f);X[6]=X[6]&79|64,X[8]=X[8]&191|128;for(var Z="",J=0;J<f;++J){var me=X[J];(J===4||J===6||J===8)&&(Z+="-"),me<16&&(Z+="0"),Z+=me.toString(16).toLowerCase()}return Z}}function E(f){return f.__=void 0,delete f.__,f}})})(pb||(pb={}));var G;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(G||(G={}));var U;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(U||(U={}));class t2{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(oe.isBufferSource(e))this.unusedBits=t,this.value=oe.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof Ta))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new Ta({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new Ta({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;const s=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let i=0;for(;i<n;)s[i]=parseInt(t.slice(i<<3,(i<<3)+8),2),i++;this.value=s.buffer}}class qe{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):oe.isBufferSource(e)?this.buffer=oe.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof ns))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new ns({valueHex:this.buffer})}toSchema(e){return new ns({name:e})}}const RX={fromASN:r=>r instanceof _i?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new _i;const e=mi(r);if(e.result.error)throw new Error(e.result.error);return e.result}},NX={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new yi({value:+r})},OX={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new B0({value:r})},yt={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new yi({valueHex:r})},MX={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Ta({valueHex:r})},LX={fromASN:r=>r.valueBlock.toString(),toASN:r=>new ai({value:r})},BX={fromASN:r=>r.valueBlock.value,toASN:r=>new L0({value:r})},dp={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new ns({valueHex:r})},$X={fromASN:r=>new qe(r.getValue()),toASN:r=>r.toASN()};function zn(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}const lT=zn(Ni),UX=zn($0),FX=zn(U0),VX=zn(F0),KX=zn(V0),qX=zn(K0),HX=zn(q0),zX=zn(H0),WX=zn(z0),jX=zn(bd),GX=zn(W0),YX=zn(j0),QX={fromASN:r=>r.toDate(),toASN:r=>new vd({valueDate:r})},XX={fromASN:r=>r.toDate(),toASN:r=>new G0({valueDate:r})},ZX={fromASN:()=>null,toASN:()=>new _i};function oh(r){switch(r){case U.Any:return RX;case U.BitString:return MX;case U.BmpString:return UX;case U.Boolean:return BX;case U.CharacterString:return YX;case U.Enumerated:return OX;case U.GeneralString:return GX;case U.GeneralizedTime:return XX;case U.GraphicString:return WX;case U.IA5String:return zX;case U.Integer:return NX;case U.Null:return ZX;case U.NumericString:return VX;case U.ObjectIdentifier:return LX;case U.OctetString:return dp;case U.PrintableString:return KX;case U.TeletexString:return qX;case U.UTCTime:return QX;case U.UniversalString:return FX;case U.Utf8String:return lT;case U.VideotexString:return HX;case U.VisibleString:return jX;default:return null}}function hi(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:hi(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function uT(r){var e;if(r){const t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:uT(t)}return!1}function JX(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<r.byteLength;s++)if(t[s]!==n[s])return!1;return!0}class eZ{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:G.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){const n=this.items.get(e)||this.createDefault(e),s=[];for(const i in n.items){const o=n.items[i],a=t?i:"";let c;if(typeof o.type=="number"){const u=U[o.type],h=oI[u];if(!h)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new h({name:a})}else hi(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===G.Choice?c=new Fa({name:a}):(c=this.create(o.type,!1),c.name=a):c=new Fa({name:a});const l=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const u=o.repeated==="set"?Os:Bt;c=new u({name:"",value:[new X1({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||hi(o.type)){const u=o.repeated?Dr:wd;s.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const u=!!o.repeated;let h=u?c:this.get(o.type,!0).schema;h="valueBlock"in h?h.valueBlock.value:h.value,s.push(new Dr({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:h}))}else s.push(new Dr({optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=l,s.push(c)}switch(n.type){case G.Sequence:return new Bt({value:s,name:""});case G.Set:return new Os({value:s,name:""});case G.Choice:return new Z6({value:s,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const qt=new eZ,ee=r=>e=>{let t;qt.has(e)?t=qt.get(e):(t=qt.createDefault(e),qt.set(e,t)),Object.assign(t,r)},S=r=>(e,t)=>{let n;qt.has(e.constructor)?n=qt.get(e.constructor):(n=qt.createDefault(e.constructor),qt.set(e.constructor,n));const s=Object.assign({},r);if(typeof s.type=="number"&&!s.converter){const i=oh(r.type);if(!i)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);s.converter=i}n.items[t]=s};class ku extends Error{constructor(){super(...arguments),this.schemas=[]}}class tZ{static parse(e,t){const n=mi(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){try{if(hi(t))return new t().fromASN(e);const n=qt.get(t);qt.cache(t);let s=n.schema;const i=this.handleChoiceTypes(e,n,t,s);if(i?.result)return i.result;i?.targetSchema&&(s=i.targetSchema);const o=this.handleSequenceTypes(e,n,t,s);if(o&&"isManualMapping"in o)return o.result;const a=o,c=new t;return uT(t)?this.handleArrayTypes(e,n,t):(this.processSchemaItems(n,a,c),c)}catch(n){throw n instanceof ku&&n.schemas.push(t.name),n}}static handleChoiceTypes(e,t,n,s){if(e.constructor===Dr&&t.type===G.Choice&&e.idBlock.tagClass===3)for(const i in t.items){const o=t.items[i];if(o.context===e.idBlock.tagNumber&&o.implicit&&typeof o.type=="function"&&qt.has(o.type)){const a=qt.get(o.type);if(a&&a.type===G.Sequence){const c=new Bt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;const l=this.fromASN(c,o.type),u=new n;return u[i]=l,{result:u}}}}}else if(e.constructor===Dr&&t.type!==G.Choice){const i=new Dr({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(const o in t.items)delete e[o];return{targetSchema:i}}return null}static handleSequenceTypes(e,t,n,s){if(t.type===G.Sequence){if(Object.keys(t.items).filter(a=>{const c=t.items[a];return c.optional&&typeof c.type=="function"&&qt.has(c.type)&&qt.get(c.type).type===G.Choice}).length>0&&"value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&n.name==="CertReqMsg")return this.handleManualMapping(e,t,n);const o=no({},e,s);if(!o.verified)throw new ku(`Data does not match to ${n.name} ASN1 schema. ${o.result.error}`);return o}else{const i=no({},e,s);if(!i.verified)throw new ku(`Data does not match to ${n.name} ASN1 schema. ${i.result.error}`);return i}}static handleManualMapping(e,t,n){const s=new n,i=e.valueBlock.value,o=Object.keys(t.items);let a=0;for(let c=0;c<o.length;c++){const l=o[c],u=t.items[l];if(a>=i.length)break;if(u.repeated){s[l]=this.processRepeatedField(i,a,u);break}else if(typeof u.type=="number")s[l]=this.processPrimitiveField(i[a],u),a++;else if(this.isOptionalChoiceField(u)){const h=this.processOptionalChoiceField(i[a],u);h.processed&&(s[l]=h.value,a++)}else s[l]=this.fromASN(i[a],u.type),a++}return{result:s,verified:!0,isManualMapping:!0}}static processRepeatedField(e,t,n){let s=e.slice(t);if(s.length===1&&s[0].constructor.name==="Sequence"){const i=s[0];i.valueBlock&&i.valueBlock.value&&Array.isArray(i.valueBlock.value)&&(s=i.valueBlock.value)}if(typeof n.type=="number"){const i=oh(n.type);if(!i)throw new Error(`No converter for ASN.1 type ${n.type}`);return s.filter(o=>o&&o.valueBlock).map(o=>{try{return i.fromASN(o)}catch{return}}).filter(o=>o!==void 0)}else return s.filter(i=>i&&i.valueBlock).map(i=>{try{return this.fromASN(i,n.type)}catch{return}}).filter(i=>i!==void 0)}static processPrimitiveField(e,t){const n=oh(t.type);if(!n)throw new Error(`No converter for ASN.1 type ${t.type}`);return n.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&qt.has(e.type)&&qt.get(e.type).type===G.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(n){if(n instanceof ku&&/Wrong values for Choice type/.test(n.message))return{processed:!1};throw n}}static handleArrayTypes(e,t,n){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const s=t.itemType;if(typeof s=="number"){const i=oh(s);if(!i)throw new Error(`Cannot get default converter for array item of ${n.name} ASN1 schema`);return n.from(e.valueBlock.value,o=>i.fromASN(o))}else return n.from(e.valueBlock.value,i=>this.fromASN(i,s))}static processSchemaItems(e,t,n){for(const s in e.items){const i=t.result[s];if(!i)continue;const o=e.items[s],a=o.type;typeof a=="number"||hi(a)?n[s]=this.processPrimitiveSchemaItem(i,o,a):n[s]=this.processComplexSchemaItem(i,o,a)}}static processPrimitiveSchemaItem(e,t,n){var s;const i=(s=t.converter)!==null&&s!==void 0?s:hi(n)?new n:null;if(!i)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,i):this.processSinglePrimitiveItem(e,t,n,i)}static processRepeatedPrimitiveItem(e,t,n){if(t.implicit){const s=t.repeated==="sequence"?Bt:Os,i=new s;i.valueBlock=e.valueBlock;const o=mi(i.toBER(!1));if(o.offset===-1)throw new Error(`Cannot parse the child item. ${o.result.error}`);if(!("value"in o.result.valueBlock&&Array.isArray(o.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const a=o.result.valueBlock.value;return Array.from(a,c=>n.fromASN(c))}else return Array.from(e,s=>n.fromASN(s))}static processSinglePrimitiveItem(e,t,n,s){let i=e;if(t.implicit){let o;if(hi(n))o=new n().toSchema("");else{const a=U[n],c=oI[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);o=new c}o.valueBlock=i.valueBlock,i=mi(o.toBER(!1)).result}return s.fromASN(i)}static processComplexSchemaItem(e,t,n){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,s=>this.fromASN(s,n))}else{const s=this.handleImplicitTagging(e,t,n);if(this.isOptionalChoiceField(t))try{return this.fromASN(s,n)}catch(i){if(i instanceof ku&&/Wrong values for Choice type/.test(i.message))return;throw i}else return this.fromASN(s,n)}}static handleImplicitTagging(e,t,n){if(t.implicit&&typeof t.context=="number"){const s=qt.get(n);if(s.type===G.Sequence){const i=new Bt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}else if(s.type===G.Set){const i=new Os;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}}return e}}class p5{static serialize(e){return e instanceof ur?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&hi(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,n=qt.get(t);qt.cache(t);let s=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){const o=oh(n.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);s=e.map(a=>o.toASN(a))}else s=e.map(o=>this.toAsnItem({type:n.itemType},"[]",t,o))}else for(const o in n.items){const a=n.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&JX(this.serialize(a.defaultValue),this.serialize(c)))continue;const l=p5.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||hi(a.type))){const u={};u.valueHex=l instanceof _i?l.valueBeforeDecodeView:l.valueBlock.toBER(),s.push(new wd({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else s.push(new Dr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else s.push(new Dr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?s=s.concat(l):s.push(l)}let i;switch(n.type){case G.Sequence:i=new Bt({value:s});break;case G.Set:i=new Os({value:s});break;case G.Choice:if(!s[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);i=s[0];break}return i}static toAsnItem(e,t,n,s){let i;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${U[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(s))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(s,l=>o.toASN(l)),c=e.repeated==="sequence"?Bt:Os;i=new c({value:a})}else i=o.toASN(s)}else if(e.repeated){if(!Array.isArray(s))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(s,c=>this.toASN(c)),a=e.repeated==="sequence"?Bt:Os;i=new a({value:o})}else i=this.toASN(s);return i}}class rt extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class ie{static serialize(e){return p5.serialize(e)}static parse(e,t){return tZ.parse(e,t)}static toString(e){const t=oe.isBufferSource(e)?oe.toArrayBuffer(e):ie.serialize(e),n=mi(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}}function w(r,e,t,n){var s=arguments.length,i=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(i=(s<3?o(i):s>3?o(e,t,i):o(e,t))||i);return s>3&&i&&Object.defineProperty(e,t,i),i}class gb{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{const s=parseInt(n,10);if(isNaN(s)||s<0||s>255)throw new Error("Invalid IPv4 address part");return s})}static parseIPv6(e){const n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((s,i)=>{const o=parseInt(i,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return s.push(o>>8&255),s.push(o&255),s},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const n=t[0]?t[0].split(":"):[],s=t[1]?t[1].split(":"):[],i=8-(n.length+s.length);if(i<0)throw new Error("Invalid IPv6 address");return[...n,...Array(i).fill("0"),...s].join(":")}static formatIPv6(e){const t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let n=-1,s=0,i=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(i===-1&&(i=a),o++):(o>s&&(n=i,s=o),i=-1,o=0);if(o>s&&(n=i,s=o),s>1){const a=t.slice(0,n).join(":"),c=t.slice(n+s).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,n]=e.split("/"),s=parseInt(n,10);if(this.isIPv4(t)){if(s<0||s>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),s]}else{if(s<0||s>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),s]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((s,i)=>s+ +i,0);let n=e.slice(0,8).replace(/(.{2})/g,s=>`${parseInt(s,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const n=t.length/2,s=t.slice(0,n),i=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=i.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(s).join(".")}/${a}`:`${this.formatIPv6(s)}/${a}`}return this.decodeIP(ye.ToHex(e))}static fromString(e){if(e.includes("/")){const[n,s]=this.parseCIDR(e),i=new Uint8Array(n.length);let o=s;for(let c=0;c<i.length;c++)o>=8?(i[c]=255,o-=8):o>0&&(i[c]=255<<8-o,o=0);const a=new Uint8Array(n.length*2);return a.set(n,0),a.set(i,n.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var My,Ly,By;let hr=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};w([S({type:U.TeletexString})],hr.prototype,"teletexString",void 0);w([S({type:U.PrintableString})],hr.prototype,"printableString",void 0);w([S({type:U.UniversalString})],hr.prototype,"universalString",void 0);w([S({type:U.Utf8String})],hr.prototype,"utf8String",void 0);w([S({type:U.BmpString})],hr.prototype,"bmpString",void 0);hr=w([ee({type:G.Choice})],hr);let Cl=class extends hr{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?ye.ToHex(this.anyValue):super.toString())}};w([S({type:U.IA5String})],Cl.prototype,"ia5String",void 0);w([S({type:U.Any})],Cl.prototype,"anyValue",void 0);Cl=w([ee({type:G.Choice})],Cl);class r2{constructor(e={}){this.type="",this.value=new Cl,Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],r2.prototype,"type",void 0);w([S({type:Cl})],r2.prototype,"value",void 0);let Pl=My=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,My.prototype)}};Pl=My=w([ee({type:G.Set,itemType:r2})],Pl);let $y=Ly=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,Ly.prototype)}};$y=Ly=w([ee({type:G.Sequence,itemType:Pl})],$y);let Rt=By=class extends $y{constructor(e){super(e),Object.setPrototypeOf(this,By.prototype)}};Rt=By=w([ee({type:G.Sequence})],Rt);const rZ={fromASN:r=>gb.toString(dp.fromASN(r)),toASN:r=>dp.toASN(gb.fromString(r))};class $h{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],$h.prototype,"typeId",void 0);w([S({type:U.Any,context:0})],$h.prototype,"value",void 0);class g5{constructor(e={}){this.partyName=new hr,Object.assign(this,e)}}w([S({type:hr,optional:!0,context:0,implicit:!0})],g5.prototype,"nameAssigner",void 0);w([S({type:hr,context:1,implicit:!0})],g5.prototype,"partyName",void 0);let Ce=class{constructor(e={}){Object.assign(this,e)}};w([S({type:$h,context:0,implicit:!0})],Ce.prototype,"otherName",void 0);w([S({type:U.IA5String,context:1,implicit:!0})],Ce.prototype,"rfc822Name",void 0);w([S({type:U.IA5String,context:2,implicit:!0})],Ce.prototype,"dNSName",void 0);w([S({type:U.Any,context:3,implicit:!0})],Ce.prototype,"x400Address",void 0);w([S({type:Rt,context:4,implicit:!1})],Ce.prototype,"directoryName",void 0);w([S({type:g5,context:5})],Ce.prototype,"ediPartyName",void 0);w([S({type:U.IA5String,context:6,implicit:!0})],Ce.prototype,"uniformResourceIdentifier",void 0);w([S({type:U.OctetString,context:7,implicit:!0,converter:rZ})],Ce.prototype,"iPAddress",void 0);w([S({type:U.ObjectIdentifier,context:8,implicit:!0})],Ce.prototype,"registeredID",void 0);Ce=w([ee({type:G.Choice})],Ce);const m5="1.3.6.1.5.5.7",nZ=`${m5}.1`,iu=`${m5}.3`,n2=`${m5}.48`,mb=`${n2}.1`,yb=`${n2}.2`,wb=`${n2}.3`,bb=`${n2}.5`,Mi="2.5.29";var Uy;const Fy=`${nZ}.1`;class xd{constructor(e={}){this.accessMethod="",this.accessLocation=new Ce,Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],xd.prototype,"accessMethod",void 0);w([S({type:Ce})],xd.prototype,"accessLocation",void 0);let qc=Uy=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,Uy.prototype)}};qc=Uy=w([ee({type:G.Sequence,itemType:xd})],qc);const Vy=`${Mi}.35`;class y5 extends qe{}class pa{constructor(e={}){e&&Object.assign(this,e)}}w([S({type:y5,context:0,optional:!0,implicit:!0})],pa.prototype,"keyIdentifier",void 0);w([S({type:Ce,context:1,optional:!0,implicit:!0,repeated:"sequence"})],pa.prototype,"authorityCertIssuer",void 0);w([S({type:U.Integer,context:2,optional:!0,implicit:!0,converter:yt})],pa.prototype,"authorityCertSerialNumber",void 0);const hT=`${Mi}.19`;class fp{constructor(e={}){this.cA=!1,Object.assign(this,e)}}w([S({type:U.Boolean,defaultValue:!1})],fp.prototype,"cA",void 0);w([S({type:U.Integer,optional:!0})],fp.prototype,"pathLenConstraint",void 0);var Ky;let _r=Ky=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,Ky.prototype)}};_r=Ky=w([ee({type:G.Sequence,itemType:Ce})],_r);var qy;let vb=qy=class extends _r{constructor(e){super(e),Object.setPrototypeOf(this,qy.prototype)}};vb=qy=w([ee({type:G.Sequence})],vb);var Hy;const dT=`${Mi}.32`;let Ai=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};w([S({type:U.IA5String})],Ai.prototype,"ia5String",void 0);w([S({type:U.VisibleString})],Ai.prototype,"visibleString",void 0);w([S({type:U.BmpString})],Ai.prototype,"bmpString",void 0);w([S({type:U.Utf8String})],Ai.prototype,"utf8String",void 0);Ai=w([ee({type:G.Choice})],Ai);class w5{constructor(e={}){this.organization=new Ai,this.noticeNumbers=[],Object.assign(this,e)}}w([S({type:Ai})],w5.prototype,"organization",void 0);w([S({type:U.Integer,repeated:"sequence"})],w5.prototype,"noticeNumbers",void 0);class b5{constructor(e={}){Object.assign(this,e)}}w([S({type:w5,optional:!0})],b5.prototype,"noticeRef",void 0);w([S({type:Ai,optional:!0})],b5.prototype,"explicitText",void 0);let pp=class{constructor(e={}){Object.assign(this,e)}};w([S({type:U.IA5String})],pp.prototype,"cPSuri",void 0);w([S({type:b5})],pp.prototype,"userNotice",void 0);pp=w([ee({type:G.Choice})],pp);class v5{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],v5.prototype,"policyQualifierId",void 0);w([S({type:U.Any})],v5.prototype,"qualifier",void 0);class s2{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],s2.prototype,"policyIdentifier",void 0);w([S({type:v5,repeated:"sequence",optional:!0})],s2.prototype,"policyQualifiers",void 0);let gp=Hy=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,Hy.prototype)}};gp=Hy=w([ee({type:G.Sequence,itemType:s2})],gp);let mp=class{constructor(e=0){this.value=e}};w([S({type:U.Integer})],mp.prototype,"value",void 0);mp=w([ee({type:G.Choice})],mp);let Eb=class extends mp{};Eb=w([ee({type:G.Choice})],Eb);var zy;const Wy=`${Mi}.31`;var Jn;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(Jn||(Jn={}));class fT extends t2{toJSON(){const e=[],t=this.toNumber();return t&Jn.aACompromise&&e.push("aACompromise"),t&Jn.affiliationChanged&&e.push("affiliationChanged"),t&Jn.cACompromise&&e.push("cACompromise"),t&Jn.certificateHold&&e.push("certificateHold"),t&Jn.cessationOfOperation&&e.push("cessationOfOperation"),t&Jn.keyCompromise&&e.push("keyCompromise"),t&Jn.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&Jn.superseded&&e.push("superseded"),t&Jn.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let qa=class{constructor(e={}){Object.assign(this,e)}};w([S({type:Ce,context:0,repeated:"sequence",implicit:!0})],qa.prototype,"fullName",void 0);w([S({type:Pl,context:1,implicit:!0})],qa.prototype,"nameRelativeToCRLIssuer",void 0);qa=w([ee({type:G.Choice})],qa);class ou{constructor(e={}){Object.assign(this,e)}}w([S({type:qa,context:0,optional:!0})],ou.prototype,"distributionPoint",void 0);w([S({type:fT,context:1,optional:!0,implicit:!0})],ou.prototype,"reasons",void 0);w([S({type:Ce,context:2,optional:!0,repeated:"sequence",implicit:!0})],ou.prototype,"cRLIssuer",void 0);let sl=zy=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,zy.prototype)}};sl=zy=w([ee({type:G.Sequence,itemType:ou})],sl);var jy;let Sb=jy=class extends sl{constructor(e){super(e),Object.setPrototypeOf(this,jy.prototype)}};Sb=jy=w([ee({type:G.Sequence,itemType:ou})],Sb);class Sr{constructor(e={}){this.onlyContainsUserCerts=Sr.ONLY,this.onlyContainsCACerts=Sr.ONLY,this.indirectCRL=Sr.ONLY,this.onlyContainsAttributeCerts=Sr.ONLY,Object.assign(this,e)}}Sr.ONLY=!1;w([S({type:qa,context:0,optional:!0})],Sr.prototype,"distributionPoint",void 0);w([S({type:U.Boolean,context:1,defaultValue:Sr.ONLY,implicit:!0})],Sr.prototype,"onlyContainsUserCerts",void 0);w([S({type:U.Boolean,context:2,defaultValue:Sr.ONLY,implicit:!0})],Sr.prototype,"onlyContainsCACerts",void 0);w([S({type:fT,context:3,optional:!0,implicit:!0})],Sr.prototype,"onlySomeReasons",void 0);w([S({type:U.Boolean,context:4,defaultValue:Sr.ONLY,implicit:!0})],Sr.prototype,"indirectCRL",void 0);w([S({type:U.Boolean,context:5,defaultValue:Sr.ONLY,implicit:!0})],Sr.prototype,"onlyContainsAttributeCerts",void 0);var ah;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(ah||(ah={}));let Gy=class{constructor(e=ah.unspecified){this.reason=ah.unspecified,this.reason=e}toJSON(){return ah[this.reason]}toString(){return this.toJSON()}};w([S({type:U.Enumerated})],Gy.prototype,"reason",void 0);Gy=w([ee({type:G.Choice})],Gy);var Yy;const pT=`${Mi}.37`;let yp=Yy=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,Yy.prototype)}};yp=Yy=w([ee({type:G.Sequence,itemType:U.ObjectIdentifier})],yp);const sZ=`${iu}.1`,iZ=`${iu}.2`,oZ=`${iu}.3`,aZ=`${iu}.4`,cZ=`${iu}.8`,lZ=`${iu}.9`;let Qy=class{constructor(e=new ArrayBuffer(0)){this.value=e}};w([S({type:U.Integer,converter:yt})],Qy.prototype,"value",void 0);Qy=w([ee({type:G.Choice})],Qy);let Xy=class{constructor(e){this.value=new Date,e&&(this.value=e)}};w([S({type:U.GeneralizedTime})],Xy.prototype,"value",void 0);Xy=w([ee({type:G.Choice})],Xy);var Zy;const gT=`${Mi}.18`;let _b=Zy=class extends _r{constructor(e){super(e),Object.setPrototypeOf(this,Zy.prototype)}};_b=Zy=w([ee({type:G.Sequence})],_b);const mT=`${Mi}.15`;var es;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(es||(es={}));class Hg extends t2{toJSON(){const e=this.toNumber(),t=[];return e&es.cRLSign&&t.push("crlSign"),e&es.dataEncipherment&&t.push("dataEncipherment"),e&es.decipherOnly&&t.push("decipherOnly"),e&es.digitalSignature&&t.push("digitalSignature"),e&es.encipherOnly&&t.push("encipherOnly"),e&es.keyAgreement&&t.push("keyAgreement"),e&es.keyCertSign&&t.push("keyCertSign"),e&es.keyEncipherment&&t.push("keyEncipherment"),e&es.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var Jy;class i2{constructor(e={}){this.base=new Ce,this.minimum=0,Object.assign(this,e)}}w([S({type:Ce})],i2.prototype,"base",void 0);w([S({type:U.Integer,context:0,defaultValue:0,implicit:!0})],i2.prototype,"minimum",void 0);w([S({type:U.Integer,context:1,optional:!0,implicit:!0})],i2.prototype,"maximum",void 0);let wp=Jy=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,Jy.prototype)}};wp=Jy=w([ee({type:G.Sequence,itemType:i2})],wp);class yT{constructor(e={}){Object.assign(this,e)}}w([S({type:wp,context:0,optional:!0,implicit:!0})],yT.prototype,"permittedSubtrees",void 0);w([S({type:wp,context:1,optional:!0,implicit:!0})],yT.prototype,"excludedSubtrees",void 0);class wT{constructor(e={}){Object.assign(this,e)}}w([S({type:U.Integer,context:0,implicit:!0,optional:!0,converter:yt})],wT.prototype,"requireExplicitPolicy",void 0);w([S({type:U.Integer,context:1,implicit:!0,optional:!0,converter:yt})],wT.prototype,"inhibitPolicyMapping",void 0);var e3;class E5{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],E5.prototype,"issuerDomainPolicy",void 0);w([S({type:U.ObjectIdentifier})],E5.prototype,"subjectDomainPolicy",void 0);let xb=e3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,e3.prototype)}};xb=e3=w([ee({type:G.Sequence,itemType:E5})],xb);var t3;const bT=`${Mi}.17`;let r3=t3=class extends _r{constructor(e){super(e),Object.setPrototypeOf(this,t3.prototype)}};r3=t3=w([ee({type:G.Sequence})],r3);let Ii=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};w([S({type:U.ObjectIdentifier})],Ii.prototype,"type",void 0);w([S({type:U.Any,repeated:"set"})],Ii.prototype,"values",void 0);var n3;let Ab=n3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,n3.prototype)}};Ab=n3=w([ee({type:G.Sequence,itemType:Ii})],Ab);const vT=`${Mi}.14`;class fo extends y5{}class ET{constructor(e={}){Object.assign(this,e)}}w([S({type:U.GeneralizedTime,context:0,implicit:!0,optional:!0})],ET.prototype,"notBefore",void 0);w([S({type:U.GeneralizedTime,context:1,implicit:!0,optional:!0})],ET.prototype,"notAfter",void 0);var ch;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(ch||(ch={}));class ST extends t2{toJSON(){const e=[],t=this.toNumber();return t&ch.pKIXCertificate&&e.push("pKIXCertificate"),t&ch.newExtensions&&e.push("newExtensions"),t&ch.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class _T{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new ST,Object.assign(this,e)}}w([S({type:U.GeneralString})],_T.prototype,"entrustVers",void 0);w([S({type:ST})],_T.prototype,"entrustInfoFlags",void 0);var s3;let Ib=s3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,s3.prototype)}};Ib=s3=w([ee({type:G.Sequence,itemType:xd})],Ib);class he{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof he&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&uA(e.parameters,this.parameters)||e.parameters===this.parameters)}}w([S({type:U.ObjectIdentifier})],he.prototype,"algorithm",void 0);w([S({type:U.Any,optional:!0})],he.prototype,"parameters",void 0);class is{constructor(e={}){this.algorithm=new he,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:he})],is.prototype,"algorithm",void 0);w([S({type:U.BitString})],is.prototype,"subjectPublicKey",void 0);let cr=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};w([S({type:U.UTCTime})],cr.prototype,"utcTime",void 0);w([S({type:U.GeneralizedTime})],cr.prototype,"generalTime",void 0);cr=w([ee({type:G.Choice})],cr);class Ad{constructor(e){this.notBefore=new cr(new Date),this.notAfter=new cr(new Date),e&&(this.notBefore=new cr(e.notBefore),this.notAfter=new cr(e.notAfter))}}w([S({type:cr})],Ad.prototype,"notBefore",void 0);w([S({type:cr})],Ad.prototype,"notAfter",void 0);var i3;let qn=class xT{constructor(e={}){this.extnID="",this.critical=xT.CRITICAL,this.extnValue=new qe,Object.assign(this,e)}};qn.CRITICAL=!1;w([S({type:U.ObjectIdentifier})],qn.prototype,"extnID",void 0);w([S({type:U.Boolean,defaultValue:qn.CRITICAL})],qn.prototype,"critical",void 0);w([S({type:qe})],qn.prototype,"extnValue",void 0);let To=i3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,i3.prototype)}};To=i3=w([ee({type:G.Sequence,itemType:qn})],To);var Ha;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(Ha||(Ha={}));class _n{constructor(e={}){this.version=Ha.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new he,this.issuer=new Rt,this.validity=new Ad,this.subject=new Rt,this.subjectPublicKeyInfo=new is,Object.assign(this,e)}}w([S({type:U.Integer,context:0,defaultValue:Ha.v1})],_n.prototype,"version",void 0);w([S({type:U.Integer,converter:yt})],_n.prototype,"serialNumber",void 0);w([S({type:he})],_n.prototype,"signature",void 0);w([S({type:Rt})],_n.prototype,"issuer",void 0);w([S({type:Ad})],_n.prototype,"validity",void 0);w([S({type:Rt})],_n.prototype,"subject",void 0);w([S({type:is})],_n.prototype,"subjectPublicKeyInfo",void 0);w([S({type:U.BitString,context:1,implicit:!0,optional:!0})],_n.prototype,"issuerUniqueID",void 0);w([S({type:U.BitString,context:2,implicit:!0,optional:!0})],_n.prototype,"subjectUniqueID",void 0);w([S({type:To,context:3,optional:!0})],_n.prototype,"extensions",void 0);class za{constructor(e={}){this.tbsCertificate=new _n,this.signatureAlgorithm=new he,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:_n})],za.prototype,"tbsCertificate",void 0);w([S({type:he})],za.prototype,"signatureAlgorithm",void 0);w([S({type:U.BitString})],za.prototype,"signatureValue",void 0);class o2{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new cr,Object.assign(this,e)}}w([S({type:U.Integer,converter:yt})],o2.prototype,"userCertificate",void 0);w([S({type:cr})],o2.prototype,"revocationDate",void 0);w([S({type:qn,optional:!0,repeated:"sequence"})],o2.prototype,"crlEntryExtensions",void 0);class Li{constructor(e={}){this.signature=new he,this.issuer=new Rt,this.thisUpdate=new cr,Object.assign(this,e)}}w([S({type:U.Integer,optional:!0})],Li.prototype,"version",void 0);w([S({type:he})],Li.prototype,"signature",void 0);w([S({type:Rt})],Li.prototype,"issuer",void 0);w([S({type:cr})],Li.prototype,"thisUpdate",void 0);w([S({type:cr,optional:!0})],Li.prototype,"nextUpdate",void 0);w([S({type:o2,repeated:"sequence",optional:!0})],Li.prototype,"revokedCertificates",void 0);w([S({type:qn,optional:!0,context:0,repeated:"sequence"})],Li.prototype,"crlExtensions",void 0);class S5{constructor(e={}){this.tbsCertList=new Li,this.signatureAlgorithm=new he,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:Li})],S5.prototype,"tbsCertList",void 0);w([S({type:he})],S5.prototype,"signatureAlgorithm",void 0);w([S({type:U.BitString})],S5.prototype,"signature",void 0);class au{constructor(e={}){this.issuer=new Rt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:Rt})],au.prototype,"issuer",void 0);w([S({type:U.Integer,converter:yt})],au.prototype,"serialNumber",void 0);let Dl=class{constructor(e={}){Object.assign(this,e)}};w([S({type:fo,context:0,implicit:!0})],Dl.prototype,"subjectKeyIdentifier",void 0);w([S({type:au})],Dl.prototype,"issuerAndSerialNumber",void 0);Dl=w([ee({type:G.Choice})],Dl);var Ti;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(Ti||(Ti={}));let Uh=class extends he{};Uh=w([ee({type:G.Sequence})],Uh);let bp=class extends he{};bp=w([ee({type:G.Sequence})],bp);let Us=class extends he{};Us=w([ee({type:G.Sequence})],Us);let vp=class extends he{};vp=w([ee({type:G.Sequence})],vp);let Tb=class extends he{};Tb=w([ee({type:G.Sequence})],Tb);let o3=class extends he{};o3=w([ee({type:G.Sequence})],o3);let cu=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};w([S({type:U.ObjectIdentifier})],cu.prototype,"attrType",void 0);w([S({type:U.Any,repeated:"set"})],cu.prototype,"attrValues",void 0);var a3;class Ks{constructor(e={}){this.version=Ti.v0,this.sid=new Dl,this.digestAlgorithm=new Uh,this.signatureAlgorithm=new bp,this.signature=new qe,Object.assign(this,e)}}w([S({type:U.Integer})],Ks.prototype,"version",void 0);w([S({type:Dl})],Ks.prototype,"sid",void 0);w([S({type:Uh})],Ks.prototype,"digestAlgorithm",void 0);w([S({type:cu,repeated:"set",context:0,implicit:!0,optional:!0})],Ks.prototype,"signedAttrs",void 0);w([S({type:bp})],Ks.prototype,"signatureAlgorithm",void 0);w([S({type:qe})],Ks.prototype,"signature",void 0);w([S({type:cu,repeated:"set",context:1,implicit:!0,optional:!0})],Ks.prototype,"unsignedAttrs",void 0);let Ep=a3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,a3.prototype)}};Ep=a3=w([ee({type:G.Set,itemType:Ks})],Ep);let kb=class extends cr{};kb=w([ee({type:G.Choice})],kb);let Cb=class extends Ks{};Cb=w([ee({type:G.Sequence})],Cb);class _5{constructor(e={}){this.acIssuer=new Ce,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}w([S({type:Ce})],_5.prototype,"acIssuer",void 0);w([S({type:U.Integer})],_5.prototype,"acSerial",void 0);w([S({type:Ii,repeated:"sequence"})],_5.prototype,"attrs",void 0);var c3;let Sp=c3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,c3.prototype)}};Sp=c3=w([ee({type:G.Sequence,itemType:U.ObjectIdentifier})],Sp);class a2{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}w([S({type:U.Integer,optional:!0})],a2.prototype,"pathLenConstraint",void 0);w([S({type:Sp,implicit:!0,context:0,optional:!0})],a2.prototype,"permittedAttrs",void 0);w([S({type:Sp,implicit:!0,context:1,optional:!0})],a2.prototype,"excludedAttrs",void 0);w([S({type:U.Boolean,defaultValue:!0})],a2.prototype,"permitUnSpecified",void 0);class pc{constructor(e={}){this.issuer=new _r,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:_r})],pc.prototype,"issuer",void 0);w([S({type:U.Integer,converter:yt})],pc.prototype,"serial",void 0);w([S({type:U.BitString,optional:!0})],pc.prototype,"issuerUID",void 0);var l3;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(l3||(l3={}));class gc{constructor(e={}){this.digestedObjectType=l3.publicKey,this.digestAlgorithm=new he,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.Enumerated})],gc.prototype,"digestedObjectType",void 0);w([S({type:U.ObjectIdentifier,optional:!0})],gc.prototype,"otherObjectTypeID",void 0);w([S({type:he})],gc.prototype,"digestAlgorithm",void 0);w([S({type:U.BitString})],gc.prototype,"objectDigest",void 0);class c2{constructor(e={}){Object.assign(this,e)}}w([S({type:_r,optional:!0})],c2.prototype,"issuerName",void 0);w([S({type:pc,context:0,implicit:!0,optional:!0})],c2.prototype,"baseCertificateID",void 0);w([S({type:gc,context:1,implicit:!0,optional:!0})],c2.prototype,"objectDigestInfo",void 0);let Rl=class{constructor(e={}){Object.assign(this,e)}};w([S({type:Ce,repeated:"sequence"})],Rl.prototype,"v1Form",void 0);w([S({type:c2,context:0,implicit:!0})],Rl.prototype,"v2Form",void 0);Rl=w([ee({type:G.Choice})],Rl);class l2{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}w([S({type:U.GeneralizedTime})],l2.prototype,"notBeforeTime",void 0);w([S({type:U.GeneralizedTime})],l2.prototype,"notAfterTime",void 0);class Id{constructor(e={}){Object.assign(this,e)}}w([S({type:pc,implicit:!0,context:0,optional:!0})],Id.prototype,"baseCertificateID",void 0);w([S({type:_r,implicit:!0,context:1,optional:!0})],Id.prototype,"entityName",void 0);w([S({type:gc,implicit:!0,context:2,optional:!0})],Id.prototype,"objectDigestInfo",void 0);var u3;(function(r){r[r.v2=1]="v2"})(u3||(u3={}));class ps{constructor(e={}){this.version=u3.v2,this.holder=new Id,this.issuer=new Rl,this.signature=new he,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new l2,this.attributes=[],Object.assign(this,e)}}w([S({type:U.Integer})],ps.prototype,"version",void 0);w([S({type:Id})],ps.prototype,"holder",void 0);w([S({type:Rl})],ps.prototype,"issuer",void 0);w([S({type:he})],ps.prototype,"signature",void 0);w([S({type:U.Integer,converter:yt})],ps.prototype,"serialNumber",void 0);w([S({type:l2})],ps.prototype,"attrCertValidityPeriod",void 0);w([S({type:Ii,repeated:"sequence"})],ps.prototype,"attributes",void 0);w([S({type:U.BitString,optional:!0})],ps.prototype,"issuerUniqueID",void 0);w([S({type:To,optional:!0})],ps.prototype,"extensions",void 0);class u2{constructor(e={}){this.acinfo=new ps,this.signatureAlgorithm=new he,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:ps})],u2.prototype,"acinfo",void 0);w([S({type:he})],u2.prototype,"signatureAlgorithm",void 0);w([S({type:U.BitString})],u2.prototype,"signatureValue",void 0);var _p;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(_p||(_p={}));class h3 extends t2{}class x5{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier,implicit:!0,context:0})],x5.prototype,"type",void 0);w([S({type:U.Any,implicit:!0,context:1})],x5.prototype,"value",void 0);class A5{constructor(e={}){this.policyId="",this.classList=new h3(_p.unclassified),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],A5.prototype,"policyId",void 0);w([S({type:h3,defaultValue:new h3(_p.unclassified)})],A5.prototype,"classList",void 0);w([S({type:x5,repeated:"set"})],A5.prototype,"securityCategories",void 0);class h2{constructor(e={}){Object.assign(this,e)}}w([S({type:qe})],h2.prototype,"cotets",void 0);w([S({type:U.ObjectIdentifier})],h2.prototype,"oid",void 0);w([S({type:U.Utf8String})],h2.prototype,"string",void 0);class AT{constructor(e={}){this.values=[],Object.assign(this,e)}}w([S({type:_r,implicit:!0,context:0,optional:!0})],AT.prototype,"policyAuthority",void 0);w([S({type:h2,repeated:"sequence"})],AT.prototype,"values",void 0);var d3;class d2{constructor(e={}){this.targetCertificate=new pc,Object.assign(this,e)}}w([S({type:pc})],d2.prototype,"targetCertificate",void 0);w([S({type:Ce,optional:!0})],d2.prototype,"targetName",void 0);w([S({type:gc,optional:!0})],d2.prototype,"certDigestInfo",void 0);let Nl=class{constructor(e={}){Object.assign(this,e)}};w([S({type:Ce,context:0,implicit:!0})],Nl.prototype,"targetName",void 0);w([S({type:Ce,context:1,implicit:!0})],Nl.prototype,"targetGroup",void 0);w([S({type:d2,context:2,implicit:!0})],Nl.prototype,"targetCert",void 0);Nl=w([ee({type:G.Choice})],Nl);let f3=d3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,d3.prototype)}};f3=d3=w([ee({type:G.Sequence,itemType:Nl})],f3);var p3;let Pb=p3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,p3.prototype)}};Pb=p3=w([ee({type:G.Sequence,itemType:f3})],Pb);class IT{constructor(e={}){Object.assign(this,e)}}w([S({type:_r,implicit:!0,context:0,optional:!0})],IT.prototype,"roleAuthority",void 0);w([S({type:Ce,implicit:!0,context:1})],IT.prototype,"roleName",void 0);class I5{constructor(e={}){this.service=new Ce,this.ident=new Ce,Object.assign(this,e)}}w([S({type:Ce})],I5.prototype,"service",void 0);w([S({type:Ce})],I5.prototype,"ident",void 0);w([S({type:qe,optional:!0})],I5.prototype,"authInfo",void 0);var g3;class T5{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],T5.prototype,"otherCertFormat",void 0);w([S({type:U.Any})],T5.prototype,"otherCert",void 0);let Ol=class{constructor(e={}){Object.assign(this,e)}};w([S({type:za})],Ol.prototype,"certificate",void 0);w([S({type:u2,context:2,implicit:!0})],Ol.prototype,"v2AttrCert",void 0);w([S({type:T5,context:3,implicit:!0})],Ol.prototype,"other",void 0);Ol=w([ee({type:G.Choice})],Ol);let xp=g3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,g3.prototype)}};xp=g3=w([ee({type:G.Set,itemType:Ol})],xp);class lu{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],lu.prototype,"contentType",void 0);w([S({type:U.Any,context:0})],lu.prototype,"content",void 0);let Fh=class{constructor(e={}){Object.assign(this,e)}};w([S({type:qe})],Fh.prototype,"single",void 0);w([S({type:U.Any})],Fh.prototype,"any",void 0);Fh=w([ee({type:G.Choice})],Fh);class f2{constructor(e={}){this.eContentType="",Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],f2.prototype,"eContentType",void 0);w([S({type:Fh,context:0,optional:!0})],f2.prototype,"eContent",void 0);let Vh=class{constructor(e={}){Object.assign(this,e)}};w([S({type:qe,context:0,implicit:!0,optional:!0})],Vh.prototype,"value",void 0);w([S({type:qe,converter:$X,context:0,implicit:!0,optional:!0,repeated:"sequence"})],Vh.prototype,"constructedValue",void 0);Vh=w([ee({type:G.Choice})],Vh);class Td{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new vp,Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],Td.prototype,"contentType",void 0);w([S({type:vp})],Td.prototype,"contentEncryptionAlgorithm",void 0);w([S({type:Vh,optional:!0})],Td.prototype,"encryptedContent",void 0);class p2{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],p2.prototype,"keyAttrId",void 0);w([S({type:U.Any,optional:!0})],p2.prototype,"keyAttr",void 0);var m3;class g2{constructor(e={}){this.subjectKeyIdentifier=new fo,Object.assign(this,e)}}w([S({type:fo})],g2.prototype,"subjectKeyIdentifier",void 0);w([S({type:U.GeneralizedTime,optional:!0})],g2.prototype,"date",void 0);w([S({type:p2,optional:!0})],g2.prototype,"other",void 0);let Ml=class{constructor(e={}){Object.assign(this,e)}};w([S({type:g2,context:0,implicit:!0,optional:!0})],Ml.prototype,"rKeyId",void 0);w([S({type:au,optional:!0})],Ml.prototype,"issuerAndSerialNumber",void 0);Ml=w([ee({type:G.Choice})],Ml);class k5{constructor(e={}){this.rid=new Ml,this.encryptedKey=new qe,Object.assign(this,e)}}w([S({type:Ml})],k5.prototype,"rid",void 0);w([S({type:qe})],k5.prototype,"encryptedKey",void 0);let Ap=m3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,m3.prototype)}};Ap=m3=w([ee({type:G.Sequence,itemType:k5})],Ap);class C5{constructor(e={}){this.algorithm=new he,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:he})],C5.prototype,"algorithm",void 0);w([S({type:U.BitString})],C5.prototype,"publicKey",void 0);let Wa=class{constructor(e={}){Object.assign(this,e)}};w([S({type:fo,context:0,implicit:!0,optional:!0})],Wa.prototype,"subjectKeyIdentifier",void 0);w([S({type:C5,context:1,implicit:!0,optional:!0})],Wa.prototype,"originatorKey",void 0);w([S({type:au,optional:!0})],Wa.prototype,"issuerAndSerialNumber",void 0);Wa=w([ee({type:G.Choice})],Wa);class uu{constructor(e={}){this.version=Ti.v3,this.originator=new Wa,this.keyEncryptionAlgorithm=new Us,this.recipientEncryptedKeys=new Ap,Object.assign(this,e)}}w([S({type:U.Integer})],uu.prototype,"version",void 0);w([S({type:Wa,context:0})],uu.prototype,"originator",void 0);w([S({type:qe,context:1,optional:!0})],uu.prototype,"ukm",void 0);w([S({type:Us})],uu.prototype,"keyEncryptionAlgorithm",void 0);w([S({type:Ap})],uu.prototype,"recipientEncryptedKeys",void 0);let Ll=class{constructor(e={}){Object.assign(this,e)}};w([S({type:fo,context:0,implicit:!0})],Ll.prototype,"subjectKeyIdentifier",void 0);w([S({type:au})],Ll.prototype,"issuerAndSerialNumber",void 0);Ll=w([ee({type:G.Choice})],Ll);class kd{constructor(e={}){this.version=Ti.v0,this.rid=new Ll,this.keyEncryptionAlgorithm=new Us,this.encryptedKey=new qe,Object.assign(this,e)}}w([S({type:U.Integer})],kd.prototype,"version",void 0);w([S({type:Ll})],kd.prototype,"rid",void 0);w([S({type:Us})],kd.prototype,"keyEncryptionAlgorithm",void 0);w([S({type:qe})],kd.prototype,"encryptedKey",void 0);class Cd{constructor(e={}){this.keyIdentifier=new qe,Object.assign(this,e)}}w([S({type:qe})],Cd.prototype,"keyIdentifier",void 0);w([S({type:U.GeneralizedTime,optional:!0})],Cd.prototype,"date",void 0);w([S({type:p2,optional:!0})],Cd.prototype,"other",void 0);class Pd{constructor(e={}){this.version=Ti.v4,this.kekid=new Cd,this.keyEncryptionAlgorithm=new Us,this.encryptedKey=new qe,Object.assign(this,e)}}w([S({type:U.Integer})],Pd.prototype,"version",void 0);w([S({type:Cd})],Pd.prototype,"kekid",void 0);w([S({type:Us})],Pd.prototype,"keyEncryptionAlgorithm",void 0);w([S({type:qe})],Pd.prototype,"encryptedKey",void 0);class Dd{constructor(e={}){this.version=Ti.v0,this.keyEncryptionAlgorithm=new Us,this.encryptedKey=new qe,Object.assign(this,e)}}w([S({type:U.Integer})],Dd.prototype,"version",void 0);w([S({type:o3,context:0,optional:!0})],Dd.prototype,"keyDerivationAlgorithm",void 0);w([S({type:Us})],Dd.prototype,"keyEncryptionAlgorithm",void 0);w([S({type:qe})],Dd.prototype,"encryptedKey",void 0);class P5{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],P5.prototype,"oriType",void 0);w([S({type:U.Any})],P5.prototype,"oriValue",void 0);let ko=class{constructor(e={}){Object.assign(this,e)}};w([S({type:kd,optional:!0})],ko.prototype,"ktri",void 0);w([S({type:uu,context:1,implicit:!0,optional:!0})],ko.prototype,"kari",void 0);w([S({type:Pd,context:2,implicit:!0,optional:!0})],ko.prototype,"kekri",void 0);w([S({type:Dd,context:3,implicit:!0,optional:!0})],ko.prototype,"pwri",void 0);w([S({type:P5,context:4,implicit:!0,optional:!0})],ko.prototype,"ori",void 0);ko=w([ee({type:G.Choice})],ko);var y3;let Ip=y3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,y3.prototype)}};Ip=y3=w([ee({type:G.Set,itemType:ko})],Ip);var w3;class m2{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],m2.prototype,"otherRevInfoFormat",void 0);w([S({type:U.Any})],m2.prototype,"otherRevInfo",void 0);let Tp=class{constructor(e={}){this.other=new m2,Object.assign(this,e)}};w([S({type:m2,context:1,implicit:!0})],Tp.prototype,"other",void 0);Tp=w([ee({type:G.Choice})],Tp);let kp=w3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,w3.prototype)}};kp=w3=w([ee({type:G.Set,itemType:Tp})],kp);class D5{constructor(e={}){Object.assign(this,e)}}w([S({type:xp,context:0,implicit:!0,optional:!0})],D5.prototype,"certs",void 0);w([S({type:kp,context:1,implicit:!0,optional:!0})],D5.prototype,"crls",void 0);var b3;let v3=b3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,b3.prototype)}};v3=b3=w([ee({type:G.Set,itemType:cu})],v3);class Rd{constructor(e={}){this.version=Ti.v0,this.recipientInfos=new Ip,this.encryptedContentInfo=new Td,Object.assign(this,e)}}w([S({type:U.Integer})],Rd.prototype,"version",void 0);w([S({type:D5,context:0,implicit:!0,optional:!0})],Rd.prototype,"originatorInfo",void 0);w([S({type:Ip})],Rd.prototype,"recipientInfos",void 0);w([S({type:Td})],Rd.prototype,"encryptedContentInfo",void 0);w([S({type:v3,context:1,implicit:!0,optional:!0})],Rd.prototype,"unprotectedAttrs",void 0);const uZ="1.2.840.113549.1.7.2";var E3;let Cp=E3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,E3.prototype)}};Cp=E3=w([ee({type:G.Set,itemType:Uh})],Cp);class hu{constructor(e={}){this.version=Ti.v0,this.digestAlgorithms=new Cp,this.encapContentInfo=new f2,this.signerInfos=new Ep,Object.assign(this,e)}}w([S({type:U.Integer})],hu.prototype,"version",void 0);w([S({type:Cp})],hu.prototype,"digestAlgorithms",void 0);w([S({type:f2})],hu.prototype,"encapContentInfo",void 0);w([S({type:xp,context:0,implicit:!0,optional:!0})],hu.prototype,"certificates",void 0);w([S({type:kp,context:1,implicit:!0,optional:!0})],hu.prototype,"crls",void 0);w([S({type:Ep})],hu.prototype,"signerInfos",void 0);const Kh="1.2.840.10045.2.1",R5="1.2.840.10045.4.1",TT="1.2.840.10045.4.3.1",N5="1.2.840.10045.4.3.2",O5="1.2.840.10045.4.3.3",M5="1.2.840.10045.4.3.4",Db="1.2.840.10045.3.1.7",Rb="1.3.132.0.34",Nb="1.3.132.0.35";function Nd(r){return new he({algorithm:r})}const hZ=Nd(R5);Nd(TT);const dZ=Nd(N5),fZ=Nd(O5),pZ=Nd(M5);let qh=class{constructor(e={}){Object.assign(this,e)}};w([S({type:U.ObjectIdentifier})],qh.prototype,"fieldType",void 0);w([S({type:U.Any})],qh.prototype,"parameters",void 0);qh=w([ee({type:G.Sequence})],qh);class gZ extends qe{}let Bl=class{constructor(e={}){Object.assign(this,e)}};w([S({type:U.OctetString})],Bl.prototype,"a",void 0);w([S({type:U.OctetString})],Bl.prototype,"b",void 0);w([S({type:U.BitString,optional:!0})],Bl.prototype,"seed",void 0);Bl=w([ee({type:G.Sequence})],Bl);var S3;(function(r){r[r.ecpVer1=1]="ecpVer1"})(S3||(S3={}));let ki=class{constructor(e={}){this.version=S3.ecpVer1,Object.assign(this,e)}};w([S({type:U.Integer})],ki.prototype,"version",void 0);w([S({type:qh})],ki.prototype,"fieldID",void 0);w([S({type:Bl})],ki.prototype,"curve",void 0);w([S({type:gZ})],ki.prototype,"base",void 0);w([S({type:U.Integer,converter:yt})],ki.prototype,"order",void 0);w([S({type:U.Integer,optional:!0})],ki.prototype,"cofactor",void 0);ki=w([ee({type:G.Sequence})],ki);let Co=class{constructor(e={}){Object.assign(this,e)}};w([S({type:U.ObjectIdentifier})],Co.prototype,"namedCurve",void 0);w([S({type:U.Null})],Co.prototype,"implicitCurve",void 0);w([S({type:ki})],Co.prototype,"specifiedCurve",void 0);Co=w([ee({type:G.Choice})],Co);class y2{constructor(e={}){this.version=1,this.privateKey=new qe,Object.assign(this,e)}}w([S({type:U.Integer})],y2.prototype,"version",void 0);w([S({type:qe})],y2.prototype,"privateKey",void 0);w([S({type:Co,context:0,optional:!0})],y2.prototype,"parameters",void 0);w([S({type:U.BitString,context:1,optional:!0})],y2.prototype,"publicKey",void 0);class Pp{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.Integer,converter:yt})],Pp.prototype,"r",void 0);w([S({type:U.Integer,converter:yt})],Pp.prototype,"s",void 0);const en="1.2.840.113549.1.1",ja=`${en}.1`,mZ=`${en}.7`,yZ=`${en}.9`,lh=`${en}.10`,wZ=`${en}.2`,bZ=`${en}.4`,Dp=`${en}.5`,vZ=`${en}.14`,_3=`${en}.11`,Rp=`${en}.12`,Np=`${en}.13`,kT=`${en}.15`,CT=`${en}.16`,Op="1.3.14.3.2.26",PT="2.16.840.1.101.3.4.2.4",Mp="2.16.840.1.101.3.4.2.1",Lp="2.16.840.1.101.3.4.2.2",Bp="2.16.840.1.101.3.4.2.3",EZ="2.16.840.1.101.3.4.2.5",SZ="2.16.840.1.101.3.4.2.6",_Z="1.2.840.113549.2.2",xZ="1.2.840.113549.2.5",w2=`${en}.8`;function jt(r){return new he({algorithm:r,parameters:null})}jt(_Z);jt(xZ);const Ga=jt(Op);jt(PT);jt(Mp);jt(Lp);jt(Bp);jt(EZ);jt(SZ);const DT=new he({algorithm:w2,parameters:ie.serialize(Ga)}),RT=new he({algorithm:yZ,parameters:ie.serialize(dp.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});jt(ja);jt(wZ);jt(bZ);jt(Dp);jt(kT);jt(CT);jt(Rp);jt(Np);jt(kT);jt(CT);class b2{constructor(e={}){this.hashAlgorithm=new he(Ga),this.maskGenAlgorithm=new he({algorithm:w2,parameters:ie.serialize(Ga)}),this.pSourceAlgorithm=new he(RT),Object.assign(this,e)}}w([S({type:he,context:0,defaultValue:Ga})],b2.prototype,"hashAlgorithm",void 0);w([S({type:he,context:1,defaultValue:DT})],b2.prototype,"maskGenAlgorithm",void 0);w([S({type:he,context:2,defaultValue:RT})],b2.prototype,"pSourceAlgorithm",void 0);new he({algorithm:mZ,parameters:ie.serialize(new b2)});class Ya{constructor(e={}){this.hashAlgorithm=new he(Ga),this.maskGenAlgorithm=new he({algorithm:w2,parameters:ie.serialize(Ga)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}w([S({type:he,context:0,defaultValue:Ga})],Ya.prototype,"hashAlgorithm",void 0);w([S({type:he,context:1,defaultValue:DT})],Ya.prototype,"maskGenAlgorithm",void 0);w([S({type:U.Integer,context:2,defaultValue:20})],Ya.prototype,"saltLength",void 0);w([S({type:U.Integer,context:3,defaultValue:1})],Ya.prototype,"trailerField",void 0);new he({algorithm:lh,parameters:ie.serialize(new Ya)});class v2{constructor(e={}){this.digestAlgorithm=new he,this.digest=new qe,Object.assign(this,e)}}w([S({type:he})],v2.prototype,"digestAlgorithm",void 0);w([S({type:qe})],v2.prototype,"digest",void 0);var x3;class E2{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.Integer,converter:yt})],E2.prototype,"prime",void 0);w([S({type:U.Integer,converter:yt})],E2.prototype,"exponent",void 0);w([S({type:U.Integer,converter:yt})],E2.prototype,"coefficient",void 0);let A3=x3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,x3.prototype)}};A3=x3=w([ee({type:G.Sequence,itemType:E2})],A3);class qs{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.Integer})],qs.prototype,"version",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"modulus",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"publicExponent",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"privateExponent",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"prime1",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"prime2",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"exponent1",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"exponent2",void 0);w([S({type:U.Integer,converter:yt})],qs.prototype,"coefficient",void 0);w([S({type:A3,optional:!0})],qs.prototype,"otherPrimeInfos",void 0);class L5{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.Integer,converter:yt})],L5.prototype,"modulus",void 0);w([S({type:U.Integer,converter:yt})],L5.prototype,"publicExponent",void 0);var I3;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(I3||(I3={}));const $r=I3;/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var T3=function(r,e){return T3=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var s in n)n.hasOwnProperty(s)&&(t[s]=n[s])},T3(r,e)};function B5(r,e){T3(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function AZ(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(u){try{l(n.next(u))}catch(h){o(h)}}function c(u){try{l(n.throw(u))}catch(h){o(h)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((n=n.apply(r,[])).next())})}function IZ(r,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,s&&(i=l[0]&2?s.return:l[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,l[1])).done)return i;switch(s=0,i&&(l=[l[0]&2,i.value]),l[0]){case 0:case 1:i=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,s=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!i||l[1]>i[0]&&l[1]<i[3])){t.label=l[1];break}if(l[0]===6&&t.label<i[1]){t.label=i[1],i=l;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(l);break}i[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(u){l=[6,u],s=0}finally{n=i=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function _f(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function $p(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),s,i=[],o;try{for(;(e===void 0||e-- >0)&&!(s=n.next()).done;)i.push(s.value)}catch(a){o={error:a}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return i}function sa(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat($p(arguments[e]));return r}var TZ="injectionTokens";function kZ(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(TZ,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function NT(r){return!!r.useClass}function k3(r){return!!r.useFactory}var OT=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},s=!1,i,o=function(){return s||(i=e(t.wrap()),s=!0),i};return new Proxy(n,this.createHandler(o))},r.prototype.createHandler=function(e){var t={},n=function(s){t[s]=function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];i[0]=e();var a=Reflect[s];return a.apply(void 0,sa(i))}};return this.reflectMethods.forEach(n),t},r}();function kc(r){return typeof r=="string"||typeof r=="symbol"}function CZ(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function Ob(r){return typeof r=="object"&&"token"in r&&"transform"in r}function PZ(r){return typeof r=="function"||r instanceof OT}function Yf(r){return!!r.useToken}function Qf(r){return r.useValue!=null}function DZ(r){return NT(r)||Qf(r)||Yf(r)||k3(r)}var $5=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),RZ=function(r){B5(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}($5),xf=function(){function r(){this.scopedResolutions=new Map}return r}();function NZ(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function OZ(r,e,t){return t===void 0&&(t="    "),sa([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function MZ(r,e,t){var n=$p(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),s=n[1],i=s===void 0?null:s,o=NZ(i,e);return OZ("Cannot inject the dependency "+o+' of "'+r.name+'" constructor. Reason:',t)}function LZ(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var BZ=function(r){B5(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}($5),$Z=function(r){B5(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}($5),UZ=function(){function r(){this.preResolution=new BZ,this.postResolution=new $Z}return r}(),MT=new Map,FZ=function(){function r(e){this.parent=e,this._registry=new RZ,this.interceptors=new UZ,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:$r.Transient}),this.ensureNotDisposed();var s;if(DZ(t)?s=t:s={useClass:t},Yf(s))for(var i=[e],o=s;o!=null;){var a=o.useToken;if(i.includes(a))throw new Error("Token registration cycle detected! "+sa(i,[a]).join(" -> "));i.push(a);var c=this._registry.get(a);c&&Yf(c.provider)?o=c.provider:o=null}if((n.lifecycle===$r.Singleton||n.lifecycle==$r.ContainerScoped||n.lifecycle==$r.ResolutionScoped)&&(Qf(s)||k3(s)))throw new Error('Cannot use lifecycle "'+$r[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:s,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),kc(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),kc(e)){if(kc(t))return this.register(e,{useToken:t},{lifecycle:$r.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:$r.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!kc(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:$r.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new xf),n===void 0&&(n=!1),this.ensureNotDisposed();var s=this.getRegistration(e);if(!s&&kc(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),s){var i=this.resolveRegistration(s,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}if(PZ(e)){var i=this.construct(e,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,s;if(this.interceptors.preResolution.has(e)){var i=[];try{for(var o=_f(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&i.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(s=o.return)&&s.call(o)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,i)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var s,i;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=_f(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&o.push(l),l.callback(e,t,n)}}catch(u){s={error:u}}finally{try{c&&!c.done&&(i=a.return)&&i.call(a)}finally{if(s)throw s.error}}this.interceptors.postResolution.setAll(e,o)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===$r.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===$r.Singleton,s=e.options.lifecycle===$r.ContainerScoped,i=n||s,o;return Qf(e.provider)?o=e.provider.useValue:Yf(e.provider)?o=i?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):NT(e.provider)?o=i?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):k3(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===$r.ResolutionScoped&&t.scopedResolutions.set(e,o),o},r.prototype.resolveAll=function(e,t,n){var s=this;t===void 0&&(t=new xf),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getAllRegistrations(e);if(!i&&kc(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),i){var o=i.map(function(c){return s.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=_f(this._registry.entries()),s=n.next();!s.done;s=n.next()){var i=$p(s.value,2),o=i[0],a=i[1];this._registry.setAll(o,a.filter(function(c){return!Qf(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var s=_f(this._registry.entries()),i=s.next();!i.done;i=s.next()){var o=$p(i.value,2),a=o[0],c=o[1];c.some(function(l){var u=l.options;return u.lifecycle===$r.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===$r.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return AZ(this,void 0,void 0,function(){var e;return IZ(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var s=n.dispose();s&&e.push(s)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof OT)return e.createProxy(function(i){return n.resolve(i,t)});var s=function(){var i=MT.get(e);if(!i||i.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=i.map(n.resolveParams(t,e));return new(e.bind.apply(e,sa([void 0],o)))}();return LZ(s)&&this.disposables.add(s),s},r.prototype.resolveParams=function(e,t){var n=this;return function(s,i){var o,a,c;try{return CZ(s)?Ob(s)?s.multiple?(o=n.resolve(s.transform)).transform.apply(o,sa([n.resolveAll(s.token,new xf,s.isOptional)],s.transformArgs)):(a=n.resolve(s.transform)).transform.apply(a,sa([n.resolve(s.token,e,s.isOptional)],s.transformArgs)):s.multiple?n.resolveAll(s.token,new xf,s.isOptional):n.resolve(s.token,e,s.isOptional):Ob(s)?(c=n.resolve(s.transform,e)).transform.apply(c,sa([n.resolve(s.token,e)],s.transformArgs)):n.resolve(s,e)}catch(l){throw new Error(MZ(t,i,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),dr=new FZ;function S2(r){return function(e){MT.set(e,kZ(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var C3;class _2{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}w([S({type:U.ObjectIdentifier})],_2.prototype,"attrId",void 0);w([S({type:U.Any,repeated:"set"})],_2.prototype,"attrValues",void 0);let Mb=C3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,C3.prototype)}};Mb=C3=w([ee({type:G.Sequence,itemType:_2})],Mb);var P3;let Lb=P3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,P3.prototype)}};Lb=P3=w([ee({type:G.Sequence,itemType:lu})],Lb);class LT{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],LT.prototype,"certId",void 0);w([S({type:U.Any,context:0})],LT.prototype,"certValue",void 0);class BT{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],BT.prototype,"crlId",void 0);w([S({type:U.Any,context:0})],BT.prototype,"crltValue",void 0);class $T extends qe{}let x2=class{constructor(e={}){this.encryptionAlgorithm=new he,this.encryptedData=new $T,Object.assign(this,e)}};w([S({type:he})],x2.prototype,"encryptionAlgorithm",void 0);w([S({type:$T})],x2.prototype,"encryptedData",void 0);var D3,R3;(function(r){r[r.v1=0]="v1"})(R3||(R3={}));class UT extends qe{}let N3=D3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,D3.prototype)}};N3=D3=w([ee({type:G.Sequence,itemType:Ii})],N3);class Od{constructor(e={}){this.version=R3.v1,this.privateKeyAlgorithm=new he,this.privateKey=new UT,Object.assign(this,e)}}w([S({type:U.Integer})],Od.prototype,"version",void 0);w([S({type:he})],Od.prototype,"privateKeyAlgorithm",void 0);w([S({type:UT})],Od.prototype,"privateKey",void 0);w([S({type:N3,implicit:!0,context:0,optional:!0})],Od.prototype,"attributes",void 0);let Bb=class extends Od{};Bb=w([ee({type:G.Sequence})],Bb);let $b=class extends x2{};$b=w([ee({type:G.Sequence})],$b);class FT{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],FT.prototype,"secretTypeId",void 0);w([S({type:U.Any,context:0})],FT.prototype,"secretValue",void 0);class Md{constructor(e={}){this.mac=new v2,this.macSalt=new qe,this.iterations=1,Object.assign(this,e)}}w([S({type:v2})],Md.prototype,"mac",void 0);w([S({type:qe})],Md.prototype,"macSalt",void 0);w([S({type:U.Integer,defaultValue:1})],Md.prototype,"iterations",void 0);class A2{constructor(e={}){this.version=3,this.authSafe=new lu,this.macData=new Md,Object.assign(this,e)}}w([S({type:U.Integer})],A2.prototype,"version",void 0);w([S({type:lu})],A2.prototype,"authSafe",void 0);w([S({type:Md,optional:!0})],A2.prototype,"macData",void 0);var O3;class I2{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:U.ObjectIdentifier})],I2.prototype,"bagId",void 0);w([S({type:U.Any,context:0})],I2.prototype,"bagValue",void 0);w([S({type:_2,repeated:"set",optional:!0})],I2.prototype,"bagAttributes",void 0);let Ub=O3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,O3.prototype)}};Ub=O3=w([ee({type:G.Sequence,itemType:I2})],Ub);var M3,L3,B3;const VT="1.2.840.113549.1.9",KT=`${VT}.7`,U5=`${VT}.14`;let Up=class extends hr{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};w([S({type:U.IA5String})],Up.prototype,"ia5String",void 0);Up=w([ee({type:G.Choice})],Up);let Fb=class extends lu{};Fb=w([ee({type:G.Sequence})],Fb);let Vb=class extends A2{};Vb=w([ee({type:G.Sequence})],Vb);let Kb=class extends x2{};Kb=w([ee({type:G.Sequence})],Kb);let $3=class{constructor(e=""){this.value=e}toString(){return this.value}};w([S({type:U.IA5String})],$3.prototype,"value",void 0);$3=w([ee({type:G.Choice})],$3);let qb=class extends Up{};qb=w([ee({type:G.Choice})],qb);let Hb=class extends hr{};Hb=w([ee({type:G.Choice})],Hb);let U3=class{constructor(e=new Date){this.value=e}};w([S({type:U.GeneralizedTime})],U3.prototype,"value",void 0);U3=w([ee({type:G.Choice})],U3);let zb=class extends hr{};zb=w([ee({type:G.Choice})],zb);let F3=class{constructor(e="M"){this.value=e}toString(){return this.value}};w([S({type:U.PrintableString})],F3.prototype,"value",void 0);F3=w([ee({type:G.Choice})],F3);let Fp=class{constructor(e=""){this.value=e}toString(){return this.value}};w([S({type:U.PrintableString})],Fp.prototype,"value",void 0);Fp=w([ee({type:G.Choice})],Fp);let Wb=class extends Fp{};Wb=w([ee({type:G.Choice})],Wb);let jb=class extends hr{};jb=w([ee({type:G.Choice})],jb);let V3=class{constructor(e=""){this.value=e}toString(){return this.value}};w([S({type:U.ObjectIdentifier})],V3.prototype,"value",void 0);V3=w([ee({type:G.Choice})],V3);let Gb=class extends cr{};Gb=w([ee({type:G.Choice})],Gb);let K3=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};w([S({type:U.Integer})],K3.prototype,"value",void 0);K3=w([ee({type:G.Choice})],K3);let Yb=class extends Ks{};Yb=w([ee({type:G.Sequence})],Yb);let Vp=class extends hr{};Vp=w([ee({type:G.Choice})],Vp);let Qb=M3=class extends To{constructor(e){super(e),Object.setPrototypeOf(this,M3.prototype)}};Qb=M3=w([ee({type:G.Sequence})],Qb);let Xb=L3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,L3.prototype)}};Xb=L3=w([ee({type:G.Set,itemType:cu})],Xb);let q3=class{constructor(e=""){this.value=e}toString(){return this.value}};w([S({type:U.BmpString})],q3.prototype,"value",void 0);q3=w([ee({type:G.Choice})],q3);let H3=class extends he{};H3=w([ee({type:G.Sequence})],H3);let Zb=B3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,B3.prototype)}};Zb=B3=w([ee({type:G.Sequence,itemType:H3})],Zb);var z3;let Kp=z3=class extends rt{constructor(e){super(e),Object.setPrototypeOf(this,z3.prototype)}};Kp=z3=w([ee({type:G.Sequence,itemType:Ii})],Kp);class du{constructor(e={}){this.version=0,this.subject=new Rt,this.subjectPKInfo=new is,this.attributes=new Kp,Object.assign(this,e)}}w([S({type:U.Integer})],du.prototype,"version",void 0);w([S({type:Rt})],du.prototype,"subject",void 0);w([S({type:is})],du.prototype,"subjectPKInfo",void 0);w([S({type:Kp,implicit:!0,context:0})],du.prototype,"attributes",void 0);class Hh{constructor(e={}){this.certificationRequestInfo=new du,this.signatureAlgorithm=new he,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}w([S({type:du})],Hh.prototype,"certificationRequestInfo",void 0);w([S({type:he})],Hh.prototype,"signatureAlgorithm",void 0);w([S({type:U.BitString})],Hh.prototype,"signature",void 0);const Ld="crypto.algorithm";class VZ{getAlgorithms(){return dr.resolveAll(Ld)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){const t=new he({algorithm:e.name});if("parameters"in e){const n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const n of this.getAlgorithms()){const s=n.toWebAlgorithm(e);if(s)return s}return{name:e.algorithm,parameters:e.parameters}}}const Qa="crypto.algorithmProvider";dr.registerSingleton(Qa,VZ);var Xf;const tn="1.3.36.3.3.2.8.1.1",Jb=`${tn}.1`,e9=`${tn}.2`,t9=`${tn}.3`,r9=`${tn}.4`,n9=`${tn}.5`,s9=`${tn}.6`,i9=`${tn}.7`,o9=`${tn}.8`,a9=`${tn}.9`,c9=`${tn}.10`,l9=`${tn}.11`,u9=`${tn}.12`,h9=`${tn}.13`,d9=`${tn}.14`,f9="brainpoolP160r1",p9="brainpoolP160t1",g9="brainpoolP192r1",m9="brainpoolP192t1",y9="brainpoolP224r1",w9="brainpoolP224t1",b9="brainpoolP256r1",v9="brainpoolP256t1",E9="brainpoolP320r1",S9="brainpoolP320t1",_9="brainpoolP384r1",x9="brainpoolP384t1",A9="brainpoolP512r1",I9="brainpoolP512t1",xt="ECDSA";let zh=Xf=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case xt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return hZ;case"sha-256":return dZ;case"sha-384":return fZ;case"sha-512":return pZ}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=Db;break;case"K-256":t=Xf.SECP256K1;break;case"P-384":t=Rb;break;case"P-521":t=Nb;break;case f9:t=Jb;break;case p9:t=e9;break;case g9:t=t9;break;case m9:t=r9;break;case y9:t=n9;break;case w9:t=s9;break;case b9:t=i9;break;case v9:t=o9;break;case E9:t=a9;break;case S9:t=c9;break;case _9:t=l9;break;case x9:t=u9;break;case A9:t=h9;break;case I9:t=d9;break}if(t)return new he({algorithm:Kh,parameters:ie.serialize(new Co({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case R5:return{name:xt,hash:{name:"SHA-1"}};case N5:return{name:xt,hash:{name:"SHA-256"}};case O5:return{name:xt,hash:{name:"SHA-384"}};case M5:return{name:xt,hash:{name:"SHA-512"}};case Kh:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(ie.parse(e.parameters,Co).namedCurve){case Db:return{name:xt,namedCurve:"P-256"};case Xf.SECP256K1:return{name:xt,namedCurve:"K-256"};case Rb:return{name:xt,namedCurve:"P-384"};case Nb:return{name:xt,namedCurve:"P-521"};case Jb:return{name:xt,namedCurve:f9};case e9:return{name:xt,namedCurve:p9};case t9:return{name:xt,namedCurve:g9};case r9:return{name:xt,namedCurve:m9};case n9:return{name:xt,namedCurve:y9};case s9:return{name:xt,namedCurve:w9};case i9:return{name:xt,namedCurve:b9};case o9:return{name:xt,namedCurve:v9};case a9:return{name:xt,namedCurve:E9};case c9:return{name:xt,namedCurve:S9};case l9:return{name:xt,namedCurve:_9};case u9:return{name:xt,namedCurve:x9};case h9:return{name:xt,namedCurve:A9};case d9:return{name:xt,namedCurve:I9}}}}return null}};zh.SECP256K1="1.3.132.0.10";zh=Xf=w([S2()],zh);dr.registerSingleton(Ld,zh);const qT=Symbol("name"),HT=Symbol("value");class Ge{constructor(e,t={},n=""){this[qT]=e,this[HT]=n;for(const s in t)this[s]=t[s]}}Ge.NAME=qT;Ge.VALUE=HT;class KZ{static toTextObject(e){const t=new Ge("Algorithm Identifier",{},Mo.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case Kh:{const n=new zh().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class Mo{static toString(e){const t=this.items[e];return t||e}}Mo.items={[Op]:"sha1",[PT]:"sha224",[Mp]:"sha256",[Lp]:"sha384",[Bp]:"sha512",[ja]:"rsaEncryption",[Dp]:"sha1WithRSAEncryption",[vZ]:"sha224WithRSAEncryption",[_3]:"sha256WithRSAEncryption",[Rp]:"sha384WithRSAEncryption",[Np]:"sha512WithRSAEncryption",[Kh]:"ecPublicKey",[R5]:"ecdsaWithSHA1",[TT]:"ecdsaWithSHA224",[N5]:"ecdsaWithSHA256",[O5]:"ecdsaWithSHA384",[M5]:"ecdsaWithSHA512",[sZ]:"TLS WWW server authentication",[iZ]:"TLS WWW client authentication",[oZ]:"Code Signing",[aZ]:"E-mail Protection",[cZ]:"Time Stamping",[lZ]:"OCSP Signing",[uZ]:"Signed Data"};class Xa{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const n=[];let s=this.pad(t++),i="";const o=e[Ge.VALUE];o&&(i=` ${o}`),n.push(`${s}${e[Ge.NAME]}:${i}`),s=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${s}${l}${c}`);else if(c instanceof Date)n.push(`${s}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(const u of c)u[Ge.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof Ge)c[Ge.NAME]=a,n.push(...this.serializeObj(c,t));else if(oe.isBufferSource(c))a?(n.push(`${s}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const u=c.toTextObject();u[Ge.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){const n=this.pad(t),s=oe.toUint8Array(e),i=[];for(let o=0;o<s.length;){const a=[];for(let c=0;c<16&&o<s.length;c++){c===8&&a.push("");const l=s[o++].toString(16).padStart(2,"0");a.push(l)}i.push(`${n}${a.join(" ")}`)}return i}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}Xa.oidSerializer=Mo;Xa.algorithmSerializer=KZ;class Lo{constructor(...e){if(e.length===1){const t=e[0];this.rawData=ie.serialize(t),this.onInit(t)}else{const t=ie.parse(e[0],e[1]);this.rawData=oe.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof Lo?uA(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return ie.toString(this.rawData);case"text":return Xa.serialize(this.toTextObject());case"hex":return ye.ToHex(this.rawData);case"base64":return ye.ToBase64(this.rawData);case"base64url":return ye.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new Ge(this.getTextName(),{},e)}}Lo.NAME="ASN";class xn extends Lo{constructor(...e){let t;oe.isBufferSource(e[0])?t=oe.toArrayBuffer(e[0]):t=ie.serialize(new qn({extnID:e[0],critical:e[1],extnValue:new qe(oe.toArrayBuffer(e[2]))})),super(t,qn)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[Ge.NAME]===xn.NAME&&(e[Ge.NAME]=Mo.toString(this.type)),e}}var zT;class oo{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[zT]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(oo.DEFAULT,crypto):typeof Sf<"u"&&Sf.crypto&&Sf.crypto.subtle&&this.set(oo.DEFAULT,Sf.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=oo.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(oo.DEFAULT,e);return this}}zT=Symbol.toStringTag;oo.DEFAULT="default";const ir=new oo,qZ=/^[0-2](?:\.[1-9][0-9]*)+$/;function HZ(r){return new RegExp(qZ).test(r)}class WT{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return HZ(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const Jr=new WT;Jr.register("CN","2.5.4.3");Jr.register("L","2.5.4.7");Jr.register("ST","2.5.4.8");Jr.register("O","2.5.4.10");Jr.register("OU","2.5.4.11");Jr.register("C","2.5.4.6");Jr.register("DC","0.9.2342.19200300.100.1.25");Jr.register("E","1.2.840.113549.1.9.1");Jr.register("G","2.5.4.42");Jr.register("I","2.5.4.43");Jr.register("SN","2.5.4.4");Jr.register("T","2.5.4.12");function zZ(r,e){return`\\${ye.ToHex(ye.FromUtf8String(e)).toUpperCase()}`}function WZ(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,zZ)}class Ln{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new WT,this.asn=new Rt;for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const s=t[n];this.extraNames.register(n,s)}typeof e=="string"?this.asn=this.fromString(e):e instanceof Rt?this.asn=e:oe.isBufferSource(e)?this.asn=ie.parse(e,Rt):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||Jr.findId(e),n=[];for(const s of this.asn)for(const i of s)i.type===t&&n.push(i.value.toString());return n}getName(e){return this.extraNames.get(e)||Jr.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const n=this.getName(t.type)||t.type,s=t.value.anyValue?`#${ye.ToHex(t.value.anyValue)}`:WZ(t.value.toString());return`${n}=${s}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const n of this.asn){const s={};for(const i of n){const o=this.getName(i.type)||i.type;(e=s[o])!==null&&e!==void 0||(s[o]=[]),s[o].push(i.value.anyValue?`#${ye.ToHex(i.value.anyValue)}`:i.value.toString())}t.push(s)}return t}fromString(e){const t=new Rt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let s=null,i=",";for(;s=n.exec(`${e},`);){let[,o,a]=s;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),s[3]=c);const l=s[3];o=this.getTypeOid(o);const u=this.createAttribute(o,a);i==="+"?t[t.length-1].push(u):t.push(new Pl([u])),i=l}return t}fromJSON(e){const t=new Rt;for(const n of e){const s=new Pl;for(const i in n){const o=this.getTypeOid(i),a=n[i];for(const c of a){const l=this.createAttribute(o,c);s.push(l)}}t.push(s)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const n=new r2({type:e});if(typeof t=="object")for(const s in t)switch(s){case"ia5String":n.value.ia5String=t[s];break;case"utf8String":n.value.utf8String=t[s];break;case"universalString":n.value.universalString=t[s];break;case"bmpString":n.value.bmpString=t[s];break;case"printableString":n.value.printableString=t[s];break}else if(t[0]==="#")n.value.anyValue=ye.FromHex(t.slice(1));else{const s=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=s:Ln.isPrintableString(s)?n.value.printableString=s:n.value.utf8String=s}return n}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return ie.serialize(this.asn)}async getThumbprint(...e){var t;let n,s="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(s=e[0]||s,n=e[1]||ir.get()):n=e[0]||ir.get(),await n.subtle.digest(s,this.toArrayBuffer())}}const jT="Cannot initialize GeneralName from ASN.1 data.",T9=`${jT} Unsupported string format in use.`,jZ=`${jT} Value doesn't match to GUID regular expression.`,k9=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,C9="1.3.6.1.4.1.311.25.1",P9="1.3.6.1.4.1.311.20.2.3",zg="dns",Wg="dn",jg="email",Gg="ip",Yg="url",Qg="guid",Xg="upn",Af="id";class ao extends Lo{constructor(...e){let t;if(e.length===2)switch(e[0]){case Wg:{const n=new Ln(e[1]).toArrayBuffer(),s=ie.parse(n,Rt);t=new Ce({directoryName:s});break}case zg:t=new Ce({dNSName:e[1]});break;case jg:t=new Ce({rfc822Name:e[1]});break;case Qg:{const n=new RegExp(k9,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const s=n.slice(1).map((i,o)=>o<3?ye.ToHex(new Uint8Array(ye.FromHex(i)).reverse()):i).join("");t=new Ce({otherName:new $h({typeId:C9,value:ie.serialize(new qe(ye.FromHex(s)))})});break}case Gg:t=new Ce({iPAddress:e[1]});break;case Af:t=new Ce({registeredID:e[1]});break;case Xg:{t=new Ce({otherName:new $h({typeId:P9,value:ie.serialize(lT.toASN(e[1]))})});break}case Yg:t=new Ce({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else oe.isBufferSource(e[0])?t=ie.parse(e[0],Ce):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=zg,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=jg,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=Gg,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=Yg,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=Af,this.value=e.registeredID;else if(e.directoryName!=null)this.type=Wg,this.value=new Ln(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===C9){this.type=Qg;const t=ie.parse(e.otherName.value,qe),n=new RegExp(k9,"i").exec(ye.ToHex(t));if(!n)throw new Error(jZ);this.value=n.slice(1).map((s,i)=>i<3?ye.ToHex(new Uint8Array(ye.FromHex(s)).reverse()):s).join("-")}else if(e.otherName.typeId===P9)this.type=Xg,this.value=ie.parse(e.otherName.value,hr).toString();else throw new Error(T9);else throw new Error(T9)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case Wg:case zg:case Qg:case Gg:case Af:case Xg:case Yg:e=this.type.toUpperCase();break;case jg:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===Af&&(t=Mo.toString(t)),new Ge(e,void 0,t)}}class Za extends Lo{constructor(e){let t;if(e instanceof _r)t=e;else if(Array.isArray(e)){const n=[];for(const s of e)if(s instanceof Ce)n.push(s);else{const i=ie.parse(new ao(s.type,s.value).rawData,Ce);n.push(i)}t=new _r(n)}else if(oe.isBufferSource(e))t=ie.parse(e,_r);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const n of e){let s=null;try{s=new ao(n)}catch{continue}t.push(s)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const n=t.toTextObject();let s=e[n[Ge.NAME]];Array.isArray(s)||(s=[],e[n[Ge.NAME]]=s),s.push(n)}return e}}Za.NAME="GeneralNames";const uh="-{5}",Wh="\\n",GZ=`[^${Wh}]+`,YZ=`${uh}BEGIN (${GZ}(?=${uh}))${uh}`,QZ=`${uh}END \\1${uh}`,$l="\\n",XZ=`[^:${Wh}]+`,ZZ=`(?:[^${Wh}]+${$l}(?: +[^${Wh}]+${$l})*)`,JZ="[a-zA-Z0-9=+/]+",eJ=`(?:${JZ}${$l})+`,D9=`${YZ}${$l}(?:((?:${XZ}: ${ZZ})+))?${$l}?(${eJ})${QZ}`;class fn{static isPem(e){return typeof e=="string"&&new RegExp(D9,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(D9,"g"),n=[];let s=null;for(;s=t.exec(e);){const i=s[3].replace(new RegExp(`[${Wh}]+`,"g"),""),o={type:s[1],headers:[],rawData:ye.FromBase64(i)},a=s[2];if(a){const c=a.split(new RegExp($l,"g"));let l=null;for(const u of c){const[h,d]=u.split(/:(.*)/);if(d===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=h.trim()}else l&&o.headers.push(l),l={key:h,value:d.trim()}}l&&o.headers.push(l)}n.push(o)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const n=new Array;return t?e.forEach(s=>{if(!oe.isBufferSource(s))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:oe.toArrayBuffer(s)}))}):e.forEach(s=>{if(!("type"in s))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(s))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:oe.toArrayBuffer(e)})}}static encodeStruct(e){var t;const n=e.type.toLocaleUpperCase(),s=[];if(s.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const l of e.headers)s.push(`${l.key}: ${l.value}`);s.push("")}const i=ye.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<i.length&&(i.length-a<64?o=i.substring(a):(o=i.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return s.push(...c),s.push(`-----END ${n}-----`),s.join(`
`)}}fn.CertificateTag="CERTIFICATE";fn.CrlTag="CRL";fn.CertificateRequestTag="CERTIFICATE REQUEST";fn.PublicKeyTag="PUBLIC KEY";fn.PrivateKeyTag="PRIVATE KEY";class Ci extends Lo{static isAsnEncoded(e){return oe.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(fn.isPem(e))return fn.decode(e)[0];if(ye.isHex(e))return ye.FromHex(e);if(ye.isBase64(e))return ye.FromBase64(e);if(ye.isBase64Url(e))return ye.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=ye.ToBinary(e);return fn.isPem(t)?fn.decode(t)[0]:ye.isHex(t)?ye.FromHex(t):ye.isBase64(t)?ye.FromBase64(t):ye.isBase64Url(t)?ye.FromBase64Url(t):oe.toArrayBuffer(e)}}constructor(...e){Ci.isAsnEncoded(e[0])?super(Ci.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return fn.encode(this.rawData,this.tag);default:return super.toString(e)}}}class ls extends Ci{static async create(e,t=ir.get()){if(e instanceof ls)return e;if(oo.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const n=await t.subtle.exportKey("spki",e);return new ls(n)}else{if(e.publicKey)return e.publicKey;if(oe.isBufferSource(e))return new ls(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){Ci.isAsnEncoded(e)?super(e,is):super(e),this.tag=fn.PublicKeyTag}async export(...e){let t,n=["verify"],s={hash:"SHA-256",...this.algorithm};e.length>1?(s=e[0]||s,n=e[1]||n,t=e[2]||ir.get()):t=e[0]||ir.get();let i=this.rawData;const o=ie.parse(this.rawData,is);return o.algorithm.algorithm===lh&&(i=tJ(o,i)),t.subtle.importKey("spki",i,s,!0,n)}onInit(e){const t=dr.resolve(Qa),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case ja:{const s=ie.parse(e.subjectPublicKey,L5),i=oe.toUint8Array(s.modulus);n.publicExponent=oe.toUint8Array(s.publicExponent),n.modulusLength=(i[0]?i:i.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,s="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(s=e[0]||s,n=e[1]||ir.get()):n=e[0]||ir.get(),await n.subtle.digest(s,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=ir.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=ir.get();const s=ie.parse(this.rawData,is);return await t.subtle.digest(n,s.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=ie.parse(this.rawData,is);switch(e.Algorithm=Xa.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case Kh:e["EC Point"]=t.subjectPublicKey;break;case ja:default:e["Raw Data"]=t.subjectPublicKey}return e}}function tJ(r,e){return r.algorithm=new he({algorithm:ja,parameters:null}),e=ie.serialize(r),e}class jh extends xn{static async create(e,t=!1,n=ir.get()){if("name"in e&&"serialNumber"in e)return new jh(e,t);const i=await(await ls.create(e,n)).getKeyIdentifier(n);return new jh(ye.ToHex(i),t)}constructor(...e){if(oe.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new pa({keyIdentifier:new y5(ye.FromHex(e[0]))});super(Vy,e[1],ie.serialize(t))}else{const t=e[0],n=t.name instanceof Za?ie.parse(t.name.rawData,_r):t.name,s=new pa({authorityCertIssuer:n,authorityCertSerialNumber:ye.FromHex(t.serialNumber)});super(Vy,e[1],ie.serialize(s))}}onInit(e){super.onInit(e);const t=ie.parse(e.extnValue,pa);t.keyIdentifier&&(this.keyId=ye.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?ye.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ie.parse(this.value,pa);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Za(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}jh.NAME="Authority Key Identifier";class F5 extends xn{constructor(...e){if(oe.isBufferSource(e[0])){super(e[0]);const t=ie.parse(this.value,fp);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new fp({cA:e[0],pathLenConstraint:e[1]});super(hT,e[2],ie.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}F5.NAME="Basic Constraints";var R9;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(R9||(R9={}));class GT extends xn{constructor(...e){if(oe.isBufferSource(e[0])){super(e[0]);const t=ie.parse(this.value,yp);this.usages=t.map(n=>n)}else{const t=new yp(e[0]);super(pT,e[1],ie.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>Mo.toString(t)).join(", "),e}}GT.NAME="Extended Key Usages";var N9;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(N9||(N9={}));class YT extends xn{constructor(...e){if(oe.isBufferSource(e[0])){super(e[0]);const t=ie.parse(this.value,Hg);this.usages=t.toNumber()}else{const t=new Hg(e[0]);super(mT,e[1],ie.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ie.parse(this.value,Hg);return e[""]=t.toJSON().join(", "),e}}YT.NAME="Key Usages";class T2 extends xn{static async create(e,t=!1,n=ir.get()){const i=await(await ls.create(e,n)).getKeyIdentifier(n);return new T2(ye.ToHex(i),t)}constructor(...e){if(oe.isBufferSource(e[0])){super(e[0]);const t=ie.parse(this.value,fo);this.keyId=ye.ToHex(t)}else{const t=typeof e[0]=="string"?ye.FromHex(e[0]):e[0],n=new fo(t);super(vT,e[1],ie.serialize(n)),this.keyId=ye.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ie.parse(this.value,fo);return e[""]=t,e}}T2.NAME="Subject Key Identifier";class QT extends xn{constructor(...e){oe.isBufferSource(e[0])?super(e[0]):super(bT,e[1],new Za(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=ie.parse(e.extnValue,r3);this.names=new Za(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}QT.NAME="Subject Alternative Name";class An{static register(e,t){this.items.set(e,t)}static create(e){const t=new xn(e),n=this.items.get(t.type);return n?new n(e):t}}An.items=new Map;class XT extends xn{constructor(...e){var t;if(oe.isBufferSource(e[0])){super(e[0]);const n=ie.parse(this.value,gp);this.policies=n.map(s=>s.policyIdentifier)}else{const n=e[0],s=(t=e[1])!==null&&t!==void 0?t:!1,i=new gp(n.map(o=>new s2({policyIdentifier:o})));super(dT,s,ie.serialize(i)),this.policies=n}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new Ge("",{},Mo.toString(t))),e}}XT.NAME="Certificate Policies";An.register(dT,XT);class ZT extends xn{constructor(...e){var t;if(oe.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const s=e[0].map(o=>new ou({distributionPoint:new qa({fullName:[new Ce({uniformResourceIdentifier:o})]})})),i=new sl(s);super(Wy,e[1],ie.serialize(i))}else{const n=new sl(e[0]);super(Wy,e[1],ie.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=ie.parse(e.extnValue,sl);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;const s={};return t.distributionPoint&&(s[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(i=>new ao(i).toString()).join(", ")),t.reasons&&(s.Reasons=t.reasons.toString()),t.cRLIssuer&&(s["CRL Issuer"]=t.cRLIssuer.map(i=>i.toString()).join(", ")),s}),e}}ZT.NAME="CRL Distribution Points";class JT extends xn{constructor(...e){var t,n,s,i;if(oe.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof qc){const o=new qc(e[0]);super(Fy,e[1],ie.serialize(o))}else{const o=e[0],a=new qc;Tf(a,o,mb,"ocsp"),Tf(a,o,yb,"caIssuers"),Tf(a,o,wb,"timeStamping"),Tf(a,o,bb,"caRepository"),super(Fy,e[1],ie.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(s=this.timeStamping)!==null&&s!==void 0||(this.timeStamping=[]),(i=this.caRepository)!==null&&i!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],ie.parse(e.extnValue,qc).forEach(n=>{switch(n.accessMethod){case mb:this.ocsp.push(new ao(n.accessLocation));break;case yb:this.caIssuers.push(new ao(n.accessLocation));break;case wb:this.timeStamping.push(new ao(n.accessLocation));break;case bb:this.caRepository.push(new ao(n.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&If(e,"OCSP",this.ocsp),this.caIssuers.length&&If(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&If(e,"Time Stamping",this.timeStamping),this.caRepository.length&&If(e,"CA Repository",this.caRepository),e}}JT.NAME="Authority Info Access";function If(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{const n=new Ge("");t.forEach((s,i)=>{const o=s.toTextObject(),a=`${o[Ge.NAME]} ${i+1}`;let c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(o)}),r[e]=n}}function Tf(r,e,t,n){const s=e[n];s&&(Array.isArray(s)?s:[s]).forEach(o=>{typeof o=="string"&&(o=new ao("url",o)),r.push(new xd({accessMethod:t,accessLocation:ie.parse(o.rawData,Ce)}))})}class ek extends xn{constructor(...e){oe.isBufferSource(e[0])?super(e[0]):super(gT,e[1],new Za(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=ie.parse(e.extnValue,_r);this.names=new Za(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}ek.NAME="Issuer Alternative Name";class fu extends Lo{constructor(...e){let t;if(oe.isBufferSource(e[0]))t=oe.toArrayBuffer(e[0]);else{const n=e[0],s=Array.isArray(e[1])?e[1].map(i=>oe.toArrayBuffer(i)):[];t=ie.serialize(new Ii({type:n,values:s}))}super(t,Ii)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new Ge("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[Ge.NAME]===fu.NAME&&(e[Ge.NAME]=Mo.toString(this.type)),e}}fu.NAME="Attribute";class tk extends fu{constructor(...e){var t;if(oe.isBufferSource(e[0]))super(e[0]);else{const n=new Vp({printableString:e[0]});super(KT,[ie.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=ie.parse(this.values[0],Vp);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[Ge.VALUE]=this.password,e}}tk.NAME="Challenge Password";class V5 extends fu{constructor(...e){var t;if(oe.isBufferSource(e[0]))super(e[0]);else{const n=e[0],s=new To;for(const i of n)s.push(ie.parse(i.rawData,qn));super(U5,[ie.serialize(s)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=ie.parse(this.values[0],To);this.items=t.map(n=>An.create(ie.serialize(n)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(const n of t)e[n[Ge.NAME]]=n;return e}}V5.NAME="Extensions";class k2{static register(e,t){this.items.set(e,t)}static create(e){const t=new fu(e),n=this.items.get(t.type);return n?new n(e):t}}k2.items=new Map;const Bd="crypto.signatureFormatter";class rJ{toAsnSignature(e,t){return oe.toArrayBuffer(t)}toWebSignature(e,t){return oe.toArrayBuffer(t)}}var Zf;let W3=Zf=class{static createPssParams(e,t){const n=Zf.getHashAlgorithm(e);return n?new Ya({hashAlgorithm:n,maskGenAlgorithm:new he({algorithm:w2,parameters:ie.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){const t=dr.resolve(Qa);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new he({algorithm:Dp,parameters:null});case"sha-256":return new he({algorithm:_3,parameters:null});case"sha-384":return new he({algorithm:Rp,parameters:null});case"sha-512":return new he({algorithm:Np,parameters:null})}}else return new he({algorithm:ja,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=Zf.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new he({algorithm:lh,parameters:ie.serialize(t)})}else return new he({algorithm:lh,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case ja:return{name:"RSASSA-PKCS1-v1_5"};case Dp:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case _3:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Rp:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Np:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case lh:if(e.parameters){const t=ie.parse(e.parameters,Ya);return{name:"RSA-PSS",hash:dr.resolve(Qa).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};W3=Zf=w([S2()],W3);dr.registerSingleton(Ld,W3);let j3=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new he({algorithm:Op});case"sha-256":return new he({algorithm:Mp});case"sha-384":return new he({algorithm:Lp});case"sha-512":return new he({algorithm:Bp})}return null}toWebAlgorithm(e){switch(e.algorithm){case Op:return{name:"SHA-1"};case Mp:return{name:"SHA-256"};case Lp:return{name:"SHA-384"};case Bp:return{name:"SHA-512"}}return null}};j3=w([S2()],j3);dr.registerSingleton(Ld,j3);class Bn{addPadding(e,t){const n=oe.toUint8Array(t),s=new Uint8Array(e);return s.set(n,e-n.length),s}removePadding(e,t=!1){let n=oe.toUint8Array(e);for(let s=0;s<n.length;s++)if(n[s]){n=n.slice(s);break}if(t&&n[0]>127){const s=new Uint8Array(n.length+1);return s.set(n,1),s.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const n=e.namedCurve,s=Bn.namedCurveSize.get(n)||Bn.defaultNamedCurveSize,i=new Pp,o=oe.toUint8Array(t);return i.r=this.removePadding(o.slice(0,s),!0),i.s=this.removePadding(o.slice(s,s+s),!0),ie.serialize(i)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const n=ie.parse(t,Pp),s=e.namedCurve,i=Bn.namedCurveSize.get(s)||Bn.defaultNamedCurveSize,o=this.addPadding(i,this.removePadding(n.r)),a=this.addPadding(i,this.removePadding(n.s));return qz(o,a)}return null}}Bn.namedCurveSize=new Map;Bn.defaultNamedCurveSize=32;const Zg="1.3.101.110",O9="1.3.101.111",Jg="1.3.101.112",M9="1.3.101.113";let G3=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=Jg;break;case"x25519":t=Zg;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=Jg;break;case"ed448":t=M9;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=Zg;break;case"x448":t=O9;break}}return t?new he({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case Jg:return{name:"Ed25519"};case M9:return{name:"EdDSA",namedCurve:"Ed448"};case Zg:return{name:"X25519"};case O9:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};G3=w([S2()],G3);dr.registerSingleton(Ld,G3);class nJ extends Ci{constructor(e){Ci.isAsnEncoded(e)?super(e,Hh):super(e),this.tag=fn.CertificateRequestTag}onInit(e){this.tbs=ie.serialize(e.certificationRequestInfo),this.publicKey=new ls(e.certificationRequestInfo.subjectPKInfo);const t=dr.resolve(Qa);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(s=>k2.create(ie.serialize(s)));const n=this.getAttribute(U5);this.extensions=[],n instanceof V5&&(this.extensions=n.items),this.subjectName=new Ln(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=ir.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),s=dr.resolveAll(Bd).reverse();let i=null;for(const a of s)if(i=a.toWebSignature(t,this.signature),i)break;if(!i)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,i,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=ie.parse(this.rawData,Hh),n=t.certificationRequestInfo,s=new Ge("",{Version:`${Ha[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const i=new Ge("");for(const o of this.attributes){const a=o.toTextObject();i[a[Ge.NAME]]=a}s.Attributes=i}return e.Data=s,e.Signature=new Ge("",{Algorithm:Xa.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}nJ.NAME="PKCS#10 Certificate Request";class K5 extends Ci{constructor(e){Ci.isAsnEncoded(e)?super(e,za):super(e),this.tag=fn.CertificateTag}onInit(e){const t=e.tbsCertificate;this.tbs=ie.serialize(t);let n=new Uint8Array(t.serialNumber);n.length>1&&n[0]===0&&n[1]>127&&(n=n.slice(1)),this.serialNumber=ye.ToHex(n),this.subjectName=new Ln(t.subject),this.subject=new Ln(t.subject).toString(),this.issuerName=new Ln(t.issuer),this.issuer=this.issuerName.toString();const s=dr.resolve(Qa);this.signatureAlgorithm=s.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;const i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;const o=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!o)throw new Error("Cannot get 'notAfter' value");this.notAfter=o,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(a=>An.create(ie.serialize(a)))),this.publicKey=new ls(t.subjectPublicKeyInfo)}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=ir.get()){let n,s;const i=e.publicKey;try{if(!i)n={...this.publicKey.algorithm,...this.signatureAlgorithm},s=await this.publicKey.export(n,["verify"],t);else if("publicKey"in i)n={...i.publicKey.algorithm,...this.signatureAlgorithm},s=await i.publicKey.export(n,["verify"],t);else if(i instanceof ls)n={...i.algorithm,...this.signatureAlgorithm},s=await i.export(n,["verify"],t);else if(oe.isBufferSource(i)){const l=new ls(i);n={...l.algorithm,...this.signatureAlgorithm},s=await l.export(n,["verify"],t)}else n={...i.algorithm,...this.signatureAlgorithm},s=i}catch{return!1}const o=dr.resolveAll(Bd).reverse();let a=null;for(const l of o)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,s,a,this.tbs);if(e.signatureOnly)return c;{const u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=ir.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=ir.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=ie.parse(this.rawData,za),n=t.tbsCertificate,s=new Ge("",{Version:`${Ha[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":Xa.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new Ge("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(s["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(s["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){const i=new Ge("");for(const o of this.extensions){const a=o.toTextObject();i[a[Ge.NAME]]=a}s.Extensions=i}return e.Data=s,e.Signature=new Ge("",{Algorithm:Xa.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}K5.NAME="Certificate";class sJ{static async createSelfSigned(e,t=ir.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=ir.get()){var n;let s;e.publicKey instanceof ls?s=e.publicKey.rawData:"publicKey"in e.publicKey?s=e.publicKey.publicKey.rawData:oe.isBufferSource(e.publicKey)?s=e.publicKey:s=await t.subtle.exportKey("spki",e.publicKey);let i=e.serialNumber?oe.toUint8Array(ye.FromHex(e.serialNumber)):void 0;i=this.generateSerialNumber(i,t);const o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new za({tbsCertificate:new _n({version:Ha.v3,serialNumber:i,validity:new Ad({notBefore:o,notAfter:a}),extensions:new To(((n=e.extensions)===null||n===void 0?void 0:n.map(y=>ie.parse(y.rawData,qn)))||[]),subjectPublicKeyInfo:ie.parse(s,is)})});if(e.subject){const y=e.subject instanceof Ln?e.subject:new Ln(e.subject);c.tbsCertificate.subject=ie.parse(y.toArrayBuffer(),Rt)}if(e.issuer){const y=e.issuer instanceof Ln?e.issuer:new Ln(e.issuer);c.tbsCertificate.issuer=ie.parse(y.toArrayBuffer(),Rt)}const l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},h=dr.resolve(Qa);c.tbsCertificate.signature=c.signatureAlgorithm=h.toAsnAlgorithm(u);const d=ie.serialize(c.tbsCertificate),g="signingKey"in e?await t.subtle.sign(u,e.signingKey,d):e.signature,m=dr.resolveAll(Bd).reverse();let b=null;for(const y of m)if(b=y.toAsnSignature(u,g),b)break;if(!b)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=b,new K5(ie.serialize(c))}static generateSerialNumber(e,t){let n=e&&e.length&&e.some(i=>i>0)?new Uint8Array(e):void 0;n||(n=t.getRandomValues(new Uint8Array(16)));let s=0;for(;s<n.length-1&&n[s]===0;)s++;if(n=n.slice(s),n[0]>127){const i=new Uint8Array(n.length+1);i[0]=0,i.set(n,1),n=i}return n}}var L9;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(L9||(L9={}));An.register(hT,F5);An.register(pT,GT);An.register(mT,YT);An.register(vT,T2);An.register(Vy,jh);An.register(bT,QT);An.register(Wy,ZT);An.register(Fy,JT);An.register(gT,ek);k2.register(KT,tk);k2.register(U5,V5);dr.registerSingleton(Bd,rJ);dr.registerSingleton(Bd,Bn);Bn.namedCurveSize.set("P-256",32);Bn.namedCurveSize.set("K-256",32);Bn.namedCurveSize.set("P-384",48);Bn.namedCurveSize.set("P-521",66);class iJ extends Tt{async listen(){throw new AX("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const rk=Object.values(p1).map(r=>r.decoder).reduce((r,e)=>r.or(e)),oJ=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function aJ(r){return r?.match(oJ)?.groups?.fingerprint}function nk(r){const t=r.stringTuples().filter(n=>n[0]===VQ).map(n=>n[1])[0];if(t===void 0||t==="")throw new te(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function cJ(r){return pr(rk.decode(r))}function lJ(r){const e=cJ(nk(r)),t=hJ(e.code),n=e.digest.reduce((i,o)=>i+o.toString(16).padStart(2,"0"),""),s=n.match(/.{1,2}/g);if(s==null)throw new xX(n,r.toString());return`${t} ${s.join(":").toUpperCase()}`}function uJ(r){const e=r.split(":").map(s=>parseInt(s,16)),t=Uint8Array.from(e),n=vi(Qr.code,t);return Ie(`/certhash/${Jh.encode(n.bytes)}`)}function hJ(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new IX(r)}}function dJ(r,e){const{host:t,port:n,family:s}=r.toOptions(),i=lJ(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${s} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${s} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${i}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${J0}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function fJ(r,e){const{host:t,port:n,family:s}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${s} ${t}
s=-
c=IN IP${s} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${J0}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function B9(r,e){if(r.sdp===void 0)throw new te("Can't munge a missing SDP");const t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}const em=ne("libp2p-webrtc-noise:");function pJ(r,e,t){const n=r.trim().toLowerCase().replaceAll(":",""),s=ne(n,"hex"),i=vi(Qr.code,s),o=rk.decode(nk(e)),a=em.byteLength+i.bytes.byteLength+o.byteLength;return Rr(t==="server"?[em,o,i.bytes]:[em,i.bytes,o],a)}const gJ=c5?"iceconnectionstatechange":"connectionstatechange";async function mJ(r,e,t){const n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");const h=await r.createOffer();t.log.trace("client created local offer %s",h.sdp);const d=B9(h,e);t.log.trace("client setting local offer %s",d.sdp),await r.setLocalDescription(d);const g=dJ(t.remoteAddr,e);t.log.trace("client setting server description %s",g.sdp),await r.setRemoteDescription(g)}else{const h=fJ(t.remoteAddr,e);t.log.trace("server setting client %s %s",h.type,h.sdp),await r.setRemoteDescription(h),t.log.trace("server creating local answer");const d=await r.createAnswer();t.log.trace("server created local answer");const g=B9(d,e);t.log.trace("server setting local description %s",d.sdp),await r.setLocalDescription(g)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await Pr(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){const h=r.remoteFingerprint()?.value??"";t.remoteAddr=t.remoteAddr.encapsulate(uJ(h))}const s=aJ(r.localDescription?.sdp);if(s==null)throw new _d("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);const i=pJ(s,t.remoteAddr,t.role),o=e5({prologueBytes:i})(t),a=hp({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),c=new Ry(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(gJ,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":c.close().catch(h=>{t.log.error("error closing connection",h),c.abort(h)});break;default:break}}),t.events?.increment({peer_connection:!0});const l=new h5(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await o.secureInbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal});t.log.trace("%s secure outbound",t.role);const u=await o.secureOutbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});c.remoteAddr=c.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal})}catch(s){throw n.close(),s}}async function yJ(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const s=typeof t=="function"?await t():t;return new RTCPeerConnection({...s??{},certificates:[n]})}async function wJ(r){const e=await xS(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...re(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}class bJ{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new Tt,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new te("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[n0]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[Jt]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n;const s=e.getPeerId();s!=null&&(n=Ht(s));const i=yX(),o=await yJ("client",i,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await mJ(o,i,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(a){throw o.close(),a}}createListener(e){if(this.certificate==null)throw new ll;return new iJ(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(Wm.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(vJ(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:s}=await this.loadOrCreateCertificate(t,e);return{privateKey:await wJ(t),pem:n,certhash:s}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??QQ,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new Ut;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await h0("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n;const s=new ft(this.init.certificateDatastoreKey??YQ),i=await xS(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new Ut;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(s,i)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(s,i)}let o=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??ob)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:n.toString("pem"),certhash:Jh.encode((await Qr.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){const n=await this.components.datastore.get(e),s=new K5(n),i=s.notAfter.getTime()-(this.init.certificateRenewalThreshold??ob);if(Date.now()>i)throw this.log("stored TLS certificate has expired"),new Ut;this.log("loaded certificate, expires in %d ms",i);const o=await s.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!$e(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new Ut;return this.log("loaded certificate, expiry time is %o",i),s}async createCertificate(e,t){const n=new Date,s=new Date(Date.now()+(this.init.certificateLifespan??XQ));n.setMilliseconds(0),s.setMilliseconds(0);const i=await sJ.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:s,keys:t,extensions:[new F5(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,ne(i.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),i}getKeychain(){try{return this.components.keychain}catch{}}}function vJ(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function EJ(r){return e=>new bJ(e,r)}function sk(r){return e=>new PX(e,r)}const SJ=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})},_J=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const s of n){try{await SJ(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{r.close()})})});var C2={},P2={};Object.defineProperty(P2,"__esModule",{value:!0});class xJ{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let ik=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const s=new xJ;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};P2.EventIterator=ik;P2.default=ik;Object.defineProperty(C2,"__esModule",{value:!0});const q5=P2;var AJ=C2.EventIterator=q5.EventIterator;function IJ(r,e,t){return new q5.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}C2.subscribe=IJ;C2.default=q5.EventIterator;function $9(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}const TJ=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((i,o)=>{if(n){i();return}if(s!=null){o(s);return}const a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(i)},l=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){const i=new AJ(({push:o,stop:a,fail:c})=>{const l=h=>{let d=null;typeof h.data=="string"&&(d=ne(h.data)),$9(h.data)&&(d=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(d=h.data),d!=null&&o(d)},u=h=>{c(h.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of i)yield $9(o)?new Uint8Array(o):o}();let n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},kJ=(r,e)=>{e=e??{};const t=TJ(r);let n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:_J(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}},CJ=WebSocket,PJ={"http:":"ws:","https:":"wss:"},U9="ws:",DJ=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??U9}${r}`),r.startsWith("/")&&e!=null){const n=e.protocol??U9,s=e.host,i=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${s}${i}${r}`}const t=new URL(r);for(const[n,s]of Object.entries(PJ))t.protocol===n&&(t.protocol=s);return t};function RJ(r,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const n=DJ(r,t),s=new CJ(n.toString(),e.websocket);return kJ(s,e)}function ok(r){return r.filter(e=>L1.exactMatch(e)||Ih.exactMatch(e))}function NJ(){throw new Error("WebSocket Servers can not be created in the browser!")}const OJ=500;function MJ(r,e,t){const n=t.logger.forComponent("libp2p:websockets:maconn"),s=t.metrics,i=t.metricPrefix??"",o={log:n,async sink(a){try{await r.sink(async function*(){for await(const c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){const c=Date.now();if(a.signal==null){const u=AbortSignal.timeout(OJ);a={...a,signal:u}}const l=()=>{const{host:u,port:h}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",u,h,Date.now()-c),this.abort(new wi("Socket close timeout"))};a.signal?.addEventListener("abort",l);try{await r.close()}catch(u){n.error("error closing WebSocket gracefully",u),this.abort(u)}finally{a.signal?.removeEventListener("abort",l),o.timeline.close=Date.now()}},abort(a){const{host:c,port:l}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),o.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return r.socket.addEventListener("close",()=>{s?.increment({[`${i}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}class LJ{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[n0]=!0;[Symbol.toStringTag]="@libp2p/websockets";[Jt]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=await this._connect(e,t),s=MJ(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const s=Fe(),i=RJ(M6(e),this.init);i.socket.addEventListener("error",()=>{const o=new lE(`Could not connect to ${e.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),s.reject(o)});try{t.onProgress?.(new ve("websockets:open-connection")),await Zt(Promise.race([i.connected(),s.promise]),t.signal)}catch(o){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return NJ({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):ok(e)}dialFilter(e){return this.listenFilter(e)}}function ak(r={}){return e=>new LJ(e,r)}function BJ(r,e){const t=e.map((n,s)=>({record:yd(n),index:s}));return t.sort((n,s)=>{const i=n.record.sequence,o=s.record.sequence;if(i>o)return-1;if(i<o)return 1;if(n.record.validityType===cs.ValidityType.EOL&&s.record.validityType===cs.ValidityType.EOL){const a=sy.fromString(n.record.validity).toDate(),c=sy.fromString(s.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const $J="5.4.2",UJ="helia",FJ={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function VJ(r={}){const e=`${UJ}/${$J} ${tx()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[BI(),sk(),EJ(),ak()],connectionEncrypters:[e5()],streamMuxers:[AI(),DQ()],peerDiscovery:[sG(FJ)],services:{autoNAT:TI(),dcutr:$I(),delegatedRouting:()=>SH("https://delegated-ipfs.dev",_H()),dht:fQ({clientMode:!0,validators:{ipns:sA},selectors:{ipns:BJ}}),identify:VI(),identifyPush:LG(),keychain:aI(r.keychain),ping:GI()}}}async function KJ(r){const e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await wW(r.datastore,r.keychain));const t=VJ(e);return t.datastore=t.datastore??r.datastore,await rx({...t,...e,start:!1})}async function qJ(r={}){const e=r.datastore??new d6,t=r.blockstore??new aA;let n;return HJ(r.libp2p)?n=r.libp2p:n=await KJ({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[tH(),$q()],routers:r.routers??[GH(n),WH()],metrics:n.metrics,start:r.start??!0}}function HJ(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}async function zJ(r={}){const e=await qJ(r),t=new rq(e);return r.start!==!1&&await t.start(),t}var H5={exports:{}},il=typeof Reflect=="object"?Reflect:null,F9=il&&typeof il.apply=="function"?il.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},Jf;il&&typeof il.ownKeys=="function"?Jf=il.ownKeys:Object.getOwnPropertySymbols?Jf=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Jf=function(e){return Object.getOwnPropertyNames(e)};function WJ(r){console&&console.warn&&console.warn(r)}var ck=Number.isNaN||function(e){return e!==e};function ct(){ct.init.call(this)}H5.exports=ct;H5.exports.once=QJ;ct.EventEmitter=ct;ct.prototype._events=void 0;ct.prototype._eventsCount=0;ct.prototype._maxListeners=void 0;var V9=10;function D2(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(ct,"defaultMaxListeners",{enumerable:!0,get:function(){return V9},set:function(r){if(typeof r!="number"||r<0||ck(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");V9=r}});ct.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};ct.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ck(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function lk(r){return r._maxListeners===void 0?ct.defaultMaxListeners:r._maxListeners}ct.prototype.getMaxListeners=function(){return lk(this)};ct.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s=e==="error",i=this._events;if(i!==void 0)s=s&&i.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[e];if(c===void 0)return!1;if(typeof c=="function")F9(c,this,t);else for(var l=c.length,u=pk(c,l),n=0;n<l;++n)F9(u[n],this,t);return!0};function uk(r,e,t,n){var s,i,o;if(D2(t),i=r._events,i===void 0?(i=r._events=Object.create(null),r._eventsCount=0):(i.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),i=r._events),o=i[e]),o===void 0)o=i[e]=t,++r._eventsCount;else if(typeof o=="function"?o=i[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),s=lk(r),s>0&&o.length>s&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,WJ(a)}return r}ct.prototype.addListener=function(e,t){return uk(this,e,t,!1)};ct.prototype.on=ct.prototype.addListener;ct.prototype.prependListener=function(e,t){return uk(this,e,t,!0)};function jJ(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function hk(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},s=jJ.bind(n);return s.listener=t,n.wrapFn=s,s}ct.prototype.once=function(e,t){return D2(t),this.on(e,hk(this,e,t)),this};ct.prototype.prependOnceListener=function(e,t){return D2(t),this.prependListener(e,hk(this,e,t)),this};ct.prototype.removeListener=function(e,t){var n,s,i,o,a;if(D2(t),s=this._events,s===void 0)return this;if(n=s[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;i===0?n.shift():GJ(n,i),n.length===1&&(s[e]=n[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};ct.prototype.off=ct.prototype.removeListener;ct.prototype.removeAllListeners=function(e){var t,n,s;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var i=Object.keys(n),o;for(s=0;s<i.length;++s)o=i[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function dk(r,e,t){var n=r._events;if(n===void 0)return[];var s=n[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?YJ(s):pk(s,s.length)}ct.prototype.listeners=function(e){return dk(this,e,!0)};ct.prototype.rawListeners=function(e){return dk(this,e,!1)};ct.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):fk.call(r,e)};ct.prototype.listenerCount=fk;function fk(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}ct.prototype.eventNames=function(){return this._eventsCount>0?Jf(this._events):[]};function pk(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function GJ(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function YJ(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function QJ(r,e){return new Promise(function(t,n){function s(o){r.removeListener(e,i),n(o)}function i(){typeof r.removeListener=="function"&&r.removeListener("error",s),t([].slice.call(arguments))}gk(r,e,i,{once:!0}),e!=="error"&&XJ(r,s,{once:!0})})}function XJ(r,e,t){typeof r.on=="function"&&gk(r,"error",e,t)}function gk(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function s(i){n.once&&r.removeEventListener(e,s),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var R2=H5.exports,ZJ=function(){return Date.now()};const kf=ZJ;class JJ{constructor(e,t,n){const s=this;this._started=kf(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(kf()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=kf();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=kf(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function eee(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new JJ(arguments[0],arguments[1],r)}var tee=eee;const{AbortController:ree}=globalThis,K9=tee;class z5 extends ree{constructor(e){super(),this._ms=e,this._timer=K9(()=>this.abort(),e),Object.setPrototypeOf(this,z5.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=K9(()=>this.abort(),this._ms)}}var Y3={TimeoutController:z5};const po=(...r)=>r.join("/").replace(/((?<=\/)\/+)|(^\.\/)|((?<=\/)\.\/)/g,"")||".",nee=3e4,see=async({ipfs:r,log:e,events:t,onSynced:n,start:s,timeout:i})=>{if(!r)throw new Error("An instance of ipfs is required.");if(!e)throw new Error("An instance of log is required.");const o=r.libp2p,a=r.libp2p.services.pubsub,c=e.id,l=po("/orbitdb/heads/",c),u=new dl({concurrency:1}),h=new Set;t=t||new R2.EventEmitter,i=i||nee;let d=!1;const g=async D=>{const F=await e.heads();t.emit("join",D,F)},m=D=>async function*(){const F=await e.heads();for await(const{bytes:O}of F)yield O}(),b=D=>async F=>{for await(const O of F){const C=O.subarray();C&&n&&await n(C)}d&&await g(D)},y=async({connection:D,stream:F})=>{const O=String(D.remotePeer);try{h.add(O),await bn(F,b(O),m,F)}catch(C){h.delete(O),t.emit("error",C)}},_=async D=>{const F=async()=>{const{peerId:O,subscriptions:C}=D.detail,N=String(O),P=C.find(M=>M.topic===c);if(P)if(P.subscribe){if(h.has(N))return;const M=new Y3.TimeoutController(i),{signal:K}=M;try{h.add(N);const H=await o.dialProtocol(O,l,{signal:K});await bn(m,H,b(N))}catch(H){h.delete(N),H.name==="UnsupportedProtocolError"||t.emit("error",H)}finally{M&&M.clear()}}else h.delete(N),t.emit("leave",N)};u.add(F)},A=async D=>{const{topic:F,data:O}=D.detail,C=async()=>{try{O&&n&&await n(O)}catch(N){t.emit("error",N)}};F===c&&u.add(C)},R=async D=>{h.delete(D.detail.toString())},I=async D=>{d&&await a.publish(c,D.bytes)},T=async()=>{d&&(d=!1,await u.onIdle(),a.removeEventListener("subscription-change",_),a.removeEventListener("message",A),await o.unhandle(l),await a.unsubscribe(c),o.removeEventListener("peer:disconnect",R),h.clear())},k=async()=>{d||(await o.handle(l,y),a.addEventListener("subscription-change",_),a.addEventListener("message",A),await a.subscribe(c),o.addEventListener("peer:disconnect",R),d=!0)};return s!==!1&&await k(),{add:I,stop:T,start:k,events:t,peers:h}};var Q3={exports:{}};typeof Object.create=="function"?Q3.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:Q3.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}};var iee=Q3.exports,mk=R2,oee=iee,aee=vn;function vn(r){if(!(this instanceof vn))return new vn(r);typeof r=="number"&&(r={max:r}),r||(r={}),mk.EventEmitter.call(this),this.cache={},this.head=this.tail=null,this.length=0,this.max=r.max||1e3,this.maxAge=r.maxAge||0}oee(vn,mk.EventEmitter);Object.defineProperty(vn.prototype,"keys",{get:function(){return Object.keys(this.cache)}});vn.prototype.clear=function(){this.cache={},this.head=this.tail=null,this.length=0};vn.prototype.remove=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];return delete this.cache[r],this._unlink(r,e.prev,e.next),e.value}};vn.prototype._unlink=function(r,e,t){this.length--,this.length===0?this.head=this.tail=null:this.head===r?(this.head=e,this.cache[this.head].next=null):this.tail===r?(this.tail=t,this.cache[this.tail].prev=null):(this.cache[e].next=t,this.cache[t].prev=e)};vn.prototype.peek=function(r){if(this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return e.value}};vn.prototype.set=function(r,e){typeof r!="string"&&(r=""+r);var t;if(this.cache.hasOwnProperty(r)){if(t=this.cache[r],t.value=e,this.maxAge&&(t.modified=Date.now()),r===this.head)return e;this._unlink(r,t.prev,t.next)}else t={value:e,modified:0,next:null,prev:null},this.maxAge&&(t.modified=Date.now()),this.cache[r]=t,this.length===this.max&&this.evict();return this.length++,t.next=null,t.prev=this.head,this.head&&(this.cache[this.head].next=r),this.head=r,this.tail||(this.tail=r),e};vn.prototype._checkAge=function(r,e){return this.maxAge&&Date.now()-e.modified>this.maxAge?(this.remove(r),this.emit("evict",{key:r,value:e.value}),!1):!0};vn.prototype.get=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return this.head!==r&&(r===this.tail?(this.tail=e.next,this.cache[this.tail].prev=null):this.cache[e.prev].next=e.next,this.cache[e.next].prev=e.prev,this.cache[this.head].next=r,e.prev=this.head,e.next=null,this.head=r),e.value}};vn.prototype.evict=function(){if(this.tail){var r=this.tail,e=this.remove(this.tail);this.emit("evict",{key:r,value:e})}};const X3=nc(aee),cee=(r,e)=>{const t=r.time-e.time;return t===0&&r.id!==e.id?r.id<e.id?-1:1:t},lee=r=>N2(r.id,++r.time),N2=(r,e)=>(e=e||0,{id:r,time:e}),uee=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},W5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};function hee(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var b=0,y=0,_=0,A=m.length;_!==A&&m[_]===0;)_++,b++;for(var R=(A-_)*u+1>>>0,I=new Uint8Array(R);_!==A;){for(var T=m[_],k=0,D=R-1;(T!==0||k<y)&&D!==-1;D--,k++)T+=256*I[D]>>>0,I[D]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");y=k,_++}for(var F=R-y;F!==R&&I[F]===0;)F++;for(var O=c.repeat(b);F<R;++F)O+=r.charAt(I[F]);return O}function d(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var b=0;if(m[b]!==" "){for(var y=0,_=0;m[b]===c;)y++,b++;for(var A=(m.length-b)*l+1>>>0,R=new Uint8Array(A);m[b];){var I=t[m.charCodeAt(b)];if(I===255)return;for(var T=0,k=A-1;(I!==0||T<_)&&k!==-1;k--,T++)I+=a*R[k]>>>0,R[k]=I%256>>>0,I=I/256>>>0;if(I!==0)throw new Error("Non-zero carry");_=T,b++}if(m[b]!==" "){for(var D=A-_;D!==A&&R[D]===0;)D++;for(var F=new Uint8Array(y+(A-D)),O=y;D!==A;)F[O++]=R[D++];return F}}}function g(m){var b=d(m);if(b)return b;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:d,decode:g}}var dee=hee,fee=dee;class pee{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class gee{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return yk(this,e)}}class mee{constructor(e){this.decoders=e}or(e){return yk(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const yk=(r,e)=>new mee({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class yee{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new pee(e,t,n),this.decoder=new gee(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const wk=({name:r,prefix:e,encode:t,decode:n})=>new yee(r,e,t,n),bk=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=fee(t,e);return wk({prefix:r,name:e,encode:n,decode:i=>W5(s(i))})},wee=(r,e,t,n)=>{const s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,l=0;for(let u=0;u<i;++u){const h=s[r[u]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},bee=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Bi=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>wk({prefix:e,name:r,encode(s){return bee(s,n,t)},decode(s){return wee(s,n,t,r)}}),e1=Bi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Bi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Bi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Bi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Bi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Bi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Bi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Bi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Bi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Cr=bk({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});bk({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var vee=vk,q9=128,Eee=-128,See=Math.pow(2,31);function vk(r,e,t){e=e||[],t=t||0;for(var n=t;r>=See;)e[t++]=r&255|q9,r/=128;for(;r&Eee;)e[t++]=r&255|q9,r>>>=7;return e[t]=r|0,vk.bytes=t-n+1,e}var _ee=Z3,xee=128,H9=127;function Z3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Z3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&H9)<<s:(o&H9)*Math.pow(2,s),s+=7}while(o>=xee);return Z3.bytes=i-n,t}var Aee=Math.pow(2,7),Iee=Math.pow(2,14),Tee=Math.pow(2,21),kee=Math.pow(2,28),Cee=Math.pow(2,35),Pee=Math.pow(2,42),Dee=Math.pow(2,49),Ree=Math.pow(2,56),Nee=Math.pow(2,63),Oee=function(r){return r<Aee?1:r<Iee?2:r<Tee?3:r<kee?4:r<Cee?5:r<Pee?6:r<Dee?7:r<Ree?8:r<Nee?9:10},Mee={encode:vee,decode:_ee,encodingLength:Oee},qp=Mee;const J3=(r,e=0)=>[qp.decode(r,e),qp.decode.bytes],Hp=(r,e,t=0)=>(qp.encode(r,e,t),e),zp=r=>qp.encodingLength(r),e4=(r,e)=>{const t=e.byteLength,n=zp(r),s=n+zp(t),i=new Uint8Array(s+t);return Hp(r,i,0),Hp(t,i,n),i.set(e,s),new j5(r,t,e,i)},Lee=r=>{const e=W5(r),[t,n]=J3(e),[s,i]=J3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new j5(t,s,o,e)},Bee=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&uee(r.bytes,t.bytes)}};class j5{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}const z9=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Uee(t,t4(r),e||Cr.encoder);default:return Fee(t,t4(r),e||e1.encoder)}},W9=new WeakMap,t4=r=>{const e=W9.get(r);if(e==null){const t=new Map;return W9.set(r,t),t}return e};class ht{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Cu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Vee)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ht.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=e4(e,t);return ht.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ht.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Bee(e.multihash,n.multihash)}toString(e){return z9(this,e)}toJSON(){return{"/":z9(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ht)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ht(n,s,i,o||j9(n,s,i.bytes))}else if(t[Kee]===!0){const{version:n,multihash:s,code:i}=t,o=Lee(s);return ht.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Cu)throw new Error(`Version 0 CID must use dag-pb (code: ${Cu}) block encoding`);return new ht(e,t,n,n.bytes)}case 1:{const s=j9(e,t,n.bytes);return new ht(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ht.create(0,Cu,e)}static createV1(e,t){return ht.create(1,e,t)}static decode(e){const[t,n]=ht.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ht.inspectBytes(e),n=t.size-t.multihashSize,s=W5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new j5(t.multihashCode,t.digestSize,i,s);return[t.version===0?ht.createV0(o):ht.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,d]=J3(e.subarray(t));return t+=d,h};let s=n(),i=Cu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){const[n,s]=$ee(e,t),i=ht.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return t4(i).set(n,e),i}}const $ee=(r,e)=>{switch(r[0]){case"Q":{const t=e||Cr;return[Cr.prefix,t.decode(`${Cr.prefix}${r}`)]}case Cr.prefix:{const t=e||Cr;return[Cr.prefix,t.decode(r)]}case e1.prefix:{const t=e||e1;return[e1.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Uee=(r,e,t)=>{const{prefix:n}=t;if(n!==Cr.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Fee=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Cu=112,Vee=18,j9=(r,e,t)=>{const n=zp(r),s=n+zp(e),i=new Uint8Array(s+t.byteLength);return Hp(r,i,0),Hp(e,i,n),i.set(t,s),i},Kee=Symbol.for("@ipld/js-cid/CID"),qee=({name:r,code:e,encode:t})=>new Hee(r,e,t);class Hee{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?e4(this.code,t):t.then(n=>e4(this.code,n))}else throw Error("Unknown type, must be binary type")}}function Cf({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*zee(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=ht.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*r4(n,s))}else{const t=ht.asCID(e);t?yield[r.join("/"),t]:yield*r4(e,r)}}function*r4(r,e){if(r==null||r instanceof Uint8Array)return;const t=ht.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*zee(i,s)}}function*Wee(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!ht.asCID(n)&&(yield*n4(n,s))}else yield*n4(e,r)}function*n4(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!ht.asCID(n)&&(yield*Wee(s,n))}}function jee(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=ht.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}class Ek{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:Cf(),bytes:Cf(),value:Cf(),asBlock:Cf()})}links(){return r4(this.value,[])}tree(){return n4(this.value,[])}get(e="/"){return jee(this.value,e.split("/").filter(Boolean))}}async function pu({value:r,codec:e,hasher:t}){if(typeof r>"u")throw new Error('Missing required argument "value"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.encode(r),s=await t.digest(n),i=ht.create(1,e.code,s);return new Ek({value:r,bytes:n,cid:i})}async function O2({bytes:r,codec:e,hasher:t}){if(!r)throw new Error('Missing required argument "bytes"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.decode(r),s=await t.digest(r),i=ht.create(1,e.code,s);return new Ek({value:n,bytes:r,cid:i})}const Gee=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),M2=qee({name:"sha2-256",code:18,encode:Gee("SHA-256")}),L2=fd,B2=M2,Sk=Cr,Yee=async(r,e,t,n=null,s=[],i=[])=>{if(r==null)throw new Error("Identity is required, cannot create entry");if(e==null)throw new Error("Entry requires an id");if(t==null)throw new Error("Entry requires a payload");if(s==null||!Array.isArray(s))throw new Error("'next' argument is not an array");n=n||N2(r.publicKey);const o={id:e,payload:t,next:s,refs:i,clock:n,v:2},{bytes:a}=await pu({value:o,codec:L2,hasher:B2}),c=await r.sign(r,a);return o.key=r.publicKey,o.identity=r.hash,o.sig=c,xk(o)},Qee=async(r,e)=>{if(!r)throw new Error("Identities is required, cannot verify entry");if(!_k(e))throw new Error("Invalid Log entry");if(!e.key)throw new Error("Entry doesn't have a key");if(!e.sig)throw new Error("Entry doesn't have a signature");const t={id:e.id,payload:e.payload,next:e.next,refs:e.refs,clock:e.clock,v:e.v},{bytes:n}=await pu({value:t,codec:L2,hasher:B2});return r.verify(e.sig,e.key,n)},_k=r=>r&&r.id!==void 0&&r.next!==void 0&&r.payload!==void 0&&r.v!==void 0&&r.clock!==void 0&&r.refs!==void 0,Xee=(r,e)=>r&&e&&r.hash===e.hash,Zee=async r=>{const{cid:e,value:t}=await O2({bytes:r,codec:L2,hasher:B2}),n=e.toString(Sk);return{...t,hash:n,bytes:r}},xk=async r=>{const{cid:e,bytes:t}=await pu({value:r,codec:L2,hasher:B2}),n=e.toString(Sk),s=N2(r.clock.id,r.clock.time);return{...r,clock:s,hash:n,bytes:t}},ii={create:Yee,verify:Qee,decode:Zee,encode:xk,isEntry:_k,isEqual:Xee},G5=async()=>{let r={};const e=async(c,l)=>{r[c]=l};return{put:e,del:async c=>{delete r[c]},get:async c=>r[c],iterator:async function*(){for await(const[c,l]of Object.entries(r))yield[c,l]},merge:async c=>{if(c)for await(const[l,u]of c.iterator())e(l,u)},clear:async()=>{r={}},close:async()=>{}}},Jee=G5,ete=async({storage:r,heads:e})=>{r=r||await Jee();const t=async u=>{u=G9(u);for(const h of u)await r.put(h.hash,h.bytes)},n=async u=>{await r.clear(),await t(u)},s=async u=>{const h=await a();if(h.find(g=>ii.isEqual(g,u)))return;const d=G9([...h,u]);return await n(d),d},i=async u=>{const d=(await a()).filter(g=>g.hash!==u);await n(d)},o=async function*(){const u=r.iterator();for await(const[,h]of u)yield await ii.decode(h)},a=async()=>{const u=[];for await(const h of o())u.push(h);return u},c=async()=>{await r.clear()},l=async()=>{await r.close()};return await t(e||[]),{put:t,set:n,add:s,remove:i,iterator:o,all:a,clear:c,close:l}},G9=r=>{r=new Set(r);const e={};for(const n of r)for(const s of n.next)e[s]=n.hash;const t=[];for(const n of r)e[n.hash]||t.push(n);return t};function tte(r,e){const t=(i,o)=>i,n=(i,o)=>nte(i,o,t);return((i,o)=>rte(i,o,n))(r,e)}function rte(r,e,t){const n=cee(r.clock,e.clock);return n===0?t(r,e):n}function nte(r,e,t){return r.clock.id===e.clock.id?t(r,e):r.clock.id<e.clock.id?-1:1}function ste(r){const e=`Your log's tiebreaker function, ${r.name}, has returned zero and therefore cannot be`;return(n,s)=>{const i=r(n,s);if(i===0)throw Error(e);return i}}const ite={LastWriteWins:tte,NoZeroes:ste},{LastWriteWins:ote,NoZeroes:ate}=ite,cte=()=>new Date().getTime().toString(),lte=(r,e)=>Math.max(r,e.clock.time),tm=G5,ute=async()=>({canAppend:async r=>!0}),hte=async(r,{logId:e,logHeads:t,access:n,entryStorage:s,headsStorage:i,indexStorage:o,sortFn:a}={})=>{if(r==null)throw new Error("Identity is required");if(t!=null&&!Array.isArray(t))throw new Error("'logHeads' argument must be an array");const c=e||cte();n=n||await ute();const l=s||await tm(),u=o||await tm();i=i||await tm();const h=await ete({storage:i,heads:t});a=ate(a||ote);const d=new dl({concurrency:1}),g=new dl({concurrency:1}),m=async()=>{const P=Math.max(0,(await b()).reduce(lte,0));return N2(r.publicKey,P)},b=async()=>(await h.all()).sort(a).reverse(),y=async()=>{const P=[];for await(const M of k())P.unshift(M);return P},_=async P=>{const M=await l.get(P);if(M)return await ii.decode(M)},A=async P=>await u.get(P)!=null,R=async(P,M={referencesCount:0})=>{const K=async()=>{const H=await b(),$=H.map(Y=>Y.hash),B=await N(H,M.referencesCount+H.length),z=await ii.create(r,c,P,lee(await m()),$,B);if(!await n.canAppend(z))throw new Error(`Could not append entry:
Key "${r.hash}" is not allowed to write to the log`);return await h.set([z]),await l.put(z.hash,z.bytes),await u.put(z.hash,!0),z};return d.add(K)},I=async P=>{if(!P)throw new Error("Log instance not defined");if(!C(P))throw new Error("Given argument is not an instance of Log");l.merge&&await l.merge(P.storage);const M=await P.heads();for(const K of M)await T(K)},T=async P=>{const M=async()=>{if(await A(P.hash))return!1;const H=async Q=>{if(Q.id!==c)throw new Error(`Entry's id (${Q.id}) doesn't match the log's id (${c}).`);if(!await n.canAppend(Q))throw new Error(`Could not append entry:
Key "${Q.identity}" is not allowed to write to the log`);if(!await ii.verify(r,Q))throw new Error(`Could not validate signature for entry "${Q.hash}"`)};await H(P);const $=(await b()).map(Q=>Q.hash),B=new Set([P.hash]),z=new Set([...P.next,...P.refs]),q=new Set,Y=async()=>{const Q=Array.from(z.values()).filter(A).map(_),j=await Promise.all(Q);for(const we of j){z.delete(we.hash),await H(we),B.add(we.hash);for(const ue of[...we.next,...we.refs])!await A(ue)&&!B.has(ue)?z.add(ue):$.includes(ue)&&q.add(ue)}z.size>0&&await Y()};await Y();for(const Q of B.values())await u.put(Q,!0);for(const Q of q.values())await h.remove(Q);return await l.put(P.hash,P.bytes),await h.add(P),!0};return g.add(M)},k=async function*(P,M){M=M||(()=>!1),P=P||await b();let H=P.sort(a);const $={};let B=[];const z={},q=Q=>!($[Q]||z[Q]);let Y;for(;H.length>0;)if(H=H.sort(a),Y=H.pop(),Y){const{hash:Q,next:j}=Y;if(!$[Q]){if(yield Y,await M(Y)===!0)break;$[Q]=!0,z[Q]=!0,B=[...B,...j].filter(q);const ue=ce=>{if(!$[ce]&&!z[ce])return z[ce]=!0,_(ce)},fe=await Promise.all(B.map(ue));B=fe.filter(ce=>ce!=null).reduce((ce,ke)=>Array.from(new Set([...ce,...ke.next])),[]).filter(q),H=[...fe,...H]}}},D=async function*({amount:P=-1,gt:M,gte:K,lt:H,lte:$}={}){if(P===0)return;if(typeof $=="string"&&($=[await _($)]),typeof H=="string"){const ce=await _(H);H=await Promise.all(ce.next.map(Oe=>_(Oe)))}if(H!=null&&!Array.isArray(H))throw new Error("lt must be a string or an array of Entries");if($!=null&&!Array.isArray($))throw new Error("lte must be a string or an array of Entries");const B=(H||$||await b()).filter(ce=>ce!=null),z=M||K?await _(M||K):null,q=z||P===-1?-1:P;let Y=0;const Q=async ce=>(Y++,ce?!!(Y>=q&&q!==-1||z&&ii.isEqual(ce,z)):!1),j=z&&P!==-1&&!H&&!$,we=j?new X3(P+2):null;let ue=0;const fe=k(B,Q);for await(const ce of fe){const ke=H&&ii.isEqual(ce,B),Oe=M&&ii.isEqual(ce,z);ke||Oe||(j?we.set(ue++,ce.hash):yield ce)}if(j){const ce=we.keys.length,ke=ce>P?ce-P:0,Oe=we.keys.slice(ke,ce);for(const ot of Oe){const lt=we.get(ot);yield await _(lt)}}},F=async()=>{await u.clear(),await h.clear(),await l.clear()},O=async()=>{await u.close(),await h.close(),await l.close()},C=P=>P&&P.id!==void 0&&P.clock!==void 0&&P.heads!==void 0&&P.values!==void 0&&P.access!==void 0&&P.identity!==void 0&&P.storage!==void 0,N=async(P,M=0)=>{let K=[];const H=async $=>K.length>=M&&M!==-1;for await(const{hash:$}of k(P,H))K.push($);return K=K.slice(P.length+1,M),K};return{id:c,clock:m,heads:b,values:y,all:y,get:_,has:A,append:R,join:I,joinEntry:T,traverse:k,iterator:D,clear:F,close:O,access:n,identity:r,storage:l}},ka=async(r,e)=>({put:async(l,u)=>{await r.put(l,u),await e.put(l,u)},get:async l=>{let u=await r.get(l);return u||(u=await e.get(l),u&&await r.put(l,u)),u},del:async l=>{await r.del(l),await e.del(l)},iterator:async function*({amount:l,reverse:u}={}){const h=[],d={amount:l||-1,reverse:u||!1};for(const g of[r,e])for await(const[m,b]of g.iterator(d))h[m]||(h[m]=!0,yield[m,b])},merge:async l=>{await r.merge(l),await e.merge(l),await l.merge(r),await l.merge(e)},clear:async()=>{await r.clear(),await e.clear()},close:async()=>{await r.close(),await e.close()}}),Y9=3e4,$2=async({ipfs:r,pin:e,timeout:t}={})=>{if(!r)throw new Error("An instance of ipfs is required.");return{put:async(u,h)=>{const d=ht.parse(u,Cr),{signal:g}=new Y3.TimeoutController(t||Y9);await r.blockstore.put(d,h,{signal:g}),e&&!await r.pins.isPinned(d)&&await Si(r.pins.add(d))},del:async u=>{},get:async u=>{const h=ht.parse(u,Cr),{signal:d}=new Y3.TimeoutController(t||Y9),g=await r.blockstore.get(h,{signal:d});if(g)return g},iterator:async function*(){},merge:async u=>{},clear:async()=>{},close:async()=>{}}};var Ak={},Bo={},U2={},Ik={};Ik.supports=function(...e){const t=e.reduce((n,s)=>Object.assign(n,s),{});return Object.assign(t,{snapshots:t.snapshots||!1,permanence:t.permanence||!1,seek:t.seek||!1,clear:t.clear||!1,getMany:t.getMany||!1,keyIterator:t.keyIterator||!1,valueIterator:t.valueIterator||!1,iteratorNextv:t.iteratorNextv||!1,iteratorAll:t.iteratorAll||!1,status:t.status||!1,createIfMissing:t.createIfMissing||!1,errorIfExists:t.errorIfExists||!1,deferredOpen:t.deferredOpen||!1,promises:t.promises||!1,streams:t.streams||!1,encodings:Object.assign({},t.encodings),events:Object.assign({},t.events),additionalMethods:Object.assign({},t.additionalMethods)})};var Tk={},Hs=class extends Error{constructor(e,t){super(e||""),typeof t=="object"&&t!==null&&(t.code&&(this.code=String(t.code)),t.expected&&(this.expected=!0),t.transient&&(this.transient=!0),t.cause&&(this.cause=t.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},mc={};const Y5=hM($z);let rm=null;var kk=function(){return rm===null&&(rm={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),rm},$d={},Q5={};const nm=Hs,dte=new Set(["buffer","view","utf8"]);let fte=class{constructor(e){if(this.encode=e.encode||this.encode,this.decode=e.decode||this.decode,this.name=e.name||this.name,this.format=e.format||this.format,typeof this.encode!="function")throw new TypeError("The 'encode' property must be a function");if(typeof this.decode!="function")throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),typeof this.name!="string"||this.name==="")throw new TypeError("The 'name' property must be a string");if(typeof this.format!="string"||!dte.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");e.createViewTranscoder&&(this.createViewTranscoder=e.createViewTranscoder),e.createBufferTranscoder&&(this.createBufferTranscoder=e.createBufferTranscoder),e.createUTF8Transcoder&&(this.createUTF8Transcoder=e.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new nm(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new nm(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new nm(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}};Q5.Encoding=fte;const{Buffer:X5}=Y5||{},{Encoding:Z5}=Q5,pte=kk;let J5=class extends Z5{constructor(e){super({...e,format:"buffer"})}createViewTranscoder(){return new e8({encode:this.encode,decode:e=>this.decode(X5.from(e.buffer,e.byteOffset,e.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}},e8=class extends Z5{constructor(e){super({...e,format:"view"})}createBufferTranscoder(){return new J5({encode:e=>{const t=this.encode(e);return X5.from(t.buffer,t.byteOffset,t.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}},gte=class extends Z5{constructor(e){super({...e,format:"utf8"})}createBufferTranscoder(){return new J5({encode:e=>X5.from(this.encode(e),"utf8"),decode:e=>this.decode(e.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:e,textDecoder:t}=pte();return new e8({encode:n=>e.encode(this.encode(n)),decode:n=>this.decode(t.decode(n)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}};$d.BufferFormat=J5;$d.ViewFormat=e8;$d.UTF8Format=gte;const{Buffer:Er}=Y5||{Buffer:{isBuffer:()=>!1}},{textEncoder:Ck,textDecoder:Q9}=kk(),{BufferFormat:Ud,ViewFormat:t8,UTF8Format:Pk}=$d,Wp=r=>r;mc.utf8=new Pk({encode:function(r){return Er.isBuffer(r)?r.toString("utf8"):ArrayBuffer.isView(r)?Q9.decode(r):String(r)},decode:Wp,name:"utf8",createViewTranscoder(){return new t8({encode:function(r){return ArrayBuffer.isView(r)?r:Ck.encode(r)},decode:function(r){return Q9.decode(r)},name:`${this.name}+view`})},createBufferTranscoder(){return new Ud({encode:function(r){return Er.isBuffer(r)?r:ArrayBuffer.isView(r)?Er.from(r.buffer,r.byteOffset,r.byteLength):Er.from(String(r),"utf8")},decode:function(r){return r.toString("utf8")},name:`${this.name}+buffer`})}});mc.json=new Pk({encode:JSON.stringify,decode:JSON.parse,name:"json"});mc.buffer=new Ud({encode:function(r){return Er.isBuffer(r)?r:ArrayBuffer.isView(r)?Er.from(r.buffer,r.byteOffset,r.byteLength):Er.from(String(r),"utf8")},decode:Wp,name:"buffer",createViewTranscoder(){return new t8({encode:function(r){return ArrayBuffer.isView(r)?r:Er.from(String(r),"utf8")},decode:function(r){return Er.from(r.buffer,r.byteOffset,r.byteLength)},name:`${this.name}+view`})}});mc.view=new t8({encode:function(r){return ArrayBuffer.isView(r)?r:Ck.encode(r)},decode:Wp,name:"view",createBufferTranscoder(){return new Ud({encode:function(r){return Er.isBuffer(r)?r:ArrayBuffer.isView(r)?Er.from(r.buffer,r.byteOffset,r.byteLength):Er.from(String(r),"utf8")},decode:Wp,name:`${this.name}+buffer`})}});mc.hex=new Ud({encode:function(r){return Er.isBuffer(r)?r:Er.from(String(r),"hex")},decode:function(r){return r.toString("hex")},name:"hex"});mc.base64=new Ud({encode:function(r){return Er.isBuffer(r)?r:Er.from(String(r),"base64")},decode:function(r){return r.toString("base64")},name:"base64"});const X9=Hs,jp=mc,{Encoding:mte}=Q5,{BufferFormat:yte,ViewFormat:wte,UTF8Format:bte}=$d,Pu=Symbol("formats"),Pf=Symbol("encodings"),vte=new Set(["buffer","view","utf8"]);let Ete=class{constructor(e){if(Array.isArray(e)){if(!e.every(t=>vte.has(t)))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}else throw new TypeError("The first argument 'formats' must be an array");this[Pf]=new Map,this[Pu]=new Set(e);for(const t in jp)try{this.encoding(t)}catch(n){if(n.code!=="LEVEL_ENCODING_NOT_SUPPORTED")throw n}}encodings(){return Array.from(new Set(this[Pf].values()))}encoding(e){let t=this[Pf].get(e);if(t===void 0){if(typeof e=="string"&&e!==""){if(t=Ate[e],!t)throw new X9(`Encoding '${e}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if(typeof e!="object"||e===null)throw new TypeError("First argument 'encoding' must be a string or object");t=Ste(e)}const{name:n,format:s}=t;if(!this[Pu].has(s))if(this[Pu].has("view"))t=t.createViewTranscoder();else if(this[Pu].has("buffer"))t=t.createBufferTranscoder();else if(this[Pu].has("utf8"))t=t.createUTF8Transcoder();else throw new X9(`Encoding '${n}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});for(const i of[e,n,t.name,t.commonName])this[Pf].set(i,t)}return t}};Tk.Transcoder=Ete;function Ste(r){if(r instanceof mte)return r;const e="type"in r&&typeof r.type=="string"?r.type:void 0,t=r.name||e||`anonymous-${Ite++}`;switch(_te(r)){case"view":return new wte({...r,name:t});case"utf8":return new bte({...r,name:t});case"buffer":return new yte({...r,name:t});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}function _te(r){return"format"in r&&r.format!==void 0?r.format:"buffer"in r&&typeof r.buffer=="boolean"?r.buffer?"buffer":"utf8":"code"in r&&Number.isInteger(r.code)?"view":"buffer"}const xte={binary:jp.buffer,"utf-8":jp.utf8},Ate={...jp,...xte};let Ite=0;var gu={},Tte=typeof queueMicrotask=="function"?queueMicrotask:r=>Promise.resolve().then(r),Z9=Tte;gu.fromCallback=function(r,e){if(r===void 0){var t=new Promise(function(n,s){r=function(i,o){i?s(i):n(o)}});r[e!==void 0?e:"promise"]=t}else if(typeof r!="function")throw new TypeError("Callback must be a function");return r};gu.fromPromise=function(r,e){if(e===void 0)return r;r.then(function(t){Z9(()=>e(null,t))}).catch(function(t){Z9(()=>e(t))})};var zs={},Fd={};Fd.getCallback=function(r,e){return typeof r=="function"?r:e};Fd.getOptions=function(r,e){return typeof r=="object"&&r!==null?r:e!==void 0?e:{}};const{fromCallback:sm}=gu,ln=Hs,{getOptions:im,getCallback:J9}=Fd,zo=Symbol("promise"),Cc=Symbol("callback"),ws=Symbol("working"),ga=Symbol("handleOne"),oi=Symbol("handleMany"),om=Symbol("autoClose"),Po=Symbol("finishWork"),Ms=Symbol("returnMany"),ji=Symbol("closing"),Du=Symbol("handleClose"),Df=Symbol("closed"),Ru=Symbol("closeCallbacks"),go=Symbol("keyEncoding"),Ja=Symbol("valueEncoding"),am=Symbol("abortOnClose"),Rf=Symbol("legacy"),cm=Symbol("keys"),lm=Symbol("values"),Gi=Symbol("limit"),Nn=Symbol("count"),Nf=Object.freeze({}),kte=()=>{};let ev=!1;class r8{constructor(e,t,n){if(typeof e!="object"||e===null){const s=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${s}`)}if(typeof t!="object"||t===null)throw new TypeError("The second argument must be an options object");this[Df]=!1,this[Ru]=[],this[ws]=!1,this[ji]=!1,this[om]=!1,this[Cc]=null,this[ga]=this[ga].bind(this),this[oi]=this[oi].bind(this),this[Du]=this[Du].bind(this),this[go]=t[go],this[Ja]=t[Ja],this[Rf]=n,this[Gi]=Number.isInteger(t.limit)&&t.limit>=0?t.limit:1/0,this[Nn]=0,this[am]=!!t.abortOnClose,this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get count(){return this[Nn]}get limit(){return this[Gi]}next(e){let t;if(e===void 0)t=new Promise((n,s)=>{e=(i,o,a)=>{i?s(i):this[Rf]?o===void 0&&a===void 0?n():n([o,a]):n(o)}});else if(typeof e!="function")throw new TypeError("Callback must be a function");return this[ji]?this.nextTick(e,new ln("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[ws]?this.nextTick(e,new ln("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[ws]=!0,this[Cc]=e,this[Nn]>=this[Gi]?this.nextTick(this[ga],null):this._next(this[ga])),t}_next(e){this.nextTick(e)}nextv(e,t,n){return n=J9(t,n),n=sm(n,zo),t=im(t,Nf),Number.isInteger(e)?(this[ji]?this.nextTick(n,new ln("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[ws]?this.nextTick(n,new ln("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(e<1&&(e=1),this[Gi]<1/0&&(e=Math.min(e,this[Gi]-this[Nn])),this[ws]=!0,this[Cc]=n,e<=0?this.nextTick(this[oi],null,[]):this._nextv(e,t,this[oi])),n[zo]):(this.nextTick(n,new TypeError("The first argument 'size' must be an integer")),n[zo])}_nextv(e,t,n){const s=[],i=(o,a,c)=>{if(o)return n(o);if(this[Rf]?a===void 0&&c===void 0:a===void 0)return n(null,s);s.push(this[Rf]?[a,c]:a),s.length===e?n(null,s):this._next(i)};this._next(i)}all(e,t){return t=J9(e,t),t=sm(t,zo),e=im(e,Nf),this[ji]?this.nextTick(t,new ln("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[ws]?this.nextTick(t,new ln("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[ws]=!0,this[Cc]=t,this[om]=!0,this[Nn]>=this[Gi]?this.nextTick(this[oi],null,[]):this._all(e,this[oi])),t[zo]}_all(e,t){let n=this[Nn];const s=[],i=()=>{const a=this[Gi]<1/0?Math.min(1e3,this[Gi]-n):1e3;a<=0?this.nextTick(t,null,s):this._nextv(a,Nf,o)},o=(a,c)=>{a?t(a):c.length===0?t(null,s):(s.push.apply(s,c),n+=c.length,i())};i()}[Po](){const e=this[Cc];return this[am]&&e===null?kte:(this[ws]=!1,this[Cc]=null,this[ji]&&this._close(this[Du]),e)}[Ms](e,t,n){this[om]?this.close(e.bind(null,t,n)):e(t,n)}seek(e,t){if(t=im(t,Nf),!this[ji]){if(this[ws])throw new ln("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const n=this.db.keyEncoding(t.keyEncoding||this[go]),s=n.format;t.keyEncoding!==s&&(t={...t,keyEncoding:s});const i=this.db.prefixKey(n.encode(e),s);this._seek(i,t)}}}_seek(e,t){throw new ln("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(e){return e=sm(e,zo),this[Df]?this.nextTick(e):this[ji]?this[Ru].push(e):(this[ji]=!0,this[Ru].push(e),this[ws]?this[am]&&this[Po]()(new ln("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[Du])),e[zo]}_close(e){this.nextTick(e)}[Du](){this[Df]=!0,this.db.detachResource(this);const e=this[Ru];this[Ru]=[];for(const t of e)t()}async*[Symbol.asyncIterator](){try{let e;for(;(e=await this.next())!==void 0;)yield e}finally{this[Df]||await this.close()}}}let F2=class extends r8{constructor(e,t){super(e,t,!0),this[cm]=t.keys!==!1,this[lm]=t.values!==!1}[ga](e,t,n){const s=this[Po]();if(e)return s(e);try{t=this[cm]&&t!==void 0?this[go].decode(t):void 0,n=this[lm]&&n!==void 0?this[Ja].decode(n):void 0}catch(i){return s(new Ul("entry",i))}t===void 0&&n===void 0||this[Nn]++,s(null,t,n)}[oi](e,t){const n=this[Po]();if(e)return this[Ms](n,e);try{for(const s of t){const i=s[0],o=s[1];s[0]=this[cm]&&i!==void 0?this[go].decode(i):void 0,s[1]=this[lm]&&o!==void 0?this[Ja].decode(o):void 0}}catch(s){return this[Ms](n,new Ul("entries",s))}this[Nn]+=t.length,this[Ms](n,null,t)}end(e){return!ev&&typeof console<"u"&&(ev=!0,console.warn(new ln("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(e)}},Cte=class extends r8{constructor(e,t){super(e,t,!1)}[ga](e,t){const n=this[Po]();if(e)return n(e);try{t=t!==void 0?this[go].decode(t):void 0}catch(s){return n(new Ul("key",s))}t!==void 0&&this[Nn]++,n(null,t)}[oi](e,t){const n=this[Po]();if(e)return this[Ms](n,e);try{for(let s=0;s<t.length;s++){const i=t[s];t[s]=i!==void 0?this[go].decode(i):void 0}}catch(s){return this[Ms](n,new Ul("keys",s))}this[Nn]+=t.length,this[Ms](n,null,t)}},Pte=class extends r8{constructor(e,t){super(e,t,!1)}[ga](e,t){const n=this[Po]();if(e)return n(e);try{t=t!==void 0?this[Ja].decode(t):void 0}catch(s){return n(new Ul("value",s))}t!==void 0&&this[Nn]++,n(null,t)}[oi](e,t){const n=this[Po]();if(e)return this[Ms](n,e);try{for(let s=0;s<t.length;s++){const i=t[s];t[s]=i!==void 0?this[Ja].decode(i):void 0}}catch(s){return this[Ms](n,new Ul("values",s))}this[Nn]+=t.length,this[Ms](n,null,t)}};class Ul extends ln{constructor(e,t){super(`Iterator could not decode ${e}`,{code:"LEVEL_DECODE_ERROR",cause:t})}}for(const r of["_ended property","_nexting property","_end method"])Object.defineProperty(F2.prototype,r.split(" ")[0],{get(){throw new ln(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new ln(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})}});F2.keyEncoding=go;F2.valueEncoding=Ja;zs.AbstractIterator=F2;zs.AbstractKeyIterator=Cte;zs.AbstractValueIterator=Pte;var n8={};const{AbstractKeyIterator:Dte,AbstractValueIterator:Rte}=zs,ia=Symbol("iterator"),Nu=Symbol("callback"),Fl=Symbol("handleOne"),Ca=Symbol("handleMany");let s4=class extends Dte{constructor(e,t){super(e,t),this[ia]=e.iterator({...t,keys:!0,values:!1}),this[Fl]=this[Fl].bind(this),this[Ca]=this[Ca].bind(this)}},Dk=class extends Rte{constructor(e,t){super(e,t),this[ia]=e.iterator({...t,keys:!1,values:!0}),this[Fl]=this[Fl].bind(this),this[Ca]=this[Ca].bind(this)}};for(const r of[s4,Dk]){const e=r===s4,t=e?n=>n[0]:n=>n[1];r.prototype._next=function(n){this[Nu]=n,this[ia].next(this[Fl])},r.prototype[Fl]=function(n,s,i){const o=this[Nu];n?o(n):o(null,e?s:i)},r.prototype._nextv=function(n,s,i){this[Nu]=i,this[ia].nextv(n,s,this[Ca])},r.prototype._all=function(n,s){this[Nu]=s,this[ia].all(n,this[Ca])},r.prototype[Ca]=function(n,s){const i=this[Nu];n?i(n):i(null,s.map(t))},r.prototype._seek=function(n,s){this[ia].seek(n,s)},r.prototype._close=function(n){this[ia].close(n)}}n8.DefaultKeyIterator=s4;n8.DefaultValueIterator=Dk;var V2={};const{AbstractIterator:Nte,AbstractKeyIterator:Ote,AbstractValueIterator:Mte}=zs,um=Hs,Fr=Symbol("nut"),K2=Symbol("undefer"),q2=Symbol("factory");let Rk=class extends Nte{constructor(e,t){super(e,t),this[Fr]=null,this[q2]=()=>e.iterator(t),this.db.defer(()=>this[K2]())}},Nk=class extends Ote{constructor(e,t){super(e,t),this[Fr]=null,this[q2]=()=>e.keys(t),this.db.defer(()=>this[K2]())}},Ok=class extends Mte{constructor(e,t){super(e,t),this[Fr]=null,this[q2]=()=>e.values(t),this.db.defer(()=>this[K2]())}};for(const r of[Rk,Nk,Ok])r.prototype[K2]=function(){this.db.status==="open"&&(this[Fr]=this[q2]())},r.prototype._next=function(e){this[Fr]!==null?this[Fr].next(e):this.db.status==="opening"?this.db.defer(()=>this._next(e)):this.nextTick(e,new um("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._nextv=function(e,t,n){this[Fr]!==null?this[Fr].nextv(e,t,n):this.db.status==="opening"?this.db.defer(()=>this._nextv(e,t,n)):this.nextTick(n,new um("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._all=function(e,t){this[Fr]!==null?this[Fr].all(t):this.db.status==="opening"?this.db.defer(()=>this._all(e,t)):this.nextTick(t,new um("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._seek=function(e,t){this[Fr]!==null?this[Fr]._seek(e,t):this.db.status==="opening"&&this.db.defer(()=>this._seek(e,t))},r.prototype._close=function(e){this[Fr]!==null?this[Fr].close(e):this.db.status==="opening"?this.db.defer(()=>this._close(e)):this.nextTick(e)};V2.DeferredIterator=Rk;V2.DeferredKeyIterator=Nk;V2.DeferredValueIterator=Ok;var Mk={},s8={};const{fromCallback:tv}=gu,Of=Hs,{getCallback:Lte,getOptions:Bte}=Fd,Mf=Symbol("promise"),Tn=Symbol("status"),Pc=Symbol("operations"),Ou=Symbol("finishClose"),Dc=Symbol("closeCallbacks");let $te=class{constructor(e){if(typeof e!="object"||e===null){const t=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${t}`)}this[Pc]=[],this[Dc]=[],this[Tn]="open",this[Ou]=this[Ou].bind(this),this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get length(){return this[Pc].length}put(e,t,n){if(this[Tn]!=="open")throw new Of("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const s=this.db._checkKey(e)||this.db._checkValue(t);if(s)throw s;const i=n&&n.sublevel!=null?n.sublevel:this.db,o=n,a=i.keyEncoding(n&&n.keyEncoding),c=i.valueEncoding(n&&n.valueEncoding),l=a.format;n={...n,keyEncoding:l,valueEncoding:c.format},i!==this.db&&(n.sublevel=null);const u=i.prefixKey(a.encode(e),l),h=c.encode(t);return this._put(u,h,n),this[Pc].push({...o,type:"put",key:e,value:t}),this}_put(e,t,n){}del(e,t){if(this[Tn]!=="open")throw new Of("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const n=this.db._checkKey(e);if(n)throw n;const s=t&&t.sublevel!=null?t.sublevel:this.db,i=t,o=s.keyEncoding(t&&t.keyEncoding),a=o.format;return t={...t,keyEncoding:a},s!==this.db&&(t.sublevel=null),this._del(s.prefixKey(o.encode(e),a),t),this[Pc].push({...i,type:"del",key:e}),this}_del(e,t){}clear(){if(this[Tn]!=="open")throw new Of("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[Pc]=[],this}_clear(){}write(e,t){return t=Lte(e,t),t=tv(t,Mf),e=Bte(e),this[Tn]!=="open"?this.nextTick(t,new Of("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):this.length===0?this.close(t):(this[Tn]="writing",this._write(e,n=>{this[Tn]="closing",this[Dc].push(()=>t(n)),n||this.db.emit("batch",this[Pc]),this._close(this[Ou])})),t[Mf]}_write(e,t){}close(e){return e=tv(e,Mf),this[Tn]==="closing"?this[Dc].push(e):this[Tn]==="closed"?this.nextTick(e):(this[Dc].push(e),this[Tn]!=="writing"&&(this[Tn]="closing",this._close(this[Ou]))),e[Mf]}_close(e){this.nextTick(e)}[Ou](){this[Tn]="closed",this.db.detachResource(this);const e=this[Dc];this[Dc]=[];for(const t of e)t()}};s8.AbstractChainedBatch=$te;const{AbstractChainedBatch:Ute}=s8,Fte=Hs,Rc=Symbol("encoded");let Vte=class extends Ute{constructor(e){super(e),this[Rc]=[]}_put(e,t,n){this[Rc].push({...n,type:"put",key:e,value:t})}_del(e,t){this[Rc].push({...t,type:"del",key:e})}_clear(){this[Rc]=[]}_write(e,t){this.db.status==="opening"?this.db.defer(()=>this._write(e,t)):this.db.status==="open"?this[Rc].length===0?this.nextTick(t):this.db._batch(this[Rc],e,t):this.nextTick(t,new Fte("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}};Mk.DefaultChainedBatch=Vte;const rv=Hs,Kte=Object.prototype.hasOwnProperty,qte=new Set(["lt","lte","gt","gte"]);var Hte=function(r,e){const t={};for(const n in r)if(Kte.call(r,n)&&!(n==="keyEncoding"||n==="valueEncoding")){if(n==="start"||n==="end")throw new rv(`The legacy range option '${n}' has been removed`,{code:"LEVEL_LEGACY"});if(n==="encoding")throw new rv("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});qte.has(n)?t[n]=e.encode(r[n]):t[n]=r[n]}return t.reverse=!!t.reverse,t.limit=Number.isInteger(t.limit)&&t.limit>=0?t.limit:-1,t};/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let nv;var Lk=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:A1):r=>(nv||(nv=Promise.resolve())).then(r).catch(e=>setTimeout(()=>{throw e},0)),hm,sv;function zte(){if(sv)return hm;sv=1;const r=Lk;return hm=function(e,...t){t.length===0?r(e):r(()=>e(...t))},hm}var Mu={},iv;function Wte(){if(iv)return Mu;iv=1;const{AbstractIterator:r,AbstractKeyIterator:e,AbstractValueIterator:t}=zs,n=Symbol("unfix"),s=Symbol("iterator"),i=Symbol("handleOne"),o=Symbol("handleMany"),a=Symbol("callback");class c extends r{constructor(d,g,m,b){super(d,g),this[s]=m,this[n]=b,this[i]=this[i].bind(this),this[o]=this[o].bind(this),this[a]=null}[i](d,g,m){const b=this[a];if(d)return b(d);g!==void 0&&(g=this[n](g)),b(d,g,m)}[o](d,g){const m=this[a];if(d)return m(d);for(const b of g){const y=b[0];y!==void 0&&(b[0]=this[n](y))}m(d,g)}}class l extends e{constructor(d,g,m,b){super(d,g),this[s]=m,this[n]=b,this[i]=this[i].bind(this),this[o]=this[o].bind(this),this[a]=null}[i](d,g){const m=this[a];if(d)return m(d);g!==void 0&&(g=this[n](g)),m(d,g)}[o](d,g){const m=this[a];if(d)return m(d);for(let b=0;b<g.length;b++){const y=g[b];y!==void 0&&(g[b]=this[n](y))}m(d,g)}}class u extends t{constructor(d,g,m){super(d,g),this[s]=m}}for(const h of[c,l])h.prototype._next=function(d){this[a]=d,this[s].next(this[i])},h.prototype._nextv=function(d,g,m){this[a]=m,this[s].nextv(d,g,this[o])},h.prototype._all=function(d,g){this[a]=g,this[s].all(d,this[o])};for(const h of[u])h.prototype._next=function(d){this[s].next(d)},h.prototype._nextv=function(d,g,m){this[s].nextv(d,g,m)},h.prototype._all=function(d,g){this[s].all(d,g)};for(const h of[c,l,u])h.prototype._seek=function(d,g){this[s].seek(d,g)},h.prototype._close=function(d){this[s].close(d)};return Mu.AbstractSublevelIterator=c,Mu.AbstractSublevelKeyIterator=l,Mu.AbstractSublevelValueIterator=u,Mu}var dm,ov;function jte(){if(ov)return dm;ov=1;const r=Hs,{Buffer:e}=Y5||{},{AbstractSublevelIterator:t,AbstractSublevelKeyIterator:n,AbstractSublevelValueIterator:s}=Wte(),i=Symbol("prefix"),o=Symbol("upperBound"),a=Symbol("prefixRange"),c=Symbol("parent"),l=Symbol("unfix"),u=new TextEncoder,h={separator:"!"};dm=function({AbstractLevel:_}){class A extends _{static defaults(I){if(typeof I=="string")throw new r("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(I&&I.open)throw new r("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return I==null?h:I.separator?I:{...I,separator:"!"}}constructor(I,T,k){const{separator:D,manifest:F,...O}=A.defaults(k);T=y(T,D);const C=D.charCodeAt(0)+1,N=I[c]||I;if(!u.encode(T).every(K=>K>C&&K<127))throw new r(`Prefix must use bytes > ${C} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(d(N,F),O);const P=(I.prefix||"")+D+T+D,M=P.slice(0,-1)+String.fromCharCode(C);this[c]=N,this[i]=new m(P),this[o]=new m(M),this[l]=new b,this.nextTick=N.nextTick}prefixKey(I,T){if(T==="utf8")return this[i].utf8+I;if(I.byteLength===0)return this[i][T];if(T==="view"){const k=this[i].view,D=new Uint8Array(k.byteLength+I.byteLength);return D.set(k,0),D.set(I,k.byteLength),D}else{const k=this[i].buffer;return e.concat([k,I],k.byteLength+I.byteLength)}}[a](I,T){I.gte!==void 0?I.gte=this.prefixKey(I.gte,T):I.gt!==void 0?I.gt=this.prefixKey(I.gt,T):I.gte=this[i][T],I.lte!==void 0?I.lte=this.prefixKey(I.lte,T):I.lt!==void 0?I.lt=this.prefixKey(I.lt,T):I.lte=this[o][T]}get prefix(){return this[i].utf8}get db(){return this[c]}_open(I,T){this[c].open({passive:!0},T)}_put(I,T,k,D){this[c].put(I,T,k,D)}_get(I,T,k){this[c].get(I,T,k)}_getMany(I,T,k){this[c].getMany(I,T,k)}_del(I,T,k){this[c].del(I,T,k)}_batch(I,T,k){this[c].batch(I,T,k)}_clear(I,T){this[a](I,I.keyEncoding),this[c].clear(I,T)}_iterator(I){this[a](I,I.keyEncoding);const T=this[c].iterator(I),k=this[l].get(this[i].utf8.length,I.keyEncoding);return new t(this,I,T,k)}_keys(I){this[a](I,I.keyEncoding);const T=this[c].keys(I),k=this[l].get(this[i].utf8.length,I.keyEncoding);return new n(this,I,T,k)}_values(I){this[a](I,I.keyEncoding);const T=this[c].values(I);return new s(this,I,T)}}return{AbstractSublevel:A}};const d=function(_,A){return{..._.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...A,encodings:{utf8:g(_,"utf8"),buffer:g(_,"buffer"),view:g(_,"view")}}},g=function(_,A){return _.supports.encodings[A]?_.keyEncoding(A).name===A:!1};class m{constructor(A){this.utf8=A,this.view=u.encode(A),this.buffer=e?e.from(this.view.buffer,0,this.view.byteLength):{}}}class b{constructor(){this.cache=new Map}get(A,R){let I=this.cache.get(R);return I===void 0&&(R==="view"?I=function(T,k){return k.subarray(T)}.bind(null,A):I=function(T,k){return k.slice(T)}.bind(null,A),this.cache.set(R,I)),I}}const y=function(_,A){let R=0,I=_.length;for(;R<I&&_[R]===A;)R++;for(;I>R&&_[I-1]===A;)I--;return _.slice(R,I)};return dm}const{supports:Gte}=Ik,{Transcoder:Yte}=Tk,{EventEmitter:Qte}=R2,{fromCallback:Yi}=gu,Xn=Hs,{AbstractIterator:Wo}=zs,{DefaultKeyIterator:Xte,DefaultValueIterator:Zte}=n8,{DeferredIterator:Jte,DeferredKeyIterator:ere,DeferredValueIterator:tre}=V2,{DefaultChainedBatch:av}=Mk,{getCallback:jo,getOptions:Qi}=Fd,Lf=Hte,De=Symbol("promise"),Xs=Symbol("landed"),Go=Symbol("resources"),fm=Symbol("closeResources"),Lu=Symbol("operations"),Bu=Symbol("undefer"),Bf=Symbol("deferOpen"),cv=Symbol("options"),Me=Symbol("status"),Yo=Symbol("defaultOptions"),Nc=Symbol("transcoder"),$f=Symbol("keyEncoding"),pm=Symbol("valueEncoding"),rre=()=>{};let i8=class extends Qte{constructor(e,t){if(super(),typeof e!="object"||e===null)throw new TypeError("The first argument 'manifest' must be an object");t=Qi(t);const{keyEncoding:n,valueEncoding:s,passive:i,...o}=t;this[Go]=new Set,this[Lu]=[],this[Bf]=!0,this[cv]=o,this[Me]="opening",this.supports=Gte(e,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:e.snapshots!==!1,permanence:e.permanence!==!1,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:e.encodings||{},events:Object.assign({},e.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[Nc]=new Yte(nre(this)),this[$f]=this[Nc].encoding(n||"utf8"),this[pm]=this[Nc].encoding(s||"utf8");for(const a of this[Nc].encodings())this.supports.encodings[a.commonName]||(this.supports.encodings[a.commonName]=!0);this[Yo]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[$f].commonName,valueEncoding:this[pm].commonName}),key:Object.freeze({keyEncoding:this[$f].commonName})},this.nextTick(()=>{this[Bf]&&this.open({passive:!1},rre)})}get status(){return this[Me]}keyEncoding(e){return this[Nc].encoding(e??this[$f])}valueEncoding(e){return this[Nc].encoding(e??this[pm])}open(e,t){t=jo(e,t),t=Yi(t,De),e={...this[cv],...Qi(e)},e.createIfMissing=e.createIfMissing!==!1,e.errorIfExists=!!e.errorIfExists;const n=s=>{this[Me]==="closing"||this[Me]==="opening"?this.once(Xs,s?()=>n(s):n):this[Me]!=="open"?t(new Xn("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:s})):t()};return e.passive?this[Me]==="opening"?this.once(Xs,n):this.nextTick(n):this[Me]==="closed"||this[Bf]?(this[Bf]=!1,this[Me]="opening",this.emit("opening"),this._open(e,s=>{if(s){this[Me]="closed",this[fm](()=>{this.emit(Xs),n(s)}),this[Bu]();return}this[Me]="open",this[Bu](),this.emit(Xs),this[Me]==="open"&&this.emit("open"),this[Me]==="open"&&this.emit("ready"),n()})):this[Me]==="open"?this.nextTick(n):this.once(Xs,()=>this.open(e,t)),t[De]}_open(e,t){this.nextTick(t)}close(e){e=Yi(e,De);const t=n=>{this[Me]==="opening"||this[Me]==="closing"?this.once(Xs,n?t(n):t):this[Me]!=="closed"?e(new Xn("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:n})):e()};if(this[Me]==="open"){this[Me]="closing",this.emit("closing");const n=s=>{this[Me]="open",this[Bu](),this.emit(Xs),t(s)};this[fm](()=>{this._close(s=>{if(s)return n(s);this[Me]="closed",this[Bu](),this.emit(Xs),this[Me]==="closed"&&this.emit("closed"),t()})})}else this[Me]==="closed"?this.nextTick(t):this.once(Xs,()=>this.close(e));return e[De]}[fm](e){if(this[Go].size===0)return this.nextTick(e);let t=this[Go].size,n=!0;const s=()=>{--t===0&&(n?this.nextTick(e):e())};for(const i of this[Go])i.close(s);n=!1,this[Go].clear()}_close(e){this.nextTick(e)}get(e,t,n){if(n=jo(t,n),n=Yi(n,De),t=Qi(t,this[Yo].entry),this[Me]==="opening")return this.defer(()=>this.get(e,t,n)),n[De];if(Oc(this,n))return n[De];const s=this._checkKey(e);if(s)return this.nextTick(n,s),n[De];const i=this.keyEncoding(t.keyEncoding),o=this.valueEncoding(t.valueEncoding),a=i.format,c=o.format;return(t.keyEncoding!==a||t.valueEncoding!==c)&&(t=Object.assign({},t,{keyEncoding:a,valueEncoding:c})),this._get(this.prefixKey(i.encode(e),a),t,(l,u)=>{if(l)return(l.code==="LEVEL_NOT_FOUND"||l.notFound||/NotFound/i.test(l))&&(l.code||(l.code="LEVEL_NOT_FOUND"),l.notFound||(l.notFound=!0),l.status||(l.status=404)),n(l);try{u=o.decode(u)}catch(h){return n(new Xn("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,u)}),n[De]}_get(e,t,n){this.nextTick(n,new Error("NotFound"))}getMany(e,t,n){if(n=jo(t,n),n=Yi(n,De),t=Qi(t,this[Yo].entry),this[Me]==="opening")return this.defer(()=>this.getMany(e,t,n)),n[De];if(Oc(this,n))return n[De];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'keys' must be an array")),n[De];if(e.length===0)return this.nextTick(n,null,[]),n[De];const s=this.keyEncoding(t.keyEncoding),i=this.valueEncoding(t.valueEncoding),o=s.format,a=i.format;(t.keyEncoding!==o||t.valueEncoding!==a)&&(t=Object.assign({},t,{keyEncoding:o,valueEncoding:a}));const c=new Array(e.length);for(let l=0;l<e.length;l++){const u=e[l],h=this._checkKey(u);if(h)return this.nextTick(n,h),n[De];c[l]=this.prefixKey(s.encode(u),o)}return this._getMany(c,t,(l,u)=>{if(l)return n(l);try{for(let h=0;h<u.length;h++)u[h]!==void 0&&(u[h]=i.decode(u[h]))}catch(h){return n(new Xn(`Could not decode one or more of ${u.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,u)}),n[De]}_getMany(e,t,n){this.nextTick(n,null,new Array(e.length).fill(void 0))}put(e,t,n,s){if(s=jo(n,s),s=Yi(s,De),n=Qi(n,this[Yo].entry),this[Me]==="opening")return this.defer(()=>this.put(e,t,n,s)),s[De];if(Oc(this,s))return s[De];const i=this._checkKey(e)||this._checkValue(t);if(i)return this.nextTick(s,i),s[De];const o=this.keyEncoding(n.keyEncoding),a=this.valueEncoding(n.valueEncoding),c=o.format,l=a.format;(n.keyEncoding!==c||n.valueEncoding!==l)&&(n=Object.assign({},n,{keyEncoding:c,valueEncoding:l}));const u=this.prefixKey(o.encode(e),c),h=a.encode(t);return this._put(u,h,n,d=>{if(d)return s(d);this.emit("put",e,t),s()}),s[De]}_put(e,t,n,s){this.nextTick(s)}del(e,t,n){if(n=jo(t,n),n=Yi(n,De),t=Qi(t,this[Yo].key),this[Me]==="opening")return this.defer(()=>this.del(e,t,n)),n[De];if(Oc(this,n))return n[De];const s=this._checkKey(e);if(s)return this.nextTick(n,s),n[De];const i=this.keyEncoding(t.keyEncoding),o=i.format;return t.keyEncoding!==o&&(t=Object.assign({},t,{keyEncoding:o})),this._del(this.prefixKey(i.encode(e),o),t,a=>{if(a)return n(a);this.emit("del",e),n()}),n[De]}_del(e,t,n){this.nextTick(n)}batch(e,t,n){if(!arguments.length){if(this[Me]==="opening")return new av(this);if(this[Me]!=="open")throw new Xn("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(typeof e=="function"?n=e:n=jo(t,n),n=Yi(n,De),t=Qi(t,this[Yo].empty),this[Me]==="opening")return this.defer(()=>this.batch(e,t,n)),n[De];if(Oc(this,n))return n[De];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'operations' must be an array")),n[De];if(e.length===0)return this.nextTick(n),n[De];const s=new Array(e.length),{keyEncoding:i,valueEncoding:o,...a}=t;for(let c=0;c<e.length;c++){if(typeof e[c]!="object"||e[c]===null)return this.nextTick(n,new TypeError("A batch operation must be an object")),n[De];const l=Object.assign({},e[c]);if(l.type!=="put"&&l.type!=="del")return this.nextTick(n,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),n[De];const u=this._checkKey(l.key);if(u)return this.nextTick(n,u),n[De];const h=l.sublevel!=null?l.sublevel:this,d=h.keyEncoding(l.keyEncoding||i),g=d.format;if(l.key=h.prefixKey(d.encode(l.key),g),l.keyEncoding=g,l.type==="put"){const m=this._checkValue(l.value);if(m)return this.nextTick(n,m),n[De];const b=h.valueEncoding(l.valueEncoding||o);l.value=b.encode(l.value),l.valueEncoding=b.format}h!==this&&(l.sublevel=null),s[c]=l}return this._batch(s,a,c=>{if(c)return n(c);this.emit("batch",e),n()}),n[De]}_batch(e,t,n){this.nextTick(n)}sublevel(e,t){return this._sublevel(e,i4.defaults(t))}_sublevel(e,t){return new i4(this,e,t)}prefixKey(e,t){return e}clear(e,t){if(t=jo(e,t),t=Yi(t,De),e=Qi(e,this[Yo].empty),this[Me]==="opening")return this.defer(()=>this.clear(e,t)),t[De];if(Oc(this,t))return t[De];const n=e,s=this.keyEncoding(e.keyEncoding);return e=Lf(e,s),e.keyEncoding=s.format,e.limit===0?this.nextTick(t):this._clear(e,i=>{if(i)return t(i);this.emit("clear",n),t()}),t[De]}_clear(e,t){this.nextTick(t)}iterator(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=Lf(e,t),e.keys=e.keys!==!1,e.values=e.values!==!1,e[Wo.keyEncoding]=t,e[Wo.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[Me]==="opening")return new Jte(this,e);if(this[Me]!=="open")throw new Xn("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(e)}_iterator(e){return new Wo(this,e)}keys(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=Lf(e,t),e[Wo.keyEncoding]=t,e[Wo.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[Me]==="opening")return new ere(this,e);if(this[Me]!=="open")throw new Xn("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(e)}_keys(e){return new Xte(this,e)}values(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=Lf(e,t),e[Wo.keyEncoding]=t,e[Wo.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[Me]==="opening")return new tre(this,e);if(this[Me]!=="open")throw new Xn("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(e)}_values(e){return new Zte(this,e)}defer(e){if(typeof e!="function")throw new TypeError("The first argument must be a function");this[Lu].push(e)}[Bu](){if(this[Lu].length===0)return;const e=this[Lu];this[Lu]=[];for(const t of e)t()}attachResource(e){if(typeof e!="object"||e===null||typeof e.close!="function")throw new TypeError("The first argument must be a resource object");this[Go].add(e)}detachResource(e){this[Go].delete(e)}_chainedBatch(){return new av(this)}_checkKey(e){if(e==null)return new Xn("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(e){if(e==null)return new Xn("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}};i8.prototype.nextTick=zte();const{AbstractSublevel:i4}=jte()({AbstractLevel:i8});U2.AbstractLevel=i8;U2.AbstractSublevel=i4;const Oc=function(r,e){return r[Me]!=="open"?(r.nextTick(e,new Xn("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0):!1},nre=function(r){return Object.keys(r.supports.encodings).filter(e=>!!r.supports.encodings[e])};Bo.AbstractLevel=U2.AbstractLevel;Bo.AbstractSublevel=U2.AbstractSublevel;Bo.AbstractIterator=zs.AbstractIterator;Bo.AbstractKeyIterator=zs.AbstractKeyIterator;Bo.AbstractValueIterator=zs.AbstractValueIterator;Bo.AbstractChainedBatch=s8.AbstractChainedBatch;/*! run-parallel-limit. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var sre=ore;const ire=Lk;function ore(r,e,t){if(typeof e!="number")throw new Error("second argument must be a Number");let n,s,i,o,a,c=!0,l;Array.isArray(r)?(n=[],i=s=r.length):(o=Object.keys(r),n={},i=s=o.length);function u(d){function g(){t&&t(d,n),t=null}c?ire(g):g()}function h(d,g,m){if(n[d]=m,g&&(a=!0),--i===0||g)u(g);else if(!a&&l<s){let b;o?(b=o[l],l+=1,r[b](function(y,_){h(b,y,_)})):(b=l,l+=1,r[b](function(y,_){h(b,y,_)}))}}l=e,i?o?o.some(function(d,g){return r[d](function(m,b){h(d,m,b)}),g===e-1}):r.some(function(d,g){return d(function(m,b){h(g,m,b)}),g===e-1}):u(null),c=!1}var Bk={},$k=function(e){const t=e.gte!==void 0?e.gte:e.gt!==void 0?e.gt:void 0,n=e.lte!==void 0?e.lte:e.lt!==void 0?e.lt:void 0,s=e.gte===void 0,i=e.lte===void 0;return t!==void 0&&n!==void 0?IDBKeyRange.bound(t,n,s,i):t!==void 0?IDBKeyRange.lowerBound(t,s):n!==void 0?IDBKeyRange.upperBound(n,i):null};const are=new TextEncoder;var Uk=function(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):are.encode(r)};const{AbstractIterator:cre}=Bo,lv=$k,Uf=Uk,bs=Symbol("cache"),Zs=Symbol("finished"),sn=Symbol("options"),Js=Symbol("currentOptions"),Qo=Symbol("position"),gm=Symbol("location"),Mc=Symbol("first"),uv={};let lre=class extends cre{constructor(e,t,n){super(e,n),this[bs]=[],this[Zs]=this.limit===0,this[sn]=n,this[Js]={...n},this[Qo]=void 0,this[gm]=t,this[Mc]=!0}_nextv(e,t,n){if(this[Mc]=!1,this[Zs])return this.nextTick(n,null,[]);if(this[bs].length>0)return e=Math.min(e,this[bs].length),this.nextTick(n,null,this[bs].splice(0,e));this[Qo]!==void 0&&(this[sn].reverse?(this[Js].lt=this[Qo],this[Js].lte=void 0):(this[Js].gt=this[Qo],this[Js].gte=void 0));let s;try{s=lv(this[Js])}catch{return this[Zs]=!0,this.nextTick(n,null,[])}const i=this.db.db.transaction([this[gm]],"readonly"),o=i.objectStore(this[gm]),a=[];if(this[sn].reverse){const c=!this[sn].values&&o.openKeyCursor?"openKeyCursor":"openCursor";o[c](s,"prev").onsuccess=l=>{const u=l.target.result;if(u){const{key:h,value:d}=u;this[Qo]=h,a.push([this[sn].keys&&h!==void 0?Uf(h):void 0,this[sn].values&&d!==void 0?Uf(d):void 0]),a.length<e?u.continue():hv(i)}else this[Zs]=!0}}else{let c,l;const u=()=>{if(c===void 0||l===void 0)return;const h=Math.max(c.length,l.length);h===0||e===1/0?this[Zs]=!0:this[Qo]=c[h-1],a.length=h;for(let d=0;d<h;d++){const g=c[d],m=l[d];a[d]=[this[sn].keys&&g!==void 0?Uf(g):void 0,this[sn].values&&m!==void 0?Uf(m):void 0]}hv(i)};this[sn].keys||e<1/0?o.getAllKeys(s,e<1/0?e:void 0).onsuccess=h=>{c=h.target.result,u()}:(c=[],this.nextTick(u)),this[sn].values?o.getAll(s,e<1/0?e:void 0).onsuccess=h=>{l=h.target.result,u()}:(l=[],this.nextTick(u))}i.onabort=()=>{n(i.error||new Error("aborted by user")),n=null},i.oncomplete=()=>{n(null,a),n=null}}_next(e){if(this[bs].length>0){const[t,n]=this[bs].shift();this.nextTick(e,null,t,n)}else if(this[Zs])this.nextTick(e);else{let t=Math.min(100,this.limit-this.count);this[Mc]&&(this[Mc]=!1,t=1),this._nextv(t,uv,(n,s)=>{if(n)return e(n);this[bs]=s,this._next(e)})}}_all(e,t){this[Mc]=!1;const n=this[bs].splice(0,this[bs].length),s=this.limit-this.count-n.length;if(s<=0)return this.nextTick(t,null,n);this._nextv(s,uv,(i,o)=>{if(i)return t(i);n.length>0&&(o=n.concat(o)),t(null,o)})}_seek(e,t){this[Mc]=!0,this[bs]=[],this[Zs]=!1,this[Qo]=void 0,this[Js]={...this[sn]};let n;try{n=lv(this[sn])}catch{this[Zs]=!0;return}n!==null&&!n.includes(e)?this[Zs]=!0:this[sn].reverse?this[Js].lte=e:this[Js].gte=e}};Bk.Iterator=lre;function hv(r){typeof r.commit=="function"&&r.commit()}var ure=function(e,t,n,s,i){if(s.limit===0)return e.nextTick(i);const o=e.db.transaction([t],"readwrite"),a=o.objectStore(t);let c=0;o.oncomplete=function(){i()},o.onabort=function(){i(o.error||new Error("aborted by user"))};const l=a.openKeyCursor?"openKeyCursor":"openCursor",u=s.reverse?"prev":"next";a[l](n,u).onsuccess=function(h){const d=h.target.result;d&&(a.delete(d.key).onsuccess=function(){(s.limit<=0||++c<s.limit)&&d.continue()})}};const{AbstractLevel:hre}=Bo,dv=Hs,dre=sre,{fromCallback:fre}=gu,{Iterator:pre}=Bk,fv=Uk,gre=ure,mre=$k,Fk="level-js-",$u=Symbol("idb"),mm=Symbol("namePrefix"),ei=Symbol("location"),ym=Symbol("version"),Xo=Symbol("store"),Uu=Symbol("onComplete"),pv=Symbol("promise");class Vk extends hre{constructor(e,t,n){if(typeof t=="function"||typeof n=="function")throw new dv("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:s,version:i,...o}=t||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},o),typeof e!="string")throw new Error("constructor requires a location string argument");this[ei]=e,this[mm]=s??Fk,this[ym]=parseInt(i||1,10),this[$u]=null}get location(){return this[ei]}get namePrefix(){return this[mm]}get version(){return this[ym]}get db(){return this[$u]}get type(){return"browser-level"}_open(e,t){const n=indexedDB.open(this[mm]+this[ei],this[ym]);n.onerror=function(){t(n.error||new Error("unknown error"))},n.onsuccess=()=>{this[$u]=n.result,t()},n.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(this[ei])||i.createObjectStore(this[ei])}}[Xo](e){return this[$u].transaction([this[ei]],e).objectStore(this[ei])}[Uu](e,t){const n=e.transaction;n.onabort=function(){t(n.error||new Error("aborted by user"))},n.oncomplete=function(){t(null,e.result)}}_get(e,t,n){const s=this[Xo]("readonly");let i;try{i=s.get(e)}catch(o){return this.nextTick(n,o)}this[Uu](i,function(o,a){if(o)return n(o);if(a===void 0)return n(new dv("Entry not found",{code:"LEVEL_NOT_FOUND"}));n(null,fv(a))})}_getMany(e,t,n){const s=this[Xo]("readonly"),i=e.map(o=>a=>{let c;try{c=s.get(o)}catch(l){return a(l)}c.onsuccess=()=>{const l=c.result;a(null,l===void 0?l:fv(l))},c.onerror=l=>{l.stopPropagation(),a(c.error)}});dre(i,16,n)}_del(e,t,n){const s=this[Xo]("readwrite");let i;try{i=s.delete(e)}catch(o){return this.nextTick(n,o)}this[Uu](i,n)}_put(e,t,n,s){const i=this[Xo]("readwrite");let o;try{o=i.put(t,e)}catch(a){return this.nextTick(s,a)}this[Uu](o,s)}_iterator(e){return new pre(this,this[ei],e)}_batch(e,t,n){const s=this[Xo]("readwrite"),i=s.transaction;let o=0,a;i.onabort=function(){n(a||i.error||new Error("aborted by user"))},i.oncomplete=function(){n()};function c(){const l=e[o++],u=l.key;let h;try{h=l.type==="del"?s.delete(u):s.put(l.value,u)}catch(d){a=d,i.abort();return}o<e.length?h.onsuccess=c:typeof i.commit=="function"&&i.commit()}c()}_clear(e,t){let n,s;try{n=mre(e)}catch{return this.nextTick(t)}if(e.limit>=0)return gre(this,this[ei],n,e,t);try{const i=this[Xo]("readwrite");s=n?i.delete(n):i.clear()}catch(i){return this.nextTick(t,i)}this[Uu](s,t)}_close(e){this[$u].close(),this.nextTick(e)}}Vk.destroy=function(r,e,t){typeof e=="function"&&(t=e,e=Fk),t=fre(t,pv);const n=indexedDB.deleteDatabase(e+r);return n.onsuccess=function(){t()},n.onerror=function(s){t(s)},t[pv]};Ak.BrowserLevel=Vk;var yre=Ak.BrowserLevel;const wre="./level",bre="view",o4=async({path:r,valueEncoding:e}={})=>{r=r||wre,e=e||bre;const t=new yre(r,{valueEncoding:e,passive:!0});return await t.open(),{put:async(u,h)=>{await t.put(u,h)},del:async u=>{await t.del(u)},get:async u=>{try{const h=await t.get(u);if(h)return h}catch{}},iterator:async function*({amount:u,reverse:h}={}){const d={limit:u||-1,reverse:h||!1};for await(const[g,m]of t.iterator(d))yield[g,m]},merge:async u=>{},clear:async()=>{await t.clear()},close:async()=>{await t.close()}}},gv=1e6,Ls=async({size:r}={})=>{let e=new X3(r||gv);return{put:async(l,u)=>{e.set(l,u)},del:async l=>{e.remove(l)},get:async l=>e.get(l),iterator:async function*(){for await(const l of e.keys){const u=e.get(l);yield[l,u]}},merge:async l=>{if(l)for await(const[u,h]of l.iterator())e.set(u,h)},clear:async()=>{e=new X3(r||gv)},close:async()=>{}}},vre=16,wm=1e3,o8=async({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d})=>{i=po(i||"./orbitdb",`./${t}/`),o=o||{},u=Number(u)>-1?u:vre,c=c||await ka(await Ls({size:wm}),await $2({ipfs:r,pin:!0})),a=a||await ka(await Ls({size:wm}),await o4({path:po(i,"/log/_heads/")})),l=l||await ka(await Ls({size:wm}),await o4({path:po(i,"/log/_index/")}));const g=await hte(e,{logId:t,access:s,entryStorage:c,headsStorage:a,indexStorage:l}),m=new R2.EventEmitter,b=new dl({concurrency:1}),y=async T=>{const k=async()=>{const F=await g.append(T,{referencesCount:u});return await I.add(F),d&&await d(g,F),m.emit("update",F),F.hash},D=await b.add(k);return await b.onIdle(),D},_=async T=>{const k=async()=>{const D=await ii.decode(T);D&&await g.joinEntry(D)&&(d&&await d(g,D),m.emit("update",D))};await b.add(k)},A=async()=>{await I.stop(),await b.onIdle(),await g.close(),s&&s.close&&await s.close(),m.emit("close")},R=async()=>{await b.onIdle(),await g.clear(),s&&s.drop&&await s.drop(),m.emit("drop")},I=await see({ipfs:r,log:g,events:m,onSynced:_,start:h});return{address:t,name:n,identity:e,meta:o,close:A,drop:R,addOperation:y,log:g,sync:I,peers:I.peers,events:m,access:s}},Kk="documents",Ere={indexBy:"_id"},qk=({indexBy:r}=Ere)=>async({ipfs:e,identity:t,address:n,name:s,access:i,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:u,referencesCount:h,syncAutomatically:d,onUpdate:g})=>{const m=await o8({ipfs:e,identity:t,address:n,name:s,access:i,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:u,referencesCount:h,syncAutomatically:d}),{addOperation:b,log:y}=m,_=async D=>{const F=D[r];if(!F)throw new Error(`The provided document doesn't contain field '${r}'`);return b({op:"PUT",key:F,value:D})},A=async D=>{if(!await R(D))throw new Error(`No document with key '${D}' in the database`);return b({op:"DEL",key:D,value:null})},R=async D=>{for await(const F of T())if(D===F.key)return F},I=async D=>{const F=[];for await(const O of T())D(O.value)&&F.push(O.value);return F},T=async function*({amount:D}={}){const F={};let O=0;for await(const C of y.iterator()){const{op:N,key:P,value:M}=C.payload;if(N==="PUT"&&!F[P]?(F[P]=!0,O++,yield{hash:C.hash,key:P,value:M}):N==="DEL"&&!F[P]&&(F[P]=!0),O>=D)break}};return{...m,type:Kk,put:_,del:A,get:R,iterator:T,query:I,indexBy:r,all:async()=>{const D=[];for await(const F of T())D.unshift(F);return D}}};qk.type=Kk;const Hk="events",zk=()=>async({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d})=>{const g=await o8({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d}),{addOperation:m,log:b}=g,y=async I=>m({op:"ADD",key:null,value:I}),_=async I=>(await b.get(I)).payload.value,A=async function*({gt:I,gte:T,lt:k,lte:D,amount:F}={}){const O=b.iterator({gt:I,gte:T,lt:k,lte:D,amount:F});for await(const C of O){const N=C.hash,P=C.payload.value;yield{hash:N,value:P}}};return{...g,type:Hk,add:y,get:_,iterator:A,all:async()=>{const I=[];for await(const T of A())I.unshift(T);return I}}};zk.type=Hk;const Wk="keyvalue",jk=()=>async({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d})=>{const g=await o8({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d}),{addOperation:m,log:b}=g,y=async(T,k)=>m({op:"PUT",key:T,value:k}),_=async T=>m({op:"DEL",key:T,value:null}),A=async T=>{for await(const k of b.traverse()){const{op:D,key:F,value:O}=k.payload;if(D==="PUT"&&F===T)return O;if(D==="DEL"&&F===T)return}},R=async function*({amount:T}={}){const k={};let D=0;for await(const F of b.traverse()){const{op:O,key:C,value:N}=F.payload;if(O==="PUT"&&!k[C]){k[C]=!0,D++;const P=F.hash;yield{key:C,value:N,hash:P}}else O==="DEL"&&!k[C]&&(k[C]=!0);if(D>=T)break}};return{...g,type:Wk,put:y,set:y,del:_,get:A,iterator:R,all:async()=>{const T=[];for await(const k of R())T.unshift(k);return T}}};jk.type=Wk;const a4={},a8=r=>{if(!r.type)throw new Error("Database type does not contain required field 'type'.");a4[r.type]=r},Sre=r=>{if(!r)throw new Error("Type not specified");if(!a4[r])throw new Error(`Unsupported database type: '${r}'`);return a4[r]};a8(zk);a8(qk);a8(jk);const _re=async(r,e,t)=>{if(!r)throw new Error("No signature given");if(!e)throw new Error("Given publicKey was undefined");if(!t)throw new Error("Given input data was undefined");t instanceof Uint8Array||(t=typeof t=="string"?ne(t):new Uint8Array(t));const n=(i,o,a)=>i.verify(o,a);let s=!1;try{const i=XO(ne(e,"base16"));s=await n(i,t,ne(r,"base16"))}catch{}return Promise.resolve(s)},c4=async(r,e)=>{if(!r)throw new Error("No signing key given");if(!e)throw new Error("Given input data was undefined");return e instanceof Uint8Array||(e=typeof e=="string"?ne(e):new Uint8Array(e)),re(await r.sign(e),"base16")},xre=Ls({size:1e3}),Gk=async(r,e,t)=>{const n=await xre,s=await n.get(r);let i=!1;if(s){const o=(a,c)=>c instanceof Uint8Array?nj(a,c)===0:a.toString()===c.toString();i=s.publicKey===e&&o(s.data,t)}else{const o=await _re(r,e,t);i=o,o&&await n.put(r,{publicKey:e,data:t})}return i},Are="./keystore",Yk=async({storage:r,path:e}={})=>{r=r||await ka(await Ls({size:1e3}),await o4({path:e||Are}));const t=await Ls({size:1e3}),n=async()=>{await r.close(),await t.close()},s=async()=>{await r.clear(),await t.clear()},i=async u=>{if(!u)throw new Error("id needed to check a key");let h=!1,d=await t.get(u);if(d)h=!0;else try{d=await r.get("private_"+u),h=d!=null}catch{console.error("Error: ENOENT: no such file or directory")}return h},o=async(u,h)=>{const{privateKey:d}=h;await r.put("private_"+u,d);const g=Vm(d);await t.put(u,g)};return{clear:s,close:n,hasKey:i,addKey:o,createKey:async u=>{if(!u)throw new Error("id needed to create a key");const h=await h0("secp256k1"),d={publicKey:h.publicKey.raw,privateKey:h.raw};return await o(u,d),h},getKey:async u=>{if(!u)throw new Error("id needed to get a key");let h=await t.get(u);if(!h){let d;try{d=await r.get("private_"+u)}catch{}if(!d)return;h=Vm(d),await t.put(u,h)}return h},getPublic:(u,h={})=>{const d=["hex","buffer"],g=h.format||"hex";if(d.indexOf(g)===-1)throw new Error("Supported formats are `hex` and `buffer`");const m=u.publicKey.raw;return g==="buffer"?m:re(m,"base16")}}},Qk=fd,Xk=M2,Ire=Cr,Zk=async({id:r,publicKey:e,signatures:t,type:n,sign:s,verify:i}={})=>{if(!r)throw new Error("Identity id is required");if(!e)throw new Error("Invalid public key");if(!t)throw new Error("Signatures object is required");if(!t.id)throw new Error("Signature of id is required");if(!t.publicKey)throw new Error("Signature of publicKey+id is required");if(!n)throw new Error("Identity type is required");t=Object.assign({},t);const o={id:r,publicKey:e,signatures:t,type:n,sign:s,verify:i},{hash:a,bytes:c}=await Tre(o);return o.hash=a,o.bytes=c,o},Tre=async r=>{const{id:e,publicKey:t,signatures:n,type:s}=r,i={id:e,publicKey:t,signatures:n,type:s},{cid:o,bytes:a}=await pu({value:i,codec:Qk,hasher:Xk});return{hash:o.toString(Ire),bytes:Uint8Array.from(a)}},kre=async r=>{const{value:e}=await O2({bytes:r,codec:Qk,hasher:Xk});return Zk({...e})},Cre=r=>!!(r.id&&r.hash&&r.bytes&&r.publicKey&&r.signatures&&r.signatures.id&&r.signatures.publicKey&&r.type),Pre=(r,e)=>r.id===e.id&&r.hash===e.hash&&r.type===e.type&&r.publicKey===e.publicKey&&r.signatures.id===e.signatures.id&&r.signatures.publicKey===e.signatures.publicKey,Jk="publickey",Dre=async r=>{const{id:e,publicKey:t,signatures:n}=r;return Gk(n.publicKey,e,t+n.id)},c8=({keystore:r})=>async()=>{if(!r)throw new Error("PublicKeyIdentityProvider requires a keystore parameter");return{type:Jk,getId:async({id:n}={})=>{if(!n)throw new Error("id is required");const s=await r.getKey(n)||await r.createKey(n);return re(s.publicKey.raw,"base16")},signIdentity:async(n,{id:s}={})=>{if(!s)throw new Error("id is required");const i=await r.getKey(s);if(!i)throw new Error(`Signing key for '${s}' not found`);return c4(i,n)}}};c8.verifyIdentity=Dre;c8.type=Jk;const l8={},Rre=r=>Object.keys(l8).includes(r),bm=r=>{if(!Rre(r))throw new Error(`IdentityProvider type '${r}' is not supported`);return l8[r]},Nre=r=>{if(!r.type||typeof r.type!="string")throw new Error("Given IdentityProvider doesn't have a field 'type'.");if(!r.verifyIdentity)throw new Error("Given IdentityProvider doesn't have a function 'verifyIdentity'.");l8[r.type]=r};Nre(c8);const Ore=po("./orbitdb","identities"),Mre=async({keystore:r,path:e,storage:t,ipfs:n}={})=>{r=r||await Yk({path:e||Ore}),t||(t=n?await ka(await Ls({size:1e3}),await $2({ipfs:n,pin:!0})):await G5());const s=await Ls({size:1e3}),i=async u=>{const h=await t.get(u);if(h)return kre(h)},o=async(u={})=>{u.keystore=r;const h=bm("publickey"),g=await(u.provider||h({keystore:r}))();if(!bm(g.type))throw new Error("Identity provider is unknown. Use useIdentityProvider(provider) to register the identity provider");const m=await g.getId(u),b=await r.getKey(m)||await r.createKey(m),y=r.getPublic(b),_=await c4(b,m),A=await g.signIdentity(y+_,u),I=await Zk({id:m,publicKey:y,signatures:{id:_,publicKey:A},type:g.type,sign:c,verify:l});return await t.put(I.hash,I.bytes),I},a=async u=>{if(!Cre(u))return!1;const{id:h,publicKey:d,signatures:g}=u;if(!await l(g.id,d,h))return!1;const b=await s.get(g.id);if(b)return Pre(u,b);const _=await bm(u.type).verifyIdentity(u);return _&&await s.put(g.id,u),_},c=async(u,h)=>{const d=await r.getKey(u.id);if(!d)throw new Error("Private signing key not found from KeyStore");return await c4(d,h)},l=async(u,h,d)=>await Gk(u,h,d);return{createIdentity:o,verifyIdentity:a,getIdentity:i,sign:c,verify:l,keystore:r}},Lre=r=>{if(r=r.toString(),!r.startsWith("/orbitdb")&&!r.startsWith("\\orbitdb"))return!1;r=r.replaceAll("/orbitdb/",""),r=r.replaceAll("\\orbitdb\\",""),r=r.replaceAll("/",""),r=r.replaceAll("\\","");let e;try{e=ht.parse(r,Cr)}catch{return!1}return e!==void 0},mv=r=>{if(r&&r.protocol==="orbitdb"&&r.hash)return r;const e="orbitdb",t=r.replace("/orbitdb/","").replace("\\orbitdb\\","");return{protocol:e,hash:t,address:r,toString:()=>po("/",e,t)}},yv=fd,wv=M2,Bre=Cr,$re=async({ipfs:r,storage:e}={})=>(e=e||await ka(await Ls({size:1e5}),await $2({ipfs:r,pin:!0})),{get:async i=>{const o=await e.get(i),{value:a}=await O2({bytes:o,codec:yv,hasher:wv});return a&&await e.put(i,o),a},create:async({name:i,type:o,accessController:a,meta:c})=>{if(!i)throw new Error("name is required");if(!o)throw new Error("type is required");if(!a)throw new Error("accessController is required");const l=Object.assign({name:i,type:o,accessController:a},c!==void 0?{meta:c}:{}),{cid:u,bytes:h}=await pu({value:l,codec:yv,hasher:wv}),d=u.toString(Bre);return await e.put(d,h),{hash:d,manifest:l}},close:async()=>{await e.close()}}),eC=async(r=32)=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="",n=0;for(;n<r;)t+=e.charAt(Math.floor(Math.random()*e.length)),n+=1;return t},tC=fd,rC=M2,Ure=Cr,Fre=async({storage:r,type:e,params:t})=>{const n={type:e,...t},{cid:s,bytes:i}=await pu({value:n,codec:tC,hasher:rC}),o=s.toString(Ure);return await r.put(o,i),o},t1="ipfs",H2=({write:r,storage:e}={})=>async({orbitdb:t,identities:n,address:s})=>{if(e=e||await ka(await Ls({size:1e3}),await $2({ipfs:t.ipfs,pin:!0})),r=r||[t.identity.id],s){const o=await e.get(s.replaceAll("/ipfs/","")),{value:a}=await O2({bytes:o,codec:tC,hasher:rC});r=a.write}else s=await Fre({storage:e,type:t1,params:{write:r}}),s=po("/",t1,s);return{type:t1,address:s,write:r,canAppend:async o=>{const a=await n.getIdentity(o.identity);if(!a)return!1;const{id:c}=a;return r.includes(c)||r.includes("*")?await n.verifyIdentity(a):!1}}};H2.type=t1;const nC="orbitdb",sC=({write:r}={})=>async({orbitdb:e,identities:t,address:n,name:s})=>{n=n||s||await eC(64),r=r||[e.identity.id];const i=await e.open(n,{type:"keyvalue",AccessController:H2({write:r})});n=i.address;const o=async m=>{const b=await t.getIdentity(m.identity);if(!b)return!1;const{id:y}=b;return await h("write",y)||await h("admin",y)?await t.verifyIdentity(b):!1},a=async()=>{const m=[];for await(const y of i.iterator())m[y.key]=y.value;const b=y=>{const _=y[0];m[_]=new Set([...m[_]||[],...y[1]])};return Object.entries({...m,admin:new Set([...m.admin||[],...i.access.write])}).forEach(b),m},c=async m=>(await a())[m]||new Set([]),l=async()=>{await i.close()},u=async()=>{await i.drop()},h=async(m,b)=>{const y=new Set(await c(m));return y.has(b)||y.has("*")};return{type:nC,address:n,write:r,canAppend:o,capabilities:a,get:c,grant:async(m,b)=>{const y=new Set([...await i.get(m)||[],b]);await i.put(m,Array.from(y.values()))},revoke:async(m,b)=>{const y=new Set(await i.get(m)||[]);y.delete(b),y.size>0?await i.put(m,Array.from(y.values())):await i.del(m)},close:l,drop:u,events:i.events}};sC.type=nC;const l4={},Vre=r=>{if(!l4[r])throw new Error(`AccessController type '${r}' is not supported`);return l4[r]},iC=r=>{if(!r.type)throw new Error("AccessController does not contain required field 'type'.");l4[r.type]=r};iC(H2);iC(sC);const Kre="events",qre=H2,Hre=async({ipfs:r,id:e,identity:t,identities:n,directory:s}={})=>{if(r==null)throw new Error("IPFS instance is a required argument.");e=e||await eC();const i=r.libp2p.peerId;s=s||"./orbitdb";let o;n?o=n.keystore:(o=await Yk({path:po(s,"./keystore")}),n=await Mre({ipfs:r,keystore:o})),t?t.provider&&(t=await n.createIdentity({...t})):t=await n.createIdentity({id:e});const a=await $re({ipfs:r});let c={};const l=async(d,{type:g,meta:m,sync:b,Database:y,AccessController:_,headsStorage:A,entryStorage:R,indexStorage:I,referencesCount:T}={})=>{let k,D,F;if(c[d])return c[d];if(Lre(d)){const C=mv(d);D=await a.get(C.hash);const N=D.accessController.split("/",2).pop();_=Vre(N)(),F=await _({orbitdb:{open:l,identity:t,ipfs:r},identities:n,address:D.accessController}),k=D.name,g=g||D.type,m=D.meta}else{g=g||Kre,_=_||qre(),F=await _({orbitdb:{open:l,identity:t,ipfs:r},identities:n,name:d});const C=await a.create({name:d,type:g,accessController:F.address,meta:m});if(D=C.manifest,d=mv(C.hash),k=D.name,m=D.meta,c[d])return c[d]}if(y=y||Sre(g)(),!y)throw new Error(`Unsupported database type: '${g}'`);d=d.toString();const O=await y({ipfs:r,identity:t,address:d,name:k,access:F,directory:s,meta:m,syncAutomatically:b,headsStorage:A,entryStorage:R,indexStorage:I,referencesCount:T});return O.events.on("close",u(d)),c[d]=O,O},u=d=>()=>{delete c[d]};return{id:e,open:l,stop:async()=>{for(const d of Object.values(c))await d.close();o&&await o.close(),a&&await a.close(),c={}},ipfs:r,directory:s,keystore:o,identities:n,identity:t,peerId:i}};function oC(r){return r[Symbol.asyncIterator]!=null}const z2=r=>{const e=tt(r),t=xr(e);return Yr(r,t),z2.bytes=e,t};z2.bytes=0;function u8(r,e){e=e??{};const t=e.lengthEncoder??z2;function*n(s){const i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return oC(r)?async function*(){for await(const s of r)yield*n(s)}():function*(){for(const s of r)yield*n(s)}()}u8.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??z2;return new Pe(t(r.byteLength),r)};class zre extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class Wre extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class jre extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}class bv extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}const Gre=8,Yre=1024*1024*4;var oa;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(oa||(oa={}));const h8=r=>{const e=Di(r);return h8.bytes=tt(e),e};h8.bytes=0;function u4(r,e){const t=new Pe;let n=oa.LENGTH,s=-1;const i=e?.lengthDecoder??h8,o=e?.maxLengthLength??Gre,a=e?.maxDataLength??Yre;function*c(){for(;t.byteLength>0;){if(n===oa.LENGTH)try{if(s=i(t),s<0)throw new zre("Invalid message length");if(s>a)throw new Wre("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=oa.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new jre("Message length length too long");break}throw l}if(n===oa.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=oa.LENGTH}}}return oC(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new bv("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new bv("Unexpected end of input")}()}u4.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return u4(n,{...e??{},onLength:i=>{t=i}})};const mu=1e3,d8=60*mu,vv="/floodsub/1.0.0",Ev="/meshsub/1.0.0",Qre="/meshsub/1.1.0",vm="/meshsub/1.2.0",Xre=6,Zre=4,Jre=12,ene=4,tne=2,rne=5,nne=3,sne=6,ine=.25,one=3,Sv=100,ane=mu,cne=d8,lne=16,une=d8,hne=10*mu,dne=15,fne=300,pne=mu,gne=60,mne=2,yne=10*mu,Lc=5e3,wne=10,bne=3*mu,vne=2*d8,Ene=120*1e3,Sne="ERR_TOPIC_VALIDATOR_REJECT",_ne="ERR_TOPIC_VALIDATOR_IGNORE",xne=0,Ane=128,Ine=1e3,Tne=1e3,kne=1,Cne=512,Pne=512,Dne={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var Pa;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.subscribe=s.bool();break}case 2:{a.topic=s.string();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)})(r.SubOpts||(r.SubOpts={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.seqno!=null&&(i.uint32(26),i.bytes(s.seqno)),s.topic!=null&&s.topic!==""&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={topic:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.from=s.bytes();break}case 2:{a.data=s.bytes();break}case 3:{a.seqno=s.bytes();break}case 4:{a.topic=s.string();break}case 5:{a.signature=s.bytes();break}case 6:{a.key=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.Message||(r.Message={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.ihave!=null)for(const a of s.ihave)i.uint32(10),r.ControlIHave.codec().encode(a,i);if(s.iwant!=null)for(const a of s.iwant)i.uint32(18),r.ControlIWant.codec().encode(a,i);if(s.graft!=null)for(const a of s.graft)i.uint32(26),r.ControlGraft.codec().encode(a,i);if(s.prune!=null)for(const a of s.prune)i.uint32(34),r.ControlPrune.codec().encode(a,i);if(s.idontwant!=null)for(const a of s.idontwant)i.uint32(42),r.ControlIDontWant.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.ihave!=null&&a.ihave.length===o.limits.ihave)throw new nt('Decode error - map field "ihave" had too many elements');a.ihave.push(r.ControlIHave.codec().decode(s,s.uint32(),{limits:o.limits?.ihave$}));break}case 2:{if(o.limits?.iwant!=null&&a.iwant.length===o.limits.iwant)throw new nt('Decode error - map field "iwant" had too many elements');a.iwant.push(r.ControlIWant.codec().decode(s,s.uint32(),{limits:o.limits?.iwant$}));break}case 3:{if(o.limits?.graft!=null&&a.graft.length===o.limits.graft)throw new nt('Decode error - map field "graft" had too many elements');a.graft.push(r.ControlGraft.codec().decode(s,s.uint32(),{limits:o.limits?.graft$}));break}case 4:{if(o.limits?.prune!=null&&a.prune.length===o.limits.prune)throw new nt('Decode error - map field "prune" had too many elements');a.prune.push(r.ControlPrune.codec().decode(s,s.uint32(),{limits:o.limits?.prune$}));break}case 5:{if(o.limits?.idontwant!=null&&a.idontwant.length===o.limits.idontwant)throw new nt('Decode error - map field "idontwant" had too many elements');a.idontwant.push(r.ControlIDontWant.codec().decode(s,s.uint32(),{limits:o.limits?.idontwant$}));break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.ControlMessage||(r.ControlMessage={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new nt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.ControlIHave||(r.ControlIHave={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new nt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.ControlIWant||(r.ControlIWant={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.ControlGraft||(r.ControlGraft={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.peers!=null)for(const a of s.peers)i.uint32(18),r.PeerInfo.codec().encode(a,i);s.backoff!=null&&(i.uint32(24),i.uint64Number(s.backoff)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={peers:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.peers!=null&&a.peers.length===o.limits.peers)throw new nt('Decode error - map field "peers" had too many elements');a.peers.push(r.PeerInfo.codec().decode(s,s.uint32(),{limits:o.limits?.peers$}));break}case 3:{a.backoff=s.uint64Number();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.ControlPrune||(r.ControlPrune={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.peerID!=null&&(i.uint32(10),i.bytes(s.peerID)),s.signedPeerRecord!=null&&(i.uint32(18),i.bytes(s.signedPeerRecord)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.peerID=s.bytes();break}case 2:{a.signedPeerRecord=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.PeerInfo||(r.PeerInfo={})),function(t){let n;t.codec=()=>(n==null&&(n=Ae((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new nt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>xe(s,t.codec()),t.decode=(s,i)=>_e(s,t.codec(),i)}(r.ControlIDontWant||(r.ControlIDontWant={}));let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const i of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(i,n);if(t.messages!=null)for(const i of t.messages)n.uint32(18),r.Message.codec().encode(i,n);t.control!=null&&(n.uint32(26),r.ControlMessage.codec().encode(t.control,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new nt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new nt('Decode error - map field "messages" had too many elements');i.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=r.ControlMessage.codec().decode(t,t.uint32(),{limits:s.limits?.control});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Pa||(Pa={}));class Rne{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,n){this.gossip=e,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(n==null)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&e.has(s.topic)){let o=t.get(s.topic);o==null&&(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}}var _v;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(_v||(_v={}));var Vl;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(Vl||(Vl={}));var us;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(us||(us={}));var Vr;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Vr||(Vr={}));var qr;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(qr||(qr={}));function xv(r){switch(r){case On.Ignore:return us.Ignore;case On.Reject:return us.Reject;default:throw new Error("Unreachable")}}var Av;(function(r){r.forward="forward",r.publish="publish"})(Av||(Av={}));var jr;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(jr||(jr={}));var Ps;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(Ps||(Ps={}));var hh;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(hh||(hh={}));var dh;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(dh||(dh={}));var Hc;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Hc||(Hc={}));function Nne(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:r.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:r.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){const o=this.toTopic(n);switch(s){case jr.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case jr.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case jr.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case jr.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case jr.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case jr.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(n,s,i){const o=this.toTopic(n);switch(s){case Ps.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case Ps.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case Ps.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case Ps.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(n,s,i){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){const o=this.toTopic(n.message.topic);switch(s){case On.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case On.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case On.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(const[i,o]of n){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onIdontwantRcv(n,s){this.idontwantRcvMsgids.inc(n),this.idontwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){const i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o,a){const c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},i*o),this.msgPublishPeersByTopic.inc({topic:c},i),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){const s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){const s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(n,s){const i=this.toTopic(n);switch(s){case qr.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case qr.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case qr.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(n,s){const i=this.toTopic(n),o=s.reason===us.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(n,s,i){const o=this.toTopic(n);this.duplicateMsgDeliveryDelay.observe({topic:o},s/1e3),i&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(n){const s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){const i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0,l=n.control.idontwant?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),l>0&&this.rpcSentIDontWant.inc(l),(i>0||o>0||a>0||c>0||l>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(const l of n)l>=s.graylistThreshold&&i++,l>=s.publishThreshold&&o++,l>=s.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:Hc.graylist},i),this.peersByScoreThreshold.set({threshold:Hc.publish},o),this.peersByScoreThreshold.set({threshold:Hc.gossip},a),this.peersByScoreThreshold.set({threshold:Hc.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){const i=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let l=i.get(c);l==null&&(l=new Set,i.set(c,l)),o.forEach(u=>l?.add(u))});for(const[o,a]of i){const c=[];a.forEach(l=>{c.push(s.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}class ut extends Error{static name="InvalidPeerScoreParamsError";constructor(e="Invalid peer score params"){super(e),this.name="InvalidPeerScoreParamsError"}}const One={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},Mne={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function Lne(r={}){return{...One,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=Bne(n),e),{}):{}}}function Bne(r={}){return{...Mne,...r}}function $ne(r){for(const[e,t]of Object.entries(r.topics))try{Une(t)}catch(n){throw new ut(`invalid score parameters for topic ${e}: ${n.message}`)}if(r.topicScoreCap<0)throw new ut("invalid topic score cap; must be positive (or 0 for no cap)");if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new ut("missing application specific score function");if(r.IPColocationFactorWeight>0)throw new ut("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new ut("invalid IPColocationFactorThreshold; must be at least 1");if(r.behaviourPenaltyWeight>0)throw new ut("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new ut("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(r.decayInterval<1e3)throw new ut("invalid DecayInterval; must be at least 1s");if(r.decayToZero<=0||r.decayToZero>=1)throw new ut("invalid DecayToZero; must be between 0 and 1")}function Une(r){if(r.topicWeight<0)throw new ut("invalid topic weight; must be >= 0");if(r.timeInMeshQuantum===0)throw new ut("invalid TimeInMeshQuantum; must be non zero");if(r.timeInMeshWeight<0)throw new ut("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new ut("invalid TimeInMeshQuantum; must be positive");if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new ut("invalid TimeInMeshCap; must be positive");if(r.firstMessageDeliveriesWeight<0)throw new ut("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new ut("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new ut("invalid FirstMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight>0)throw new ut("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new ut("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new ut("invalid MeshMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new ut("invalid MeshMessageDeliveriesThreshold; must be positive");if(r.meshMessageDeliveriesWindow<0)throw new ut("invalid MeshMessageDeliveriesWindow; must be non-negative");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new ut("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(r.meshFailurePenaltyWeight>0)throw new ut("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new ut("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(r.invalidMessageDeliveriesWeight>0)throw new ut("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new ut("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const Fne={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function Vne(r={}){return{...Fne,...r}}function h4(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function Kne(r,e){return h4(r,e,()=>!0)}class qne extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}}function Hne(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let g=a.meshTime/c.timeInMeshQuantum;g>c.timeInMeshCap&&(g=c.timeInMeshCap),l+=g*c.timeInMeshWeight}let u=a.firstMessageDeliveries;if(u>c.firstMessageDeliveriesCap&&(u=c.firstMessageDeliveriesCap),l+=u*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const g=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,m=g*g;l+=m*c.meshMessageDeliveriesWeight}const h=a.meshFailurePenalty;l+=h*c.meshFailurePenaltyWeight;const d=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=d*c.invalidMessageDeliveriesWeight,s+=l*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);const i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){const l=c-t.IPColocationFactorThreshold,u=l*l;s+=u*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}function kt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}kt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};kt.prototype.get=function(e){return this.peekAt(e)};kt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};kt.prototype.peekFront=function(){return this.peek()};kt.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(kt.prototype,"length",{get:function(){return this.size()}});kt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};kt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};kt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};kt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};kt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};kt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var i=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};kt.prototype.remove=function(e,t){var n=e,s,i=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=o)return s=this.toArray(),this.clear(),s;n+t>o&&(t=o-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;i>0;)this._list[n=n-1+a&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};kt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,a,c=arguments.length,l=this._list.length,u=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>u;)this.unshift(arguments[--c]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+t));var h=o.length;for(i=0;i<h;i++)o[i]=this._list[this._head+n+t+i&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-h+l&this._capacityMask);u<c;)this.push(arguments[u++]);for(i=0;i<h;i++)this.push(o[i])}return a}else return this.remove(n,t)}};kt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};kt.prototype.isEmpty=function(){return this._head===this._tail};kt.prototype.toArray=function(){return this._copyArray(!1)};kt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var s=0;s<t;s++)this._list[s]=e[s]};kt.prototype._copyArray=function(e,t){var n=this._list,s=n.length,i=this.length;if(t=t|i,t==i&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<s;c++)o[a++]=n[c];for(c=0;c<this._tail;c++)o[a++]=n[c]}else for(c=this._head;c<this._tail;c++)o[a++]=n[c];return o};kt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};kt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};kt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};var zne=kt;const Wne=nc(zne);var Kr;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Kr||(Kr={}));class jne{records;queue;constructor(){this.records=new Map,this.queue=new Wne}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:Kr.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+Ene};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class Gne{params;metrics;peerStats=new Map;peerIPs=new qne(()=>new Set);scoreCache=new Map;deliveryRecords=new jne;_backgroundInterval;scoreCacheValidityMs;computeScore;log;constructor(e,t,n,s){this.params=e,this.metrics=t,$ne(e),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??Hne,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(t==null)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s!=null&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){const s=this.peerStats.get(e);s!=null&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n?.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n?.knownIPs.delete(t);const s=this.peerIPs.get(t);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);if(s!=null){const i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==Kr.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeenTsMs,Kr[s.status]);return}s.status=Kr.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case us.Error:this.markInvalidMessageDelivery(e,n);return;case us.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status!==Kr.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeenTsMs,Kr[i.status]);return}if(s===us.Ignore){i.status=Kr.ignored,i.peers.clear();return}i.status=Kr.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case Kr.unknown:s.peers.add(e);break;case Kr.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case Kr.invalid:this.markInvalidMessageDelivery(e,n);break;case Kr.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);if(s!=null){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s!=null){const i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o!=null&&o.inMesh){const a=this.params.topics[t];if(n!==void 0){const l=i-n,u=l>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,l,u),u)return}const c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const s=this.peerIPs.get(n);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function Yne(r,e,t,n,s){let i=0;const o=new Map;if(Object.entries(e.topics).forEach(([d,g])=>{const m=s.get(d)??"unknown",b=t.topics[d];if(b===void 0)return;let y=o.get(m);y==null&&(y={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(m,y));let _=0,A=0,R=0,I=0,T=0;if(g.inMesh){const O=Math.max(g.meshTime/b.timeInMeshQuantum,b.timeInMeshCap);_+=O*b.timeInMeshWeight}let k=g.firstMessageDeliveries;if(k>b.firstMessageDeliveriesCap&&(k=b.firstMessageDeliveriesCap),A+=k*b.firstMessageDeliveriesWeight,g.meshMessageDeliveriesActive&&g.meshMessageDeliveries<b.meshMessageDeliveriesThreshold){const O=b.meshMessageDeliveriesThreshold-g.meshMessageDeliveries,C=O*O;R+=C*b.meshMessageDeliveriesWeight}const D=g.meshFailurePenalty;I+=D*b.meshFailurePenaltyWeight;const F=g.invalidMessageDeliveries*g.invalidMessageDeliveries;T+=F*b.invalidMessageDeliveriesWeight,i+=(_+A+R+I+T)*b.topicWeight,y.p1w+=_,y.p2w+=A,y.p3w+=R,y.p3bw+=I,y.p4w+=T}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;const d=t.topicScoreCap/i;for(const g of o.values())g.p1w*=d,g.p2w*=d,g.p3w*=d,g.p3bw*=d,g.p4w*=d}let a=0,c=0,l=0;const u=t.appSpecificScore(r);a+=u*t.appSpecificWeight,e.knownIPs.forEach(d=>{if(t.IPColocationFactorWhitelist.has(d))return;const g=n.get(d),m=g!=null?g.size:0;if(m>t.IPColocationFactorThreshold){const b=m-t.IPColocationFactorThreshold,y=b*b;c+=y*t.IPColocationFactorWeight}});const h=e.behaviourPenalty*e.behaviourPenalty;return l+=h*t.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function Qne(r,e,t,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a!=null){const c=Yne(o,a,t,n,s);for(const[l,u]of c.byTopic){let h=i.byTopic.get(l);h==null&&(h={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(l,h)),h.p1w.push(u.p1w),h.p2w.push(u.p2w),h.p3w.push(u.p3w),h.p3bw.push(u.p3bw),h.p4w.push(u.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}class Xne{rawStream;pushable;closeController;maxBufferSize;constructor(e,t,n){this.rawStream=e,this.pushable=Vn(),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(s=>{e.abort(s)})}),bn(this.pushable,this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(u8.single(e))}pushPrefixed(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return()}}class Zne{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(n=>{e.abort(n)})}),this.source=bn(this.rawStream,n=>u4(n,t))}async close(){this.closeController.abort()}}class Jne{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o==null&&(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size===0&&this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case us.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const aC=ne("libp2p-pubsub:");async function ese(r,e,t,n){switch(r.type){case Vl.Signing:{const s={from:r.author.toMultihash().bytes,data:n,seqno:vo(8),topic:e,signature:void 0,key:void 0},i=Rr([aC,Pa.Message.encode(s)]);s.signature=await r.privateKey.sign(i),s.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${re(s.seqno??new Uint8Array(0),"base16")}`),topic:e,signature:s.signature,key:Or(s.key)};return{raw:s,msg:o}}case Vl.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function tse(r,e){switch(r){case R4:return e.signature!=null?{valid:!1,error:Vr.SignaturePresent}:e.seqno!=null?{valid:!1,error:Vr.SeqnoPresent}:e.key!=null?{valid:!1,error:Vr.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case l1:{if(e.seqno==null)return{valid:!1,error:Vr.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Vr.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Vr.InvalidSignature};if(e.from==null)return{valid:!1,error:Vr.InvalidPeerId};let t;try{t=En(pr(e.from))}catch{return{valid:!1,error:Vr.InvalidPeerId}}let n;if(e.key!=null){if(n=Or(e.key),t.publicKey!==void 0&&!n.equals(t.publicKey))return{valid:!1,error:Vr.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Vr.InvalidPeerId};n=t.publicKey}const s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=Rr([aC,Pa.Message.encode(s)]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${re(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key!=null?Or(e.key):n}}:{valid:!1,error:Vr.InvalidSignature}}default:throw new Error("Unreachable")}}function vs(r=[],e){return{subscriptions:[],messages:r,control:e!==void 0?{graft:e.graft??[],prune:e.prune??[],ihave:e.ihave??[],iwant:e.iwant??[],idontwant:e.idontwant??[]}:void 0}}function Iv(r){return r.control===void 0&&(r.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),r}function ti(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function rse(r){return re(r,"base64")}function nse(r,e,t){switch(r){case l1:return{type:Vl.Signing,author:e,key:yn(t.publicKey),privateKey:t};case R4:return{type:Vl.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const sse=(r,e)=>{const t=ne(e.toString(16).padStart(16,"0"),"base16"),n=yn(r),s=new Uint8Array(n.byteLength+t.length);return s.set(n,0),s.set(t,n.byteLength),s};function ise(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return sse(r.from.publicKey??r.key,r.sequenceNumber)}async function ose(r){return Qr.encode(r.data)}var Gp;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(Gp||(Gp={}));function ase(r){for(const e of r.tuples())switch(e[0]){case Gp.ip4:case Gp.ip6:return xL(e[0],e[1])}return null}class Em{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var an;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(an||(an={}));class cse extends Tt{globalSignaturePolicy;multicodecs=[vm,Qre,Ev];publishConfig;dataTransform;peers=new Map;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=Vn({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;idontwantCounts=new Map;idontwants=new Map;components;directPeerInitial=null;static multicodec=vm;opts;decodeRpcLimits;metrics;status={code:an.stopped};maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();const n={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:Xre,Dlo:Zre,Dhi:Jre,Dscore:ene,Dout:tne,Dlazy:sne,heartbeatInterval:ane,fanoutTTL:cne,mcacheLength:rne,mcacheGossip:nne,seenTTL:vne,gossipsubIWantFollowupMs:bne,prunePeers:lne,pruneBackoff:une,unsubcribeBackoff:hne,graftFloodThreshold:yne,opportunisticGraftPeers:mne,opportunisticGraftTicks:gne,directConnectTicks:fne,gossipFactor:ine,idontwantMinDataSize:Cne,idontwantMaxMessages:Pne,...t,scoreParams:Lne(t.scoreParams),scoreThresholds:Vne(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??Dne,this.globalSignaturePolicy=n.globalSignaturePolicy??l1,n.fallbackToFloodsub&&this.multicodecs.push(vv),this.log=e.logger.forComponent(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new Em({validityMs:n.seenTTL}),this.publishedMessageIds=new Em({validityMs:n.seenTTL}),t.msgIdFn!=null)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case l1:this.msgIdFn=ise;break;case R4:this.msgIdFn=ose;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(t.fastMsgIdFn!=null&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new Em({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??rse,this.mcache=t.messageCache??new Rne(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform!=null&&(this.dataTransform=t.dataTransform),t.metricsRegister!=null){if(t.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),Tne),i=Nne(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});i.mcacheSize.addCollect(()=>{this.onScrapeMetrics(i)});for(const o of this.multicodecs)i.protocolsEnabled.set({protocol:o},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new Jne(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new Gne(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.runOnLimitedConnection=t.runOnLimitedConnection,this.allowedTopics=n.allowedTopics!=null?new Set(n.allowedTopics):null}[Symbol.toStringTag]="@chainsafe/libp2p-gossipsub";[Jt]=["@libp2p/pubsub"];[yo]=["@libp2p/identify"];getPeers(){return[...this.peers.values()]}isStarted(){return this.status.code===an.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=nse(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=Vn({objectMode:!0}),bn(this.outboundInflightQueue,async i=>{for await(const{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>{this.log.error("outbound inflight queue error",i)}),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.merge(i.id,{multiaddrs:i.addrs})}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},n=await Promise.all(this.multicodecs.map(async i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,Sv);this.status={code:an.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+Sv},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>this.connect(i)))}).catch(i=>{this.log(i)})},pne),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==an.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:an.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const t=this.components.registrar;await Promise.all(this.multicodecs.map(async s=>t.unhandle(s))),e.forEach(s=>{t.unregister(s)}),this.outboundInflightQueue.end();const n=[];for(const s of this.streamsOutbound.values())n.push(s.close());this.streamsOutbound.clear();for(const s of this.streamsInbound.values())n.push(s.close());this.streamsInbound.clear(),await Promise.all(n),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),!(!this.isStarted()||t.status!=="open")&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new Xne(await t.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),o=>{this.log.error("outbound pipe error",o)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const i=s.protocol;i===vv&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close().catch(o=>{this.log.error(o)})),this.log("create inbound stream %s",n);const i=new Zne(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>{this.log(o)})}addPeer(e,t,n){const s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.set(s,e),this.score.addPeer(s);const i=ase(n);i!==null?this.score.addIP(s,i):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n!=null&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close().catch(i=>{this.log.error(i)}),s?.close().catch(i=>{this.log.error(i)}),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const i of this.topics.values())i.delete(t);for(const[i,o]of this.mesh)o.delete(t)&&this.metrics?.onRemoveFromMesh(i,Ps.Dc,1);for(const i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.idontwantCounts.delete(t),this.idontwants.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===an.started}getMeshPeers(e){const t=this.mesh.get(e);return t!=null?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t!=null?Array.from(t):[]).map(n=>this.peers.get(n)??Ht(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await bn(t,async n=>{for await(const s of n)try{const i=s.subarray(),o=Pa.decode(i,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if(this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,o)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,o).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(i){this.metrics?.onRpcDataError(),this.log(i)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}const n=t.subscriptions!=null?t.subscriptions.length:0,s=t.messages!=null?t.messages.length:0;let i=0,o=0,a=0,c=0;if(t.control!=null&&(t.control.ihave!=null&&(i=t.control.ihave.length),t.control.iwant!=null&&(o=t.control.iwant.length),t.control.graft!=null&&(a=t.control.graft.length),t.control.prune!=null&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${s} ihave ${i} iwant ${o} graft ${a} prune ${c}`),t.subscriptions!=null&&t.subscriptions.length>0){const l=[];t.subscriptions.forEach(u=>{const h=u.topic,d=u.subscribe===!0;if(h!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(h))return;this.handleReceivedSubscription(e,h,d),l.push({topic:h,subscribe:d})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:l}})}for(const l of t.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(l.topic))continue;const u=this.handleReceivedMessage(e,l).catch(h=>{this.metrics?.onMsgRecvError(l.topic),this.log(h)});this.opts.awaitRpcMessageHandler&&await u}t.control!=null&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);this.metrics?.onPrevalidationResult(t.topic,n.code);const s=n.code;switch(s){case qr.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case qr.invalid:if(n.msgIdStr!=null){const i=n.msgIdStr;this.score.rejectMessage(e.toString(),i,t.topic,n.reason),this.gossipTracer.rejectMessage(i,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case qr.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString());break;default:throw new Error(`Invalid validation result: ${s}`)}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s!=null)return{code:qr.duplicate,msgIdStr:s};const i=await tse(this.globalSignaturePolicy,t);if(!i.valid)return{code:qr.invalid,reason:us.Error,error:i.error};const o=i.message;try{this.dataTransform!=null&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(h){return this.log("Invalid message, transform failed",h),{code:qr.invalid,reason:us.Error,error:Vr.TransformFailed}}const a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),l={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:qr.duplicate,msgIdStr:c};this.seenCache.put(c),(t.data?.length??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(a,t.topic,e.toString());const u=this.topicValidators.get(t.topic);if(u!=null){let h;try{h=await u(e,o)}catch(d){const g=d.code;g===_ne&&(h=On.Ignore),g===Sne?h=On.Reject:h=On.Ignore}if(h!==On.Accept)return{code:qr.invalid,reason:xv(h),msgIdStr:c}}return{code:qr.valid,messageId:l,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n})),messages:[]})}async handleControlMessage(e,t){if(t===void 0)return;const n=t.ihave?.length>0?this.handleIHave(e,t.ihave):[],s=t.iwant?.length>0?this.handleIWant(e,t.iwant):[],i=t.graft?.length>0?await this.handleGraft(e,t.graft):[];if(t.prune?.length>0&&await this.handlePrune(e,t.prune),t.idontwant?.length>0&&this.handleIdontwant(e,t.idontwant),n.length===0&&s.length===0&&i.length===0)return;const o=this.sendRpc(e,vs(s,{iwant:n,prune:i})),a=n[0]?.messageIDs;a!=null&&(o?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n!=null&&n.messagesAccepted<Ane&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=xne?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+Ine}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(t.length===0)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:dh.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>wne)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:dh.MaxIhave}),[];const i=this.iasked.get(e)??0;if(i>=Lc)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:dh.MaxIasked}),[];const o=new Map;if(t.forEach(({topicID:l,messageIDs:u})=>{if(l==null||u==null||!this.mesh.has(l))return;let h=0;u.forEach(d=>{const g=this.msgIdToStrFn(d);this.seenCache.has(g)||(o.set(g,d),h++)}),this.metrics?.onIhaveRcv(l,u.length,h)}),o.size===0)return[];let a=o.size;a+i>Lc&&(a=Lc-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return ti(c),c=c.slice(0,a),this.iasked.set(e,i+a),[{messageIDs:c}]}handleIWant(e,t){if(t.length===0)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,i=new Map;let o=0;return t.forEach(({messageIDs:a})=>{a?.forEach(c=>{const l=this.msgIdToStrFn(c),u=this.mcache.getWithIWantCount(l,e);if(u==null){o++;return}if(i.set(u.msg.topic,1+(i.get(u.msg.topic)??0)),u.count>one){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(l,u.msg)})}),this.metrics?.onIwantRcv(i,o),s.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values()))}async handleGraft(e,t){const n=[],s=this.score.score(e),i=Date.now();let o=this.opts.doPX;if(t.forEach(({topicID:c})=>{if(c==null)return;const l=this.mesh.get(c);if(l==null){o=!1;return}if(l.has(e))return;const u=this.backoff.get(c)?.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),n.push(c),o=!1;else if(typeof u=="number"&&i<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,hh.GraftBackoff),o=!1;const h=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<h&&this.score.addPenalty(e,1,hh.GraftBackoff),this.addBackoff(e,c),n.push(c)}else s<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,c),n.push(c),o=!1,this.addBackoff(e,c)):l.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)?(n.push(c),this.addBackoff(e,c)):(this.log("GRAFT: Add mesh link from %s in %s",e,c),this.score.graft(e,c),l.add(e),this.metrics?.onAddToMesh(c,jr.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:c,direction:"inbound"}})}),n.length===0)return[];const a=!1;return Promise.all(n.map(async c=>this.makePrune(e,c,o,a)))}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;const a=this.mesh.get(s);if(a==null)return;this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,Ps.Prune,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o!=null&&o.length>0&&(n<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s):await this.pxConnect(o)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:s,direction:"inbound"}})}}handleIdontwant(e,t){let n=this.idontwantCounts.get(e)??0;if(n>=this.opts.idontwantMaxMessages)return;const s=n;let i=this.idontwants.get(e);i==null&&(i=new Map,this.idontwants.set(e,i));let o=0;e:for(const{messageIDs:c}of t)for(const l of c){if(n>=this.opts.idontwantMaxMessages)break e;n++;const u=this.msgIdToStrFn(l);i.set(u,this.heartbeatTicks),this.mcache.msgs.has(u)||o++}this.idontwantCounts.set(e,n);const a=n-s;this.metrics?.onIdontwantRcv(a,o)}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s==null&&(s=new Map,this.backoff.set(t,s));const i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,hh.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%dne!==0)return;const e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s+kne*this.opts.heartbeatInterval<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(ti(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async n=>{if(n.peerID==null)return;const s=En(pr(n.peerID)),i=s.toString();if(!this.peers.has(i)){if(n.signedPeerRecord==null){t.push(i);return}try{if(!await this.components.peerStore.consumePeerRecord(n.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(i)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length!==0&&await Promise.all(t.map(async n=>this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);const t=Ht(e),n=await this.components.connectionManager.openConnection(t);for(const s of this.multicodecs)for(const i of this.components.registrar.getTopologies(s))i.onConnect?.(t,n)}subscribe(e){if(this.status.code!==an.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==an.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==an.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.backoff.get(e),s=this.fanout.get(e);if(s!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),s.forEach(i=>{!this.direct.has(i)&&this.score.score(i)>=0&&n?.has(i)!==!0&&t.add(i)}),this.metrics?.onAddToMesh(e,jr.Fanout,t.size)),t.size<this.opts.D){const i=t.size;this.getRandomGossipPeers(e,this.opts.D,a=>!t.has(a)&&!this.direct.has(a)&&this.score.score(a)>=0&&n?.has(a)!==!0).forEach(a=>{t.add(a)}),this.metrics?.onAddToMesh(e,jr.Random,t.size-i)}this.mesh.set(e,t),t.forEach(i=>{this.log("JOIN: Add mesh link to %s in %s",i,e),this.sendGraft(i,e)})}leave(e){if(this.status.code!==an.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t!=null&&(Promise.all(Array.from(t).map(async n=>{this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)})).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,i=this.topics.get(e);i!=null&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!(n?.has(a)??!1)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!(n?.has(a)??!1)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));const o=this.mesh.get(e);return o!=null&&o.size>0&&o.forEach(a=>{t!==a&&!(n?.has(a)??!1)&&s.add(a)}),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s!=null)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});const i=this.mesh.get(e);if(i!=null&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++}),i.size<this.opts.D&&this.getRandomGossipPeers(e,this.opts.D-i.size,a=>!i.has(a)&&!this.direct.has(a)&&!this.floodsubPeers.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold).forEach(a=>{t.add(a),n.mesh++});else{const o=this.fanout.get(e);if(o!=null&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{const a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n!=null&&this.score.deliverMessage(n,e,t.topic);const i=this.selectPeersToForward(t.topic,n,s);i.forEach(o=>{this.sendRpc(o,vs([t]))}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t,n){const s=Date.now(),i=this.dataTransform!=null?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:o,msg:a}=await ese(this.publishConfig,e,t,i),c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(l)){if(u)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:h,tosendCount:d}=this.selectPeersToPublish(e),g=this.opts.emitSelf&&this.subscriptions.has(e),m=n?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(h.size===0&&!m&&!g)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(l),this.mcache.put({msgId:c,msgIdStr:l},o,!0),this.publishedMessageIds.put(l);const b=n?.batchPublish??this.opts.batchPublish,y=vs([o]);if(b)this.sendRpcInBatch(h,y);else for(const A of h)this.sendRpc(A,y)||h.delete(A);const _=Date.now()-s;return this.metrics?.onPublishMsg(e,d,h.size,o.data!=null?o.data.length:0,_),g&&(h.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:l,msg:a}})),super.dispatchEvent(new CustomEvent("message",{detail:a}))),{recipients:Array.from(h.values()).map(A=>this.peers.get(A)??Ht(A))}}sendRpcInBatch(e,t){const n=Pa.encode(t),s=u8.single(n);for(const i of e){const o=this.streamsOutbound.get(i);if(o==null){this.log(`Cannot send RPC to ${i} as there is no open stream to it available`),e.delete(i);continue}try{o.pushPrefixed(s)}catch(a){e.delete(i),this.log.error(`Cannot send rpc to ${i}`,a)}this.metrics?.onRpcSent(t,n.length)}}reportMessageValidationResult(e,t,n){let s;if(n===On.Accept){if(s=this.mcache.validate(e),s!=null){const{message:o,originatingPeers:a}=s;this.score.deliverMessage(t,e,o.topic),this.forwardMessage(e,s.message,t,a)}}else if(s=this.mcache.remove(e),s!=null){const o=xv(n),{message:a,originatingPeers:c}=s;this.score.rejectMessage(t,e,a.topic,o);for(const l of c)this.score.rejectMessage(l,e,a.topic,o)}const i=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(s,n,i)}sendGraft(e,t){const s=vs([],{graft:[{topicID:t}]});this.sendRpc(e,s)}async sendPrune(e,t){const s=[await this.makePrune(e,t,this.opts.doPX,!0)],i=vs([],{prune:s});this.sendRpc(e,i)}sendIDontWants(e,t,n){const s=this.mesh.get(t);if(s==null)return;const i=new Set(s);i.delete(n);for(const a of i)this.streamsOutbound.get(a)?.protocol!==vm&&i.delete(a);const o=vs([],{idontwant:[{messageIDs:[e]}]});this.sendRpcInBatch(i,o)}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(n==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s!=null&&(this.piggybackControl(e,t,s),this.control.delete(e));const i=this.gossip.get(e);i!=null&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));const o=Pa.encode(t);try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s!=null&&this.control.set(e,s),i!=null&&this.gossip.set(e,i),!1}if(this.metrics?.onRpcSent(t,o.length),t.control?.graft!=null)for(const a of t.control?.graft)a.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:a.topicID,direction:"outbound"}});if(t.control?.prune!=null)for(const a of t.control?.prune)a.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:a.topicID,direction:"outbound"}});return!0}piggybackControl(e,t,n){const s=Iv(t);for(const i of n.graft)i.topicID!=null&&(this.mesh.get(i.topicID)?.has(e)??!1)&&s.control.graft.push(i);for(const i of n.prune)i.topicID!=null&&!(this.mesh.get(i.topicID)?.has(e)??!1)&&s.control.prune.push(i)}piggybackGossip(e,t,n){const s=Iv(t);s.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX,i=!1;for(const[o,a]of e){const c=a.map(h=>({topicID:h}));let l=[];const u=t.get(o);u!=null&&(l=await Promise.all(u.map(async h=>this.makePrune(o,h,s&&!(n.get(o)??!1),i))),t.delete(o)),this.sendRpc(o,vs([],{graft:c,prune:l}))}for(const[o,a]of t){const c=await Promise.all(a.map(async l=>this.makePrune(o,l,s&&!(n.get(o)??!1),i)));this.sendRpc(o,vs([],{prune:c}))}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(n.length===0||(ti(n),n.length>Lc&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),t.size===0))return;let s=this.opts.Dlazy;const o=this.opts.gossipFactor*t.size;let a=t;o>s&&(s=o),s>a.size?s=a.size:a=ti(Array.from(a)).slice(0,s),a.forEach(c=>{let l=n;n.length>Lc&&(l=ti(l.slice()).slice(0,Lc)),this.pushGossip(c,{topicID:e,messageIDs:l})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,vs([],{ihave:t}));for(const[e,t]of this.control.entries()){this.control.delete(e);const n=vs([],{graft:t.graft,prune:t.prune});this.sendRpc(e,n)}}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)??[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n,s){if(this.score.prune(e,t),this.streamsOutbound.get(e)?.protocol===Ev)return{topicID:t,peers:[]};const i=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,o=i/1e3;if(this.doAddBackoff(e,t,i),!n)return{topicID:t,peers:[],backoff:o};const a=this.getRandomGossipPeers(t,this.opts.prunePeers,l=>l!==e&&this.score.score(l)>=0),c=await Promise.all(Array.from(a).map(async l=>{const u=this.peers.get(l)??Ht(l);let h;try{h=await this.components.peerStore.get(u)}catch(d){if(d.name!=="NotFoundError")throw d}return{peerID:u.toMultihash().bytes,signedPeerRecord:h?.peerRecordEnvelope}}));return{topicID:t,peers:c,backoff:o}}runHeartbeat=()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(t=>{this.log("Error running heartbeat",t)}).finally(()=>{if(e?.(),this.status.code===an.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;t<this.opts.heartbeatInterval*.25&&(t+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}})};async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const a=new Map,c=m=>{let b=a.get(m);return b===void 0&&(b=this.score.score(m),a.set(m,b)),b},l=new Map,u=new Map,h=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const m of this.idontwants.values())for(const[b,y]of m)this.heartbeatTicks-y>=this.opts.mcacheLength&&m.delete(b);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const d=new Map;this.mesh.forEach((m,b)=>{const y=this.topics.get(b),_=new Set,A=new Set;if(d.set(b,A),y!=null){const T=ti(Array.from(y)),k=this.backoff.get(b);for(const D of T){const F=this.streamsOutbound.get(D);if(F!=null&&this.multicodecs.includes(F.protocol)&&!m.has(D)&&!this.direct.has(D)){const O=c(D);k?.has(D)!==!0&&O>=0&&_.add(D),O>=this.opts.scoreThresholds.gossipThreshold&&A.add(D)}}}const R=(T,k)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",T,b),this.addBackoff(T,b),m.delete(T),c(T)>=this.opts.scoreThresholds.gossipThreshold&&A.add(T),this.metrics?.onRemoveFromMesh(b,k,1);const D=u.get(T);D==null?u.set(T,[b]):D.push(b)},I=(T,k)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",T,b),this.score.graft(T,b),m.add(T),A.delete(T),this.metrics?.onAddToMesh(b,k,1);const D=l.get(T);D==null?l.set(T,[b]):D.push(b)};if(m.forEach(T=>{const k=c(T);k<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",T,k,b),R(T,Ps.BadScore),h.set(T,!0))}),m.size<t){const T=e-m.size;Kne(_,T).forEach(D=>{I(D,jr.NotEnough)})}if(m.size>n){let T=Array.from(m);T.sort((D,F)=>c(F)-c(D)),T=T.slice(0,s).concat(ti(T.slice(s)));let k=0;if(T.slice(0,e).forEach(D=>{(this.outbound.get(D)??!1)&&k++}),k<i){const D=O=>{const C=T[O];for(let N=O;N>0;N--)T[N]=T[N-1];T[0]=C};if(k>0){let O=k;for(let C=1;C<e&&O>0;C++)(this.outbound.get(T[C])??!1)&&(D(C),O--)}let F=e-k;for(let O=e;O<T.length&&F>0;O++)(this.outbound.get(T[O])??!1)&&(D(O),F--)}T.slice(e).forEach(D=>{R(D,Ps.Excess)})}if(m.size>=t){let T=0;if(m.forEach(k=>{(this.outbound.get(k)??!1)&&T++}),T<i){const k=i-T;h4(_,k,F=>this.outbound.get(F)===!0).forEach(F=>{I(F,jr.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&m.size>1){const T=Array.from(m).sort((F,O)=>c(F)-c(O)),k=Math.floor(m.size/2),D=c(T[k]);if(D<this.opts.scoreThresholds.opportunisticGraftThreshold){const F=this.opts.opportunisticGraftPeers,O=h4(_,F,C=>c(C)>D);for(const C of O)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",C,b),I(C,jr.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((m,b)=>{m+o<g&&(this.fanout.delete(b),this.fanoutLastpub.delete(b))}),this.fanout.forEach((m,b)=>{const y=this.topics.get(b);m.forEach(I=>{(!(y?.has(I)??!1)||c(I)<this.opts.scoreThresholds.publishThreshold)&&m.delete(I)});const _=this.topics.get(b),A=[],R=new Set;if(d.set(b,R),_!=null){const I=ti(Array.from(_));for(const T of I){const k=this.streamsOutbound.get(T);if(k!=null&&this.multicodecs.includes(k.protocol)&&!m.has(T)&&!this.direct.has(T)){const D=c(T);D>=this.opts.scoreThresholds.publishThreshold&&A.push(T),D>=this.opts.scoreThresholds.gossipThreshold&&R.add(T)}}}if(m.size<e){const I=e-m.size;A.slice(0,I).forEach(T=>{m.add(T),R?.delete(T)})}}),this.emitGossip(d),await this.sendGraftPrune(l,u,h),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){const s=this.topics.get(e);if(s==null)return new Set;let i=[];return s.forEach(o=>{const a=this.streamsOutbound.get(o);a!=null&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=ti(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;const n=Date.now();e.connectedPeersBackoffSec.reset();for(const c of this.backoff.values()){t+=c.size;for(const[l,u]of c.entries())this.peers.has(l)&&e.connectedPeersBackoffSec.observe(Math.max(0,u-n)/1e3)}e.cacheSize.set({cache:"backoff"},t);let s=0;for(const c of this.idontwants.values())s+=c.size;e.cacheSize.set({cache:"idontwants"},s);for(const[c,l]of this.topics)e.topicPeersCount.set({topicStr:c},l.size);for(const[c,l]of this.mesh)e.meshPeerCounts.set({topicStr:c},l.size);const i=[],o=new Map;e.behaviourPenalty.reset();for(const c of this.peers.keys()){const l=this.score.score(c);i.push(l),o.set(c,l),e.behaviourPenalty.observe(this.score.peerStats.get(c)?.behaviourPenalty??0)}e.registerScores(i,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,o);const a=Qne(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(a)}tagMeshPeer=e=>{const{peerId:t,topic:n}=e.detail;this.components.peerStore.merge(this.peers.get(t)??Ht(t),{tags:{[n]:{value:100}}}).catch(s=>{this.log.error("Error tagging peer %s with topic %s",t,n,s)})};untagMeshPeer=e=>{const{peerId:t,topic:n}=e.detail;this.components.peerStore.merge(this.peers.get(t)??Ht(t),{tags:{[n]:void 0}}).catch(s=>{this.log.error("Error untagging peer %s with topic %s",t,n,s)})}}function lse(r={}){return e=>new cse(e,r)}var Yp;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Be(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new nt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>_e(t,r.codec(),n)})(Yp||(Yp={}));const use="_peer-discovery._p2p._pubsub";class hse extends Tt{[mh]=!0;[Symbol.toStringTag]="@libp2p/pubsub-peer-discovery";interval;listenOnly;topics;intervalId;components;log;constructor(e,t={}){super();const{interval:n,topics:s,listenOnly:i}=t;this.components=e,this.interval=n??1e4,this.listenOnly=i??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(s)&&s.length>0?this.topics=s:this.topics=[use],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.subscribe(t),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.unsubscribe(t),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const t={publicKey:yn(e.publicKey),addrs:this.components.addressManager.getAddresses().map(i=>i.bytes)},n=Yp.encode(t),s=this.components.pubsub;if(s==null)throw new Error("PubSub not configured");for(const i of this.topics){if(s.getSubscribers(i).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",i);continue}this.log("broadcasting our peer data on topic %s",i),s.publish(i,n)}}_onMessage(e){if(!this.isStarted())return;const t=e.detail;if(this.topics.includes(t.topic))try{const n=Yp.decode(t.data),s=Or(n.publicKey),i=Na(s);if(i.equals(this.components.peerId))return;this.log("discovered peer %p on %s",i,t.topic),this.safeDispatchEvent("peer",{detail:{id:i,multiaddrs:n.addrs.map(o=>Ie(o))}})}catch(n){this.log.error("error handling incoming message",n)}}}function dse(r={}){return e=>new hse(e,r)}const cC=typeof window<"u";let Rn=null,Tv=null,d4=null,ma=null;const fse="12D3KooWAJjbRkp8FPF5MKgMU53aUTxWkqvDrs4zc1VMbwRwfsbE",pse=`/ip4/127.0.0.1/tcp/4001/ws/p2p/${fse}`;async function lC(){if(!cC||Rn)return Rn;const r="08011240abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890";let e=null;try{e=_S(ne(r,"hex"))}catch(t){console.warn("Invalid test peer ID, generating random key:",t)}Rn=await rx({...e&&{privateKey:e},addresses:{listen:[]},transports:[ak({filter:ok}),sk(),BI({discoverRelays:1})],connectionEncryption:[e5()],streamMuxers:[AI()],peerDiscovery:[dse({interval:1e4,listenOnly:!1})],services:{identify:VI(),ping:GI(),dcutr:$I(),autonat:TI(),pubsub:lse({allowPublishToZeroTopicPeers:!0,canRelayMessage:!0})}});try{await Rn.dial(Ie(pse)),console.log("Connected to relay server")}catch(t){console.warn("Could not connect to relay server:",t)}return Tv=await zJ({libp2p:Rn,blockstore:new aA,datastore:new d6}),d4=await Hre({ipfs:Tv,id:"todo-p2p-app",directory:"./orbitdb"}),console.log("P2P initialized with PeerId:",Rn.peerId.toString()),Rn}async function W2(){return d4||await lC(),ma||(ma=await d4.open("todos",{type:"documents",AccessController:()=>({canAppend:()=>!0})}),console.log("Todo database opened at:",ma.address)),ma}async function uC(r,e=null){const t=await W2(),n={id:Date.now().toString(),text:r,assignee:e,completed:!1,createdAt:new Date().toISOString(),createdBy:Rn.peerId.toString()},s=await t.put(n);return console.log("Todo added:",n,"Hash:",s),n}async function f4(r,e){const t=await W2(),n=await t.query(s=>s.id===r);if(n.length>0){const i={...n[0],...e,updatedAt:new Date().toISOString(),updatedBy:Rn.peerId.toString()},o=await t.put(i);return console.log("Todo updated:",i,"Hash:",o),i}throw new Error(`Todo with id ${r} not found`)}async function hC(r){const e=await W2(),t=await e.query(n=>n.id===r);if(t.length>0){const n=await e.del(t[0]._id);return console.log("Todo deleted:",r,"Hash:",n),!0}return!1}async function p4(){return(await(await W2()).query(()=>!0)).sort((t,n)=>new Date(n.createdAt)-new Date(t.createdAt))}async function g4(){return Rn?Rn.getPeers().map(r=>r.toString()):[]}function dC(){return Rn?.peerId?.toString()||null}function gse(r){return ma?(ma.events.on("update",r),()=>ma.events.off("update",r)):()=>{}}cC&&typeof window<"u"&&(window.app={addTodo:uC,updateTodo:f4,deleteTodo:hC,getAllTodos:p4,getConnectedPeers:g4,getMyPeerId:dC});var mse=Ir('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div> <p class="mt-4 text-gray-600">Initializing P2P connection...</p></div>'),yse=Ir('<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"> </div>'),wse=Ir('Assigned to: <code class="bg-gray-100 px-1 rounded"> </code>',1),bse=Ir('<span class="text-orange-600">Unassigned</span>'),vse=Ir("<option> </option>"),Ese=Ir('<select class="text-sm border border-gray-300 rounded px-2 py-1"><option>Assign to...</option><!></select>'),Sse=Ir('<div class="flex items-center justify-between p-3 border border-gray-200 rounded-md hover:bg-gray-50"><div class="flex items-center space-x-3 flex-1"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"/> <div class="flex-1"><span> </span> <div class="text-sm text-gray-500 mt-1"><!> • Created by: <code class="bg-gray-100 px-1 rounded"> </code></div></div></div> <div class="flex space-x-2"><!> <button class="text-red-500 hover:text-red-700 px-3 py-1 rounded-md transition-colors">Delete</button></div></div>'),_se=Ir('<div class="space-y-3"></div>'),xse=Ir('<p class="text-gray-500 text-center py-8">No TODOs yet. Add one above!</p>'),Ase=Ir('<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> <code class="text-sm bg-gray-100 px-2 py-1 rounded"> </code></div>'),Ise=Ir('<div class="space-y-2"></div>'),Tse=Ir('<p class="text-gray-500">No peers connected yet.</p>'),kse=Ir('<div class="bg-blue-50 p-3 rounded-md"><code class="text-sm font-mono break-all"> </code></div> <p class="text-sm text-gray-600 mt-2">Share this ID with others to assign TODOs to you.</p>',1),Cse=Ir('<p class="text-gray-500">Loading...</p>'),Pse=Ir('<div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="text-xl font-semibold mb-4">Add New TODO</h2> <div class="space-y-4"><input type="text" placeholder="What needs to be done?" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"/> <div class="flex gap-2"><input type="text" placeholder="Assign to PeerID (optional)" class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"/> <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md font-medium transition-colors">Add TODO</button></div></div></div> <div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="text-xl font-semibold mb-4"> </h2> <!></div> <div class="grid md:grid-cols-2 gap-6"><div class="bg-white rounded-lg shadow-md p-6"><h2 class="text-xl font-semibold mb-4"> </h2> <!></div> <div class="bg-white rounded-lg shadow-md p-6"><h2 class="text-xl font-semibold mb-4">My Peer ID</h2> <!></div></div>',1),Dse=Ir('<main class="container mx-auto p-6 max-w-4xl"><h1 class="text-3xl font-bold mb-6 text-center">P2P TODO List</h1> <!></main>');function Rse(r,e){KC(e,!1);let t=Xi([]),n=Xi(""),s=Xi(""),i=Xi([]),o=Xi(null),a=Xi(!0),c=Xi(null);EP(async()=>{try{await lC(),At(t,await p4()),At(i,await g4()),At(o,dC()),gse(async()=>{At(t,await p4()),At(i,await g4())}),At(a,!1)}catch(_){At(c,_.message),At(a,!1)}});async function l(){if(Le(n).trim()!=="")try{await uC(Le(n),Le(s)||null),At(n,""),At(s,"")}catch(_){At(c,_.message)}}async function u(_){const A=Le(t).find(R=>R.id===_);if(A)try{await f4(_,{completed:!A.completed})}catch(R){At(c,R.message)}}async function h(_){try{await hC(_)}catch(A){At(c,A.message)}}async function d(_,A){try{await f4(_,{assignee:A})}catch(R){At(c,R.message)}}NP();var g=Dse(),m=Gt(gt(g),2);{var b=_=>{var A=mse();er(_,A)},y=_=>{var A=vP(),R=Kd(A);{var I=k=>{var D=yse(),F=gt(D);Fo(()=>js(F,`Error: ${Le(c)??""}`)),er(k,D)},T=k=>{var D=Pse(),F=Kd(D),O=Gt(gt(F),2),C=gt(O),N=Gt(C,2),P=gt(N),M=Gt(P,2),K=Gt(F,2),H=gt(K),$=gt(H),B=Gt(H,2);{var z=Te=>{var Ke=_se();Q2(Ke,5,()=>Le(t),Y2,(Mt,Ft)=>{let Dt=()=>Le(Ft).id,rn=()=>Le(Ft).text,nn=()=>Le(Ft).completed,$o=()=>Le(Ft).assignee,yc=()=>Le(Ft).createdBy;var Ws=Sse(),$i=gt(Ws),Uo=gt($i),wc=Gt(Uo,2),gs=gt(wc),Br=gt(gs),Wn=Gt(gs,2),bc=gt(Wn);{var In=W=>{var pe=wse(),ge=Gt(Kd(pe)),X=gt(ge);Fo(Z=>js(X,`${Z??""}...`),[()=>$o().slice(0,12)]),er(W,pe)},yu=W=>{var pe=bse();er(W,pe)};Vo(bc,W=>{$o()?W(In):W(yu,!1)})}var E=Gt(bc,2),f=gt(E),p=Gt($i,2),v=gt(p);{var x=W=>{var pe=Ese(),ge=gt(pe);ge.value=ge.__value="";var X=Gt(ge);Q2(X,1,()=>Le(i),Y2,(Z,J)=>{var me=vse(),Re=gt(me),at={};Fo(_t=>{js(Re,`${_t??""}...`),at!==(at=Le(J))&&(me.value=(me.__value=Le(J))??"")},[()=>Le(J).slice(0,12)]),er(Z,me)}),wu("change",pe,Z=>d(Dt(),Z.target.value)),er(W,pe)};Vo(v,W=>{Le(i).length>0&&W(x)})}var L=Gt(v,2);Fo(W=>{DP(Uo,nn()),kP(gs,1,IP(nn()?"line-through text-gray-500":"text-gray-800")),js(Br,rn()),js(f,`${W??""}...`)},[()=>yc()?.slice(0,12)]),wu("change",Uo,()=>u(Dt())),wu("click",L,()=>h(Dt())),er(Mt,Ws)}),er(Te,Ke)},q=Te=>{var Ke=xse();er(Te,Ke)};Vo(B,Te=>{Le(t).length>0?Te(z):Te(q,!1)})}var Y=Gt(K,2),Q=gt(Y),j=gt(Q),we=gt(j),ue=Gt(j,2);{var fe=Te=>{var Ke=Ise();Q2(Ke,5,()=>Le(i),Y2,(Mt,Ft)=>{var Dt=Ase(),rn=Gt(gt(Dt),2),nn=gt(rn);Fo(()=>js(nn,Le(Ft))),er(Mt,Dt)}),er(Te,Ke)},ce=Te=>{var Ke=Tse();er(Te,Ke)};Vo(ue,Te=>{Le(i).length>0?Te(fe):Te(ce,!1)})}var ke=Gt(Q,2),Oe=Gt(gt(ke),2);{var ot=Te=>{var Ke=kse(),Mt=Kd(Ke),Ft=gt(Mt),Dt=gt(Ft);Fo(()=>js(Dt,Le(o))),er(Te,Ke)},lt=Te=>{var Ke=Cse();er(Te,Ke)};Vo(Oe,Te=>{Le(o)?Te(ot):Te(lt,!1)})}Fo(()=>{js($,`TODO Items (${Le(t).length??""})`),js(we,`Connected Peers (${Le(i).length??""})`)}),E8(C,()=>Le(n),Te=>At(n,Te)),wu("keydown",C,Te=>Te.key==="Enter"&&l()),E8(P,()=>Le(s),Te=>At(s,Te)),wu("click",M,l),er(k,D)};Vo(R,k=>{Le(c)?k(I):k(T,!1)},!0)}er(_,A)};Vo(m,_=>{Le(a)?_(b):_(y,!1)})}er(r,g),qC()}new Rse({target:document.getElementById("app")});
