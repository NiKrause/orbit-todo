(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const hP="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(hP);let rf=!1,dP=!1;function fP(){rf=!0}fP();const rg=1,ng=2,AE=4,pP=8,gP=16,yP=1,mP=2,yr=Symbol(),wP="http://www.w3.org/1999/xhtml",IE=!1;var sg=Array.isArray,bP=Array.prototype.indexOf,c6=Array.from,Sm=Object.defineProperty,Wh=Object.getOwnPropertyDescriptor,vP=Object.getOwnPropertyDescriptors,EP=Object.prototype,SP=Array.prototype,kE=Object.getPrototypeOf,o8=Object.isExtensible;const W2=()=>{};function _P(r){return r()}function _m(r){for(var e=0;e<r.length;e++)r[e]()}function xP(){var r,e,t=new Promise((n,s)=>{r=n,e=s});return{promise:t,resolve:r,reject:e}}const On=2,l6=4,ig=8,nf=16,to=32,Ou=64,TE=128,ns=256,lp=512,wr=1024,hn=2048,Rc=4096,Ts=8192,Nu=16384,u6=32768,h6=65536,a8=1<<17,AP=1<<18,d6=1<<19,f6=1<<20,xm=1<<21,p6=1<<22,ja=1<<23,Ga=Symbol("$state"),g6=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function IP(){throw new Error("https://svelte.dev/e/await_outside_boundary")}function kP(r){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function TP(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function CP(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function PP(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function DP(r){throw new Error("https://svelte.dev/e/effect_orphan")}function RP(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function OP(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function NP(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function MP(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function BP(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}let LP=!1;function CE(r){return r===this.v}function PE(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function DE(r){return!PE(r,this.v)}let Jt=null;function up(r){Jt=r}function RE(r,e=!1,t){Jt={p:Jt,c:null,e:null,s:r,x:null,l:rf&&!e?{s:null,u:null,$:[]}:null}}function OE(r){var e=Jt,t=e.e;if(t!==null){e.e=null;for(var n of t)GE(n)}return Jt=e.p,{}}function Mu(){return!rf||Jt!==null&&Jt.l===null}const $P=new WeakMap;function UP(r){var e=Je;if(e===null)return Ze.f|=ja,r;if(e.f&u6)y6(r,e);else{if(!(e.f&TE))throw!e.parent&&r instanceof Error&&NE(r),r;e.b.error(r)}}function y6(r,e){for(;e!==null;){if(e.f&TE)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r instanceof Error&&NE(r),r}function NE(r){const e=$P.get(r);e&&(Sm(r,"message",{value:e.message}),Sm(r,"stack",{value:e.stack}))}let hp=[];function FP(){var r=hp;hp=[],_m(r)}function ME(r){hp.length===0&&queueMicrotask(FP),hp.push(r)}function VP(){for(var r=Je.b;r!==null&&!r.has_pending_snippet();)r=r.parent;return r===null&&IP(),r}function m6(r){var e=On|hn,t=Ze!==null&&Ze.f&On?Ze:null;return Je===null||t!==null&&t.f&ns?e|=ns:Je.f|=d6,{ctx:Jt,deps:null,effects:null,equals:CE,f:e,fn:r,reactions:null,rv:0,v:yr,wv:0,parent:t??Je,ac:null}}function KP(r,e){let t=Je;t===null&&TP();var n=t.b,s=void 0,i=gd(yr),o=null,a=!Ze;return eD(()=>{try{var c=r()}catch(g){c=Promise.reject(g)}var l=()=>c;s=o?.then(l,l)??Promise.resolve(c),o=s;var u=ar,h=n.pending;a&&(n.update_pending_count(1),h||u.increment());const d=(g,y=void 0)=>{o=null,h||u.activate(),y?y!==g6&&(i.f|=ja,Yl(i,y)):(i.f&ja&&(i.f^=ja),Yl(i,g)),a&&(n.update_pending_count(-1),h||u.decrement()),UE()};if(s.then(d,g=>d(null,g||"unknown")),u)return()=>{queueMicrotask(()=>u.neuter())}}),new Promise(c=>{function l(u){function h(){u===s?c(i):l(s)}u.then(h,h)}l(s)})}function BE(r){const e=m6(r);return e.equals=DE,e}function LE(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)Ki(e[t])}}function qP(r){for(var e=r.parent;e!==null;){if(!(e.f&On))return e;e=e.parent}return null}function w6(r){var e,t=Je;Wo(qP(r));try{LE(r),e=nS(r)}finally{Wo(t)}return e}function $E(r){var e=w6(r);if(r.equals(e)||(r.v=e,r.wv=tS()),!Bu)if(Ql!==null)Ql.set(r,r.v);else{var t=(To||r.f&ns)&&r.deps!==null?Rc:wr;br(r,t)}}function HP(r,e,t){const n=Mu()?m6:BE;if(e.length===0){t(r.map(n));return}var s=ar,i=Je,o=zP(),a=VP();Promise.all(e.map(c=>KP(c))).then(c=>{s?.activate(),o();try{t([...r.map(n),...c])}catch(l){i.f&Nu||y6(l,i)}s?.deactivate(),UE()}).catch(c=>{a.error(c)})}function zP(){var r=Je,e=Ze,t=Jt;return function(){Wo(r),oi(e),up(t)}}function UE(){Wo(null),oi(null),up(null)}const Yf=new Set;let ar=null,Ql=null,c8=new Set,dp=[];function FE(){const r=dp.shift();dp.length>0&&queueMicrotask(FE),r()}let Bh=[],b6=null,Am=!1;class pd{#e=new Map;#t=new Map;#r=new Set;#o=0;#a=null;#u=!1;#s=[];#h=[];#n=[];#c=[];#i=[];skipped_effects=new Set;#d(e){Bh=[];var t=null;if(Yf.size>1){t=new Map,Ql=new Map;for(const[i,o]of this.#e)t.set(i,{v:i.v,wv:i.wv}),i.v=o;for(const i of Yf)if(i!==this)for(const[o,a]of i.#t)t.has(o)||(t.set(o,{v:o.v,wv:o.wv}),o.v=a)}for(const i of e)this.#l(i);if(this.#s.length===0&&this.#o===0){var n=this.#n,s=this.#c;this.#n=[],this.#c=[],this.#i=[],this.#f(),l8(n),l8(s),this.#a?.resolve()}else{for(const i of this.#n)br(i,wr);for(const i of this.#c)br(i,wr);for(const i of this.#i)br(i,wr)}if(t){for(const[i,{v:o,wv:a}]of t)i.wv<=a&&(i.v=o);Ql=null}for(const i of this.#s)jh(i);for(const i of this.#h)jh(i);this.#s=[],this.#h=[]}#l(e){e.f^=wr;for(var t=e.first;t!==null;){var n=t.f,s=(n&(to|Ou))!==0,i=s&&(n&wr)!==0,o=i||(n&Ts)!==0||this.skipped_effects.has(t);if(!o&&t.fn!==null){if(s)t.f^=wr;else if(n&l6)this.#c.push(t);else if(ag(t))if(n&p6){var a=t.b?.pending?this.#h:this.#s;a.push(t)}else t.f&nf&&this.#i.push(t),jh(t);var c=t.first;if(c!==null){t=c;continue}}var l=t.parent;for(t=t.next;t===null&&l!==null;)t=l.next,l=l.parent}}capture(e,t){this.#t.has(e)||this.#t.set(e,t),this.#e.set(e,e.v)}activate(){ar=this}deactivate(){ar=null;for(const e of c8)if(c8.delete(e),e(),ar!==null)break}neuter(){this.#u=!0}flush(){Bh.length>0?this.flush_effects():this.#f(),ar===this&&(this.#o===0&&Yf.delete(this),this.deactivate())}flush_effects(){var e=Ol;Am=!0;try{var t=0;for(f8(!0);Bh.length>0;){if(t++>1e3){var n,s;WP()}this.#d(Bh),Qa.clear()}}finally{Am=!1,f8(e),b6=null}}#f(){if(!this.#u)for(const e of this.#r)e();this.#r.clear()}increment(){this.#o+=1}decrement(){if(this.#o-=1,this.#o===0){for(const e of this.#n)br(e,hn),Lo(e);for(const e of this.#c)br(e,hn),Lo(e);for(const e of this.#i)br(e,hn),Lo(e);this.#n=[],this.#c=[],this.flush()}else this.deactivate()}add_callback(e){this.#r.add(e)}settled(){return(this.#a??=xP()).promise}static ensure(e=!0){if(ar===null){const t=ar=new pd;Yf.add(ar),e&&pd.enqueue(()=>{ar===t&&t.flush()})}return ar}static enqueue(e){dp.length===0&&queueMicrotask(FE),dp.unshift(e)}}function WP(){try{RP()}catch(r){y6(r,b6)}}function l8(r){var e=r.length;if(e!==0){for(var t=0;t<e;t++){var n=r[t];if(!(n.f&(Nu|Ts))&&ag(n)){var s=pp;if(jh(n),n.deps===null&&n.first===null&&n.nodes_start===null&&(n.teardown===null&&n.ac===null?ZE(n):n.fn=null),pp>s&&n.f&f6)break}}for(;t<e;t+=1)Lo(r[t])}}function Lo(r){for(var e=b6=r;e.parent!==null;){e=e.parent;var t=e.f;if(Am&&e===Je&&t&nf)return;if(t&(Ou|to)){if(!(t&wr))return;e.f^=wr}}Bh.push(e)}const Qa=new Map;function gd(r,e){var t={f:0,v:r,reactions:null,equals:CE,rv:0,wv:0};return t}function go(r,e){const t=gd(r);return iD(t),t}function Kr(r,e=!1,t=!0){const n=gd(r);return e||(n.equals=DE),rf&&t&&Jt!==null&&Jt.l!==null&&(Jt.l.s??=[]).push(n),n}function Le(r,e,t=!1){Ze!==null&&(!Ys||Ze.f&a8)&&Mu()&&Ze.f&(On|nf|p6|a8)&&!Mi?.includes(r)&&MP();let n=t?Lh(e):e;return Yl(r,n)}function Yl(r,e){if(!r.equals(e)){var t=r.v;Bu?Qa.set(r,e):Qa.set(r,t),r.v=e,pd.ensure().capture(r,t),r.f&On&&(r.f&hn&&w6(r),br(r,r.f&ns?Rc:wr)),r.wv=tS(),VE(r,hn),Mu()&&Je!==null&&Je.f&wr&&!(Je.f&(to|Ou))&&(Qn===null?oD([r]):Qn.push(r))}return e}function j2(r){Le(r,r.v+1)}function VE(r,e){var t=r.reactions;if(t!==null)for(var n=Mu(),s=t.length,i=0;i<s;i++){var o=t[i],a=o.f;!n&&o===Je||(a&hn||br(o,e),a&On?VE(o,Rc):a&hn||Lo(o))}}function Lh(r){if(typeof r!="object"||r===null||Ga in r)return r;const e=kE(r);if(e!==EP&&e!==SP)return r;var t=new Map,n=sg(r),s=go(0),i=Ya,o=a=>{if(Ya===i)return a();var c=Ze,l=Ya;oi(null),g8(i);var u=a();return oi(c),g8(l),u};return n&&t.set("length",go(r.length)),new Proxy(r,{defineProperty(a,c,l){(!("value"in l)||l.configurable===!1||l.enumerable===!1||l.writable===!1)&&OP();var u=t.get(c);return u===void 0?u=o(()=>{var h=go(l.value);return t.set(c,h),h}):Le(u,l.value,!0),!0},deleteProperty(a,c){var l=t.get(c);if(l===void 0){if(c in a){const u=o(()=>go(yr));t.set(c,u),j2(s)}}else Le(l,yr),j2(s);return!0},get(a,c,l){if(c===Ga)return r;var u=t.get(c),h=c in a;if(u===void 0&&(!h||Wh(a,c)?.writable)&&(u=o(()=>{var g=Lh(h?a[c]:yr),y=go(g);return y}),t.set(c,u)),u!==void 0){var d=ae(u);return d===yr?void 0:d}return Reflect.get(a,c,l)},getOwnPropertyDescriptor(a,c){var l=Reflect.getOwnPropertyDescriptor(a,c);if(l&&"value"in l){var u=t.get(c);u&&(l.value=ae(u))}else if(l===void 0){var h=t.get(c),d=h?.v;if(h!==void 0&&d!==yr)return{enumerable:!0,configurable:!0,value:d,writable:!0}}return l},has(a,c){if(c===Ga)return!0;var l=t.get(c),u=l!==void 0&&l.v!==yr||Reflect.has(a,c);if(l!==void 0||Je!==null&&(!u||Wh(a,c)?.writable)){l===void 0&&(l=o(()=>{var d=u?Lh(a[c]):yr,g=go(d);return g}),t.set(c,l));var h=ae(l);if(h===yr)return!1}return u},set(a,c,l,u){var h=t.get(c),d=c in a;if(n&&c==="length")for(var g=l;g<h.v;g+=1){var y=t.get(g+"");y!==void 0?Le(y,yr):g in a&&(y=o(()=>go(yr)),t.set(g+"",y))}if(h===void 0)(!d||Wh(a,c)?.writable)&&(h=o(()=>go(void 0)),Le(h,Lh(l)),t.set(c,h));else{d=h.v!==yr;var w=o(()=>Lh(l));Le(h,w)}var m=Reflect.getOwnPropertyDescriptor(a,c);if(m?.set&&m.set.call(u,l),!d){if(n&&typeof c=="string"){var _=t.get("length"),k=Number(c);Number.isInteger(k)&&k>=_.v&&Le(_,k+1)}j2(s)}return!0},ownKeys(a){ae(s);var c=Reflect.ownKeys(a).filter(h=>{var d=t.get(h);return d===void 0||d.v!==yr});for(var[l,u]of t)u.v!==yr&&!(l in a)&&c.push(l);return c},setPrototypeOf(){NP()}})}function u8(r){try{if(r!==null&&typeof r=="object"&&Ga in r)return r[Ga]}catch{}return r}function jP(r,e){return Object.is(u8(r),u8(e))}var h8,KE,qE,HE;function GP(){if(h8===void 0){h8=window,KE=/Firefox/.test(navigator.userAgent);var r=Element.prototype,e=Node.prototype,t=Text.prototype;qE=Wh(e,"firstChild").get,HE=Wh(e,"nextSibling").get,o8(r)&&(r.__click=void 0,r.__className=void 0,r.__attributes=null,r.__style=void 0,r.__e=void 0),o8(t)&&(t.__t=void 0)}}function sf(r=""){return document.createTextNode(r)}function fp(r){return qE.call(r)}function og(r){return HE.call(r)}function Se(r,e){return fp(r)}function ps(r,e){{var t=fp(r);return t instanceof Comment&&t.data===""?og(t):t}}function Me(r,e=1,t=!1){let n=r;for(;e--;)n=og(n);return n}function QP(r){r.textContent=""}function zE(){return!1}function WE(r){Je===null&&Ze===null&&DP(),Ze!==null&&Ze.f&ns&&Je===null&&PP(),Bu&&CP()}function YP(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function li(r,e,t,n=!0){var s=Je;s!==null&&s.f&Ts&&(r|=Ts);var i={ctx:Jt,deps:null,nodes_start:null,nodes_end:null,f:r|hn,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,transitions:null,wv:0,ac:null};if(t)try{jh(i),i.f|=u6}catch(c){throw Ki(i),c}else e!==null&&Lo(i);var o=t&&i.deps===null&&i.first===null&&i.nodes_start===null&&i.teardown===null&&(i.f&d6)===0;if(!o&&n&&(s!==null&&YP(i,s),Ze!==null&&Ze.f&On)){var a=Ze;(a.effects??=[]).push(i)}return i}function jE(r){const e=li(ig,null,!1);return br(e,wr),e.teardown=r,e}function Im(r){WE();var e=Je.f,t=!Ze&&(e&to)!==0&&(e&u6)===0;if(t){var n=Jt;(n.e??=[]).push(r)}else return GE(r)}function GE(r){return li(l6|f6,r,!1)}function XP(r){return WE(),li(ig|f6,r,!0)}function ZP(r){pd.ensure();const e=li(Ou,r,!0);return(t={})=>new Promise(n=>{t.outro?v6(e,()=>{Ki(e),n(void 0)}):(Ki(e),n(void 0))})}function JP(r){return li(l6,r,!1)}function eD(r){return li(p6|d6,r,!0)}function tD(r,e=0){return li(ig|e,r,!0)}function Ft(r,e=[],t=[]){HP(e,t,n=>{li(ig,()=>r(...n.map(ae)),!0)})}function QE(r,e=0){var t=li(nf|e,r,!0);return t}function yd(r,e=!0){return li(to,r,!0,e)}function YE(r){var e=r.teardown;if(e!==null){const t=Bu,n=Ze;p8(!0),oi(null);try{e.call(null)}finally{p8(t),oi(n)}}}function XE(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){t.ac?.abort(g6);var n=t.next;t.f&Ou?t.parent=null:Ki(t,e),t=n}}function rD(r){for(var e=r.first;e!==null;){var t=e.next;e.f&to||Ki(e),e=t}}function Ki(r,e=!0){var t=!1;(e||r.f&AP)&&r.nodes_start!==null&&r.nodes_end!==null&&(nD(r.nodes_start,r.nodes_end),t=!0),XE(r,e&&!t),gp(r,0),br(r,Nu);var n=r.transitions;if(n!==null)for(const i of n)i.stop();YE(r);var s=r.parent;s!==null&&s.first!==null&&ZE(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes_start=r.nodes_end=r.ac=null}function nD(r,e){for(;r!==null;){var t=r===e?null:og(r);r.remove(),r=t}}function ZE(r){var e=r.parent,t=r.prev,n=r.next;t!==null&&(t.next=n),n!==null&&(n.prev=t),e!==null&&(e.first===r&&(e.first=n),e.last===r&&(e.last=t))}function v6(r,e){var t=[];E6(r,t,!0),JE(t,()=>{Ki(r),e&&e()})}function JE(r,e){var t=r.length;if(t>0){var n=()=>--t||e();for(var s of r)s.out(n)}else e()}function E6(r,e,t){if(!(r.f&Ts)){if(r.f^=Ts,r.transitions!==null)for(const o of r.transitions)(o.is_global||t)&&e.push(o);for(var n=r.first;n!==null;){var s=n.next,i=(n.f&h6)!==0||(n.f&to)!==0;E6(n,e,i?t:!1),n=s}}}function S6(r){eS(r,!0)}function eS(r,e){if(r.f&Ts){r.f^=Ts,r.f&wr||(br(r,hn),Lo(r));for(var t=r.first;t!==null;){var n=t.next,s=(t.f&h6)!==0||(t.f&to)!==0;eS(t,s?e:!1),t=n}if(r.transitions!==null)for(const i of r.transitions)(i.is_global||e)&&i.in()}}let xl=null;function sD(r){var e=xl;try{if(xl=new Set,cg(r),e!==null)for(var t of xl)e.add(t);return xl}finally{xl=e}}function d8(r){for(var e of sD(r))Yl(e,e.v)}let Ol=!1;function f8(r){Ol=r}let Bu=!1;function p8(r){Bu=r}let Ze=null,Ys=!1;function oi(r){Ze=r}let Je=null;function Wo(r){Je=r}let Mi=null;function iD(r){Ze!==null&&(Mi===null?Mi=[r]:Mi.push(r))}let qr=null,_n=0,Qn=null;function oD(r){Qn=r}let pp=1,md=0,Ya=md;function g8(r){Ya=r}let To=!1;function tS(){return++pp}function ag(r){var e=r.f;if(e&hn)return!0;if(e&Rc){var t=r.deps,n=(e&ns)!==0;if(t!==null){var s,i,o=(e&lp)!==0,a=n&&Je!==null&&!To,c=t.length;if((o||a)&&(Je===null||!(Je.f&Nu))){var l=r,u=l.parent;for(s=0;s<c;s++)i=t[s],(o||!i?.reactions?.includes(l))&&(i.reactions??=[]).push(l);o&&(l.f^=lp),a&&u!==null&&!(u.f&ns)&&(l.f^=ns)}for(s=0;s<c;s++)if(i=t[s],ag(i)&&$E(i),i.wv>r.wv)return!0}(!n||Je!==null&&!To)&&br(r,wr)}return!1}function rS(r,e,t=!0){var n=r.reactions;if(n!==null&&!Mi?.includes(r))for(var s=0;s<n.length;s++){var i=n[s];i.f&On?rS(i,e,!1):e===i&&(t?br(i,hn):i.f&wr&&br(i,Rc),Lo(i))}}function nS(r){var e=qr,t=_n,n=Qn,s=Ze,i=To,o=Mi,a=Jt,c=Ys,l=Ya,u=r.f;qr=null,_n=0,Qn=null,To=(u&ns)!==0&&(Ys||!Ol||Ze===null),Ze=u&(to|Ou)?null:r,Mi=null,up(r.ctx),Ys=!1,Ya=++md,r.ac!==null&&(r.ac.abort(g6),r.ac=null);try{r.f|=xm;var h=(0,r.fn)(),d=r.deps;if(qr!==null){var g;if(gp(r,_n),d!==null&&_n>0)for(d.length=_n+qr.length,g=0;g<qr.length;g++)d[_n+g]=qr[g];else r.deps=d=qr;if(!To||u&On&&r.reactions!==null)for(g=_n;g<d.length;g++)(d[g].reactions??=[]).push(r)}else d!==null&&_n<d.length&&(gp(r,_n),d.length=_n);if(Mu()&&Qn!==null&&!Ys&&d!==null&&!(r.f&(On|Rc|hn)))for(g=0;g<Qn.length;g++)rS(Qn[g],r);return s!==null&&s!==r&&(md++,Qn!==null&&(n===null?n=Qn:n.push(...Qn))),r.f&ja&&(r.f^=ja),h}catch(y){return UP(y)}finally{r.f^=xm,qr=e,_n=t,Qn=n,Ze=s,To=i,Mi=o,up(a),Ys=c,Ya=l}}function aD(r,e){let t=e.reactions;if(t!==null){var n=bP.call(t,r);if(n!==-1){var s=t.length-1;s===0?t=e.reactions=null:(t[n]=t[s],t.pop())}}t===null&&e.f&On&&(qr===null||!qr.includes(e))&&(br(e,Rc),e.f&(ns|lp)||(e.f^=lp),LE(e),gp(e,0))}function gp(r,e){var t=r.deps;if(t!==null)for(var n=e;n<t.length;n++)aD(r,t[n])}function jh(r){var e=r.f;if(!(e&Nu)){br(r,wr);var t=Je,n=Ol;Je=r,Ol=!0;try{e&nf?rD(r):XE(r),YE(r);var s=nS(r);r.teardown=typeof s=="function"?s:null,r.wv=pp;var i;IE&&dP&&r.f&hn&&r.deps}finally{Ol=n,Je=t}}}function ae(r){var e=r.f,t=(e&On)!==0;if(xl?.add(r),Ze!==null&&!Ys){var n=Je!==null&&(Je.f&Nu)!==0;if(!n&&!Mi?.includes(r)){var s=Ze.deps;if(Ze.f&xm)r.rv<md&&(r.rv=md,qr===null&&s!==null&&s[_n]===r?_n++:qr===null?qr=[r]:(!To||!qr.includes(r))&&qr.push(r));else{(Ze.deps??=[]).push(r);var i=r.reactions;i===null?r.reactions=[Ze]:i.includes(Ze)||i.push(Ze)}}}else if(t&&r.deps===null&&r.effects===null){var o=r,a=o.parent;a!==null&&!(a.f&ns)&&(o.f^=ns)}if(Bu){if(Qa.has(r))return Qa.get(r);if(t){o=r;var c=o.v;return(!(o.f&wr)&&o.reactions!==null||sS(o))&&(c=w6(o)),Qa.set(o,c),c}}else if(t){if(o=r,Ql?.has(o))return Ql.get(o);ag(o)&&$E(o)}if(r.f&ja)throw r.v;return r.v}function sS(r){if(r.v===yr)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(Qa.has(e)||e.f&On&&sS(e))return!0;return!1}function cg(r){var e=Ys;try{return Ys=!0,r()}finally{Ys=e}}const cD=-7169;function br(r,e){r.f=r.f&cD|e}function lD(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(Ga in r)km(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&Ga in t&&km(t)}}}function km(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let n in r)try{km(r[n],e)}catch{}const t=kE(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const n=vP(t);for(let s in n){const i=n[s].get;if(i)try{i.call(r)}catch{}}}}}let y8=!1;function uD(){y8||(y8=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function iS(r){var e=Ze,t=Je;oi(null),Wo(null);try{return r()}finally{oi(e),Wo(t)}}function oS(r,e,t,n=t){r.addEventListener(e,()=>iS(t));const s=r.__on_r;s?r.__on_r=()=>{s(),n(!0)}:r.__on_r=()=>n(!0),uD()}const hD=new Set,m8=new Set;function dD(r,e,t,n={}){function s(i){if(n.capture||$h.call(e,i),!i.cancelBubble)return iS(()=>t?.call(this,i))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?ME(()=>{e.addEventListener(r,s,n)}):e.addEventListener(r,s,n),s}function va(r,e,t,n,s){var i={capture:n,passive:s},o=dD(r,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&jE(()=>{e.removeEventListener(r,o,i)})}function $h(r){var e=this,t=e.ownerDocument,n=r.type,s=r.composedPath?.()||[],i=s[0]||r.target,o=0,a=r.__root;if(a){var c=s.indexOf(a);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var l=s.indexOf(e);if(l===-1)return;c<=l&&(o=c)}if(i=s[o]||r.target,i!==e){Sm(r,"currentTarget",{configurable:!0,get(){return i||t}});var u=Ze,h=Je;oi(null),Wo(null);try{for(var d,g=[];i!==null;){var y=i.assignedSlot||i.parentNode||i.host||null;try{var w=i["__"+n];if(w!=null&&(!i.disabled||r.target===i))if(sg(w)){var[m,..._]=w;m.apply(i,[r,..._])}else w.call(i,r)}catch(k){d?g.push(k):d=k}if(r.cancelBubble||y===e||y===null)break;i=y}if(d){for(let k of g)queueMicrotask(()=>{throw k});throw d}}finally{r.__root=e,delete r.currentTarget,oi(u),Wo(h)}}}function fD(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function Tm(r,e){var t=Je;t.nodes_start===null&&(t.nodes_start=r,t.nodes_end=e)}function je(r,e){var t=(e&yP)!==0,n=(e&mP)!==0,s,i=!r.startsWith("<!>");return()=>{s===void 0&&(s=fD(i?r:"<!>"+r),t||(s=fp(s)));var o=n||KE?document.importNode(s,!0):s.cloneNode(!0);if(t){var a=fp(o),c=o.lastChild;Tm(a,c)}else Tm(o,o);return o}}function rl(){var r=document.createDocumentFragment(),e=document.createComment(""),t=sf();return r.append(e,t),Tm(e,t),r}function Oe(r,e){r!==null&&r.before(e)}const pD=["touchstart","touchmove"];function gD(r){return pD.includes(r)}function Nt(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??=r.nodeValue)&&(r.__t=t,r.nodeValue=t+"")}function yD(r,e){return mD(r,e)}const nl=new Map;function mD(r,{target:e,anchor:t,props:n={},events:s,context:i,intro:o=!0}){GP();var a=new Set,c=h=>{for(var d=0;d<h.length;d++){var g=h[d];if(!a.has(g)){a.add(g);var y=gD(g);e.addEventListener(g,$h,{passive:y});var w=nl.get(g);w===void 0?(document.addEventListener(g,$h,{passive:y}),nl.set(g,1)):nl.set(g,w+1)}}};c(c6(hD)),m8.add(c);var l=void 0,u=ZP(()=>{var h=t??e.appendChild(sf());return yd(()=>{if(i){RE({});var d=Jt;d.c=i}s&&(n.$$events=s),l=r(h,n)||{},i&&OE()}),()=>{for(var d of a){e.removeEventListener(d,$h);var g=nl.get(d);--g===0?(document.removeEventListener(d,$h),nl.delete(d)):nl.set(d,g)}m8.delete(c),h!==t&&h.parentNode?.removeChild(h)}});return wD.set(l,u),l}let wD=new WeakMap;function bD(r){Jt===null&&kP(),rf&&Jt.l!==null?vD(Jt).m.push(r):Im(()=>{const e=cg(r);if(typeof e=="function")return e})}function vD(r){var e=r.l;return e.u??={a:[],b:[],m:[]}}function Mt(r,e,t=!1){var n=r,s=null,i=null,o=yr,a=t?h6:0,c=!1;const l=(g,y=!0)=>{c=!0,d(y,g)};var u=null;function h(){u!==null&&(u.lastChild.remove(),n.before(u),u=null);var g=o?s:i,y=o?i:s;g&&S6(g),y&&v6(y,()=>{o?i=null:s=null})}const d=(g,y)=>{if(o!==(o=g)){var w=zE(),m=n;if(w&&(u=document.createDocumentFragment(),u.append(m=sf())),o?s??=y&&yd(()=>y(m)):i??=y&&yd(()=>y(m)),w){var _=ar,k=o?s:i,N=o?i:s;k&&_.skipped_effects.delete(k),N&&_.skipped_effects.add(N),_.add_callback(h)}else h()}};QE(()=>{c=!1,e(l),c||d(null,null)},a)}function sl(r,e){return e}function ED(r,e,t){for(var n=r.items,s=[],i=e.length,o=0;o<i;o++)E6(e[o].e,s,!0);var a=i>0&&s.length===0&&t!==null;if(a){var c=t.parentNode;QP(c),c.append(t),n.clear(),Hs(r,e[0].prev,e[i-1].next)}JE(s,()=>{for(var l=0;l<i;l++){var u=e[l];a||(n.delete(u.k),Hs(r,u.prev,u.next)),Ki(u.e,!a)}})}function il(r,e,t,n,s,i=null){var o=r,a={flags:e,items:new Map,first:null},c=(e&AE)!==0;if(c){var l=r;o=l.appendChild(sf())}var u=null,h=!1,d=new Map,g=BE(()=>{var _=t();return sg(_)?_:_==null?[]:c6(_)}),y,w;function m(){SD(w,y,a,d,o,s,e,n,t),i!==null&&(y.length===0?u?S6(u):u=yd(()=>i(o)):u!==null&&v6(u,()=>{u=null}))}QE(()=>{w??=Je,y=ae(g);var _=y.length;if(!(h&&_===0)){h=_===0;var k,N,I,T;if(zE()){var x=new Set,D=ar;for(N=0;N<_;N+=1){I=y[N],T=n(I,N);var F=a.items.get(T)??d.get(T);F?e&(rg|ng)&&aS(F,I,N,e):(k=cS(null,a,null,null,I,T,N,s,e,t,!0),d.set(T,k)),x.add(T)}for(const[R,C]of a.items)x.has(R)||D.skipped_effects.add(C.e);D.add_callback(m)}else m();ae(g)}})}function SD(r,e,t,n,s,i,o,a,c){var l=(o&pP)!==0,u=(o&(rg|ng))!==0,h=e.length,d=t.items,g=t.first,y=g,w,m=null,_,k=[],N=[],I,T,x,D;if(l)for(D=0;D<h;D+=1)I=e[D],T=a(I,D),x=d.get(T),x!==void 0&&(x.a?.measure(),(_??=new Set).add(x));for(D=0;D<h;D+=1){if(I=e[D],T=a(I,D),x=d.get(T),x===void 0){var F=n.get(T);if(F!==void 0){n.delete(T),d.set(T,F);var R=m?m.next:y;Hs(t,m,F),Hs(t,F,R),G2(F,R,s),m=F}else{var C=y?y.e.nodes_start:s;m=cS(C,t,m,m===null?t.first:m.next,I,T,D,i,o,c)}d.set(T,m),k=[],N=[],y=m.next;continue}if(u&&aS(x,I,D,o),x.e.f&Ts&&(S6(x.e),l&&(x.a?.unfix(),(_??=new Set).delete(x))),x!==y){if(w!==void 0&&w.has(x)){if(k.length<N.length){var O=N[0],P;m=O.prev;var M=k[0],K=k[k.length-1];for(P=0;P<k.length;P+=1)G2(k[P],O,s);for(P=0;P<N.length;P+=1)w.delete(N[P]);Hs(t,M.prev,K.next),Hs(t,m,M),Hs(t,K,O),y=O,m=K,D-=1,k=[],N=[]}else w.delete(x),G2(x,y,s),Hs(t,x.prev,x.next),Hs(t,x,m===null?t.first:m.next),Hs(t,m,x),m=x;continue}for(k=[],N=[];y!==null&&y.k!==T;)y.e.f&Ts||(w??=new Set).add(y),N.push(y),y=y.next;if(y===null)continue;x=y}k.push(x),m=x,y=x.next}if(y!==null||w!==void 0){for(var H=w===void 0?[]:c6(w);y!==null;)y.e.f&Ts||H.push(y),y=y.next;var $=H.length;if($>0){var L=o&AE&&h===0?s:null;if(l){for(D=0;D<$;D+=1)H[D].a?.measure();for(D=0;D<$;D+=1)H[D].a?.fix()}ED(t,H,L)}}l&&ME(()=>{if(_!==void 0)for(x of _)x.a?.apply()}),r.first=t.first&&t.first.e,r.last=m&&m.e;for(var z of n.values())Ki(z.e);n.clear()}function aS(r,e,t,n){n&rg&&Yl(r.v,e),n&ng?Yl(r.i,t):r.i=t}function cS(r,e,t,n,s,i,o,a,c,l,u){var h=(c&rg)!==0,d=(c&gP)===0,g=h?d?Kr(s,!1,!1):gd(s):s,y=c&ng?gd(o):o,w={i:y,v:g,k:i,a:null,e:null,prev:t,next:n};try{if(r===null){var m=document.createDocumentFragment();m.append(r=sf())}return w.e=yd(()=>a(r,g,y,l),LP),w.e.prev=t&&t.e,w.e.next=n&&n.e,t===null?u||(e.first=w):(t.next=w,t.e.next=w.e),n!==null&&(n.prev=w,n.e.prev=w.e),w}finally{}}function G2(r,e,t){for(var n=r.next?r.next.e.nodes_start:t,s=e?e.e.nodes_start:t,i=r.e.nodes_start;i!==null&&i!==n;){var o=og(i);s.before(i),i=o}}function Hs(r,e,t){e===null?r.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}function lS(r){var e,t,n="";if(typeof r=="string"||typeof r=="number")n+=r;else if(typeof r=="object")if(Array.isArray(r)){var s=r.length;for(e=0;e<s;e++)r[e]&&(t=lS(r[e]))&&(n&&(n+=" "),n+=t)}else for(t in r)r[t]&&(n&&(n+=" "),n+=t);return n}function _D(){for(var r,e,t=0,n="",s=arguments.length;t<s;t++)(r=arguments[t])&&(e=lS(r))&&(n&&(n+=" "),n+=e);return n}function xD(r){return typeof r=="object"?_D(r):r??""}function AD(r,e,t){var n=r==null?"":""+r;return n===""?null:n}function w8(r,e,t,n,s,i){var o=r.__className;if(o!==t||o===void 0){var a=AD(t);a==null?r.removeAttribute("class"):r.className=a,r.__className=t}return i}function uS(r,e,t=!1){if(r.multiple){if(e==null)return;if(!sg(e))return BP();for(var n of r.options)n.selected=e.includes(Gh(n));return}for(n of r.options){var s=Gh(n);if(jP(s,e)){n.selected=!0;return}}(!t||e!==void 0)&&(r.selectedIndex=-1)}function ID(r){var e=new MutationObserver(()=>{uS(r,r.__value)});e.observe(r,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),jE(()=>{e.disconnect()})}function b8(r,e,t=e){var n=!0;oS(r,"change",s=>{var i=s?"[selected]":":checked",o;if(r.multiple)o=[].map.call(r.querySelectorAll(i),Gh);else{var a=r.querySelector(i)??r.querySelector("option:not([disabled])");o=a&&Gh(a)}t(o)}),JP(()=>{var s=e();if(uS(r,s,n),n&&s===void 0){var i=r.querySelector(":checked");i!==null&&(s=Gh(i),t(s))}r.__value=s,n=!1}),ID(r)}function Gh(r){return"__value"in r?r.__value:r.value}const kD=Symbol("is custom element"),TD=Symbol("is html");function CD(r,e){var t=PD(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function PD(r){return r.__attributes??={[kD]:r.nodeName.includes("-"),[TD]:r.namespaceURI===wP}}function DD(r,e,t=e){var n=Mu(),s=new WeakSet;oS(r,"input",i=>{var o=i?r.defaultValue:r.value;if(o=Q2(r)?Y2(o):o,t(o),ar!==null&&s.add(ar),n&&o!==(o=e())){var a=r.selectionStart,c=r.selectionEnd;r.value=o??"",c!==null&&(r.selectionStart=a,r.selectionEnd=Math.min(c,r.value.length))}}),cg(e)==null&&r.value&&(t(Q2(r)?Y2(r.value):r.value),ar!==null&&s.add(ar)),tD(()=>{var i=e();r===document.activeElement&&s.has(ar)||Q2(r)&&i===Y2(r.value)||r.type==="date"&&!i&&!r.value||i!==r.value&&(r.value=i??"")})}function Q2(r){var e=r.type;return e==="number"||e==="range"}function Y2(r){return r===""?null:+r}function RD(r=!1){const e=Jt,t=e.l.u;if(!t)return;let n=()=>lD(e.s);if(r){let s=0,i={};const o=m6(()=>{let a=!1;const c=e.s;for(const l in c)c[l]!==i[l]&&(i[l]=c[l],a=!0);return a&&s++,s});n=()=>ae(o)}t.b.length&&XP(()=>{v8(e,n),_m(t.b)}),Im(()=>{const s=cg(()=>t.m.map(_P));return()=>{for(const i of s)typeof i=="function"&&i()}}),t.a.length&&Im(()=>{v8(e,n),_m(t.a)})}function v8(r,e){if(r.l.s)for(const t of r.l.s)ae(t);e()}const ol=[];function OD(r,e=W2){let t=null;const n=new Set;function s(a){if(PE(r,a)&&(r=a,t)){const c=!ol.length;for(const l of n)l[1](),ol.push(l,r);if(c){for(let l=0;l<ol.length;l+=2)ol[l][0](ol[l+1]);ol.length=0}}}function i(a){s(a(r))}function o(a,c=W2){const l=[a,c];return n.add(l),n.size===1&&(t=e(s,i)||W2),a(r),()=>{n.delete(l),n.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:o}}const ND=Symbol.for("@libp2p/connection"),Xl=Symbol.for("@libp2p/content-routing"),wd=Symbol.for("@libp2p/peer-discovery"),_6=Symbol.for("@libp2p/peer-id");function Xa(r){return!!r?.[_6]}const Zl=Symbol.for("@libp2p/peer-routing"),lg="keep-alive",yp="StrictSign",x6="StrictNoSign";var Jn;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Jn||(Jn={}));const ug=Symbol.for("@libp2p/transport");var bd;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(bd||(bd={}));let qi=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class MD extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let BD=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},re=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class mp extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class hS extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class LD extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class dS extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class fS extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Al extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class $D extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class Cm extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}let Zt=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class pS extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let A6=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class UD extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class I6 extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class hg extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class It extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}class FD extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}let of=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class Jl extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class Qh extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class Pm extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class gS extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class VD extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class k6 extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class Lu extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class $t extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function T6(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Hi(...r){const e=[];for(const t of r)T6(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function la(...r){const e=[];for(const t of r)T6(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const lr=Symbol.for("@libp2p/service-capabilities"),jo=Symbol.for("@libp2p/service-dependencies");function KD(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function $u(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function qD(r){return new TextEncoder().encode(r)}function HD(r){return new TextDecoder().decode(r)}function zD(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var w=0,m=0,_=0,k=y.length;_!==k&&y[_]===0;)_++,w++;for(var N=(k-_)*u+1>>>0,I=new Uint8Array(N);_!==k;){for(var T=y[_],x=0,D=N-1;(T!==0||x<m)&&D!==-1;D--,x++)T+=256*I[D]>>>0,I[D]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");m=x,_++}for(var F=N-m;F!==N&&I[F]===0;)F++;for(var R=c.repeat(w);F<N;++F)R+=r.charAt(I[F]);return R}function d(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var w=0;if(y[w]!==" "){for(var m=0,_=0;y[w]===c;)m++,w++;for(var k=(y.length-w)*l+1>>>0,N=new Uint8Array(k);y[w];){var I=t[y.charCodeAt(w)];if(I===255)return;for(var T=0,x=k-1;(I!==0||T<_)&&x!==-1;x--,T++)I+=a*N[x]>>>0,N[x]=I%256>>>0,I=I/256>>>0;if(I!==0)throw new Error("Non-zero carry");_=T,w++}if(y[w]!==" "){for(var D=k-_;D!==k&&N[D]===0;)D++;for(var F=new Uint8Array(m+(k-D)),R=m;D!==k;)F[R++]=N[D++];return F}}}function g(y){var w=d(y);if(w)return w;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:d,decode:g}}var WD=zD,jD=WD;let GD=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},QD=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return yS(this,e)}},YD=class{decoders;constructor(e){this.decoders=e}or(e){return yS(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function yS(r,e){return new YD({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let XD=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new GD(e,t,n),this.decoder=new QD(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function dg({name:r,prefix:e,encode:t,decode:n}){return new XD(r,e,t,n)}function af({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=jD(t,r);return dg({prefix:e,name:r,encode:n,decode:i=>$u(s(i))})}function ZD(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,a=0,c=0;for(let l=0;l<s;++l){const u=e[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|u,o+=t,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return i}function JD(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o!==0&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i}function eR(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function kr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=eR(n);return dg({prefix:e,name:r,encode(i){return JD(i,n,t)},decode(i){return ZD(i,s,t,r)}})}const Xt=af({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),tR=af({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),rR=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Xt,base58flickr:tR},Symbol.toStringTag,{value:"Module"})),Tn=kr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),mS=kr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),nR=kr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),sR=kr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),iR=kr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),oR=kr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),aR=kr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),cR=kr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),lR=kr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),uR=Object.freeze(Object.defineProperty({__proto__:null,base32:Tn,base32hex:iR,base32hexpad:aR,base32hexpadupper:cR,base32hexupper:oR,base32pad:nR,base32padupper:sR,base32upper:mS,base32z:lR},Symbol.toStringTag,{value:"Module"})),Za=af({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),hR=af({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),dR=Object.freeze(Object.defineProperty({__proto__:null,base36:Za,base36upper:hR},Symbol.toStringTag,{value:"Module"}));var fR=wS,E8=128,pR=-128,gR=Math.pow(2,31);function wS(r,e,t){e=e||[],t=t||0;for(var n=t;r>=gR;)e[t++]=r&255|E8,r/=128;for(;r&pR;)e[t++]=r&255|E8,r>>>=7;return e[t]=r|0,wS.bytes=t-n+1,e}var yR=Dm,mR=128,S8=127;function Dm(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Dm.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&S8)<<s:(o&S8)*Math.pow(2,s),s+=7}while(o>=mR);return Dm.bytes=i-n,t}var wR=Math.pow(2,7),bR=Math.pow(2,14),vR=Math.pow(2,21),ER=Math.pow(2,28),SR=Math.pow(2,35),_R=Math.pow(2,42),xR=Math.pow(2,49),AR=Math.pow(2,56),IR=Math.pow(2,63),kR=function(r){return r<wR?1:r<bR?2:r<vR?3:r<ER?4:r<SR?5:r<_R?6:r<xR?7:r<AR?8:r<IR?9:10},TR={encode:fR,decode:yR,encodingLength:kR},wp=TR;function Rm(r,e=0){return[wp.decode(r,e),wp.decode.bytes]}function bp(r,e,t=0){return wp.encode(r,e,t),e}function vp(r){return wp.encodingLength(r)}function zi(r,e){const t=e.byteLength,n=vp(r),s=n+vp(t),i=new Uint8Array(s+t);return bp(r,i,0),bp(t,i,n),i.set(e,s),new C6(r,t,e,i)}function ur(r){const e=$u(r),[t,n]=Rm(e),[s,i]=Rm(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new C6(t,s,o,e)}function CR(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&KD(r.bytes,t.bytes)}}let C6=class{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function _8(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return DR(t,Om(r),e??Xt.encoder);default:return RR(t,Om(r),e??Tn.encoder)}}const x8=new WeakMap;function Om(r){const e=x8.get(r);if(e==null){const t=new Map;return x8.set(r,t),t}return e}let $e=class Pr{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==gh)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==OR)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Pr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=zi(e,t);return Pr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Pr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&CR(e.multihash,n.multihash)}toString(e){return _8(this,e)}toJSON(){return{"/":_8(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Pr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Pr(n,s,i,o??A8(n,s,i.bytes))}else if(t[NR]===!0){const{version:n,multihash:s,code:i}=t,o=ur(s);return Pr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==gh)throw new Error(`Version 0 CID must use dag-pb (code: ${gh}) block encoding`);return new Pr(e,t,n,n.bytes)}case 1:{const s=A8(e,t,n.bytes);return new Pr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Pr.create(0,gh,e)}static createV1(e,t){return Pr.create(1,e,t)}static decode(e){const[t,n]=Pr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Pr.inspectBytes(e),n=t.size-t.multihashSize,s=$u(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new C6(t.multihashCode,t.digestSize,i,s);return[t.version===0?Pr.createV0(o):Pr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,d]=Rm(e.subarray(t));return t+=d,h};let s=n(),i=gh;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){const[n,s]=PR(e,t),i=Pr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Om(i).set(n,e),i}};function PR(r,e){switch(r[0]){case"Q":{const t=e??Xt;return[Xt.prefix,t.decode(`${Xt.prefix}${r}`)]}case Xt.prefix:{const t=e??Xt;return[Xt.prefix,t.decode(r)]}case Tn.prefix:{const t=e??Tn;return[Tn.prefix,t.decode(r)]}case Za.prefix:{const t=e??Za;return[Za.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function DR(r,e,t){const{prefix:n}=t;if(n!==Xt.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function RR(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const gh=112,OR=18;function A8(r,e,t){const n=vp(r),s=n+vp(e),i=new Uint8Array(s+t.byteLength);return bp(r,i,0),bp(e,i,n),i.set(t,s),i}const NR=Symbol.for("@ipld/js-cid/CID"),bS=0,MR="identity",vS=$u;function BR(r){return zi(bS,vS(r))}const Go={code:bS,name:MR,encode:vS,digest:BR};function We(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function ze(r=0){return new Uint8Array(r)}function dn(r=0){return new Uint8Array(r)}function jr(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=dn(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const ES=Symbol.for("@achingbrain/uint8arraylist");function I8(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Uh(r){return!!r?.[ES]}class Ve{bufs;length;[ES]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Uh(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Uh(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=I8(this.bufs,e);return t.buf[t.index]}set(e,t){const n=I8(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Uh(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return jr(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:jr(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Ve;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(o);break}const h=e-a;n.push(o.subarray(h,h+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(u){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Uh(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let h=0;h<i;h++)o[h]=-1;for(let h=0;h<s;h++)o[n[h]]=h;const a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1;let u;for(let h=t;h<=c;h+=u){u=0;for(let d=l;d>=0;d--){const g=this.get(h+d);if(n[d]!==g){u=Math.max(1,d-a[g]);break}}if(u===0)return h}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=dn(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=ze(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=ze(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=ze(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=dn(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=ze(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=ze(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=ze(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=ze(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=ze(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Ve)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!We(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Ve;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const LR=af({prefix:"9",name:"base10",alphabet:"0123456789"}),$R=Object.freeze(Object.defineProperty({__proto__:null,base10:LR},Symbol.toStringTag,{value:"Module"})),UR=kr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),FR=kr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),VR=Object.freeze(Object.defineProperty({__proto__:null,base16:UR,base16upper:FR},Symbol.toStringTag,{value:"Module"})),KR=kr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),qR=Object.freeze(Object.defineProperty({__proto__:null,base2:KR},Symbol.toStringTag,{value:"Module"})),SS=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),HR=SS.reduce((r,e,t)=>(r[t]=e,r),[]),zR=SS.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function WR(r){return r.reduce((e,t)=>(e+=HR[t],e),"")}function jR(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=zR[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const GR=dg({prefix:"🚀",name:"base256emoji",encode:WR,decode:jR}),QR=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:GR},Symbol.toStringTag,{value:"Module"})),ss=kr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),YR=kr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),cf=kr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),XR=kr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),ZR=Object.freeze(Object.defineProperty({__proto__:null,base64:ss,base64pad:YR,base64url:cf,base64urlpad:XR},Symbol.toStringTag,{value:"Module"})),JR=kr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),eO=Object.freeze(Object.defineProperty({__proto__:null,base8:JR},Symbol.toStringTag,{value:"Module"})),tO=dg({prefix:"\0",name:"identity",encode:r=>HD(r),decode:r=>qD(r)}),rO=Object.freeze(Object.defineProperty({__proto__:null,identity:tO},Symbol.toStringTag,{value:"Module"})),nO=new TextEncoder,sO=new TextDecoder,iO="json",_S=512;function oO(r){return nO.encode(JSON.stringify(r))}function aO(r){return JSON.parse(sO.decode(r))}const cO=Object.freeze(Object.defineProperty({__proto__:null,code:_S,decode:aO,encode:oO,name:iO},Symbol.toStringTag,{value:"Module"})),lO="raw",lf=85;function uO(r){return $u(r)}function hO(r){return $u(r)}const dO=Object.freeze(Object.defineProperty({__proto__:null,code:lf,decode:hO,encode:uO,name:lO},Symbol.toStringTag,{value:"Module"}));function xS({name:r,code:e,encode:t}){return new fO(r,e,t)}let fO=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?zi(this.code,t):t.then(n=>zi(this.code,n))}else throw Error("Unknown type, must be binary type")}};function AS(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const fn=xS({name:"sha2-256",code:18,encode:AS("SHA-256")}),k8=xS({name:"sha2-512",code:19,encode:AS("SHA-512")}),Ep={...rO,...qR,...eO,...$R,...VR,...uR,...dR,...rR,...ZR,...QR};function IS(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const T8=IS("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),X2=IS("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=dn(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),kS={utf8:T8,"utf-8":T8,hex:Ep.base16,latin1:X2,ascii:X2,binary:X2,...Ep};function ie(r,e="utf8"){const t=kS[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function se(r,e="utf8"){const t=kS[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const pO=parseInt("11111",2),Nm=parseInt("10000000",2),gO=parseInt("01111111",2),C8={0:yh,1:yh,2:yO,3:bO,4:vO,5:wO,6:mO,16:yh,22:yh,48:yh};function ua(r,e={offset:0}){const t=r[e.offset]&pO;if(e.offset++,C8[t]!=null)return C8[t](r,e);throw new Error("No decoder for tag "+t)}function uf(r,e){let t=0;if((r[e.offset]&Nm)===Nm){const n=r[e.offset]&gO;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function yh(r,e){uf(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=ua(r,e);if(n===null)break;t.push(n)}return t}function yO(r,e){const t=uf(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function mO(r,e){const t=uf(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let h=0;h<c.length;h++)u+=c[h]<<h*7;a+=`.${u}`,c=[]}}return a}function wO(r,e){return e.offset++,null}function bO(r,e){const t=uf(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function vO(r,e){const t=uf(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function EO(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ve;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function fg(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=EO(r.byteLength);return new Ve(Uint8Array.from([e.byteLength|Nm]),e)}function An(r){const e=new Ve,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ve(Uint8Array.from([2]),fg(e),e)}function P6(r){const e=Uint8Array.from([0]),t=new Ve(e,r);return new Ve(Uint8Array.from([3]),fg(t),t)}function SO(r){return new Ve(Uint8Array.from([4]),fg(r),r)}function Bi(r,e=48){const t=new Ve;for(const n of r)t.append(n);return new Ve(Uint8Array.from([e]),fg(t),t)}const TS="1.2.840.10045.3.1.7",CS="1.3.132.0.34",PS="1.3.132.0.35";async function _O(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function xO(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function AO(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const IO=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),kO=Uint8Array.from([6,5,43,129,4,0,34]),TO=Uint8Array.from([6,5,43,129,4,0,35]),DS={ext:!0,kty:"EC",crv:"P-256"},RS={ext:!0,kty:"EC",crv:"P-384"},OS={ext:!0,kty:"EC",crv:"P-521"},Nl=32,Ml=48,Bl=66;function CO(r){const e=ua(r);return NS(e)}function NS(r){const e=r[1],t=se(e,"base64url"),n=r[2][1][0],s=1;let i,o;if(e.byteLength===Nl)return i=se(n.subarray(s,s+Nl),"base64url"),o=se(n.subarray(s+Nl),"base64url"),new G1({...DS,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Ml)return i=se(n.subarray(s,s+Ml),"base64url"),o=se(n.subarray(s+Ml),"base64url"),new G1({...RS,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Bl)return i=se(n.subarray(s,s+Bl),"base64url"),o=se(n.subarray(s+Bl),"base64url"),new G1({...OS,key_ops:["sign"],d:t,x:i,y:o});throw new re(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function MS(r){const e=ua(r);return BS(e)}function BS(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===Nl*2+1)return n=se(e.subarray(t,t+Nl),"base64url"),s=se(e.subarray(t+Nl),"base64url"),new j1({...DS,key_ops:["verify"],x:n,y:s});if(e.byteLength===Ml*2+1)return n=se(e.subarray(t,t+Ml),"base64url"),s=se(e.subarray(t+Ml),"base64url"),new j1({...RS,key_ops:["verify"],x:n,y:s});if(e.byteLength===Bl*2+1)return n=se(e.subarray(t,t+Bl),"base64url"),s=se(e.subarray(t+Bl),"base64url"),new j1({...OS,key_ops:["verify"],x:n,y:s});throw new re(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function PO(r){return Bi([An(Uint8Array.from([1])),SO(ie(r.d??"","base64url")),Bi([LS(r.crv)],160),Bi([P6(new Ve(Uint8Array.from([4]),ie(r.x??"","base64url"),ie(r.y??"","base64url")))],161)]).subarray()}function DO(r){return Bi([An(Uint8Array.from([1])),Bi([LS(r.crv)],160),Bi([P6(new Ve(Uint8Array.from([4]),ie(r.x??"","base64url"),ie(r.y??"","base64url")))],161)]).subarray()}function LS(r){if(r==="P-256")return IO;if(r==="P-384")return kO;if(r==="P-521")return TO;throw new re(`Invalid curve ${r}`)}async function RO(r="P-256"){const e=await _O(r);return new G1(e.privateKey)}class j1{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=DO(this.jwk)),this._raw}toMultihash(){return Go.digest(Rn(this))}toCID(){return $e.createV1(114,this.toMultihash())}toString(){return Xt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}async verify(e,t,n){return AO(this.jwk,t,e,n)}}class G1{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new j1({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=PO(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}async sign(e,t){return xO(this.jwk,e,t)}}const al=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Sp(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Ja(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function pn(r,...e){if(!Sp(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function hf(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Ja(r.outputLen),Ja(r.blockLen)}function _p(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function OO(r,e){pn(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ai(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Yh(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function $s(r,e){return r<<32-e|r>>>e}function Z2(r,e){return r<<e|r>>>32-e>>>0}const $S=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",NO=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function ec(r){if(pn(r),$S)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=NO[r[t]];return e}const wi={_0:48,_9:57,A:65,F:70,a:97,f:102};function P8(r){if(r>=wi._0&&r<=wi._9)return r-wi._0;if(r>=wi.A&&r<=wi.F)return r-(wi.A-10);if(r>=wi.a&&r<=wi.f)return r-(wi.a-10)}function xp(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if($S)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=P8(r.charCodeAt(i)),a=P8(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}const MO=async()=>{};async function BO(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);const i=Date.now()-n;i>=0&&i<e||(await MO(),n+=i)}}function US(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function vd(r){return typeof r=="string"&&(r=US(r)),pn(r),r}function D8(r){return typeof r=="string"&&(r=US(r)),pn(r),r}function Di(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];pn(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function LO(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}class FS{}function D6(r){const e=n=>r().update(vd(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function pg(r=32){if(al&&typeof al.getRandomValues=="function")return al.getRandomValues(new Uint8Array(r));if(al&&typeof al.randomBytes=="function")return Uint8Array.from(al.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function $O(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function VS(r,e,t){return r&e^~r&t}function KS(r,e,t){return r&e^r&t^e&t}class R6 extends FS{constructor(e,t,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Yh(this.buffer)}update(e){_p(this),e=vd(e),pn(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=Yh(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){_p(this),OO(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,ai(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let h=o;h<s;h++)t[h]=0;$O(n,s-8,BigInt(this.length*8),i),this.process(n,0);const a=Yh(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,u[h],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const yo=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Cr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Xf=BigInt(2**32-1),R8=BigInt(32);function UO(r,e=!1){return e?{h:Number(r&Xf),l:Number(r>>R8&Xf)}:{h:Number(r>>R8&Xf)|0,l:Number(r&Xf)|0}}function FO(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=UO(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const O8=(r,e,t)=>r>>>t,N8=(r,e,t)=>r<<32-t|e>>>t,cl=(r,e,t)=>r>>>t|e<<32-t,ll=(r,e,t)=>r<<32-t|e>>>t,Zf=(r,e,t)=>r<<64-t|e>>>t-32,Jf=(r,e,t)=>r>>>t-32|e<<64-t;function bi(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const VO=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),KO=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,qO=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),HO=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,zO=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),WO=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,jO=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),mo=new Uint32Array(64);class GO extends R6{constructor(e=32){super(64,e,8,!1),this.A=yo[0]|0,this.B=yo[1]|0,this.C=yo[2]|0,this.D=yo[3]|0,this.E=yo[4]|0,this.F=yo[5]|0,this.G=yo[6]|0,this.H=yo[7]|0}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)mo[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const d=mo[h-15],g=mo[h-2],y=$s(d,7)^$s(d,18)^d>>>3,w=$s(g,17)^$s(g,19)^g>>>10;mo[h]=w+mo[h-7]+y+mo[h-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:u}=this;for(let h=0;h<64;h++){const d=$s(a,6)^$s(a,11)^$s(a,25),g=u+d+VS(a,c,l)+jO[h]+mo[h]|0,w=($s(n,2)^$s(n,13)^$s(n,22))+KS(n,s,i)|0;u=l,l=c,c=a,a=o+g|0,o=i,i=s,s=n,n=g+w|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,s,i,o,a,c,l,u)}roundClean(){ai(mo)}destroy(){this.set(0,0,0,0,0,0,0,0),ai(this.buffer)}}const qS=FO(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),QO=qS[0],YO=qS[1],wo=new Uint32Array(80),bo=new Uint32Array(80);class XO extends R6{constructor(e=64){super(128,e,16,!1),this.Ah=Cr[0]|0,this.Al=Cr[1]|0,this.Bh=Cr[2]|0,this.Bl=Cr[3]|0,this.Ch=Cr[4]|0,this.Cl=Cr[5]|0,this.Dh=Cr[6]|0,this.Dl=Cr[7]|0,this.Eh=Cr[8]|0,this.El=Cr[9]|0,this.Fh=Cr[10]|0,this.Fl=Cr[11]|0,this.Gh=Cr[12]|0,this.Gl=Cr[13]|0,this.Hh=Cr[14]|0,this.Hl=Cr[15]|0}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:h,Fl:d,Gh:g,Gl:y,Hh:w,Hl:m}=this;return[e,t,n,s,i,o,a,c,l,u,h,d,g,y,w,m]}set(e,t,n,s,i,o,a,c,l,u,h,d,g,y,w,m){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=h|0,this.Fl=d|0,this.Gh=g|0,this.Gl=y|0,this.Hh=w|0,this.Hl=m|0}process(e,t){for(let N=0;N<16;N++,t+=4)wo[N]=e.getUint32(t),bo[N]=e.getUint32(t+=4);for(let N=16;N<80;N++){const I=wo[N-15]|0,T=bo[N-15]|0,x=cl(I,T,1)^cl(I,T,8)^O8(I,T,7),D=ll(I,T,1)^ll(I,T,8)^N8(I,T,7),F=wo[N-2]|0,R=bo[N-2]|0,C=cl(F,R,19)^Zf(F,R,61)^O8(F,R,6),O=ll(F,R,19)^Jf(F,R,61)^N8(F,R,6),P=qO(D,O,bo[N-7],bo[N-16]),M=HO(P,x,C,wo[N-7],wo[N-16]);wo[N]=M|0,bo[N]=P|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:h,El:d,Fh:g,Fl:y,Gh:w,Gl:m,Hh:_,Hl:k}=this;for(let N=0;N<80;N++){const I=cl(h,d,14)^cl(h,d,18)^Zf(h,d,41),T=ll(h,d,14)^ll(h,d,18)^Jf(h,d,41),x=h&g^~h&w,D=d&y^~d&m,F=zO(k,T,D,YO[N],bo[N]),R=WO(F,_,I,x,QO[N],wo[N]),C=F|0,O=cl(n,s,28)^Zf(n,s,34)^Zf(n,s,39),P=ll(n,s,28)^Jf(n,s,34)^Jf(n,s,39),M=n&i^n&a^i&a,K=s&o^s&c^o&c;_=w|0,k=m|0,w=g|0,m=y|0,g=h|0,y=d|0,{h,l:d}=bi(l|0,u|0,R|0,C|0),l=a|0,u=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const H=VO(C,P,K);n=KO(H,R,O,M),s=H|0}({h:n,l:s}=bi(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=bi(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=bi(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=bi(this.Dh|0,this.Dl|0,l|0,u|0),{h,l:d}=bi(this.Eh|0,this.El|0,h|0,d|0),{h:g,l:y}=bi(this.Fh|0,this.Fl|0,g|0,y|0),{h:w,l:m}=bi(this.Gh|0,this.Gl|0,w|0,m|0),{h:_,l:k}=bi(this.Hh|0,this.Hl|0,_|0,k|0),this.set(n,s,i,o,a,c,l,u,h,d,g,y,w,m,_,k)}roundClean(){ai(wo,bo)}destroy(){ai(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const HS=D6(()=>new GO),zS=D6(()=>new XO);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const O6=BigInt(0),Mm=BigInt(1);function cc(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function e1(r){const e=r.toString(16);return e.length&1?"0"+e:e}function WS(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?O6:BigInt("0x"+r)}function gg(r){return WS(ec(r))}function lc(r){return pn(r),WS(ec(Uint8Array.from(r).reverse()))}function N6(r,e){return xp(r.toString(16).padStart(e*2,"0"))}function df(r,e){return N6(r,e).reverse()}function Ct(r,e,t){let n;if(typeof e=="string")try{n=xp(e)}catch(i){throw new Error(r+" must be hex string or Uint8Array, cause: "+i)}else if(Sp(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");const s=n.length;if(typeof t=="number"&&s!==t)throw new Error(r+" of length "+t+" expected, got "+s);return n}const J2=r=>typeof r=="bigint"&&O6<=r;function ZO(r,e,t){return J2(r)&&J2(e)&&J2(t)&&e<=r&&r<t}function Co(r,e,t,n){if(!ZO(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function jS(r){let e;for(e=0;r>O6;r>>=Mm,e+=1);return e}const ff=r=>(Mm<<BigInt(r))-Mm;function JO(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const n=g=>new Uint8Array(g),s=g=>Uint8Array.of(g);let i=n(r),o=n(r),a=0;const c=()=>{i.fill(1),o.fill(0),a=0},l=(...g)=>t(o,i,...g),u=(g=n(0))=>{o=l(s(0),g),i=l(),g.length!==0&&(o=l(s(1),g),i=l())},h=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let g=0;const y=[];for(;g<e;){i=l();const w=i.slice();y.push(w),g+=i.length}return Di(...y)};return(g,y)=>{c(),u(g);let w;for(;!(w=y(h()));)u();return c(),w}}function Uu(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,i,o){const a=r[s];if(o&&a===void 0)return;const c=typeof a;if(c!==i||a===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${c}`)}Object.entries(e).forEach(([s,i])=>n(s,i,!1)),Object.entries(t).forEach(([s,i])=>n(s,i,!0))}function Ap(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const un=BigInt(0),_r=BigInt(1),$a=BigInt(2),GS=BigInt(3),QS=BigInt(4),YS=BigInt(5),eN=BigInt(7),XS=BigInt(8),tN=BigInt(9),ZS=BigInt(16);function Kt(r,e){const t=r%e;return t>=un?t:e+t}function Lt(r,e,t){let n=r;for(;e-- >un;)n*=n,n%=t;return n}function M8(r,e){if(r===un)throw new Error("invert: expected non-zero number");if(e<=un)throw new Error("invert: expected positive modulus, got "+e);let t=Kt(r,e),n=e,s=un,i=_r;for(;t!==un;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==_r)throw new Error("invert: does not exist");return Kt(s,e)}function M6(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function JS(r,e){const t=(r.ORDER+_r)/QS,n=r.pow(e,t);return M6(r,n,e),n}function rN(r,e){const t=(r.ORDER-YS)/XS,n=r.mul(e,$a),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,$a),s),a=r.mul(i,r.sub(o,r.ONE));return M6(r,a,e),a}function nN(r){const e=Oc(r),t=e_(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+eN)/ZS;return(a,c)=>{let l=a.pow(c,o),u=a.mul(l,n);const h=a.mul(l,s),d=a.mul(l,i),g=a.eql(a.sqr(u),c),y=a.eql(a.sqr(h),c);l=a.cmov(l,u,g),u=a.cmov(d,h,y);const w=a.eql(a.sqr(u),c),m=a.cmov(l,u,w);return M6(a,m,c),m}}function e_(r){if(r<GS)throw new Error("sqrt is not defined for small field");let e=r-_r,t=0;for(;e%$a===un;)e/=$a,t++;let n=$a;const s=Oc(r);for(;B8(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return JS;let i=s.pow(n,e);const o=(e+_r)/$a;return function(c,l){if(c.is0(l))return l;if(B8(c,l)!==1)throw new Error("Cannot find square root");let u=t,h=c.mul(c.ONE,i),d=c.pow(l,e),g=c.pow(l,o);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let y=1,w=c.sqr(d);for(;!c.eql(w,c.ONE);)if(y++,w=c.sqr(w),y===u)throw new Error("Cannot find square root");const m=_r<<BigInt(u-y-1),_=c.pow(h,m);u=y,h=c.sqr(_),d=c.mul(d,h),g=c.mul(g,_)}return g}}function sN(r){return r%QS===GS?JS:r%XS===YS?rN:r%ZS===tN?nN(r):e_(r)}const iN=(r,e)=>(Kt(r,e)&_r)===_r,oN=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function aN(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=oN.reduce((n,s)=>(n[s]="function",n),e);return Uu(r,t),r}function cN(r,e,t){if(t<un)throw new Error("invalid exponent, negatives unsupported");if(t===un)return r.ONE;if(t===_r)return e;let n=r.ONE,s=e;for(;t>un;)t&_r&&(n=r.mul(n,s)),s=r.sqr(s),t>>=_r;return n}function t_(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function B8(r,e){const t=(r.ORDER-_r)/$a,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function lN(r,e){e!==void 0&&Ja(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function Oc(r,e,t=!1,n={}){if(r<=un)throw new Error("invalid field: expected ORDER > 0, got "+r);let s,i,o=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");const d=e;d.BITS&&(s=d.BITS),d.sqrt&&(i=d.sqrt),typeof d.isLE=="boolean"&&(t=d.isLE),typeof d.modOnDecode=="boolean"&&(o=d.modOnDecode),a=d.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(i=n.sqrt);const{nBitLength:c,nByteLength:l}=lN(r,s);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let u;const h=Object.freeze({ORDER:r,isLE:t,BITS:c,BYTES:l,MASK:ff(c),ZERO:un,ONE:_r,allowedLengths:a,create:d=>Kt(d,r),isValid:d=>{if(typeof d!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof d);return un<=d&&d<r},is0:d=>d===un,isValidNot0:d=>!h.is0(d)&&h.isValid(d),isOdd:d=>(d&_r)===_r,neg:d=>Kt(-d,r),eql:(d,g)=>d===g,sqr:d=>Kt(d*d,r),add:(d,g)=>Kt(d+g,r),sub:(d,g)=>Kt(d-g,r),mul:(d,g)=>Kt(d*g,r),pow:(d,g)=>cN(h,d,g),div:(d,g)=>Kt(d*M8(g,r),r),sqrN:d=>d*d,addN:(d,g)=>d+g,subN:(d,g)=>d-g,mulN:(d,g)=>d*g,inv:d=>M8(d,r),sqrt:i||(d=>(u||(u=sN(r)),u(h,d))),toBytes:d=>t?df(d,l):N6(d,l),fromBytes:(d,g=!0)=>{if(a){if(!a.includes(d.length)||d.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+d.length);const w=new Uint8Array(l);w.set(d,t?0:w.length-d.length),d=w}if(d.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+d.length);let y=t?lc(d):gg(d);if(o&&(y=Kt(y,r)),!g&&!h.isValid(y))throw new Error("invalid field element: outside of range 0..ORDER");return y},invertBatch:d=>t_(h,d),cmov:(d,g,y)=>y?g:d});return Object.freeze(h)}function r_(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function n_(r){const e=r_(r);return e+Math.ceil(e/2)}function uN(r,e,t=!1){const n=r.length,s=r_(e),i=n_(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?lc(r):gg(r),a=Kt(o,e-_r)+_r;return t?df(a,s):N6(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const eu=BigInt(0),Ua=BigInt(1);function Ip(r,e){const t=e.negate();return r?t:e}function Fa(r,e){const t=t_(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function s_(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function ey(r,e){s_(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=ff(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function L8(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=Ua);const l=e*n,u=l+Math.abs(a)-1,h=a===0,d=a<0,g=e%2!==0;return{nextN:c,offset:u,isZero:h,isNeg:d,isNegF:g,offsetF:l}}function hN(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function dN(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}const ty=new WeakMap,i_=new WeakMap;function ry(r){return i_.get(r)||1}function $8(r){if(r!==eu)throw new Error("invalid wNAF")}class o_{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>eu;)t&Ua&&(n=n.add(s)),s=s.double(),t>>=Ua;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=ey(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=ey(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:u,isNeg:h,isNegF:d,offsetF:g}=L8(n,a,o);n=c,u?i=i.add(Ip(d,t[g])):s=s.add(Ip(h,t[l]))}return $8(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=ey(e,this.bits);for(let o=0;o<i.windows&&n!==eu;o++){const{nextN:a,offset:c,isZero:l,isNeg:u}=L8(n,o,i);if(n=a,!l){const h=t[c];s=s.add(u?h.negate():h)}}return $8(n),s}getPrecomputes(e,t,n){let s=ty.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),ty.set(t,s))),s}cached(e,t,n){const s=ry(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=ry(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){s_(t,this.bits),i_.set(e,t),ty.delete(e)}hasCache(e){return ry(e)!==1}}function fN(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>eu||n>eu;)t&Ua&&(i=i.add(s)),n&Ua&&(o=o.add(s)),s=s.double(),t>>=Ua,n>>=Ua;return{p1:i,p2:o}}function a_(r,e,t,n){hN(t,r),dN(n,e);const s=t.length,i=n.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const o=r.ZERO,a=jS(BigInt(s));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const l=ff(c),u=new Array(Number(l)+1).fill(o),h=Math.floor((e.BITS-1)/c)*c;let d=o;for(let g=h;g>=0;g-=c){u.fill(o);for(let w=0;w<i;w++){const m=n[w],_=Number(m>>BigInt(g)&l);u[_]=u[_].add(t[w])}let y=o;for(let w=u.length-1,m=o;w>0;w--)m=m.add(u[w]),y=y.add(m);if(d=d.add(y),g!==0)for(let w=0;w<c;w++)d=d.double()}return d}function U8(r,e){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return aN(e),e}else return Oc(r)}function c_(r,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const a of["p","n","h"]){const c=e[a];if(!(typeof c=="bigint"&&c>eu))throw new Error(`CURVE.${a} must be positive bigint`)}const n=U8(e.p,t.Fp),s=U8(e.n,t.Fn),o=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const a of o)if(!n.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return{Fp:n,Fn:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const qs=BigInt(0),er=BigInt(1),ny=BigInt(2),pN=BigInt(8);function gN(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function yN(r,e={}){const{Fp:t,Fn:n}=c_("edwards",r,e),{h:s,n:i}=r;Uu(e,{},{uvRatio:"function"});const o=ny<<BigInt(n.BYTES*8)-er,a=w=>t.create(w),c=e.uvRatio||((w,m)=>{try{return{isValid:!0,value:t.sqrt(t.div(w,m))}}catch{return{isValid:!1,value:qs}}});if(!gN(t,r,r.Gx,r.Gy))throw new Error("bad curve params: generator point");function l(w,m,_=!1){const k=_?er:qs;return Co("coordinate "+w,m,k,o),m}function u(w){if(!(w instanceof g))throw new Error("ExtendedPoint expected")}const h=Ap((w,m)=>{const{X:_,Y:k,Z:N}=w,I=w.is0();m==null&&(m=I?pN:t.inv(N));const T=a(_*m),x=a(k*m),D=t.mul(N,m);if(I)return{x:qs,y:er};if(D!==er)throw new Error("invZ was invalid");return{x:T,y:x}}),d=Ap(w=>{const{a:m,d:_}=r;if(w.is0())throw new Error("bad point: ZERO");const{X:k,Y:N,Z:I,T}=w,x=a(k*k),D=a(N*N),F=a(I*I),R=a(F*F),C=a(x*m),O=a(F*a(C+D)),P=a(R+a(_*a(x*D)));if(O!==P)throw new Error("bad point: equation left != right (1)");const M=a(k*N),K=a(I*T);if(M!==K)throw new Error("bad point: equation left != right (2)");return!0});class g{constructor(m,_,k,N){this.X=l("x",m),this.Y=l("y",_),this.Z=l("z",k,!0),this.T=l("t",N),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(m){return Fa(g,m)}static msm(m,_){return a_(g,n,m,_)}_setWindowSize(m){this.precompute(m)}static fromAffine(m){if(m instanceof g)throw new Error("extended point not allowed");const{x:_,y:k}=m||{};return l("x",_),l("y",k),new g(_,k,er,a(_*k))}precompute(m=8,_=!0){return y.createCache(this,m),_||this.multiply(ny),this}assertValidity(){d(this)}equals(m){u(m);const{X:_,Y:k,Z:N}=this,{X:I,Y:T,Z:x}=m,D=a(_*x),F=a(I*N),R=a(k*x),C=a(T*N);return D===F&&R===C}is0(){return this.equals(g.ZERO)}negate(){return new g(a(-this.X),this.Y,this.Z,a(-this.T))}double(){const{a:m}=r,{X:_,Y:k,Z:N}=this,I=a(_*_),T=a(k*k),x=a(ny*a(N*N)),D=a(m*I),F=_+k,R=a(a(F*F)-I-T),C=D+T,O=C-x,P=D-T,M=a(R*O),K=a(C*P),H=a(R*P),$=a(O*C);return new g(M,K,$,H)}add(m){u(m);const{a:_,d:k}=r,{X:N,Y:I,Z:T,T:x}=this,{X:D,Y:F,Z:R,T:C}=m,O=a(N*D),P=a(I*F),M=a(x*k*C),K=a(T*R),H=a((N+I)*(D+F)-O-P),$=K-M,L=K+M,z=a(P-_*O),q=a(H*$),Y=a(L*z),X=a(H*z),j=a($*L);return new g(q,Y,j,X)}subtract(m){return this.add(m.negate())}multiply(m){const _=m;Co("scalar",_,er,i);const{p:k,f:N}=y.cached(this,_,I=>Fa(g,I));return Fa(g,[k,N])[0]}multiplyUnsafe(m,_=g.ZERO){const k=m;return Co("scalar",k,qs,i),k===qs?g.ZERO:this.is0()||k===er?this:y.unsafe(this,k,N=>Fa(g,N),_)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}isTorsionFree(){return y.unsafe(this,i).is0()}toAffine(m){return h(this,m)}clearCofactor(){return s===er?this:this.multiplyUnsafe(s)}static fromBytes(m,_=!1){return pn(m),g.fromHex(m,_)}static fromHex(m,_=!1){const{d:k,a:N}=r,I=t.BYTES;m=Ct("pointHex",m,I),cc("zip215",_);const T=m.slice(),x=m[I-1];T[I-1]=x&-129;const D=lc(T),F=_?o:t.ORDER;Co("pointHex.y",D,qs,F);const R=a(D*D),C=a(R-er),O=a(k*R-N);let{isValid:P,value:M}=c(C,O);if(!P)throw new Error("Point.fromHex: invalid y coordinate");const K=(M&er)===er,H=(x&128)!==0;if(!_&&M===qs&&H)throw new Error("Point.fromHex: x=0 and x_0=1");return H!==K&&(M=a(-M)),g.fromAffine({x:M,y:D})}toBytes(){const{x:m,y:_}=this.toAffine(),k=df(_,t.BYTES);return k[k.length-1]|=m&er?128:0,k}toRawBytes(){return this.toBytes()}toHex(){return ec(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}g.BASE=new g(r.Gx,r.Gy,er,a(r.Gx*r.Gy)),g.ZERO=new g(qs,er,er,qs),g.Fp=t,g.Fn=n;const y=new o_(g,n.BYTES*8);return g}function mN(r,e,t){if(typeof e!="function")throw new Error('"hash" function param is required');Uu(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=o.ORDER,c=t.randomBytes||pg,l=t.adjustScalarBytes||(O=>O),u=t.domain||((O,P,M)=>{if(cc("phflag",M),P.length||M)throw new Error("Contexts/pre-hash are not supported");return O});function h(O){return o.create(O)}function d(O){return h(lc(O))}function g(O){const P=i.BYTES;O=Ct("private key",O,P);const M=Ct("hashed private key",e(O),2*P),K=l(M.slice(0,P)),H=M.slice(P,2*P),$=d(K);return{head:K,prefix:H,scalar:$}}function y(O){const{head:P,prefix:M,scalar:K}=g(O),H=s.multiply(K),$=H.toBytes();return{head:P,prefix:M,scalar:K,point:H,pointBytes:$}}function w(O){return y(O).pointBytes}function m(O=Uint8Array.of(),...P){const M=Di(...P);return d(e(u(M,Ct("context",O),!!n)))}function _(O,P,M={}){O=Ct("message",O),n&&(O=n(O));const{prefix:K,scalar:H,pointBytes:$}=y(P),L=m(M.context,K,O),z=s.multiply(L).toBytes(),q=m(M.context,z,$,O),Y=h(L+q*H);Co("signature.s",Y,qs,a);const X=i.BYTES,j=Di(z,df(Y,X));return Ct("result",j,X*2)}const k={zip215:!0};function N(O,P,M,K=k){const{context:H,zip215:$}=K,L=i.BYTES;O=Ct("signature",O,2*L),P=Ct("message",P),M=Ct("publicKey",M,L),$!==void 0&&cc("zip215",$),n&&(P=n(P));const z=lc(O.slice(L,2*L));let q,Y,X;try{q=r.fromHex(M,$),Y=r.fromHex(O.slice(0,L),$),X=s.multiplyUnsafe(z)}catch{return!1}if(!$&&q.isSmallOrder())return!1;const j=m(H,Y.toBytes(),q.toBytes(),P);return Y.add(q.multiplyUnsafe(j)).subtract(X).clearCofactor().is0()}s.precompute(8);const I=i.BYTES,T={secret:I,public:I,signature:2*I,seed:I};function x(O=c(T.seed)){return O}const D={getExtendedPublicKey:y,randomSecretKey:x,isValidSecretKey:R,isValidPublicKey:C,randomPrivateKey:x,toMontgomery(O){const{y:P}=r.fromBytes(O),M=I===32;if(!M&&I!==57)throw new Error("only defined for 25519 and 448");const K=M?i.div(er+P,er-P):i.div(P-er,P+er);return i.toBytes(K)},toMontgomeryPriv(O){pn(O,I);const P=e(O.subarray(0,I));return l(P).subarray(0,I)},precompute(O=8,P=r.BASE){return P.precompute(O,!1)}};function F(O){const P=D.randomSecretKey(O);return{secretKey:P,publicKey:w(P)}}function R(O){try{return!!o.fromBytes(O,!1)}catch{return!1}}function C(O,P){try{return!!r.fromBytes(O,P)}catch{return!1}}return Object.freeze({keygen:F,getPublicKey:w,sign:_,verify:N,utils:D,Point:r,info:{type:"edwards",lengths:T}})}function wN(r){const e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=Oc(e.n,r.nBitLength,!0),s={Fp:t,Fn:n,uvRatio:r.uvRatio},i={randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:s,hash:r.hash,eddsaOpts:i}}function bN(r,e){return Object.assign({},e,{ExtendedPoint:e.Point,CURVE:r})}function vN(r){const{CURVE:e,curveOpts:t,hash:n,eddsaOpts:s}=wN(r),i=yN(e,t),o=mN(i,n,s);return bN(r,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const mh=BigInt(0),ul=BigInt(1),t1=BigInt(2);function EN(r){return Uu(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function SN(r){const e=EN(r),{P:t,type:n,adjustScalarBytes:s,powPminus2:i,randomBytes:o}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");const c=o||pg,l=a?255:448,u=a?32:56,h=BigInt(a?9:5),d=BigInt(a?121665:39081),g=a?t1**BigInt(254):t1**BigInt(447),y=a?BigInt(8)*t1**BigInt(251)-ul:BigInt(4)*t1**BigInt(445)-ul,w=g+y+ul,m=M=>Kt(M,t),_=k(h);function k(M){return df(m(M),u)}function N(M){const K=Ct("u coordinate",M,u);return a&&(K[31]&=127),m(lc(K))}function I(M){return lc(s(Ct("scalar",M,u)))}function T(M,K){const H=F(N(K),I(M));if(H===mh)throw new Error("invalid private or public key received");return k(H)}function x(M){return T(M,_)}function D(M,K,H){const $=m(M*(K-H));return K=m(K-$),H=m(H+$),{x_2:K,x_3:H}}function F(M,K){Co("u",M,mh,t),Co("scalar",K,g,w);const H=K,$=M;let L=ul,z=mh,q=M,Y=ul,X=mh;for(let me=BigInt(l-1);me>=mh;me--){const de=H>>me&ul;X^=de,{x_2:L,x_3:q}=D(X,L,q),{x_2:z,x_3:Y}=D(X,z,Y),X=de;const Q=L+z,J=m(Q*Q),ge=L-z,ke=m(ge*ge),Ue=J-ke,Ke=q+Y,at=q-Y,et=m(at*Q),tt=m(Ke*ge),yt=et+tt,hr=et-tt;q=m(yt*yt),Y=m($*m(hr*hr)),L=m(J*ke),z=m(Ue*(J+m(d*Ue)))}({x_2:L,x_3:q}=D(X,L,q)),{x_2:z,x_3:Y}=D(X,z,Y);const j=i(z);return m(L*j)}const R=(M=c(u))=>M,C={randomSecretKey:R,randomPrivateKey:R};function O(M){const K=C.randomSecretKey(M);return{secretKey:K,publicKey:x(K)}}const P={secret:u,public:u,seed:u};return{keygen:O,getSharedSecret:(M,K)=>T(M,K),getPublicKey:M=>x(M),scalarMult:T,scalarMultBase:x,utils:C,GuBytes:_.slice(),info:{type:"montgomery",lengths:P}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */BigInt(0);const _N=BigInt(1),F8=BigInt(2),xN=BigInt(3),AN=BigInt(5),IN=BigInt(8),pf={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:IN,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function l_(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=pf.p,a=r*r%i*r%i,c=Lt(a,F8,i)*a%i,l=Lt(c,_N,i)*r%i,u=Lt(l,AN,i)*l%i,h=Lt(u,e,i)*u%i,d=Lt(h,t,i)*h%i,g=Lt(d,n,i)*d%i,y=Lt(g,s,i)*g%i,w=Lt(y,s,i)*g%i,m=Lt(w,e,i)*u%i;return{pow_p_5_8:Lt(m,F8,i)*r%i,b2:a}}function u_(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const V8=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function kN(r,e){const t=pf.p,n=Kt(e*e*e,t),s=Kt(n*n*e,t),i=l_(r*s).pow_p_5_8;let o=Kt(r*n*i,t);const a=Kt(e*o*o,t),c=o,l=Kt(o*V8,t),u=a===r,h=a===Kt(-r,t),d=a===Kt(-r*V8,t);return u&&(o=c),(h||d)&&(o=l),iN(o,t)&&(o=Kt(-o,t)),{isValid:u||h,value:o}}const TN=Oc(pf.p,{isLE:!0}),CN={...pf,Fp:TN,hash:zS,adjustScalarBytes:u_,uvRatio:kN},kp=vN(CN),r1=(()=>{const r=pf.p;return SN({P:r,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:n}=l_(e);return Kt(Lt(t,xN,r)*n,r)},adjustScalarBytes:u_})})();class K8 extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class q8 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class PN extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Gr={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new PN("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}},Ed=32,Qs=64,Bm=32;let Ll;const h_=(async()=>{try{return await Gr.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function DN(){const r=kp.utils.randomPrivateKey(),e=kp.getPublicKey(r);return{privateKey:$N(r,e),publicKey:e}}async function RN(r,e){let t;r.length===Qs?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:se(r.subarray(32),"base64url"),d:se(t,"base64url"),ext:!0,key_ops:["sign"]},s=await Gr.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Gr.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function ON(r,e){const t=r.subarray(0,Bm);return kp.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function NN(r,e){return Ll==null&&(Ll=await h_),Ll?RN(r,e):ON(r,e)}async function MN(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Gr.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Gr.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function BN(r,e,t){return kp.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function LN(r,e,t){return Ll==null&&(Ll=await h_),Ll?MN(r,e,t):BN(r,e,t)}function $N(r,e){const t=new Uint8Array(Qs);for(let n=0;n<Bm;n++)t[n]=r[n],t[Bm+n]=e[n];return t}function yg(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class d_{type="Ed25519";raw;constructor(e){this.raw=Sd(e,Ed)}toMultihash(){return Go.digest(Rn(this))}toCID(){return $e.createV1(114,this.toMultihash())}toString(){return Xt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=LN(this.raw,t,e);return yg(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}class Lm{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=Sd(e,Qs),this.publicKey=new d_(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=NN(this.raw,e);return yg(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function f_(r){if(r.length>Qs){r=Sd(r,Qs+Ed);const n=r.subarray(0,Qs),s=r.subarray(Qs,r.length);return new Lm(n,s)}r=Sd(r,Qs);const e=r.subarray(0,Qs),t=r.subarray(Ed);return new Lm(e,t)}function B6(r){return r=Sd(r,Ed),new d_(r)}async function UN(){const{privateKey:r,publicKey:e}=DN();return new Lm(r,e)}function Sd(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new re(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const FN=Math.pow(2,7),VN=Math.pow(2,14),KN=Math.pow(2,21),L6=Math.pow(2,28),$6=Math.pow(2,35),U6=Math.pow(2,42),F6=Math.pow(2,49),lt=128,Rr=127;function At(r){if(r<FN)return 1;if(r<VN)return 2;if(r<KN)return 3;if(r<L6)return 4;if(r<$6)return 5;if(r<U6)return 6;if(r<F6)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Tp(r,e,t=0){switch(At(r)){case 8:e[t++]=r&255|lt,r/=128;case 7:e[t++]=r&255|lt,r/=128;case 6:e[t++]=r&255|lt,r/=128;case 5:e[t++]=r&255|lt,r/=128;case 4:e[t++]=r&255|lt,r>>>=7;case 3:e[t++]=r&255|lt,r>>>=7;case 2:e[t++]=r&255|lt,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function qN(r,e,t=0){switch(At(r)){case 8:e.set(t++,r&255|lt),r/=128;case 7:e.set(t++,r&255|lt),r/=128;case 6:e.set(t++,r&255|lt),r/=128;case 5:e.set(t++,r&255|lt),r/=128;case 4:e.set(t++,r&255|lt),r>>>=7;case 3:e.set(t++,r&255|lt),r>>>=7;case 2:e.set(t++,r&255|lt),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function p_(r,e){let t=r[e],n=0;if(n+=t&Rr,t<lt||(t=r[e+1],n+=(t&Rr)<<7,t<lt)||(t=r[e+2],n+=(t&Rr)<<14,t<lt)||(t=r[e+3],n+=(t&Rr)<<21,t<lt)||(t=r[e+4],n+=(t&Rr)*L6,t<lt)||(t=r[e+5],n+=(t&Rr)*$6,t<lt)||(t=r[e+6],n+=(t&Rr)*U6,t<lt)||(t=r[e+7],n+=(t&Rr)*F6,t<lt))return n;throw new RangeError("Could not decode varint")}function HN(r,e){let t=r.get(e),n=0;if(n+=t&Rr,t<lt||(t=r.get(e+1),n+=(t&Rr)<<7,t<lt)||(t=r.get(e+2),n+=(t&Rr)<<14,t<lt)||(t=r.get(e+3),n+=(t&Rr)<<21,t<lt)||(t=r.get(e+4),n+=(t&Rr)*L6,t<lt)||(t=r.get(e+5),n+=(t&Rr)*$6,t<lt)||(t=r.get(e+6),n+=(t&Rr)*U6,t<lt)||(t=r.get(e+7),n+=(t&Rr)*F6,t<lt))return n;throw new RangeError("Could not decode varint")}function is(r,e,t=0){return e==null&&(e=dn(At(r))),e instanceof Uint8Array?Tp(r,e,t):qN(r,e,t)}function Nc(r,e=0){return r instanceof Uint8Array?p_(r,e):HN(r,e)}const V6=new Float32Array([-0]),Po=new Uint8Array(V6.buffer);function zN(r,e,t){V6[0]=r,e[t]=Po[0],e[t+1]=Po[1],e[t+2]=Po[2],e[t+3]=Po[3]}function WN(r,e){return Po[0]=r[e],Po[1]=r[e+1],Po[2]=r[e+2],Po[3]=r[e+3],V6[0]}const K6=new Float64Array([-0]),Or=new Uint8Array(K6.buffer);function jN(r,e,t){K6[0]=r,e[t]=Or[0],e[t+1]=Or[1],e[t+2]=Or[2],e[t+3]=Or[3],e[t+4]=Or[4],e[t+5]=Or[5],e[t+6]=Or[6],e[t+7]=Or[7]}function GN(r,e){return Or[0]=r[e],Or[1]=r[e+1],Or[2]=r[e+2],Or[3]=r[e+3],Or[4]=r[e+4],Or[5]=r[e+5],Or[6]=r[e+6],Or[7]=r[e+7],K6[0]}const QN=BigInt(Number.MAX_SAFE_INTEGER),YN=BigInt(Number.MIN_SAFE_INTEGER);class Nr{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return tc;if(e<QN&&e>YN)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>H8&&(s=0n,++n>H8&&(n=0n))),new Nr(Number(s),Number(n))}static fromNumber(e){if(e===0)return tc;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new Nr(n,s)}static from(e){return typeof e=="number"?Nr.fromNumber(e):typeof e=="bigint"?Nr.fromBigInt(e):typeof e=="string"?Nr.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new Nr(e.low>>>0,e.high>>>0):tc}}const tc=new Nr(0,0);tc.toBigInt=function(){return 0n};tc.zzEncode=tc.zzDecode=function(){return this};tc.length=function(){return 1};const H8=4294967296n;function XN(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function ZN(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,a;for(;e<t;)a=r[e++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function g_(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function gs(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function n1(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class JN{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,gs(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw gs(this,4);return n1(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw gs(this,4);return n1(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw gs(this,4);const e=WN(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw gs(this,4);const e=GN(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw gs(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return ZN(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw gs(this,e);this.pos+=e}else do if(this.pos>=this.len)throw gs(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Nr(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw gs(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw gs(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw gs(this,8);const e=n1(this.buf,this.pos+=4),t=n1(this.buf,this.pos+=4);return new Nr(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=p_(this.buf,this.pos);return this.pos+=At(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function eM(r){return new JN(r instanceof Uint8Array?r:r.subarray())}function Te(r,e,t){const n=eM(r);return e.decode(n,void 0,t)}function tM(r){let n,s=8192;return function(o){if(o<1||o>4096)return dn(o);s+o>8192&&(n=dn(8192),s=0);const a=n.subarray(s,s+=o);return s&7&&(s=(s|7)+1),a}}class Fh{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function sy(){}class rM{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const nM=tM();function sM(r){return globalThis.Buffer!=null?dn(r):nM(r)}class $m{len;head;tail;states;constructor(){this.len=0,this.head=new Fh(sy,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Fh(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new oM((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(s1,10,Nr.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Nr.fromBigInt(e);return this._push(s1,t.length(),t)}uint64Number(e){return this._push(Tp,At(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Nr.fromBigInt(e).zzEncode();return this._push(s1,t.length(),t)}sint64Number(e){const t=Nr.fromNumber(e).zzEncode();return this._push(s1,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(iy,1,e?1:0)}fixed32(e){return this._push(wh,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Nr.fromBigInt(e);return this._push(wh,4,t.lo)._push(wh,4,t.hi)}fixed64Number(e){const t=Nr.fromNumber(e);return this._push(wh,4,t.lo)._push(wh,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(zN,4,e)}double(e){return this._push(jN,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(iy,1,0):this.uint32(t)._push(aM,t,e)}string(e){const t=XN(e);return t!==0?this.uint32(t)._push(g_,t,e):this._push(iy,1,0)}fork(){return this.states=new rM(this),this.head=this.tail=new Fh(sy,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Fh(sy,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=sM(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function iy(r,e,t){e[t]=r&255}function iM(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class oM extends Fh{next;constructor(e,t){super(iM,e,t),this.next=void 0}}function s1(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function wh(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function aM(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&($m.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(cM,e,r),this},$m.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(lM,e,r),this});function cM(r,e,t){e.set(r,t)}function lM(r,e,t){r.length<40?g_(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(ie(r),t)}function uM(){return new $m}function Ce(r,e){const t=uM();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Cp;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Cp||(Cp={}));function y_(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function gn(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const a=e(i);o.int32(a)},n=function(i){const o=i.int32();return e(o)};return y_("enum",Cp.VARINT,t,n)}function Pe(r,e){return y_("message",Cp.LENGTH_DELIMITED,r,e)}class ft extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class z8 extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var Dt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Dt||(Dt={}));var Um;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Um||(Um={}));(function(r){r.codec=()=>gn(Um)})(Dt||(Dt={}));var Qo;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Dt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Dt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Qo||(Qo={}));var Pp;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Dt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Dt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Pp||(Pp={}));function Yo(r){if(isNaN(r)||r<=0)throw new re("random bytes length must be a Number bigger than 0");return pg(r)}const rc=HS;let q6=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=z6(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return $e.createV1(114,this._multihash)}toString(){return Xt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}verify(e,t,n){return xM(this.jwk,t,e,n)}},m_=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=pM(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}sign(e,t){return _M(this.jwk,e,t)}};const w_=8192,H6=18,hM=1062,dM=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function fM(r){return{n:se(r[1],"base64url"),e:se(r[2],"base64url"),d:se(r[3],"base64url"),p:se(r[4],"base64url"),q:se(r[5],"base64url"),dp:se(r[6],"base64url"),dq:se(r[7],"base64url"),qi:se(r[8],"base64url"),kty:"RSA"}}function pM(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new re("JWK was missing components");return Bi([An(Uint8Array.from([0])),An(ie(r.n,"base64url")),An(ie(r.e,"base64url")),An(ie(r.d,"base64url")),An(ie(r.p,"base64url")),An(ie(r.q,"base64url")),An(ie(r.dp,"base64url")),An(ie(r.dq,"base64url")),An(ie(r.qi,"base64url"))]).subarray()}function gM(r){const e=ua(r[1],{offset:0});return{kty:"RSA",n:se(e[0],"base64url"),e:se(e[1],"base64url")}}function z6(r){if(r.n==null||r.e==null)throw new re("JWK was missing components");return Bi([dM,P6(Bi([An(ie(r.n,"base64url")),An(ie(r.e,"base64url"))]))]).subarray()}function yM(r){const e=ua(r);return b_(e)}function b_(r){const e=fM(r);return wM(e)}function mM(r,e){if(r.byteLength>=hM)throw new mp("Key size is too large");const t=ua(r,{offset:0});return v_(t,r,e)}function v_(r,e,t){const n=gM(r);if(t==null){const s=rc(Qo.encode({Type:Dt.RSA,Data:e}));t=zi(H6,s)}return new q6(n,t)}function wM(r){if(IM(r)>w_)throw new re("Key size is too large");const e=vM(r),t=rc(Qo.encode({Type:Dt.RSA,Data:z6(e.publicKey)})),n=zi(H6,t);return new m_(e.privateKey,new q6(e.publicKey,n))}async function bM(r){if(r>w_)throw new re("Key size is too large");const e=await SM(r),t=rc(Qo.encode({Type:Dt.RSA,Data:z6(e.publicKey)})),n=zi(H6,t);return new m_(e.privateKey,new q6(e.publicKey,n))}function vM(r){if(r==null)throw new re("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const EM="1.2.840.113549.1.1.1";async function SM(r,e){const t=await Gr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await AM(t);return{privateKey:n[0],publicKey:n[1]}}async function _M(r,e,t){const n=await Gr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const s=await Gr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function xM(r,e,t,n){const s=await Gr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Gr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function AM(r,e){if(r.privateKey==null||r.publicKey==null)throw new re("Private and public key are required");return await Promise.all([Gr.get().subtle.exportKey("jwk",r.privateKey),Gr.get().subtle.exportKey("jwk",r.publicKey)])}function IM(r){if(r.kty!=="RSA")throw new re("invalid key type");if(r.n==null)throw new re("invalid key modulus");return ie(r.n,"base64url").length*8}class E_ extends FS{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,hf(e);const n=vd(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(n.length>s?e.create().update(n).digest():n);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),ai(i)}update(e){return _p(this),this.iHash.update(e),this}digestInto(e){_p(this),pn(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const gf=(r,e,t)=>new E_(r,e).update(t).digest();gf.create=(r,e)=>new E_(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const W8=(r,e)=>(r+(r>=0?e:-e)/S_)/e;function kM(r,e,t){const[[n,s],[i,o]]=e,a=W8(o*r,t),c=W8(-s*r,t);let l=r-a*n-c*i,u=-a*s-c*o;const h=l<Ri,d=u<Ri;h&&(l=-l),d&&(u=-u);const g=ff(Math.ceil(jS(t)/2))+$l;if(l<Ri||l>=g||u<Ri||u>=g)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:l,k2neg:d,k2:u}}function j8(r){r.lowS!==void 0&&cc("lowS",r.lowS),r.prehash!==void 0&&cc("prehash",r.prehash)}class TM extends Error{constructor(e=""){super(e)}}const Ti={Err:TM,_tlv:{encode:(r,e)=>{const{Err:t}=Ti;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=e1(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?e1(s.length/2|128):"";return e1(r)+i+s+e},decode(r,e){const{Err:t}=Ti;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const u of l)o=o<<8|u;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Ti;if(r<Ri)throw new e("integer: negative integers are not allowed");let t=e1(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Ti;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return gg(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Ti,s=Ct("signature",r),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=Ti,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Ri=BigInt(0),$l=BigInt(1),S_=BigInt(2),i1=BigInt(3),CM=BigInt(4);function PM(r,e,t){function n(s){const i=r.sqr(s),o=r.mul(i,s);return r.add(r.add(o,r.mul(s,e)),t)}return n}function Il(r,e){const{BYTES:t}=r;let n;if(typeof e=="bigint")n=e;else{let s=Ct("private key",e);try{n=r.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!r.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function DM(r,e={}){const{Fp:t,Fn:n}=c_("weierstrass",r,e),{h:s,n:i}=r;Uu(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:o}=e;if(o&&(!t.is0(r.a)||typeof o.beta!="bigint"||!Array.isArray(o.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(R,C,O){const{x:P,y:M}=C.toAffine(),K=t.toBytes(P);if(cc("isCompressed",O),O){a();const H=!t.isOdd(M);return Di(__(H),K)}else return Di(Uint8Array.of(4),K,t.toBytes(M))}function l(R){pn(R);const C=t.BYTES,O=C+1,P=2*C+1,M=R.length,K=R[0],H=R.subarray(1);if(M===O&&(K===2||K===3)){const $=t.fromBytes(H);if(!t.isValid($))throw new Error("bad point: is not on curve, wrong x");const L=d($);let z;try{z=t.sqrt(L)}catch(X){const j=X instanceof Error?": "+X.message:"";throw new Error("bad point: is not on curve, sqrt error"+j)}a();const q=t.isOdd(z);return(K&1)===1!==q&&(z=t.neg(z)),{x:$,y:z}}else if(M===P&&K===4){const $=t.fromBytes(H.subarray(C*0,C*1)),L=t.fromBytes(H.subarray(C*1,C*2));if(!g($,L))throw new Error("bad point: is not on curve");return{x:$,y:L}}else throw new Error(`bad point: got length ${M}, expected compressed=${O} or uncompressed=${P}`)}const u=e.toBytes||c,h=e.fromBytes||l,d=PM(t,r.a,r.b);function g(R,C){const O=t.sqr(C),P=d(R);return t.eql(O,P)}if(!g(r.Gx,r.Gy))throw new Error("bad curve params: generator point");const y=t.mul(t.pow(r.a,i1),CM),w=t.mul(t.sqr(r.b),BigInt(27));if(t.is0(t.add(y,w)))throw new Error("bad curve params: a or b");function m(R,C,O=!1){if(!t.isValid(C)||O&&t.is0(C))throw new Error(`bad point coordinate ${R}`);return C}function _(R){if(!(R instanceof x))throw new Error("ProjectivePoint expected")}function k(R){if(!o||!o.basises)throw new Error("no endo");return kM(R,o.basises,n.ORDER)}const N=Ap((R,C)=>{const{X:O,Y:P,Z:M}=R;if(t.eql(M,t.ONE))return{x:O,y:P};const K=R.is0();C==null&&(C=K?t.ONE:t.inv(M));const H=t.mul(O,C),$=t.mul(P,C),L=t.mul(M,C);if(K)return{x:t.ZERO,y:t.ZERO};if(!t.eql(L,t.ONE))throw new Error("invZ was invalid");return{x:H,y:$}}),I=Ap(R=>{if(R.is0()){if(e.allowInfinityPoint&&!t.is0(R.Y))return;throw new Error("bad point: ZERO")}const{x:C,y:O}=R.toAffine();if(!t.isValid(C)||!t.isValid(O))throw new Error("bad point: x or y not field elements");if(!g(C,O))throw new Error("bad point: equation left != right");if(!R.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function T(R,C,O,P,M){return O=new x(t.mul(O.X,R),O.Y,O.Z),C=Ip(P,C),O=Ip(M,O),C.add(O)}class x{constructor(C,O,P){this.X=m("x",C),this.Y=m("y",O,!0),this.Z=m("z",P),Object.freeze(this)}static fromAffine(C){const{x:O,y:P}=C||{};if(!C||!t.isValid(O)||!t.isValid(P))throw new Error("invalid affine point");if(C instanceof x)throw new Error("projective point not allowed");return t.is0(O)&&t.is0(P)?x.ZERO:new x(O,P,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}static normalizeZ(C){return Fa(x,C)}static fromBytes(C){return pn(C),x.fromHex(C)}static fromHex(C){const O=x.fromAffine(h(Ct("pointHex",C)));return O.assertValidity(),O}static fromPrivateKey(C){return x.BASE.multiply(Il(n,C))}static msm(C,O){return a_(x,n,C,O)}_setWindowSize(C){this.precompute(C)}precompute(C=8,O=!0){return F.createCache(this,C),O||this.multiply(i1),this}assertValidity(){I(this)}hasEvenY(){const{y:C}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(C)}equals(C){_(C);const{X:O,Y:P,Z:M}=this,{X:K,Y:H,Z:$}=C,L=t.eql(t.mul(O,$),t.mul(K,M)),z=t.eql(t.mul(P,$),t.mul(H,M));return L&&z}negate(){return new x(this.X,t.neg(this.Y),this.Z)}double(){const{a:C,b:O}=r,P=t.mul(O,i1),{X:M,Y:K,Z:H}=this;let $=t.ZERO,L=t.ZERO,z=t.ZERO,q=t.mul(M,M),Y=t.mul(K,K),X=t.mul(H,H),j=t.mul(M,K);return j=t.add(j,j),z=t.mul(M,H),z=t.add(z,z),$=t.mul(C,z),L=t.mul(P,X),L=t.add($,L),$=t.sub(Y,L),L=t.add(Y,L),L=t.mul($,L),$=t.mul(j,$),z=t.mul(P,z),X=t.mul(C,X),j=t.sub(q,X),j=t.mul(C,j),j=t.add(j,z),z=t.add(q,q),q=t.add(z,q),q=t.add(q,X),q=t.mul(q,j),L=t.add(L,q),X=t.mul(K,H),X=t.add(X,X),q=t.mul(X,j),$=t.sub($,q),z=t.mul(X,Y),z=t.add(z,z),z=t.add(z,z),new x($,L,z)}add(C){_(C);const{X:O,Y:P,Z:M}=this,{X:K,Y:H,Z:$}=C;let L=t.ZERO,z=t.ZERO,q=t.ZERO;const Y=r.a,X=t.mul(r.b,i1);let j=t.mul(O,K),me=t.mul(P,H),de=t.mul(M,$),Q=t.add(O,P),J=t.add(K,H);Q=t.mul(Q,J),J=t.add(j,me),Q=t.sub(Q,J),J=t.add(O,M);let ge=t.add(K,$);return J=t.mul(J,ge),ge=t.add(j,de),J=t.sub(J,ge),ge=t.add(P,M),L=t.add(H,$),ge=t.mul(ge,L),L=t.add(me,de),ge=t.sub(ge,L),q=t.mul(Y,J),L=t.mul(X,de),q=t.add(L,q),L=t.sub(me,q),q=t.add(me,q),z=t.mul(L,q),me=t.add(j,j),me=t.add(me,j),de=t.mul(Y,de),J=t.mul(X,J),me=t.add(me,de),de=t.sub(j,de),de=t.mul(Y,de),J=t.add(J,de),j=t.mul(me,J),z=t.add(z,j),j=t.mul(ge,J),L=t.mul(Q,L),L=t.sub(L,j),j=t.mul(Q,me),q=t.mul(ge,q),q=t.add(q,j),new x(L,z,q)}subtract(C){return this.add(C.negate())}is0(){return this.equals(x.ZERO)}multiply(C){const{endo:O}=e;if(!n.isValidNot0(C))throw new Error("invalid scalar: out of range");let P,M;const K=H=>F.cached(this,H,$=>Fa(x,$));if(O){const{k1neg:H,k1:$,k2neg:L,k2:z}=k(C),{p:q,f:Y}=K($),{p:X,f:j}=K(z);M=Y.add(j),P=T(O.beta,q,X,H,L)}else{const{p:H,f:$}=K(C);P=H,M=$}return Fa(x,[P,M])[0]}multiplyUnsafe(C){const{endo:O}=e,P=this;if(!n.isValid(C))throw new Error("invalid scalar: out of range");if(C===Ri||P.is0())return x.ZERO;if(C===$l)return P;if(F.hasCache(this))return this.multiply(C);if(O){const{k1neg:M,k1:K,k2neg:H,k2:$}=k(C),{p1:L,p2:z}=fN(x,P,K,$);return T(O.beta,L,z,M,H)}else return F.unsafe(P,C)}multiplyAndAddUnsafe(C,O,P){const M=this.multiplyUnsafe(O).add(C.multiplyUnsafe(P));return M.is0()?void 0:M}toAffine(C){return N(this,C)}isTorsionFree(){const{isTorsionFree:C}=e;return s===$l?!0:C?C(x,this):F.unsafe(this,i).is0()}clearCofactor(){const{clearCofactor:C}=e;return s===$l?this:C?C(x,this):this.multiplyUnsafe(s)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}toBytes(C=!0){return cc("isCompressed",C),this.assertValidity(),u(x,this,C)}toRawBytes(C=!0){return this.toBytes(C)}toHex(C=!0){return ec(this.toBytes(C))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}x.BASE=new x(r.Gx,r.Gy,t.ONE),x.ZERO=new x(t.ZERO,t.ONE,t.ZERO),x.Fp=t,x.Fn=n;const D=n.BITS,F=new o_(x,e.endo?Math.ceil(D/2):D);return x}function __(r){return Uint8Array.of(r?2:3)}function RM(r,e,t={}){hf(e),Uu(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=t.randomBytes||pg,s=t.hmac||(($,...L)=>gf(e,$,Di(...L))),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,l=n_(a),u={secret:o.BYTES,public:1+i.BYTES,publicUncompressed:1+2*i.BYTES,signature:2*o.BYTES,seed:l};function h($){const L=a>>$l;return $>L}function d($){return h($)?o.neg($):$}function g($,L){if(!o.isValidNot0(L))throw new Error(`invalid signature ${$}: out of range 1..CURVE.n`)}class y{constructor(L,z,q){g("r",L),g("s",z),this.r=L,this.s=z,q!=null&&(this.recovery=q),Object.freeze(this)}static fromBytes(L,z="compact"){if(z==="compact"){const q=o.BYTES;pn(L,q*2);const Y=L.subarray(0,q),X=L.subarray(q,q*2);return new y(o.fromBytes(Y),o.fromBytes(X))}if(z==="der"){pn(L);const{r:q,s:Y}=Ti.toSig(L);return new y(q,Y)}throw new Error("invalid format")}static fromHex(L,z){return this.fromBytes(xp(L),z)}addRecoveryBit(L){return new y(this.r,this.s,L)}recoverPublicKey(L){const z=i.ORDER,{r:q,s:Y,recovery:X}=this;if(X==null||![0,1,2,3].includes(X))throw new Error("recovery id invalid");if(a*S_<z&&X>1)throw new Error("recovery id is ambiguous for h>1 curve");const me=X===2||X===3?q+a:q;if(!i.isValid(me))throw new Error("recovery id 2 or 3 invalid");const de=i.toBytes(me),Q=r.fromHex(Di(__((X&1)===0),de)),J=o.inv(me),ge=D(Ct("msgHash",L)),ke=o.create(-ge*J),Ue=o.create(Y*J),Ke=r.BASE.multiplyUnsafe(ke).add(Q.multiplyUnsafe(Ue));if(Ke.is0())throw new Error("point at infinify");return Ke.assertValidity(),Ke}hasHighS(){return h(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,o.neg(this.s),this.recovery):this}toBytes(L="compact"){if(L==="compact")return Di(o.toBytes(this.r),o.toBytes(this.s));if(L==="der")return xp(Ti.hexFromSig(this));throw new Error("invalid format")}toHex(L){return ec(this.toBytes(L))}assertValidity(){}static fromCompact(L){return y.fromBytes(Ct("sig",L),"compact")}static fromDER(L){return y.fromBytes(Ct("sig",L),"der")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return ec(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return ec(this.toBytes("compact"))}}function w($){try{return!!Il(o,$)}catch{return!1}}function m($,L){try{const z=$.length;return L===!0&&z!==u.public||L===!1&&z!==u.publicUncompressed?!1:!!r.fromBytes($)}catch{return!1}}function _($=n(l)){return uN($,a)}const k={isValidSecretKey:w,isValidPublicKey:m,randomSecretKey:_,isValidPrivateKey:w,randomPrivateKey:_,normPrivateKeyToScalar:$=>Il(o,$),precompute($=8,L=r.BASE){return L.precompute($,!1)}};function N($,L=!0){return r.BASE.multiply(Il(o,$)).toBytes(L)}function I($){if(typeof $=="bigint")return!1;if($ instanceof r)return!0;if(o.allowedLengths||u.secret===u.public)return;const L=Ct("key",$).length;return L===u.public||L===u.publicUncompressed}function T($,L,z=!0){if(I($)===!0)throw new Error("first arg must be private key");if(I(L)===!1)throw new Error("second arg must be public key");const q=Il(o,$);return r.fromHex(L).multiply(q).toBytes(z)}const x=t.bits2int||function($){if($.length>8192)throw new Error("input is too large");const L=gg($),z=$.length*8-c;return z>0?L>>BigInt(z):L},D=t.bits2int_modN||function($){return o.create(x($))},F=ff(c);function R($){return Co("num < 2^"+c,$,Ri,F),o.toBytes($)}function C($,L,z=O){if(["recovered","canonical"].some(ke=>ke in z))throw new Error("sign() legacy options not supported");let{lowS:q,prehash:Y,extraEntropy:X}=z;q==null&&(q=!0),$=Ct("msgHash",$),j8(z),Y&&($=Ct("prehashed msgHash",e($)));const j=D($),me=Il(o,L),de=[R(me),R(j)];if(X!=null&&X!==!1){const ke=X===!0?n(u.secret):X;de.push(Ct("extraEntropy",ke))}const Q=Di(...de),J=j;function ge(ke){const Ue=x(ke);if(!o.isValidNot0(Ue))return;const Ke=o.inv(Ue),at=r.BASE.multiply(Ue).toAffine(),et=o.create(at.x);if(et===Ri)return;const tt=o.create(Ke*o.create(J+et*me));if(tt===Ri)return;let yt=(at.x===et?0:2)|Number(at.y&$l),hr=tt;return q&&h(tt)&&(hr=d(tt),yt^=1),new y(et,hr,yt)}return{seed:Q,k2sig:ge}}const O={lowS:t.lowS,prehash:!1},P={lowS:t.lowS,prehash:!1};function M($,L,z=O){const{seed:q,k2sig:Y}=C($,L,z);return JO(e.outputLen,o.BYTES,s)(q,Y)}r.BASE.precompute(8);function K($,L,z,q=P){const Y=$;L=Ct("msgHash",L),z=Ct("publicKey",z),j8(q);const{lowS:X,prehash:j,format:me}=q;if("strict"in q)throw new Error("options.strict was renamed to lowS");let de,Q;if(me===void 0){const J=typeof Y=="string"||Sp(Y),ge=!J&&Y!==null&&typeof Y=="object"&&typeof Y.r=="bigint"&&typeof Y.s=="bigint";if(!J&&!ge)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(ge)de=new y(Y.r,Y.s);else if(J){try{de=y.fromDER(Y)}catch(ke){if(!(ke instanceof Ti.Err))throw ke}if(!de)try{de=y.fromCompact(Y)}catch{return!1}}}else if(me==="compact"||me==="der"){if(typeof Y!="string"&&!Sp(Y))throw new Error('"der" / "compact" format expects Uint8Array signature');de=y.fromBytes(Ct("sig",Y),me)}else if(me==="js"){if(!(Y instanceof y))throw new Error('"js" format expects Signature instance');de=Y}else throw new Error('format must be "compact", "der" or "js"');if(!de)return!1;try{if(Q=r.fromHex(z),X&&de.hasHighS())return!1;j&&(L=e(L));const{r:J,s:ge}=de,ke=D(L),Ue=o.inv(ge),Ke=o.create(ke*Ue),at=o.create(J*Ue),et=r.BASE.multiplyUnsafe(Ke).add(Q.multiplyUnsafe(at));return et.is0()?!1:o.create(et.x)===J}catch{return!1}}function H($){const L=k.randomSecretKey($);return{secretKey:L,publicKey:N(L)}}return Object.freeze({keygen:H,getPublicKey:N,sign:M,verify:K,getSharedSecret:T,utils:k,Point:r,Signature:y,info:{type:"weierstrass",lengths:u,publicKeyHasPrefix:!0}})}function OM(r){const e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp;let n=r.allowedPrivateKeyLengths?Array.from(new Set(r.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0;const s=Oc(e.n,{BITS:r.nBitLength,allowedLengths:n,modOnDecode:r.wrapPrivateKey}),i={Fp:t,Fn:s,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:i}}function NM(r){const{CURVE:e,curveOpts:t}=OM(r),n={hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,hash:r.hash,ecdsaOpts:n}}function MM(r,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:r})}function BM(r){const{CURVE:e,curveOpts:t,hash:n,ecdsaOpts:s}=NM(r),i=DM(e,t),o=RM(i,n,s);return MM(r,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function LM(r,e){const t=n=>BM({...r,hash:n});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const W6={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},$M={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},G8=BigInt(2);function UM(r){const e=W6.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,h=Lt(u,t,e)*u%e,d=Lt(h,t,e)*u%e,g=Lt(d,G8,e)*l%e,y=Lt(g,s,e)*g%e,w=Lt(y,i,e)*y%e,m=Lt(w,a,e)*w%e,_=Lt(m,c,e)*m%e,k=Lt(_,a,e)*w%e,N=Lt(k,t,e)*u%e,I=Lt(N,o,e)*y%e,T=Lt(I,n,e)*l%e,x=Lt(T,G8,e);if(!Fm.eql(Fm.sqr(x),r))throw new Error("Cannot find square root");return x}const Fm=Oc(W6.p,void 0,void 0,{sqrt:UM}),Wi=LM({...W6,Fp:Fm,lowS:!0,endo:$M},HS),FM=33,VM=32;function KM(r,e,t){const n=fn.digest(e instanceof Uint8Array?e:e.subarray());if(yg(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),Wi.sign(s,r).toDERRawBytes())).catch(s=>{throw s.name==="AbortError"?s:new K8(String(s))});try{return Wi.sign(n.digest,r).toDERRawBytes()}catch(s){throw new K8(String(s))}}function qM(r,e,t,n){const s=fn.digest(t instanceof Uint8Array?t:t.subarray());if(yg(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),Wi.verify(e,i,r))).catch(i=>{throw i.name==="AbortError"?i:new q8(String(i))});try{return n?.signal?.throwIfAborted(),Wi.verify(e,s.digest,r)}catch(i){throw new q8(String(i))}}class x_{type="secp256k1";raw;_key;constructor(e){this._key=jM(e),this.raw=zM(this._key)}toMultihash(){return Go.digest(Rn(this))}toCID(){return $e.createV1(114,this.toMultihash())}toString(){return Xt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}verify(e,t,n){return qM(this._key,t,e,n)}}class A_{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=WM(e),this.publicKey=new x_(t??GM(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:We(this.raw,e.raw)}sign(e,t){return KM(this.raw,e,t)}}function I_(r){return new A_(r)}function j6(r){return new x_(r)}async function HM(){const r=QM();return new A_(r)}function zM(r){return Wi.ProjectivePoint.fromHex(r).toRawBytes(!0)}function WM(r){try{return Wi.getPublicKey(r,!0),r}catch(e){throw new hS(String(e))}}function jM(r){try{return Wi.ProjectivePoint.fromHex(r),r}catch(e){throw new mp(String(e))}}function GM(r){try{return Wi.getPublicKey(r,!0)}catch(e){throw new hS(String(e))}}function QM(){return Wi.utils.randomPrivateKey()}async function mg(r,e){if(r==="Ed25519")return UN();if(r==="secp256k1")return HM();if(r==="RSA")return bM(ZM(e));if(r==="ECDSA")return RO(JM(e));throw new Lu}function Qr(r,e){const{Type:t,Data:n}=Qo.decode(r),s=n??new Uint8Array;switch(t){case Dt.RSA:return mM(s,e);case Dt.Ed25519:return B6(s);case Dt.secp256k1:return j6(s);case Dt.ECDSA:return MS(s);default:throw new Lu}}function YM(r){if(r.byteLength===Ed)return B6(r);if(r.byteLength===FM)return j6(r);const e=ua(r),t=e[1]?.[0];if(t===TS||t===CS||t===PS)return BS(e);if(e[0]?.[0]===EM)return v_(e,r);throw new re("Could not extract public key from raw bytes")}function k_(r){const{Type:e,Data:t}=Qo.decode(r.digest),n=t??new Uint8Array;switch(e){case Dt.Ed25519:return B6(n);case Dt.secp256k1:return j6(n);case Dt.ECDSA:return MS(n);default:throw new Lu}}function Rn(r){return Qo.encode({Type:Dt[r.type],Data:r.raw})}function XM(r){const e=Pp.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Dt.RSA:return yM(t);case Dt.Ed25519:return f_(t);case Dt.secp256k1:return I_(t);case Dt.ECDSA:return CO(t);default:throw new Lu}}function Vm(r){if(r.byteLength===Qs)return f_(r);if(r.byteLength===VM)return I_(r);const e=ua(r),t=e[2]?.[0];if(t===TS||t===CS||t===PS)return NS(e);if(e.length>8)return b_(e);throw new re("Could not extract private key from raw bytes")}function yf(r){return Pp.encode({Type:Dt[r.type],Data:r.raw})}function ZM(r){return r==null?2048:parseInt(r,10)}function JM(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new re("Unsupported curve, should be P-256, P-384 or P-521")}async function T_(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new re("Only RSA and ECDSA keys are supported")}const C_=Symbol.for("nodejs.util.inspect.custom"),eB=114;class G6{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[_6]=!0;toString(){return this.string==null&&(this.string=Xt.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return $e.createV1(eB,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return We(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return We(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[C_](){return`PeerId(${this.toString()})`}}class P_ extends G6{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class D_ extends G6{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class R_ extends G6{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const tB=2336;class O_{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Go.digest(ie(this.url))}[C_](){return`PeerId(${this.url})`}[_6]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return $e.createV1(tB,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=se(e)),e.toString()===this.toString())}}const rB=114,Q8=2336;function nr(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=ur(Xt.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Fu($e.parse(r));throw new re('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return Bn(t)}function uc(r){if(r.type==="Ed25519")return new D_({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new R_({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new P_({multihash:r.toCID().multihash,publicKey:r});throw new Lu}function nB(r){return uc(r.publicKey)}function Bn(r){if(iB(r))return new P_({multihash:r});if(sB(r))try{const e=k_(r);if(e.type==="Ed25519")return new D_({multihash:r,publicKey:e});if(e.type==="secp256k1")return new R_({multihash:r,publicKey:e})}catch{const t=se(r.digest);return new O_(new URL(t))}throw new I6("Supplied PeerID Multihash is invalid")}function Fu(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==rB&&r.code!==Q8)throw new UD("Supplied PeerID CID is invalid");if(r.code===Q8){const e=se(r.multihash.digest);return new O_(new URL(e))}return Bn(r.multihash)}function sB(r){return r.code===Go.code}function iB(r){return r.code===fn.code}function Dp(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}const{hasOwnProperty:N_}=Object.prototype,{propertyIsEnumerable:oB}=Object,tu=(r,e,t)=>{Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},aB=void 0,Y8={concatArrays:!1,ignoreUndefined:!1},wg=r=>{const e=[];for(const t in r)N_.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)oB.call(r,n)&&e.push(n)}return e};function Vu(r){return Array.isArray(r)?cB(r):Dp(r)?lB(r):r}function cB(r){const e=r.slice(0,0);return wg(r).forEach(t=>{tu(e,t,Vu(r[t]))}),e}function lB(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return wg(r).forEach(t=>{tu(e,t,Vu(r[t]))}),e}const M_=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?tu(r,s,Km(r[s],e[s],n)):tu(r,s,Vu(e[s])))}),r),uB=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)N_.call(i,a)&&(o.push(String(a)),i===r?tu(n,s++,i[a]):tu(n,s++,Vu(i[a])));n=M_(n,i,wg(i).filter(a=>!o.includes(a)),t)}),n};function Km(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?uB(r,e,t):!Dp(e)||!Dp(r)?Vu(e):M_(r,e,wg(e),t)}function Q6(...r){const e=Km(Vu(Y8),this!==aB&&this||{},Y8);let t={_:{}};for(const n of r)if(n!==void 0){if(!Dp(n))throw new TypeError("`"+n+"` is not an Option Object");t=Km(t,{_:n},e)}return t._}class xe extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}var Rp=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Mc(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function hB(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var s=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return r[n]}})}),t}var B_={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,h,d){if(typeof u!="function")throw new TypeError("The listener must be a function");var g=new s(u,h||c,d),y=t?t+l:l;return c._events[y]?c._events[y].fn?c._events[y]=[c._events[y],g]:c._events[y].push(g):(c._events[y]=g,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,h;if(this._eventsCount===0)return l;for(h in u=this._events)e.call(u,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=t?t+l:l,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var d=0,g=h.length,y=new Array(g);d<g;d++)y[d]=h[d].fn;return y},a.prototype.listenerCount=function(l){var u=t?t+l:l,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,u,h,d,g,y){var w=t?t+l:l;if(!this._events[w])return!1;var m=this._events[w],_=arguments.length,k,N;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),_){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,u),!0;case 3:return m.fn.call(m.context,u,h),!0;case 4:return m.fn.call(m.context,u,h,d),!0;case 5:return m.fn.call(m.context,u,h,d,g),!0;case 6:return m.fn.call(m.context,u,h,d,g,y),!0}for(N=1,k=new Array(_-1);N<_;N++)k[N-1]=arguments[N];m.fn.apply(m.context,k)}else{var I=m.length,T;for(N=0;N<I;N++)switch(m[N].once&&this.removeListener(l,m[N].fn,void 0,!0),_){case 1:m[N].fn.call(m[N].context);break;case 2:m[N].fn.call(m[N].context,u);break;case 3:m[N].fn.call(m[N].context,u,h);break;case 4:m[N].fn.call(m[N].context,u,h,d);break;default:if(!k)for(T=1,k=new Array(_-1);T<_;T++)k[T-1]=arguments[T];m[N].fn.apply(m[N].context,k)}}return!0},a.prototype.on=function(l,u,h){return i(this,l,u,h,!1)},a.prototype.once=function(l,u,h){return i(this,l,u,h,!0)},a.prototype.removeListener=function(l,u,h,d){var g=t?t+l:l;if(!this._events[g])return this;if(!u)return o(this,g),this;var y=this._events[g];if(y.fn)y.fn===u&&(!d||y.once)&&(!h||y.context===h)&&o(this,g);else{for(var w=0,m=[],_=y.length;w<_;w++)(y[w].fn!==u||d&&!y[w].once||h&&y[w].context!==h)&&m.push(y[w]);m.length?this._events[g]=m.length===1?m[0]:m:o(this,g)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&o(this,u)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(B_);var dB=B_.exports;const fB=Mc(dB);class L_ extends Error{constructor(e){super(e),this.name="TimeoutError"}}let pB=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const X8=r=>globalThis.DOMException===void 0?new pB(r):new DOMException(r),Z8=r=>{const e=r.reason===void 0?X8("This operation was aborted."):r.reason;return e instanceof Error?e:X8(e)};function bg(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((u,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:g}=e;g.aborted&&h(Z8(g)),a=()=>{h(Z8(g))},g.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,h);return}const d=new L_;o=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(g){h(g)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?u():s instanceof Error?h(s):(d.message=s??`Promise timed out after ${t} milliseconds`,h(d))},t),(async()=>{try{u(await r)}catch(g){h(g)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},l}function gB(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}let yB=class{#e=[];enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}const s=gB(this.#e,n,(i,o)=>o.priority-i.priority);this.#e.splice(s,0,n)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class ru extends fB{#e;#t;#r=0;#o;#a;#u=0;#s;#h;#n;#c;#i=0;#d;#l;#f;#b=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:yB,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#o=e.intervalCap,this.#a=e.interval,this.#n=new e.queueClass,this.#c=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#f=e.throwOnTimeout===!0,this.#l=e.autoStart===!1}get#v(){return this.#t||this.#r<this.#o}get#E(){return this.#i<this.#d}#S(){this.#i--,this.#p(),this.emit("next")}#_(){this.#w(),this.#m(),this.#h=void 0}get#x(){const e=Date.now();if(this.#s===void 0){const t=this.#u-e;if(t<0)this.#r=this.#e?this.#i:0;else return this.#h===void 0&&(this.#h=setTimeout(()=>{this.#_()},t)),!0}return!1}#p(){if(this.#n.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#i===0&&this.emit("idle"),!1;if(!this.#l){const e=!this.#x;if(this.#v&&this.#E){const t=this.#n.dequeue();return t?(this.emit("active"),t(),e&&this.#m(),!0):!1}}return!1}#m(){this.#t||this.#s!==void 0||(this.#s=setInterval(()=>{this.#w()},this.#a),this.#u=Date.now()+this.#a)}#w(){this.#r===0&&this.#i===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#r=this.#e?this.#i:0,this.#g()}#g(){for(;this.#p(););}get concurrency(){return this.#d}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#d=e,this.#g()}async#A(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#b++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#f,...t},new Promise((n,s)=>{this.#n.enqueue(async()=>{this.#i++,this.#r++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=bg(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#A(t.signal)]));const o=await i;n(o),this.emit("completed",o)}catch(i){if(i instanceof L_&&!t.throwOnTimeout){n();return}s(i),this.emit("error",i)}finally{this.#S()}},t),this.emit("add"),this.#p()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#l?(this.#l=!1,this.#g(),this):this}pause(){this.#l=!0}clear(){this.#n=new this.#c}async onEmpty(){this.#n.size!==0&&await this.#y("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#y("next",()=>this.#n.size<e)}async onIdle(){this.#i===0&&this.#n.size===0||await this.#y("idle")}async#y(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#l}}function $_(r){const e=[Xo.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const U_=60;function F_(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Xo[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Xo[e.type],TTL:e.TTL??e.ttl??U_,data:e.data instanceof Uint8Array?se(e.data):e.data}))}}const mB=4;function J8(r,e={}){const t=new ru({concurrency:e.queryConcurrency??mB});return async(n,s={})=>{const i=new URLSearchParams;i.set("name",n),$_(s.types).forEach(a=>{i.append("type",Xo[a])}),s.onProgress?.(new xe("dns:query",{detail:n}));const o=await t.add(async()=>{const a=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const c=F_(await a.json());return s.onProgress?.(new xe("dns:response",{detail:c})),c},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function wB(){return[J8("https://cloudflare-dns.com/dns-query"),J8("https://dns.google/resolve")]}var bB=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};const vB=Mc(bB);class EB{lru;constructor(e){this.lru=vB(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return F_({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Xo[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??U_)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function SB(r){return new EB(r)}const _B=1e3;let xB=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=SB(e.cacheSize??_B),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=wB())}async query(e,t={}){const n=$_(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new xe("dns:cache",{detail:s})),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const l=await c(e,{...t,types:n});for(const u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new xe("dns:error",{detail:l}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var Xo;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Xo||(Xo={}));function V_(r={}){return new xB(r)}class es extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class _d extends Error{static name="ValidationError";name="ValidationError"}class AB extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class IB extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}class kB{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*s)-1;for(;;){const u=this.readAtomically(()=>{const h=this.readChar();if(h===void 0)return;const d=Number.parseInt(h,e);if(!Number.isNaN(d))return d});if(u===void 0)break;if(i*=e,i+=u,i>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const K_=45,TB=15,nu=new kB;function q_(r){if(!(r.length>TB))return nu.new(r).parseWith(()=>nu.readIPv4Addr())}function H_(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>K_))return nu.new(r).parseWith(()=>nu.readIPv6Addr())}function qm(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>K_)return;const t=nu.new(r).parseWith(()=>nu.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function hc(r){return!!q_(r)}function Y6(r){return!!H_(r)}const dc=4,Li=6,Op=273,CB=33,os=41,Bc=42,X6=43,mf=53,wf=54,Ku=55,bf=56,PB=132,DB=301,RB=302,z_=400,pt=421,OB=444,NB=445,MB=446,BB=447,Ul=448,W_=449,LB=454,j_=460,G_=461,Q_=465,xd=466,Fl=480,$B=481,Hm=443,Z6=477,Y_=478,UB=479,FB=277,VB=275,KB=276,X_=280,Q1=281,Lc=290,Z_=777;function e7(r){return e=>se(e,r)}function t7(r){return e=>ie(e,r)}function Vh(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function kl(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function qB(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=ie(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=kl(n);return jr([t,s],t.length+s.length)}function HB(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Tn.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=kl(n);return jr([t,s],t.length+s.length)}function r7(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=se(e,"base32"),s=Vh(t);return`${n}:${s}`}const J_=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new es("Invalid byte value in IP address");e[n]=s}),e},zB=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=hc(t[n]);let o;i&&(o=J_(t[n]),t[n]=se(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,se(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new es("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},WB=function(r){if(r.byteLength!==4)throw new es("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},jB=function(r){if(r.byteLength!==16)throw new es("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new es(`Invalid IPv6 address "${t}"`)}};function GB(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new es(`Invalid IPv6 address "${r}"`)}}const oy=Object.values(Ep).map(r=>r.decoder),QB=function(){let r=oy[0].or(oy[1]);return oy.slice(2).forEach(e=>r=r.or(e)),r}();function YB(r){return QB.decode(r)}function XB(r){return e=>r.encoder.encode(e)}function ZB(r){if(parseInt(r).toString()!==r)throw new _d("Value must be an integer")}function JB(r){if(r<0)throw new _d("Value must be a positive integer, or zero")}function eL(r){return e=>{if(e>r)throw new _d(`Value must be smaller than or equal to ${r}`)}}function tL(...r){return e=>{for(const t of r)t(e)}}const o1=tL(ZB,JB,eL(65535)),Dr=-1;let rL=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new IB(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}};const Cs=new rL,nL=[{code:dc,name:"ip4",size:32,valueToBytes:J_,bytesToValue:WB,validate:r=>{if(!hc(r))throw new _d(`Invalid IPv4 address "${r}"`)}},{code:Li,name:"tcp",size:16,valueToBytes:kl,bytesToValue:Vh,validate:o1},{code:Op,name:"udp",size:16,valueToBytes:kl,bytesToValue:Vh,validate:o1},{code:CB,name:"dccp",size:16,valueToBytes:kl,bytesToValue:Vh,validate:o1},{code:os,name:"ip6",size:128,valueToBytes:zB,bytesToValue:jB,stringToValue:GB,validate:r=>{if(!Y6(r))throw new _d(`Invalid IPv6 address "${r}"`)}},{code:Bc,name:"ip6zone",size:Dr},{code:X6,name:"ipcidr",size:8,bytesToValue:e7("base10"),valueToBytes:t7("base10")},{code:mf,name:"dns",size:Dr,resolvable:!0},{code:wf,name:"dns4",size:Dr,resolvable:!0},{code:Ku,name:"dns6",size:Dr,resolvable:!0},{code:bf,name:"dnsaddr",size:Dr,resolvable:!0},{code:PB,name:"sctp",size:16,valueToBytes:kl,bytesToValue:Vh,validate:o1},{code:DB,name:"udt"},{code:RB,name:"utp"},{code:z_,name:"unix",size:Dr,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:pt,name:"p2p",aliases:["ipfs"],size:Dr,bytesToValue:e7("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?t7("base58btc")(r):$e.parse(r).multihash.bytes},{code:OB,name:"onion",size:96,bytesToValue:r7,valueToBytes:qB},{code:NB,name:"onion3",size:296,bytesToValue:r7,valueToBytes:HB},{code:MB,name:"garlic64",size:Dr},{code:BB,name:"garlic32",size:Dr},{code:Ul,name:"tls"},{code:W_,name:"sni",size:Dr},{code:LB,name:"noise"},{code:j_,name:"quic"},{code:G_,name:"quic-v1"},{code:Q_,name:"webtransport"},{code:xd,name:"certhash",size:Dr,bytesToValue:XB(cf),valueToBytes:YB},{code:Fl,name:"http"},{code:$B,name:"http-path",size:Dr,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:Hm,name:"https"},{code:Z6,name:"ws"},{code:Y_,name:"wss"},{code:UB,name:"p2p-websocket-star"},{code:FB,name:"p2p-stardust"},{code:VB,name:"p2p-webrtc-star"},{code:KB,name:"p2p-webrtc-direct"},{code:X_,name:"webrtc-direct"},{code:Q1,name:"webrtc"},{code:Lc,name:"p2p-circuit"},{code:Z_,name:"memory",size:Dr}];nL.forEach(r=>{Cs.addProtocol(r)});function sL(r){const e=[];let t=0;for(;t<r.length;){const n=Nc(r,t),s=Cs.getProtocol(n),i=At(n),o=cL(s,r,t+i);let a=0;o>0&&s.size===Dr&&(a=At(o));const c=i+a+o,l={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const u=t+i+a,h=r.subarray(u,u+o);l.value=s.bytesToValue?.(h)??se(h)}e.push(l),t+=c}return e}function iL(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=Cs.getProtocol(n.code),i=At(n.code);let o,a=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??ie(n.value),a=o.byteLength,s.size===Dr&&(c=At(a)));const l=new Uint8Array(i+c+a);let u=0;Tp(n.code,l,u),u+=i,o!=null&&(s.size===Dr&&(Tp(a,l,u),u+=c),l.set(o,u)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return jr(t,e)}function oL(r){if(r.charAt(0)!=="/")throw new es('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const a=i===r.length-1;if(o==="/"||a){const c=Cs.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new es(`Component ${s} was missing value`);t="value"}else if(t==="value"){const l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new es(`Component ${s} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new es("Incomplete multiaddr");return e}function aL(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=Cs.getProtocol(e.code);if(t==null)throw new es(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function cL(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Nc(e,t)}const lL=Symbol.for("nodejs.util.inspect.custom"),ex=Symbol.for("@multiformats/multiaddr"),uL=[mf,wf,Ku,bf];class hL extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function dL(r){if(r==null&&(r="/"),vg(r))return r.getComponents();if(r instanceof Uint8Array)return sL(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),oL(r);if(Array.isArray(r))return r;throw new es("Must be a string, Uint8Array, Component[], or another Multiaddr")}class Tl{[ex]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=dL(e),t.validate!==!1&&fL(this)}get bytes(){return this.#r==null&&(this.#r=iL(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=aL(this.#e)),this.#t}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";for(const{code:a,name:c,value:l}of this.#e)a===Bc&&(i=`%${l??""}`),uL.includes(a)&&(t="tcp",s=443,n=`${l??""}${i}`,e=a===Ku?6:4),(a===Li||a===Op)&&(t=c==="tcp"?"tcp":"udp",s=parseInt(l??"")),(a===dc||a===os)&&(t="tcp",n=`${l??""}${i}`,e=a===os?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{const n=Cs.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];const n=Cs.getProtocol(e),s=[e];return t!=null&&s.push(n.valueToBytes?.(t)??ie(t)),s})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){const t=new Tl(e);return new Tl([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new AB(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Tl(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new Tl(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:n,value:s})=>{n===pt&&e.push([n,s]),n===Lc&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?se(Xt.decode(`z${n}`),"base58btc"):se($e.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(const e of this.#e)if(Cs.getProtocol(e.code).path)return e.value??null;return null}equals(e){return We(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=AL.get(t.name);if(n==null)throw new hL(`no available resolver for ${t.name}`);return(await n(this,e)).map(i=>De(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==dc&&this.#e[0].code!==os||this.#e[1].code!==Li&&this.#e[1].code!==Op)}[lL](){return`Multiaddr(${this.toString()})`}}function fL(r){r.getComponents().forEach(e=>{const t=Cs.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function pL(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function gL(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function yL(r){switch(r.length){case Ad:return r.join(".");case Id:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function mL(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;n&128;)e++,n=n<<1;if(n&128)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function wL(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Ad=4,Id=16,bL=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function tx(r,e){e.length===Id&&r.length===Ad&&pL(e,0,11)&&(e=e.slice(12)),e.length===Ad&&r.length===Id&&gL(r,bL,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function vL(r,e){if(typeof e=="string"&&(e=qm(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function EL(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Ad,s=q_(e);if(s==null&&(n=Id,s=H_(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=rx(i,8*n);return{network:tx(s,o),mask:o}}function rx(r,e){if(e!==8*Ad&&e!==8*Id)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class nx{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=EL(e));else{const n=qm(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=qm(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=rx(s,8*n.length);this.network=tx(n,this.mask)}}contains(e){return vL({network:this.network,mask:this.mask},e)}toString(){const e=mL(this.mask),t=e!==-1?String(e):wL(this.mask);return yL(this.network)+"/"+t}}function SL(r,e){return new nx(r).contains(e)}function _L(r){let e,t;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(t=n.value),n.name==="ipcidr"&&(e=n.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new nx(t,e)}function xL(r,e){return Cs.getProtocol(r).bytesToValue?.(e)??se(e,"base16")}const AL=new Map;function vg(r){return!!r?.[ex]}function De(r){return new Tl(r)}function qu(r){const e=Cs.getProtocol(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}class IL{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Xo.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(const c of i.Answer){const l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(o!=null&&!l.includes(o)||a.push(De(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=V_()),this.dns)}}const J6=new IL,kL={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:J6}},transportManager:{faultTolerance:bd.FATAL_ALL}};async function TL(r){const e=Q6(kL,r);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new re("Private network is enforced, but no protector was provided");return e}const su=1e3,iu=su*60,ou=iu*60,fc=ou*24,CL=fc*7,PL=fc*365.25;function sx(r,e){try{if(typeof r=="string"&&r.length>0)return DL(r);if(typeof r=="number"&&isFinite(r))return e?.long?OL(r):RL(r);throw new Error("Value is not a string or number.")}catch(t){const n=NL(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function DL(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;const t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*PL;case"weeks":case"week":case"w":return t*CL;case"days":case"day":case"d":return t*fc;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ou;case"minutes":case"minute":case"mins":case"min":case"m":return t*iu;case"seconds":case"second":case"secs":case"sec":case"s":return t*su;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}function RL(r){const e=Math.abs(r);return e>=fc?`${Math.round(r/fc)}d`:e>=ou?`${Math.round(r/ou)}h`:e>=iu?`${Math.round(r/iu)}m`:e>=su?`${Math.round(r/su)}s`:`${r}ms`}function OL(r){const e=Math.abs(r);return e>=fc?a1(r,e,fc,"day"):e>=ou?a1(r,e,ou,"hour"):e>=iu?a1(r,e,iu,"minute"):e>=su?a1(r,e,su,"second"):`${r} ms`}function a1(r,e,t,n){const s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function NL(r){return typeof r=="object"&&r!==null&&"message"in r}function ML(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=sx,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let h=0;for(let d=0;d<u.length;d++)h=(h<<5)-h+u.charCodeAt(d),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(u){let h,d=null,g,y;function w(...m){if(!w.enabled)return;const _=w,k=Number(new Date),N=k-(h||k);_.diff=N,_.prev=h,_.curr=k,h=k,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let I=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(x,D)=>{if(x==="%%")return"%";I++;const F=t.formatters[D];if(typeof F=="function"){const R=m[I];x=F.call(_,R),m.splice(I,1),I--}return x}),t.formatArgs.call(_,m),(_.log||t.log).apply(_,m)}return w.namespace=u,w.useColors=t.useColors(),w.color=t.selectColor(u),w.extend=n,w.destroy=t.destroy,Object.defineProperty(w,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(g!==t.namespaces&&(g=t.namespaces,y=t.enabled(u)),y),set:m=>{d=m}}),typeof t.init=="function"&&t.init(w),w}function n(u,h){const d=t(this.namespace+(typeof h>"u"?":":h)+u);return d.log=this.log,d}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let h;const d=(typeof u=="string"?u:"").split(/[\s,]+/),g=d.length;for(h=0;h<g;h++)d[h]&&(u=d[h].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function i(){const u=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let h,d;for(h=0,d=t.skips.length;h<d;h++)if(t.skips[h].test(u))return!1;for(h=0,d=t.names.length;h<d;h++)if(t.names[h].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var BL={};const Np=qL(),LL=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function $L(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function UL(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+sx(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const FL=console.debug??console.log??(()=>{});function VL(r){try{r?Np?.setItem("debug",r):Np?.removeItem("debug")}catch{}}function KL(){let r;try{r=Np?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=BL.DEBUG),r}function qL(){try{return localStorage}catch{}}function HL(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Cn=ML({formatArgs:UL,save:VL,load:KL,useColors:$L,setupFormatters:HL,colors:LL,storage:Np,log:FL});Cn.formatters.b=r=>r==null?"undefined":Xt.baseEncode(r);Cn.formatters.t=r=>r==null?"undefined":Tn.baseEncode(r);Cn.formatters.m=r=>r==null?"undefined":ss.baseEncode(r);Cn.formatters.p=r=>r==null?"undefined":r.toString();Cn.formatters.c=r=>r==null?"undefined":r.toString();Cn.formatters.k=r=>r==null?"undefined":r.toString();Cn.formatters.a=r=>r==null?"undefined":r.toString();Cn.formatters.e=r=>r==null?"undefined":n7(r.stack)??n7(r.message)??r.toString();function zL(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Eg(){return{forComponent(r){return Hu(r)}}}function Hu(r){let e=zL(`${r}:trace`);return Cn.enabled(`${r}:trace`)&&Cn.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Cn(`${r}:trace`)),Object.assign(Cn(r),{error:Cn(`${r}:error`),trace:e})}function n7(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function Xh(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function ay(r){const e=ur(Xt.decode(`z${r}`));return Bn(e)}class $c{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Xh(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Xh(this.map.values(),e=>e.key)}values(){return Xh(this.map.values(),e=>e.value)}get size(){return this.map.size}}class ei{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Xh(this.set.entries(),e=>{const t=ay(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=ay(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Xh(this.set.values(),e=>ay(e))}intersection(e){const t=new ei;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ei;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ei;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function WL(){return new ei}function ix(r,e,t,n){hf(r);const s=LO({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:a}=s;if(Ja(i),Ja(o),Ja(a),i<1)throw new Error("iterations (c) should be >= 1");const c=D8(e),l=D8(t),u=new Uint8Array(o),h=gf.create(r,c),d=h._cloneInto().update(l);return{c:i,dkLen:o,asyncTick:a,DK:u,PRF:h,PRFSalt:d}}function ox(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),ai(s),t}function jL(r,e,t,n){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:c}=ix(r,e,t,n);let l;const u=new Uint8Array(4),h=Yh(u),d=new Uint8Array(a.outputLen);for(let g=1,y=0;y<i;g++,y+=a.outputLen){const w=o.subarray(y,y+a.outputLen);h.setInt32(0,g,!1),(l=c._cloneInto(l)).update(u).digestInto(d),w.set(d.subarray(0,w.length));for(let m=1;m<s;m++){a._cloneInto(l).update(d).digestInto(d);for(let _=0;_<w.length;_++)w[_]^=d[_]}}return ox(a,c,o,l,d)}async function ax(r,e,t,n){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=ix(r,e,t,n);let u;const h=new Uint8Array(4),d=Yh(h),g=new Uint8Array(c.outputLen);for(let y=1,w=0;w<i;y++,w+=c.outputLen){const m=a.subarray(w,w+c.outputLen);d.setInt32(0,y,!1),(u=l._cloneInto(u)).update(h).digestInto(g),m.set(g.subarray(0,m.length)),await BO(s-1,o,()=>{c._cloneInto(u).update(g).digestInto(g);for(let _=0;_<m.length;_++)m[_]^=g[_]})}return ox(c,l,a,u,g)}const bh=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),vo=new Uint32Array(80);class GL extends R6{constructor(){super(64,20,8,!1),this.A=bh[0]|0,this.B=bh[1]|0,this.C=bh[2]|0,this.D=bh[3]|0,this.E=bh[4]|0}get(){const{A:e,B:t,C:n,D:s,E:i}=this;return[e,t,n,s,i]}set(e,t,n,s,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)vo[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)vo[c]=Z2(vo[c-3]^vo[c-8]^vo[c-14]^vo[c-16],1);let{A:n,B:s,C:i,D:o,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=VS(s,i,o),u=1518500249):c<40?(l=s^i^o,u=1859775393):c<60?(l=KS(s,i,o),u=2400959708):(l=s^i^o,u=3395469782);const h=Z2(n,5)+l+a+u+vo[c]|0;a=o,o=i,i=Z2(s,30),s=n,n=h}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(n,s,i,o,a)}roundClean(){ai(vo)}destroy(){this.set(0,0,0,0,0),ai(this.buffer)}}const QL=D6(()=>new GL),YL=QL,ew=zS,s7={sha1:YL,"sha2-256":rc,"sha2-512":ew};function i7(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(s7).join(" / ");throw new re(`Hash '${s}' is unknown or not supported. Must be ${a}`)}const i=s7[s],o=jL(i,r,e,{c:t,dkLen:n});return ss.encode(o).substring(1)}const tw={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},cx={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},lx=new globalThis.TextEncoder;function XL(r,e){const t=tw[e];let n=cx[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function ZL(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=tw[e];let s=cx[e],i=r;for(;i.length>0;){const o=lx.encodeInto(i,t);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(t[a]),s=BigInt.asUintN(e,s*n)}return s}function JL(r,{size:e=32,utf8Buffer:t}={}){if(!tw[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return ZL(r,e,t);r=lx.encode(r)}return XL(r,e)}const rw={hash:r=>Number(JL(r,{size:32})),hashV:(r,e)=>e$(rw.hash(r,e))};function e$(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),ie(e,"base16")}const ux=64;class Va{fp;h;seed;constructor(e,t,n,s=2){if(s>ux)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=ze(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?We(this.fp,e.fp):!1}}function Mp(r,e){return Math.floor(Math.random()*(e-r))+r}class c1{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Va))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Va))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Va))throw new TypeError("Invalid Fingerprint");const t=Mp(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Va))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const t$=500;class o7{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??rw,this.seed=e.seed??Mp(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=ie(e));const t=new Va(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new c1(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new c1(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[Mp(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new c1(this.bucketSize));for(let a=0;a<t$;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new c1(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=ie(e));const t=new Va(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=ie(e));const t=new Va(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const r$={1:.5,2:.84,4:.95,8:.98};function n$(r=.001){return r>.002?2:r>1e-5?4:8}function s$(r,e=.001){const t=n$(e),n=r$[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),ux);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class i${filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??rw,this.seed=e.seed??Mp(0,Math.pow(2,10)),this.filterSeries=[new o7({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=ie(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new o7({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=ie(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=ie(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function Zo(r,e=.001,t){return new i$({...s$(r,e)})}class o${filter;constructor(e,t){this.filter=Zo(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function a$(r,e=.001){return new o$(r,e)}class c$ extends $c{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Sg(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new c$({name:e,metrics:t}):n=new $c,n}var Bp;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:ze(0),payloadType:ze(0),payload:ze(0),signature:ze(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Bp||(Bp={}));class l$ extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class ti{static createFromProtobuf=e=>{const t=Bp.decode(e),n=Qr(t.publicKey);return new ti({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),a=a7(s,i,o),c=await t.sign(a.subarray(),n);return new ti({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=ti.createFromProtobuf(e);if(!await s.validate(t,n))throw new l$("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=Bp.encode({publicKey:Rn(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:We(this.marshal(),e.marshal())}async validate(e,t){const n=a7(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const a7=(r,e,t)=>{const n=ie(r),s=is(n.byteLength),i=is(e.length),o=is(t.length);return new Ve(s,n,i,e,o,t)};function u$(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}const h$="libp2p-peer-record",d$=Uint8Array.from([3,1]);var Lp;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:ze(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.multiaddr=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:ze(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new ft('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Lp||(Lp={}));class Dn{static createFromProtobuf=e=>{const t=Lp.decode(e),n=Bn(ur(t.peerId)),s=(t.addresses??[]).map(o=>De(o.multiaddr)),i=t.seq;return new Dn({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=h$;static CODEC=d$;peerId;multiaddrs;seqNumber;domain=Dn.DOMAIN;codec=Dn.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Lp.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Dn)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!u$(this.multiaddrs,e.multiaddrs))}}function f$(r){return r[Symbol.asyncIterator]!=null}function $p(r){if(f$(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}let au=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function Qe(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class c7{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class cy{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new c7(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new c7(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let p$=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ls(r={}){return g$(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function g$(r,e){e=e??{};let t=e.onEnd,n=new cy,s,i,o,a=Qe();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((m,_)=>{i=k=>{i=null,n.push(k);try{m(r(n))}catch(N){_(N)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Qe()})}},l=m=>i!=null?i(m):(n.push(m),s),u=m=>(n=new cy,i!=null?i({error:m}):(n.push({error:m}),s)),h=m=>{if(o)return s;if(e?.objectMode!==!0&&m?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:m})},d=m=>o?s:(o=!0,m!=null?u(m):l({done:!0})),g=()=>(n=new cy,d(),{done:!0}),y=m=>(d(m),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:g,throw:y,push:h,end:d,get readableLength(){return n.size},onEmpty:async m=>{const _=m?.signal;if(_?.throwIfAborted(),n.isEmpty())return;let k,N;_!=null&&(k=new Promise((I,T)=>{N=()=>{T(new p$)},_.addEventListener("abort",N)}));try{await Promise.race([a.promise,k])}finally{N!=null&&_!=null&&_?.removeEventListener("abort",N)}}},t==null)return s;const w=s;return s={[Symbol.asyncIterator](){return this},next(){return w.next()},throw(m){return w.throw(m),t!=null&&(t(m),t=void 0),{done:!0}},return(){return w.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(m){return w.end(m),t!=null&&(t(m),t=void 0),s},get readableLength(){return w.readableLength},onEmpty:m=>w.onEmpty(m)},s}async function zr(r,e,t,n){const s=new au(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((o,a)=>{function c(){uy(t,"abort",h),uy(r,e,l),uy(r,i,u)}const l=d=>{try{if(n?.filter?.(d)===!1)return}catch(g){c(),a(g);return}c(),o(d)},u=d=>{if(c(),d instanceof Error){a(d);return}a(d.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},h=()=>{c(),a(s)};ly(t,"abort",h),ly(r,e,l),ly(r,i,u)})}function ly(r,e,t){r!=null&&(hx(r)?r.addListener(e,t):r.addEventListener(e,t))}function uy(r,e,t){r!=null&&(hx(r)?r.removeListener(e,t):r.removeEventListener(e,t))}function hx(r){return typeof r.on=="function"&&typeof r.emit=="function"}let y$=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},l7=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function Et(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new l7(t?.errorMessage,t?.errorCode,t?.errorName));let n;const s=new l7(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((i,o)=>{n=()=>{o(s)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}let m$=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new au)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function w$(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let b$=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=w$(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new au),this.cleanup())}async join(e={}){const t=new m$(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Et(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function u7(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}let h7=class extends $t{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=u7(this.emitEmpty.bind(this),1),this.emitIdle=u7(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new y$;const n=new b$(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new au)}),this.clear()}async onEmpty(e){this.size!==0&&await zr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await zr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await zr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ls({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new au("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}};const dx="lock:worker:request-read",fx="lock:worker:abort-read-request",px="lock:worker:release-read",gx="lock:master:grant-read",yx="lock:master:error-read",mx="lock:worker:request-write",wx="lock:worker:abort-write-request",bx="lock:worker:release-write",vx="lock:master:grant-write",Ex="lock:master:error-write",Sx="lock:worker:finalize",_x="mortice",v$={singleProcess:!1},d7=(r,e,t,n,s,i,o,a,c)=>l=>{if(l.data==null)return;const u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===s&&r.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(h=>{const d=g=>{if(g?.data==null)return;const y={type:g.data.type,name:g.data.name,identifier:g.data.identifier};y.type===a&&y.identifier===u.identifier&&(e.removeEventListener("message",d),h())};e.addEventListener("message",d)})},onError:h=>{e.postMessage({type:o,name:u.name,identifier:u.identifier,error:{message:h.message,name:h.name,stack:h.stack}})}}}),u.type===i&&r.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===Sx&&r.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})},E$=(r=10)=>Math.random().toString().substring(2,r+2);class S${name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(_x)}readLock(e){return this.sendRequest(dx,fx,gx,yx,px,e)}writeLock(e){return this.sendRequest(mx,wx,vx,Ex,bx,e)}finalize(){this.channel.postMessage({type:Sx,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const a=E$();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{const u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};o?.signal?.addEventListener("abort",u,{once:!0});const h=d=>{if(d.data?.identifier===a&&(d.data?.type===n&&(this.channel.removeEventListener("message",h),o?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),d.data.type===s)){this.channel.removeEventListener("message",h),o?.signal?.removeEventListener("abort",u);const g=new Error;d.data.error!=null&&(g.message=d.data.error.message,g.name=d.data.error.name,g.stack=d.data.error.stack),l(g)}};this.channel.addEventListener("message",h)})}}const _$=r=>{if(r=Object.assign({},v$,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(_x),n=new $t;return t.addEventListener("message",d7(n,t,"requestReadLock","abortReadLockRequest",dx,fx,yx,px,gx)),t.addEventListener("message",d7(n,t,"requestWriteLock","abortWriteLockRequest",mx,wx,Ex,bx,vx)),n}return new S$(r.name)},Ka=new Map;let vh;function xx(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function x$(r){if(vh==null&&(vh=_$(r),!xx(vh))){const e=vh;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=Ka.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=Ka.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=Ka.get(n);s?.finalize()})}return vh}async function hy(r,e){let t,n;const s=new Promise((o,a)=>{t=o,n=a}),i=()=>{n(new au)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const A$=(r,e)=>{let t=Ka.get(r);if(t!=null)return t;const n=x$(e);if(xx(n))return t=n,Ka.set(r,t),t;const s=new h7({concurrency:1});let i;return t={async readLock(o){if(i!=null)return hy(i,o);i=new h7({concurrency:e.concurrency,autoStart:!1});const a=i,c=hy(i,o);return s.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(o){return i=null,hy(s,o)},finalize:()=>{Ka.delete(r)},queue:s},Ka.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},I$={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Ax(r){const e=Object.assign({},I$,r);return A$(e.name,e)}const k$=36e5,T$=216e5;var qa;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:ze(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Fp.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=Fp.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),Up.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new ft('Decode error - map field "addresses" had too many elements');i.addresses.push(Up.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new ft('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new z8('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new z8('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(qa||(qa={}));var Up;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:ze(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Up||(Up={}));var Fp;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Fp||(Fp={}));function C$(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=Qr(e.publicKey,t);return uc(n)}function P$(r,e,t){const n=qa.decode(e);return Kh(r,n,t)}function Kh(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:C$(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:De(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function D$(r,e){return R$(r.addresses,e.addresses)&&O$(r.protocols,e.protocols)&&N$(r.publicKey,e.publicKey)&&M$(r.peerRecordEnvelope,e.peerRecordEnvelope)&&B$(r.metadata,e.metadata)&&L$(r.tags,e.tags)}function R$(r,e){return kx(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!We(t.multiaddr,n.multiaddr)))}function O$(r,e){return kx(r,e,(t,n)=>t===n)}function N$(r,e){return Ix(r,e)}function M$(r,e){return Ix(r,e)}function B$(r,e){return Tx(r,e,(t,n)=>We(t,n))}function L$(r,e){return Tx(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function Ix(r,e){return r==null&&e==null?!0:r!=null&&e!=null?We(r,e):!1}function kx(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function Tx(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const Ii="/",Cx=new TextEncoder().encode(Ii),l1=Cx[0];class wt{_buf;constructor(e,t){if(typeof e=="string")this._buf=ie(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==l1)throw new Error("Invalid key")}toString(e="utf8"){return se(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new wt(e.join(Ii))}static random(){return new wt(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new wt(e):typeof e.uint8Array=="function"?new wt(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=Cx),this._buf[0]!==l1){const e=new Uint8Array(this._buf.byteLength+1);e.fill(l1,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===l1;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return wt.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Ii).slice(1)}type(){return $$(this.baseNamespace())}name(){return U$(this.baseNamespace())}instance(e){return new wt(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Ii)||(e+=Ii),e+=this.type(),new wt(e)}parent(){const e=this.list();return e.length===1?new wt(Ii):new wt(e.slice(0,-1).join(Ii))}child(e){return this.toString()===Ii?e:e.toString()===Ii?this:new wt(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return wt.withNamespaces([...this.namespaces(),...F$(e.map(t=>t.namespaces()))])}}function $$(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function U$(r){const e=r.split(":");return e[e.length-1]}function F$(r){return[].concat(...r)}const Px="/peers/";function u1(r){if(!Xa(r)||r.type==null)throw new re("Invalid PeerId");const e=r.toCID().toString();return new wt(`${Px}${e}`)}async function V$(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=De(o.multiaddr)),!vg(o.multiaddr))throw new re("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),l=i.get(c);l!=null?o.isCertified=l.isCertified||a:i.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...i.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(De(`/p2p/${r}`))),{isCertified:o,multiaddr:a.bytes}})}async function dy(r,e,t,n){if(e==null)throw new re("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new re("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new re("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,l=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=h1(d,{validate:f7})}if(e.tags!=null){const d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=h1(d,{validate:p7,map:g7})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[g,y]of d)y==null?a.delete(g):a.set(g,y);a=h1([...a.entries()],{validate:f7})}if(e.tags!=null){const d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),g=new Map(c);for(const[y,w]of d)w==null?g.delete(y):g.set(y,w);c=h1([...g.entries()],{validate:p7,map:g7})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;s?.id.publicKey!=null?u=Rn(s.id.publicKey):e.publicKey!=null?u=Rn(e.publicKey):r.publicKey!=null&&(u=Rn(r.publicKey));const h={addresses:await V$(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((d,g)=>d.localeCompare(g)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return h.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(g=>We(g.multiaddr,g.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete h.publicKey,h}function h1(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function f7(r,e){if(typeof r!="string")throw new re("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new re("Metadata value must be a Uint8Array")}function p7(r,e){if(typeof r!="string")throw new re("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new re("Tag value must be an integer");if(e.value<0||e.value>100)throw new re("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new re("Tag ttl must be an integer");if(e.ttl<0)throw new re("Tag ttl must be between greater than 0")}}function g7(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function Dx(r){const e=r.toString().split("/")[2],t=$e.parse(e,Tn);return Fu(t)}function fy(r,e,t){const n=Dx(r);return P$(n,e,t)}function K$(r,e){return{prefix:Px,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(fy(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(fy(n.key,n.value,e),fy(s.key,s.value,e)))}}class q${peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=Sg({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??k$,this.maxPeerAge=t.maxPeerAge??T$}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:Ax({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(u1(e),t)}async load(e,t){const n=u1(e),s=await this.datastore.get(n,t),i=qa.decode(s);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Zt;return Kh(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await dy(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await dy(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await dy(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(K$(e??{},this.maxAddressAge),e)){const s=Dx(t);if(s.equals(this.peerId))continue;const i=qa.decode(n);if(this.#r(s,i)){await this.datastore.delete(t,e);continue}yield Kh(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=u1(e),s=await this.datastore.get(n,t),i=qa.decode(s);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Zt;return{peerPB:i,peer:Kh(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,s){t.updated=Date.now();const i=qa.encode(t);return await this.datastore.put(u1(e),i,s),{peer:Kh(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!D$(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class H${store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new q$(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return $p(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=Xa(t)?t:Xa(t?.expectedPeer)?t.expectedPeer:void 0,i=Xa(t)||t===void 0?n:t,o=await ti.openAndCertify(e,Dn.DOMAIN,i),a=Fu(o.publicKey.toCID());if(s?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,a),!1;const c=Dn.createFromProtobuf(o.payload);let l;try{l=await this.get(a,i)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){const u=ti.createFromProtobuf(l.peerRecordEnvelope),h=Dn.createFromProtobuf(u.payload);if(h.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",h.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function z$(r,e={}){return new H$(r,e)}class kd extends Error{static name="OpenFailedError";static code="ERR_OPEN_FAILED";name=kd.name;code=kd.code;constructor(e="Open failed"){super(e)}}class Td extends Error{static name="PutFailedError";static code="ERR_PUT_FAILED";name=Td.name;code=Td.code;constructor(e="Put failed"){super(e)}}class Cd extends Error{static name="GetFailedError";static code="ERR_GET_FAILED";name=Cd.name;code=Cd.code;constructor(e="Get failed"){super(e)}}class Pd extends Error{static name="DeleteFailedError";static code="ERR_DELETE_FAILED";name=Pd.name;code=Pd.code;constructor(e="Delete failed"){super(e)}}class Jo extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=Jo.name;code=Jo.code;constructor(e="Not Found"){super(e)}}function W$(r){return r[Symbol.asyncIterator]!=null}function ji(r){if(W$(r))return(async()=>{for await(const e of r);})();for(const e of r);}function nw(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function j$(r){return r[Symbol.asyncIterator]!=null}function xs(r,e){let t=0;if(j$(r))return async function*(){for await(const c of r)await e(c,t++)&&(yield c)}();const n=nw(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield s);for(const c of n)a(c,t++)&&(yield c)}()}function G$(r){return r[Symbol.asyncIterator]!=null}function Vp(r,e){return G$(r)?async function*(){yield*(await $p(r)).sort(e)}():function*(){yield*$p(r).sort(e)}()}function Q$(r){return r[Symbol.asyncIterator]!=null}function cu(r,e){return Q$(r)?async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}}()}class Rx{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await ji(this.putMany(e,n)),e=[],await ji(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=xs(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xs(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Vp(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=xs(n,()=>s++>=i)}return e.limit!=null&&(n=cu(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=xs(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xs(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Vp(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=xs(n,()=>i++>=s)}return e.limit!=null&&(n=cu(n,e.limit)),n}}class Ox extends Rx{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new Jo;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new wt(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new wt(n),t?.signal?.throwIfAborted()}}function Dd(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var Nx;(function(){var r,e,t,n,s,i,o,a;a=function(c){var l,u,h,d;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,h=(c&65280)>>>8,d=c&255,[l,u,h,d].join(".")},o=function(c){var l,u,h,d,g,y;for(l=[],h=d=0;d<=3&&c.length!==0;h=++d){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}y=e(c),g=y[0],u=y[1],c=c.substring(u),l.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var l,u,h,d,g;for(d=0,l=10,u="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,l=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,l=8,u="7")),g=h;h<c.length;){if("0"<=c[h]&&c[h]<=u)d=d*l+(t(c[h])-n)>>>0;else if(l===16)if("a"<=c[h]&&c[h]<="f")d=d*l+(10+t(c[h])-i)>>>0;else if("A"<=c[h]&&c[h]<="F")d=d*l+(10+t(c[h])-s)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");h++}if(h===g)throw new Error("empty octet");return[d,h]},r=function(){function c(l,u){var h,d,g;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(g=l.split("/",2),l=g[0],u=g[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,h,d;for(d=o(this.first),h=o(this.last),u=0;d<=h;)l(a(d),d,u),u++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),Nx=r}).call(Rp);const Y$=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],X$=Y$.map(r=>new Nx(r));function sw(r){for(const e of X$)if(e.contains(r))return!0;return!1}function Z$(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function J$(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return sw(s)}function eU(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function tU(r){const e=r.split(":"),t=e[e.length-1];return sw(t)}function rU(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function ha(r){if(hc(r))return sw(r);if(Z$(r))return J$(r);if(eU(r))return tU(r);if(Y6(r))return rU(r)}const xt=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),Ie=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),it=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),Yr=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),ht=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function St(...r){function e(s){if(s==null)return!1;let i=s.getComponents();for(const o of r){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const nU=Ie(pt),sU=St(nU),_g=Ie(wf),xg=Ie(Ku),Ag=Ie(bf),iw=Ie(mf);St(_g,it(Ie(pt)));St(xg,it(Ie(pt)));St(Ag,it(Ie(pt)));const iU=St(Yr(iw,Ag,_g,xg),it(Ie(pt))),Mx=ht(Ie(dc),it(Ie(X6))),Bx=ht(it(Ie(Bc)),Ie(os),it(Ie(X6))),ow=Yr(Mx,Bx),pc=Yr(ow,iw,_g,xg,Ag),oU=St(Yr(ow,ht(Yr(iw,Ag,_g,xg),it(Ie(pt))))),y7=St(Mx),m7=St(Bx),aU=St(ow),aw=ht(pc,Ie(Li)),vf=ht(pc,Ie(Op)),Kp=St(ht(aw,it(Ie(pt))));St(vf);const cw=ht(vf,xt(j_),it(Ie(pt))),Ig=ht(vf,xt(G_),it(Ie(pt))),cU=Yr(cw,Ig);St(cw);const lU=St(Ig),zm=Yr(pc,aw,vf,cw,Ig),Lx=Yr(ht(zm,xt(Z6),it(Ie(pt)))),Rd=St(Lx),$x=Yr(ht(zm,xt(Y_),it(Ie(pt))),ht(zm,xt(Ul),it(Ie(W_)),xt(Z6),it(Ie(pt)))),qp=St($x),Ux=ht(vf,xt(X_),it(Ie(xd)),it(Ie(xd)),it(Ie(pt))),Wm=St(Ux),Fx=ht(Ig,xt(Q_),it(Ie(xd)),it(Ie(xd)),it(Ie(pt))),w7=St(Fx),Hp=Yr(Lx,$x,ht(aw,it(Ie(pt))),ht(cU,it(Ie(pt))),ht(pc,it(Ie(pt))),Ux,Fx,Ie(pt)),Vx=St(Hp),uU=ht(Hp,xt(Lc),Ie(pt)),ea=St(uU),hU=Yr(ht(Hp,xt(Lc),xt(Q1),it(Ie(pt))),ht(Hp,xt(Q1),it(Ie(pt))),ht(xt(Q1),it(Ie(pt)))),jm=St(hU),dU=Yr(ht(pc,Ie(Li),xt(Fl),it(Ie(pt))),ht(pc,xt(Fl),it(Ie(pt))));St(dU);const fU=ht(pc,Yr(ht(Ie(Li,"443"),xt(Fl)),ht(Ie(Li),xt(Hm)),ht(Ie(Li),xt(Ul),xt(Fl)),ht(xt(Ul),xt(Fl)),xt(Ul),xt(Hm)),it(Ie(pt)));St(fU);const pU=Yr(ht(Ie(Z_),it(Ie(pt))));St(pU);const gU=Yr(ht(Ie(z_),it(Ie(pt))));St(gU);class yU extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Os(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new yU({name:e,metrics:t}):n=new Map,n}const b7=864e13,mU=448,py=449,wU=53,bU=54,vU=55,EU=56;class SU{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=Os({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=ha(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?b7-Date.now():0,lastVerified:s?b7-Date.now():void 0})})}remove(e){const t=this.findHost(e);let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:De(`/${i.map(u=>[qu(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===mU&&e[n+1]?.[0]!==py)return e.splice(n+1,0,[py,t]),!0;return!1}confirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+t);return s}findHost(e){for(const t of e.stringTuples())if(t[0]===py||t[0]===wU||t[0]===bU||t[0]===vU||t[0]===EU)return t[1]}}const gy=4,yy=41,my=6,_U=273;class xU{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=Os({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:hc(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),n=t[0][1]??"",s=t[1][0]===my?"tcp":"udp",i=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===n&&u.externalPort===i&&u.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,n,i,s),o=o||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:n}of e){const s=n.stringTuples();let i;if((s[0][0]===gy||s[0][0]===yy)&&s[1][0]===my?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===gy||s[0][0]===yy)&&s[1][0]===_U&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?gy:yy,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,t.push({multiaddr:De(`/${s.map(c=>[qu(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){const n=e.stringTuples(),s=n[0][1]??"",i=n[1][0]===my?"tcp":"udp",o=parseInt(n[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===s&&u.externalPort===o&&u.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,s,o,i),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}}function AU(r){try{for(const{code:e,value:t}of r.getComponents())if(e!==Bc&&t!=null){if(e===dc)return t.startsWith("169.254.");if(e===os)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function Kx(r){try{for(const{code:e}of r.getComponents())if(e!==Bc)return e===dc||e===os}catch{}return!1}function gc(r){try{if(!Kx(r))return!1;const[[,e]]=r.stringTuples();return e==null?!1:ha(e)??!1}catch{}return!0}const IU={maxObservedAddresses:10};class kU{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Os({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??IU.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(gc(e)||AU(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:De(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const TU=[dc,os,mf,wf,Ku,bf];function v7(r){try{for(const{code:e}of r.getComponents())if(e!==Bc)return TU.includes(e)}catch{}return!1}const CU={maxObservedAddresses:10};class PU{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Os({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??CU.maxObservedAddresses}get(e,t){if(gc(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!v7(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(v7(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const E7=6e4,S7={addressVerificationTTL:E7*10,addressVerificationRetry:E7*5},DU=r=>r;function wy(r,e){const t=r.getPeerId();return t!=null&&nr(t).equals(e)&&(r=r.decapsulate(De(`/p2p/${e.toString()}`))),r}class RU{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new kU(e,t),this.dnsMappings=new SU(e,t),this.ipMappings=new xU(e,t),this.transportAddresses=new PU(e,t),this.announceFilter=t.announceFilter??DU,this.observedAddressFilter=Zo(1024),this.addressVerificationTTL=t.addressVerificationTTL??S7.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??S7.addressVerificationRetry,this._updatePeerStoreAddresses=Dd(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>De(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>De(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>De(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=wy(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=wy(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=wy(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=De(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(De(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${hc(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(De(`/ip${hc(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||ha(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>Rd.exactMatch(i)||qp.exactMatch(i),i=>Kp.exactMatch(i),i=>lU.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&i(u)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var _7;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(_7||(_7={}));class OU extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class NU extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class by extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class x7 extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class MU extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class BU extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class LU extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class A7 extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class $U extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class UU extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class FU extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class VU extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class KU extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class d1 extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class f1 extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class qU extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class HU extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class zU{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Eg())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>T6(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const WU=["metrics","connectionProtector","dns"],jU=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function GU(r={}){const e=new zU(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!jU.includes(s)){const o=e.components[s];if(o==null&&!WU.includes(s))throw new OU(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function QU(r){const e={};for(const t of Object.values(r.components))for(const n of YU(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of XU(t))if(e[n]!==!0)throw new NU(`Service "${ZU(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function YU(r){return Array.isArray(r?.[lr])?r[lr]:[]}function XU(r){return Array.isArray(r?.[jo])?r[jo]:[]}function ZU(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}const JU=4,eF=41;function tF(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Rd.matches(e))return!1;const t=e.stringTuples();return t[0][0]===JU||t[0][0]===eF?!!ha(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}const I7=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},rF=new WeakMap;function nF({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(I7());let i,o,a;const c=r??clearTimeout,l=()=>{c(i),a(I7())},u=()=>{s&&s.removeEventListener("abort",l)},h=new Promise((d,g)=>{o=()=>{u(),d(n)},a=g,i=(e??setTimeout)(o,t)});return s&&s.addEventListener("abort",l,{once:!0}),rF.set(h,()=>{c(i),i=null,o()}),h}}const qx=nF();class sF extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}class iF extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class Hx{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new oF}async consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new sF("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await qx(a)}return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}let oF=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};function zx(r){if(Xa(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getPeerId();t=n==null?void 0:nr(n),e.forEach(s=>{if(!vg(s))throw new A6("Invalid multiaddr");const i=s.getPeerId();if(i==null){if(t!=null)throw new re("Multiaddrs must all have the same peer id or have no peer id")}else{const o=nr(i);if(t?.equals(o)!==!0)throw new re("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!sU.exactMatch(n)),{peerId:t,multiaddrs:e}}const aF=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function cF(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??aF;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function Gm(r){try{let e;typeof r=="string"?e=De(r):e=r;const t=new Set([...e.getComponents().map(n=>n.name)]);if(!t.has("ipcidr")){const s=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(s)}return _L(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}class lF{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Gm(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new $c;for(const c of e){const l=c.remotePeer;if(!s.has(l)){s.set(l,0);try{const u=await this.peerStore.get(l);s.set(l,[...u.tags.values()].reduce((h,d)=>h+d.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),a=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>u.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await cF(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const Wx=1e4,uF=1e4,k7=1e4,jx=25,hF=5,dF=10,fF=5,pF="last-dial-failure",gF="last-dial-success",Gx=500,yF=32,mF=100,Qx=50;class wF{deferred;signal;constructor(e){this.signal=e,this.deferred=Qe(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new qi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function bF(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class vF{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=bF(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new qi),this.cleanup())}async join(e={}){const t=new wF(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Et(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}class ta extends $t{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Dd(this.emitEmpty.bind(this),1),this.emitIdle=Dd(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new iF;const n=new vF(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:s}),this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new qi)}),this.clear()}async onEmpty(e){this.size!==0&&await zr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await zr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await zr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ls({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail)},o=()=>{n()},a=()=>{n(new qi("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("error",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}}class EF extends ta{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}function ut(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}function SF(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function T7(r){if(!Kx(r))return!1;const{address:e}=r.nodeAddress();return SF(e)}function _F(r,e){const t=Kp.exactMatch(r.multiaddr),n=Kp.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=qp.exactMatch(r.multiaddr),i=qp.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=Rd.exactMatch(r.multiaddr),a=Rd.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=jm.exactMatch(r.multiaddr),l=jm.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const u=Wm.exactMatch(r.multiaddr),h=Wm.exactMatch(e.multiaddr);if(u&&!h)return-1;if(!u&&h)return 1;const d=w7.exactMatch(r.multiaddr),g=w7.exactMatch(e.multiaddr);return d&&!g?-1:!d&&g?1:0}function xF(r,e){const t=T7(r.multiaddr),n=T7(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function AF(r,e){const t=gc(r.multiaddr),n=gc(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function IF(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function kF(r,e){const t=ea.exactMatch(r.multiaddr),n=ea.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function TF(r){return r.sort(_F).sort(IF).sort(kF).sort(AF).sort(xF)}async function Yx(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??yF))throw new HU("Max recursive depth reached");let s=!1;const i=[];for(const o of Object.values(e))if(o.canResolve(r)){s=!0;const a=await o.resolve(r,t);for(const c of a)i.push(...await Yx(c,e,{...t,depth:n+1}))}return s===!1&&i.push(r),i}const Eh={maxParallelDials:Qx,maxDialQueueLength:Gx,maxPeerAddrsToDial:jx,dialTimeout:Wx,resolvers:{dnsaddr:J6}};class CF{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Eh.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Eh.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Eh.dialTimeout,this.connections=t.connections??new $c,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Eh.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new EF({concurrency:t.maxParallelDials??Eh.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==qi.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=zx(e),i=Array.from(this.connections.values()).flat().find(a=>t.force===!0||a.limits!=null?!1:a.remotePeer.equals(n)?!0:s.find(c=>c.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new xe("dial-queue:already-connected")),i;const o=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;const c=a.options.multiaddrs;if(c==null)return!1;for(const l of s)if(c.has(l.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(const a of s)o.options.multiaddrs.add(a.toString());return t.onProgress?.(new xe("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Qh("Dial queue is full");return this.log("creating dial target for %p",n,s.map(a=>a.toString())),t.onProgress?.(new xe("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new xe("dial-queue:start-dial"));const c=ut([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??Zx,multiaddrs:new Set(s.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const u=[],h=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...h]);const d=await this.calculateMultiaddrs(n,h,{...e,signal:t});for(const g of d){if(i.has(g.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",g.multiaddr,n);continue}u.push(g)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(g=>g.multiaddr.toString())),e?.onProgress?.(new xe("dial-queue:calculated-addresses",u));for(const g of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new Qh("Peer had more than maxPeerAddrsToDial");a++;try{const y=await this.components.transportManager.dial(g.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",g.multiaddr);try{await this.components.peerStore.merge(y.remotePeer,{multiaddrs:[y.remoteAddr],metadata:{[gF]:ie(Date.now().toString())}})}catch(w){this.log.error("could not update last dial failure key for %p",n,w)}return y}catch(y){if(this.log.error("dial failed to %a",g.multiaddr,y),i.add(g.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[pF]:ie(Date.now().toString())}})}catch(w){this.log.error("could not update last dial failure key for %p",n,w)}if(t.aborted)throw new of(y.message);l.push(y)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(h=>({multiaddr:De(h),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Qh("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new A7("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const h=await this.components.peerStore.get(e);s.push(...h.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:d})=>d.toString()))}catch(h){if(h.name!=="NotFoundError")throw h}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const h=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:d})=>d.toString())),s.push(...h.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(h){h.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,h)}}}let i=(await Promise.all(s.map(async h=>{const d=await Yx(h.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return d.length===1&&d[0].equals(h.multiaddr)?h:d.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(e!=null){const h=`/p2p/${e.toString()}`;i=i.map(d=>d.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:d.multiaddr.encapsulate(h),isCertified:d.isCertified}:d)}const o=i.filter(h=>{if(this.components.transportManager.dialTransportForMultiaddr(h.multiaddr)==null)return!1;const d=h.multiaddr.getPeerId();return e!=null&&d!=null?e.equals(d):!0}),a=new Map;for(const h of o){const d=h.multiaddr.toString(),g=a.get(d);if(g!=null){g.isCertified=g.isCertified||h.isCertified||!1;continue}a.set(d,h)}const c=[...a.values()];if(c.length===0)throw new FU("The dial request has no valid addresses");const l=[];for(const h of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(h.multiaddr)||l.push(h);const u=this.addressSorter==null?TF(l):l.sort(this.addressSorter);if(u.length===0)throw new A7("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:h})=>h.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:h})=>h.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!ea.matches(s.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}}class ra extends ta{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}var Xx={};function us(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var PF=us;us.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};us.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};us.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};us.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};us.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};us.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};us.prototype.start=us.prototype.try;us.prototype.errors=function(){return this._errors};us.prototype.attempts=function(){return this._attempts};us.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var s=this._errors[n],i=s.message,o=(r[i]||0)+1;r[i]=o,o>=t&&(e=s,t=o)}return e};(function(r){var e=PF;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)n[s]=t[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<n.retries;o++)i.push(this.createTimeout(o,n));return t&&t.forever&&!i.length&&i.push(this.createTimeout(o,n)),i.sort(function(a,c){return a-c}),i},r.createTimeout=function(t,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return i=Math.min(i,n.maxTimeout),i},r.wrap=function(t,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],c=t[a];t[a]=function(u){var h=r.operation(n),d=Array.prototype.slice.call(arguments,1),g=d.pop();d.push(function(y){h.retry(y)||(y&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){u.apply(t,d)})}.bind(t,c),t[a].options=n}}})(Xx);var DF=Xx;const RF=Mc(DF),OF=Object.prototype.toString,NF=r=>OF.call(r)==="[object Error]",MF=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function BF(r){return r&&NF(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:MF.has(r.message):!1}class LF extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const C7=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function $F(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;const s=RF.operation(e),i=()=>{s.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});const o=()=>{e.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const c=await r(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof LF)throw c.originalError;if(c instanceof TypeError&&!BF(c))throw c;if(C7(c,a,e),await e.shouldRetry(c)||(s.stop(),n(c)),await e.onFailedAttempt(c),!s.retry(c))throw s.mainError()}catch(l){C7(l,a,e),o(),n(l)}}})})}class UF{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new ra({concurrency:t.maxParallelReconnects??fF,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);P7(t)&&(this.queue.has(e)||this.queue.add(async n=>{await $F(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(lg)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>P7(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function P7(r){for(const e of r.tags.keys())if(e.startsWith(lg))return!0;return!1}const Zx=50,vy={maxConnections:mF,inboundConnectionThreshold:hF,maxIncomingPendingConnections:dF};class FF{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??vy.maxConnections,this.maxConnections<1)throw new re("Connection Manager maxConnections must be greater than 0");this.connections=new $c,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Gm(n)),this.deny=(t.deny??[]).map(n=>Gm(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??vy.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new Hx({points:t.inboundConnectionThreshold??vy.inboundConnectionThreshold,duration:1}),this.connectionPruner=new lF({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>De(n))}),this.dialQueue=new CF(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??Qx,maxDialQueueLength:t.maxDialQueueLength??Gx,maxPeerAddrsToDial:t.maxPeerAddrsToDial??jx,dialTimeout:t.dialTimeout??Wx,resolvers:t.resolvers??{dnsaddr:J6},connections:this.connections}),this.reconnectQueue=new UF({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Hi(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await la(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new re("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Jl("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n}=zx(e);if(this.peerId.equals(n))throw new pS("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),t.onProgress?.(new xe("dial-queue:already-connected")),a}const s=await this.dialQueue.dial(e,{...t,priority:t.priority??Zx});if(s.status!=="open")throw new dS("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const a of i)if(a.id===s.id&&(o=!0),t.force!==!0&&a.id!==s.id&&a.remoteAddr.equals(s.remoteAddr))return s.abort(new A6("Duplicate multiaddr connection")),a;return o||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>De(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class Ey{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const VF=1.2,KF=2,qF=5e3,HF=6e4,zF=5e3;class Od{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??zF;this.success=new Ey(t),this.failure=new Ey(t),this.next=new Ey(t),this.failureMultiplier=e.failureMultiplier??KF,this.timeoutMultiplier=e.timeoutMultiplier??VF,this.minTimeout=e.minTimeout??qF,this.maxTimeout=e.maxTimeout??HF,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=ut([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class WF{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=Qe(),this.haveNext=Qe()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Qe(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Qe(),await Et(this.readNext.promise,t?.signal,t)}}function Jx(){return new WF}let jF=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function zp(r,e){const t=Jx();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const s=new Ve;return{read:async o=>{if(o?.signal?.throwIfAborted(),o?.bytes==null){const{done:c,value:l}=await Et(n.next(),o?.signal);return c===!0?null:l}for(;s.byteLength<o.bytes;){const{value:c,done:l}=await Et(n.next(),o?.signal);if(l===!0)throw new jF("unexpected end of input");s.append(c)}const a=s.sublist(0,o.bytes);return s.consume(o.bytes),a},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=r.source;r.source=async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*o}()}return r}}}const GF=1e4,QF="1.0.0",YF="ping",XF="ipfs",D7=32,ZF=!0;class JF{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??XF}/${YF}/${QF}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??GF,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??ZF,this.timeout=new Od({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[lr]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=zp(s);t=Date.now(),await Promise.all([i.write(Yo(D7),{signal:n}),i.read({bytes:D7,signal:n})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}function eV(r){return r[Symbol.asyncIterator]!=null}async function tV(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*rV(r){const e=new AbortController,t=Jx();tV(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*nV(r){for(const e of r)yield*e}function $o(...r){const e=[];for(const t of r)eV(t)||e.push(t);return e.length===r.length?nV(e):rV(r)}class sV{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:se(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:se(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new by("No content routers available");const n=this,s=new ei;for await(const i of $o(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new by("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new by("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Jl;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Jl;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}const p1=globalThis.CustomEvent??Event;async function*kg(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=Qe(),a=Qe(),c=!1,l,u=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const y of r){if(i.length===t&&(o=Qe(),await o.promise),u)break;const w={done:!1};i.push(w),y().then(m=>{w.done=!0,w.ok=!0,w.value=m,s.dispatchEvent(new p1("task-complete"))},m=>{w.done=!0,w.err=m,s.dispatchEvent(new p1("task-complete"))})}c=!0,s.dispatchEvent(new p1("task-complete"))}catch(y){l=y,s.dispatchEvent(new p1("task-complete"))}});function h(){return n?i[0]?.done:!!i.find(y=>y.done)}function*d(){for(;i.length>0&&i[0].done;){const y=i[0];if(i.shift(),y.ok)yield y.value;else throw u=!0,o.resolve(),y.err;o.resolve()}}function*g(){for(;h();)for(let y=0;y<i.length;y++)if(i[y].done){const w=i[y];if(i.splice(y,1),y--,w.ok)yield w.value;else throw u=!0,o.resolve(),w.err;o.resolve()}}for(;;){if(h()||(a=Qe(),await a.promise),l!=null||(n?yield*d():yield*g(),l!=null))throw l;if(c&&i.length===0)break}}class iV{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:se(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new x7("No peer routers available");if(e.toString()===this.peerId.toString())throw new MU("Should not try to find self");const n=this,s=$o(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new Zt}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new x7("No peer routers available");const n=this,s=Zo(1024);for await(const i of kg(async function*(){const o=$o(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class oV extends $t{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=ut([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=Qe(),yield(await zr(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=ut([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=Yo(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Et(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const eA=32,tA=64;class aV{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=Os({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new BU(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new LU(`Handler already registered for protocol ${e}`);const s=Q6.bind({ignoreUndefined:!0})({maxInboundStreams:eA,maxOutboundStreams:tA},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new re("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,n).then(s=>{for(const i of s.protocols){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(s=>{s.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,s)})}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));for(const i of s){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;for(const i of t){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),a.onConnect?.(s,n))}}}class cV{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=Os({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=Os({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??bd.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new re("Transport must have a valid tag");if(this.transports.has(t))throw new re(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new qU(`No transport available for address ${String(e)}`);return t?.onProgress?.(new xe("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Jl("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new $U)});const n=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",i,c);const l=o.createListener({upgrader:this.components.upgrader});let u=this.listeners.get(i)??[];u==null&&(u=[],this.listeners.set(i,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const h=u.findIndex(d=>d===l);u.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),y7.matches(c)?t.ipv4.attempts++:m7.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),y7.matches(c)&&t.ipv4.success++,m7.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,h),t.errors.set(c.toString(),h),h}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===bd.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new UU(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const on="/multistream/1.0.0",lw=1024;let lV=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},uV=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},hV=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function lu(r,e={}){const t=zp(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=At(e.maxDataLength));const n=e?.lengthDecoder??Nc,s=e?.lengthEncoder??is;return{read:async o=>{let a=-1;const c=new Ve;for(;;){c.append(await t.read({...o,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new lV("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new hV("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new uV("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Ve(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Ve(...o.flatMap(l=>[s(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}const dV=ie(`
`);async function qh(r,e,t){await r.write(e,t)}async function fV(r,e,t){await r.writeV(e,t)}async function pV(r,e){const t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==dV[0])throw e.log.error("Invalid mss message - missing newline",t),new It("Missing newline");return t.sublist(0,-1)}async function Vl(r,e){const t=await pV(r,e);return se(t.subarray())}async function Sy(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return gV(r,e[0],t);const n=lu(r,{...t,maxDataLength:lw}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',on,s);const i=ie(`${on}
`),o=ie(`${s}
`);await fV(n,[i,o],t),t.log.trace("select: reading multistream-select header");let a=await Vl(n,t);if(t.log.trace('select: read "%s"',a),a===on&&(t.log.trace("select: reading protocol response"),a=await Vl(n,t),t.log.trace('select: read "%s"',a)),a===s)return{stream:n.unwrap(),protocol:s};for(const c of e){t.log.trace('select: write "%s"',c),await qh(n,ie(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await Vl(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new hg("protocol selection failed")}function gV(r,e,t){const n=r.sink.bind(r),s=r.source;let i=!1,o=!1;const a=Qe();let c=!1,l=!1;const u=Qe();let h=!1,d=!1;const g=Qe(),y=lu({sink:n,source:s},{...t,maxDataLength:lw});r.sink=async k=>{const{sink:N}=y.unwrap();await N(async function*(){let I=!1;for await(const T of k){if(l&&await u.promise,c)yield T;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',on,e,T.byteLength);const x=`${e}
`;yield new Ve(Uint8Array.from([19]),ie(`${on}
`),is(x.length),ie(x),T).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',on,e,T.byteLength),c=!0,l=!1,u.resolve(),w().catch(D=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,D)})}I=!0}I||await w()}())};async function w(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await m()),h||(t.log.trace("optimistic: doing read protocol for %s stream",e),await _())}finally{o=!1,i=!0,a.resolve()}}async function m(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',on,e),await y.writeV([ie(`${on}
`),ie(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',on,e)}finally{c=!0,l=!1,u.resolve()}}async function _(){if(d){await g.promise;return}d=!0;try{t.log.trace("optimistic: reading multistream select header");let k=await Vl(y,t);if(t.log.trace('optimistic: read multistream select header "%s"',k),k===on&&(k=await Vl(y,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',k,e),k!==e)throw new hg("protocol selection failed")}finally{h=!0,d=!1,g.resolve()}}if(r.source=async function*(){await w(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*y.unwrap().source}(),r.closeRead!=null){const k=r.closeRead.bind(r);r.closeRead=async N=>{i||await w().catch(I=>{t.log.error("could not negotiate protocol before close read",I)}),await k(N)}}if(r.closeWrite!=null){const k=r.closeWrite.bind(r);r.closeWrite=async N=>{i||await w().catch(I=>{t.log.error("could not negotiate protocol before close write",I)}),await k(N)}}if(r.close!=null){const k=r.close.bind(r);r.close=async N=>{const I=[];l&&I.push(u.promise),d&&I.push(g.promise),I.length>0?await Et(Promise.all(I),N?.signal):(i=!0,o=!1,a.resolve()),await k(N)}}return{stream:r,protocol:e}}const yV=8,uw=1024*1024*4;let mV=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},rA=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},wV=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},R7=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function nA(r){return r[Symbol.asyncIterator]!=null}function sA(r,e){if(r.byteLength>e)throw new rA("Message length too long")}const Tg=r=>{const e=At(r),t=dn(e);return is(r,t),Tg.bytes=e,t};Tg.bytes=0;function Nd(r,e){e=e??{};const t=e.lengthEncoder??Tg,n=e?.maxDataLength??uw;function*s(i){sA(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return nA(r)?async function*(){for await(const i of r)yield*s(i)}():function*(){for(const i of r)yield*s(i)}()}Nd.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Tg,n=e?.maxDataLength??uw;return sA(r,n),new Ve(t(r.byteLength),r)};var Ra;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Ra||(Ra={}));const hw=r=>{const e=Nc(r);return hw.bytes=At(e),e};hw.bytes=0;function Md(r,e){const t=new Ve;let n=Ra.LENGTH,s=-1;const i=e?.lengthDecoder??hw,o=e?.maxLengthLength??yV,a=e?.maxDataLength??uw;function*c(){for(;t.byteLength>0;){if(n===Ra.LENGTH)try{if(s=i(t),s<0)throw new mV("Invalid message length");if(s>a)throw new rA("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=Ra.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new wV("Message length length too long");break}throw l}if(n===Ra.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=Ra.LENGTH}}}return nA(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new R7("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new R7("Unexpected end of input")}()}Md.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return Md(n,{...e??{},onLength:i=>{t=i}})};async function _y(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const n=lu(r,{...t,maxDataLength:lw,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const s=await Vl(n,t);if(t.log.trace('handle: read "%s"',s),s===on){t.log.trace('handle: respond with "%s" for "%s"',on,s),await qh(n,ie(`${on}
`),t),t.log.trace('handle: responded with "%s" for "%s"',on,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await qh(n,ie(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:n.unwrap(),protocol:s};if(s==="ls"){const i=new Ve(...e.map(o=>Nd.single(ie(`${o}
`))),ie(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await qh(n,i,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log.trace('handle: respond with "na" for "%s"',s),await qh(n,ie(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}const bV=500;class vV{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:i,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[ND]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new LD("the connection is being closed");if(this.status==="closed")throw new dS("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new gS("Cannot open protocol stream on limited connection");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(bV);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function EV(r){return new vV(r)}function SV(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return eA}function _V(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??tA}function O7(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class xV{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=Os({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=Os({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??uF,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??k7,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??k7,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new VU(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return ut([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await Et(this.components.connectionManager.acceptIncomingConnection(e),s),!n)throw new KU("Connection denied");await Et(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getPeerId();let s;n!=null&&(s=nr(n),await Et(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s,i,o,a,c;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if(n?.skipProtection!==!0){const u=this.components.connectionProtector;u!=null&&(e.log("protecting the %s connection",t),l=await u.protect(e,n))}try{if(s=l,n?.skipEncryption!==!0){n?.onProgress?.(new xe(`upgrader:encrypt-${t}-connection`)),{conn:s,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));const u={...l,...s};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,u)}else{const u=e.remoteAddr.getPeerId();if(u==null)throw new A6(`${t} connection that skipped encryption must have a peer id`);const h=nr(u);c="native",i=h}if(i.equals(this.components.peerId)){const u=new pS("Can not dial self");throw e.abort(u),u}if(o=s,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new xe(`upgrader:multiplex-${t}-connection`));const u=await(t==="inbound"?this._multiplexInbound({...l,...s},this.streamMuxers,n):this._multiplexOutbound({...l,...s},this.streamMuxers,n));a=u.muxerFactory,o=u.stream}}catch(u){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,u),u}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:n?.limits})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,limits:c}=e;let l,u,h;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:y=>{if(h==null)return;const w=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const m=this.components.registrar.getProtocols(),{stream:_,protocol:k}=await _y(y,m,{signal:w,log:y.log,yieldBytes:!1});if(h==null)return;h.log("incoming stream opened on %s",k);const N=SV(k,this.components.registrar);if(O7(k,"inbound",h)===N){const T=new VD(`Too many inbound protocol streams for protocol "${k}" - limit ${N}`);throw y.abort(T),T}y.source=_.source,y.sink=_.sink,y.protocol=k,_.closeWrite!=null&&(y.closeWrite=_.closeWrite),_.closeRead!=null&&(y.closeRead=_.closeRead),_.close!=null&&(y.close=_.close),await this.components.peerStore.merge(o,{protocols:[k]},{signal:w}),this.components.metrics?.trackProtocolStream(y,h),this._onStream({connection:h,stream:y,protocol:k})}).catch(async m=>{h.log.error("error handling incoming stream id %s - %e",y.id,m),y.timeline.close==null&&await y.close({signal:w}).catch(_=>y.abort(_))})}}),u=async(y,w={})=>{if(l==null)throw new d1("Connection is not multiplexed");h.log.trace("starting new stream for protocols %s",y);const m=await l.newStream();h.log.trace("started new stream %s for protocols %s",m.id,y);try{if(w.signal==null){m.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",y);const T=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);w={...w,signal:T}}m.log.trace("selecting protocol from protocols %s",y);const{stream:_,protocol:k}=await Sy(m,y,{...w,log:m.log,yieldBytes:!0});m.log.trace("selected protocol %s",k);const N=_V(k,this.components.registrar,w),I=O7(k,"outbound",h);if(I>=N){const T=new k6(`Too many outbound protocol streams for protocol "${k}" - ${I}/${N}`);throw m.abort(T),T}return await this.components.peerStore.merge(o,{protocols:[k]}),m.source=_.source,m.sink=_.sink,m.protocol=k,_.closeWrite!=null&&(m.closeWrite=_.closeWrite),_.closeRead!=null&&(m.closeRead=_.closeRead),_.close!=null&&(m.close=_.close),this.components.metrics?.trackProtocolStream(m,h),m}catch(_){throw h.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,y,_),m.timeline.close==null&&m.abort(_),_}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(y=>{h.log.error("error piping data through muxer - %e",y)}));const d=s.timeline;s.timeline=new Proxy(d,{set:(...y)=>(y[1]==="close"&&y[2]!=null&&d.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(w){h.log.error("error closing connection after timeline close %e",w)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(w=>{h.log.error("error thrown while dispatching connection:close event %e",w)}),Reflect.set(...y))}),s.timeline.upgraded=Date.now();const g=()=>{throw new d1("Connection is not multiplexed")};return h=EV({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:s.timeline,multiplexer:l?.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:u??g,getStreams:()=>l?.streams??[],close:async y=>{await l?.close(y),await s.close(y)},abort:y=>{s.abort(y),l?.abort(y)}}),this.events.safeDispatchEvent("connection:open",{detail:h}),h.__maConnTimeline=d,h}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:i,options:o}=this.components.registrar.getHandler(s);if(t.limits!=null&&o.runOnLimitedConnection!==!0)throw new gS("Cannot open protocol stream on limited connection");i({connection:t,stream:n})}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await _y(e,n,{...t,log:e.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new f1(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await o.secureInbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,s),new f1(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const{stream:s,protocol:i}=await Sy(e,n,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new f1(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await o.secureOutbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,s),new f1(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await Sy(e,s,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new d1(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await _y(e,s,{...n,log:e.log}),a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new d1(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const iA="2.9.0",oA="js-libp2p";function aA(r,e){return`${r??oA}/${e??iA} browser/${globalThis.navigator.userAgent}`}class AV extends $t{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new $t,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{const u=n(l),h=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||h},this.peerId=e.peerId,this.logger=e.logger??Eg(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??oA,i=e.nodeInfo?.version??iA,o=this.components=GU({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??aA(s,i)},logger:this.logger,events:t,datastore:e.datastore??new Ox,connectionGater:tF(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",z$(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){const u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(h=>h.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new xV(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new cV(this.components,e.transportManager)),this.configureComponent("connectionManager",new FF(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new JF(this.components,e.connectionMonitor)),this.configureComponent("registrar",new aV(this.components)),this.configureComponent("addressManager",new RU(this.components,e.addresses));const a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new iV(this.components,{routers:a}));const c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new sV(this.components,{routers:c})),this.configureComponent("randomWalk",new oV(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",d=>{this.#e(d)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(const l of Object.keys(e.services)){const u=e.services[l],h=u(this.components);if(h==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=h,this.configureComponent(l,h),h[Xl]!=null&&(this.log("registering service %s for content routing",l),c.push(h[Xl])),h[Zl]!=null&&(this.log("registering service %s for peer routing",l),a.push(h[Zl])),h[wd]!=null&&(this.log("registering service %s for peer discovery",l),h[wd].addEventListener?.("peer",d=>{this.#e(d)}))}QU(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new ei;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new re("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new re("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){vg(e)&&(e=nr(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=jr([ie("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=Qr(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}}async function cA(r={}){r.privateKey??=await mg("Ed25519");const e=new AV({...await TL(r),peerId:nB(r.privateKey)});return r.start!==!1&&await e.start(),e}const IV=["string","number","bigint","symbol"],kV=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function TV(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";const e=typeof r;if(IV.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(CV(r))return"Buffer";const t=PV(r);return t||"Object"}function CV(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function PV(r){const e=Object.prototype.toString.call(r).slice(8,-1);if(kV.includes(e))return e}class V{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}V.uint=new V(0,"uint",!0);V.negint=new V(1,"negint",!0);V.bytes=new V(2,"bytes",!0);V.string=new V(3,"string",!0);V.array=new V(4,"array",!1);V.map=new V(5,"map",!1);V.tag=new V(6,"tag",!1);V.float=new V(7,"float",!0);V.false=new V(7,"false",!0);V.true=new V(7,"true",!0);V.null=new V(7,"null",!0);V.undefined=new V(7,"undefined",!0);V.break=new V(7,"break",!0);class oe{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const zu=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",DV=new TextDecoder,RV=new TextEncoder;function Wp(r){return zu&&globalThis.Buffer.isBuffer(r)}function dw(r){return r instanceof Uint8Array?Wp(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}const OV=zu?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):M7(r,e,t):(r,e,t)=>t-e>64?DV.decode(r.subarray(e,t)):M7(r,e,t),lA=zu?r=>r.length>64?globalThis.Buffer.from(r):N7(r):r=>r.length>64?RV.encode(r):N7(r),vi=r=>Uint8Array.from(r),fw=zu?(r,e,t)=>Wp(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),NV=zu?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),dw(globalThis.Buffer.concat(r,e))):(r,e)=>{const t=new Uint8Array(e);let n=0;for(let s of r)n+s.length>t.length&&(s=s.subarray(0,t.length-n)),t.set(s,n),n+=s.length;return t},MV=zu?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function BV(r,e){if(Wp(r)&&Wp(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function N7(r){const e=[];let t=0;for(let n=0;n<r.length;n++){let s=r.charCodeAt(n);s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(s=65536+((s&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128)}return e}function M7(r,e,t){const n=[];for(;e<t;){const s=r[e];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(e+o<=t){let a,c,l,u;switch(o){case 1:s<128&&(i=s);break;case 2:a=r[e+1],(a&192)===128&&(u=(s&31)<<6|a&63,u>127&&(i=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(s&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(i=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(s&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(i=u))}}i===null?(i=65533,o=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=o}return uA(n)}const B7=4096;function uA(r){const e=r.length;if(e<=B7)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=B7));return t}const LV=256;class hA{constructor(e=LV){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const s=t.length-(this.maxCursor-this.cursor)-1;t.set(e,s)}else{if(t){const s=t.length-(this.maxCursor-this.cursor)-1;s<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,s),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=MV(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=fw(n,0,this.cursor)}else t=NV(this.chunks,this.cursor);return e&&this.reset(),t}}const _e="CBOR decode error:",nc="CBOR encode error:";function Wu(r,e,t){if(r.length-e<t)throw new Error(`${_e} not enough data for type`)}const vr=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Uc(r,e,t){Wu(r,e,1);const n=r[e];if(t.strict===!0&&n<vr[0])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);return n}function Fc(r,e,t){Wu(r,e,2);const n=r[e]<<8|r[e+1];if(t.strict===!0&&n<vr[1])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);return n}function Vc(r,e,t){Wu(r,e,4);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<vr[2])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);return n}function Kc(r,e,t){Wu(r,e,8);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],s=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(s);if(t.strict===!0&&i<vr[3])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${_e} integers outside of the safe integer range are not supported`)}function $V(r,e,t,n){return new oe(V.uint,Uc(r,e+1,n),2)}function UV(r,e,t,n){return new oe(V.uint,Fc(r,e+1,n),3)}function FV(r,e,t,n){return new oe(V.uint,Vc(r,e+1,n),5)}function VV(r,e,t,n){return new oe(V.uint,Kc(r,e+1,n),9)}function qc(r,e){return ds(r,0,e.value)}function ds(r,e,t){if(t<vr[0]){const n=Number(t);r.push([e|n])}else if(t<vr[1]){const n=Number(t);r.push([e|24,n])}else if(t<vr[2]){const n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<vr[3]){const n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{const n=BigInt(t);if(n<vr[4]){const s=[e|27,0,0,0,0,0,0,0];let i=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));s[8]=i&255,i=i>>8,s[7]=i&255,i=i>>8,s[6]=i&255,i=i>>8,s[5]=i&255,s[4]=o&255,o=o>>8,s[3]=o&255,o=o>>8,s[2]=o&255,o=o>>8,s[1]=o&255,r.push(s)}else throw new Error(`${_e} encountered BigInt larger than allowable range`)}}qc.encodedSize=function(e){return ds.encodedSize(e.value)};ds.encodedSize=function(e){return e<vr[0]?1:e<vr[1]?2:e<vr[2]?3:e<vr[3]?5:9};qc.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function KV(r,e,t,n){return new oe(V.negint,-1-Uc(r,e+1,n),2)}function qV(r,e,t,n){return new oe(V.negint,-1-Fc(r,e+1,n),3)}function HV(r,e,t,n){return new oe(V.negint,-1-Vc(r,e+1,n),5)}const pw=BigInt(-1),dA=BigInt(1);function zV(r,e,t,n){const s=Kc(r,e+1,n);if(typeof s!="bigint"){const i=-1-s;if(i>=Number.MIN_SAFE_INTEGER)return new oe(V.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${_e} integers outside of the safe integer range are not supported`);return new oe(V.negint,pw-BigInt(s),9)}function gw(r,e){const t=e.value,n=typeof t=="bigint"?t*pw-dA:t*-1-1;ds(r,e.type.majorEncoded,n)}gw.encodedSize=function(e){const t=e.value,n=typeof t=="bigint"?t*pw-dA:t*-1-1;return n<vr[0]?1:n<vr[1]?2:n<vr[2]?3:n<vr[3]?5:9};gw.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function Ef(r,e,t,n){Wu(r,e,t+n);const s=fw(r,e+t,e+t+n);return new oe(V.bytes,s,t+n)}function WV(r,e,t,n){return Ef(r,e,1,t)}function jV(r,e,t,n){return Ef(r,e,2,Uc(r,e+1,n))}function GV(r,e,t,n){return Ef(r,e,3,Fc(r,e+1,n))}function QV(r,e,t,n){return Ef(r,e,5,Vc(r,e+1,n))}function YV(r,e,t,n){const s=Kc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${_e} 64-bit integer bytes lengths not supported`);return Ef(r,e,9,s)}function jp(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===V.string?lA(r.value):r.value),r.encodedBytes}function Cg(r,e){const t=jp(e);ds(r,e.type.majorEncoded,t.length),r.push(t)}Cg.encodedSize=function(e){const t=jp(e);return ds.encodedSize(t.length)+t.length};Cg.compareTokens=function(e,t){return XV(jp(e),jp(t))};function XV(r,e){return r.length<e.length?-1:r.length>e.length?1:BV(r,e)}function Sf(r,e,t,n,s){const i=t+n;Wu(r,e,i);const o=new oe(V.string,OV(r,e+t,e+i),i);return s.retainStringBytes===!0&&(o.byteValue=fw(r,e+t,e+i)),o}function ZV(r,e,t,n){return Sf(r,e,1,t,n)}function JV(r,e,t,n){return Sf(r,e,2,Uc(r,e+1,n),n)}function eK(r,e,t,n){return Sf(r,e,3,Fc(r,e+1,n),n)}function tK(r,e,t,n){return Sf(r,e,5,Vc(r,e+1,n),n)}function rK(r,e,t,n){const s=Kc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${_e} 64-bit integer string lengths not supported`);return Sf(r,e,9,s,n)}const nK=Cg;function ju(r,e,t,n){return new oe(V.array,n,t)}function sK(r,e,t,n){return ju(r,e,1,t)}function iK(r,e,t,n){return ju(r,e,2,Uc(r,e+1,n))}function oK(r,e,t,n){return ju(r,e,3,Fc(r,e+1,n))}function aK(r,e,t,n){return ju(r,e,5,Vc(r,e+1,n))}function cK(r,e,t,n){const s=Kc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${_e} 64-bit integer array lengths not supported`);return ju(r,e,9,s)}function lK(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${_e} indefinite length items not allowed`);return ju(r,e,1,1/0)}function yw(r,e){ds(r,V.array.majorEncoded,e.value)}yw.compareTokens=qc.compareTokens;yw.encodedSize=function(e){return ds.encodedSize(e.value)};function Gu(r,e,t,n){return new oe(V.map,n,t)}function uK(r,e,t,n){return Gu(r,e,1,t)}function hK(r,e,t,n){return Gu(r,e,2,Uc(r,e+1,n))}function dK(r,e,t,n){return Gu(r,e,3,Fc(r,e+1,n))}function fK(r,e,t,n){return Gu(r,e,5,Vc(r,e+1,n))}function pK(r,e,t,n){const s=Kc(r,e+1,n);if(typeof s=="bigint")throw new Error(`${_e} 64-bit integer map lengths not supported`);return Gu(r,e,9,s)}function gK(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${_e} indefinite length items not allowed`);return Gu(r,e,1,1/0)}function mw(r,e){ds(r,V.map.majorEncoded,e.value)}mw.compareTokens=qc.compareTokens;mw.encodedSize=function(e){return ds.encodedSize(e.value)};function yK(r,e,t,n){return new oe(V.tag,t,1)}function mK(r,e,t,n){return new oe(V.tag,Uc(r,e+1,n),2)}function wK(r,e,t,n){return new oe(V.tag,Fc(r,e+1,n),3)}function bK(r,e,t,n){return new oe(V.tag,Vc(r,e+1,n),5)}function vK(r,e,t,n){return new oe(V.tag,Kc(r,e+1,n),9)}function ww(r,e){ds(r,V.tag.majorEncoded,e.value)}ww.compareTokens=qc.compareTokens;ww.encodedSize=function(e){return ds.encodedSize(e.value)};const EK=20,SK=21,_K=22,xK=23;function AK(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${_e} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new oe(V.null,null,1):new oe(V.undefined,void 0,1)}function IK(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${_e} indefinite length items not allowed`);return new oe(V.break,void 0,1)}function bw(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${_e} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${_e} Infinity values are not supported`)}return new oe(V.float,r,e)}function kK(r,e,t,n){return bw(Ew(r,e+1),3,n)}function TK(r,e,t,n){return bw(Sw(r,e+1),5,n)}function CK(r,e,t,n){return bw(yA(r,e+1),9,n)}function vw(r,e,t){const n=e.value;if(n===!1)r.push([V.float.majorEncoded|EK]);else if(n===!0)r.push([V.float.majorEncoded|SK]);else if(n===null)r.push([V.float.majorEncoded|_K]);else if(n===void 0)r.push([V.float.majorEncoded|xK]);else{let s,i=!1;(!t||t.float64!==!0)&&(pA(n),s=Ew(bs,1),n===s||Number.isNaN(n)?(bs[0]=249,r.push(bs.slice(0,3)),i=!0):(gA(n),s=Sw(bs,1),n===s&&(bs[0]=250,r.push(bs.slice(0,5)),i=!0))),i||(PK(n),s=yA(bs,1),bs[0]=251,r.push(bs.slice(0,9)))}}vw.encodedSize=function(e,t){const n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){pA(n);let s=Ew(bs,1);if(n===s||Number.isNaN(n))return 3;if(gA(n),s=Sw(bs,1),n===s)return 5}return 9};const fA=new ArrayBuffer(9),Gn=new DataView(fA,1),bs=new Uint8Array(fA,0);function pA(r){if(r===1/0)Gn.setUint16(0,31744,!1);else if(r===-1/0)Gn.setUint16(0,64512,!1);else if(Number.isNaN(r))Gn.setUint16(0,32256,!1);else{Gn.setFloat32(0,r);const e=Gn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Gn.setUint16(0,31744,!1);else if(t===0)Gn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{const s=t-127;s<-24?Gn.setUint16(0,0):s<-14?Gn.setUint16(0,(e&2147483648)>>16|1<<24+s,!1):Gn.setUint16(0,(e&2147483648)>>16|s+15<<10|n>>13,!1)}}}function Ew(r,e){if(r.length-e<2)throw new Error(`${_e} not enough data for float16`);const t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const n=t>>10&31,s=t&1023;let i;return n===0?i=s*2**-24:n!==31?i=(s+1024)*2**(n-25):i=s===0?1/0:NaN,t&32768?-i:i}function gA(r){Gn.setFloat32(0,r,!1)}function Sw(r,e){if(r.length-e<4)throw new Error(`${_e} not enough data for float32`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function PK(r){Gn.setFloat64(0,r,!1)}function yA(r,e){if(r.length-e<8)throw new Error(`${_e} not enough data for float64`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}vw.compareTokens=qc.compareTokens;function ot(r,e,t){throw new Error(`${_e} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function Pg(r){return()=>{throw new Error(`${_e} ${r}`)}}const ue=[];for(let r=0;r<=23;r++)ue[r]=ot;ue[24]=$V;ue[25]=UV;ue[26]=FV;ue[27]=VV;ue[28]=ot;ue[29]=ot;ue[30]=ot;ue[31]=ot;for(let r=32;r<=55;r++)ue[r]=ot;ue[56]=KV;ue[57]=qV;ue[58]=HV;ue[59]=zV;ue[60]=ot;ue[61]=ot;ue[62]=ot;ue[63]=ot;for(let r=64;r<=87;r++)ue[r]=WV;ue[88]=jV;ue[89]=GV;ue[90]=QV;ue[91]=YV;ue[92]=ot;ue[93]=ot;ue[94]=ot;ue[95]=Pg("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ue[r]=ZV;ue[120]=JV;ue[121]=eK;ue[122]=tK;ue[123]=rK;ue[124]=ot;ue[125]=ot;ue[126]=ot;ue[127]=Pg("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ue[r]=sK;ue[152]=iK;ue[153]=oK;ue[154]=aK;ue[155]=cK;ue[156]=ot;ue[157]=ot;ue[158]=ot;ue[159]=lK;for(let r=160;r<=183;r++)ue[r]=uK;ue[184]=hK;ue[185]=dK;ue[186]=fK;ue[187]=pK;ue[188]=ot;ue[189]=ot;ue[190]=ot;ue[191]=gK;for(let r=192;r<=215;r++)ue[r]=yK;ue[216]=mK;ue[217]=wK;ue[218]=bK;ue[219]=vK;ue[220]=ot;ue[221]=ot;ue[222]=ot;ue[223]=ot;for(let r=224;r<=243;r++)ue[r]=Pg("simple values are not supported");ue[244]=ot;ue[245]=ot;ue[246]=ot;ue[247]=AK;ue[248]=Pg("simple values are not supported");ue[249]=kK;ue[250]=TK;ue[251]=CK;ue[252]=ot;ue[253]=ot;ue[254]=ot;ue[255]=IK;const ui=[];for(let r=0;r<24;r++)ui[r]=new oe(V.uint,r,1);for(let r=-1;r>=-24;r--)ui[31-r]=new oe(V.negint,r,1);ui[64]=new oe(V.bytes,new Uint8Array(0),1);ui[96]=new oe(V.string,"",1);ui[128]=new oe(V.array,0,1);ui[160]=new oe(V.map,0,1);ui[244]=new oe(V.false,!1,1);ui[245]=new oe(V.true,!0,1);ui[246]=new oe(V.null,null,1);function DK(r){switch(r.type){case V.false:return vi([244]);case V.true:return vi([245]);case V.null:return vi([246]);case V.bytes:return r.value.length?void 0:vi([64]);case V.string:return r.value===""?vi([96]):void 0;case V.array:return r.value===0?vi([128]):void 0;case V.map:return r.value===0?vi([160]):void 0;case V.uint:return r.value<24?vi([Number(r.value)]):void 0;case V.negint:if(r.value>=-24)return vi([31-Number(r.value)])}}const RK={float64:!1,mapSorter:MK,quickEncodeToken:DK};function OK(){const r=[];return r[V.uint.major]=qc,r[V.negint.major]=gw,r[V.bytes.major]=Cg,r[V.string.major]=nK,r[V.array.major]=yw,r[V.map.major]=mw,r[V.tag.major]=ww,r[V.float.major]=vw,r}const mA=OK(),xy=new hA;class Gp{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${nc} object contains circular references`);return new Gp(t,e)}}const Eo={null:new oe(V.null,null),undefined:new oe(V.undefined,void 0),true:new oe(V.true,!0),false:new oe(V.false,!1),emptyArray:new oe(V.array,0),emptyMap:new oe(V.map,0)},na={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new oe(V.float,r):r>=0?new oe(V.uint,r):new oe(V.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new oe(V.uint,r):new oe(V.negint,r)},Uint8Array(r,e,t,n){return new oe(V.bytes,r)},string(r,e,t,n){return new oe(V.string,r)},boolean(r,e,t,n){return r?Eo.true:Eo.false},null(r,e,t,n){return Eo.null},undefined(r,e,t,n){return Eo.undefined},ArrayBuffer(r,e,t,n){return new oe(V.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new oe(V.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[Eo.emptyArray,new oe(V.break)]:Eo.emptyArray;n=Gp.createCheck(n,r);const s=[];let i=0;for(const o of r)s[i++]=Y1(o,t,n);return t.addBreakTokens?[new oe(V.array,r.length),s,new oe(V.break)]:[new oe(V.array,r.length),s]},Object(r,e,t,n){const s=e!=="Object",i=s?r.keys():Object.keys(r),o=s?r.size:i.length;if(!o)return t.addBreakTokens===!0?[Eo.emptyMap,new oe(V.break)]:Eo.emptyMap;n=Gp.createCheck(n,r);const a=[];let c=0;for(const l of i)a[c++]=[Y1(l,t,n),Y1(s?r.get(l):r[l],t,n)];return NK(a,t),t.addBreakTokens?[new oe(V.map,o),a,new oe(V.break)]:[new oe(V.map,o),a]}};na.Map=na.Object;na.Buffer=na.Uint8Array;for(const r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))na[`${r}Array`]=na.DataView;function Y1(r,e={},t){const n=TV(r),s=e&&e.typeEncoders&&e.typeEncoders[n]||na[n];if(typeof s=="function"){const o=s(r,n,e,t);if(o!=null)return o}const i=na[n];if(!i)throw new Error(`${nc} unsupported type: ${n}`);return i(r,n,e,t)}function NK(r,e){e.mapSorter&&r.sort(e.mapSorter)}function MK(r,e){const t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);const s=t.type.major,i=mA[s].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function wA(r,e,t,n){if(Array.isArray(e))for(const s of e)wA(r,s,t,n);else t[e.type.major](r,e,n)}function bA(r,e,t){const n=Y1(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){const s=t.quickEncodeToken(n);if(s)return s;const i=e[n.type.major];if(i.encodedSize){const o=i.encodedSize(n,t),a=new hA(o);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return dw(a.chunks[0])}}return xy.reset(),wA(xy,n,e,t),xy.toBytes(!0)}function X1(r,e){return e=Object.assign({},RK,e),bA(r,mA,e)}const BK={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class LK{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=ui[e];if(t===void 0){const n=ue[e];if(!n)throw new Error(`${_e} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const s=e&31;t=n(this.data,this._pos,s,this.options)}return this._pos+=t.encodedLength,t}}const Bd=Symbol.for("DONE"),Dg=Symbol.for("BREAK");function $K(r,e,t){const n=[];for(let s=0;s<r.value;s++){const i=Ld(e,t);if(i===Dg){if(r.value===1/0)break;throw new Error(`${_e} got unexpected break to lengthed array`)}if(i===Bd)throw new Error(`${_e} found array but not enough entries (got ${s}, expected ${r.value})`);n[s]=i}return n}function UK(r,e,t){const n=t.useMaps===!0,s=n?void 0:{},i=n?new Map:void 0;for(let o=0;o<r.value;o++){const a=Ld(e,t);if(a===Dg){if(r.value===1/0)break;throw new Error(`${_e} got unexpected break to lengthed map`)}if(a===Bd)throw new Error(`${_e} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${_e} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in s))throw new Error(`${_e} found repeat map key "${a}"`);const c=Ld(e,t);if(c===Bd)throw new Error(`${_e} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?i.set(a,c):s[a]=c}return n?i:s}function Ld(r,e){if(r.done())return Bd;const t=r.next();if(t.type===V.break)return Dg;if(t.type.terminal)return t.value;if(t.type===V.array)return $K(t,r,e);if(t.type===V.map)return UK(t,r,e);if(t.type===V.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const n=Ld(r,e);return e.tags[t.value](n)}throw new Error(`${_e} tag not supported (${t.value})`)}throw new Error("unsupported")}function FK(r,e){if(!(r instanceof Uint8Array))throw new Error(`${_e} data to decode must be a Uint8Array`);e=Object.assign({},BK,e);const t=e.tokenizer||new LK(r,e),n=Ld(t,e);if(n===Bd)throw new Error(`${_e} did not find any content to decode`);if(n===Dg)throw new Error(`${_e} got unexpected break`);return[n,r.subarray(t.pos())]}function ko(r,e){const[t,n]=FK(r,e);if(n.length>0)throw new Error(`${_e} too many terminals, data makes no sense`);return t}function g1({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*VK(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=$e.asCID(n);i!=null?yield[s.join("/"),i]:typeof n=="object"&&(yield*Qm(n,s))}else{const t=$e.asCID(e);t!=null?yield[r.join("/"),t]:yield*Qm(e,r)}}function*Qm(r,e){if(r==null||r instanceof Uint8Array)return;const t=$e.asCID(r);t!=null&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*VK(i,s)}}function*KK(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&$e.asCID(n)==null&&(yield*Ym(n,s))}else yield*Ym(e,r)}function*Ym(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&$e.asCID(n)==null&&(yield*KK(s,n))}}function qK(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=$e.asCID(t);if(i!=null)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}let HK=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:g1(),bytes:g1(),value:g1(),asBlock:g1()})}links(){return Qm(this.value,[])}tree(){return Ym(this.value,[])}get(e="/"){return qK(this.value,e.split("/").filter(Boolean))}};function zK({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n?.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new HK({cid:e,bytes:r,value:s})}const vA="/pin/",L7="/pinned-block/",Xm=Za,$7=1;function y1(r){return r.version===0&&(r=r.toV1()),new wt(`${vA}${r.toString(Xm)}`)}class WK{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){const n=y1(e);if(await this.datastore.has(n))throw new Error("Already pinned");const s=Math.round(t.depth??1/0);if(s<0)throw new Error("Depth must be greater than or equal to 0");const i=new ta({concurrency:$7});for await(const a of this.#e(e,i,{...t,depth:s}))await this.#t(a,c=>c.pinnedBy.find(l=>We(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:s,metadata:t.metadata??{}};await this.datastore.put(n,X1(o),t)}async*#e(e,t,n){if(n.depth===-1)return;const s=await this.getCodec(e.code),i=await this.blockstore.get(e,n),o=zK({bytes:i,cid:e,codec:s});yield e;for(const[,a]of o.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){const s=new wt(`${L7}${Xm.encode(e.multihash.bytes)}`);let i={pinCount:0,pinnedBy:[]};try{i=ko(await this.datastore.get(s,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(i)){if(i.pinCount===0&&await this.datastore.has(s)){await this.datastore.delete(s);return}await this.datastore.put(s,X1(i),n),n.onProgress?.(new xe("helia:pin:add",e))}}async*rm(e,t={}){const n=y1(e),s=await this.datastore.get(n,t),i=ko(s);await this.datastore.delete(n,t);const o=new ta({concurrency:$7});for await(const a of this.#e(e,o,{...t,depth:i.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>We(l,e.bytes)),!0),{...t,depth:i.depth}),yield a}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:vA+(e.cid!=null?`${e.cid.toString(Za)}`:"")},e)){const s=$e.parse(t.toString().substring(5),Za),i=ko(n);yield{cid:s,...i}}}async isPinned(e,t={}){const n=new wt(`${L7}${Xm.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){const n=y1(e),s=await this.datastore.get(n,t);return ko(s)}async setMetadata(e,t,n){const s=y1(e),i=await this.datastore.get(s,n),o=ko(i);o.metadata=t??{},await this.datastore.put(s,X1(o),n)}}const jK=1,GK=5;class QK extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}class m1 extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}class YK extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}class XK extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}const ZK=5;class JK{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??ZK,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await Hi(...this.routers)}async stop(){await la(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new m1("No content routers available");const n=new ra({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(const s of $o(n.toGenerator(),...Ea(this.routers,"findProviders").map(i=>i.findProviders(e,t))))if(s!=null){if(s.multiaddrs.length===0){if(n.find(s.id)!=null)continue;n.add(async()=>{try{const i=await this.findPeer(s.id,t);return i.multiaddrs.length===0?null:i}catch(i){return this.log.error("could not load multiaddrs for peer %p",s.id,i),null}},{peerId:s.id,signal:t.signal}).catch(i=>{this.log.error("could not load multiaddrs for peer %p",s.id,i)})}yield s}}async provide(e,t={}){if(this.routers.length===0)throw new m1("No content routers available");await Promise.all(Ea(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Ea(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Ea(this.routers,"put").map(async s=>{await s.put(e,t,n)}))}async get(e,t){return Promise.any(Ea(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new m1("No peer routers available");const n=this,s=$o(...Ea(this.routers,"findPeer").map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const i of s)if(i!=null)return i;throw new Zt("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new m1("No peer routers available");for await(const n of $o(...Ea(this.routers,"getClosestPeers").map(s=>s.getClosestPeers(e,t))))n!=null&&(yield n)}}function Ea(r,e){return r.filter(t=>t[e]!=null)}class eq{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Ax({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Hi(this.child),this.started=!0}async stop(){await la(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();const s=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{s()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{const s=this;yield*this.child.deleteMany(async function*(){for await(const i of e){if(await s.pins.isPinned(i))throw new Error("CID was pinned");yield i}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}}const Ay=new wt("/version"),U7=1;async function tq(r){if(!await r.has(Ay)){await r.put(Ay,ie(`${U7}`));return}const e=await r.get(Ay),t=se(e);if(parseInt(t,10)!==U7)throw new Error("Unknown datastore version, a datastore migration may be required")}const EA=42;function SA(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function rq(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=$e.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new oe(V.tag,EA),new oe(V.bytes,t)]}function nq(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function sq(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const Zm={float64:!0,typeEncoders:{Object:rq,undefined:nq,number:sq}},iq={...Zm,typeEncoders:{...Zm.typeEncoders}};function oq(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return $e.decode(r.subarray(1))}const Qp={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Qp.tags[EA]=oq;const aq={...Qp,tags:Qp.tags.slice()},cq="dag-cbor",_A=113,lq=r=>X1(r,Zm),uq=r=>ko(SA(r),Qp),_f=Object.freeze(Object.defineProperty({__proto__:null,code:_A,decode:uq,decodeOptions:aq,encode:lq,encodeOptions:iq,name:cq,toByteView:SA},Symbol.toStringTag,{value:"Module"}));class hq extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===V.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===V.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[V.uint.major](e,t){this.prefix(e);const n=String(t.value),s=[];for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i);e.push(s)}[V.negint.major](e,t){this[V.uint.major](e,t)}[V.bytes.major](e,t){throw new Error(`${nc} unsupported type: Uint8Array`)}[V.string.major](e,t){this.prefix(e);const n=lA(JSON.stringify(t.value));e.push(n.length>32?dw(n):n)}[V.array.major](e,t){this.prefix(e),this.inRecursive.push({type:V.array,elements:0}),e.push([91])}[V.map.major](e,t){this.prefix(e),this.inRecursive.push({type:V.map,elements:0}),e.push([123])}[V.tag.major](e,t){}[V.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===V.array)e.push([93]);else if(o.type===V.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${nc} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),s=[];let i=!1;for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),e.push(s)}}function dq(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${nc} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==V.string||n.type!==V.string)throw new Error(`${nc} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${nc} unexpected duplicate map keys, this is not supported`)}const fq={addBreakTokens:!0,mapSorter:dq};function pq(r,e){return e=Object.assign({},fq,e),bA(r,new hq,e)}class xA{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${_e} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${_e} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const s=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new oe(V.uint,0,this._pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${_e} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${_e} unexpected token at position ${this._pos}`);n=!0,this._pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,s([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(i);return n?new oe(V.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new oe(o>=0?V.uint:V.negint,o,this._pos-e):new oe(o>=0?V.uint:V.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${_e} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,o=0;i<this.data.length&&o<65536;i++,o++){const a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new oe(V.string,c,o)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${_e} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${_e} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},s=()=>{const i=this.ch();let o=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${_e} unexpected unicode sequence at position ${this._pos}`);let c,l,u,h;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(h=(i&31)<<6|c&63,h>127&&(o=h));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(h=(i&15)<<12|(c&63)<<6|l&63,h>2047&&(h<55296||h>57343)&&(o=h));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(h=(i&15)<<18|(c&63)<<12|(l&63)<<6|u&63,h>65535&&h<1114112&&(o=h))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${_e} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${_e} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new oe(V.string,uA(t),this._pos-e);default:if(i<32)throw new Error(`${_e} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):s()}}throw new Error(`${_e} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new oe(V.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new oe(V.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new oe(V.null,null,4);case 102:return this.expect([102,97,108,115,101]),new oe(V.false,!1,5);case 116:return this.expect([116,114,117,101]),new oe(V.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${_e} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new oe(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${_e} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new oe(V.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new oe(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${_e} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new oe(V.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${_e} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${_e} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function gq(r,e){return e=Object.assign({tokenizer:new xA(r,e)},e),ko(r,e)}function yq(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function mq(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=$e.asCID(r);if(!e)return null;const t=e.toString();return[new oe(V.map,1/0,1),new oe(V.string,"/",1),new oe(V.string,t,t.length),new oe(V.break,void 0,1)]}function Yp(r){const e=ss.encode(r).slice(1);return[new oe(V.map,1/0,1),new oe(V.string,"/",1),new oe(V.map,1/0,1),new oe(V.string,"bytes",5),new oe(V.string,e,e.length),new oe(V.break,void 0,1),new oe(V.break,void 0,1)]}function ys(r){return Yp(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function wq(r){return Yp(new Uint8Array(r))}function bq(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function vq(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const Eq={typeEncoders:{Object:mq,Buffer:Yp,Uint8Array:Yp,Int8Array:ys,Uint16Array:ys,Int16Array:ys,Uint32Array:ys,Int32Array:ys,Float32Array:ys,Float64Array:ys,Uint8ClampedArray:ys,BigInt64Array:ys,BigUint64Array:ys,DataView:ys,ArrayBuffer:wq,undefined:bq,number:vq}};class Sq extends xA{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===V.map){const t=this._next();if(t.type===V.string&&t.value==="/"){const n=this._next();if(n.type===V.string){if(this._next().type!==V.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new oe(V.tag,42,0)}if(n.type===V.map){const s=this._next();if(s.type===V.string&&s.value==="bytes"){const i=this._next();if(i.type===V.string){for(let a=0;a<2;a++)if(this._next().type!==V.break)throw new Error("Invalid encoded Bytes form");const o=ss.decode(`m${i.value}`);return new oe(V.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const Jm={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Jm.tags[42]=$e.parse;const _q="dag-json",AA=297,IA=r=>pq(r,Eq),kA=r=>{const e=yq(r),t=Object.assign(Jm,{tokenizer:new Sq(e,Jm)});return gq(e,t)},F7=r=>xq.decode(IA(r)),xq=new TextDecoder,Aq=r=>kA(Iq.encode(r)),Iq=new TextEncoder,kq=Object.freeze(Object.defineProperty({__proto__:null,code:AA,decode:kA,encode:IA,format:F7,name:_q,parse:Aq,stringify:F7},Symbol.toStringTag,{value:"Module"})),Tq=new TextDecoder;function _w(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");const s=r[e++];if(t+=n<28?(s&127)<<n:(s&127)*2**n,s<128)break}return[t,e]}function Xp(r,e){let t;[t,e]=_w(r,e);const n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function TA(r,e){let t;return[t,e]=_w(r,e),[t&7,t>>3,e]}function Cq(r){const e={},t=r.length;let n=0;for(;n<t;){let s,i;if([s,i,n]=TA(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=Xp(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=Xp(r,n),e.Name=Tq.decode(o)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(s!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Tsize`);[e.Tsize,n]=_w(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function Pq(r){const e=r.length;let t=0,n,s=!1,i;for(;t<e;){let a,c;if([a,c,t]=TA(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=Xp(r,t),n&&(s=!0)}else if(c===2){if(s)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=Xp(r,t),n.push(Cq(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return i&&(o.Data=i),o.Links=n||[],o}const CA=new TextEncoder,V7=2**32,Dq=2**31;function Rq(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=Zh(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){const n=CA.encode(r.Name);t-=n.length,e.set(n,t),t=Zh(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=Zh(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function Oq(r){const e=Mq(r),t=new Uint8Array(e);let n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=Zh(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let s=r.Links.length-1;s>=0;s--){const i=Rq(r.Links[s],t.subarray(0,n));n-=i,n=Zh(t,n,i)-1,t[n]=18}return t}function Nq(r){let e=0;if(r.Hash){const t=r.Hash.length;e+=1+t+Kl(t)}if(typeof r.Name=="string"){const t=CA.encode(r.Name).length;e+=1+t+Kl(t)}return typeof r.Tsize=="number"&&(e+=1+Kl(r.Tsize)),e}function Mq(r){let e=0;if(r.Data){const t=r.Data.length;e+=1+t+Kl(t)}if(r.Links)for(const t of r.Links){const n=Nq(t);e+=1+n+Kl(n)}return e}function Zh(r,e,t){e-=Kl(t);const n=e;for(;t>=Dq;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function Kl(r){return r%2===0&&r++,Math.floor((Bq(r)+6)/7)}function Bq(r){let e=0;return r>=V7&&(r=Math.floor(r/V7),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+Lq[r]}const Lq=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],$q=["Data","Links"],Uq=["Hash","Name","Tsize"],e3=new TextEncoder;function PA(r,e){if(r===e)return 0;const t=r.Name?e3.encode(r.Name):[],n=e.Name?e3.encode(e.Name):[];let s=t.length,i=n.length;for(let o=0,a=Math.min(s,i);o<a;++o)if(t[o]!==n[o]){s=t[o],i=n[o];break}return s<i?-1:i<s?1:0}function K7(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function DA(r){if(typeof r.asCID=="object"){const t=$e.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Hash){let t=$e.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=$e.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=$e.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function RA(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=e3.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(DA),e.Links.sort(PA);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function OA(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!K7(r,$q))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){const t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!K7(t,Uq))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&PA(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function Fq(r,e=[]){return RA({Data:r,Links:e})}function Vq(r,e,t){return DA({Hash:t,Name:r,Tsize:e})}function Kq(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}const qq="dag-pb",NA=112;function Hq(r){OA(r);const e={};return r.Links&&(e.Links=r.Links.map(t=>{const n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),Oq(e)}function zq(r){const e=Kq(r),t=Pq(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(s=>{const i={};try{i.Hash=$e.decode(s.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return s.Name!==void 0&&(i.Name=s.Name),s.Tsize!==void 0&&(i.Tsize=s.Tsize),i})),n}const Wq=Object.freeze(Object.defineProperty({__proto__:null,code:NA,createLink:Vq,createNode:Fq,decode:zq,encode:Hq,name:qq,prepare:RA,validate:OA},Symbol.toStringTag,{value:"Module"}));function xw(r){return r?.then!=null}function jq(r=[],e){const t={[NA]:Wq,[lf]:dO,[_A]:_f,[AA]:kq,[_S]:cO};return r.forEach(n=>{t[n.code]=n}),async n=>{let s=t[n];if(s==null&&e!=null){const i=e(n);xw(i)?s=await i:s=i,t[s.code]=s}if(s!=null)return s;throw new XK(`Could not load codec for ${n}`)}}function Gq(r=[],e){const t={[fn.code]:fn,[k8.code]:k8,[Go.code]:Go};return r.forEach(n=>{t[n.code]=n}),async n=>{let s=t[n];if(s==null&&e!=null){const i=e(n);xw(i)?s=await i:s=i,t[s.code]=s}if(s!=null)return s;throw new YK(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}class Aw{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,block:s}of e)await this.put(n,s,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}const w1=0;class Qq extends Aw{child;constructor(e){super(),this.child=e}put(e,t,n){return e.multihash.code===w1||this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}get(e,t){if(e.multihash.code===w1)return t?.signal?.throwIfAborted(),e.multihash.digest;if(this.child==null)throw t?.signal?.throwIfAborted(),new Jo;return this.child.get(e,t)}has(e,t){return e.multihash.code===w1?(t?.signal?.throwIfAborted(),!0):this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===w1){t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}getAll(e){return this.child!=null?this.child.getAll(e):(e?.signal?.throwIfAborted(),[])}}function Yq(r){return r[Symbol.asyncIterator]!=null}function q7(r){return r?.then!=null}function Zp(r,e){let t=0;if(Yq(r))return async function*(){for await(const c of r){const l=e(c,t++);q7(l)&&await l,yield c}}();const n=nw(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();if(typeof e(s,t++)?.then=="function")return async function*(){yield s;for(const c of n){const l=e(c,t++);q7(l)&&await l,yield c}}();const a=e;return function*(){yield s;for(const c of n)a(c,t++),yield c}()}class MA{child;getHasher;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Qq(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new xe("blocks:put:duplicate",e)),e):(n.onProgress?.(new xe("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(e,t,n))),n.onProgress?.(new xe("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){const n=xs(e,async({cid:i})=>{const o=await this.child.has(i,t);return o&&t.onProgress?.(new xe("blocks:put-many:duplicate",i)),!o}),s=Zp(n,async({cid:i,block:o})=>{t.onProgress?.(new xe("blocks:put-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(i,o,t)))});t.onProgress?.(new xe("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(s,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){const n=await this.getHasher(e.multihash.code);t.onProgress?.(new xe("blocks:get:providers:get",e));const s=await H7(e,this.components.blockBrokers,n,{...t,log:this.log});return t.onProgress?.(new xe("blocks:get:blockstore:put",e)),await this.child.put(e,s,t),t.onProgress?.(new xe("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,s,t))),s}return t.onProgress?.(new xe("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new xe("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Zp(e,async n=>{if(t.offline!==!0&&!await this.child.has(n,t)){const s=await this.getHasher(n.multihash.code);t.onProgress?.(new xe("blocks:get-many:providers:get",n));const i=await H7(n,this.components.blockBrokers,s,{...t,log:this.log});t.onProgress?.(new xe("blocks:get-many:blockstore:put",n)),await this.child.put(n,i,t),t.onProgress?.(new xe("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(n,i,t)))}}))}async delete(e,t={}){t.onProgress?.(new xe("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new xe("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new xe("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class Xq extends MA{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await Hi(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await la(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){const n=this.components.blockBrokers.map(s=>s.createSession==null?s:s.createSession(t));return new Zq({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}}class Zq extends MA{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){const s=ut([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:s})}finally{s.clear()}}async*putMany(e,t={}){const n=ut([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){const n=ut([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){const n=ut([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){const n=ut([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){const n=ut([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){const n=ut([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){const t=ut([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}}function Jq(r){return typeof r.retrieve=="function"}const eH=(r,e)=>{if(e==null)throw new re(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n;const s=e.digest(t);if(xw(s)?n=await s:n=s,!We(n.digest,r.multihash.digest))throw new I6("Hash of downloaded block did not match multihash from passed CID")}};async function H7(r,e,t,n){const s=eH(r,t),i=new AbortController,o=ut([i.signal,n.signal]);i.signal;const a=[];for(const c of e)Jq(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1;const u=await c.retrieve(r,{...n,signal:o,validateFn:async h=>{await s(h),l=!0}});return l||await s(u),u}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{i.abort(),o.clear()}}class BA extends $t{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??jK,this.maxProviders=t.maxProviders??GK,this.providers=[],this.evictionFilter=Zo(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){const n=ss.encode(e.multihash.bytes),s=this.requests.get(n);if(s!=null)return this.log("join existing request for %c",e),s;const i=Qe();if(this.requests.set(n,i.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.initialPeerSearchComplete,u&&this.log("found initial session peers for %c",e)}let o=!1;const a=new ta({concurrency:this.maxProviders});a.addEventListener("error",()=>{}),a.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{o=!0,i.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(o||t.signal?.aborted===!0){this.log.trace("session idle, found block");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){const h=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(h)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),i.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c",e,u),i.reject(u)})});const c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(h=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,h)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,u)});const l=()=>{i.reject(new qi(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await i.promise}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){const s=Qe();let i=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;i<t&&this.initialProviders.length>0;){const o=this.initialProviders.pop();if(o==null)break;const a=await this.convertToProvider(o,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),i++,i===t&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(i<this.maxProviders)for await(const o of this.findNewProviders(e,n)){if(i===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(o)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(o),this.safeDispatchEvent("provider",{detail:o}),i++,i===t&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new QK(`Found ${i} of ${t} ${this.name} providers for ${e}`)}).catch(o=>{this.log.error("error searching routing for potential session peers for %c",e,o.errors??o),s.reject(o)}),s.promise}}class tH{blockstore;datastore;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??Eg(),this.log=this.logger.forComponent("helia"),this.getHasher=Gq(e.hashers,e.loadHasher),this.getCodec=jq(e.codecs,e.loadCodec),this.dns=e.dns??V_(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new JK(t,{routers:(e.routers??[]).flatMap(s=>{const i=[s];return s[Xl]!=null&&i.push(s[Xl]),s[Zl]!=null&&i.push(s[Zl]),i}),providerLookupConcurrency:e.providerLookupConcurrency});const n=new Xq(t);this.pins=new WK(e.datastore,n,this.getCodec),this.blockstore=new eq(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(s=>s(t))}async start(){await tq(this.datastore),await Hi(this.blockstore,this.datastore,this.routing)}async stop(){await la(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const n=this,s=this.blockstore.unwrap();this.log("gc start"),await ji(s.deleteMany(async function*(){for await(const{cid:i}of s.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new xe("helia:gc:deleted",i))}catch(o){n.log.error("Error during gc",o),e.onProgress?.(new xe("helia:gc:error",o))}}()))}finally{t()}this.log("gc finished")}}class rH extends tH{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}function nH(r){return r[Symbol.asyncIterator]!=null}function yc(r,e){let t=0;if(nH(r))return async function*(){for await(const c of r)yield e(c,t++)}();const n=nw(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){yield await o;for(const c of n)yield e(c,t++)}();const a=e;return function*(){yield o;for(const c of n)yield a(c,t++)}()}function Nn(r,...e){if(r==null)throw new Error("Empty pipeline");if(Iy(r)){const n=r;r=()=>n.source}else if($A(r)||LA(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&Iy(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Iy(t[n])&&(t[n]=iH(t[n]));return sH(...t)}const sH=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},LA=r=>r?.[Symbol.asyncIterator]!=null,$A=r=>r?.[Symbol.iterator]!=null,Iy=r=>r==null?!1:r.sink!=null&&r.source!=null,iH=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=ls({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s;const i=r.source;if(LA(i))s=async function*(){yield*i,n.end()};else if($A(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return $o(n,s())}return r.source},b1="/ipfs/bitswap/1.2.0",oH=1024,aH=1024,cH=1024,lH=5e3,uH=10,hH=50,dH=!1,fH=3,UA=1024*1024*4,pH=UA;var cr;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(cr||(cr={}));var t3;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(t3||(t3={}));(function(r){r.codec=()=>gn(t3)})(cr||(cr={}));var $d;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),cr.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={cid:ze(0),priority:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.priority=t.int32();break}case 3:{i.cancel=t.bool();break}case 4:{i.wantType=cr.codec().decode(t);break}case 5:{i.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})($d||($d={}));var Jp;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(const i of t.entries)n.uint32(10),$d.codec().encode(i,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={entries:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.entries!=null&&i.entries.length===s.limits.entries)throw new ft('Decode error - map field "entries" had too many elements');i.entries.push($d.codec().decode(t,t.uint32(),{limits:s.limits?.entries$}));break}case 2:{i.full=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Jp||(Jp={}));var Ud;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={prefix:ze(0),data:ze(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.prefix=t.bytes();break}case 2:{i.data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Ud||(Ud={}));var ri;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(ri||(ri={}));var e0;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(e0||(e0={}));(function(r){r.codec=()=>gn(e0)})(ri||(ri={}));var Fd;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&e0[t.type]!==0&&(n.uint32(16),ri.codec().encode(t.type,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={cid:ze(0),type:ri.HaveBlock},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.type=ri.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Fd||(Fd={}));var Vd;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),Jp.codec().encode(t.wantlist,n)),t.blocks!=null)for(const i of t.blocks)n.uint32(26),Ud.codec().encode(i,n);if(t.blockPresences!=null)for(const i of t.blockPresences)n.uint32(34),Fd.codec().encode(i,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={blocks:[],blockPresences:[],pendingBytes:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.wantlist=Jp.codec().decode(t,t.uint32(),{limits:s.limits?.wantlist});break}case 3:{if(s.limits?.blocks!=null&&i.blocks.length===s.limits.blocks)throw new ft('Decode error - map field "blocks" had too many elements');i.blocks.push(Ud.codec().decode(t,t.uint32(),{limits:s.limits?.blocks$}));break}case 4:{if(s.limits?.blockPresences!=null&&i.blockPresences.length===s.limits.blockPresences)throw new ft('Decode error - map field "blockPresences" had too many elements');i.blockPresences.push(Fd.codec().decode(t,t.uint32(),{limits:s.limits?.blockPresences$}));break}case 5:{i.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Vd||(Vd={}));function gH(r,e){for(const[t,n]of e.wantlist.entries()){const s=r.wantlist.get(t);s!=null&&(s.priority>n.priority&&(n.priority=s.priority),n.cancel=n.cancel??s.cancel,n.wantType=n.wantType??s.wantType,n.sendDontHave=n.sendDontHave??s.sendDontHave),r.wantlist.set(t,n)}for(const[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(const[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}class yH extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}const mH=4193648,wH=mH+16;function*bH(r,e){const t=[...r.wantlist.values()],n=[...r.blockPresences.values()],s=[...r.blocks.values()];let i=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=Vd.encode(l).byteLength,{added:h,hasMore:d,newSize:g}=ky(s,l.blocks,a,e,u,vH);a+=h,u=g;const y=d;({added:h,hasMore:d,newSize:g}=ky(n,l.blockPresences,o,e,u,EH)),o+=h,u=g;const w=d;if({added:h,hasMore:d,newSize:g}=ky(t,l.wantlist.entries,i,e,u,SH),i+=h,u=g,c=!y&&!w&&!d,c||(l.wantlist.full=!1),yield Vd.encode(l),c)break}}function ky(r,e,t,n,s,i){let o=0,a=!1;for(let c=t;c<r.length;c++){const l=r[c],u=i(l);if(u>wH)throw new yH("Cannot send block as after encoding it is over the max message size");const h=s+u;if(h>n){a=!0;break}e.push(l),o++,s=h}return{hasMore:a,added:o,newSize:s}}function vH(r){return Iw(3,Ud.encode(r))}function EH(r){return Iw(4,Fd.encode(r))}function SH(r){return Iw(1,$d.encode(r))}function Iw(r,e){const t=At(r),n=At(e.byteLength);return t+n+e.byteLength}let _H=class extends $t{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[b1],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??aH,this.maxOutboundStreams=t.maxOutboundStreams??cH,this.messageReceiveTimeout=t.messageReceiveTimeout??lH,this.runOnLimitedConnections=t.runOnLimitedConnections??dH,this.maxIncomingMessageSize=t.maxIncomingMessageSize??UA,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??pH,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new ra({concurrency:t.messageSendConcurrency??hH,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",n=>{this.log.error("error sending wantlist to peer",n.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(const t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;const{stream:t,connection:n}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);const s=()=>{t.status==="open"?t.abort(new of(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)};let i=AbortSignal.timeout(this.messageReceiveTimeout);i.addEventListener("abort",s),await t.closeWrite(),await Nn(t,o=>Md(o,{maxDataLength:this.maxIncomingMessageSize}),async o=>{for await(const a of o)try{const c=Vd.decode(a);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:c}}),i.removeEventListener("abort",s),i=AbortSignal.timeout(this.messageReceiveTimeout),i.addEventListener("abort",s)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,c),t.abort(c);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",n.remotePeer,s),t.abort(s)})}async*findProviders(e,t){t?.onProgress?.(new xe("bitswap:network:find-providers",e));for await(const n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield n)}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(s=>{this.log.error("could not connect to supplied provider - %e",s)}))),await ji(yc(cu(this.findProviders(e,t),t?.maxProviders??fH),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");const s=this.sendQueue.queue.find(i=>e.equals(i.options.peerId)&&i.status==="queued");if(s!=null){s.options.message=gH(s.options.message,t),await s.join({signal:n?.signal});return}await this.sendQueue.add(async i=>{const o=i?.message;if(o==null)throw new re("No message to send");this.log("sendMessage to %p",e),i?.onProgress?.(new xe("bitswap:network:send-wantlist",e));const a=await this.libp2p.dialProtocol(e,b1,i);await a.closeRead();try{await Nn(bH(o,this.maxOutgoingMessageSize),c=>Nd(c),a),await a.close(i)}catch(c){i?.onProgress?.(new xe("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p",e,c),a.abort(c)}this._updateSentStats(o.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new Jl("Network isn't running");t?.onProgress?.(new xe("bitswap:network:dial",e));const[n]=await Promise.all([this.libp2p.dial(e,t),zr(this.libp2p,"peer:identify",t?.signal,{filter:s=>{if(!s.detail.peerId.equals(e))return!1;if(s.detail.protocols.includes(b1))return!0;throw new hg(`${e} did not support ${b1}`)}})]);return n}_updateSentStats(e){let t=0;for(const n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};class Hh{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=ss.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=ss.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=ss.encode(e.multihash.bytes);this.blocks.set(n,t)}}function xH(r){let e=new Uint8Array(r.reduce((n,s)=>n+At(s),0)),t=0;for(const n of r)e=is(n,e,t),t+=At(n);return e}function z7(r){return xH([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}class AH{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??oH}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new Hh,n=new Set;for(const[s,i]of this.wants.entries())try{const o=await this.blockstore.get(i.cid,e);i.wantType===cr.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),n.add(s),t.addBlock(i.cid,{data:o,prefix:z7(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:ri.HaveBlock})):(this.log("sending block for %c",i.cid),n.add(s),t.addBlock(i.cid,{data:o,prefix:z7(i.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDoNotHave===!0)continue;i.sentDoNotHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:ri.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((s,i)=>s+i.data.byteLength,0));for(const s of n)this.wants.delete(s)}}}class IH{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Sg({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,s)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new AH({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((s,i)=>s+i.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(const s of t.wantlist.entries){const i=$e.decode(s.cid),o=se(i.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,i),n.wants.delete(o)):(s.wantType===cr.WantHave?this.log("peer %p wanted block presence for %c",e,i):this.log("peer %p wanted block for %c",e,i),n.wants.set(o,{cid:i,priority:s.priority,wantType:s.wantType??cr.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=se(e.multihash.bytes,"base64"),s=[];for(const i of this.ledgerMap.values())i.wants.has(n)&&s.push(i);await Promise.all(s.map(async i=>i.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}class kH extends BA{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);const s=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,s.has?"has":"does not have",e),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(const n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return Xa(e)?e:(await this.libp2p.dial(e,t)).remotePeer}}function TH(r,e){return new kH(r,e)}class CH{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}}function PH(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=Nc(r);e.push(t),r=r.slice(At(t))}return e}class DH extends $t{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Sg({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=Os({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??uH,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,s)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",n.detail,s)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){const n=se(e.multihash.bytes,"base64");let s=this.wants.get(n);s==null&&(s={cid:e,priority:t.priority??1,wantType:t.wantType??cr.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,s)),s.wantType===cr.WantHave&&t.wantType===cr.WantBlock&&(s.wantType=cr.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===cr.WantBlock?(await zr(this,"block",t?.signal,{filter:a=>We(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await zr(this,"presence",t?.signal,{filter:o=>We(e.multihash.digest,o.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Qe(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{const n=new Set,s=new Hh;for(const[i,o]of this.wants.entries())t.has(i)||o.cancel||(n.add(i),s.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:o.priority,wantType:o.wantType,cancel:o.cancel,sendDontHave:o.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(e,s);for(const i of n)t.add(i)}catch(i){this.log.error("error sending full wantlist to new peer",i)}})).catch(e=>{this.log.error("error sending messages",e)});for(const[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(const n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){const t=se(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){const s=new Hh;return s.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:cr.WantHave,priority:1}),await this.network.sendMessage(t,s),(await zr(this,"presence",n.signal,{filter:o=>t.equals(o.detail.sender)&&We(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:cr.WantBlock})}async wantSessionBlock(e,t,n={}){const s=new Hh;return s.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:cr.WantBlock,priority:1}),await this.network.sendMessage(t,s),(await zr(this,"presence",n.signal,{filter:o=>t.equals(o.detail.sender)&&We(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){const n=se(e.multihash.bytes,"base64"),s=this.wants.get(n);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(const s of t.blocks){if(s.prefix==null||s.data==null)continue;const i=PH(s.prefix),o=i[0],a=i[1],c=i[2],l=c===fn.code?fn:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(s.data);u.then!=null&&(u=await u);const h=$e.create(o===0?0:1,a,u);this.log("received block from %p for %c",e,h),this.safeDispatchEvent("block",{detail:{sender:e,cid:h,block:s.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:h,has:!0,block:s.data}});const d=se(h.multihash.bytes,"base64"),g=this.wants.get(d);g!=null&&(g.cancel=!0,n=!0)}for(const{cid:s,type:i}of t.blockPresences){const o=$e.decode(s);this.log("received %s from %p for %c",i,e,o),this.safeDispatchEvent("presence",{detail:{sender:e,cid:o,has:i===ri.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){const t=new Set,n=new Hh(!0);for(const[s,i]of this.wants.entries())i.cancel||(t.add(s),n.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:1,wantType:cr.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(s){this.log.error("error sending full wantlist to new peer %p",e,s)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class RH{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new CH(e),this.network=new _H(e,t),this.peerWantLists=new IH({...e,network:this.network},t),this.wantList=new DH({...e,network:this.network},t)}createSession(e={}){return TH({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){const n=new AbortController,s=ut([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:s}).catch(i=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,i)});try{return(await this.wantList.wantBlock(e,{...t,signal:s})).block}finally{n.abort(),s.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const OH=(r,e={})=>new RH(r,e);class NH{bitswap;started;constructor(e,t={}){const{getHasher:n}=e;this.bitswap=OH(e,{hashLoader:{getHasher:async s=>n(s)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(n,s,i)=>{await this.bitswap.notify(n,s,i)},retrieve:async(n,s)=>t.retrieve(n,s)}}}function MH(r={}){return e=>new NH(e,r)}const BH=[Li,mf,bf,wf,Ku];function W7(r){return FA("sni",r)?.value}function j7(r){const e=FA("tcp",r)?.value;return e==null?"":`:${e}`}function FA(r,e){return e.find(t=>t.name===r)}function G7(r){return r.some(({code:e})=>e===Ul)}function ms(r,e){const t=VA[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===os?`[${n}]`:n}const VA={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${ms(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${ms(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${ms(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${ms(t,e)}`},http:(r,e)=>{const t=G7(e),n=W7(e),s=j7(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=ms(o,e);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=ms(t,e),s=decodeURIComponent(r.value??"");return`${n}${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return ms(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return ms(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=ms(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=G7(e),n=W7(e),s=j7(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=ms(o,e);return a=a?.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=ms(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function kw(r,e){const n=De(r).getComponents(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=VA[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let o=i(s,n)??"";return BH.includes(s.code)&&(o=o.replace(/^.*:\/\//,""),s.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}class KA{url;#e=0;#t=0;#r=0;#o=0;#a=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#u(e){const t=e.multihash.bytes;return ss.encode(t)}async getRawBlock(e,t){const n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const s=this.#u(e),i=new AbortController,o=()=>{i.abort()};t?.addEventListener("abort",o);try{let a=this.#a.get(s);if(a==null){this.#e++;const c={signal:i.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},l=this.transformRequestInit!=null?await this.transformRequestInit(c):c;a=fetch(n.toString(),l).then(async u=>{if(this.log("GET %s %d",n,u.status),!u.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#o++,new Uint8Array(await u.arrayBuffer())}),this.#a.set(s,a)}return await a}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",o),this.#a.delete(s)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#o/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#o,pendingResponses:this.#a.size}}}const LH=r=>r.toString().split("/").slice(1),xf=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Ge=r=>({match:e=>xf(t=>t===r).match(e),pattern:r}),Hc=()=>({match:r=>xf(e=>typeof e=="string").match(r),pattern:"{string}"}),Kd=()=>({match:r=>xf(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),gt=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{Xt.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),t0=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{cf.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),ct=r=>({match:e=>{const t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),Ur=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Ye=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function Rt(...r){function e(s){let i=LH(s);for(const o of r){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const $H=gt();Rt($H);const Rg=Ye(Ge("dns4"),Hc()),Og=Ye(Ge("dns6"),Hc()),Ng=Ye(Ge("dnsaddr"),Hc()),Tw=Ye(Ge("dns"),Hc());Rt(Rg,ct(gt()));Rt(Og,ct(gt()));Rt(Ng,ct(gt()));const UH=Rt(Ur(Tw,Ng,Rg,Og),ct(gt())),qA=Ye(Ge("ip4"),xf(hc)),HA=Ye(Ge("ip6"),xf(Y6)),Cw=Ur(qA,HA),$i=Ur(Cw,Tw,Rg,Og,Ng);Rt(Ur(Cw,Ye(Ur(Tw,Ng,Rg,Og),ct(gt()))));Rt(qA);Rt(HA);Rt(Cw);const Pw=Ye($i,Ge("tcp"),Kd()),Af=Ye($i,Ge("udp"),Kd());Rt(Ye(Pw,ct(gt())));Rt(Af);const Dw=Ye(Af,Ge("quic"),ct(gt())),Mg=Ye(Af,Ge("quic-v1"),ct(gt())),FH=Ur(Dw,Mg);Rt(Dw);Rt(Mg);const r3=Ur($i,Pw,Af,Dw,Mg),zA=Ur(Ye(r3,Ge("ws"),ct(gt())));Rt(zA);const WA=Ur(Ye(r3,Ge("wss"),ct(gt())),Ye(r3,Ge("tls"),ct(Ye(Ge("sni"),Hc())),Ge("ws"),ct(gt())));Rt(WA);const jA=Ye(Af,Ge("webrtc-direct"),ct(t0()),ct(t0()),ct(gt()));Rt(jA);const GA=Ye(Mg,Ge("webtransport"),ct(t0()),ct(t0()),ct(gt()));Rt(GA);const r0=Ur(zA,WA,Ye(Pw,ct(gt())),Ye(FH,ct(gt())),Ye($i,ct(gt())),jA,GA,gt());Rt(r0);const VH=Ye(r0,Ge("p2p-circuit"),gt());Rt(VH);const KH=Ur(Ye(r0,Ge("p2p-circuit"),Ge("webrtc"),ct(gt())),Ye(r0,Ge("webrtc"),ct(gt())),Ye(Ge("webrtc"),ct(gt())));Rt(KH);const qH=Ur(Ye($i,Ge("tcp"),Kd(),Ge("http"),ct(gt())),Ye($i,Ge("http"),ct(gt()))),HH=Rt(qH),zH=Ur(Ye($i,Ge("tcp"),Ur(Ye(Ge("443"),Ge("http")),Ye(Kd(),Ge("https")),Ye(Kd(),Ge("tls"),Ge("http"))),ct(gt())),Ye($i,Ge("tls"),Ge("http"),ct(gt())),Ye($i,Ge("https"),ct(gt()))),WH=Rt(zH),jH=Ur(Ye(Ge("memory"),Hc(),ct(gt())));Rt(jH);const GH=Ur(Ye(Ge("unix"),Hc(),ct(gt())));Rt(GH);function QA(r,e,t){return r.filter(n=>{if(WH.matches(n)||e&&HH.matches(n))return t||UH.matches(n)?!0:ha(n.toOptions().host)===!1;if(!e&&t){const{host:s}=n.toOptions();if(s==="127.0.0.1"||s==="localhost"||s.endsWith(".localhost"))return!0}return!1})}async function*YA(r,e,t,n,s,i={}){for await(const o of e.findProviders(r,i)){const a=QA(o.multiaddrs,n,s);if(a.length===0)continue;const c=kw(a[0]);yield new KA(c,{logger:t,transformRequestInit:i.transformRequestInit})}}class QH extends BA{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??XA,this.allowLocal=t.allowLocal??ZA,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);const s=await t.getRawBlock(e,n.signal);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(s),s}async*findNewProviders(e,t={}){yield*YA(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(Xa(e))return;const n=QA(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;const s=kw(n[0]);return new KA(s,{logger:this.logger,transformRequestInit:this.transformRequestInit})}}function YH(r,e){return new QH(r,e)}class XH{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??XA,this.allowLocal=t.allowLocal??ZA,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){const n=[];for await(const s of YA(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,s.url);try{const i=await s.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,s.url);try{await t.validateFn?.(i)}catch(o){this.log.error("failed to validate block for %c from %s",e,s.url,o);continue}return i}catch(i){if(this.log.error("failed to get block for %c from %s",e,s.url,i),i instanceof Error?n.push(i):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${s.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,s.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return YH({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const XA=!1,ZA=!1;function ZH(r={}){return e=>new XH(e,r)}async function*Q7(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var JA={exports:{}};(function(r){(function(){r.exports=m;var e=86400,t=3200,n=146097*t/400,s=e*n,i=1e3*s,o=864e13,a=4294967296,c=1e6,l="000000000",u=Math.trunc||function(R){var C=R-R%1;return C==0&&(R<0||R===0&&1/R!=1/0)?-0:C},h=m.prototype,d=(m.fromDate=function(R){return new m(+R)},m.fromInt64BE=T(0,1,2,3,0,4),m.fromInt64LE=T(3,2,1,0,4,0),m.fromString=function(P){var C,O=new m,P=(P+="").replace(/^\s*[+\-]?\d+/,function(K){var K=+K,H=1970+(K-1970)%400;return O.year=K-H,H}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(M,K,H){return K<0&&(H*=-1),C=6e4*(60*+K+ +H),""}).replace(/\.\d+$/,function(M){return O.nano=+(M+l).substr(1,9),""}).split(/\D+/);if(1<P.length?P[1]--:P[1]=0,O.time=C=Date.UTC.apply(Date,P)-(C||0),isNaN(C))throw new TypeError("Invalid Date");return _(O)},m.fromTimeT=function(R){return N(R,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(R){return this.nano+=+R||0,this},h.getNano=function(){var R=_(this);return(R.time%1e3*c+ +R.nano+1e9)%1e9},h.getTimeT=function(){var C=_(this),R=Math.floor(C.time/1e3),C=C.year;return C&&(R+=C*n*e/t),R},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return k(_(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(R){var C=this,O=C.toDate(),P={H:function(){return D(O.getUTCHours())},L:function(){return F(O.getUTCMilliseconds(),3)},M:function(){return D(O.getUTCMinutes())},N:function(){return F(C.getNano(),9)},S:function(){return D(O.getUTCSeconds())},Y:function(){var M=C.getYear();return 999999<M?"+"+M:9999<M?"+"+F(M,6):0<=M?F(M,4):-999999<=M?"-"+F(-M,6):M},a:function(){return y[O.getUTCDay()]},b:function(){return g[O.getUTCMonth()]},d:function(){return D(O.getUTCDate())},e:function(){return function(M){return(9<M?"":" ")+(0|M)}(O.getUTCDate())},m:function(){return D(O.getUTCMonth()+1)}};return function M(K){return K.replace(/%./g,function(H){var L=H[1],$=w[L],L=P[L];return $?M($):L?L():H})}(R||d)},h.writeInt64BE=I(0,1,2,3,0,4),h.writeInt64LE=I(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],y=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],w={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return m;function m(R,C,O){var P=this;if(!(P instanceof m))return new m(R,C,O);P.time=+R||0,P.nano=+C||0,P.year=+O||0,_(P)}function _(R){var C,O,P,M=R.year,K=R.time,H=R.nano,$=((H<0||c<=H)&&(H-=(O=Math.floor(H/c))*c,K+=O,O=1),M%t);return(K<-o||o<K||$)&&((C=u(K/i))&&(M+=C*t,K-=C*i),(P=k(K)).setUTCFullYear($+P.getUTCFullYear()),P=(K=+P)+(C=u((M-=$)/t))*i,C&&-o<=P&&P<=o&&(M-=C*t,K=P),O=1),O&&(R.year=M,R.time=K,R.nano=H),R}function k(R){var C=new Date(0);return C.setTime(R),C}function N(M,P){M=+M||0;var O=u((P=(P|0)*a)/s)+u(M/s),P=P%s+M%s,M=u(P/s);return M&&(O+=M,P-=M*s),new m(1e3*P,0,O*t)}function I(R,C,O,P,M,K){return function($,L){var q=_(this);$=$||new Array(8),x($,L|=0);var Y=Math.floor(q.time/1e3),q=q.year*(n*e/t),z=u(q/a)+u(Y/a),q=q%a+Y%a,Y=Math.floor(q/a);return Y&&(z+=Y,q-=Y*a),H($,L+M,z),H($,L+K,q),$};function H($,L,z){$[L+R]=z>>24&255,$[L+C]=z>>16&255,$[L+O]=z>>8&255,$[L+P]=255&z}}function T(R,C,O,P,M,K){return function($,L){x($,L|=0);var z=H($,L+M);return N(H($,L+K),z)};function H($,L){return 16777216*$[L+R]+($[L+C]<<16|$[L+O]<<8|$[L+P])}}function x(R,C){if(R=R&&R.length,R==null)throw new TypeError("Invalid Buffer");if(R<C+8)throw new RangeError("Out of range")}function D(R){return(9<R?"":"0")+(0|R)}function F(R,C){return(l+(0|R)).substr(-C)}})()})(JA);var JH=JA.exports;const n3=Mc(JH);class Oa extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}class ez extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}class eI extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}class tz extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}class rz extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}}class nz extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}class Y7 extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}var Ps;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>gn(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=Pe((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.value!=null&&(s.uint32(10),s.bytes(n.value)),n.signatureV1!=null&&(s.uint32(18),s.bytes(n.signatureV1)),n.validityType!=null&&(s.uint32(24),r.ValidityType.codec().encode(n.validityType,s)),n.validity!=null&&(s.uint32(34),s.bytes(n.validity)),n.sequence!=null&&(s.uint32(40),s.uint64(n.sequence)),n.ttl!=null&&(s.uint32(48),s.uint64(n.ttl)),n.pubKey!=null&&(s.uint32(58),s.bytes(n.pubKey)),n.signatureV2!=null&&(s.uint32(66),s.bytes(n.signatureV2)),n.data!=null&&(s.uint32(74),s.bytes(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.value=n.bytes();break}case 2:{o.signatureV1=n.bytes();break}case 3:{o.validityType=r.ValidityType.codec().decode(n);break}case 4:{o.validity=n.bytes();break}case 5:{o.sequence=n.uint64();break}case 6:{o.ttl=n.uint64();break}case 7:{o.pubKey=n.bytes();break}case 8:{o.signatureV2=n.bytes();break}case 9:{o.data=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Ce(n,r.codec()),r.decode=(n,s)=>Te(n,r.codec(),s)})(Ps||(Ps={}));const sz=Hu("ipns:utils"),tI=ie("/ipns/"),iz=0,oz=18;function az(r){let e;if(r.pubKey!=null)try{e=Qr(r.pubKey)}catch(t){throw sz.error(t),t}if(e!=null)return e}function cz(r){const e=ie("ipns-signature:");return jr([e,r])}function rI(r){return"signatureV1"in r?Ps.encode({value:ie(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:ie(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):Ps.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function If(r){const e=Ps.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new Oa("Missing data or signatureV2");const t=sI(e.data),n=lz(t.Value),s=se(t.Validity);if(e.value!=null&&e.signatureV1!=null)return uz(e),{value:n,validityType:Ps.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Ps.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function nI(r){return jr([tI,r.bytes])}function s3(r){const e=ur(r.slice(tI.length));if(!i3(e,iz)&&!i3(e,oz))throw new I6("Multihash in IPNS key was not identity or sha2-256");return e}function sI(r){const e=ko(r);if(e.ValidityType===0)e.ValidityType=Ps.ValidityType.EOL;else throw new eI("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function lz(r){const e=se(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${$e.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${$e.parse(e).toV1().toString()}`}catch{}throw new rz("Value must be a valid content path starting with /")}function uz(r){if(r.data==null)throw new nz("Record data is missing");const e=sI(r.data);if(!We(e.Value,r.value??new Uint8Array(0)))throw new Oa('Field "value" did not match between protobuf and CBOR');if(!We(e.Validity,r.validity??new Uint8Array(0)))throw new Oa('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new Oa('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new Oa('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new Oa('Field "ttl" did not match between protobuf and CBOR')}function i3(r,e){return r.code===e}const v1=Hu("ipns:validator"),hz=1024*10;async function dz(r,e){const t=If(e);let n;try{const s=cz(t.data);n=await r.verify(s,t.signatureV2)}catch{n=!1}if(!n)throw v1.error("record signature verification failed"),new Oa("Record signature verification failed");if(t.validityType===Ps.ValidityType.EOL){if(n3.fromString(t.validity).toDate().getTime()<Date.now())throw v1.error("record has expired"),new ez("record has expired")}else if(t.validityType!=null)throw v1.error("the validity type is unsupported"),new eI("The validity type is unsupported");v1("ipns record for %s is valid",t.value)}async function iI(r,e){if(e.byteLength>hz)throw new tz("The record is too large");const t=s3(r);let n;i3(t,0)&&(n=k_(t));const s=If(e),i=az(s)??n;if(i==null)throw new Y7("Could not extract public key from IPNS record or routing key");const o=nI(i.toMultihash());if(!We(o,r))throw new Y7("Embedded public key did not match routing key");await dz(i,e)}let fz=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*X7(r,e={}){const t=/\r?\n/,n=new TextDecoder("utf8");let s="";for await(let i of r){if(typeof i=="string"&&(i=new TextEncoder().encode(i)),Uh(i)&&(i=i.subarray()),s+=n.decode(i,{stream:!0}),s.length>(e?.maxMessageLength??s.length))throw new fz("Incoming message too long");const o=s.split(t);s=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}s+=n.decode(),s!==""&&(yield JSON.parse(s))}class Ty extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}class So extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}}function pz(r){return r[Symbol.asyncIterator]!=null}function gz(r){if(pz(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}const Z7=ie("/ipns/");function J7(r){return We(r.subarray(0,Z7.byteLength),Z7)}class yz{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*yc(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!J7(e))return;const s=s3(e),i=$e.createV1(114,s),o=If(t);await this.client.putIPNS(i,o,n)}async get(e,t){if(!J7(e))throw new Zt("Not found");const n=s3(e),s=$e.createV1(114,n);try{const i=await this.client.getIPNS(s,t);return rI(i)}catch(i){throw i.name==="BadResponseError"?new Zt("Not found"):i}}}class mz{client;constructor(e){this.client=e}async findPeer(e,t={}){const n=await gz(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new Zt("Not found")}async*getClosestPeers(e,t={}){}}const fr=Hu("delegated-routing-v1-http-api-client"),E1={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"};class wz{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new ru({concurrency:t.concurrentRequests??E1.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??E1.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new yz(this),this.peerRouting=new mz(this),this.cacheName=t.cacheName??E1.cacheName,this.cacheTTL=t.cacheTTL??E1.cacheTTL}get[Xl](){return this.contentRouting}get[Zl](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&fr("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){fr("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),s=ut([this.shutDownController.signal,n,t.signal]),i=Qe(),o=Qe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:s},l=await this.#r(a.toString(),c);if(l==null)throw new So("No response received");if(!l.ok)throw l.status===404?new Zt("No matching records found"):l.status===422?new Ty("Request does not conform to schema or semantic constraints"):new So(`Unexpected status code: ${l.status}`);if(l.body==null)throw new So("Routing response had no body");const u=l.headers.get("Content-Type");if(u==null)throw new So("No Content-Type header received");if(u?.startsWith("application/json")){const h=await l.json();for(const d of h.Providers){const g=this.#e(d);g!=null&&(yield g)}}else if(u.includes("application/x-ndjson"))for await(const h of X7(Q7(l.body))){const d=this.#e(h);d!=null&&(yield d)}else throw new So(`Unsupported Content-Type: ${u}`)}finally{s.clear(),o.resolve(),fr("getProviders finished: %c",e)}}async*getPeers(e,t={}){fr("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),s=ut([this.shutDownController.signal,n,t.signal]),i=Qe(),o=Qe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:s},l=await this.#r(a.toString(),c);if(l.status===404)throw new Zt("No matching records found");if(l.status===422)throw new Ty("Request does not conform to schema or semantic constraints");if(l.body==null)throw new So("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){const h=await l.json();for(const d of h.Peers){const g=this.#e(d);g!=null&&(yield g)}}else for await(const h of X7(Q7(l.body))){const d=this.#e(h);d!=null&&(yield d)}}catch(a){fr.error("getPeers errored:",a)}finally{s.clear(),o.resolve(),fr("getPeers finished: %c",e)}}async getIPNS(e,t={}){fr("getIPNS starts: %s",e);const n=AbortSignal.timeout(this.timeout),s=ut([this.shutDownController.signal,n,t.signal]),i=Qe(),o=Qe();this.httpQueue.add(async()=>(i.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await i.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:s},l=await this.#r(a,c);if(fr("getIPNS GET %s %d",a,l.status),l.status===404)throw new Zt("No matching records found");if(l.status===422)throw new Ty("Request does not conform to schema or semantic constraints");if(l.body==null)throw new So("GET ipns response had no body");const u=await l.arrayBuffer(),h=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await iI(nI(e.multihash),h),If(h)}catch(c){throw fr.error("getIPNS GET %s error:",a,c),c}finally{s.clear(),o.resolve(),fr("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){fr("putIPNS starts: %c",e);const s=AbortSignal.timeout(this.timeout),i=ut([this.shutDownController.signal,s,n.signal]),o=Qe(),a=Qe();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;const l=rI(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i},h=await this.#r(c,u);if(fr("putIPNS PUT %s %d",c,h.status),h.status!==200)throw new So("PUT ipns response had status other than 200")}catch(l){throw fr.error("putIPNS PUT %s error:",c,l.stack),l}finally{i.clear(),a.resolve(),fr("putIPNS finished: %c",e)}}#e(e){try{const t=[],n=e.Addrs?.map(De)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:nr(e.ID),Addrs:n,Protocols:t}}catch(t){fr.error("could not conform record to peer schema",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){const s=t?.join(",")??this.filterAddrs?.join(",")??"";s!==""&&e.searchParams.set("filter-addrs",s)}if(n!=null||this.filterProtocols!=null){const s=n?.join(",")??this.filterProtocols?.join(",")??"";s!==""&&e.searchParams.set("filter-protocols",s)}}async#r(e,t){const n=t.method??"GET",s=`${n}-${e}`;if(n==="GET"){const c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return fr("returning cached response for %s",s),c;await this.cache?.delete(e)}}const i=this.inFlightRequests.get(s);if(i!=null){const c=await i;return fr("deduplicating outgoing request for %s",s),c.clone()}const o=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&n==="GET"){const l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());const h=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,h)}return c}).finally(()=>{this.inFlightRequests.delete(s)});return this.inFlightRequests.set(s,o),await o}}function bz(r,e={}){return new wz(new URL(r),e)}function vz(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const eb="[a-fA-F\\d:]",Do=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${eb})|(?<=${eb})(?=\\s|$))`:"",Ss="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Qt="[a-fA-F\\d]{1,4}",Bg=`
(?:
(?:${Qt}:){7}(?:${Qt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Qt}:){6}(?:${Ss}|:${Qt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Qt}:){5}(?::${Ss}|(?::${Qt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Qt}:){4}(?:(?::${Qt}){0,1}:${Ss}|(?::${Qt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Qt}:){3}(?:(?::${Qt}){0,2}:${Ss}|(?::${Qt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Qt}:){2}(?:(?::${Qt}){0,3}:${Ss}|(?::${Qt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Qt}:){1}(?:(?::${Qt}){0,4}:${Ss}|(?::${Qt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Qt}){0,5}:${Ss}|(?::${Qt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),Ez=new RegExp(`(?:^${Ss}$)|(?:^${Bg}$)`),Sz=new RegExp(`^${Ss}$`),_z=new RegExp(`^${Bg}$`),Lg=r=>r&&r.exact?Ez:new RegExp(`(?:${Do(r)}${Ss}${Do(r)})|(?:${Do(r)}${Bg}${Do(r)})`,"g");Lg.v4=r=>r&&r.exact?Sz:new RegExp(`${Do(r)}${Ss}${Do(r)}`,"g");Lg.v6=r=>r&&r.exact?_z:new RegExp(`${Do(r)}${Bg}${Do(r)}`,"g");function xz(r){const e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}const{toString:Az}=Object.prototype;function Iz(r){return Az.call(r)==="[object RegExp]"}const tb={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function kz(r,e={}){if(!Iz(r))throw new TypeError("Expected a RegExp instance");const t=Object.keys(tb).map(s=>(typeof e[s]=="boolean"?e[s]:r[s])?tb[s]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function oI(r,e,{timeout:t}={}){try{return xz(()=>kz(r).test(e),{timeout:t})()}catch(n){throw n}}const Tz=15,Cz=45,aI={timeout:400};function rb(r){return r.length>Cz?!1:oI(Lg.v6({exact:!0}),r,aI)}function Pz(r){return r.length>Tz?!1:oI(Lg.v4({exact:!0}),r,aI)}const nb={http:"80",https:"443",ws:"80",wss:"443"},Dz=["http","https","ws","wss"];function Rz(r,e){e=e??{};const t=e.defaultDnsType??"dns",{scheme:n,hostname:s,port:i,path:o}=Oz(r),a=[Nz(s,t),Mz(i,n),Bz(n)];o!=null&&a.push(Lz(o));const c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return De(c)}function Oz(r){const[e]=r.split(":");Dz.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:s,pathname:i,search:o}=new URL(r);if(s==null||s===""){const c=$z(e);c!=null&&(s=c),c==null&&t==="http:"&&(s="80")}let a;return i!=null&&i!==""&&i!=="/"&&(i.startsWith("/")&&(i=i.substring(1)),a=i),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:n,port:s,path:a}}function Nz(r,e){if(!(r==null||r==="")){if(Pz(r))return["ip4",r];if(rb(r))return["ip6",r];if(r[0]==="["){const t=r.substring(1,r.length-1);if(rb(t))return["ip6",t]}return[e,r]}}function Mz(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function Bz(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function Lz(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function $z(r){if(!(r==null||r===""||nb[r]==null))return nb[r]}const Uz=["https://trustless-gateway.link","https://4everland.io"],Fz=2336;function Vz(r){return r=r.toString(),{id:Fu($e.createV1(Fz,Go.digest(ie(r)))),multiaddrs:[Rz(r)]}}class Kz{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??Uz).map(t=>Vz(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}}function qz(r={}){return new Kz(r)}class Hz{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function zz(r){return new Hz(r)}class Wz extends Aw{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(Tn.encode(e.multihash.bytes),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(Tn.encode(e.multihash.bytes));if(n==null)throw new Jo;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(Tn.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(Tn.encode(e.multihash.bytes))}async*getAll(e){e?.signal?.throwIfAborted();for(const[t,n]of this.data.entries())yield{cid:$e.createV1(lf,ur(Tn.decode(t))),block:n},e?.signal?.throwIfAborted()}}Hu("blockstore:core:tiered");const jz="SHARDING";new wt(jz);Hu("datastore:core:tiered");function Gz(r){return r>=55296&&r<=56319}function Qz(r){return r>=56320&&r<=57343}var Yz=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,i=0,o,a,c=0;c<s;c+=1){if(o=t.charCodeAt(c),a=t[c],Gz(o)&&Qz(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t};function Xz(r){return r>=55296&&r<=56319}function Zz(r){return r>=56320&&r<=57343}var Jz=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,i=null,o=0;o<t;o++)s=e.charCodeAt(o),Zz(s)?i!=null&&Xz(i)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),i=s;return n},eW=Yz,tW=Jz,rW=eW.bind(null,tW),nW=rW,sW=/[\/\?<>\\:\*\|"]/g,iW=/[\x00-\x1f\x80-\x9f]/g,oW=/^\.+$/,aW=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,cW=/[\. ]+$/;function sb(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(sW,e).replace(iW,e).replace(oW,e).replace(aW,e).replace(cW,e);return nW(t,255)}var lW=function(r,e){var t=e&&e.replacement||"",n=sb(r,t);return t===""?n:sb(n,"")};const uW=Mc(lW),Cy={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function cI(r){const e="AES-GCM";let t=16;const n=12,s="SHA-256",i=16,o=32767,a=Gr.get();t*=8;async function c(h,d){const g=a.getRandomValues(new Uint8Array(i)),y=a.getRandomValues(new Uint8Array(n)),w={name:e,iv:y};typeof d=="string"&&(d=ie(d));let m;if(d.length===0){m=await a.subtle.importKey("jwk",Cy,{name:"AES-GCM"},!0,["encrypt"]);try{const k={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},N=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(k,N,{name:e,length:t},!0,["encrypt"])}catch{m=await a.subtle.importKey("jwk",Cy,{name:"AES-GCM"},!0,["encrypt"])}}else{const k={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},N=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(k,N,{name:e,length:t},!0,["encrypt"])}const _=await a.subtle.encrypt(w,m,h);return jr([g,w.iv,new Uint8Array(_)])}async function l(h,d){const g=h.subarray(0,i),y=h.subarray(i,i+n),w=h.subarray(i+n),m={name:e,iv:y};typeof d=="string"&&(d=ie(d));let _;if(d.length===0)try{const N={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},I=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);_=await a.subtle.deriveKey(N,I,{name:e,length:t},!0,["decrypt"])}catch{_=await a.subtle.importKey("jwk",Cy,{name:"AES-GCM"},!0,["decrypt"])}else{const N={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},I=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);_=await a.subtle.deriveKey(N,I,{name:e,length:t},!0,["decrypt"])}const k=await a.subtle.decrypt(m,_,w);return new Uint8Array(k)}return{encrypt:c,decrypt:l}}var sr={},$g={};$g.byteLength=fW;$g.toByteArray=gW;$g.fromByteArray=wW;var Xs=[],Yn=[],hW=typeof Uint8Array<"u"?Uint8Array:Array,Py="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var hl=0,dW=Py.length;hl<dW;++hl)Xs[hl]=Py[hl],Yn[Py.charCodeAt(hl)]=hl;Yn[45]=62;Yn[95]=63;function lI(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function fW(r){var e=lI(r),t=e[0],n=e[1];return(t+n)*3/4-n}function pW(r,e,t){return(e+t)*3/4-t}function gW(r){var e,t=lI(r),n=t[0],s=t[1],i=new hW(pW(r,n,s)),o=0,a=s>0?n-4:n,c;for(c=0;c<a;c+=4)e=Yn[r.charCodeAt(c)]<<18|Yn[r.charCodeAt(c+1)]<<12|Yn[r.charCodeAt(c+2)]<<6|Yn[r.charCodeAt(c+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return s===2&&(e=Yn[r.charCodeAt(c)]<<2|Yn[r.charCodeAt(c+1)]>>4,i[o++]=e&255),s===1&&(e=Yn[r.charCodeAt(c)]<<10|Yn[r.charCodeAt(c+1)]<<4|Yn[r.charCodeAt(c+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function yW(r){return Xs[r>>18&63]+Xs[r>>12&63]+Xs[r>>6&63]+Xs[r&63]}function mW(r,e,t){for(var n,s=[],i=e;i<t;i+=3)n=(r[i]<<16&16711680)+(r[i+1]<<8&65280)+(r[i+2]&255),s.push(yW(n));return s.join("")}function wW(r){for(var e,t=r.length,n=t%3,s=[],i=16383,o=0,a=t-n;o<a;o+=i)s.push(mW(r,o,o+i>a?a:o+i));return n===1?(e=r[t-1],s.push(Xs[e>>2]+Xs[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],s.push(Xs[e>>10]+Xs[e>>4&63]+Xs[e<<2&63]+"=")),s.join("")}var Rw={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Rw.read=function(r,e,t,n,s){var i,o,a=s*8-n-1,c=(1<<a)-1,l=c>>1,u=-7,h=t?s-1:0,d=t?-1:1,g=r[e+h];for(h+=d,i=g&(1<<-u)-1,g>>=-u,u+=a;u>0;i=i*256+r[e+h],h+=d,u-=8);for(o=i&(1<<-u)-1,i>>=-u,u+=n;u>0;o=o*256+r[e+h],h+=d,u-=8);if(i===0)i=1-l;else{if(i===c)return o?NaN:(g?-1:1)*(1/0);o=o+Math.pow(2,n),i=i-l}return(g?-1:1)*o*Math.pow(2,i-n)};Rw.write=function(r,e,t,n,s,i){var o,a,c,l=i*8-s-1,u=(1<<l)-1,h=u>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,g=n?0:i-1,y=n?1:-1,w=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=u):(o=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-o))<1&&(o--,c*=2),o+h>=1?e+=d/c:e+=d*Math.pow(2,1-h),e*c>=2&&(o++,c/=2),o+h>=u?(a=0,o=u):o+h>=1?(a=(e*c-1)*Math.pow(2,s),o=o+h):(a=e*Math.pow(2,h-1)*Math.pow(2,s),o=0));s>=8;r[t+g]=a&255,g+=y,a/=256,s-=8);for(o=o<<s|a,l+=s;l>0;r[t+g]=o&255,g+=y,o/=256,l-=8);r[t+g-y]|=w*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(r){const e=$g,t=Rw,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=u,r.SlowBuffer=T,r.INSPECT_MAX_BYTES=50;const s=2147483647;r.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:o,SharedArrayBuffer:a}=globalThis;u.TYPED_ARRAY_SUPPORT=c(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{const E=new i(1),f={foo:function(){return 42}};return Object.setPrototypeOf(f,i.prototype),Object.setPrototypeOf(E,f),E.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function l(E){if(E>s)throw new RangeError('The value "'+E+'" is invalid for option "size"');const f=new i(E);return Object.setPrototypeOf(f,u.prototype),f}function u(E,f,p){if(typeof E=="number"){if(typeof f=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return y(E)}return h(E,f,p)}u.poolSize=8192;function h(E,f,p){if(typeof E=="string")return w(E,f);if(o.isView(E))return _(E);if(E==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof E);if(Zr(E,o)||E&&Zr(E.buffer,o)||typeof a<"u"&&(Zr(E,a)||E&&Zr(E.buffer,a)))return k(E,f,p);if(typeof E=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const v=E.valueOf&&E.valueOf();if(v!=null&&v!==E)return u.from(v,f,p);const A=N(E);if(A)return A;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof E[Symbol.toPrimitive]=="function")return u.from(E[Symbol.toPrimitive]("string"),f,p);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof E)}u.from=function(E,f,p){return h(E,f,p)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function d(E){if(typeof E!="number")throw new TypeError('"size" argument must be of type number');if(E<0)throw new RangeError('The value "'+E+'" is invalid for option "size"')}function g(E,f,p){return d(E),E<=0?l(E):f!==void 0?typeof p=="string"?l(E).fill(f,p):l(E).fill(f):l(E)}u.alloc=function(E,f,p){return g(E,f,p)};function y(E){return d(E),l(E<0?0:I(E)|0)}u.allocUnsafe=function(E){return y(E)},u.allocUnsafeSlow=function(E){return y(E)};function w(E,f){if((typeof f!="string"||f==="")&&(f="utf8"),!u.isEncoding(f))throw new TypeError("Unknown encoding: "+f);const p=x(E,f)|0;let v=l(p);const A=v.write(E,f);return A!==p&&(v=v.slice(0,A)),v}function m(E){const f=E.length<0?0:I(E.length)|0,p=l(f);for(let v=0;v<f;v+=1)p[v]=E[v]&255;return p}function _(E){if(Zr(E,i)){const f=new i(E);return k(f.buffer,f.byteOffset,f.byteLength)}return m(E)}function k(E,f,p){if(f<0||E.byteLength<f)throw new RangeError('"offset" is outside of buffer bounds');if(E.byteLength<f+(p||0))throw new RangeError('"length" is outside of buffer bounds');let v;return f===void 0&&p===void 0?v=new i(E):p===void 0?v=new i(E,f):v=new i(E,f,p),Object.setPrototypeOf(v,u.prototype),v}function N(E){if(u.isBuffer(E)){const f=I(E.length)|0,p=l(f);return p.length===0||E.copy(p,0,0,f),p}if(E.length!==void 0)return typeof E.length!="number"||Kn(E.length)?l(0):m(E);if(E.type==="Buffer"&&Array.isArray(E.data))return m(E.data)}function I(E){if(E>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return E|0}function T(E){return+E!=E&&(E=0),u.alloc(+E)}u.isBuffer=function(f){return f!=null&&f._isBuffer===!0&&f!==u.prototype},u.compare=function(f,p){if(Zr(f,i)&&(f=u.from(f,f.offset,f.byteLength)),Zr(p,i)&&(p=u.from(p,p.offset,p.byteLength)),!u.isBuffer(f)||!u.isBuffer(p))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(f===p)return 0;let v=f.length,A=p.length;for(let B=0,W=Math.min(v,A);B<W;++B)if(f[B]!==p[B]){v=f[B],A=p[B];break}return v<A?-1:A<v?1:0},u.isEncoding=function(f){switch(String(f).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(f,p){if(!Array.isArray(f))throw new TypeError('"list" argument must be an Array of Buffers');if(f.length===0)return u.alloc(0);let v;if(p===void 0)for(p=0,v=0;v<f.length;++v)p+=f[v].length;const A=u.allocUnsafe(p);let B=0;for(v=0;v<f.length;++v){let W=f[v];if(Zr(W,i))B+W.length>A.length?(u.isBuffer(W)||(W=u.from(W)),W.copy(A,B)):i.prototype.set.call(A,W,B);else if(u.isBuffer(W))W.copy(A,B);else throw new TypeError('"list" argument must be an Array of Buffers');B+=W.length}return A};function x(E,f){if(u.isBuffer(E))return E.length;if(o.isView(E)||Zr(E,o))return E.byteLength;if(typeof E!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof E);const p=E.length,v=arguments.length>2&&arguments[2]===!0;if(!v&&p===0)return 0;let A=!1;for(;;)switch(f){case"ascii":case"latin1":case"binary":return p;case"utf8":case"utf-8":return yi(E).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return p*2;case"hex":return p>>>1;case"base64":return Zc(E).length;default:if(A)return v?-1:yi(E).length;f=(""+f).toLowerCase(),A=!0}}u.byteLength=x;function D(E,f,p){let v=!1;if((f===void 0||f<0)&&(f=0),f>this.length||((p===void 0||p>this.length)&&(p=this.length),p<=0)||(p>>>=0,f>>>=0,p<=f))return"";for(E||(E="utf8");;)switch(E){case"hex":return j(this,f,p);case"utf8":case"utf-8":return L(this,f,p);case"ascii":return Y(this,f,p);case"latin1":case"binary":return X(this,f,p);case"base64":return $(this,f,p);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return me(this,f,p);default:if(v)throw new TypeError("Unknown encoding: "+E);E=(E+"").toLowerCase(),v=!0}}u.prototype._isBuffer=!0;function F(E,f,p){const v=E[f];E[f]=E[p],E[p]=v}u.prototype.swap16=function(){const f=this.length;if(f%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let p=0;p<f;p+=2)F(this,p,p+1);return this},u.prototype.swap32=function(){const f=this.length;if(f%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let p=0;p<f;p+=4)F(this,p,p+3),F(this,p+1,p+2);return this},u.prototype.swap64=function(){const f=this.length;if(f%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let p=0;p<f;p+=8)F(this,p,p+7),F(this,p+1,p+6),F(this,p+2,p+5),F(this,p+3,p+4);return this},u.prototype.toString=function(){const f=this.length;return f===0?"":arguments.length===0?L(this,0,f):D.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(f){if(!u.isBuffer(f))throw new TypeError("Argument must be a Buffer");return this===f?!0:u.compare(this,f)===0},u.prototype.inspect=function(){let f="";const p=r.INSPECT_MAX_BYTES;return f=this.toString("hex",0,p).replace(/(.{2})/g,"$1 ").trim(),this.length>p&&(f+=" ... "),"<Buffer "+f+">"},n&&(u.prototype[n]=u.prototype.inspect),u.prototype.compare=function(f,p,v,A,B){if(Zr(f,i)&&(f=u.from(f,f.offset,f.byteLength)),!u.isBuffer(f))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof f);if(p===void 0&&(p=0),v===void 0&&(v=f?f.length:0),A===void 0&&(A=0),B===void 0&&(B=this.length),p<0||v>f.length||A<0||B>this.length)throw new RangeError("out of range index");if(A>=B&&p>=v)return 0;if(A>=B)return-1;if(p>=v)return 1;if(p>>>=0,v>>>=0,A>>>=0,B>>>=0,this===f)return 0;let W=B-A,Ee=v-p;const we=Math.min(W,Ee),Z=this.slice(A,B),ne=f.slice(p,v);for(let ee=0;ee<we;++ee)if(Z[ee]!==ne[ee]){W=Z[ee],Ee=ne[ee];break}return W<Ee?-1:Ee<W?1:0};function R(E,f,p,v,A){if(E.length===0)return-1;if(typeof p=="string"?(v=p,p=0):p>2147483647?p=2147483647:p<-2147483648&&(p=-2147483648),p=+p,Kn(p)&&(p=A?0:E.length-1),p<0&&(p=E.length+p),p>=E.length){if(A)return-1;p=E.length-1}else if(p<0)if(A)p=0;else return-1;if(typeof f=="string"&&(f=u.from(f,v)),u.isBuffer(f))return f.length===0?-1:C(E,f,p,v,A);if(typeof f=="number")return f=f&255,typeof i.prototype.indexOf=="function"?A?i.prototype.indexOf.call(E,f,p):i.prototype.lastIndexOf.call(E,f,p):C(E,[f],p,v,A);throw new TypeError("val must be string, number or Buffer")}function C(E,f,p,v,A){let B=1,W=E.length,Ee=f.length;if(v!==void 0&&(v=String(v).toLowerCase(),v==="ucs2"||v==="ucs-2"||v==="utf16le"||v==="utf-16le")){if(E.length<2||f.length<2)return-1;B=2,W/=2,Ee/=2,p/=2}function we(ne,ee){return B===1?ne[ee]:ne.readUInt16BE(ee*B)}let Z;if(A){let ne=-1;for(Z=p;Z<W;Z++)if(we(E,Z)===we(f,ne===-1?0:Z-ne)){if(ne===-1&&(ne=Z),Z-ne+1===Ee)return ne*B}else ne!==-1&&(Z-=Z-ne),ne=-1}else for(p+Ee>W&&(p=W-Ee),Z=p;Z>=0;Z--){let ne=!0;for(let ee=0;ee<Ee;ee++)if(we(E,Z+ee)!==we(f,ee)){ne=!1;break}if(ne)return Z}return-1}u.prototype.includes=function(f,p,v){return this.indexOf(f,p,v)!==-1},u.prototype.indexOf=function(f,p,v){return R(this,f,p,v,!0)},u.prototype.lastIndexOf=function(f,p,v){return R(this,f,p,v,!1)};function O(E,f,p,v){p=Number(p)||0;const A=E.length-p;v?(v=Number(v),v>A&&(v=A)):v=A;const B=f.length;v>B/2&&(v=B/2);let W;for(W=0;W<v;++W){const Ee=parseInt(f.substr(W*2,2),16);if(Kn(Ee))return W;E[p+W]=Ee}return W}function P(E,f,p,v){return lo(yi(f,E.length-p),E,p,v)}function M(E,f,p,v){return lo(co(f),E,p,v)}function K(E,f,p,v){return lo(Zc(f),E,p,v)}function H(E,f,p,v){return lo(ch(f,E.length-p),E,p,v)}u.prototype.write=function(f,p,v,A){if(p===void 0)A="utf8",v=this.length,p=0;else if(v===void 0&&typeof p=="string")A=p,v=this.length,p=0;else if(isFinite(p))p=p>>>0,isFinite(v)?(v=v>>>0,A===void 0&&(A="utf8")):(A=v,v=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const B=this.length-p;if((v===void 0||v>B)&&(v=B),f.length>0&&(v<0||p<0)||p>this.length)throw new RangeError("Attempt to write outside buffer bounds");A||(A="utf8");let W=!1;for(;;)switch(A){case"hex":return O(this,f,p,v);case"utf8":case"utf-8":return P(this,f,p,v);case"ascii":case"latin1":case"binary":return M(this,f,p,v);case"base64":return K(this,f,p,v);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return H(this,f,p,v);default:if(W)throw new TypeError("Unknown encoding: "+A);A=(""+A).toLowerCase(),W=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function $(E,f,p){return f===0&&p===E.length?e.fromByteArray(E):e.fromByteArray(E.slice(f,p))}function L(E,f,p){p=Math.min(E.length,p);const v=[];let A=f;for(;A<p;){const B=E[A];let W=null,Ee=B>239?4:B>223?3:B>191?2:1;if(A+Ee<=p){let we,Z,ne,ee;switch(Ee){case 1:B<128&&(W=B);break;case 2:we=E[A+1],(we&192)===128&&(ee=(B&31)<<6|we&63,ee>127&&(W=ee));break;case 3:we=E[A+1],Z=E[A+2],(we&192)===128&&(Z&192)===128&&(ee=(B&15)<<12|(we&63)<<6|Z&63,ee>2047&&(ee<55296||ee>57343)&&(W=ee));break;case 4:we=E[A+1],Z=E[A+2],ne=E[A+3],(we&192)===128&&(Z&192)===128&&(ne&192)===128&&(ee=(B&15)<<18|(we&63)<<12|(Z&63)<<6|ne&63,ee>65535&&ee<1114112&&(W=ee))}}W===null?(W=65533,Ee=1):W>65535&&(W-=65536,v.push(W>>>10&1023|55296),W=56320|W&1023),v.push(W),A+=Ee}return q(v)}const z=4096;function q(E){const f=E.length;if(f<=z)return String.fromCharCode.apply(String,E);let p="",v=0;for(;v<f;)p+=String.fromCharCode.apply(String,E.slice(v,v+=z));return p}function Y(E,f,p){let v="";p=Math.min(E.length,p);for(let A=f;A<p;++A)v+=String.fromCharCode(E[A]&127);return v}function X(E,f,p){let v="";p=Math.min(E.length,p);for(let A=f;A<p;++A)v+=String.fromCharCode(E[A]);return v}function j(E,f,p){const v=E.length;(!f||f<0)&&(f=0),(!p||p<0||p>v)&&(p=v);let A="";for(let B=f;B<p;++B)A+=Jc[E[B]];return A}function me(E,f,p){const v=E.slice(f,p);let A="";for(let B=0;B<v.length-1;B+=2)A+=String.fromCharCode(v[B]+v[B+1]*256);return A}u.prototype.slice=function(f,p){const v=this.length;f=~~f,p=p===void 0?v:~~p,f<0?(f+=v,f<0&&(f=0)):f>v&&(f=v),p<0?(p+=v,p<0&&(p=0)):p>v&&(p=v),p<f&&(p=f);const A=this.subarray(f,p);return Object.setPrototypeOf(A,u.prototype),A};function de(E,f,p){if(E%1!==0||E<0)throw new RangeError("offset is not uint");if(E+f>p)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(f,p,v){f=f>>>0,p=p>>>0,v||de(f,p,this.length);let A=this[f],B=1,W=0;for(;++W<p&&(B*=256);)A+=this[f+W]*B;return A},u.prototype.readUintBE=u.prototype.readUIntBE=function(f,p,v){f=f>>>0,p=p>>>0,v||de(f,p,this.length);let A=this[f+--p],B=1;for(;p>0&&(B*=256);)A+=this[f+--p]*B;return A},u.prototype.readUint8=u.prototype.readUInt8=function(f,p){return f=f>>>0,p||de(f,1,this.length),this[f]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(f,p){return f=f>>>0,p||de(f,2,this.length),this[f]|this[f+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(f,p){return f=f>>>0,p||de(f,2,this.length),this[f]<<8|this[f+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(f,p){return f=f>>>0,p||de(f,4,this.length),(this[f]|this[f+1]<<8|this[f+2]<<16)+this[f+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(f,p){return f=f>>>0,p||de(f,4,this.length),this[f]*16777216+(this[f+1]<<16|this[f+2]<<8|this[f+3])},u.prototype.readBigUInt64LE=bn(function(f){f=f>>>0,Vr(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&Vn(f,this.length-8);const A=p+this[++f]*2**8+this[++f]*2**16+this[++f]*2**24,B=this[++f]+this[++f]*2**8+this[++f]*2**16+v*2**24;return BigInt(A)+(BigInt(B)<<BigInt(32))}),u.prototype.readBigUInt64BE=bn(function(f){f=f>>>0,Vr(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&Vn(f,this.length-8);const A=p*2**24+this[++f]*2**16+this[++f]*2**8+this[++f],B=this[++f]*2**24+this[++f]*2**16+this[++f]*2**8+v;return(BigInt(A)<<BigInt(32))+BigInt(B)}),u.prototype.readIntLE=function(f,p,v){f=f>>>0,p=p>>>0,v||de(f,p,this.length);let A=this[f],B=1,W=0;for(;++W<p&&(B*=256);)A+=this[f+W]*B;return B*=128,A>=B&&(A-=Math.pow(2,8*p)),A},u.prototype.readIntBE=function(f,p,v){f=f>>>0,p=p>>>0,v||de(f,p,this.length);let A=p,B=1,W=this[f+--A];for(;A>0&&(B*=256);)W+=this[f+--A]*B;return B*=128,W>=B&&(W-=Math.pow(2,8*p)),W},u.prototype.readInt8=function(f,p){return f=f>>>0,p||de(f,1,this.length),this[f]&128?(255-this[f]+1)*-1:this[f]},u.prototype.readInt16LE=function(f,p){f=f>>>0,p||de(f,2,this.length);const v=this[f]|this[f+1]<<8;return v&32768?v|4294901760:v},u.prototype.readInt16BE=function(f,p){f=f>>>0,p||de(f,2,this.length);const v=this[f+1]|this[f]<<8;return v&32768?v|4294901760:v},u.prototype.readInt32LE=function(f,p){return f=f>>>0,p||de(f,4,this.length),this[f]|this[f+1]<<8|this[f+2]<<16|this[f+3]<<24},u.prototype.readInt32BE=function(f,p){return f=f>>>0,p||de(f,4,this.length),this[f]<<24|this[f+1]<<16|this[f+2]<<8|this[f+3]},u.prototype.readBigInt64LE=bn(function(f){f=f>>>0,Vr(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&Vn(f,this.length-8);const A=this[f+4]+this[f+5]*2**8+this[f+6]*2**16+(v<<24);return(BigInt(A)<<BigInt(32))+BigInt(p+this[++f]*2**8+this[++f]*2**16+this[++f]*2**24)}),u.prototype.readBigInt64BE=bn(function(f){f=f>>>0,Vr(f,"offset");const p=this[f],v=this[f+7];(p===void 0||v===void 0)&&Vn(f,this.length-8);const A=(p<<24)+this[++f]*2**16+this[++f]*2**8+this[++f];return(BigInt(A)<<BigInt(32))+BigInt(this[++f]*2**24+this[++f]*2**16+this[++f]*2**8+v)}),u.prototype.readFloatLE=function(f,p){return f=f>>>0,p||de(f,4,this.length),t.read(this,f,!0,23,4)},u.prototype.readFloatBE=function(f,p){return f=f>>>0,p||de(f,4,this.length),t.read(this,f,!1,23,4)},u.prototype.readDoubleLE=function(f,p){return f=f>>>0,p||de(f,8,this.length),t.read(this,f,!0,52,8)},u.prototype.readDoubleBE=function(f,p){return f=f>>>0,p||de(f,8,this.length),t.read(this,f,!1,52,8)};function Q(E,f,p,v,A,B){if(!u.isBuffer(E))throw new TypeError('"buffer" argument must be a Buffer instance');if(f>A||f<B)throw new RangeError('"value" argument is out of bounds');if(p+v>E.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(f,p,v,A){if(f=+f,p=p>>>0,v=v>>>0,!A){const Ee=Math.pow(2,8*v)-1;Q(this,f,p,v,Ee,0)}let B=1,W=0;for(this[p]=f&255;++W<v&&(B*=256);)this[p+W]=f/B&255;return p+v},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(f,p,v,A){if(f=+f,p=p>>>0,v=v>>>0,!A){const Ee=Math.pow(2,8*v)-1;Q(this,f,p,v,Ee,0)}let B=v-1,W=1;for(this[p+B]=f&255;--B>=0&&(W*=256);)this[p+B]=f/W&255;return p+v},u.prototype.writeUint8=u.prototype.writeUInt8=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,1,255,0),this[p]=f&255,p+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,2,65535,0),this[p]=f&255,this[p+1]=f>>>8,p+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,2,65535,0),this[p]=f>>>8,this[p+1]=f&255,p+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,4,4294967295,0),this[p+3]=f>>>24,this[p+2]=f>>>16,this[p+1]=f>>>8,this[p]=f&255,p+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,4,4294967295,0),this[p]=f>>>24,this[p+1]=f>>>16,this[p+2]=f>>>8,this[p+3]=f&255,p+4};function J(E,f,p,v,A){hr(f,v,A,E,p,7);let B=Number(f&BigInt(4294967295));E[p++]=B,B=B>>8,E[p++]=B,B=B>>8,E[p++]=B,B=B>>8,E[p++]=B;let W=Number(f>>BigInt(32)&BigInt(4294967295));return E[p++]=W,W=W>>8,E[p++]=W,W=W>>8,E[p++]=W,W=W>>8,E[p++]=W,p}function ge(E,f,p,v,A){hr(f,v,A,E,p,7);let B=Number(f&BigInt(4294967295));E[p+7]=B,B=B>>8,E[p+6]=B,B=B>>8,E[p+5]=B,B=B>>8,E[p+4]=B;let W=Number(f>>BigInt(32)&BigInt(4294967295));return E[p+3]=W,W=W>>8,E[p+2]=W,W=W>>8,E[p+1]=W,W=W>>8,E[p]=W,p+8}u.prototype.writeBigUInt64LE=bn(function(f,p=0){return J(this,f,p,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=bn(function(f,p=0){return ge(this,f,p,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(f,p,v,A){if(f=+f,p=p>>>0,!A){const we=Math.pow(2,8*v-1);Q(this,f,p,v,we-1,-we)}let B=0,W=1,Ee=0;for(this[p]=f&255;++B<v&&(W*=256);)f<0&&Ee===0&&this[p+B-1]!==0&&(Ee=1),this[p+B]=(f/W>>0)-Ee&255;return p+v},u.prototype.writeIntBE=function(f,p,v,A){if(f=+f,p=p>>>0,!A){const we=Math.pow(2,8*v-1);Q(this,f,p,v,we-1,-we)}let B=v-1,W=1,Ee=0;for(this[p+B]=f&255;--B>=0&&(W*=256);)f<0&&Ee===0&&this[p+B+1]!==0&&(Ee=1),this[p+B]=(f/W>>0)-Ee&255;return p+v},u.prototype.writeInt8=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,1,127,-128),f<0&&(f=255+f+1),this[p]=f&255,p+1},u.prototype.writeInt16LE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,2,32767,-32768),this[p]=f&255,this[p+1]=f>>>8,p+2},u.prototype.writeInt16BE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,2,32767,-32768),this[p]=f>>>8,this[p+1]=f&255,p+2},u.prototype.writeInt32LE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,4,2147483647,-2147483648),this[p]=f&255,this[p+1]=f>>>8,this[p+2]=f>>>16,this[p+3]=f>>>24,p+4},u.prototype.writeInt32BE=function(f,p,v){return f=+f,p=p>>>0,v||Q(this,f,p,4,2147483647,-2147483648),f<0&&(f=4294967295+f+1),this[p]=f>>>24,this[p+1]=f>>>16,this[p+2]=f>>>8,this[p+3]=f&255,p+4},u.prototype.writeBigInt64LE=bn(function(f,p=0){return J(this,f,p,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=bn(function(f,p=0){return ge(this,f,p,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ke(E,f,p,v,A,B){if(p+v>E.length)throw new RangeError("Index out of range");if(p<0)throw new RangeError("Index out of range")}function Ue(E,f,p,v,A){return f=+f,p=p>>>0,A||ke(E,f,p,4),t.write(E,f,p,v,23,4),p+4}u.prototype.writeFloatLE=function(f,p,v){return Ue(this,f,p,!0,v)},u.prototype.writeFloatBE=function(f,p,v){return Ue(this,f,p,!1,v)};function Ke(E,f,p,v,A){return f=+f,p=p>>>0,A||ke(E,f,p,8),t.write(E,f,p,v,52,8),p+8}u.prototype.writeDoubleLE=function(f,p,v){return Ke(this,f,p,!0,v)},u.prototype.writeDoubleBE=function(f,p,v){return Ke(this,f,p,!1,v)},u.prototype.copy=function(f,p,v,A){if(!u.isBuffer(f))throw new TypeError("argument should be a Buffer");if(v||(v=0),!A&&A!==0&&(A=this.length),p>=f.length&&(p=f.length),p||(p=0),A>0&&A<v&&(A=v),A===v||f.length===0||this.length===0)return 0;if(p<0)throw new RangeError("targetStart out of bounds");if(v<0||v>=this.length)throw new RangeError("Index out of range");if(A<0)throw new RangeError("sourceEnd out of bounds");A>this.length&&(A=this.length),f.length-p<A-v&&(A=f.length-p+v);const B=A-v;return this===f&&typeof i.prototype.copyWithin=="function"?this.copyWithin(p,v,A):i.prototype.set.call(f,this.subarray(v,A),p),B},u.prototype.fill=function(f,p,v,A){if(typeof f=="string"){if(typeof p=="string"?(A=p,p=0,v=this.length):typeof v=="string"&&(A=v,v=this.length),A!==void 0&&typeof A!="string")throw new TypeError("encoding must be a string");if(typeof A=="string"&&!u.isEncoding(A))throw new TypeError("Unknown encoding: "+A);if(f.length===1){const W=f.charCodeAt(0);(A==="utf8"&&W<128||A==="latin1")&&(f=W)}}else typeof f=="number"?f=f&255:typeof f=="boolean"&&(f=Number(f));if(p<0||this.length<p||this.length<v)throw new RangeError("Out of range index");if(v<=p)return this;p=p>>>0,v=v===void 0?this.length:v>>>0,f||(f=0);let B;if(typeof f=="number")for(B=p;B<v;++B)this[B]=f;else{const W=u.isBuffer(f)?f:u.from(f,A),Ee=W.length;if(Ee===0)throw new TypeError('The value "'+f+'" is invalid for argument "value"');for(B=0;B<v-p;++B)this[B+p]=W[B%Ee]}return this};const at={};function et(E,f,p){at[E]=class extends p{constructor(){super(),Object.defineProperty(this,"message",{value:f.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${E}]`,this.stack,delete this.name}get code(){return E}set code(A){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:A,writable:!0})}toString(){return`${this.name} [${E}]: ${this.message}`}}}et("ERR_BUFFER_OUT_OF_BOUNDS",function(E){return E?`${E} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),et("ERR_INVALID_ARG_TYPE",function(E,f){return`The "${E}" argument must be of type number. Received type ${typeof f}`},TypeError),et("ERR_OUT_OF_RANGE",function(E,f,p){let v=`The value of "${E}" is out of range.`,A=p;return Number.isInteger(p)&&Math.abs(p)>2**32?A=tt(String(p)):typeof p=="bigint"&&(A=String(p),(p>BigInt(2)**BigInt(32)||p<-(BigInt(2)**BigInt(32)))&&(A=tt(A)),A+="n"),v+=` It must be ${f}. Received ${A}`,v},RangeError);function tt(E){let f="",p=E.length;const v=E[0]==="-"?1:0;for(;p>=v+4;p-=3)f=`_${E.slice(p-3,p)}${f}`;return`${E.slice(0,p)}${f}`}function yt(E,f,p){Vr(f,"offset"),(E[f]===void 0||E[f+p]===void 0)&&Vn(f,E.length-(p+1))}function hr(E,f,p,v,A,B){if(E>p||E<f){const W=typeof f=="bigint"?"n":"";let Ee;throw f===0||f===BigInt(0)?Ee=`>= 0${W} and < 2${W} ** ${(B+1)*8}${W}`:Ee=`>= -(2${W} ** ${(B+1)*8-1}${W}) and < 2 ** ${(B+1)*8-1}${W}`,new at.ERR_OUT_OF_RANGE("value",Ee,E)}yt(v,A,B)}function Vr(E,f){if(typeof E!="number")throw new at.ERR_INVALID_ARG_TYPE(f,"number",E)}function Vn(E,f,p){throw Math.floor(E)!==E?(Vr(E,p),new at.ERR_OUT_OF_RANGE("offset","an integer",E)):f<0?new at.ERR_BUFFER_OUT_OF_BOUNDS:new at.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${f}`,E)}const Yc=/[^+/0-9A-Za-z-_]/g;function Xc(E){if(E=E.split("=")[0],E=E.trim().replace(Yc,""),E.length<2)return"";for(;E.length%4!==0;)E=E+"=";return E}function yi(E,f){f=f||1/0;let p;const v=E.length;let A=null;const B=[];for(let W=0;W<v;++W){if(p=E.charCodeAt(W),p>55295&&p<57344){if(!A){if(p>56319){(f-=3)>-1&&B.push(239,191,189);continue}else if(W+1===v){(f-=3)>-1&&B.push(239,191,189);continue}A=p;continue}if(p<56320){(f-=3)>-1&&B.push(239,191,189),A=p;continue}p=(A-55296<<10|p-56320)+65536}else A&&(f-=3)>-1&&B.push(239,191,189);if(A=null,p<128){if((f-=1)<0)break;B.push(p)}else if(p<2048){if((f-=2)<0)break;B.push(p>>6|192,p&63|128)}else if(p<65536){if((f-=3)<0)break;B.push(p>>12|224,p>>6&63|128,p&63|128)}else if(p<1114112){if((f-=4)<0)break;B.push(p>>18|240,p>>12&63|128,p>>6&63|128,p&63|128)}else throw new Error("Invalid code point")}return B}function co(E){const f=[];for(let p=0;p<E.length;++p)f.push(E.charCodeAt(p)&255);return f}function ch(E,f){let p,v,A;const B=[];for(let W=0;W<E.length&&!((f-=2)<0);++W)p=E.charCodeAt(W),v=p>>8,A=p%256,B.push(A),B.push(v);return B}function Zc(E){return e.toByteArray(Xc(E))}function lo(E,f,p,v){let A;for(A=0;A<v&&!(A+p>=f.length||A>=E.length);++A)f[A+p]=E[A];return A}function Zr(E,f){return E instanceof f||E!=null&&E.constructor!=null&&E.constructor.name!=null&&E.constructor.name===f.name}function Kn(E){return E!==E}const Jc=function(){const E="0123456789abcdef",f=new Array(256);for(let p=0;p<16;++p){const v=p*16;for(let A=0;A<16;++A)f[v+A]=E[p]+E[A]}return f}();function bn(E){return typeof BigInt>"u"?lh:E}function lh(){throw new Error("BigInt not supported")}})(sr);const o3=sr.Buffer,bW=sr.Blob,vW=sr.BlobOptions,EW=sr.Buffer,SW=sr.File,_W=sr.FileOptions,xW=sr.INSPECT_MAX_BYTES,AW=sr.SlowBuffer,IW=sr.TranscodeEncoding,kW=sr.atob,TW=sr.btoa,CW=sr.constants,PW=sr.isAscii,DW=sr.isUtf8,RW=sr.kMaxLength,OW=sr.kStringMaxLength,NW=sr.resolveObjectURL,MW=sr.transcode,BW=Object.freeze(Object.defineProperty({__proto__:null,Blob:bW,BlobOptions:vW,Buffer:EW,File:SW,FileOptions:_W,INSPECT_MAX_BYTES:xW,SlowBuffer:AW,TranscodeEncoding:IW,atob:kW,btoa:TW,constants:CW,default:o3,isAscii:PW,isUtf8:DW,kMaxLength:RW,kStringMaxLength:OW,resolveObjectURL:NW,transcode:MW},Symbol.toStringTag,{value:"Module"}));/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const LW="[object ArrayBuffer]";class le{static isArrayBuffer(e){return Object.prototype.toString.call(e)===LW}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=le.toUint8Array(e),s=le.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const s=new Uint8Array(n);let i=0;for(const o of t){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Dy="string",$W=/^[0-9a-f\s]+$/i,UW=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,FW=/^[a-zA-Z0-9-_]+$/;class ib{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){const t=le.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}}class Us{static toString(e,t=!1){const n=le.toArrayBuffer(e),s=new DataView(n);let i="";for(let o=0;o<n.byteLength;o+=2){const a=s.getUint16(o,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return n}}class ye{static isHex(e){return typeof e===Dy&&$W.test(e)}static isBase64(e){return typeof e===Dy&&UW.test(e)}static isBase64Url(e){return typeof e===Dy&&FW.test(e)}static ToString(e,t="utf8"){const n=le.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Us.toString(n,!0);case"utf16":case"utf16be":return Us.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Us.fromString(e,!0);case"utf16":case"utf16be":return Us.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=le.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return o3.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ye.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(o3.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ye.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return ib.fromString(e);case"utf16":case"utf16be":return Us.fromString(e);case"utf16le":case"usc2":return Us.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return ib.toString(e);case"utf16":case"utf16be":return Us.toString(e);case"utf16le":case"usc2":return Us.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){const t=le.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){const t=le.toUint8Array(e);let n="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ye.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);n[s/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return Us.toString(e,t)}static FromUtf16String(e,t=!1){return Us.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}ye.DEFAULT_UTF8_ENCODING="utf8";function VW(...r){const e=r.map(s=>s.byteLength).reduce((s,i)=>s+i),t=new Uint8Array(e);let n=0;return r.map(s=>new Uint8Array(s)).forEach(s=>{for(const i of s)t[n++]=i}),t.buffer}function uI(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<r.byteLength;s++)if(t[s]!==n[s])return!1;return!0}/*!
 Copyright (c) Peculiar Ventures, LLC
*/function uu(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function mc(r,e,t=-1){const n=t;let s=r,i=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(r<o){let c;if(n<0)c=new ArrayBuffer(a),i=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}const l=new Uint8Array(c);for(let u=a-1;u>=0;u--){const h=Math.pow(2,u*e);l[i-u-1]=Math.floor(s/h),s-=l[i-u-1]*h}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function a3(...r){let e=0,t=0;for(const i of r)e+=i.length;const n=new ArrayBuffer(e),s=new Uint8Array(n);for(const i of r)s.set(i,t),t+=i.length;return s}function hI(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;const n=uu(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=r[a];return i[0]&=127,uu(i,8)-n}function KW(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,a=mc(o,8,n),c=new Uint8Array(a);return c[0]|=128,a}let s=mc(e,8,n),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=a[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function qW(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function kn(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,s=new Array(n);for(let o=0;o<n;o++)s[o]="0";return s.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function n0(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Ow(r){let e=0,t=0;for(let s=0;s<r.length;s++){const i=r[s];e+=i.byteLength}const n=new Uint8Array(e);for(let s=0;s<r.length;s++){const i=r[s];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function ro(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class Ug{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Ow(this.items)}}const Sh=[new Uint8Array([1])],ob="0123456789",Ry="name",ab="valueHexView",HW="isHexOnly",zW="idBlock",WW="tagClass",jW="tagNumber",GW="isConstructed",QW="fromBER",YW="toBER",XW="local",an="",Ns=new ArrayBuffer(0),Fg=new Uint8Array(0),qd="EndOfContent",dI="OCTET STRING",fI="BIT STRING";function hi(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);const i=n[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?le.toUint8Array(i.valueHex):Fg}fromBER(n,s,i){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!ro(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Ns)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:ye.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class zc{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=an,warnings:n=[],valueBeforeDecode:s=Fg}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=le.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:ye.ToHex(this.valueBeforeDecodeView)}}}zc.NAME="baseBlock";class Xr extends zc{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Xr.NAME="valueBlock";class pI extends hi(zc){constructor({idBlock:e={}}={}){var t,n,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?le.toUint8Array(e.valueHex):Fg,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Ns}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=mc(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=i[c]|128;a[o]=i[o-1]}return a.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)n[i+1]=s[i]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){const s=le.toUint8Array(e);if(!ro(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;const d=new Uint8Array(u);for(let g=0;g<l.length;g++)d[g]=l[g];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=i[c]&127;const h=new Uint8Array(c);for(let d=0;d<c;d++)h[d]=l[d];l=this.valueHexView=new Uint8Array(c),l.set(h),this.blockLength<=9?this.tagNumber=uu(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}pI.NAME="identificationBlock";class gI extends zc{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){const s=le.toUint8Array(e);if(!ro(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=s.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=uu(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const s=mc(this.length,8);if(s.byteLength>127)return this.error="Too big length",Ns;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)n[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}gI.NAME="lengthBlock";const pe={};class xr extends zc{constructor({name:e=an,optional:t=!1,primitiveSchema:n,...s}={},i){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new pI(s),this.lenBlock=new gI(s),this.valueBlock=i?new i(s):new Xr(s)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const n=t||new Ug;t||yI(this);const s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(i)}return t?Ns:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():ye.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=ye.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return qW(t,n)}}xr.NAME="BaseBlock";function yI(r){var e;if(r instanceof pe.Constructed)for(const t of r.valueBlock.value)yI(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class Nw extends xr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=an,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}Nw.NAME="BaseStringBlock";class mI extends hi(Xr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}mI.NAME="PrimitiveValueBlock";var wI;class kf extends xr{constructor(e={}){super(e,mI),this.idBlock.isConstructed=!1}}wI=kf;pe.Primitive=wI;kf.NAME="PRIMITIVE";function ZW(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function Qu(r,e=0,t=r.length){const n=e;let s=new xr({},Xr);const i=new zc;if(!ro(i,r,e,t))return s.error=i.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=a,t-=s.idBlock.blockLength,a=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=a,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=xr;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=pe.EndOfContent;break;case 1:c=pe.Boolean;break;case 2:c=pe.Integer;break;case 3:c=pe.BitString;break;case 4:c=pe.OctetString;break;case 5:c=pe.Null;break;case 6:c=pe.ObjectIdentifier;break;case 10:c=pe.Enumerated;break;case 12:c=pe.Utf8String;break;case 13:c=pe.RelativeObjectIdentifier;break;case 14:c=pe.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=pe.Sequence;break;case 17:c=pe.Set;break;case 18:c=pe.NumericString;break;case 19:c=pe.PrintableString;break;case 20:c=pe.TeletexString;break;case 21:c=pe.VideotexString;break;case 22:c=pe.IA5String;break;case 23:c=pe.UTCTime;break;case 24:c=pe.GeneralizedTime;break;case 25:c=pe.GraphicString;break;case 26:c=pe.VisibleString;break;case 27:c=pe.GeneralString;break;case 28:c=pe.UniversalString;break;case 29:c=pe.CharacterString;break;case 30:c=pe.BmpString;break;case 31:c=pe.DATE;break;case 32:c=pe.TimeOfDay;break;case 33:c=pe.DateTime;break;case 34:c=pe.Duration;break;default:{const l=s.idBlock.isConstructed?new pe.Constructed:new pe.Primitive;l.idBlock=s.idBlock,l.lenBlock=s.lenBlock,l.warnings=s.warnings,s=l}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?pe.Constructed:pe.Primitive}return s=ZW(s,c),a=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:a,result:s}}function Ui(r){if(!r.byteLength){const e=new xr({},Xr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Qu(le.toUint8Array(r).slice(),0,r.byteLength)}function JW(r,e){return r?1:e}class Uo extends Xr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const s=le.toUint8Array(e);if(!ro(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;JW(this.isIndefiniteForm,n)>0;){const o=Qu(s,i,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===qd)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===qd?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new Ug;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?Ns:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Uo.NAME="ConstructedValueBlock";var bI;class Wr extends xr{constructor(e={}){super(e,Uo),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}bI=Wr;pe.Constructed=bI;Wr.NAME="CONSTRUCTED";class vI extends Xr{fromBER(e,t,n){return t}toBER(e){return Ns}}vI.override="EndOfContentValueBlock";var EI;class Mw extends xr{constructor(e={}){super(e,vI),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}EI=Mw;pe.EndOfContent=EI;Mw.NAME=qd;var SI;class Gi extends xr{constructor(e={}){super(e,Xr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}SI=Gi;pe.Null=SI;Gi.NAME="NULL";class _I extends hi(Xr){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=le.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const s=le.toUint8Array(e);return ro(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,hI.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}_I.NAME="BooleanValueBlock";var xI;let Vg=class extends xr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,_I),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};xI=Vg;pe.Boolean=xI;Vg.NAME="BOOLEAN";class AI extends hi(Uo){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Uo.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===qd){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==dI)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?Uo.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}AI.NAME="OctetStringValueBlock";var Bw;let As=class extends xr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},AI),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){const o=Qu(i,0,i.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Wr.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=ye.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof Bw&&e.push(t.valueBlock.valueHexView);return le.concat(e)}};Bw=As;pe.OctetString=Bw;As.NAME=dI;class II extends hi(Uo){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=Uo.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(const a of this.value){const c=a.constructor.NAME;if(c===qd){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==fI)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return s}const i=le.toUint8Array(e);if(!ro(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=Qu(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return Uo.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Ns;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}II.NAME="BitStringValueBlock";var kI;let sc=class extends xr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},II),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Wr.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),s=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}};kI=sc;pe.BitString=kI;sc.NAME=fI;var TI;function ej(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e);let i=n.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let l=0;const u=c<o?o:c;let h=0;for(let d=u;d>=0;d--,h++){switch(!0){case h<a.length:l=i[o-h]+a[c-h]+t[0];break;default:l=i[o-h]+t[0]}switch(t[0]=l/10,!0){case h>=i.length:i=a3(new Uint8Array([l%10]),i);break;default:i[o-h]=l%10}}return t[0]>0&&(i=a3(t,i)),i}function cb(r){if(r>=Sh.length)for(let e=Sh.length;e<=r;e++){const t=new Uint8Array([0]);let n=Sh[e-1].slice(0);for(let s=n.length-1;s>=0;s--){const i=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=i[0]/10,n[s]=i[0]%10}t[0]>0&&(n=a3(t,n)),Sh.push(n)}return Sh[r]}function tj(r,e){let t=0;const n=new Uint8Array(r),s=new Uint8Array(e),i=n.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let l,u=0;for(let h=c;h>=0;h--,u++)switch(l=i[o-u]-a[c-u]-t,!0){case l<0:t=1,i[o-u]=l+10;break;default:t=0,i[o-u]=l}if(t>0)for(let h=o-c+1;h>=0;h--,u++)if(l=i[o-u]-t,l<0)t=1,i[o-u]=l+10;else{t=0,i[o-u]=l;break}return i.slice()}class Lw extends hi(Xr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=hI.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(KW(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){const i=this.fromBER(e,t,n);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,s;const i=this.valueHexView;let o="",a=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let l=0;l<8;l++){if((s&1)===1)switch(n){case e:t=tj(cb(n),t),o="-";break;default:t=ej(t,cb(n))}n++,s>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=ob.charAt(t[c]));return a===!1&&(o+=ob.charAt(0)),o}}TI=Lw;Lw.NAME="IntegerValueBlock";Object.defineProperty(TI.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Jh;class Fi extends xr{constructor(e={}){super(e,Lw),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return n0(),BigInt(this.valueBlock.toString())}static fromBigInt(e){n0();const t=BigInt(e),n=new Ug,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(ye.FromHex(s));if(t<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${ye.ToHex(a)}`)+t,u=le.toUint8Array(ye.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new Jh({valueHex:n.final()})}convertToDER(){const e=new Jh({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Jh({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}Jh=Fi;pe.Integer=Jh;Fi.NAME="INTEGER";var CI;class Kg extends Fi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}CI=Kg;pe.Enumerated=CI;Kg.NAME="ENUMERATED";class c3 extends hi(Xr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const s=le.toUint8Array(e);if(!ro(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=uu(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){n0();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=mc(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Ns;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n}toString(){let e="";if(this.isHexOnly)e=ye.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}c3.NAME="sidBlock";class PI extends Xr{constructor({value:e=an,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new c3;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,Ns;t.push(s)}return Ow(t)}fromString(e){this.value=[];let t=0,n=0,s="",i=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+a,i=!1}else{const o=new c3;if(s>Number.MAX_SAFE_INTEGER){n0();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}PI.NAME="ObjectIdentifierValueBlock";var DI;class Pi extends xr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,PI),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}DI=Pi;pe.ObjectIdentifier=DI;Pi.NAME="OBJECT IDENTIFIER";class l3 extends hi(zc){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const s=le.toUint8Array(e);if(!ro(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=uu(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=mc(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Ns;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=ye.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}l3.NAME="relativeSidBlock";class RI extends Xr{constructor({value:e=an,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new l3;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const n=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,Ns;n.push(i)}return Ow(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;const i=new l3;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}RI.NAME="RelativeObjectIdentifierValueBlock";var OI;class $w extends xr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,RI),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}OI=$w;pe.RelativeObjectIdentifier=OI;$w.NAME="RelativeObjectIdentifier";var NI;class Yt extends Wr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}NI=Yt;pe.Sequence=NI;Yt.NAME="SEQUENCE";var MI;let ni=class extends Wr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};MI=ni;pe.Set=MI;ni.NAME="SET";class BI extends hi(Xr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=an}toJSON(){return{...super.toJSON(),value:this.value}}}BI.NAME="StringValueBlock";class LI extends BI{}LI.NAME="SimpleStringValueBlock";class Ln extends Nw{constructor({...e}={}){super(e,LI)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,le.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}}Ln.NAME="SIMPLE STRING";class $I extends Ln{fromBuffer(e){this.valueBlock.valueHexView=le.toUint8Array(e);try{this.valueBlock.value=ye.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=ye.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(ye.FromUtf8String(e)),this.valueBlock.value=e}}$I.NAME="Utf8StringValueBlock";var UI;class no extends $I{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}UI=no;pe.Utf8String=UI;no.NAME="UTF8String";class FI extends Ln{fromBuffer(e){this.valueBlock.value=ye.ToUtf16String(e),this.valueBlock.valueHexView=le.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(ye.FromUtf16String(e))}}FI.NAME="BmpStringValueBlock";var VI;class qg extends FI{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}VI=qg;pe.BmpString=VI;qg.NAME="BMPString";class KI extends Ln{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=mc(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)n[s*4+c+a]=o[c]}this.valueBlock.value=e}}KI.NAME="UniversalStringValueBlock";var qI;class Hg extends KI{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}qI=Hg;pe.UniversalString=qI;Hg.NAME="UniversalString";var HI;class zg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}HI=zg;pe.NumericString=HI;zg.NAME="NumericString";var zI;class Wg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}zI=Wg;pe.PrintableString=zI;Wg.NAME="PrintableString";var WI;class jg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}WI=jg;pe.TeletexString=WI;jg.NAME="TeletexString";var jI;class Gg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}jI=Gg;pe.VideotexString=jI;Gg.NAME="VideotexString";var GI;class Qg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}GI=Qg;pe.IA5String=GI;Qg.NAME="IA5String";var QI;class Yg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}QI=Yg;pe.GraphicString=QI;Yg.NAME="GraphicString";var YI;class Tf extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}YI=Tf;pe.VisibleString=YI;Tf.NAME="VisibleString";var XI;class Xg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}XI=Xg;pe.GeneralString=XI;Xg.NAME="GeneralString";var ZI;class Zg extends Ln{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}ZI=Zg;pe.CharacterString=ZI;Zg.NAME="CharacterString";var JI;class Cf extends Tf{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,le.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=kn(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=kn(this.month,2),t[2]=kn(this.day,2),t[3]=kn(this.hour,2),t[4]=kn(this.minute,2),t[5]=kn(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}JI=Cf;pe.UTCTime=JI;Cf.NAME="UTCTime";var ek;class Jg extends Cf{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",i=0,o,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,d=n.indexOf("+"),g="";if(d===-1&&(d=n.indexOf("-"),h=-1),d!==-1){if(g=n.substring(d+1),n=n.substring(0,d),g.length!==2&&g.length!==4)throw new Error("Wrong input string for conversion");let y=parseInt(g.substring(0,2),10);if(isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*y,g.length===4){if(y=parseInt(g.substring(2,4),10),isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");c=h*y}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){const h=new Number(`0${n.substring(l)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");i=h.valueOf(),s=n.substring(0,l)}else s=n;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*i;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*i;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const h=1e3*i;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(s);if(u===null)throw new Error("Wrong input string for conversion");for(let h=1;h<u.length;h++)switch(h){case 1:this.year=parseInt(u[h],10);break;case 2:this.month=parseInt(u[h],10);break;case 3:this.day=parseInt(u[h],10);break;case 4:this.hour=parseInt(u[h],10)+a;break;case 5:this.minute=parseInt(u[h],10)+c;break;case 6:this.second=parseInt(u[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(kn(this.year,4)),t.push(kn(this.month,2)),t.push(kn(this.day,2)),t.push(kn(this.hour,2)),t.push(kn(this.minute,2)),t.push(kn(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(kn(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}ek=Jg;pe.GeneralizedTime=ek;Jg.NAME="GeneralizedTime";var tk;class Uw extends no{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}tk=Uw;pe.DATE=tk;Uw.NAME="DATE";var rk;class Fw extends no{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}rk=Fw;pe.TimeOfDay=rk;Fw.NAME="TimeOfDay";var nk;class Vw extends no{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}nk=Vw;pe.DateTime=nk;Vw.NAME="DateTime";var sk;class Kw extends no{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}sk=Kw;pe.Duration=sk;Kw.NAME="Duration";var ik;class qw extends no{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}ik=qw;pe.TIME=ik;qw.NAME="TIME";class wc{constructor({name:e=an,optional:t=!1}={}){this.name=e,this.optional=t}}class Hw extends wc{constructor({value:e=[],...t}={}){super(t),this.value=e}}class s0 extends wc{constructor({value:e=new wc,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}}class rj{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=le.toUint8Array(e)}constructor({data:e=Fg}={}){this.dataView=le.toUint8Array(e)}fromBER(e,t,n){const s=t+n;return this.dataView=le.toUint8Array(e).subarray(t,s),s}toBER(e){return this.dataView.slice().buffer}}function Ro(r,e,t){if(t instanceof Hw){for(const i of t.value)if(Ro(r,e,i).verified)return{verified:!0,result:r};{const i={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(Ry)&&(i.name=t.name),i}}if(t instanceof wc)return t.hasOwnProperty(Ry)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(zW in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(QW in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(YW in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(WW)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(jW)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(GW)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(HW in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(ab in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const i=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(i.length!==o.length)return{verified:!1,result:r};for(let a=0;a<i.length;a++)if(i[a]!==o[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&(r[t.name]=e)),t instanceof pe.Constructed){let i=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof s0&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-i>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof s0){if(o=Ro(r,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&delete r[t.name]),o;if(Ry in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};XW in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=Ro(r,e.valueBlock.value[c-i],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&delete r[t.name]),o;if(o.verified===!1){const c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&ab in e.valueBlock){const i=Qu(e.valueBlock.valueHexView);if(i.offset===-1){const o={verified:!1,result:i.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,an),t.name&&(delete r[t.name],o.name=t.name)),o}return Ro(r,i.result,t.primitiveSchema)}return{verified:!0,result:r}}function nj(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=Qu(le.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:Ro(t.result,t.result,e)}const ok=Object.freeze(Object.defineProperty({__proto__:null,Any:wc,BaseBlock:xr,BaseStringBlock:Nw,BitString:sc,BmpString:qg,Boolean:Vg,CharacterString:Zg,Choice:Hw,Constructed:Wr,DATE:Uw,DateTime:Vw,Duration:Kw,EndOfContent:Mw,Enumerated:Kg,GeneralString:Xg,GeneralizedTime:Jg,GraphicString:Yg,HexBlock:hi,IA5String:Qg,Integer:Fi,Null:Gi,NumericString:zg,ObjectIdentifier:Pi,OctetString:As,Primitive:kf,PrintableString:Wg,RawData:rj,RelativeObjectIdentifier:$w,Repeated:s0,Sequence:Yt,Set:ni,TIME:qw,TeletexString:jg,TimeOfDay:Fw,UTCTime:Cf,UniversalString:Hg,Utf8String:no,ValueBlock:Xr,VideotexString:Gg,ViewWriter:Ug,VisibleString:Tf,compareSchema:Ro,fromBER:Ui,verifySchema:nj},Symbol.toStringTag,{value:"Module"})),sj=16,u3=32,h3=1e4;async function e2(r,e){const n=await cI().encrypt(r,e);return ss.encode(n)}async function lb(r,e,t){if(r.type==="RSA")return cj(r,e,t);if(r.type==="Ed25519")return ij(r,e,t);if(r.type==="secp256k1")return oj(r,e,t);if(r.type==="ECDSA")return aj(r,e,t);throw new Lu}async function ij(r,e,t="libp2p-key"){if(t==="libp2p-key")return e2(yf(r),e);throw new re(`export format '${t}' is not supported`)}async function oj(r,e,t="libp2p-key"){if(t==="libp2p-key")return e2(yf(r),e);throw new re("Export format is not supported")}async function aj(r,e,t="libp2p-key"){if(t==="libp2p-key")return e2(yf(r),e);throw new re(`export format '${t}' is not supported`)}async function cj(r,e,t="pkcs-8"){if(t==="pkcs-8")return lj(r,e);if(t==="libp2p-key")return e2(yf(r),e);throw new re("Export format is not supported")}async function lj(r,e){const t=Gr.get(),s=new Yt({value:[new Fi({value:0}),new Yt({value:[new Pi({value:"1.2.840.113549.1.1.1"}),new Gi]}),new As({valueHex:r.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=Yo(sj),a=await ax(ew,e,o,{c:h3,dkLen:u3}),c=Yo(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,i),h=new Yt({value:[new As({valueHex:o}),new Fi({value:h3}),new Fi({value:u3}),new Yt({value:[new Pi({value:"1.2.840.113549.2.11"}),new Gi]})]}),d=new Yt({value:[new Pi({value:"1.2.840.113549.1.5.13"}),new Yt({value:[new Yt({value:[new Pi({value:"1.2.840.113549.1.5.12"}),h]}),new Yt({value:[new Pi({value:"2.16.840.1.101.3.4.1.42"}),new As({valueHex:c})]})]})]}),y=new Yt({value:[d,new As({valueHex:u})]}).toBER(),w=new Uint8Array(y,0,y.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...se(w,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function ub(r,e){try{const t=await uj(r,e);return XM(t)}catch{}if(!r.includes("BEGIN"))throw new re("Encrypted key was not a libp2p-key or a PEM file");return hj(r,e)}async function uj(r,e){const t=ss.decode(r);return cI().decrypt(t,e)}async function hj(r,e){const t=Gr.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=ie(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ui(i),{iv:a,salt:c,iterations:l,keySize:u,cipherText:h}=dj(o),d=await ax(ew,e,c,{c:l,dkLen:u}),g=await t.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),y=ed(await t.subtle.decrypt({name:"AES-CBC",iv:a},g,h)),{result:w}=Ui(y);n=hb(w)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const i=ie(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ui(i);n=hb(o)}else throw new re("Could not parse private key from PEM data");const s=Vm(n);if(s.type!=="RSA")throw new re("Could not parse RSA private key from PEM data");return s}function dj(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new re("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new re("Only pkcs5PBKDF2 key derivation functions are supported");const i=n.valueBlock.value[1],o=ed(i.valueBlock.value[0].getValue());let a=h3,c=u3;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new re("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new re("Only AES-CBC encryption schemes are supported")}}}}const h=ed(l.valueBlock.value[1].getValue());return{cipherText:ed(r.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:h}}function hb(r){return ed(r.valueBlock.value[2].getValue())}function ed(r){return new Uint8Array(r,0,r.byteLength)}const fj="/pkcs8/",d3="/info/",_h=new WeakMap,Sa={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Oy={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function dl(r){return r==null||typeof r!="string"?!1:r===uW(r.trim())&&r.length>0}async function pr(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function _a(r){return new wt(fj+r)}function fl(r){return new wt(d3+r)}async function pj(r){const e=yf(r),t=await fn.digest(e);return Xt.encode(t.bytes).substring(1)}class gj{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=Q6(Oy,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Sa.minKeyLength)throw new Error(`dek.keyLength must be least ${Sa.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Sa.minSaltLength)throw new Error(`dek.saltLength must be least ${Sa.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Sa.minIterationCount)throw new Error(`dek.iterationCount must be least ${Sa.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?i7(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";_h.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[lr]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},Oy),t=Math.ceil(Sa.minSaltLength/3)*3;return e.dek.salt=se(Yo(t),"base64"),e}static get options(){return Oy}async findKeyByName(e){if(!dl(e))throw await pr(),new re(`Invalid key name '${e}'`);const t=fl(e);try{const n=await this.components.datastore.get(t);return JSON.parse(se(n))}catch(n){throw await pr(),this.log.error(n),new Zt(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:d3};for await(const n of this.components.datastore.query(t)){const s=JSON.parse(se(n.value));if(s.id===e)return s}throw new re(`Key with id '${e}' does not exist.`)}catch(t){throw await pr(),t}}async importKey(e,t){if(!dl(e))throw await pr(),new re(`Invalid key name '${e}'`);if(t==null)throw await pr(),new re("Key is required");const n=_a(e);if(await this.components.datastore.has(n))throw await pr(),new re(`Key '${e}' already exists`);let i,o;try{i=await pj(t);const l=_h.get(this);if(l==null)throw new re("dek missing");const u=l.dek;o=await lb(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await pr(),l}const a={name:e,id:i},c=this.components.datastore.batch();return c.put(n,ie(o)),c.put(fl(e),ie(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!dl(e))throw await pr(),new re(`Invalid key name '${e}'`);const t=_a(e);try{const n=await this.components.datastore.get(t),s=se(n),i=_h.get(this);if(i==null)throw new re("dek missing");const o=i.dek;return await ub(s,o)}catch(n){throw await pr(),n}}async removeKey(e){if(!dl(e)||e===this.self)throw await pr(),new re(`Invalid key name '${e}'`);const t=_a(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(fl(e)),await s.commit(),n}async listKeys(){const e={prefix:d3},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(se(n.value)));return t}async renameKey(e,t){if(!dl(e)||e===this.self)throw await pr(),new re(`Invalid old key name '${e}'`);if(!dl(t)||t===this.self)throw await pr(),new re(`Invalid new key name '${t}'`);const n=_a(e),s=_a(t),i=fl(e),o=fl(t);if(await this.components.datastore.has(s))throw await pr(),new re(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),l=await this.components.datastore.get(i),u=JSON.parse(se(l));u.name=t;const h=this.components.datastore.batch();return h.put(s,c),h.put(o,ie(JSON.stringify(u))),h.delete(n),h.delete(i),await h.commit(),u}catch(c){throw await pr(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await pr(),new re(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await pr(),new re(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await pr(),new re(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=_h.get(this);if(n==null)throw new re("dek missing");const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?i7(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";_h.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(_a(a.name)),l=se(c),u=await ub(l,s),h=i.toString(),d=await lb(u,h,u.type==="RSA"?"pkcs-8":"libp2p-key"),g=this.components.datastore.batch(),y={name:a.name,id:a.id};g.put(_a(a.name),ie(d)),g.put(fl(a.name),ie(JSON.stringify(y))),await g.commit()}this.log("keychain reconstructed")}}function ak(r={}){return e=>new gj(e,r)}async function yj(r,e={}){const t=e.selfKey??"self",n=ak(e)({datastore:r,logger:Eg()});let s;return await r.has(new wt(`/pkcs8/${t}`))?s=await n.exportKey(t):(s=await mg(e.keyType??"Ed25519"),await n.importKey(t,s)),s}function db(){const r=Qe();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function mj(){const r=db(),e=db();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const Hd=65535,fb=Hd-16,Pf=!!globalThis.process?.env?.DUMP_SESSION_KEYS;/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function ck(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function f3(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function Ny(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function cn(r,...e){if(!ck(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function pb(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function wj(r,e){cn(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Fo(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function hu(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function bj(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}const vj=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Ej(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function p3(r){if(typeof r=="string")r=Ej(r);else if(ck(r))r=g3(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function Sj(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function _j(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const xj=(r,e)=>{function t(n,...s){if(cn(n),!vj)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){const u=s[0];if(!u)throw new Error("nonce / iv required");r.varSizeNonce?cn(u):cn(u,r.nonceLength)}const i=r.tagLength;i&&s[1]!==void 0&&cn(s[1]);const o=e(n,...s),a=(u,h)=>{if(h!==void 0){if(u!==2)throw new Error("cipher output not supported");cn(h)}};let c=!1;return{encrypt(u,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,cn(u),a(o.encrypt.length,h),o.encrypt(u,h)},decrypt(u,h){if(cn(u),i&&u.length<i)throw new Error("invalid ciphertext length: smaller than tagLength="+i);return a(o.decrypt.length,h),o.decrypt(u,h)}}}return Object.assign(t,r),t};function gb(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!Ij(e))throw new Error("invalid output, must be aligned");return e}function yb(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=4,l=0;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function Aj(r,e,t){f3(t);const n=new Uint8Array(16),s=bj(n);return yb(s,0,BigInt(e),t),yb(s,8,BigInt(r),t),n}function Ij(r){return r.byteOffset%4===0}function g3(r){return Uint8Array.from(r)}const lk=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),kj=lk("expand 16-byte k"),Tj=lk("expand 32-byte k"),Cj=Fo(kj),Pj=Fo(Tj);function rt(r,e){return r<<e|r>>>32-e}function y3(r){return r.byteOffset%4===0}const S1=64,Dj=16,uk=2**32-1,mb=new Uint32Array;function Rj(r,e,t,n,s,i,o,a){const c=s.length,l=new Uint8Array(S1),u=Fo(l),h=y3(s)&&y3(i),d=h?Fo(s):mb,g=h?Fo(i):mb;for(let y=0;y<c;o++){if(r(e,t,n,u,o,a),o>=uk)throw new Error("arx: counter overflow");const w=Math.min(S1,c-y);if(h&&w===S1){const m=y/4;if(y%4!==0)throw new Error("arx: invalid block position");for(let _=0,k;_<Dj;_++)k=m+_,g[k]=d[k]^u[_];y+=S1;continue}for(let m=0,_;m<w;m++)_=y+m,i[_]=s[_]^l[m];y+=w}}function Oj(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:i,rounds:o}=Sj({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return Ny(s),Ny(o),f3(i),f3(t),(a,c,l,u,h=0)=>{cn(a),cn(c),cn(l);const d=l.length;if(u===void 0&&(u=new Uint8Array(d)),cn(u),Ny(h),h<0||h>=uk)throw new Error("arx: counter overflow");if(u.length<d)throw new Error(`arx: output (${u.length}) is shorter than data (${d})`);const g=[];let y=a.length,w,m;if(y===32)g.push(w=g3(a)),m=Pj;else if(y===16&&t)w=new Uint8Array(32),w.set(a),w.set(a,16),m=Cj,g.push(w);else throw new Error(`arx: invalid 32-byte key, got length=${y}`);y3(c)||g.push(c=g3(c));const _=Fo(w);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(m,_,Fo(c.subarray(0,16)),_),c=c.subarray(16)}const k=16-s;if(k!==c.length)throw new Error(`arx: nonce must be ${k} or 16 bytes`);if(k!==12){const I=new Uint8Array(12);I.set(c,i?0:12-c.length),c=I,g.push(c)}const N=Fo(c);return Rj(r,m,_,N,l,u,h,o),hu(...g),u}}const gr=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class Nj{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=p3(e),cn(e,32);const t=gr(e,0),n=gr(e,2),s=gr(e,4),i=gr(e,6),o=gr(e,8),a=gr(e,10),c=gr(e,12),l=gr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=gr(e,16+2*u)}process(e,t,n=!1){const s=n?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],h=o[4],d=o[5],g=o[6],y=o[7],w=o[8],m=o[9],_=gr(e,t+0),k=gr(e,t+2),N=gr(e,t+4),I=gr(e,t+6),T=gr(e,t+8),x=gr(e,t+10),D=gr(e,t+12),F=gr(e,t+14);let R=i[0]+(_&8191),C=i[1]+((_>>>13|k<<3)&8191),O=i[2]+((k>>>10|N<<6)&8191),P=i[3]+((N>>>7|I<<9)&8191),M=i[4]+((I>>>4|T<<12)&8191),K=i[5]+(T>>>1&8191),H=i[6]+((T>>>14|x<<2)&8191),$=i[7]+((x>>>11|D<<5)&8191),L=i[8]+((D>>>8|F<<8)&8191),z=i[9]+(F>>>5|s),q=0,Y=q+R*a+C*(5*m)+O*(5*w)+P*(5*y)+M*(5*g);q=Y>>>13,Y&=8191,Y+=K*(5*d)+H*(5*h)+$*(5*u)+L*(5*l)+z*(5*c),q+=Y>>>13,Y&=8191;let X=q+R*c+C*a+O*(5*m)+P*(5*w)+M*(5*y);q=X>>>13,X&=8191,X+=K*(5*g)+H*(5*d)+$*(5*h)+L*(5*u)+z*(5*l),q+=X>>>13,X&=8191;let j=q+R*l+C*c+O*a+P*(5*m)+M*(5*w);q=j>>>13,j&=8191,j+=K*(5*y)+H*(5*g)+$*(5*d)+L*(5*h)+z*(5*u),q+=j>>>13,j&=8191;let me=q+R*u+C*l+O*c+P*a+M*(5*m);q=me>>>13,me&=8191,me+=K*(5*w)+H*(5*y)+$*(5*g)+L*(5*d)+z*(5*h),q+=me>>>13,me&=8191;let de=q+R*h+C*u+O*l+P*c+M*a;q=de>>>13,de&=8191,de+=K*(5*m)+H*(5*w)+$*(5*y)+L*(5*g)+z*(5*d),q+=de>>>13,de&=8191;let Q=q+R*d+C*h+O*u+P*l+M*c;q=Q>>>13,Q&=8191,Q+=K*a+H*(5*m)+$*(5*w)+L*(5*y)+z*(5*g),q+=Q>>>13,Q&=8191;let J=q+R*g+C*d+O*h+P*u+M*l;q=J>>>13,J&=8191,J+=K*c+H*a+$*(5*m)+L*(5*w)+z*(5*y),q+=J>>>13,J&=8191;let ge=q+R*y+C*g+O*d+P*h+M*u;q=ge>>>13,ge&=8191,ge+=K*l+H*c+$*a+L*(5*m)+z*(5*w),q+=ge>>>13,ge&=8191;let ke=q+R*w+C*y+O*g+P*d+M*h;q=ke>>>13,ke&=8191,ke+=K*u+H*l+$*c+L*a+z*(5*m),q+=ke>>>13,ke&=8191;let Ue=q+R*m+C*w+O*y+P*g+M*d;q=Ue>>>13,Ue&=8191,Ue+=K*h+H*u+$*l+L*c+z*a,q+=Ue>>>13,Ue&=8191,q=(q<<2)+q|0,q=q+Y|0,Y=q&8191,q=q>>>13,X+=q,i[0]=Y,i[1]=X,i[2]=j,i[3]=me,i[4]=de,i[5]=Q,i[6]=J,i[7]=ge,i[8]=ke,i[9]=Ue}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;hu(n)}update(e){pb(this),e=p3(e),cn(e);const{buffer:t,blockLen:n}=this,s=e.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);if(o===n){for(;n<=s-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){hu(this.h,this.r,this.buffer,this.pad)}digestInto(e){pb(this),wj(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)e[i++]=n[o]>>>0,e[i++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function Mj(r){const e=(n,s)=>r(s).update(p3(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const Bj=Mj(r=>new Nj(r));function Lj(r,e,t,n,s,i=20){let o=r[0],a=r[1],c=r[2],l=r[3],u=e[0],h=e[1],d=e[2],g=e[3],y=e[4],w=e[5],m=e[6],_=e[7],k=s,N=t[0],I=t[1],T=t[2],x=o,D=a,F=c,R=l,C=u,O=h,P=d,M=g,K=y,H=w,$=m,L=_,z=k,q=N,Y=I,X=T;for(let me=0;me<i;me+=2)x=x+C|0,z=rt(z^x,16),K=K+z|0,C=rt(C^K,12),x=x+C|0,z=rt(z^x,8),K=K+z|0,C=rt(C^K,7),D=D+O|0,q=rt(q^D,16),H=H+q|0,O=rt(O^H,12),D=D+O|0,q=rt(q^D,8),H=H+q|0,O=rt(O^H,7),F=F+P|0,Y=rt(Y^F,16),$=$+Y|0,P=rt(P^$,12),F=F+P|0,Y=rt(Y^F,8),$=$+Y|0,P=rt(P^$,7),R=R+M|0,X=rt(X^R,16),L=L+X|0,M=rt(M^L,12),R=R+M|0,X=rt(X^R,8),L=L+X|0,M=rt(M^L,7),x=x+O|0,X=rt(X^x,16),$=$+X|0,O=rt(O^$,12),x=x+O|0,X=rt(X^x,8),$=$+X|0,O=rt(O^$,7),D=D+P|0,z=rt(z^D,16),L=L+z|0,P=rt(P^L,12),D=D+P|0,z=rt(z^D,8),L=L+z|0,P=rt(P^L,7),F=F+M|0,q=rt(q^F,16),K=K+q|0,M=rt(M^K,12),F=F+M|0,q=rt(q^F,8),K=K+q|0,M=rt(M^K,7),R=R+C|0,Y=rt(Y^R,16),H=H+Y|0,C=rt(C^H,12),R=R+C|0,Y=rt(Y^R,8),H=H+Y|0,C=rt(C^H,7);let j=0;n[j++]=o+x|0,n[j++]=a+D|0,n[j++]=c+F|0,n[j++]=l+R|0,n[j++]=u+C|0,n[j++]=h+O|0,n[j++]=d+P|0,n[j++]=g+M|0,n[j++]=y+K|0,n[j++]=w+H|0,n[j++]=m+$|0,n[j++]=_+L|0,n[j++]=k+z|0,n[j++]=N+q|0,n[j++]=I+Y|0,n[j++]=T+X|0}const $j=Oj(Lj,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Uj=new Uint8Array(16),wb=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(Uj.subarray(t))},Fj=new Uint8Array(32);function bb(r,e,t,n,s){const i=r(e,t,Fj),o=Bj.create(i);s&&wb(o,s),wb(o,n);const a=Aj(n.length,s?s.length:0,!0);o.update(a);const c=o.digest();return hu(i,a),c}const Vj=r=>(e,t,n)=>({encrypt(i,o){const a=i.length;o=gb(a+16,o,!1),o.set(i);const c=o.subarray(0,-16);r(e,t,c,c,1);const l=bb(r,e,t,c,n);return o.set(l,a),hu(l),o},decrypt(i,o){o=gb(i.length-16,o,!1);const a=i.subarray(0,-16),c=i.subarray(-16),l=bb(r,e,t,a,n);if(!_j(c,l))throw new Error("invalid tag");return o.set(i.subarray(0,-16)),r(e,t,o,o,1),hu(l),o}}),vb=xj({blockSize:64,nonceLength:12,tagLength:16},Vj($j));function Kj(r,e,t){return hf(r),t===void 0&&(t=new Uint8Array(r.outputLen)),gf(r,vd(t),vd(e))}const My=Uint8Array.from([0]),Eb=Uint8Array.of();function qj(r,e,t,n=32){hf(r),Ja(n);const s=r.outputLen;if(n>255*s)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(n/s);t===void 0&&(t=Eb);const o=new Uint8Array(i*s),a=gf.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<i;u++)My[0]=u+1,c.update(u===0?Eb:l).update(t).update(My).digestInto(l),o.set(l,s*u),a._cloneInto(c);return a.destroy(),c.destroy(),ai(l,My),o.slice(0,n)}const Hj={hashSHA256(r){return rc(r.subarray())},getHKDF(r,e){const t=Kj(rc,e,r),s=qj(rc,t,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const r=r1.utils.randomPrivateKey();return{publicKey:r1.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:r1.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return r1.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return vb(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,s){return vb(n,e,t).decrypt(r.subarray(),s)}},zj=Hj;function Wj(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const i0=r=>{const e=dn(2);return e[0]=r>>8,e[1]=r,e};i0.bytes=2;const Z1=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Z1.bytes=2;function jj(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function hk(r,e){!e.enabled||!Pf||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${se(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${se(r.privateKey,"hex")}`)):e("Missing local static keys."))}function dk(r,e){!e.enabled||!Pf||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${se(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${se(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function Gj(r,e){!e.enabled||!Pf||e(r?`REMOTE_STATIC_PUBLIC_KEY ${se(r.subarray(),"hex")}`:"Missing remote static public key.")}function fk(r,e){!e.enabled||!Pf||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${se(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function pk(r,e,t){!t.enabled||!Pf||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&se(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&se(e.k,"hex")}`))}function du(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=dn(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}function Qj(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}class td extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=td.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const Yj=0,Xj=4294967295,Zj="Cipherstate has reached maximum n, a new handshake must be performed";class Jj{n;bytes;view;constructor(e=Yj){this.n=e,this.bytes=ze(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>Xj)throw new Error(Zj)}}const ql=ze(0);class _1{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new Jj(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const s=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),s}}class eG{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=ie(t,"utf-8");this.h=rG(e,n),this.ck=this.h,this.cs=new _1(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new _1(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Ve(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,ql);return[new _1(this.crypto,e),new _1(this.crypto,t)]}}class tG{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:s,initiator:i,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new eG(t,n),this.ss.mixHash(s),this.initiator=i,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const s=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(s),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class gk extends tG{writeMessageA(e){return new Ve(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new Ve(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Ve(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new td(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new td(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new td(`handshake stage 2 validation fail: ${t.message}`)}}}function rG(r,e){if(e.length<=32){const t=ze(32);return t.set(e),t}else return r.hash(e)}var o0;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(const i of t.streamMuxers)n.uint32(18),n.string(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===s.limits.webtransportCerthashes)throw new ft('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(s.limits?.streamMuxers!=null&&i.streamMuxers.length===s.limits.streamMuxers)throw new ft('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(o0||(o0={}));var a0;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),o0.codec().encode(t.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={identityKey:ze(0),identitySig:ze(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=o0.codec().decode(t,t.uint32(),{limits:s.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(a0||(a0={}));async function yk(r,e,t){const n=await r.sign(wk(e));return a0.encode({identityKey:Rn(r.publicKey),identitySig:n,extensions:t})}async function mk(r,e,t){try{const n=a0.decode(r),s=Qr(n.identityKey);if(t?.equals(s)===!1)throw new Error(`Payload identity key ${s} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const i=wk(e);if(!await s.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new MD(n.message)}}function wk(r){const e=ie("noise-libp2p-static-key:");return r instanceof Uint8Array?jr([e,r],e.length+r.length):(r.prepend(e),r)}async function nG(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,u=await yk(i,a.publicKey,l),h=new gk({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});hk(h.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(ql),e),t.trace("Stage 0 - Initiator finished sending first message."),dk(h.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const d=h.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),fk(h.re,t),Gj(h.rs,t),t.trace("Initiator going to check remote's signature...");const g=await mk(d,h.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[y,w]=h.ss.split();return pk(y,w,t),{payload:g,encrypt:m=>y.encryptWithAd(ql,m),decrypt:(m,_)=>w.decryptWithAd(ql,m,_)}}async function sG(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,u=await yk(i,a.publicKey,l),h=new gk({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});hk(h.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),fk(h.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),dk(h.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const d=h.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const g=await mk(d,h.rs,c),[y,w]=h.ss.split();return pk(y,w,t),{payload:g,encrypt:m=>w.encryptWithAd(ql,m),decrypt:(m,_)=>y.decryptWithAd(ql,m,_)}}const Sb=16;function iG(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=fb){let i=s+fb;i>n.length&&(i=n.length);let o;n instanceof Uint8Array?o=r.encrypt(n.subarray(s,i)):o=r.encrypt(n.sublist(s,i)),e?.encryptedPackets.increment(),yield new Ve(i0(o.byteLength),o)}}}function oG(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=Hd){let i=s+Hd;if(i>n.length&&(i=n.length),i-Sb<s)throw new Error("Invalid chunk");const o=n.sublist(s,i),a=n.subarray(s,i-Sb);try{const c=r.decrypt(o,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}class aG{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:n,extensions:s,crypto:i,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=i??zj;this.crypto=Wj(c),this.extensions={webtransportCerthashes:[],...s},this.metrics=a?jj(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??ze(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[lr]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const n=lu(e,{lengthEncoder:i0,lengthDecoder:Z1,maxDataLength:Hd}),s=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=Qr(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:uc(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const s=t.get(n);if(s!=null)return s}if(e.length)throw new BD("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const n=lu(e,{lengthEncoder:i0,lengthDecoder:Z1,maxDataLength:Hd}),s=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=Qr(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:uc(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await nG({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await sG({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){const[n,s]=mj(),i=e.unwrap();return await Nn(n,iG(t,this.metrics),i,o=>Md(o,{lengthDecoder:Z1}),oG(t,this.metrics),n),s}}function zw(r={}){return e=>new aG(e,r)}function bk(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}class Cl extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}class vk extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}class Ek extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}class cG extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}class lG extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}class uG extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}class hG extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}}class Sk extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}const dG=new Set([Cl.name,vk.name,Ek.name,lG.name,uG.name,hG.name,Sk.name]),Ww=256*1024,fG=16*1024*1024,pG={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Ww,maxStreamWindowSize:fG,maxMessageSize:64*1024};function gG(r){if(r.keepAliveInterval<=0)throw new re("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new re("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new re("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<Ww)throw new re("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new re("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new re("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new re("MaxMessageSize must be greater than a kilobyte")}var tr;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(tr||(tr={}));var Vt;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Vt||(Vt={}));Object.values(Vt).filter(r=>typeof r!="string");const yG=0;var zs;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(zs||(zs={}));const rd=12,_b=2**24;function mG(r){if(r[0]!==yG)throw new Cl("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*_b+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*_b+(r[9]<<16)+(r[10]<<8)+r[11]}}let wG=class{source;buffer;frameInProgress;constructor(e){this.source=bG(e),this.buffer=new Ve,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:n,length:s}=t;n===tr.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new cG("decoding frame already in progress");if(this.buffer.length<rd)return;const e=mG(this.buffer.subarray(0,rd));return this.buffer.consume(rd),e}async readBytes(e){if(this.buffer.length<e){for await(const n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function bG(r){if(r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){const e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function xb(r){const e=new Uint8Array(rd);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function vG(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function _k(r,e){const t=bk(r).return?.();vG(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}const EG=5e3;function By(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class jw{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=Qe(),this.closed=Qe(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??EG,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=ls({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new Cm(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(t);By(s)&&await s}const n=()=>{_k(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Ve(s):s;const i=this.sendData(s,t);By(i)&&(this.sendingData=Qe(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await Et(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Et(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Et(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Et(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();By(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new $D("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var _s;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(_s||(_s={}));class SG extends jw{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=_s.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Ww,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=Zp(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-rd,e.length),s=this.getSendFlags();this.sendFrame({type:tr.Data,flag:s,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:tr.WindowUpdate,flag:Vt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Vt.FIN;this.sendFrame({type:tr.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n;const s=()=>{this.status==="open"||this.status==="closing"?n(new qi("Stream aborted")):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,o)=>{this.sendWindowCapacityUpdate=()=>{i()},n=o,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Sk("Receive window exceeded");const n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Vt.ACK)===Vt.ACK&&this.state===_s.SYNSent&&(this.state=_s.Established),(e&Vt.FIN)===Vt.FIN&&this.remoteCloseWrite(),(e&Vt.RST)===Vt.RST&&this.reset()}getSendFlags(){switch(this.state){case _s.Init:return this.state=_s.SYNSent,Vt.SYN;case _s.SYNReceived:return this.state=_s.Established,Vt.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:tr.WindowUpdate,flag:e,streamID:this._id,length:s})}}const xk="/yamux/1.0.0",_G=500;class xG{protocol=xk;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[lr]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new AG(this._components,{...this._init,...e})}}class AG{protocol=xk;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...pG,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),gG(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=ls({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{const s=()=>{const a=bk(n);if(a.return!=null){const c=a.return();IG(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}};let i,o;try{const a=new wG(n);try{this.closeController.signal.addEventListener("abort",s);for await(const c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=zs.NormalTermination}catch(a){dG.has(a.name)?(this.log?.error("protocol error in sink",a),i=zs.ProtocolError):(this.log?.error("internal error in sink",a),i=zs.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new Al("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Al("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new k6("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,_s.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new Al("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Al("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new Al("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??zs.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){const n=AbortSignal.timeout(_G);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??zs.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new re("Stream already exists with that id");const i=new SG({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await Et(new Promise(t=>{e=setTimeout(t,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(t=>this.log?.error("ping error: %s",t))}catch{clearInterval(e);return}}}async handleFrame(e,t){const{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %o",e),n===0)switch(s){case tr.Ping:{this.handlePing(e);return}case tr.GoAway:{this.handleGoAway(i);return}default:throw new Cl("Invalid frame type")}else switch(e.type){case tr.Data:case tr.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new Cl("Invalid frame type")}}handlePing(e){if(e.flag===Vt.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Vt.ACK);else if(e.flag===Vt.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Cl("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new vk("ping not requested");if(this.activePing.id!==e)throw new Ek("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",zs[e]??"unknown"),this.remoteGoAway=e;for(const t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:n,flag:s,type:i}=e;(s&Vt.SYN)===Vt.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(o===void 0){if(i===tr.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(i){case tr.WindowUpdate:{o.handleWindowUpdate(e);return}case tr.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new re("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:tr.WindowUpdate,flag:Vt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:tr.WindowUpdate,flag:Vt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,_s.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===tr.Data){if(t===void 0)throw new Cl("Invalid frame");this.source.push(new Ve(xb(e),t))}else this.source.push(xb(e))}sendPing(e,t=Vt.SYN){t===Vt.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:tr.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=zs.NormalTermination){this.log?.("sending GoAway reason=%s",zs[e]),this.localGoAway=e,this.sendFrame({type:tr.GoAway,flag:0,streamID:0,length:e})}}function IG(r){return r!=null&&typeof r.then=="function"}function Ak(r={}){return e=>new xG(e,r)}function Ik(r){try{for(const{code:e,value:t}of r.getComponents())if(t!=null&&e===os)return SL("2000::/3",t)}catch{}return!1}function kG(r,e,t){let n,s,i=!1;function o(){const l={signal:s.signal};if(t?.timeout!=null){const u=ut([s.signal,AbortSignal.timeout(t.timeout)]);l.signal=u}i=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{i=!1,!s.signal.aborted&&(n=setTimeout(o,e))})}const a=Dd(o,t?.debounce??100);let c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{i||(clearTimeout(n),a())},start:()=>{c||(c=!0,s=new AbortController,s.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),s?.abort(),c=!1}}}function Fr(r,e){const t=lu(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const TG="libp2p",CG="autonat",PG="1.0.0",DG=3e4,RG=2,OG=20,NG=80,MG=8192;var Tt;(function(r){(function(s){s.DIAL="DIAL",s.DIAL_RESPONSE="DIAL_RESPONSE"})(r.MessageType||(r.MessageType={}));let e;(function(s){s[s.DIAL=0]="DIAL",s[s.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),function(s){s.codec=()=>gn(e)}(r.MessageType||(r.MessageType={})),function(s){s.OK="OK",s.E_DIAL_ERROR="E_DIAL_ERROR",s.E_DIAL_REFUSED="E_DIAL_REFUSED",s.E_BAD_REQUEST="E_BAD_REQUEST",s.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(r.ResponseStatus||(r.ResponseStatus={}));let t;(function(s){s[s.OK=0]="OK",s[s.E_DIAL_ERROR=100]="E_DIAL_ERROR",s[s.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",s[s.E_BAD_REQUEST=200]="E_BAD_REQUEST",s[s.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),function(s){s.codec=()=>gn(t)}(r.ResponseStatus||(r.ResponseStatus={})),function(s){let i;s.codec=()=>(i==null&&(i=Pe((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const h=o.uint32();switch(h>>>3){case 1:{l.id=o.bytes();break}case 2:{if(c.limits?.addrs!=null&&l.addrs.length===c.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(h&7);break}}}return l})),i),s.encode=o=>Ce(o,s.codec()),s.decode=(o,a)=>Te(o,s.codec(),a)}(r.PeerInfo||(r.PeerInfo={})),function(s){let i;s.codec=()=>(i==null&&(i=Pe((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),r.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const h=o.uint32();switch(h>>>3){case 1:{l.peer=r.PeerInfo.codec().decode(o,o.uint32(),{limits:c.limits?.peer});break}default:{o.skipType(h&7);break}}}return l})),i),s.encode=o=>Ce(o,s.codec()),s.decode=(o,a)=>Te(o,s.codec(),a)}(r.Dial||(r.Dial={})),function(s){let i;s.codec=()=>(i==null&&(i=Pe((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),r.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const h=o.uint32();switch(h>>>3){case 1:{l.status=r.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(h&7);break}}}return l})),i),s.encode=o=>Ce(o,s.codec()),s.decode=(o,a)=>Te(o,s.codec(),a)}(r.DialResponse||(r.DialResponse={}));let n;r.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.MessageType.codec().encode(s.type,i)),s.dial!=null&&(i.uint32(18),r.Dial.codec().encode(s.dial,i)),s.dialResponse!=null&&(i.uint32(26),r.DialResponse.codec().encode(s.dialResponse,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.type=r.MessageType.codec().decode(s);break}case 2:{a.dial=r.Dial.codec().decode(s,s.uint32(),{limits:o.limits?.dial});break}case 3:{a.dialResponse=r.DialResponse.codec().decode(s,s.uint32(),{limits:o.limits?.dialResponse});break}default:{s.skipType(l&7);break}}}return a})),n),r.encode=s=>Ce(s,r.codec()),r.decode=(s,i)=>Te(s,r.codec(),i)})(Tt||(Tt={}));const BG=4,LG=8;class $G{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??TG}/${CG}/${PG}`,this.timeout=t.timeout??DG,this.maxInboundStreams=t.maxInboundStreams??RG,this.maxOutboundStreams=t.maxOutboundStreams??OG,this.connectionThreshold=t.connectionThreshold??NG,this.maxMessageSize=t.maxMessageSize??MG,this.dialResults=Os({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=kG(this.findRandomPeers.bind(this),6e4),this.addressFilter=Zo(1024)}[Symbol.toStringTag]="@libp2p/autonat";[lr]=["@libp2p/autonat"];get[jo](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=ut([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(s=>s.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=Fr(e.stream,{maxDataLength:this.maxMessageSize}).pb(Tt);try{const s=await n.read({signal:t}),i=await this.handleAutonatMessage(s,e.connection,{signal:t});await n.write(i,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(s){this.log.error("error handling incoming autonat stream - %e",s),e.stream.abort(s)}}async handleAutonatMessage(e,t,n){const s=this.components.addressManager.getAddresses().map(h=>h.toOptions().host),i=e.dial;if(i==null)return this.log.error("dial was missing from message"),{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=i.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const h=ur(a.id);o=Bn(h)}catch(h){return this.log.error("invalid PeerId - %e",h),{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(h=>De(h)).filter(h=>{const d=h.toOptions();return gc(h)?!1:d.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",h,t.remoteAddr),!1):s.includes(d.host)?!1:this.components.transportManager.dialTransportForMultiaddr(h)==null?(this.log.trace("not dialing %a - transport unsupported",h),!1):!0}).map(h=>(h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${o.toString()}`)),h));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(h=>h.toString()).join(", "),o);let l="",u=c[0];for(const h of c){let d;u=h;try{if(d=await this.components.connectionManager.openConnection(h,n),!d.remoteAddr.equals(h))throw this.log.error("tried to dial %a but dialed %a",h,d.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,h),{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.OK,addr:d.remoteAddr.decapsulateCode(qu("p2p").code).bytes}}}catch(g){this.log.error("could not dial %p - %e",o,g),l=g.message}finally{d!=null&&await d.close()}}return{type:Tt.MessageType.DIAL_RESPONSE,dialResponse:{status:Tt.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){const n=this.components.addressManager.getAddressesWithMetadata().sort((s,i)=>s.type==="observed"&&i.type!=="observed"?1:i.type==="observed"&&s.type!=="observed"?-1:0).filter(s=>!(!(s.expires<Date.now())||s.multiaddr.toOptions().family===6&&(!t||!Ik(s.multiaddr))||gc(s.multiaddr)));for(const s of n){const i=s.multiaddr.toString();let o=this.dialResults.get(i);if(o!=null){if(o.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",o.multiaddr,e);continue}if(o.queue.size>10){this.log.trace("%a already has enough peers queued",o.multiaddr);continue}}if(o==null){const a=s.expires<Date.now();if(a&&this.addressFilter.remove?.(i),this.addressFilter.has(i))continue;this.addressFilter.add(i),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",i),o={multiaddr:s.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:WL(),queue:new ra({concurrency:3,maxSize:50}),type:s.type,lastVerified:s.lastVerified},this.dialResults.set(i,o)}return o}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),s=this.getNetworkSegment(e.remoteAddr),i=this.getFirstUnverifiedMultiaddr(s,n);if(i==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){i.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",i.multiaddr),this.confirmAddress(i)):this.log("skipping verifying %a because we are too close to the connection limit",i.multiaddr);return}i.queue.add(async o=>{await this.askPeerToVerify(e,s,o)},{peerId:e.remotePeer,multiaddr:i.multiaddr}).catch(o=>{i?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,i?.multiaddr,o)})}async askPeerToVerify(e,t,n){let s=this.dialResults.get(n.multiaddr.toString());if(s==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}const i=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);const o=await e.newStream(this.protocol,{signal:i});try{const a=Fr(o).pb(Tt),[,c]=await Promise.all([a.write({type:Tt.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:i}),a.read({signal:i})]);if(c.type!==Tt.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==Tt.ResponseStatus.OK&&l!==Tt.ResponseStatus.E_DIAL_ERROR)return;if(s=this.dialResults.get(n.multiaddr.toString()),s==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(s.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(s.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(s.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(s.verifyingPeers.add(e.remotePeer),s.networkSegments.push(t),l===Tt.ResponseStatus.OK){if(s.success++,s.type!=="observed"){this.confirmAddress(s);return}}else l===Tt.ResponseStatus.E_DIAL_ERROR&&s.failure++;this.log("%a success %d failure %d",s.multiaddr,s.success,s.failure),s.success===BG&&this.confirmAddress(s),s.failure===LG&&this.unconfirmAddress(s)}finally{try{await o.close({signal:i})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function kk(r={}){return e=>new $G(e,r)}const UG=he("dns4"),FG=he("dns6"),VG=he("dnsaddr"),bc=zt(he("dns"),VG,UG,FG),t2=zt(he("ip4"),he("ip6")),fu=zt(Ae(t2,he("tcp")),Ae(bc,he("tcp"))),r2=Ae(t2,he("udp")),KG=Ae(r2,he("utp")),qG=Ae(r2,he("quic")),HG=Ae(r2,he("quic-v1")),m3=zt(Ae(fu,he("ws")),Ae(bc,he("ws"))),c0=zt(Ae(m3,he("p2p")),m3),w3=zt(Ae(fu,he("wss")),Ae(bc,he("wss")),Ae(fu,he("tls"),he("ws")),Ae(bc,he("tls"),he("ws"))),l0=zt(Ae(w3,he("p2p")),w3),b3=zt(Ae(fu,he("http")),Ae(t2,he("http")),Ae(bc,he("http"))),v3=zt(Ae(fu,he("https")),Ae(t2,he("https")),Ae(bc,he("https"))),Ab=Ae(r2,he("webrtc-direct"),he("certhash")),Tk=zt(Ae(Ab,he("p2p")),Ab),Ib=Ae(HG,he("webtransport"),he("certhash"),he("certhash")),Ck=zt(Ae(Ib,he("p2p")),Ib),Pk=zt(Ae(c0,he("p2p-webrtc-star"),he("p2p")),Ae(l0,he("p2p-webrtc-star"),he("p2p")),Ae(c0,he("p2p-webrtc-star")),Ae(l0,he("p2p-webrtc-star")));zt(Ae(c0,he("p2p-websocket-star"),he("p2p")),Ae(l0,he("p2p-websocket-star"),he("p2p")),Ae(c0,he("p2p-websocket-star")),Ae(l0,he("p2p-websocket-star")));const Dk=zt(Ae(b3,he("p2p-webrtc-direct"),he("p2p")),Ae(v3,he("p2p-webrtc-direct"),he("p2p")),Ae(b3,he("p2p-webrtc-direct")),Ae(v3,he("p2p-webrtc-direct"))),vc=zt(m3,w3,b3,v3,Pk,Dk,fu,KG,qG,bc,Tk,Ck);zt(Ae(vc,he("p2p-stardust"),he("p2p")),Ae(vc,he("p2p-stardust")));const Oo=zt(Ae(vc,he("p2p")),Pk,Dk,Tk,Ck,he("p2p")),kb=zt(Ae(Oo,he("p2p-circuit"),Oo),Ae(Oo,he("p2p-circuit")),Ae(he("p2p-circuit"),Oo),Ae(vc,he("p2p-circuit")),Ae(he("p2p-circuit"),vc),he("p2p-circuit")),Rk=()=>zt(Ae(kb,Rk),kb),Na=Rk(),zG=zt(Ae(Na,Oo,Na),Ae(Oo,Na),Ae(Na,Oo),Na,Oo);zt(Ae(Na,he("webrtc"),he("p2p")),Ae(Na,he("webrtc")),Ae(vc,he("webrtc"),he("p2p")),Ae(vc,he("webrtc")),he("webrtc"));function Ok(r){function e(t){let n;try{n=De(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function Ae(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Ok(e),partialMatch:e}}function zt(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Ok(e),partialMatch:e}}function he(r){const e=r;function t(s){let i;try{i=De(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const WG="bootstrap",jG=50,GG=1e3;class QG extends $t{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??GG,this.list=[];for(const n of t.list){if(!zG.matches(n)){this.log.error("Invalid multiaddr");continue}const s=De(n),i=s.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:nr(i),multiaddrs:[s]};this.list.push(o)}this._init=t}[wd]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[lr]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??WG]:{value:this._init.tagValue??jG,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function Nk(r){return e=>new QG(e,r)}const YG=290,XG=1,Mk=2e3,ZG=100,x1=`${lg}-circuit-relay`;BigInt(1<<17);const u0="/libp2p/circuit/relay/0.2.0/hop",Tb="/libp2p/circuit/relay/0.2.0/stop",Cb=300,JG=4096,eQ=.001;var pu;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),function(n){n.codec=()=>gn(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Pe((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),gu.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),h0.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),yu.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),Hr.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=gu.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=h0.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=yu.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Hr.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Ce(n,r.codec()),r.decode=(n,s)=>Te(n,r.codec(),s)})(pu||(pu={}));var ki;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),function(n){n.codec=()=>gn(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Pe((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),gu.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),yu.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),Hr.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=gu.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=yu.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Hr.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Ce(n,r.codec()),r.decode=(n,s)=>Te(n,r.codec(),s)})(ki||(ki={}));var gu;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:ze(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(gu||(gu={}));var h0;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),f0.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=f0.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(h0||(h0={}));var yu;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(yu||(yu={}));var Hr;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Hr||(Hr={}));var E3;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(E3||(E3={}));(function(r){r.codec=()=>gn(E3)})(Hr||(Hr={}));var d0;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:ze(0),peer:ze(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(d0||(d0={}));var f0;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),d0.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:ze(0),payloadType:ze(0),signature:ze(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=d0.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(f0||(f0={}));class Pb extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class tQ extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class rQ extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function Db(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class Rb{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const Bk=St(ht(Vx.matchers[0],xt(Lc))),Lk=St(xt(Lc));function Ob(r){const{stream:e,remoteAddr:t,logger:n,onDataRead:s,onDataWrite:i}=r,o=n.forComponent("libp2p:stream:converter");let a=!1,c=!1;const l=e.close.bind(e);e.close=async y=>{await l(y),g(!0)};const u=e.abort.bind(e);e.abort=y=>{u(y),g(!0)};const h=e.sink.bind(e);e.sink=async y=>{try{await h(Nn(y,w=>Zp(w,m=>i?.(m))))}catch(w){w.type!=="aborted"&&o.error("%s error in sink",t,w)}finally{c=!0,g()}};const d={log:o,sink:e.sink,source:async function*(){try{for await(const y of e.source)s?.(y),yield y}finally{a=!0,g()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function g(y){y===!0&&(a=!0,c=!0),a&&c&&d.timeline.close==null&&(d.timeline.close=Date.now())}return d}let nQ=class extends $t{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(u0,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(u0)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=Nb(n),o=Nb(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new ra({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=ut([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}};function Nb(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(se(e)).getTime()}class sQ extends $t{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Mk,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(Lk.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Bk.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new Pm(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>De(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function iQ(r){return new sQ(r)}const oQ="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let aQ=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=oQ[t[r]&63];return e};const cQ=60*1e3*10,lQ=60*1e3*5,uQ=30*1e3;class hQ extends $t{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new $c,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??ZG,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Mk,this.started=!1,this.relayFilter=Zo(100),this.reserveQueue=new ra({concurrency:t?.reservationConcurrency??XG,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(x1)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[x1]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=aQ();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Pm("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new rQ("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Pm("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const y=this.connectionManager.getConnections(e);let w=!1;if(y.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),y.map(m=>m.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),w=!0),w&&Db(i.reservation.expire)>cQ)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new Pb("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const a=await this.connectionManager.openConnection(e,{signal:o});if(ea.matches(a.remoteAddr))throw new tQ("not creating reservation over relayed connection");const c=await this.#e(a,{signal:o}),l=Db(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());const u=Math.min(Math.max(l-lQ,uQ),Math.pow(2,31)-1),h=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async y=>{this.log.error("could not refresh reservation to relay %p - %e",e,y),await this.#t(e)}).catch(y=>{this.log.error("could not remove expired reservation to relay %p - %e",e,y)})},u);let d;if(t==="discovered"){const y=this.pendingReservations.pop();if(y==null)throw new Pb("Made reservation on relay but did not need any more discovered relays");d={timeout:h,reservation:c,type:t,connection:a.id,id:y}}else d={timeout:h,reservation:c,type:t,connection:a.id};this.reservations.set(e,d),await this.peerStore.merge(e,{tags:{[x1]:{value:1,ttl:l}}}),this.#r();const g={relay:e,details:d};return this.safeDispatchEvent("relay:created-reservation",{detail:g}),g}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(u0,t),i=Fr(n).pb(pu);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:pu.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",o),o.status===Hr.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const l of o.reservation.addrs){let u=De(l);u.getPeerId()==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=De(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return o.reservation.addrs=[...c].map(l=>De(l).bytes),o.reservation}const a=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[x1]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Zo(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}const dQ=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(De)}catch{return!1}return!0},Mb={maxInboundStopStreams:Cb,maxOutboundStopStreams:Cb};class fQ{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??Mb.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??Mb.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new nQ(e,{filter:t.discoveryFilter??a$(JG,eQ)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,s)})}),this.reservationStore=new hQ(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[lr]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[jo](){return this.discovery!=null?["@libp2p/identify"]:[]}[ug]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(Tb,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Hi(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await la(this.discovery,this.reservationStore),await this.registrar.unhandle(Tb),this.started=!1}async dial(e,t){if(e.protoCodes().filter(g=>g===YG).length!==1){const g="Invalid circuit relay address";throw this.log.error(g,e),new Qh(g)}const n=e.toString().split("/p2p-circuit"),s=De(n[0]),i=De(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const g=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${g}`),new Qh(`C${g}`)}const c=nr(o),l=nr(a);let h=this.connectionManager.getConnections(c)[0];h==null?(await this.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new xe("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new xe("circuit-relay:reuse-connection"));let d;try{t.onProgress?.(new xe("circuit-relay:open-hop-stream")),d=await h.newStream(u0,t);const g=Fr(d),y=g.pb(pu);t.onProgress?.(new xe("circuit-relay:write-connect-message")),await y.write({type:pu.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[De(i).bytes]}},t),t.onProgress?.(new xe("circuit-relay:read-connect-response"));const w=await y.read(t);if(w.status!==Hr.OK)throw new It(`failed to connect via relay with status ${w?.status?.toString()??"undefined"}`);const m=new Rb(w.limit),_=Ob({stream:g.unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:m.onData,onDataWrite:m.onData});return this.log("new outbound relayed connection %a",_.remoteAddr),await this.upgrader.upgradeOutbound(_,{...t,limits:m.getLimits()})}catch(g){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,g),d?.abort(g),g}}createListener(e){return iQ({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Bk.exactMatch(t)||Lk.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>ea.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(u){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",u)}const s=Fr(t).pb(ki),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:ki.Type.STATUS,status:Hr.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==ki.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:ki.Type.STATUS,status:Hr.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!dQ(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:ki.Type.STATUS,status:Hr.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}const o=Bn(ur(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:ki.Type.STATUS,status:Hr.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:ki.Type.STATUS,status:Hr.OK},{signal:n});const a=new Rb(i.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=Ob({stream:s.unwrap().unwrap(),remoteAddr:c,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function $k(r={}){return e=>new fQ(e,r)}var Ws;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),function(n){n.codec=()=>gn(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Pe((n,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.observedAddresses!=null)for(const o of n.observedAddresses)s.uint32(18),s.bytes(o);i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={observedAddresses:[]},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(i.limits?.observedAddresses!=null&&o.observedAddresses.length===i.limits.observedAddresses)throw new ft('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Ce(n,r.codec()),r.decode=(n,s)=>Te(n,r.codec(),s)})(Ws||(Ws={}));function Bb(r,e){return ea.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:iU.matches(r)?!0:aU.matches(r)?ha(r.toOptions().host)===!1:!1}const Lb=1024*4,$b=100,A1={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};class pQ{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??A1.timeout,this.retries=t.retries??A1.retries,this.maxInboundStreams=t.maxInboundStreams??A1.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??A1.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[jo]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(I1,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{ea.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(I1,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(I1),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const s={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([I1],{signal:s.signal,runOnLimitedConnection:!0});const i=Fr(t,{maxDataLength:Lb}).pb(Ws);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await i.write({type:Ws.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(h=>h.bytes)},s),this.log("B receiving connect from %p",e.remotePeer);const a=await i.read(s);if(a.type!==Ws.Type.CONNECT)throw this.log("A sent wrong message type"),new It("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new It("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await i.write({type:Ws.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await qx(l/2),this.log("B dialing",c);const u=await this.connectionManager.openConnection(c,{signal:s.signal,priority:$b,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(s);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(s)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(s=>{const i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(s=>Bb(s,this.transportManager));if(n.length>0){const s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const i=await this.connectionManager.openConnection(n,{signal:s,force:!0});if(ea.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:s}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const s=Fr(e,{maxDataLength:Lb}).pb(Ws);this.log("A receiving connect");const i=await s.read(n);if(i.type!==Ws.Type.CONNECT)throw this.log("B sent wrong message type"),new It("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new It("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new It("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await s.write({type:Ws.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await s.read(n)).type!==Ws.Type.SYNC)throw new It("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:$b,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(s){this.log.error("incoming DCUtR from %p failed",t.remotePeer,s),e.abort(s)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const s=De(n);if(!Bb(s,this.transportManager))continue;t.push(s)}catch{}return t}}const I1="/libp2p/dcutr";function Uk(r={}){return e=>new pQ(e,r)}const gQ="0.1.0",yQ="id",mQ="id/push",wQ="1.0.0",bQ="1.0.0",vQ=1024*8,EQ=32,SQ=1e3;var mu;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new ft('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new ft('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(mu||(mu={}));const Xn={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:vQ,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:EQ};function _Q(r){if(r!=null&&r.length>0)try{return De(r)}catch{}}function xQ(r,e){return e??r.userAgent}async function Fk(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new It("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:De(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=Qr(s.publicKey);if(!uc(c).equals(n.remotePeer))throw new It("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const l=await ti.openAndCertify(c,Dn.DOMAIN);let u=Dn.createFromProtobuf(l.payload);const h=Fu(l.publicKey.toCID());if(!u.peerId.equals(h))throw new It("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new It("signing key does not match remote PeerId");let d;try{d=await r.get(u.peerId)}catch(g){if(g.name!=="NotFoundError")throw g}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){const g=ti.createFromProtobuf(d.peerRecordEnvelope),y=Dn.createFromProtobuf(g.payload);y.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",y.seqNumber,u.seqNumber),u=y,c=d.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=u.multiaddrs.map(g=>({isCertified:!0,multiaddr:g})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=ie(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=ie(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>De(c)),observedAddr:s.observedAddr==null?void 0:De(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class Vk{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Xn.timeout,this.maxInboundStreams=t.maxInboundStreams??Xn.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Xn.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Xn.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Xn.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Xn.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Xn.protocolPrefix}/${gQ}`,agentVersion:xQ(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:ie(this.host.agentVersion),ProtocolVersion:ie(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class AQ extends Vk{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Xn.protocolPrefix}/${mQ}/${bQ}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??Xn.concurrency,this._push=Dd(this.sendPushMessage.bind(this),t.debounce??SQ),(t.runOnSelfUpdate??Xn.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(s=>{this.log.error("error pushing updates to peers - %e",s)})})}[lr]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{const e=this.addressManager.getAddresses().map(u=>u.decapsulateCode(qu("p2p").code)),t=new Dn({peerId:this.peerId,multiaddrs:e}),n=await ti.seal(t,this.privateKey),s=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),o=se(i.metadata.get("AgentVersion")??ie(this.host.agentVersion)),a=se(i.metadata.get("ProtocolVersion")??ie(this.host.protocolVersion)),c=this;async function*l(){for(const u of c.connectionManager.getConnections())(await c.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let d;const g=AbortSignal.timeout(c.timeout);try{d=await u.newStream(c.protocol,{signal:g,runOnLimitedConnection:c.runOnLimitedConnection}),await Fr(d,{maxDataLength:c.maxMessageSize}).pb(mu).write({listenAddrs:e.map(w=>w.bytes),signedPeerRecord:n.marshal(),protocols:s,agentVersion:o,protocolVersion:a},{signal:g}),await d.close({signal:g})}catch(y){c.log.error("could not push identify update to peer",y),d?.abort(y)}})}await ji(kg(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e){const{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},o=await Fr(n,{maxDataLength:this.maxMessageSize}).pb(mu).read(s);await n.close(s),await Fk(this.peerStore,this.events,this.log,t,o)}catch(s){this.log.error("received invalid message",s),n.abort(s);return}this.log.trace("handled push from %p",t.remotePeer)}}class IQ extends Vk{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Xn.protocolPrefix}/${yQ}/${wQ}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Xn.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(i=>{i.name!==hg.name&&this.log.error("error during identify trigged by connection:open",i)})})}[lr]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){const s=AbortSignal.timeout(this.timeout);t={...t,signal:s}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const i=await Fr(n,{maxDataLength:this.maxMessageSize}).pb(mu).read(t);return await n.close(t),i}catch(s){throw n?.abort(s),s}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new It("public key was missing from identify message");const a=Qr(s),c=Fu(a.toCID());if(!e.remotePeer.equals(c))throw new It("identified peer does not match the expected peer");if(this.peerId.equals(c))throw new It("identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("identify completed for peer %p and protocols %o",c,i),Fk(this.peerStore,this.events,this.log,e,n)}maybeAddObservedAddress(e){const t=_Q(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),gc(t)){this.log.trace("our observed address was private");return}const n=t.getComponents();if((n[0].code===os||n[0].code===Bc&&n[1].code===os)&&!Ik(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Kp.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){const{connection:t,stream:n}=e,s=AbortSignal.timeout(this.timeout);try{const i=await this.peerStore.get(this.peerId),o=this.addressManager.getAddresses().map(u=>u.decapsulateCode(qu("p2p").code));let a=i.peerRecordEnvelope;if(o.length>0&&a==null){const u=new Dn({peerId:this.peerId,multiaddrs:o});a=(await ti.seal(u,this.privateKey)).marshal().subarray()}let c=t.remoteAddr.bytes;oU.matches(t.remoteAddr)||(c=void 0),await Fr(n).pb(mu).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Rn(this.privateKey.publicKey),listenAddrs:o.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:i.protocols},{signal:s}),await n.close({signal:s})}catch(i){this.log.error("could not respond to identify request",i),n.abort(i)}}}function Kk(r={}){return e=>new IQ(e,r)}function kQ(r={}){return e=>new AQ(e,r)}const Yu=1e3,Gw=60*Yu,Df=60*Gw,TQ=36*Df,CQ="/ipfs/kad/1.0.0",PQ=48*Df,DQ=24*Df,RQ=10,OQ=16384,NQ=Df,Ub=Df,MQ=10*Yu,qk=20,n2=10,BQ=5*Gw,LQ=Yu,$Q=5*Yu,UQ=5*Gw,FQ=30*Yu,VQ=180*Yu,Fb=`${lg}-kad-dht`;var p0;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={key:ze(0),value:ze(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(p0||(p0={}));function KQ(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function qQ(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}class as{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return p0.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:KQ(this.timeReceived)}}static deserialize(e){const t=p0.decode(e);return new as(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=qQ(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new as(e.key,e.value,t)}}class g0 extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class HQ extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class zQ extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var Vb;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Vb||(Vb={}));var Pt;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(Pt||(Pt={}));var y0;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(y0||(y0={}));(function(r){r.codec=()=>gn(y0)})(Pt||(Pt={}));var wu;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(wu||(wu={}));var S3;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(S3||(S3={}));(function(r){r.codec=()=>gn(S3)})(wu||(wu={}));var Pl;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),wu.codec().encode(t.connection,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:ze(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.multiaddrs!=null&&i.multiaddrs.length===s.limits.multiaddrs)throw new ft('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=wu.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Pl||(Pl={}));var Hl;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.type!=null&&y0[t.type]!==0&&(n.uint32(8),Pt.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const i of t.closer)n.uint32(66),Pl.codec().encode(i,n);if(t.providers!=null)for(const i of t.providers)n.uint32(74),Pl.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={type:Pt.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.type=Pt.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(s.limits?.closer!=null&&i.closer.length===s.limits.closer)throw new ft('Decode error - map field "closer" had too many elements');i.closer.push(Pl.codec().decode(t,t.uint32(),{limits:s.limits?.closer$}));break}case 9:{if(s.limits?.providers!=null&&i.providers.length===s.limits.providers)throw new ft('Decode error - map field "providers" had too many elements');i.providers.push(Pl.codec().decode(t,t.uint32(),{limits:s.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Hl||(Hl={}));function Kb(r,e={}){const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function _3(r,e={}){const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Ly(r,e={}){const t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function bu(r,e={}){const t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function qb(r,e={}){const t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function x3(r,e={}){const t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function Hb(r,e={}){const t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function WQ(r,e={}){const t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function jQ(r,e,t){if(t.length===0)throw new re("No records given");const s=se(e).split("/");if(s.length<3)throw new re("Record key does not have a selector function");const i=r[s[1].toString()];if(i==null)throw new zQ(`No selector function configured for key type "${s[1]}"`);return t.length===1?0:i(e,t)}function GQ(r,e){return 0}const QQ={pk:GQ};async function Qw(r,e,t){const n=e.key,i=se(n).split("/");if(i.length<3)return;const o=r[i[1].toString()];if(o==null)throw new re(`No validator available for key type "${i[1]}"`);await o(n,e.value,t)}const YQ=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new re('"key" must be a Uint8Array');if(r.byteLength<5)throw new re("Invalid public key record");if(se(r.subarray(0,4))!=="/pk/")throw new re("key was not prefixed with /pk/");const s=Qr(e),i=r.slice(4);if(!We(i,s.toMultihash().bytes))throw new re("public key does not match passed in key")},XQ={pk:YQ},ZQ=ie("/pk/");function JQ(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const s=ha(n);return s==null?!0:!s})}}async function zd(r,e){const t=await fn.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function Qi(r,e){return zd(r.toMultihash().bytes,e)}function nd(r,e){return new wt(`${r}/${se(e,"base32")}`,!1)}function eY(r){return jr([ZQ,r.toMultihash().bytes])}function tY(r){return se(r.subarray(0,4))==="/pk/"}function rY(r){const e=ur(r.subarray(4));return Bn(e)}function zb(r,e){const t=new Date;return new as(r,e,t).serialize()}const nY=290,sY=54,iY=55,oY=56,aY=4,cY=41;function lY(r){const e=r.stringTuples();for(const t of e)if(t[0]===nY)return!1;if(e[0][0]===sY||e[0][0]===iY||e[0][0]===oY)return!0;if(e[0][0]===aY||e[0][0]===cY){const t=ha(`${e[0][1]}`);return t==null||!t}return!1}function Hk(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:$e.createV1(lf,ur(ie(n,"base32"))),peerId:nr(t)}}function $y(r,e,t){const n=typeof e=="string"?e:se(e.multihash.bytes,"base32"),s=[r,n];return t!=null&&s.push(t.toString()),new wt(s.join("/"))}function zk(r){return new Date(Nc(r))}function pl(r,e,t){return async function*(...n){const s=e.queryTime?.timer(t),i=e.errorTime?.timer(t);let o=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}function Wk(r,e,t){return async function(...n){const s=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t);let o=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}class uY{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const n=nd(this.datastorePrefix,e);this.log("fetching record for key %k",n);const s=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);const i=as.deserialize(s);return await Qw(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,s){this.log("sendCorrection for %b",e);const i=zb(e,n);for(const{value:o,from:a}of t){if(We(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=nd(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray(),s)}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1;const l={type:Pt.PUT_VALUE,key:e,record:i};for await(const u of this.network.sendRequest(a,l,s))u.name==="PEER_RESPONSE"&&u.record!=null&&We(u.record.value,as.deserialize(i).value)&&(c=!0),yield u;if(!c)throw new g0("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);const s=zb(e,t),i=nd(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray(),n),yield*Nn(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>yc(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:Pt.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&We(u.record.value,as.deserialize(s).value)||c.push(bu({from:a.peer.id,error:new g0("Value not put correctly"),path:u.path},n)));return c}),o=>kg(o,{ordered:!1,concurrency:n2}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=jQ(this.selectors,e,s)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new Zt("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const i=await this.getLocal(e,t);yield x3({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}const n=this,s=async function*({peer:i,signal:o,path:a}){for await(const c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield x3({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,s,t)}}function hY(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function k1(r){if(r.id==null)throw new Error("Invalid peer in message");const e=ur(r.id);return{id:Bn(e),multiaddrs:(r.multiaddrs??[]).map(t=>De(t))}}class dY{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(h=>h.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);const i={type:Pt.ADD_PROVIDER,key:s,providers:[hY({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(h){try{a.log("sending provider record for %s to %p",e,h.peer.id);for await(const d of a.network.sendMessage(h.peer.id,i,{...n,path:h.path}))d.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,h.peer.id),o++),yield d}catch(d){a.log.error("error sending provide record to peer %p",h.peer.id,d),yield bu({from:h.peer.id,error:d,path:h.path},n)}}const l=ls({objectMode:!0}),u=new ta({concurrency:n2});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("error",h=>{this.log.error("error publishing provider record to peer - %e",h)}),u.add(async()=>{const h=[];for await(const d of this.peerRouting.getClosestPeers(s,n))l.push(d),d.name==="FINAL_PEER"&&h.push(d);h.forEach(d=>{u.add(async()=>{for await(const g of c(d))l.push(g)}).catch(g=>{this.log.error("error publishing provider record to peer - %e",g)})})}).catch(h=>{l.end(h)}),yield*l,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let s=0;const i=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const u=[];for(const h of a.slice(0,n))try{const d=await this.components.peerStore.get(h,t);u.push({id:h,multiaddrs:d.addresses.map(({multiaddr:g})=>g)})}catch(d){if(d.name!=="NotFoundError")throw d;this.log("no peer store entry for %p",h)}if(yield _3({from:this.components.peerId,messageType:Pt.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield qb({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),s+=u.length,s>=n)return}const c=async function*({peer:u,signal:h,path:d}){const g={type:Pt.GET_PROVIDERS,key:i};yield*o.network.sendRequest(u.id,g,{...t,signal:h,path:d})},l=new ei(a);for await(const u of this.queryManager.run(i,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);const h=[];for(const d of u.providers)l.has(d.id)||(l.add(d.id),h.push(d));if(h.length>0&&(yield qb({from:u.from,providers:h,path:u.path},t),s+=h.length,s>=n))return}}}class fY extends $t{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new Od({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new re("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield Hb({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield Kb({to:e,type:s,path:n.path},n);const c=await this._writeReadMessage(i,t,n);i.close(n).catch(l=>{this.log.error("error closing stream to %p",e,l),i?.abort(l)}),yield _3({from:e,messageType:c.type,closer:c.closer.map(k1),providers:c.providers.map(k1),record:c.record==null?void 0:as.deserialize(c.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield bu({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new re("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield Hb({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield Kb({to:e,type:s,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),i?.abort(c)}),yield _3({from:e,messageType:s,path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),yield bu({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,n){await Fr(e).write(t,Hl,n)}async _writeReadMessage(e,t,n){const s=Fr(e);await s.write(t,Hl,n);const i=await s.read(Hl,n);return i.closer.forEach(o=>{this.safeDispatchEvent("peer",{detail:k1(o)})}),i.providers.forEach(o=>{this.safeDispatchEvent("peer",{detail:k1(o)})}),i}}function sd(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class Yw{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){const s=await Qi(e.id,n);this.addWithKadId(e,s,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const s={peer:e,distance:du(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&sd(s.distance,o.distance)!==-1)return}let i=!1;for(let o=0;o<this.peerDistances.length;o++){const a=sd(this.peerDistances[o].distance,s.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(o,0,s);break}}i||this.peerDistances.push(s),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const n=await Qi(e,t),s=du(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return sd(s,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}}class pY{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n;const s=await this.routingTable.find(e,t);if(s!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(s,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){const s={type:Pt.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=eY(e),s={index:-1,queued:0,running:0,total:0};for await(const i of this._getValueSingle(e,n,{...t,path:s}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const o=Qr(i.record.value),a=uc(o);if(!a.equals(e))throw new mp("public key does not match id");if(a.publicKey==null)throw new mp("public key missing");yield x3({from:e,value:i.record.value,path:s},t)}throw new g0(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const s=await this.findPeerLocal(e,t);if(s!=null){this.log("found local"),yield Ly({from:this.components.peerId,peer:s,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a,path:c}){const l={type:Pt.FIND_NODE,key:e.toMultihash().bytes};for await(const u of s.network.sendRequest(o.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){const h=u.closer.find(d=>d.id.equals(e));h!=null&&(yield Ly({from:u.from,peer:h,path:u.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,i,t))o.name==="FINAL_PEER"&&(n=!0),yield o}if(!n)throw new Zt("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await zd(e,t),s=new Yw(n,this.routingTable.kBucketSize),i=this,o=async function*({peer:a,path:c,peerKadId:l,signal:u}){i.log("getClosestPeers asking %p",a.id);const h={type:Pt.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,h,{...t,signal:u,path:c}),s.addWithKadId(a,l,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",s.length,e);for(let{peer:a,path:c}of s.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield Ly({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record,n)}catch{const o="invalid record received, discarded";this.log(o),yield bu({from:s.from,error:new g0(o),path:n.path},n);continue}yield s}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new HQ("invalid record received");await Qw(this.validators,new as(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const n=[];try{const o=ur(e),a=Bn(o),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}const s=await zd(e,t),i=this.routingTable.closestPeers(s,t);for(const o of i)try{n.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}}class gY{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){const s=$y(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(s,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);const n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){const s=$y(this.datastorePrefix,e,t),i=is(n?.time?.getTime()??Date.now());await this.datastore.put(s,i,n)}async loadProviders(e,t){const n=new $c,s=$y(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:s.toString()},t)){const{peerId:o}=Hk(i.key);n.set(o,zk(i.value))}return n}}const yY=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function mY(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:u}=yY(r),h=(...g)=>{const y=t.multiArgs?g:g[0];t.filter&&!t.filter(y)||(c.push(y),t.count===c.length&&(n(),i(c)))},d=g=>{n(),o(g)};n=()=>{for(const g of a)u(g,h);for(const g of t.rejectionEvents)u(g,d)};for(const g of a)l(g,h);for(const g of t.rejectionEvents)l(g,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=bg(s,{milliseconds:t.timeout});return i.cancel=n,i}return s}function wY(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=mY(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}async function*bY(r){const{key:e,startingPeers:t,ourPeerId:n,query:s,alpha:i,path:o,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:h}=r,d=ls({objectMode:!0}),g=new ta({concurrency:i,sort:(m,_)=>sd(m.options.distance,_.options.distance)});g.addEventListener("idle",()=>{d.push(WQ({path:{index:o,queued:g.queued,running:g.running,total:g.size}},r)),d.end()}),g.addEventListener("error",m=>{c.error("error during query - %e",m.detail)});const y=()=>{g.abort(),d.end(new qi)};h.addEventListener("abort",y);try{let _=function(k,N){if(k==null)return;l.add(k.id.toMultihash().bytes);const I=du(N,m);g.add(async()=>{try{for await(const T of s({...r,key:e,peer:k,path:{index:o,queued:g.queued,running:g.running,total:g.size},numPaths:a,peerKadId:N,signal:h})){if(T.name==="PEER_RESPONSE")for(const x of T.closer){if(l.has(x.id.toMultihash().bytes)){c("already seen %p in query",x.id);continue}if(n.equals(x.id)){c("not querying ourselves");continue}if(!await u.isDialable(x.multiaddrs)){c("not querying undialable peer");continue}const D=await Qi(x.id,{signal:h}),F=du(D,m);if(sd(F,I)!==-1){c("skipping %p as they are not closer to %b than %p",x.id,e,k);continue}c("querying closer peer %p",x.id),_(x,D)}d.push({...T,path:{index:o,queued:g.queued,running:g.running,total:g.size}})}}catch(T){d.push(bu({from:k.id,error:T,path:{index:o,queued:g.queued,running:g.running-1,total:g.size-1}},r))}},{distance:I}).catch(T=>{c.error("error during query - %e",T)})};var w=_;const m=await zd(e,{signal:h});await Promise.all(t.map(async k=>{_({id:k,multiaddrs:[]},await Qi(k,{signal:h}))})),yield*d}finally{h.removeEventListener("abort",y)}}class vY{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??qk,this.alpha=t.alpha??n2,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(VQ);n={...n,signal:c}}const s=new AbortController,i=ut([this.shutDownController.signal,s.signal,n.signal]);s.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+se(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await wY(this.routingTable,"peer:add",{signal:i,filter:g=>!this.peerId.equals(g.detail)}),o("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await Et(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await zd(e,{signal:i}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((g,y,w)=>(g[w%this.disjointPaths].push(y),g),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(g=>g.length>0);if(l.length===0){o.error("running query with no peers");return}const h=Zo(1024),d=u.map((g,y)=>bY({...n,key:e,startingPeers:g,ourPeerId:this.peerId,signal:i,query:t,path:y,numPaths:u.length,alpha:this.alpha,log:o,peersSeen:h,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const g of $o(...d)){if(g.name==="QUERY_ERROR"&&o.error("query error",g.error),g.name==="PEER_RESPONSE")for(const y of[...g.closer,...g.providers])await this.connectionManager.isDialable(y.multiaddrs,{signal:i})&&await this.routingTable.add(y.id,{signal:i});i.throwIfAborted(),yield g}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),s.abort()),i.clear(),o("query finished")}}}function EY(r){return r[Symbol.asyncIterator]!=null}function jk(r){if(EY(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}class SY{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??qk,this.interval=t.interval??BQ,this.initialInterval=t.initialInterval??LQ,this.queryTimeout=t.queryTimeout??$Q,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=Wk(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Qe(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=ut(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),s=await Nn(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>cu(o,this.count),async o=>jk(o));t?.throwIfAborted();const i=Date.now()-n;this.log("self-query found %d peers in %dms",s,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:s,duration:i}}))}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class _Y extends $t{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new ta({concurrency:t.concurrency??RQ,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Od({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??DQ,this.maxQueueSize=t.maxQueueSize??OQ,this.validity=t.validity??PQ,this.interval=t.interval??NQ,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=Wk(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(Ub)}).catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(e){try{this.safeDispatchEvent("reprovide:start");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:n,peerId:s}=Hk(t.key),i=zk(t.value).getTime(),o=i+this.validity,a=Date.now(),c=a>o;this.log.trace("comparing: %d < %d = %s %s",i,a-this.validity,c,c?"(expired)":""),c&&await this.datastore.delete(t.key,e),this.peerId.equals(s)&&a-o<this.reprovideThreshold&&this.queueReprovide(n).catch(l=>{this.log.error("could not reprovide %c - %e",n,l)})}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(Ub)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const n=this.reprovideQueue.queue.find(s=>s.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async s=>{if(s.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const i=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(s=>{this.log.error("could not re-provide key %c - %e",e,s)})}async reprovide(e,t){await ji(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const xY=20,AY=5e3,IY="kad-close",kY=50;class TY{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??AY,this.peerSetSize=t.peerSetSize??xY,this.closeTagName=t.closeTagName??IY,this.closeTagValue=t.closeTagValue??kY,this.closestPeers=new ei,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await Qi(this.components.peerId);this.newPeers=new Yw(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new ei(this.newPeers?.peers.map(({peer:s})=>s.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[Fb]:{value:1}}})}),...[...n].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[Fb]:void 0}})})])}}function J1(r){return Array.isArray(r?.peers)}class CY{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??RY,this.kBucketSize=t.kBucketSize??Xw,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??MY,this.lastPingThreshold=t.lastPingThreshold??UY,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=Sg({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await Qi(e,t),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await Qi(e,t),lastPing:0},s=this.addingPeerMap.get(e);if(s!=null)return s;try{const i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!DY(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const s=n.peers.filter(o=>!(o.peerId.equals(this.localPeer?.peerId)||o.lastPing>Date.now()-this.lastPingThreshold)).sort((o,a)=>o.lastPing<a.lastPing?-1:o.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing);let i=!1;for await(const o of this.ping(s,t))i=!0,await this.remove(o.kadId,t);i&&await this._add(e,t)}*closest(e,t){const n=new Yw(e,t?.count??this.kBucketSize);for(const s of this.toIterable())t?.exclude?.some(i=>i.equals(s.peerId))!==!0&&n.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*yc(n.peers,({peer:s})=>s.id)}count(){function e(t){if(J1(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){const n=this._determineBucket(e),s=this._indexOf(n,e);if(s>-1){const i=n.peers.splice(s,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(J1(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+se(du(e,t),"base16"))}_determineBucket(e){const t=se(e,"base2");function n(s,i=0){return J1(s)?s:t[i]==="0"?n(s.left,i+1):n(s.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>We(n.kadId,t))}async _split(e,t){const n={prefix:"0",depth:e.depth+1,peers:[]},s={prefix:"1",depth:e.depth+1,peers:[]};for(const i of e.peers)se(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(s.peers.push(i),await this.onMove?.(i,e,s,t));PY(e,n,s)}}function PY(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function DY(r,e){return r.lastPing<Date.now()-e}const Xw=20,RY=6,OY=20,NY=100,MY=3,BY=20,LY=100,Wb="kad-peer",$Y=1,UY=6e5,FY=!0,VY=1e3;class KY extends $t{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??Xw,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??Wb,this.peerTagValue=t.peerTagValue??$Y,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??FY,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??VY,this.shutdownController=new AbortController,this.pingOldContactQueue=new ra({concurrency:t.pingOldContactConcurrency??BY,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??LY}),this.pingOldContactTimeout=new Od({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new ra({concurrency:t.pingNewContactConcurrency??OY,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??NY}),this.pingNewContactTimeout=new Od({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new CY(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new TY(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,await Hi(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=ut([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const n of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(Wb)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await la(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const n=[];for(const s of e){if(this.kb.get(s.kadId)==null){this.log("asked to ping contact %p that was not in routing table",s.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{const i=this.pingOldContactQueue.find(s.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",s.peerId),await i.join(t)?void 0:s;if(!await this.pingOldContactQueue.add(async a=>{const c=this.pingOldContactTimeout.getTimeoutSignal(),l=ut([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(s,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:s.peerId,signal:t?.signal}))return s})}for await(const s of kg(n))s!=null&&(yield s)}async verifyNewContact(e,t){const n=this.pingNewContactTimeout.getTimeoutSignal(),s=ut([n,this.shutdownController.signal,t?.signal]);try{const i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:s})):await this.pingNewContactQueue.add(async o=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,o)),{peerId:e.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),s.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(n){return this.log("error pinging old contact %p - %e",e.peerId,n),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const n=await Qi(e,t);return this.kb.get(n)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await Qi(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,s=20,i=0;function o(a){if(J1(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<s&&(s=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}o(a.left),o(a.right)}o(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}}const qY=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],T1=15;class HY{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=s,this.refreshInterval=i??UQ,this.refreshQueryTimeout=o??FQ,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const n=this._maxCommonPrefix(),s=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${s.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(s.map(async(i,o)=>{try{if(await this._refreshCommonPrefixLength(o,i,e,t),this._numPeersForCpl(n)===0){const a=Math.min(2*(o+1),s.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(l){this.log.error(l)}}}catch(a){this.log.error(a)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n,s){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const o=ut([s?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await jk(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>T1&&(e=T1);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=Yo(2),n=(t[1]<<8)+t[0],s=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=ur(s);return Bn(i)}_makePeerId(e,t,n){if(n>T1)throw new Error(`Cannot generate peer ID for common prefix length greater than ${T1}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=qY[c],u=new ArrayBuffer(34),h=new DataView(u,0,u.byteLength);return h.setUint8(0,fn.code),h.setUint8(1,32),h.setUint32(2,l,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=du(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}class zY{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new It("Missing key");let n;try{n=$e.decode(t.key)}catch{throw new It("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async s=>{const i=ur(s.id),o=Bn(i),a=s.multiaddrs.map(c=>De(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class WY{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new It("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});We(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(qu("p2p").code))});const s={type:Pt.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",s.closer.length,t.key,e),s}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}}class jY{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:s,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new It("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=$e.decode(t.key)}catch{throw new It("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([$p(yc(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:Pt.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class GY{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new It("Invalid key");const s={type:Pt.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(tY(n)){this.log("is public key");const a=rY(n);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new Zt("No public key found in key book");c=Rn(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),s.record=new as(n,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=nd(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}const s=as.deserialize(n);if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>TQ){await this.datastore.delete(t);return}return s}}class QY{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class YY{components;validators;log;datastorePrefix;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){const s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new It(s)}try{const s=as.deserialize(t.record);await Qw(this.validators,s),s.timeReceived=new Date;const i=nd(this.datastorePrefix,s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}}let XY=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[Pt.GET_VALUE.toString()]:new GY(e,t),[Pt.PUT_VALUE.toString()]:new YY(e,t),[Pt.FIND_NODE.toString()]:new WY(e,t),[Pt.ADD_PROVIDER.toString()]:new zY(e,t),[Pt.GET_PROVIDERS.toString()]:new jY(e,t),[Pt.PING.toString()]:new QY(e,t)}}async handleMessage(e,t){const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{const{stream:n,connection:s}=e,i=()=>{n.abort(new of)};let o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",i);const a=Fr(n).pb(Hl);try{for(;;){const c=await a.read({signal:o}),l=this.metrics?.rpcTime?.timer(c.type.toString()),u=this.metrics?.rpcTime?.timer(c.type.toString());let h=!1;try{this.log("incoming %s from %p",c.type,s.remotePeer);const d=await this.handleMessage(s.remotePeer,c);d!=null&&await a.write(d,{signal:o})}catch(d){throw h=!0,u?.(),d}finally{h||l?.()}o.removeEventListener("abort",i),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",i)}}catch(c){n.abort(c)}}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};class ZY extends $t{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:s}=t;this.components=e,this.log=e.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class JY{dht;constructor(e){this.dht=e}async provide(e,t={}){await ji(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await ji(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new Zt("Could not find value for key")}}class eX{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new Zt("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const tX=32,rX=64;class nX extends $t{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const n=t.logPrefix??"libp2p:kad-dht",s=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",o={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??Xw,this.a=t.alpha??n2,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??CQ,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??tX,this.maxOutboundStreams=t.maxOutboundStreams??rX,this.peerInfoMapper=t.peerInfoMapper??JQ,this.onPeerConnectTimeout=t.onPeerConnectTimeout??MQ,this.providers=new gY(e,{...t.providers,logPrefix:n,datastorePrefix:s}),this.validators={...XQ,...t.validators},this.selectors={...QQ,...t.selectors},this.network=new fY(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new KY(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const a=Qe();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new vY(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new pY(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new uY(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:s}),this.contentRouting=new dY(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new HY(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new XY(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new ZY(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new SY(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:o}),this.reprovider=new _Y(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:s,contentRouting:this.contentRouting,operationMetrics:o}),this.network.addEventListener("peer",c=>{const l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{const l=c.detail;Promise.resolve().then(async()=>{const u=await this.components.peerStore.get(l),h={id:l,multiaddrs:u.addresses.map(({multiaddr:d})=>d),protocols:u.protocols};await this.onPeerConnect(h)}).catch(u=>{this.log.error("could not add %p to routing table - %e - %e",l,u)})}),this.dhtPeerRouting=new eX(this),this.dhtContentRouting=new JY(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const l=c.detail.peer.addresses.some(({multiaddr:h})=>lY(h)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode",l)})}),this.get=pl(this.get.bind(this),o,"GET_VALUE"),this.findProviders=pl(this.findProviders.bind(this),o,"FIND_PROVIDERS"),this.findPeer=pl(this.findPeer.bind(this),o,"FIND_PEER"),this.getClosestPeers=pl(this.getClosestPeers.bind(this),o,"GET_CLOSEST_PEERS"),this.provide=pl(this.provide.bind(this),o,"PROVIDE"),this.put=pl(this.put.bind(this),o,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[lr]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[jo]=["@libp2p/identify","@libp2p/ping"];get[Xl](){return this.dhtContentRouting}get[Zl](){return this.dhtPeerRouting}get[wd](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await Hi(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Hi(this.querySelf))}async stop(){this.running=!1,await la(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var jb;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(jb||(jb={}));function sX(r={}){return e=>new nX(e,r)}var nt;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(nt||(nt={}));const Zw=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Gb=Object.freeze({NEW_STREAM:nt.NEW_STREAM,MESSAGE:nt.MESSAGE_INITIATOR,CLOSE:nt.CLOSE_INITIATOR,RESET:nt.RESET_INITIATOR}),iX=Object.freeze({MESSAGE:nt.MESSAGE_RECEIVER,CLOSE:nt.CLOSE_RECEIVER,RESET:nt.RESET_RECEIVER}),Gk=1<<20,oX=4<<20;let aX=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=Gk,t=oX){this._buffer=new Ve,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new It("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}const{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:n,type:s};(s===nt.NEW_STREAM||s===nt.MESSAGE_INITIATOR||s===nt.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=Yb(e),{value:s,offset:i}=Yb(e,n),o=t&7;if(Zw[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw new It("Message size too large");return{id:t>>3,type:o,offset:n+i,length:s}}};const cX=128,Qb=127;function Yb(r,e=0){let t=0,n=0,s=e,i;const o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&Qb)<<n:(i&Qb)*Math.pow(2,n),n+=7}while(i>=cX);return e=s-e,{value:t,offset:e}}const Uy=10*1024;let lX=class{_pool;_poolOffset;constructor(){this._pool=dn(Uy),this._poolOffset=0}write(e,t){const n=this._pool;let s=this._poolOffset;is(e.id<<3|e.type,n,s),s+=At(e.id<<3|e.type),(e.type===nt.NEW_STREAM||e.type===nt.MESSAGE_INITIATOR||e.type===nt.MESSAGE_RECEIVER)&&e.data!=null?(is(e.data.length,n,s),s+=At(e.data.length)):(is(0,n,s),s+=At(0));const i=n.subarray(this._poolOffset,s);Uy-s<100?(this._pool=dn(Uy),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===nt.NEW_STREAM||e.type===nt.MESSAGE_INITIATOR||e.type===nt.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const uX=new lX;async function*hX(r){for await(const e of r){const t=new Ve;uX.write(e,t),yield t}}class dX extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}class fX extends jw{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?Gb:iX,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:Gb.NEW_STREAM,data:new Ve(ie(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function pX(r){const{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=Gk}=r;return new fX({id:i==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:s,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${i}:${e}`)})}const gX=1024,yX=1024,mX=1024*1024*4,wX=5,bX=500;function Xb(r){const e={...r,type:`${Zw[r.type]} (${r.type})`};return r.type===nt.NEW_STREAM&&(e.data=se(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===nt.MESSAGE_INITIATOR||r.type===nt.MESSAGE_RECEIVER)&&(e.data=se(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class vX{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??bX,this.sink=this._createSink(),this._source=ls({objectMode:!0,onEnd:()=>{for(const n of this._streams.initiators.values())n.destroy();for(const n of this._streams.receivers.values())n.destroy()}}),this.source=Nn(this._source,n=>hX(n)),this.closeController=new AbortController,this.rateLimiter=new Hx({points:t.disconnectThreshold??wX,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Al("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;const t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){const{id:t,name:n,type:s,registry:i}=e;if(this.log("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??yX))throw new k6("Too many outbound streams open");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);const c=pX({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",s,t,Xb(l)),this._source.push(l)},type:s,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",s,t,c.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(t,c),c}_createSink(){return async t=>{const n=()=>{_k(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{const s=new aX(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of t)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){this.log("error in sink",s),this._source.end(s)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){const{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",Xb(e)),e.type===nt.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??gX)){this.log("too many inbound streams open"),this._source.push({id:t,type:nt.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:se(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){this.log("missing stream %s for message type %s",t,Zw[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??mX;try{switch(n){case nt.MESSAGE_INITIATOR:case nt.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o)throw this._source.push({id:e.id,type:n===nt.MESSAGE_INITIATOR?nt.RESET_RECEIVER:nt.RESET_INITIATOR}),new dX("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");i.sourcePush(e.data);break;case nt.CLOSE_INITIATOR:case nt.CLOSE_RECEIVER:i.remoteCloseWrite();break;case nt.RESET_INITIATOR:case nt.RESET_RECEIVER:i.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),i.abort(a)}}}class EX{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[lr]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new vX(this.components,{...e,...this._init})}}function SX(r={}){return e=>new EX(e,r)}const Fy=32,_X="1.0.0",xX="ping",AX="ipfs",IX=1e4,kX=2,TX=1;class CX{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??AX}/${xX}/${_X}`,this.timeout=t.timeout??IX,this.maxInboundStreams=t.maxInboundStreams??kX,this.maxOutboundStreams=t.maxOutboundStreams??TX,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[lr]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now(),s=zp(t);let i=!1;Promise.resolve().then(async()=>{for(;;){const o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{t?.abort(new of("ping timeout"))});const a=await s.read({bytes:Fy,signal:o});await s.write(a,{signal:o}),i=!0}}).catch(o=>{i&&o.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,o),t?.abort(o))}).finally(()=>{const o=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o);const a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t?.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),s=Yo(Fy),i=await this.components.connectionManager.openConnection(e,t);let o;if(t.signal==null){const a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{o=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const a=zp(o),[,c]=await Promise.all([a.write(s,t),a.read({...t,bytes:Fy})]),l=Date.now()-n;if(!We(s,c.subarray()))throw new FD(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",i.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",i.remotePeer,a),o?.abort(a),a}finally{o!=null&&await o.close(t)}}}function Qk(r={}){return e=>new CX(e,r)}var en;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(n){n.codec=()=>gn(e)}(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=Pe((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.flag!=null&&(s.uint32(8),r.Flag.codec().encode(n.flag,s)),n.message!=null&&(s.uint32(18),s.bytes(n.message)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.flag=r.Flag.codec().decode(n);break}case 2:{o.message=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Ce(n,r.codec()),r.decode=(n,s)=>Te(n,r.codec(),s)})(en||(en={}));const PX=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],Zb=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),DX="libp2p+webrtc+v1/",RX=466,OX=2*1024*1024,NX=30*1e3,s2=16*1024;function MX(r=s2){const e=At(r-At(r)),t=1+At(Object.keys(en.Flag).length-1),n=1,s=r-e-t-n,i=At(s);return e+t+n+i}const BX=MX(),LX=5e3,$X=5e3,UX=3e4,Yk="/webrtc",A3="/webrtc-signaling/0.0.1",FX="/libp2p/webrtc-direct/certificate",VX="webrtc-direct-certificate-private-key",KX=12096e5,Jb=864e5;function qX(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Xk={exports:{}},Wt=Xk.exports={},js,Gs;function I3(){throw new Error("setTimeout has not been defined")}function k3(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?js=setTimeout:js=I3}catch{js=I3}try{typeof clearTimeout=="function"?Gs=clearTimeout:Gs=k3}catch{Gs=k3}})();function Zk(r){if(js===setTimeout)return setTimeout(r,0);if((js===I3||!js)&&setTimeout)return js=setTimeout,setTimeout(r,0);try{return js(r,0)}catch{try{return js.call(null,r,0)}catch{return js.call(this,r,0)}}}function HX(r){if(Gs===clearTimeout)return clearTimeout(r);if((Gs===k3||!Gs)&&clearTimeout)return Gs=clearTimeout,clearTimeout(r);try{return Gs(r)}catch{try{return Gs.call(null,r)}catch{return Gs.call(this,r)}}}var Oi=[],zl=!1,Ha,ep=-1;function zX(){!zl||!Ha||(zl=!1,Ha.length?Oi=Ha.concat(Oi):ep=-1,Oi.length&&Jk())}function Jk(){if(!zl){var r=Zk(zX);zl=!0;for(var e=Oi.length;e;){for(Ha=Oi,Oi=[];++ep<e;)Ha&&Ha[ep].run();ep=-1,e=Oi.length}Ha=null,zl=!1,HX(r)}}Wt.nextTick=function(r){var e=new Array(arguments.length-1);if(arguments.length>1)for(var t=1;t<arguments.length;t++)e[t-1]=arguments[t];Oi.push(new eT(r,e)),Oi.length===1&&!zl&&Zk(Jk)};function eT(r,e){this.fun=r,this.array=e}eT.prototype.run=function(){this.fun.apply(null,this.array)};Wt.title="browser";Wt.browser=!0;Wt.env={};Wt.argv=[];Wt.version="";Wt.versions={};function so(){}Wt.on=so;Wt.addListener=so;Wt.once=so;Wt.off=so;Wt.removeListener=so;Wt.removeAllListeners=so;Wt.emit=so;Wt.prependListener=so;Wt.prependOnceListener=so;Wt.listeners=function(r){return[]};Wt.binding=function(r){throw new Error("process.binding is not supported")};Wt.cwd=function(){return"/"};Wt.chdir=function(r){throw new Error("process.chdir is not supported")};Wt.umask=function(){return 0};var WX=Xk.exports;const tp=qX(WX);var ev=function(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},jX=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}(),GX=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=tp.platform}return r}(),QX=function(){function r(e,t,n,s){this.name=e,this.version=t,this.os=n,this.bot=s,this.type="bot-device"}return r}(),YX=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}(),XX=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}(),ZX=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,JX=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,tv=3,eZ=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",ZX]],rv=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function tZ(r){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new XX:typeof navigator<"u"?nZ(navigator.userAgent):iZ()}function rZ(r){return r!==""&&eZ.reduce(function(e,t){var n=t[0],s=t[1];if(e)return e;var i=s.exec(r);return!!i&&[n,i]},!1)}function nZ(r){var e=rZ(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new YX;var s=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);s?s.length<tv&&(s=ev(ev([],s,!0),oZ(tv-s.length),!0)):s=[];var i=s.join("."),o=sZ(r),a=JX.exec(r);return a&&a[1]?new QX(t,i,o,a[1]):new jX(t,i,o)}function sZ(r){for(var e=0,t=rv.length;e<t;e++){var n=rv[e],s=n[0],i=n[1],o=i.exec(r);if(o)return s}return null}function iZ(){var r=typeof tp<"u"&&tp.version;return r?new GX(tp.version.slice(1)):null}function oZ(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}const nv=tZ(),Jw=nv!=null&&nv.name==="firefox",tT=async function*(){},rT=async r=>{};function aZ(r,e,t=UX,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);const s=Qe();let i=!1;r.bufferedAmountLowThreshold=0;const o=()=>{i||(n.log("%s drain channel closed before drain",e),s.resolve())};r.addEventListener("close",o,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",o),s.resolve()}),await bg(s.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(s=>{n.log.error("error closing outbound stream",s)})}async function sv(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??PX.map(e=>({urls:[e]})),r}const cZ=(r=32)=>DX+[...Array(r)].map(()=>Zb.at(Math.floor(Math.random()*Zb.length))).join("");class T3{log;peerConnection;remoteAddr;timeline;metrics;source=tT();sink=rT;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection,s=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",s),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}class lZ extends jw{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){const t=e.onEnd;switch(e.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await bg(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),t?.(s)}).catch(i=>{this.log.error("error ending stream",i)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=ls(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??NX,this.maxBufferedAmount=e.maxBufferedAmount??OX,this.maxMessageSize=(e.maxMessageSize??s2)-BX,this.receiveFinAck=Qe(),this.finAckTimeout=e.closeTimeout??LX,this.openTimeout=e.openTimeout??$X,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new Cm("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const i=s.error;this.abort(i)},this.channel.onmessage=async s=>{const{data:i}=s;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};const n=this;Promise.resolve().then(async()=>{for await(const s of Md(this.incomingData)){const i=n.processIncomingProtobuf(s);i!=null&&n.sourcePush(new Ve(i))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new Cm(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const n=AbortSignal.timeout(this.openTimeout),s=ut([this.closeController.signal,n]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await zr(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){const n=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=ut([this.closeController.signal,n]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await zr(this.channel,"bufferedamountlow",s)}catch(i){throw n.aborted?new of(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):i}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(n){this.log.error("error while sending message",n)}}async sendData(e){const t=e.byteLength;for(e=e.sublist();e.byteLength>0;){const n=Math.min(e.byteLength,this.maxMessageSize),s=e.subarray(0,n),i=en.encode({message:s}),o=Nd.single(i);this.log.trace("sending %d/%d bytes on channel",s.byteLength,t),await this._sendMessage(o),e.consume(n)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(en.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(en.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Et(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(en.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=en.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===en.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(en.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===en.Flag.RESET&&this.reset(),t.flag===en.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===en.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=en.encode({flag:e}),n=Nd.single(t);try{return await this._sendMessage(n,!1),!0}catch(s){this.log.error("could not send flag %s - %e",e.toString(),s)}return!1}}function m0(r){const{channel:e,direction:t,handshake:n}=r;return new lZ({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}class e5{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??Yk,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}const s={},i=m0({channel:n,direction:"inbound",onEnd:o=>{s.onEnd(o)},logger:e.logger,...this.dataChannelOptions});s.stream=i,s.channel=n,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==i.id)},this.bufferedStreams.push(s)}}createStreamMuxer(e){return new uZ(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class uZ{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??Yk,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}const s=n.id,i=m0({channel:n,direction:"inbound",onEnd:()=>{this.#e(i,n),this.log("incoming channel %s ended",s)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),aZ(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}source=tT();sink=rT;newStream(){const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const n=m0({channel:e,direction:"outbound",onEnd:()=>{this.#e(n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),this.metrics?.increment({outgoing_stream:!0}),n}}const nT=globalThis.RTCPeerConnection,sT=globalThis.RTCSessionDescription,hZ=globalThis.RTCIceCandidate;class Rf extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class No extends Rf{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class dZ extends Rf{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class fZ extends Rf{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class pZ extends Rf{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var Is;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(n){n.codec=()=>gn(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Pe((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.data!=null&&(s.uint32(18),s.string(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.data=n.string();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Ce(n,r.codec()),r.decode=(n,s)=>Te(n,r.codec(),s)})(Is||(Is={}));const iT=async(r,e,t)=>{try{const n=Qe();for(gZ(r,n);;){const s=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(s==null){t.signal?.throwIfAborted();break}if(s.type!==Is.Type.ICE_CANDIDATE)throw new It("ICE candidate message expected");const i=JSON.parse(s.data??"null");if(i===""||i===null){t.onProgress?.(new xe("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const o=new hZ(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new xe("webrtc:add-ice-candidate",o.candidate)),await r.addIceCandidate(o)}catch(a){t.log.error("%s bad candidate received",t.direction,i,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0&&t5(r)!=="connected")throw n}};function t5(r){return Jw?r.iceConnectionState:r.connectionState}function gZ(r,e){r[Jw?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(t5(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new fS("RTCPeerConnection was closed"));break}}}async function yZ({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:s,connectionManager:i,transportManager:o,log:a,logger:c,onProgress:l}){const{circuitAddress:u,targetPeer:h}=bZ(s);n?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",u);const d=i.getConnections(h);let g;d.length===0?(l?.(new xe("webrtc:dial-relay")),g=await o.dial(u,{signal:t,onProgress:l})):(l?.(new xe("webrtc:reuse-relay-connection")),g=d[0]),l?.(new xe("webrtc:open-signaling-stream"));const y=await g.newStream(A3,{signal:t,runOnLimitedConnection:!0}),w=Fr(y).pb(Is),m=new nT(r),_=new e5({logger:c},{peerConnection:m,dataChannelOptions:e});try{const k=m.createDataChannel("init");m.onicecandidate=({candidate:x})=>{const D=JSON.stringify(x?.toJSON()??null);a.trace("initiator sending ICE candidate %o",x),w.write({type:Is.Type.ICE_CANDIDATE,data:D},{signal:t}).catch(F=>{a.error("error sending ICE candidate",F)})},m.onicecandidateerror=x=>{a.error("initiator ICE candidate error",x)};const N=await m.createOffer().catch(x=>{throw a.error("could not execute createOffer",x),new No("Failed to set createOffer")});a.trace("initiator send SDP offer %s",N.sdp),l?.(new xe("webrtc:send-sdp-offer")),await w.write({type:Is.Type.SDP_OFFER,data:N.sdp},{signal:t}),await m.setLocalDescription(N).catch(x=>{throw a.error("could not execute setLocalDescription",x),new No("Failed to set localDescription")}),l?.(new xe("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const I=await w.read({signal:t});if(I.type!==Is.Type.SDP_ANSWER)throw new No("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",I.data);const T=new sT({type:"answer",sdp:I.data});return await m.setRemoteDescription(T).catch(x=>{throw a.error("could not execute setRemoteDescription",x),new No("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new xe("webrtc:read-ice-candidates")),await iT(m,w,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),k.close(),l?.(new xe("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await y.close({signal:t}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:m,muxerFactory:_}}catch(k){throw a.error("outgoing signaling error",k),m.close(),y.abort(k),k}finally{m.onicecandidate=null,m.onicecandidateerror=null}}const iv=St(Vx.matchers[0],xt(Lc));class r5 extends $t{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>iv.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof r5)).map(e=>e.getAddrs().filter(t=>iv.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function mZ({peerConnection:r,stream:e,signal:t,connection:n,log:s}){s.trace("new inbound signaling stream");const i=Fr(e).pb(Is);try{r.onicecandidate=({candidate:u})=>{const h=JSON.stringify(u?.toJSON()??null);s.trace("recipient sending ICE candidate %s",h),i.write({type:Is.Type.ICE_CANDIDATE,data:h},{signal:t}).catch(d=>{s.error("error sending ICE candidate",d)})},s.trace("recipient read SDP offer");const a=await i.read({signal:t});if(a.type!==Is.Type.SDP_OFFER)throw new No(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);s.trace("recipient received SDP offer %s",a.data);const c=new sT({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(u=>{throw s.error("could not execute setRemoteDescription",u),new No("Failed to set remoteDescription")});const l=await r.createAnswer().catch(u=>{throw s.error("could not execute createAnswer",u),new No("Failed to create answer")});s.trace("recipient send SDP answer %s",l.sdp),await i.write({type:Is.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(u=>{throw s.error("could not execute setLocalDescription",u),new No("Failed to set localDescription")}),s.trace("recipient read candidates until connected"),await iT(r,i,{direction:"recipient",signal:t,log:s})}catch(a){if(t5(r)!=="connected")throw s.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}const o=De(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",o),{remoteAddress:o}}class wZ{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[ug]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[lr]=["@libp2p/transport"];[jo]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(A3,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(A3),this._started=!1}createListener(e){return new r5(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(jm.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:s,muxerFactory:i}=await yZ({rtcConfiguration:await sv(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new T3(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(s,o),a}async _onProtocol({connection:e,stream:t},n){const s=new nT(await sv(this.init.rtcConfiguration)),i=new e5(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o}=await mZ({peerConnection:s,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const a=new T3(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:o,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:i,signal:n}),this._closeOnShutdown(s,a)}catch(o){throw this.log.error("incoming signaling error",o),s.close(),t.abort(o),o}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function bZ(r){const e=r.getComponents().filter(({name:n})=>n==="p2p").map(({value:n})=>n).pop();if(e==null)throw new re("Destination peer id was missing");return{circuitAddress:De(r.getComponents().filter(({name:n})=>n!=="webrtc")),targetPeer:nr(e)}}const C1=globalThis||void 0||self;/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var ov;(function(r){(function(e){var t=typeof globalThis=="object"?globalThis:typeof Rp=="object"?Rp:typeof self=="object"?self:typeof this=="object"?this:a(),n=s(r);typeof t.Reflect<"u"&&(n=s(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function s(c,l){return function(u,h){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:h}),l&&l(u,h)}}function i(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||o()}})(function(e,t){var n=Object.prototype.hasOwnProperty,s=typeof Symbol=="function",i=s&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=s&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return E(Object.create(null))}:c?function(){return E({__proto__:null})}:function(){return E({})},has:l?function(f,p){return n.call(f,p)}:function(f,p){return p in f},get:l?function(f,p){return n.call(f,p)?f[p]:void 0}:function(f,p){return f[p]}},h=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:Jc(),g=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:bn(),y=typeof WeakMap=="function"?WeakMap:lh(),w=s?Symbol.for("@reflect-metadata:registry"):void 0,m=Zc(),_=lo(m);function k(f,p,v,A){if(j(v)){if(!at(f))throw new TypeError;if(!tt(p))throw new TypeError;return P(f,p)}else{if(!at(f))throw new TypeError;if(!Q(p))throw new TypeError;if(!Q(A)&&!j(A)&&!me(A))throw new TypeError;return me(A)&&(A=void 0),v=Ke(v),M(f,p,v,A)}}e("decorate",k);function N(f,p){function v(A,B){if(!Q(A))throw new TypeError;if(!j(B)&&!yt(B))throw new TypeError;z(f,p,A,B)}return v}e("metadata",N);function I(f,p,v,A){if(!Q(v))throw new TypeError;return j(A)||(A=Ke(A)),z(f,p,v,A)}e("defineMetadata",I);function T(f,p,v){if(!Q(p))throw new TypeError;return j(v)||(v=Ke(v)),K(f,p,v)}e("hasMetadata",T);function x(f,p,v){if(!Q(p))throw new TypeError;return j(v)||(v=Ke(v)),H(f,p,v)}e("hasOwnMetadata",x);function D(f,p,v){if(!Q(p))throw new TypeError;return j(v)||(v=Ke(v)),$(f,p,v)}e("getMetadata",D);function F(f,p,v){if(!Q(p))throw new TypeError;return j(v)||(v=Ke(v)),L(f,p,v)}e("getOwnMetadata",F);function R(f,p){if(!Q(f))throw new TypeError;return j(p)||(p=Ke(p)),q(f,p)}e("getMetadataKeys",R);function C(f,p){if(!Q(f))throw new TypeError;return j(p)||(p=Ke(p)),Y(f,p)}e("getOwnMetadataKeys",C);function O(f,p,v){if(!Q(p))throw new TypeError;if(j(v)||(v=Ke(v)),!Q(p))throw new TypeError;j(v)||(v=Ke(v));var A=Kn(p,v,!1);return j(A)?!1:A.OrdinaryDeleteMetadata(f,p,v)}e("deleteMetadata",O);function P(f,p){for(var v=f.length-1;v>=0;--v){var A=f[v],B=A(p);if(!j(B)&&!me(B)){if(!tt(B))throw new TypeError;p=B}}return p}function M(f,p,v,A){for(var B=f.length-1;B>=0;--B){var W=f[B],Ee=W(p,v,A);if(!j(Ee)&&!me(Ee)){if(!Q(Ee))throw new TypeError;A=Ee}}return A}function K(f,p,v){var A=H(f,p,v);if(A)return!0;var B=co(p);return me(B)?!1:K(f,B,v)}function H(f,p,v){var A=Kn(p,v,!1);return j(A)?!1:ke(A.OrdinaryHasOwnMetadata(f,p,v))}function $(f,p,v){var A=H(f,p,v);if(A)return L(f,p,v);var B=co(p);if(!me(B))return $(f,B,v)}function L(f,p,v){var A=Kn(p,v,!1);if(!j(A))return A.OrdinaryGetOwnMetadata(f,p,v)}function z(f,p,v,A){var B=Kn(v,A,!0);B.OrdinaryDefineOwnMetadata(f,p,v,A)}function q(f,p){var v=Y(f,p),A=co(f);if(A===null)return v;var B=q(A,p);if(B.length<=0)return v;if(v.length<=0)return B;for(var W=new g,Ee=[],we=0,Z=v;we<Z.length;we++){var ne=Z[we],ee=W.has(ne);ee||(W.add(ne),Ee.push(ne))}for(var be=0,Fe=B;be<Fe.length;be++){var ne=Fe[be],ee=W.has(ne);ee||(W.add(ne),Ee.push(ne))}return Ee}function Y(f,p){var v=Kn(f,p,!1);return v?v.OrdinaryOwnMetadataKeys(f,p):[]}function X(f){if(f===null)return 1;switch(typeof f){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return f===null?1:6;default:return 6}}function j(f){return f===void 0}function me(f){return f===null}function de(f){return typeof f=="symbol"}function Q(f){return typeof f=="object"?f!==null:typeof f=="function"}function J(f,p){switch(X(f)){case 0:return f;case 1:return f;case 2:return f;case 3:return f;case 4:return f;case 5:return f}var v="string",A=Vr(f,i);if(A!==void 0){var B=A.call(f,v);if(Q(B))throw new TypeError;return B}return ge(f)}function ge(f,p){var v,A,B;{var W=f.toString;if(et(W)){var A=W.call(f);if(!Q(A))return A}var v=f.valueOf;if(et(v)){var A=v.call(f);if(!Q(A))return A}}throw new TypeError}function ke(f){return!!f}function Ue(f){return""+f}function Ke(f){var p=J(f);return de(p)?p:Ue(p)}function at(f){return Array.isArray?Array.isArray(f):f instanceof Object?f instanceof Array:Object.prototype.toString.call(f)==="[object Array]"}function et(f){return typeof f=="function"}function tt(f){return typeof f=="function"}function yt(f){switch(X(f)){case 3:return!0;case 4:return!0;default:return!1}}function hr(f,p){return f===p||f!==f&&p!==p}function Vr(f,p){var v=f[p];if(v!=null){if(!et(v))throw new TypeError;return v}}function Vn(f){var p=Vr(f,o);if(!et(p))throw new TypeError;var v=p.call(f);if(!Q(v))throw new TypeError;return v}function Yc(f){return f.value}function Xc(f){var p=f.next();return p.done?!1:p}function yi(f){var p=f.return;p&&p.call(f)}function co(f){var p=Object.getPrototypeOf(f);if(typeof f!="function"||f===h||p!==h)return p;var v=f.prototype,A=v&&Object.getPrototypeOf(v);if(A==null||A===Object.prototype)return p;var B=A.constructor;return typeof B!="function"||B===f?p:B}function ch(){var f;!j(w)&&typeof t.Reflect<"u"&&!(w in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(f=Zr(t.Reflect));var p,v,A,B=new y,W={registerProvider:Ee,getProvider:Z,setProvider:ee};return W;function Ee(be){if(!Object.isExtensible(W))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case f===be:break;case j(p):p=be;break;case p===be:break;case j(v):v=be;break;case v===be:break;default:A===void 0&&(A=new g),A.add(be);break}}function we(be,Fe){if(!j(p)){if(p.isProviderFor(be,Fe))return p;if(!j(v)){if(v.isProviderFor(be,Fe))return p;if(!j(A))for(var ve=Vn(A);;){var Re=Xc(ve);if(!Re)return;var Ot=Yc(Re);if(Ot.isProviderFor(be,Fe))return yi(ve),Ot}}}if(!j(f)&&f.isProviderFor(be,Fe))return f}function Z(be,Fe){var ve=B.get(be),Re;return j(ve)||(Re=ve.get(Fe)),j(Re)&&(Re=we(be,Fe),j(Re)||(j(ve)&&(ve=new d,B.set(be,ve)),ve.set(Fe,Re))),Re}function ne(be){if(j(be))throw new TypeError;return p===be||v===be||!j(A)&&A.has(be)}function ee(be,Fe,ve){if(!ne(ve))throw new Error("Metadata provider not registered.");var Re=Z(be,Fe);if(Re!==ve){if(!j(Re))return!1;var Ot=B.get(be);j(Ot)&&(Ot=new d,B.set(be,Ot)),Ot.set(Fe,ve)}return!0}}function Zc(){var f;return!j(w)&&Q(t.Reflect)&&Object.isExtensible(t.Reflect)&&(f=t.Reflect[w]),j(f)&&(f=ch()),!j(w)&&Q(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,w,{enumerable:!1,configurable:!1,writable:!1,value:f}),f}function lo(f){var p=new y,v={isProviderFor:function(ne,ee){var be=p.get(ne);return j(be)?!1:be.has(ee)},OrdinaryDefineOwnMetadata:Ee,OrdinaryHasOwnMetadata:B,OrdinaryGetOwnMetadata:W,OrdinaryOwnMetadataKeys:we,OrdinaryDeleteMetadata:Z};return m.registerProvider(v),v;function A(ne,ee,be){var Fe=p.get(ne),ve=!1;if(j(Fe)){if(!be)return;Fe=new d,p.set(ne,Fe),ve=!0}var Re=Fe.get(ee);if(j(Re)){if(!be)return;if(Re=new d,Fe.set(ee,Re),!f.setProvider(ne,ee,v))throw Fe.delete(ee),ve&&p.delete(ne),new Error("Wrong provider for target.")}return Re}function B(ne,ee,be){var Fe=A(ee,be,!1);return j(Fe)?!1:ke(Fe.has(ne))}function W(ne,ee,be){var Fe=A(ee,be,!1);if(!j(Fe))return Fe.get(ne)}function Ee(ne,ee,be,Fe){var ve=A(be,Fe,!0);ve.set(ne,ee)}function we(ne,ee){var be=[],Fe=A(ne,ee,!1);if(j(Fe))return be;for(var ve=Fe.keys(),Re=Vn(ve),Ot=0;;){var jt=Xc(Re);if(!jt)return be.length=Ot,be;var vn=Yc(jt);try{be[Ot]=vn}catch(dr){try{yi(Re)}finally{throw dr}}Ot++}}function Z(ne,ee,be){var Fe=A(ee,be,!1);if(j(Fe)||!Fe.delete(ne))return!1;if(Fe.size===0){var ve=p.get(ee);j(ve)||(ve.delete(be),ve.size===0&&p.delete(ve))}return!0}}function Zr(f){var p=f.defineMetadata,v=f.hasOwnMetadata,A=f.getOwnMetadata,B=f.getOwnMetadataKeys,W=f.deleteMetadata,Ee=new y,we={isProviderFor:function(Z,ne){var ee=Ee.get(Z);return!j(ee)&&ee.has(ne)?!0:B(Z,ne).length?(j(ee)&&(ee=new g,Ee.set(Z,ee)),ee.add(ne),!0):!1},OrdinaryDefineOwnMetadata:p,OrdinaryHasOwnMetadata:v,OrdinaryGetOwnMetadata:A,OrdinaryOwnMetadataKeys:B,OrdinaryDeleteMetadata:W};return we}function Kn(f,p,v){var A=m.getProvider(f,p);if(!j(A))return A;if(v){if(m.setProvider(f,p,_))return _;throw new Error("Illegal state.")}}function Jc(){var f={},p=[],v=function(){function we(Z,ne,ee){this._index=0,this._keys=Z,this._values=ne,this._selector=ee}return we.prototype["@@iterator"]=function(){return this},we.prototype[o]=function(){return this},we.prototype.next=function(){var Z=this._index;if(Z>=0&&Z<this._keys.length){var ne=this._selector(this._keys[Z],this._values[Z]);return Z+1>=this._keys.length?(this._index=-1,this._keys=p,this._values=p):this._index++,{value:ne,done:!1}}return{value:void 0,done:!0}},we.prototype.throw=function(Z){throw this._index>=0&&(this._index=-1,this._keys=p,this._values=p),Z},we.prototype.return=function(Z){return this._index>=0&&(this._index=-1,this._keys=p,this._values=p),{value:Z,done:!0}},we}(),A=function(){function we(){this._keys=[],this._values=[],this._cacheKey=f,this._cacheIndex=-2}return Object.defineProperty(we.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),we.prototype.has=function(Z){return this._find(Z,!1)>=0},we.prototype.get=function(Z){var ne=this._find(Z,!1);return ne>=0?this._values[ne]:void 0},we.prototype.set=function(Z,ne){var ee=this._find(Z,!0);return this._values[ee]=ne,this},we.prototype.delete=function(Z){var ne=this._find(Z,!1);if(ne>=0){for(var ee=this._keys.length,be=ne+1;be<ee;be++)this._keys[be-1]=this._keys[be],this._values[be-1]=this._values[be];return this._keys.length--,this._values.length--,hr(Z,this._cacheKey)&&(this._cacheKey=f,this._cacheIndex=-2),!0}return!1},we.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=f,this._cacheIndex=-2},we.prototype.keys=function(){return new v(this._keys,this._values,B)},we.prototype.values=function(){return new v(this._keys,this._values,W)},we.prototype.entries=function(){return new v(this._keys,this._values,Ee)},we.prototype["@@iterator"]=function(){return this.entries()},we.prototype[o]=function(){return this.entries()},we.prototype._find=function(Z,ne){if(!hr(this._cacheKey,Z)){this._cacheIndex=-1;for(var ee=0;ee<this._keys.length;ee++)if(hr(this._keys[ee],Z)){this._cacheIndex=ee;break}}return this._cacheIndex<0&&ne&&(this._cacheIndex=this._keys.length,this._keys.push(Z),this._values.push(void 0)),this._cacheIndex},we}();return A;function B(we,Z){return we}function W(we,Z){return Z}function Ee(we,Z){return[we,Z]}}function bn(){var f=function(){function p(){this._map=new d}return Object.defineProperty(p.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),p.prototype.has=function(v){return this._map.has(v)},p.prototype.add=function(v){return this._map.set(v,v),this},p.prototype.delete=function(v){return this._map.delete(v)},p.prototype.clear=function(){this._map.clear()},p.prototype.keys=function(){return this._map.keys()},p.prototype.values=function(){return this._map.keys()},p.prototype.entries=function(){return this._map.entries()},p.prototype["@@iterator"]=function(){return this.keys()},p.prototype[o]=function(){return this.keys()},p}();return f}function lh(){var f=16,p=u.create(),v=A();return function(){function Z(){this._key=A()}return Z.prototype.has=function(ne){var ee=B(ne,!1);return ee!==void 0?u.has(ee,this._key):!1},Z.prototype.get=function(ne){var ee=B(ne,!1);return ee!==void 0?u.get(ee,this._key):void 0},Z.prototype.set=function(ne,ee){var be=B(ne,!0);return be[this._key]=ee,this},Z.prototype.delete=function(ne){var ee=B(ne,!1);return ee!==void 0?delete ee[this._key]:!1},Z.prototype.clear=function(){this._key=A()},Z}();function A(){var Z;do Z="@@WeakMap@@"+we();while(u.has(p,Z));return p[Z]=!0,Z}function B(Z,ne){if(!n.call(Z,v)){if(!ne)return;Object.defineProperty(Z,v,{value:u.create()})}return Z[v]}function W(Z,ne){for(var ee=0;ee<ne;++ee)Z[ee]=Math.random()*255|0;return Z}function Ee(Z){if(typeof Uint8Array=="function"){var ne=new Uint8Array(Z);return typeof crypto<"u"?crypto.getRandomValues(ne):typeof msCrypto<"u"?msCrypto.getRandomValues(ne):W(ne,Z),ne}return W(new Array(Z),Z)}function we(){var Z=Ee(f);Z[6]=Z[6]&79|64,Z[8]=Z[8]&191|128;for(var ne="",ee=0;ee<f;++ee){var be=Z[ee];(ee===4||ee===6||ee===8)&&(ne+="-"),be<16&&(ne+="0"),ne+=be.toString(16).toLowerCase()}return ne}}function E(f){return f.__=void 0,delete f.__,f}})})(ov||(ov={}));var G;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(G||(G={}));var U;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(U||(U={}));class i2{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(le.isBufferSource(e))this.unusedBits=t,this.value=le.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof sc))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new sc({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new sc({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;const s=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let i=0;for(;i<n;)s[i]=parseInt(t.slice(i<<3,(i<<3)+8),2),i++;this.value=s.buffer}}class Xe{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):le.isBufferSource(e)?this.buffer=le.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof As))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new As({valueHex:this.buffer})}toSchema(e){return new As({name:e})}}const vZ={fromASN:r=>r instanceof Gi?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Gi;const e=Ui(r);if(e.result.error)throw new Error(e.result.error);return e.result}},EZ={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new Fi({value:+r})},SZ={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new Kg({value:r})},kt={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Fi({valueHex:r})},_Z={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new sc({valueHex:r})},xZ={fromASN:r=>r.valueBlock.toString(),toASN:r=>new Pi({value:r})},AZ={fromASN:r=>r.valueBlock.value,toASN:r=>new Vg({value:r})},w0={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new As({valueHex:r})},IZ={fromASN:r=>new Xe(r.getValue()),toASN:r=>r.toASN()};function fs(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}const oT=fs(no),kZ=fs(qg),TZ=fs(Hg),CZ=fs(zg),PZ=fs(Wg),DZ=fs(jg),RZ=fs(Gg),OZ=fs(Qg),NZ=fs(Yg),MZ=fs(Tf),BZ=fs(Xg),LZ=fs(Zg),$Z={fromASN:r=>r.toDate(),toASN:r=>new Cf({valueDate:r})},UZ={fromASN:r=>r.toDate(),toASN:r=>new Jg({valueDate:r})},FZ={fromASN:()=>null,toASN:()=>new Gi};function id(r){switch(r){case U.Any:return vZ;case U.BitString:return _Z;case U.BmpString:return kZ;case U.Boolean:return AZ;case U.CharacterString:return LZ;case U.Enumerated:return SZ;case U.GeneralString:return BZ;case U.GeneralizedTime:return UZ;case U.GraphicString:return NZ;case U.IA5String:return OZ;case U.Integer:return EZ;case U.Null:return FZ;case U.NumericString:return CZ;case U.ObjectIdentifier:return xZ;case U.OctetString:return w0;case U.PrintableString:return PZ;case U.TeletexString:return DZ;case U.UTCTime:return $Z;case U.UniversalString:return TZ;case U.Utf8String:return oT;case U.VideotexString:return RZ;case U.VisibleString:return MZ;default:return null}}function Ni(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:Ni(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function aT(r){var e;if(r){const t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:aT(t)}return!1}function VZ(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<r.byteLength;s++)if(t[s]!==n[s])return!1;return!0}class KZ{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:G.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){const n=this.items.get(e)||this.createDefault(e),s=[];for(const i in n.items){const o=n.items[i],a=t?i:"";let c;if(typeof o.type=="number"){const u=U[o.type],h=ok[u];if(!h)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new h({name:a})}else Ni(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===G.Choice?c=new wc({name:a}):(c=this.create(o.type,!1),c.name=a):c=new wc({name:a});const l=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const u=o.repeated==="set"?ni:Yt;c=new u({name:"",value:[new s0({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||Ni(o.type)){const u=o.repeated?Wr:kf;s.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const u=!!o.repeated;let h=u?c:this.get(o.type,!0).schema;h="valueBlock"in h?h.valueBlock.value:h.value,s.push(new Wr({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:h}))}else s.push(new Wr({optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=l,s.push(c)}switch(n.type){case G.Sequence:return new Yt({value:s,name:""});case G.Set:return new ni({value:s,name:""});case G.Choice:return new Hw({value:s,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const rr=new KZ,te=r=>e=>{let t;rr.has(e)?t=rr.get(e):(t=rr.createDefault(e),rr.set(e,t)),Object.assign(t,r)},S=r=>(e,t)=>{let n;rr.has(e.constructor)?n=rr.get(e.constructor):(n=rr.createDefault(e.constructor),rr.set(e.constructor,n));const s=Object.assign({},r);if(typeof s.type=="number"&&!s.converter){const i=id(r.type);if(!i)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);s.converter=i}n.items[t]=s};class xh extends Error{constructor(){super(...arguments),this.schemas=[]}}class qZ{static parse(e,t){const n=Ui(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){try{if(Ni(t))return new t().fromASN(e);const n=rr.get(t);rr.cache(t);let s=n.schema;const i=this.handleChoiceTypes(e,n,t,s);if(i?.result)return i.result;i?.targetSchema&&(s=i.targetSchema);const o=this.handleSequenceTypes(e,n,t,s);if(o&&"isManualMapping"in o)return o.result;const a=o,c=new t;return aT(t)?this.handleArrayTypes(e,n,t):(this.processSchemaItems(n,a,c),c)}catch(n){throw n instanceof xh&&n.schemas.push(t.name),n}}static handleChoiceTypes(e,t,n,s){if(e.constructor===Wr&&t.type===G.Choice&&e.idBlock.tagClass===3)for(const i in t.items){const o=t.items[i];if(o.context===e.idBlock.tagNumber&&o.implicit&&typeof o.type=="function"&&rr.has(o.type)){const a=rr.get(o.type);if(a&&a.type===G.Sequence){const c=new Yt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;const l=this.fromASN(c,o.type),u=new n;return u[i]=l,{result:u}}}}}else if(e.constructor===Wr&&t.type!==G.Choice){const i=new Wr({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(const o in t.items)delete e[o];return{targetSchema:i}}return null}static handleSequenceTypes(e,t,n,s){if(t.type===G.Sequence){if(Object.keys(t.items).filter(a=>{const c=t.items[a];return c.optional&&typeof c.type=="function"&&rr.has(c.type)&&rr.get(c.type).type===G.Choice}).length>0&&"value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&n.name==="CertReqMsg")return this.handleManualMapping(e,t,n);const o=Ro({},e,s);if(!o.verified)throw new xh(`Data does not match to ${n.name} ASN1 schema. ${o.result.error}`);return o}else{const i=Ro({},e,s);if(!i.verified)throw new xh(`Data does not match to ${n.name} ASN1 schema. ${i.result.error}`);return i}}static handleManualMapping(e,t,n){const s=new n,i=e.valueBlock.value,o=Object.keys(t.items);let a=0;for(let c=0;c<o.length;c++){const l=o[c],u=t.items[l];if(a>=i.length)break;if(u.repeated){s[l]=this.processRepeatedField(i,a,u);break}else if(typeof u.type=="number")s[l]=this.processPrimitiveField(i[a],u),a++;else if(this.isOptionalChoiceField(u)){const h=this.processOptionalChoiceField(i[a],u);h.processed&&(s[l]=h.value,a++)}else s[l]=this.fromASN(i[a],u.type),a++}return{result:s,verified:!0,isManualMapping:!0}}static processRepeatedField(e,t,n){let s=e.slice(t);if(s.length===1&&s[0].constructor.name==="Sequence"){const i=s[0];i.valueBlock&&i.valueBlock.value&&Array.isArray(i.valueBlock.value)&&(s=i.valueBlock.value)}if(typeof n.type=="number"){const i=id(n.type);if(!i)throw new Error(`No converter for ASN.1 type ${n.type}`);return s.filter(o=>o&&o.valueBlock).map(o=>{try{return i.fromASN(o)}catch{return}}).filter(o=>o!==void 0)}else return s.filter(i=>i&&i.valueBlock).map(i=>{try{return this.fromASN(i,n.type)}catch{return}}).filter(i=>i!==void 0)}static processPrimitiveField(e,t){const n=id(t.type);if(!n)throw new Error(`No converter for ASN.1 type ${t.type}`);return n.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&rr.has(e.type)&&rr.get(e.type).type===G.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(n){if(n instanceof xh&&/Wrong values for Choice type/.test(n.message))return{processed:!1};throw n}}static handleArrayTypes(e,t,n){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const s=t.itemType;if(typeof s=="number"){const i=id(s);if(!i)throw new Error(`Cannot get default converter for array item of ${n.name} ASN1 schema`);return n.from(e.valueBlock.value,o=>i.fromASN(o))}else return n.from(e.valueBlock.value,i=>this.fromASN(i,s))}static processSchemaItems(e,t,n){for(const s in e.items){const i=t.result[s];if(!i)continue;const o=e.items[s],a=o.type;typeof a=="number"||Ni(a)?n[s]=this.processPrimitiveSchemaItem(i,o,a):n[s]=this.processComplexSchemaItem(i,o,a)}}static processPrimitiveSchemaItem(e,t,n){var s;const i=(s=t.converter)!==null&&s!==void 0?s:Ni(n)?new n:null;if(!i)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,i):this.processSinglePrimitiveItem(e,t,n,i)}static processRepeatedPrimitiveItem(e,t,n){if(t.implicit){const s=t.repeated==="sequence"?Yt:ni,i=new s;i.valueBlock=e.valueBlock;const o=Ui(i.toBER(!1));if(o.offset===-1)throw new Error(`Cannot parse the child item. ${o.result.error}`);if(!("value"in o.result.valueBlock&&Array.isArray(o.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const a=o.result.valueBlock.value;return Array.from(a,c=>n.fromASN(c))}else return Array.from(e,s=>n.fromASN(s))}static processSinglePrimitiveItem(e,t,n,s){let i=e;if(t.implicit){let o;if(Ni(n))o=new n().toSchema("");else{const a=U[n],c=ok[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);o=new c}o.valueBlock=i.valueBlock,i=Ui(o.toBER(!1)).result}return s.fromASN(i)}static processComplexSchemaItem(e,t,n){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,s=>this.fromASN(s,n))}else{const s=this.handleImplicitTagging(e,t,n);if(this.isOptionalChoiceField(t))try{return this.fromASN(s,n)}catch(i){if(i instanceof xh&&/Wrong values for Choice type/.test(i.message))return;throw i}else return this.fromASN(s,n)}}static handleImplicitTagging(e,t,n){if(t.implicit&&typeof t.context=="number"){const s=rr.get(n);if(s.type===G.Sequence){const i=new Yt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}else if(s.type===G.Set){const i=new ni;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}}return e}}class n5{static serialize(e){return e instanceof xr?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&Ni(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,n=rr.get(t);rr.cache(t);let s=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){const o=id(n.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);s=e.map(a=>o.toASN(a))}else s=e.map(o=>this.toAsnItem({type:n.itemType},"[]",t,o))}else for(const o in n.items){const a=n.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&VZ(this.serialize(a.defaultValue),this.serialize(c)))continue;const l=n5.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||Ni(a.type))){const u={};u.valueHex=l instanceof Gi?l.valueBeforeDecodeView:l.valueBlock.toBER(),s.push(new kf({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else s.push(new Wr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else s.push(new Wr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?s=s.concat(l):s.push(l)}let i;switch(n.type){case G.Sequence:i=new Yt({value:s});break;case G.Set:i=new ni({value:s});break;case G.Choice:if(!s[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);i=s[0];break}return i}static toAsnItem(e,t,n,s){let i;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${U[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(s))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(s,l=>o.toASN(l)),c=e.repeated==="sequence"?Yt:ni;i=new c({value:a})}else i=o.toASN(s)}else if(e.repeated){if(!Array.isArray(s))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(s,c=>this.toASN(c)),a=e.repeated==="sequence"?Yt:ni;i=new a({value:o})}else i=this.toASN(s);return i}}class dt extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class ce{static serialize(e){return n5.serialize(e)}static parse(e,t){return qZ.parse(e,t)}static toString(e){const t=le.isBufferSource(e)?le.toArrayBuffer(e):ce.serialize(e),n=Ui(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}}function b(r,e,t,n){var s=arguments.length,i=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(i=(s<3?o(i):s>3?o(e,t,i):o(e,t))||i);return s>3&&i&&Object.defineProperty(e,t,i),i}class av{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{const s=parseInt(n,10);if(isNaN(s)||s<0||s>255)throw new Error("Invalid IPv4 address part");return s})}static parseIPv6(e){const n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((s,i)=>{const o=parseInt(i,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return s.push(o>>8&255),s.push(o&255),s},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const n=t[0]?t[0].split(":"):[],s=t[1]?t[1].split(":"):[],i=8-(n.length+s.length);if(i<0)throw new Error("Invalid IPv6 address");return[...n,...Array(i).fill("0"),...s].join(":")}static formatIPv6(e){const t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let n=-1,s=0,i=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(i===-1&&(i=a),o++):(o>s&&(n=i,s=o),i=-1,o=0);if(o>s&&(n=i,s=o),s>1){const a=t.slice(0,n).join(":"),c=t.slice(n+s).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,n]=e.split("/"),s=parseInt(n,10);if(this.isIPv4(t)){if(s<0||s>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),s]}else{if(s<0||s>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),s]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((s,i)=>s+ +i,0);let n=e.slice(0,8).replace(/(.{2})/g,s=>`${parseInt(s,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const n=t.length/2,s=t.slice(0,n),i=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=i.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(s).join(".")}/${a}`:`${this.formatIPv6(s)}/${a}`}return this.decodeIP(ye.ToHex(e))}static fromString(e){if(e.includes("/")){const[n,s]=this.parseCIDR(e),i=new Uint8Array(n.length);let o=s;for(let c=0;c<i.length;c++)o>=8?(i[c]=255,o-=8):o>0&&(i[c]=255<<8-o,o=0);const a=new Uint8Array(n.length*2);return a.set(n,0),a.set(i,n.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var C3,P3,D3;let Ar=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};b([S({type:U.TeletexString})],Ar.prototype,"teletexString",void 0);b([S({type:U.PrintableString})],Ar.prototype,"printableString",void 0);b([S({type:U.UniversalString})],Ar.prototype,"universalString",void 0);b([S({type:U.Utf8String})],Ar.prototype,"utf8String",void 0);b([S({type:U.BmpString})],Ar.prototype,"bmpString",void 0);Ar=b([te({type:G.Choice})],Ar);let vu=class extends Ar{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?ye.ToHex(this.anyValue):super.toString())}};b([S({type:U.IA5String})],vu.prototype,"ia5String",void 0);b([S({type:U.Any})],vu.prototype,"anyValue",void 0);vu=b([te({type:G.Choice})],vu);class o2{constructor(e={}){this.type="",this.value=new vu,Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],o2.prototype,"type",void 0);b([S({type:vu})],o2.prototype,"value",void 0);let Eu=C3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,C3.prototype)}};Eu=C3=b([te({type:G.Set,itemType:o2})],Eu);let R3=P3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,P3.prototype)}};R3=P3=b([te({type:G.Sequence,itemType:Eu})],R3);let Ht=D3=class extends R3{constructor(e){super(e),Object.setPrototypeOf(this,D3.prototype)}};Ht=D3=b([te({type:G.Sequence})],Ht);const HZ={fromASN:r=>av.toString(w0.fromASN(r)),toASN:r=>w0.toASN(av.fromString(r))};class Wd{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],Wd.prototype,"typeId",void 0);b([S({type:U.Any,context:0})],Wd.prototype,"value",void 0);class s5{constructor(e={}){this.partyName=new Ar,Object.assign(this,e)}}b([S({type:Ar,optional:!0,context:0,implicit:!0})],s5.prototype,"nameAssigner",void 0);b([S({type:Ar,context:1,implicit:!0})],s5.prototype,"partyName",void 0);let Ne=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Wd,context:0,implicit:!0})],Ne.prototype,"otherName",void 0);b([S({type:U.IA5String,context:1,implicit:!0})],Ne.prototype,"rfc822Name",void 0);b([S({type:U.IA5String,context:2,implicit:!0})],Ne.prototype,"dNSName",void 0);b([S({type:U.Any,context:3,implicit:!0})],Ne.prototype,"x400Address",void 0);b([S({type:Ht,context:4,implicit:!1})],Ne.prototype,"directoryName",void 0);b([S({type:s5,context:5})],Ne.prototype,"ediPartyName",void 0);b([S({type:U.IA5String,context:6,implicit:!0})],Ne.prototype,"uniformResourceIdentifier",void 0);b([S({type:U.OctetString,context:7,implicit:!0,converter:HZ})],Ne.prototype,"iPAddress",void 0);b([S({type:U.ObjectIdentifier,context:8,implicit:!0})],Ne.prototype,"registeredID",void 0);Ne=b([te({type:G.Choice})],Ne);const i5="1.3.6.1.5.5.7",zZ=`${i5}.1`,Xu=`${i5}.3`,a2=`${i5}.48`,cv=`${a2}.1`,lv=`${a2}.2`,uv=`${a2}.3`,hv=`${a2}.5`,io="2.5.29";var O3;const N3=`${zZ}.1`;class Of{constructor(e={}){this.accessMethod="",this.accessLocation=new Ne,Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],Of.prototype,"accessMethod",void 0);b([S({type:Ne})],Of.prototype,"accessLocation",void 0);let Dl=O3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,O3.prototype)}};Dl=O3=b([te({type:G.Sequence,itemType:Of})],Dl);const M3=`${io}.35`;class o5 extends Xe{}class za{constructor(e={}){e&&Object.assign(this,e)}}b([S({type:o5,context:0,optional:!0,implicit:!0})],za.prototype,"keyIdentifier",void 0);b([S({type:Ne,context:1,optional:!0,implicit:!0,repeated:"sequence"})],za.prototype,"authorityCertIssuer",void 0);b([S({type:U.Integer,context:2,optional:!0,implicit:!0,converter:kt})],za.prototype,"authorityCertSerialNumber",void 0);const cT=`${io}.19`;class b0{constructor(e={}){this.cA=!1,Object.assign(this,e)}}b([S({type:U.Boolean,defaultValue:!1})],b0.prototype,"cA",void 0);b([S({type:U.Integer,optional:!0})],b0.prototype,"pathLenConstraint",void 0);var B3;let $r=B3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,B3.prototype)}};$r=B3=b([te({type:G.Sequence,itemType:Ne})],$r);var L3;let dv=L3=class extends $r{constructor(e){super(e),Object.setPrototypeOf(this,L3.prototype)}};dv=L3=b([te({type:G.Sequence})],dv);var $3;const lT=`${io}.32`;let Yi=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};b([S({type:U.IA5String})],Yi.prototype,"ia5String",void 0);b([S({type:U.VisibleString})],Yi.prototype,"visibleString",void 0);b([S({type:U.BmpString})],Yi.prototype,"bmpString",void 0);b([S({type:U.Utf8String})],Yi.prototype,"utf8String",void 0);Yi=b([te({type:G.Choice})],Yi);class a5{constructor(e={}){this.organization=new Yi,this.noticeNumbers=[],Object.assign(this,e)}}b([S({type:Yi})],a5.prototype,"organization",void 0);b([S({type:U.Integer,repeated:"sequence"})],a5.prototype,"noticeNumbers",void 0);class c5{constructor(e={}){Object.assign(this,e)}}b([S({type:a5,optional:!0})],c5.prototype,"noticeRef",void 0);b([S({type:Yi,optional:!0})],c5.prototype,"explicitText",void 0);let v0=class{constructor(e={}){Object.assign(this,e)}};b([S({type:U.IA5String})],v0.prototype,"cPSuri",void 0);b([S({type:c5})],v0.prototype,"userNotice",void 0);v0=b([te({type:G.Choice})],v0);class l5{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],l5.prototype,"policyQualifierId",void 0);b([S({type:U.Any})],l5.prototype,"qualifier",void 0);class c2{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],c2.prototype,"policyIdentifier",void 0);b([S({type:l5,repeated:"sequence",optional:!0})],c2.prototype,"policyQualifiers",void 0);let E0=$3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,$3.prototype)}};E0=$3=b([te({type:G.Sequence,itemType:c2})],E0);let S0=class{constructor(e=0){this.value=e}};b([S({type:U.Integer})],S0.prototype,"value",void 0);S0=b([te({type:G.Choice})],S0);let fv=class extends S0{};fv=b([te({type:G.Choice})],fv);var U3;const F3=`${io}.31`;var vs;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(vs||(vs={}));class uT extends i2{toJSON(){const e=[],t=this.toNumber();return t&vs.aACompromise&&e.push("aACompromise"),t&vs.affiliationChanged&&e.push("affiliationChanged"),t&vs.cACompromise&&e.push("cACompromise"),t&vs.certificateHold&&e.push("certificateHold"),t&vs.cessationOfOperation&&e.push("cessationOfOperation"),t&vs.keyCompromise&&e.push("keyCompromise"),t&vs.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&vs.superseded&&e.push("superseded"),t&vs.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let Ec=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Ne,context:0,repeated:"sequence",implicit:!0})],Ec.prototype,"fullName",void 0);b([S({type:Eu,context:1,implicit:!0})],Ec.prototype,"nameRelativeToCRLIssuer",void 0);Ec=b([te({type:G.Choice})],Ec);class Zu{constructor(e={}){Object.assign(this,e)}}b([S({type:Ec,context:0,optional:!0})],Zu.prototype,"distributionPoint",void 0);b([S({type:uT,context:1,optional:!0,implicit:!0})],Zu.prototype,"reasons",void 0);b([S({type:Ne,context:2,optional:!0,repeated:"sequence",implicit:!0})],Zu.prototype,"cRLIssuer",void 0);let Wl=U3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,U3.prototype)}};Wl=U3=b([te({type:G.Sequence,itemType:Zu})],Wl);var V3;let pv=V3=class extends Wl{constructor(e){super(e),Object.setPrototypeOf(this,V3.prototype)}};pv=V3=b([te({type:G.Sequence,itemType:Zu})],pv);class Lr{constructor(e={}){this.onlyContainsUserCerts=Lr.ONLY,this.onlyContainsCACerts=Lr.ONLY,this.indirectCRL=Lr.ONLY,this.onlyContainsAttributeCerts=Lr.ONLY,Object.assign(this,e)}}Lr.ONLY=!1;b([S({type:Ec,context:0,optional:!0})],Lr.prototype,"distributionPoint",void 0);b([S({type:U.Boolean,context:1,defaultValue:Lr.ONLY,implicit:!0})],Lr.prototype,"onlyContainsUserCerts",void 0);b([S({type:U.Boolean,context:2,defaultValue:Lr.ONLY,implicit:!0})],Lr.prototype,"onlyContainsCACerts",void 0);b([S({type:uT,context:3,optional:!0,implicit:!0})],Lr.prototype,"onlySomeReasons",void 0);b([S({type:U.Boolean,context:4,defaultValue:Lr.ONLY,implicit:!0})],Lr.prototype,"indirectCRL",void 0);b([S({type:U.Boolean,context:5,defaultValue:Lr.ONLY,implicit:!0})],Lr.prototype,"onlyContainsAttributeCerts",void 0);var od;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(od||(od={}));let K3=class{constructor(e=od.unspecified){this.reason=od.unspecified,this.reason=e}toJSON(){return od[this.reason]}toString(){return this.toJSON()}};b([S({type:U.Enumerated})],K3.prototype,"reason",void 0);K3=b([te({type:G.Choice})],K3);var q3;const hT=`${io}.37`;let _0=q3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,q3.prototype)}};_0=q3=b([te({type:G.Sequence,itemType:U.ObjectIdentifier})],_0);const WZ=`${Xu}.1`,jZ=`${Xu}.2`,GZ=`${Xu}.3`,QZ=`${Xu}.4`,YZ=`${Xu}.8`,XZ=`${Xu}.9`;let H3=class{constructor(e=new ArrayBuffer(0)){this.value=e}};b([S({type:U.Integer,converter:kt})],H3.prototype,"value",void 0);H3=b([te({type:G.Choice})],H3);let z3=class{constructor(e){this.value=new Date,e&&(this.value=e)}};b([S({type:U.GeneralizedTime})],z3.prototype,"value",void 0);z3=b([te({type:G.Choice})],z3);var W3;const dT=`${io}.18`;let gv=W3=class extends $r{constructor(e){super(e),Object.setPrototypeOf(this,W3.prototype)}};gv=W3=b([te({type:G.Sequence})],gv);const fT=`${io}.15`;var Es;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(Es||(Es={}));class Vy extends i2{toJSON(){const e=this.toNumber(),t=[];return e&Es.cRLSign&&t.push("crlSign"),e&Es.dataEncipherment&&t.push("dataEncipherment"),e&Es.decipherOnly&&t.push("decipherOnly"),e&Es.digitalSignature&&t.push("digitalSignature"),e&Es.encipherOnly&&t.push("encipherOnly"),e&Es.keyAgreement&&t.push("keyAgreement"),e&Es.keyCertSign&&t.push("keyCertSign"),e&Es.keyEncipherment&&t.push("keyEncipherment"),e&Es.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var j3;class l2{constructor(e={}){this.base=new Ne,this.minimum=0,Object.assign(this,e)}}b([S({type:Ne})],l2.prototype,"base",void 0);b([S({type:U.Integer,context:0,defaultValue:0,implicit:!0})],l2.prototype,"minimum",void 0);b([S({type:U.Integer,context:1,optional:!0,implicit:!0})],l2.prototype,"maximum",void 0);let x0=j3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,j3.prototype)}};x0=j3=b([te({type:G.Sequence,itemType:l2})],x0);class pT{constructor(e={}){Object.assign(this,e)}}b([S({type:x0,context:0,optional:!0,implicit:!0})],pT.prototype,"permittedSubtrees",void 0);b([S({type:x0,context:1,optional:!0,implicit:!0})],pT.prototype,"excludedSubtrees",void 0);class gT{constructor(e={}){Object.assign(this,e)}}b([S({type:U.Integer,context:0,implicit:!0,optional:!0,converter:kt})],gT.prototype,"requireExplicitPolicy",void 0);b([S({type:U.Integer,context:1,implicit:!0,optional:!0,converter:kt})],gT.prototype,"inhibitPolicyMapping",void 0);var G3;class u5{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],u5.prototype,"issuerDomainPolicy",void 0);b([S({type:U.ObjectIdentifier})],u5.prototype,"subjectDomainPolicy",void 0);let yv=G3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,G3.prototype)}};yv=G3=b([te({type:G.Sequence,itemType:u5})],yv);var Q3;const yT=`${io}.17`;let Y3=Q3=class extends $r{constructor(e){super(e),Object.setPrototypeOf(this,Q3.prototype)}};Y3=Q3=b([te({type:G.Sequence})],Y3);let Xi=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};b([S({type:U.ObjectIdentifier})],Xi.prototype,"type",void 0);b([S({type:U.Any,repeated:"set"})],Xi.prototype,"values",void 0);var X3;let mv=X3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,X3.prototype)}};mv=X3=b([te({type:G.Sequence,itemType:Xi})],mv);const mT=`${io}.14`;class Vo extends o5{}class wT{constructor(e={}){Object.assign(this,e)}}b([S({type:U.GeneralizedTime,context:0,implicit:!0,optional:!0})],wT.prototype,"notBefore",void 0);b([S({type:U.GeneralizedTime,context:1,implicit:!0,optional:!0})],wT.prototype,"notAfter",void 0);var ad;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(ad||(ad={}));class bT extends i2{toJSON(){const e=[],t=this.toNumber();return t&ad.pKIXCertificate&&e.push("pKIXCertificate"),t&ad.newExtensions&&e.push("newExtensions"),t&ad.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class vT{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new bT,Object.assign(this,e)}}b([S({type:U.GeneralString})],vT.prototype,"entrustVers",void 0);b([S({type:bT})],vT.prototype,"entrustInfoFlags",void 0);var Z3;let wv=Z3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,Z3.prototype)}};wv=Z3=b([te({type:G.Sequence,itemType:Of})],wv);class fe{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof fe&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&uI(e.parameters,this.parameters)||e.parameters===this.parameters)}}b([S({type:U.ObjectIdentifier})],fe.prototype,"algorithm",void 0);b([S({type:U.Any,optional:!0})],fe.prototype,"parameters",void 0);class ks{constructor(e={}){this.algorithm=new fe,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:fe})],ks.prototype,"algorithm",void 0);b([S({type:U.BitString})],ks.prototype,"subjectPublicKey",void 0);let Er=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};b([S({type:U.UTCTime})],Er.prototype,"utcTime",void 0);b([S({type:U.GeneralizedTime})],Er.prototype,"generalTime",void 0);Er=b([te({type:G.Choice})],Er);class Nf{constructor(e){this.notBefore=new Er(new Date),this.notAfter=new Er(new Date),e&&(this.notBefore=new Er(e.notBefore),this.notAfter=new Er(e.notAfter))}}b([S({type:Er})],Nf.prototype,"notBefore",void 0);b([S({type:Er})],Nf.prototype,"notAfter",void 0);var J3;let hs=class ET{constructor(e={}){this.extnID="",this.critical=ET.CRITICAL,this.extnValue=new Xe,Object.assign(this,e)}};hs.CRITICAL=!1;b([S({type:U.ObjectIdentifier})],hs.prototype,"extnID",void 0);b([S({type:U.Boolean,defaultValue:hs.CRITICAL})],hs.prototype,"critical",void 0);b([S({type:Xe})],hs.prototype,"extnValue",void 0);let sa=J3=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,J3.prototype)}};sa=J3=b([te({type:G.Sequence,itemType:hs})],sa);var Sc;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(Sc||(Sc={}));class $n{constructor(e={}){this.version=Sc.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new fe,this.issuer=new Ht,this.validity=new Nf,this.subject=new Ht,this.subjectPublicKeyInfo=new ks,Object.assign(this,e)}}b([S({type:U.Integer,context:0,defaultValue:Sc.v1})],$n.prototype,"version",void 0);b([S({type:U.Integer,converter:kt})],$n.prototype,"serialNumber",void 0);b([S({type:fe})],$n.prototype,"signature",void 0);b([S({type:Ht})],$n.prototype,"issuer",void 0);b([S({type:Nf})],$n.prototype,"validity",void 0);b([S({type:Ht})],$n.prototype,"subject",void 0);b([S({type:ks})],$n.prototype,"subjectPublicKeyInfo",void 0);b([S({type:U.BitString,context:1,implicit:!0,optional:!0})],$n.prototype,"issuerUniqueID",void 0);b([S({type:U.BitString,context:2,implicit:!0,optional:!0})],$n.prototype,"subjectUniqueID",void 0);b([S({type:sa,context:3,optional:!0})],$n.prototype,"extensions",void 0);class _c{constructor(e={}){this.tbsCertificate=new $n,this.signatureAlgorithm=new fe,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:$n})],_c.prototype,"tbsCertificate",void 0);b([S({type:fe})],_c.prototype,"signatureAlgorithm",void 0);b([S({type:U.BitString})],_c.prototype,"signatureValue",void 0);class u2{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Er,Object.assign(this,e)}}b([S({type:U.Integer,converter:kt})],u2.prototype,"userCertificate",void 0);b([S({type:Er})],u2.prototype,"revocationDate",void 0);b([S({type:hs,optional:!0,repeated:"sequence"})],u2.prototype,"crlEntryExtensions",void 0);class oo{constructor(e={}){this.signature=new fe,this.issuer=new Ht,this.thisUpdate=new Er,Object.assign(this,e)}}b([S({type:U.Integer,optional:!0})],oo.prototype,"version",void 0);b([S({type:fe})],oo.prototype,"signature",void 0);b([S({type:Ht})],oo.prototype,"issuer",void 0);b([S({type:Er})],oo.prototype,"thisUpdate",void 0);b([S({type:Er,optional:!0})],oo.prototype,"nextUpdate",void 0);b([S({type:u2,repeated:"sequence",optional:!0})],oo.prototype,"revokedCertificates",void 0);b([S({type:hs,optional:!0,context:0,repeated:"sequence"})],oo.prototype,"crlExtensions",void 0);class h5{constructor(e={}){this.tbsCertList=new oo,this.signatureAlgorithm=new fe,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:oo})],h5.prototype,"tbsCertList",void 0);b([S({type:fe})],h5.prototype,"signatureAlgorithm",void 0);b([S({type:U.BitString})],h5.prototype,"signature",void 0);class Ju{constructor(e={}){this.issuer=new Ht,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:Ht})],Ju.prototype,"issuer",void 0);b([S({type:U.Integer,converter:kt})],Ju.prototype,"serialNumber",void 0);let Su=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Vo,context:0,implicit:!0})],Su.prototype,"subjectKeyIdentifier",void 0);b([S({type:Ju})],Su.prototype,"issuerAndSerialNumber",void 0);Su=b([te({type:G.Choice})],Su);var Zi;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(Zi||(Zi={}));let jd=class extends fe{};jd=b([te({type:G.Sequence})],jd);let A0=class extends fe{};A0=b([te({type:G.Sequence})],A0);let ci=class extends fe{};ci=b([te({type:G.Sequence})],ci);let I0=class extends fe{};I0=b([te({type:G.Sequence})],I0);let bv=class extends fe{};bv=b([te({type:G.Sequence})],bv);let e4=class extends fe{};e4=b([te({type:G.Sequence})],e4);let eh=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};b([S({type:U.ObjectIdentifier})],eh.prototype,"attrType",void 0);b([S({type:U.Any,repeated:"set"})],eh.prototype,"attrValues",void 0);var t4;class di{constructor(e={}){this.version=Zi.v0,this.sid=new Su,this.digestAlgorithm=new jd,this.signatureAlgorithm=new A0,this.signature=new Xe,Object.assign(this,e)}}b([S({type:U.Integer})],di.prototype,"version",void 0);b([S({type:Su})],di.prototype,"sid",void 0);b([S({type:jd})],di.prototype,"digestAlgorithm",void 0);b([S({type:eh,repeated:"set",context:0,implicit:!0,optional:!0})],di.prototype,"signedAttrs",void 0);b([S({type:A0})],di.prototype,"signatureAlgorithm",void 0);b([S({type:Xe})],di.prototype,"signature",void 0);b([S({type:eh,repeated:"set",context:1,implicit:!0,optional:!0})],di.prototype,"unsignedAttrs",void 0);let k0=t4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,t4.prototype)}};k0=t4=b([te({type:G.Set,itemType:di})],k0);let vv=class extends Er{};vv=b([te({type:G.Choice})],vv);let Ev=class extends di{};Ev=b([te({type:G.Sequence})],Ev);class d5{constructor(e={}){this.acIssuer=new Ne,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}b([S({type:Ne})],d5.prototype,"acIssuer",void 0);b([S({type:U.Integer})],d5.prototype,"acSerial",void 0);b([S({type:Xi,repeated:"sequence"})],d5.prototype,"attrs",void 0);var r4;let T0=r4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,r4.prototype)}};T0=r4=b([te({type:G.Sequence,itemType:U.ObjectIdentifier})],T0);class h2{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}b([S({type:U.Integer,optional:!0})],h2.prototype,"pathLenConstraint",void 0);b([S({type:T0,implicit:!0,context:0,optional:!0})],h2.prototype,"permittedAttrs",void 0);b([S({type:T0,implicit:!0,context:1,optional:!0})],h2.prototype,"excludedAttrs",void 0);b([S({type:U.Boolean,defaultValue:!0})],h2.prototype,"permitUnSpecified",void 0);class Wc{constructor(e={}){this.issuer=new $r,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:$r})],Wc.prototype,"issuer",void 0);b([S({type:U.Integer,converter:kt})],Wc.prototype,"serial",void 0);b([S({type:U.BitString,optional:!0})],Wc.prototype,"issuerUID",void 0);var n4;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(n4||(n4={}));class jc{constructor(e={}){this.digestedObjectType=n4.publicKey,this.digestAlgorithm=new fe,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.Enumerated})],jc.prototype,"digestedObjectType",void 0);b([S({type:U.ObjectIdentifier,optional:!0})],jc.prototype,"otherObjectTypeID",void 0);b([S({type:fe})],jc.prototype,"digestAlgorithm",void 0);b([S({type:U.BitString})],jc.prototype,"objectDigest",void 0);class d2{constructor(e={}){Object.assign(this,e)}}b([S({type:$r,optional:!0})],d2.prototype,"issuerName",void 0);b([S({type:Wc,context:0,implicit:!0,optional:!0})],d2.prototype,"baseCertificateID",void 0);b([S({type:jc,context:1,implicit:!0,optional:!0})],d2.prototype,"objectDigestInfo",void 0);let _u=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Ne,repeated:"sequence"})],_u.prototype,"v1Form",void 0);b([S({type:d2,context:0,implicit:!0})],_u.prototype,"v2Form",void 0);_u=b([te({type:G.Choice})],_u);class f2{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}b([S({type:U.GeneralizedTime})],f2.prototype,"notBeforeTime",void 0);b([S({type:U.GeneralizedTime})],f2.prototype,"notAfterTime",void 0);class Mf{constructor(e={}){Object.assign(this,e)}}b([S({type:Wc,implicit:!0,context:0,optional:!0})],Mf.prototype,"baseCertificateID",void 0);b([S({type:$r,implicit:!0,context:1,optional:!0})],Mf.prototype,"entityName",void 0);b([S({type:jc,implicit:!0,context:2,optional:!0})],Mf.prototype,"objectDigestInfo",void 0);var s4;(function(r){r[r.v2=1]="v2"})(s4||(s4={}));class Ms{constructor(e={}){this.version=s4.v2,this.holder=new Mf,this.issuer=new _u,this.signature=new fe,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new f2,this.attributes=[],Object.assign(this,e)}}b([S({type:U.Integer})],Ms.prototype,"version",void 0);b([S({type:Mf})],Ms.prototype,"holder",void 0);b([S({type:_u})],Ms.prototype,"issuer",void 0);b([S({type:fe})],Ms.prototype,"signature",void 0);b([S({type:U.Integer,converter:kt})],Ms.prototype,"serialNumber",void 0);b([S({type:f2})],Ms.prototype,"attrCertValidityPeriod",void 0);b([S({type:Xi,repeated:"sequence"})],Ms.prototype,"attributes",void 0);b([S({type:U.BitString,optional:!0})],Ms.prototype,"issuerUniqueID",void 0);b([S({type:sa,optional:!0})],Ms.prototype,"extensions",void 0);class p2{constructor(e={}){this.acinfo=new Ms,this.signatureAlgorithm=new fe,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:Ms})],p2.prototype,"acinfo",void 0);b([S({type:fe})],p2.prototype,"signatureAlgorithm",void 0);b([S({type:U.BitString})],p2.prototype,"signatureValue",void 0);var C0;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(C0||(C0={}));class i4 extends i2{}class f5{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier,implicit:!0,context:0})],f5.prototype,"type",void 0);b([S({type:U.Any,implicit:!0,context:1})],f5.prototype,"value",void 0);class p5{constructor(e={}){this.policyId="",this.classList=new i4(C0.unclassified),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],p5.prototype,"policyId",void 0);b([S({type:i4,defaultValue:new i4(C0.unclassified)})],p5.prototype,"classList",void 0);b([S({type:f5,repeated:"set"})],p5.prototype,"securityCategories",void 0);class g2{constructor(e={}){Object.assign(this,e)}}b([S({type:Xe})],g2.prototype,"cotets",void 0);b([S({type:U.ObjectIdentifier})],g2.prototype,"oid",void 0);b([S({type:U.Utf8String})],g2.prototype,"string",void 0);class ST{constructor(e={}){this.values=[],Object.assign(this,e)}}b([S({type:$r,implicit:!0,context:0,optional:!0})],ST.prototype,"policyAuthority",void 0);b([S({type:g2,repeated:"sequence"})],ST.prototype,"values",void 0);var o4;class y2{constructor(e={}){this.targetCertificate=new Wc,Object.assign(this,e)}}b([S({type:Wc})],y2.prototype,"targetCertificate",void 0);b([S({type:Ne,optional:!0})],y2.prototype,"targetName",void 0);b([S({type:jc,optional:!0})],y2.prototype,"certDigestInfo",void 0);let xu=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Ne,context:0,implicit:!0})],xu.prototype,"targetName",void 0);b([S({type:Ne,context:1,implicit:!0})],xu.prototype,"targetGroup",void 0);b([S({type:y2,context:2,implicit:!0})],xu.prototype,"targetCert",void 0);xu=b([te({type:G.Choice})],xu);let a4=o4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,o4.prototype)}};a4=o4=b([te({type:G.Sequence,itemType:xu})],a4);var c4;let Sv=c4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,c4.prototype)}};Sv=c4=b([te({type:G.Sequence,itemType:a4})],Sv);class _T{constructor(e={}){Object.assign(this,e)}}b([S({type:$r,implicit:!0,context:0,optional:!0})],_T.prototype,"roleAuthority",void 0);b([S({type:Ne,implicit:!0,context:1})],_T.prototype,"roleName",void 0);class g5{constructor(e={}){this.service=new Ne,this.ident=new Ne,Object.assign(this,e)}}b([S({type:Ne})],g5.prototype,"service",void 0);b([S({type:Ne})],g5.prototype,"ident",void 0);b([S({type:Xe,optional:!0})],g5.prototype,"authInfo",void 0);var l4;class y5{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],y5.prototype,"otherCertFormat",void 0);b([S({type:U.Any})],y5.prototype,"otherCert",void 0);let Au=class{constructor(e={}){Object.assign(this,e)}};b([S({type:_c})],Au.prototype,"certificate",void 0);b([S({type:p2,context:2,implicit:!0})],Au.prototype,"v2AttrCert",void 0);b([S({type:y5,context:3,implicit:!0})],Au.prototype,"other",void 0);Au=b([te({type:G.Choice})],Au);let P0=l4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,l4.prototype)}};P0=l4=b([te({type:G.Set,itemType:Au})],P0);class th{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],th.prototype,"contentType",void 0);b([S({type:U.Any,context:0})],th.prototype,"content",void 0);let Gd=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Xe})],Gd.prototype,"single",void 0);b([S({type:U.Any})],Gd.prototype,"any",void 0);Gd=b([te({type:G.Choice})],Gd);class m2{constructor(e={}){this.eContentType="",Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],m2.prototype,"eContentType",void 0);b([S({type:Gd,context:0,optional:!0})],m2.prototype,"eContent",void 0);let Qd=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Xe,context:0,implicit:!0,optional:!0})],Qd.prototype,"value",void 0);b([S({type:Xe,converter:IZ,context:0,implicit:!0,optional:!0,repeated:"sequence"})],Qd.prototype,"constructedValue",void 0);Qd=b([te({type:G.Choice})],Qd);class Bf{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new I0,Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],Bf.prototype,"contentType",void 0);b([S({type:I0})],Bf.prototype,"contentEncryptionAlgorithm",void 0);b([S({type:Qd,optional:!0})],Bf.prototype,"encryptedContent",void 0);class w2{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],w2.prototype,"keyAttrId",void 0);b([S({type:U.Any,optional:!0})],w2.prototype,"keyAttr",void 0);var u4;class b2{constructor(e={}){this.subjectKeyIdentifier=new Vo,Object.assign(this,e)}}b([S({type:Vo})],b2.prototype,"subjectKeyIdentifier",void 0);b([S({type:U.GeneralizedTime,optional:!0})],b2.prototype,"date",void 0);b([S({type:w2,optional:!0})],b2.prototype,"other",void 0);let Iu=class{constructor(e={}){Object.assign(this,e)}};b([S({type:b2,context:0,implicit:!0,optional:!0})],Iu.prototype,"rKeyId",void 0);b([S({type:Ju,optional:!0})],Iu.prototype,"issuerAndSerialNumber",void 0);Iu=b([te({type:G.Choice})],Iu);class m5{constructor(e={}){this.rid=new Iu,this.encryptedKey=new Xe,Object.assign(this,e)}}b([S({type:Iu})],m5.prototype,"rid",void 0);b([S({type:Xe})],m5.prototype,"encryptedKey",void 0);let D0=u4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,u4.prototype)}};D0=u4=b([te({type:G.Sequence,itemType:m5})],D0);class w5{constructor(e={}){this.algorithm=new fe,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:fe})],w5.prototype,"algorithm",void 0);b([S({type:U.BitString})],w5.prototype,"publicKey",void 0);let xc=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Vo,context:0,implicit:!0,optional:!0})],xc.prototype,"subjectKeyIdentifier",void 0);b([S({type:w5,context:1,implicit:!0,optional:!0})],xc.prototype,"originatorKey",void 0);b([S({type:Ju,optional:!0})],xc.prototype,"issuerAndSerialNumber",void 0);xc=b([te({type:G.Choice})],xc);class rh{constructor(e={}){this.version=Zi.v3,this.originator=new xc,this.keyEncryptionAlgorithm=new ci,this.recipientEncryptedKeys=new D0,Object.assign(this,e)}}b([S({type:U.Integer})],rh.prototype,"version",void 0);b([S({type:xc,context:0})],rh.prototype,"originator",void 0);b([S({type:Xe,context:1,optional:!0})],rh.prototype,"ukm",void 0);b([S({type:ci})],rh.prototype,"keyEncryptionAlgorithm",void 0);b([S({type:D0})],rh.prototype,"recipientEncryptedKeys",void 0);let ku=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Vo,context:0,implicit:!0})],ku.prototype,"subjectKeyIdentifier",void 0);b([S({type:Ju})],ku.prototype,"issuerAndSerialNumber",void 0);ku=b([te({type:G.Choice})],ku);class Lf{constructor(e={}){this.version=Zi.v0,this.rid=new ku,this.keyEncryptionAlgorithm=new ci,this.encryptedKey=new Xe,Object.assign(this,e)}}b([S({type:U.Integer})],Lf.prototype,"version",void 0);b([S({type:ku})],Lf.prototype,"rid",void 0);b([S({type:ci})],Lf.prototype,"keyEncryptionAlgorithm",void 0);b([S({type:Xe})],Lf.prototype,"encryptedKey",void 0);class $f{constructor(e={}){this.keyIdentifier=new Xe,Object.assign(this,e)}}b([S({type:Xe})],$f.prototype,"keyIdentifier",void 0);b([S({type:U.GeneralizedTime,optional:!0})],$f.prototype,"date",void 0);b([S({type:w2,optional:!0})],$f.prototype,"other",void 0);class Uf{constructor(e={}){this.version=Zi.v4,this.kekid=new $f,this.keyEncryptionAlgorithm=new ci,this.encryptedKey=new Xe,Object.assign(this,e)}}b([S({type:U.Integer})],Uf.prototype,"version",void 0);b([S({type:$f})],Uf.prototype,"kekid",void 0);b([S({type:ci})],Uf.prototype,"keyEncryptionAlgorithm",void 0);b([S({type:Xe})],Uf.prototype,"encryptedKey",void 0);class Ff{constructor(e={}){this.version=Zi.v0,this.keyEncryptionAlgorithm=new ci,this.encryptedKey=new Xe,Object.assign(this,e)}}b([S({type:U.Integer})],Ff.prototype,"version",void 0);b([S({type:e4,context:0,optional:!0})],Ff.prototype,"keyDerivationAlgorithm",void 0);b([S({type:ci})],Ff.prototype,"keyEncryptionAlgorithm",void 0);b([S({type:Xe})],Ff.prototype,"encryptedKey",void 0);class b5{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],b5.prototype,"oriType",void 0);b([S({type:U.Any})],b5.prototype,"oriValue",void 0);let ia=class{constructor(e={}){Object.assign(this,e)}};b([S({type:Lf,optional:!0})],ia.prototype,"ktri",void 0);b([S({type:rh,context:1,implicit:!0,optional:!0})],ia.prototype,"kari",void 0);b([S({type:Uf,context:2,implicit:!0,optional:!0})],ia.prototype,"kekri",void 0);b([S({type:Ff,context:3,implicit:!0,optional:!0})],ia.prototype,"pwri",void 0);b([S({type:b5,context:4,implicit:!0,optional:!0})],ia.prototype,"ori",void 0);ia=b([te({type:G.Choice})],ia);var h4;let R0=h4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,h4.prototype)}};R0=h4=b([te({type:G.Set,itemType:ia})],R0);var d4;class v2{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],v2.prototype,"otherRevInfoFormat",void 0);b([S({type:U.Any})],v2.prototype,"otherRevInfo",void 0);let O0=class{constructor(e={}){this.other=new v2,Object.assign(this,e)}};b([S({type:v2,context:1,implicit:!0})],O0.prototype,"other",void 0);O0=b([te({type:G.Choice})],O0);let N0=d4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,d4.prototype)}};N0=d4=b([te({type:G.Set,itemType:O0})],N0);class v5{constructor(e={}){Object.assign(this,e)}}b([S({type:P0,context:0,implicit:!0,optional:!0})],v5.prototype,"certs",void 0);b([S({type:N0,context:1,implicit:!0,optional:!0})],v5.prototype,"crls",void 0);var f4;let p4=f4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,f4.prototype)}};p4=f4=b([te({type:G.Set,itemType:eh})],p4);class Vf{constructor(e={}){this.version=Zi.v0,this.recipientInfos=new R0,this.encryptedContentInfo=new Bf,Object.assign(this,e)}}b([S({type:U.Integer})],Vf.prototype,"version",void 0);b([S({type:v5,context:0,implicit:!0,optional:!0})],Vf.prototype,"originatorInfo",void 0);b([S({type:R0})],Vf.prototype,"recipientInfos",void 0);b([S({type:Bf})],Vf.prototype,"encryptedContentInfo",void 0);b([S({type:p4,context:1,implicit:!0,optional:!0})],Vf.prototype,"unprotectedAttrs",void 0);const ZZ="1.2.840.113549.1.7.2";var g4;let M0=g4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,g4.prototype)}};M0=g4=b([te({type:G.Set,itemType:jd})],M0);class nh{constructor(e={}){this.version=Zi.v0,this.digestAlgorithms=new M0,this.encapContentInfo=new m2,this.signerInfos=new k0,Object.assign(this,e)}}b([S({type:U.Integer})],nh.prototype,"version",void 0);b([S({type:M0})],nh.prototype,"digestAlgorithms",void 0);b([S({type:m2})],nh.prototype,"encapContentInfo",void 0);b([S({type:P0,context:0,implicit:!0,optional:!0})],nh.prototype,"certificates",void 0);b([S({type:N0,context:1,implicit:!0,optional:!0})],nh.prototype,"crls",void 0);b([S({type:k0})],nh.prototype,"signerInfos",void 0);const Yd="1.2.840.10045.2.1",E5="1.2.840.10045.4.1",xT="1.2.840.10045.4.3.1",S5="1.2.840.10045.4.3.2",_5="1.2.840.10045.4.3.3",x5="1.2.840.10045.4.3.4",_v="1.2.840.10045.3.1.7",xv="1.3.132.0.34",Av="1.3.132.0.35";function Kf(r){return new fe({algorithm:r})}const JZ=Kf(E5);Kf(xT);const eJ=Kf(S5),tJ=Kf(_5),rJ=Kf(x5);let Xd=class{constructor(e={}){Object.assign(this,e)}};b([S({type:U.ObjectIdentifier})],Xd.prototype,"fieldType",void 0);b([S({type:U.Any})],Xd.prototype,"parameters",void 0);Xd=b([te({type:G.Sequence})],Xd);class nJ extends Xe{}let Tu=class{constructor(e={}){Object.assign(this,e)}};b([S({type:U.OctetString})],Tu.prototype,"a",void 0);b([S({type:U.OctetString})],Tu.prototype,"b",void 0);b([S({type:U.BitString,optional:!0})],Tu.prototype,"seed",void 0);Tu=b([te({type:G.Sequence})],Tu);var y4;(function(r){r[r.ecpVer1=1]="ecpVer1"})(y4||(y4={}));let Ji=class{constructor(e={}){this.version=y4.ecpVer1,Object.assign(this,e)}};b([S({type:U.Integer})],Ji.prototype,"version",void 0);b([S({type:Xd})],Ji.prototype,"fieldID",void 0);b([S({type:Tu})],Ji.prototype,"curve",void 0);b([S({type:nJ})],Ji.prototype,"base",void 0);b([S({type:U.Integer,converter:kt})],Ji.prototype,"order",void 0);b([S({type:U.Integer,optional:!0})],Ji.prototype,"cofactor",void 0);Ji=b([te({type:G.Sequence})],Ji);let oa=class{constructor(e={}){Object.assign(this,e)}};b([S({type:U.ObjectIdentifier})],oa.prototype,"namedCurve",void 0);b([S({type:U.Null})],oa.prototype,"implicitCurve",void 0);b([S({type:Ji})],oa.prototype,"specifiedCurve",void 0);oa=b([te({type:G.Choice})],oa);class E2{constructor(e={}){this.version=1,this.privateKey=new Xe,Object.assign(this,e)}}b([S({type:U.Integer})],E2.prototype,"version",void 0);b([S({type:Xe})],E2.prototype,"privateKey",void 0);b([S({type:oa,context:0,optional:!0})],E2.prototype,"parameters",void 0);b([S({type:U.BitString,context:1,optional:!0})],E2.prototype,"publicKey",void 0);class B0{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.Integer,converter:kt})],B0.prototype,"r",void 0);b([S({type:U.Integer,converter:kt})],B0.prototype,"s",void 0);const mn="1.2.840.113549.1.1",Ac=`${mn}.1`,sJ=`${mn}.7`,iJ=`${mn}.9`,cd=`${mn}.10`,oJ=`${mn}.2`,aJ=`${mn}.4`,L0=`${mn}.5`,cJ=`${mn}.14`,m4=`${mn}.11`,$0=`${mn}.12`,U0=`${mn}.13`,AT=`${mn}.15`,IT=`${mn}.16`,F0="1.3.14.3.2.26",kT="2.16.840.1.101.3.4.2.4",V0="2.16.840.1.101.3.4.2.1",K0="2.16.840.1.101.3.4.2.2",q0="2.16.840.1.101.3.4.2.3",lJ="2.16.840.1.101.3.4.2.5",uJ="2.16.840.1.101.3.4.2.6",hJ="1.2.840.113549.2.2",dJ="1.2.840.113549.2.5",S2=`${mn}.8`;function ir(r){return new fe({algorithm:r,parameters:null})}ir(hJ);ir(dJ);const Ic=ir(F0);ir(kT);ir(V0);ir(K0);ir(q0);ir(lJ);ir(uJ);const TT=new fe({algorithm:S2,parameters:ce.serialize(Ic)}),CT=new fe({algorithm:iJ,parameters:ce.serialize(w0.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});ir(Ac);ir(oJ);ir(aJ);ir(L0);ir(AT);ir(IT);ir($0);ir(U0);ir(AT);ir(IT);class _2{constructor(e={}){this.hashAlgorithm=new fe(Ic),this.maskGenAlgorithm=new fe({algorithm:S2,parameters:ce.serialize(Ic)}),this.pSourceAlgorithm=new fe(CT),Object.assign(this,e)}}b([S({type:fe,context:0,defaultValue:Ic})],_2.prototype,"hashAlgorithm",void 0);b([S({type:fe,context:1,defaultValue:TT})],_2.prototype,"maskGenAlgorithm",void 0);b([S({type:fe,context:2,defaultValue:CT})],_2.prototype,"pSourceAlgorithm",void 0);new fe({algorithm:sJ,parameters:ce.serialize(new _2)});class kc{constructor(e={}){this.hashAlgorithm=new fe(Ic),this.maskGenAlgorithm=new fe({algorithm:S2,parameters:ce.serialize(Ic)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}b([S({type:fe,context:0,defaultValue:Ic})],kc.prototype,"hashAlgorithm",void 0);b([S({type:fe,context:1,defaultValue:TT})],kc.prototype,"maskGenAlgorithm",void 0);b([S({type:U.Integer,context:2,defaultValue:20})],kc.prototype,"saltLength",void 0);b([S({type:U.Integer,context:3,defaultValue:1})],kc.prototype,"trailerField",void 0);new fe({algorithm:cd,parameters:ce.serialize(new kc)});class x2{constructor(e={}){this.digestAlgorithm=new fe,this.digest=new Xe,Object.assign(this,e)}}b([S({type:fe})],x2.prototype,"digestAlgorithm",void 0);b([S({type:Xe})],x2.prototype,"digest",void 0);var w4;class A2{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.Integer,converter:kt})],A2.prototype,"prime",void 0);b([S({type:U.Integer,converter:kt})],A2.prototype,"exponent",void 0);b([S({type:U.Integer,converter:kt})],A2.prototype,"coefficient",void 0);let b4=w4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,w4.prototype)}};b4=w4=b([te({type:G.Sequence,itemType:A2})],b4);class fi{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.Integer})],fi.prototype,"version",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"modulus",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"publicExponent",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"privateExponent",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"prime1",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"prime2",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"exponent1",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"exponent2",void 0);b([S({type:U.Integer,converter:kt})],fi.prototype,"coefficient",void 0);b([S({type:b4,optional:!0})],fi.prototype,"otherPrimeInfos",void 0);class A5{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.Integer,converter:kt})],A5.prototype,"modulus",void 0);b([S({type:U.Integer,converter:kt})],A5.prototype,"publicExponent",void 0);var v4;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(v4||(v4={}));const Jr=v4;/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var E4=function(r,e){return E4=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var s in n)n.hasOwnProperty(s)&&(t[s]=n[s])},E4(r,e)};function I5(r,e){E4(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function fJ(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(u){try{l(n.next(u))}catch(h){o(h)}}function c(u){try{l(n.throw(u))}catch(h){o(h)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((n=n.apply(r,[])).next())})}function pJ(r,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,s&&(i=l[0]&2?s.return:l[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,l[1])).done)return i;switch(s=0,i&&(l=[l[0]&2,i.value]),l[0]){case 0:case 1:i=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,s=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!i||l[1]>i[0]&&l[1]<i[3])){t.label=l[1];break}if(l[0]===6&&t.label<i[1]){t.label=i[1],i=l;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(l);break}i[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(u){l=[6,u],s=0}finally{n=i=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function P1(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function H0(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),s,i=[],o;try{for(;(e===void 0||e-- >0)&&!(s=n.next()).done;)i.push(s.value)}catch(a){o={error:a}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return i}function Ma(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(H0(arguments[e]));return r}var gJ="injectionTokens";function yJ(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(gJ,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function PT(r){return!!r.useClass}function S4(r){return!!r.useFactory}var DT=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},s=!1,i,o=function(){return s||(i=e(t.wrap()),s=!0),i};return new Proxy(n,this.createHandler(o))},r.prototype.createHandler=function(e){var t={},n=function(s){t[s]=function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];i[0]=e();var a=Reflect[s];return a.apply(void 0,Ma(i))}};return this.reflectMethods.forEach(n),t},r}();function gl(r){return typeof r=="string"||typeof r=="symbol"}function mJ(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function Iv(r){return typeof r=="object"&&"token"in r&&"transform"in r}function wJ(r){return typeof r=="function"||r instanceof DT}function rp(r){return!!r.useToken}function np(r){return r.useValue!=null}function bJ(r){return PT(r)||np(r)||rp(r)||S4(r)}var k5=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),vJ=function(r){I5(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(k5),D1=function(){function r(){this.scopedResolutions=new Map}return r}();function EJ(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function SJ(r,e,t){return t===void 0&&(t="    "),Ma([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function _J(r,e,t){var n=H0(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),s=n[1],i=s===void 0?null:s,o=EJ(i,e);return SJ("Cannot inject the dependency "+o+' of "'+r.name+'" constructor. Reason:',t)}function xJ(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var AJ=function(r){I5(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(k5),IJ=function(r){I5(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(k5),kJ=function(){function r(){this.preResolution=new AJ,this.postResolution=new IJ}return r}(),RT=new Map,TJ=function(){function r(e){this.parent=e,this._registry=new vJ,this.interceptors=new kJ,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:Jr.Transient}),this.ensureNotDisposed();var s;if(bJ(t)?s=t:s={useClass:t},rp(s))for(var i=[e],o=s;o!=null;){var a=o.useToken;if(i.includes(a))throw new Error("Token registration cycle detected! "+Ma(i,[a]).join(" -> "));i.push(a);var c=this._registry.get(a);c&&rp(c.provider)?o=c.provider:o=null}if((n.lifecycle===Jr.Singleton||n.lifecycle==Jr.ContainerScoped||n.lifecycle==Jr.ResolutionScoped)&&(np(s)||S4(s)))throw new Error('Cannot use lifecycle "'+Jr[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:s,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),gl(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),gl(e)){if(gl(t))return this.register(e,{useToken:t},{lifecycle:Jr.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:Jr.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!gl(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:Jr.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new D1),n===void 0&&(n=!1),this.ensureNotDisposed();var s=this.getRegistration(e);if(!s&&gl(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),s){var i=this.resolveRegistration(s,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}if(wJ(e)){var i=this.construct(e,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,s;if(this.interceptors.preResolution.has(e)){var i=[];try{for(var o=P1(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&i.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(s=o.return)&&s.call(o)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,i)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var s,i;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=P1(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&o.push(l),l.callback(e,t,n)}}catch(u){s={error:u}}finally{try{c&&!c.done&&(i=a.return)&&i.call(a)}finally{if(s)throw s.error}}this.interceptors.postResolution.setAll(e,o)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===Jr.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===Jr.Singleton,s=e.options.lifecycle===Jr.ContainerScoped,i=n||s,o;return np(e.provider)?o=e.provider.useValue:rp(e.provider)?o=i?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):PT(e.provider)?o=i?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):S4(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===Jr.ResolutionScoped&&t.scopedResolutions.set(e,o),o},r.prototype.resolveAll=function(e,t,n){var s=this;t===void 0&&(t=new D1),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getAllRegistrations(e);if(!i&&gl(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),i){var o=i.map(function(c){return s.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=P1(this._registry.entries()),s=n.next();!s.done;s=n.next()){var i=H0(s.value,2),o=i[0],a=i[1];this._registry.setAll(o,a.filter(function(c){return!np(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var s=P1(this._registry.entries()),i=s.next();!i.done;i=s.next()){var o=H0(i.value,2),a=o[0],c=o[1];c.some(function(l){var u=l.options;return u.lifecycle===Jr.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===Jr.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return fJ(this,void 0,void 0,function(){var e;return pJ(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var s=n.dispose();s&&e.push(s)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof DT)return e.createProxy(function(i){return n.resolve(i,t)});var s=function(){var i=RT.get(e);if(!i||i.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=i.map(n.resolveParams(t,e));return new(e.bind.apply(e,Ma([void 0],o)))}();return xJ(s)&&this.disposables.add(s),s},r.prototype.resolveParams=function(e,t){var n=this;return function(s,i){var o,a,c;try{return mJ(s)?Iv(s)?s.multiple?(o=n.resolve(s.transform)).transform.apply(o,Ma([n.resolveAll(s.token,new D1,s.isOptional)],s.transformArgs)):(a=n.resolve(s.transform)).transform.apply(a,Ma([n.resolve(s.token,e,s.isOptional)],s.transformArgs)):s.multiple?n.resolveAll(s.token,new D1,s.isOptional):n.resolve(s.token,e,s.isOptional):Iv(s)?(c=n.resolve(s.transform,e)).transform.apply(c,Ma([n.resolve(s.token,e)],s.transformArgs)):n.resolve(s,e)}catch(l){throw new Error(_J(t,i,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),Ir=new TJ;function I2(r){return function(e){RT.set(e,yJ(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var _4;class k2{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}b([S({type:U.ObjectIdentifier})],k2.prototype,"attrId",void 0);b([S({type:U.Any,repeated:"set"})],k2.prototype,"attrValues",void 0);let kv=_4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,_4.prototype)}};kv=_4=b([te({type:G.Sequence,itemType:k2})],kv);var x4;let Tv=x4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,x4.prototype)}};Tv=x4=b([te({type:G.Sequence,itemType:th})],Tv);class OT{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],OT.prototype,"certId",void 0);b([S({type:U.Any,context:0})],OT.prototype,"certValue",void 0);class NT{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],NT.prototype,"crlId",void 0);b([S({type:U.Any,context:0})],NT.prototype,"crltValue",void 0);class MT extends Xe{}let T2=class{constructor(e={}){this.encryptionAlgorithm=new fe,this.encryptedData=new MT,Object.assign(this,e)}};b([S({type:fe})],T2.prototype,"encryptionAlgorithm",void 0);b([S({type:MT})],T2.prototype,"encryptedData",void 0);var A4,I4;(function(r){r[r.v1=0]="v1"})(I4||(I4={}));class BT extends Xe{}let k4=A4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,A4.prototype)}};k4=A4=b([te({type:G.Sequence,itemType:Xi})],k4);class qf{constructor(e={}){this.version=I4.v1,this.privateKeyAlgorithm=new fe,this.privateKey=new BT,Object.assign(this,e)}}b([S({type:U.Integer})],qf.prototype,"version",void 0);b([S({type:fe})],qf.prototype,"privateKeyAlgorithm",void 0);b([S({type:BT})],qf.prototype,"privateKey",void 0);b([S({type:k4,implicit:!0,context:0,optional:!0})],qf.prototype,"attributes",void 0);let Cv=class extends qf{};Cv=b([te({type:G.Sequence})],Cv);let Pv=class extends T2{};Pv=b([te({type:G.Sequence})],Pv);class LT{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],LT.prototype,"secretTypeId",void 0);b([S({type:U.Any,context:0})],LT.prototype,"secretValue",void 0);class Hf{constructor(e={}){this.mac=new x2,this.macSalt=new Xe,this.iterations=1,Object.assign(this,e)}}b([S({type:x2})],Hf.prototype,"mac",void 0);b([S({type:Xe})],Hf.prototype,"macSalt",void 0);b([S({type:U.Integer,defaultValue:1})],Hf.prototype,"iterations",void 0);class C2{constructor(e={}){this.version=3,this.authSafe=new th,this.macData=new Hf,Object.assign(this,e)}}b([S({type:U.Integer})],C2.prototype,"version",void 0);b([S({type:th})],C2.prototype,"authSafe",void 0);b([S({type:Hf,optional:!0})],C2.prototype,"macData",void 0);var T4;class P2{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:U.ObjectIdentifier})],P2.prototype,"bagId",void 0);b([S({type:U.Any,context:0})],P2.prototype,"bagValue",void 0);b([S({type:k2,repeated:"set",optional:!0})],P2.prototype,"bagAttributes",void 0);let Dv=T4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,T4.prototype)}};Dv=T4=b([te({type:G.Sequence,itemType:P2})],Dv);var C4,P4,D4;const $T="1.2.840.113549.1.9",UT=`${$T}.7`,T5=`${$T}.14`;let z0=class extends Ar{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};b([S({type:U.IA5String})],z0.prototype,"ia5String",void 0);z0=b([te({type:G.Choice})],z0);let Rv=class extends th{};Rv=b([te({type:G.Sequence})],Rv);let Ov=class extends C2{};Ov=b([te({type:G.Sequence})],Ov);let Nv=class extends T2{};Nv=b([te({type:G.Sequence})],Nv);let R4=class{constructor(e=""){this.value=e}toString(){return this.value}};b([S({type:U.IA5String})],R4.prototype,"value",void 0);R4=b([te({type:G.Choice})],R4);let Mv=class extends z0{};Mv=b([te({type:G.Choice})],Mv);let Bv=class extends Ar{};Bv=b([te({type:G.Choice})],Bv);let O4=class{constructor(e=new Date){this.value=e}};b([S({type:U.GeneralizedTime})],O4.prototype,"value",void 0);O4=b([te({type:G.Choice})],O4);let Lv=class extends Ar{};Lv=b([te({type:G.Choice})],Lv);let N4=class{constructor(e="M"){this.value=e}toString(){return this.value}};b([S({type:U.PrintableString})],N4.prototype,"value",void 0);N4=b([te({type:G.Choice})],N4);let W0=class{constructor(e=""){this.value=e}toString(){return this.value}};b([S({type:U.PrintableString})],W0.prototype,"value",void 0);W0=b([te({type:G.Choice})],W0);let $v=class extends W0{};$v=b([te({type:G.Choice})],$v);let Uv=class extends Ar{};Uv=b([te({type:G.Choice})],Uv);let M4=class{constructor(e=""){this.value=e}toString(){return this.value}};b([S({type:U.ObjectIdentifier})],M4.prototype,"value",void 0);M4=b([te({type:G.Choice})],M4);let Fv=class extends Er{};Fv=b([te({type:G.Choice})],Fv);let B4=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};b([S({type:U.Integer})],B4.prototype,"value",void 0);B4=b([te({type:G.Choice})],B4);let Vv=class extends di{};Vv=b([te({type:G.Sequence})],Vv);let j0=class extends Ar{};j0=b([te({type:G.Choice})],j0);let Kv=C4=class extends sa{constructor(e){super(e),Object.setPrototypeOf(this,C4.prototype)}};Kv=C4=b([te({type:G.Sequence})],Kv);let qv=P4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,P4.prototype)}};qv=P4=b([te({type:G.Set,itemType:eh})],qv);let L4=class{constructor(e=""){this.value=e}toString(){return this.value}};b([S({type:U.BmpString})],L4.prototype,"value",void 0);L4=b([te({type:G.Choice})],L4);let $4=class extends fe{};$4=b([te({type:G.Sequence})],$4);let Hv=D4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,D4.prototype)}};Hv=D4=b([te({type:G.Sequence,itemType:$4})],Hv);var U4;let G0=U4=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,U4.prototype)}};G0=U4=b([te({type:G.Sequence,itemType:Xi})],G0);class sh{constructor(e={}){this.version=0,this.subject=new Ht,this.subjectPKInfo=new ks,this.attributes=new G0,Object.assign(this,e)}}b([S({type:U.Integer})],sh.prototype,"version",void 0);b([S({type:Ht})],sh.prototype,"subject",void 0);b([S({type:ks})],sh.prototype,"subjectPKInfo",void 0);b([S({type:G0,implicit:!0,context:0})],sh.prototype,"attributes",void 0);class Zd{constructor(e={}){this.certificationRequestInfo=new sh,this.signatureAlgorithm=new fe,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}b([S({type:sh})],Zd.prototype,"certificationRequestInfo",void 0);b([S({type:fe})],Zd.prototype,"signatureAlgorithm",void 0);b([S({type:U.BitString})],Zd.prototype,"signature",void 0);const zf="crypto.algorithm";class CJ{getAlgorithms(){return Ir.resolveAll(zf)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){const t=new fe({algorithm:e.name});if("parameters"in e){const n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const n of this.getAlgorithms()){const s=n.toWebAlgorithm(e);if(s)return s}return{name:e.algorithm,parameters:e.parameters}}}const Tc="crypto.algorithmProvider";Ir.registerSingleton(Tc,CJ);var sp;const wn="1.3.36.3.3.2.8.1.1",zv=`${wn}.1`,Wv=`${wn}.2`,jv=`${wn}.3`,Gv=`${wn}.4`,Qv=`${wn}.5`,Yv=`${wn}.6`,Xv=`${wn}.7`,Zv=`${wn}.8`,Jv=`${wn}.9`,e9=`${wn}.10`,t9=`${wn}.11`,r9=`${wn}.12`,n9=`${wn}.13`,s9=`${wn}.14`,i9="brainpoolP160r1",o9="brainpoolP160t1",a9="brainpoolP192r1",c9="brainpoolP192t1",l9="brainpoolP224r1",u9="brainpoolP224t1",h9="brainpoolP256r1",d9="brainpoolP256t1",f9="brainpoolP320r1",p9="brainpoolP320t1",g9="brainpoolP384r1",y9="brainpoolP384t1",m9="brainpoolP512r1",w9="brainpoolP512t1",Bt="ECDSA";let Jd=sp=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Bt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return JZ;case"sha-256":return eJ;case"sha-384":return tJ;case"sha-512":return rJ}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=_v;break;case"K-256":t=sp.SECP256K1;break;case"P-384":t=xv;break;case"P-521":t=Av;break;case i9:t=zv;break;case o9:t=Wv;break;case a9:t=jv;break;case c9:t=Gv;break;case l9:t=Qv;break;case u9:t=Yv;break;case h9:t=Xv;break;case d9:t=Zv;break;case f9:t=Jv;break;case p9:t=e9;break;case g9:t=t9;break;case y9:t=r9;break;case m9:t=n9;break;case w9:t=s9;break}if(t)return new fe({algorithm:Yd,parameters:ce.serialize(new oa({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case E5:return{name:Bt,hash:{name:"SHA-1"}};case S5:return{name:Bt,hash:{name:"SHA-256"}};case _5:return{name:Bt,hash:{name:"SHA-384"}};case x5:return{name:Bt,hash:{name:"SHA-512"}};case Yd:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(ce.parse(e.parameters,oa).namedCurve){case _v:return{name:Bt,namedCurve:"P-256"};case sp.SECP256K1:return{name:Bt,namedCurve:"K-256"};case xv:return{name:Bt,namedCurve:"P-384"};case Av:return{name:Bt,namedCurve:"P-521"};case zv:return{name:Bt,namedCurve:i9};case Wv:return{name:Bt,namedCurve:o9};case jv:return{name:Bt,namedCurve:a9};case Gv:return{name:Bt,namedCurve:c9};case Qv:return{name:Bt,namedCurve:l9};case Yv:return{name:Bt,namedCurve:u9};case Xv:return{name:Bt,namedCurve:h9};case Zv:return{name:Bt,namedCurve:d9};case Jv:return{name:Bt,namedCurve:f9};case e9:return{name:Bt,namedCurve:p9};case t9:return{name:Bt,namedCurve:g9};case r9:return{name:Bt,namedCurve:y9};case n9:return{name:Bt,namedCurve:m9};case s9:return{name:Bt,namedCurve:w9}}}}return null}};Jd.SECP256K1="1.3.132.0.10";Jd=sp=b([I2()],Jd);Ir.registerSingleton(zf,Jd);const FT=Symbol("name"),VT=Symbol("value");class st{constructor(e,t={},n=""){this[FT]=e,this[VT]=n;for(const s in t)this[s]=t[s]}}st.NAME=FT;st.VALUE=VT;class PJ{static toTextObject(e){const t=new st("Algorithm Identifier",{},da.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case Yd:{const n=new Jd().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class da{static toString(e){const t=this.items[e];return t||e}}da.items={[F0]:"sha1",[kT]:"sha224",[V0]:"sha256",[K0]:"sha384",[q0]:"sha512",[Ac]:"rsaEncryption",[L0]:"sha1WithRSAEncryption",[cJ]:"sha224WithRSAEncryption",[m4]:"sha256WithRSAEncryption",[$0]:"sha384WithRSAEncryption",[U0]:"sha512WithRSAEncryption",[Yd]:"ecPublicKey",[E5]:"ecdsaWithSHA1",[xT]:"ecdsaWithSHA224",[S5]:"ecdsaWithSHA256",[_5]:"ecdsaWithSHA384",[x5]:"ecdsaWithSHA512",[WZ]:"TLS WWW server authentication",[jZ]:"TLS WWW client authentication",[GZ]:"Code Signing",[QZ]:"E-mail Protection",[YZ]:"Time Stamping",[XZ]:"OCSP Signing",[ZZ]:"Signed Data"};class Cc{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const n=[];let s=this.pad(t++),i="";const o=e[st.VALUE];o&&(i=` ${o}`),n.push(`${s}${e[st.NAME]}:${i}`),s=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${s}${l}${c}`);else if(c instanceof Date)n.push(`${s}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(const u of c)u[st.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof st)c[st.NAME]=a,n.push(...this.serializeObj(c,t));else if(le.isBufferSource(c))a?(n.push(`${s}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const u=c.toTextObject();u[st.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){const n=this.pad(t),s=le.toUint8Array(e),i=[];for(let o=0;o<s.length;){const a=[];for(let c=0;c<16&&o<s.length;c++){c===8&&a.push("");const l=s[o++].toString(16).padStart(2,"0");a.push(l)}i.push(`${n}${a.join(" ")}`)}return i}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}Cc.oidSerializer=da;Cc.algorithmSerializer=PJ;class fa{constructor(...e){if(e.length===1){const t=e[0];this.rawData=ce.serialize(t),this.onInit(t)}else{const t=ce.parse(e[0],e[1]);this.rawData=le.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof fa?uI(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return ce.toString(this.rawData);case"text":return Cc.serialize(this.toTextObject());case"hex":return ye.ToHex(this.rawData);case"base64":return ye.ToBase64(this.rawData);case"base64url":return ye.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new st(this.getTextName(),{},e)}}fa.NAME="ASN";class Un extends fa{constructor(...e){let t;le.isBufferSource(e[0])?t=le.toArrayBuffer(e[0]):t=ce.serialize(new hs({extnID:e[0],critical:e[1],extnValue:new Xe(le.toArrayBuffer(e[2]))})),super(t,hs)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[st.NAME]===Un.NAME&&(e[st.NAME]=da.toString(this.type)),e}}var KT;class Mo{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[KT]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(Mo.DEFAULT,crypto):typeof C1<"u"&&C1.crypto&&C1.crypto.subtle&&this.set(Mo.DEFAULT,C1.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=Mo.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(Mo.DEFAULT,e);return this}}KT=Symbol.toStringTag;Mo.DEFAULT="default";const mr=new Mo,DJ=/^[0-2](?:\.[1-9][0-9]*)+$/;function RJ(r){return new RegExp(DJ).test(r)}class qT{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return RJ(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const yn=new qT;yn.register("CN","2.5.4.3");yn.register("L","2.5.4.7");yn.register("ST","2.5.4.8");yn.register("O","2.5.4.10");yn.register("OU","2.5.4.11");yn.register("C","2.5.4.6");yn.register("DC","0.9.2342.19200300.100.1.25");yn.register("E","1.2.840.113549.1.9.1");yn.register("G","2.5.4.42");yn.register("I","2.5.4.43");yn.register("SN","2.5.4.4");yn.register("T","2.5.4.12");function OJ(r,e){return`\\${ye.ToHex(ye.FromUtf8String(e)).toUpperCase()}`}function NJ(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,OJ)}class ts{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new qT,this.asn=new Ht;for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const s=t[n];this.extraNames.register(n,s)}typeof e=="string"?this.asn=this.fromString(e):e instanceof Ht?this.asn=e:le.isBufferSource(e)?this.asn=ce.parse(e,Ht):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||yn.findId(e),n=[];for(const s of this.asn)for(const i of s)i.type===t&&n.push(i.value.toString());return n}getName(e){return this.extraNames.get(e)||yn.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const n=this.getName(t.type)||t.type,s=t.value.anyValue?`#${ye.ToHex(t.value.anyValue)}`:NJ(t.value.toString());return`${n}=${s}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const n of this.asn){const s={};for(const i of n){const o=this.getName(i.type)||i.type;(e=s[o])!==null&&e!==void 0||(s[o]=[]),s[o].push(i.value.anyValue?`#${ye.ToHex(i.value.anyValue)}`:i.value.toString())}t.push(s)}return t}fromString(e){const t=new Ht,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let s=null,i=",";for(;s=n.exec(`${e},`);){let[,o,a]=s;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),s[3]=c);const l=s[3];o=this.getTypeOid(o);const u=this.createAttribute(o,a);i==="+"?t[t.length-1].push(u):t.push(new Eu([u])),i=l}return t}fromJSON(e){const t=new Ht;for(const n of e){const s=new Eu;for(const i in n){const o=this.getTypeOid(i),a=n[i];for(const c of a){const l=this.createAttribute(o,c);s.push(l)}}t.push(s)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const n=new o2({type:e});if(typeof t=="object")for(const s in t)switch(s){case"ia5String":n.value.ia5String=t[s];break;case"utf8String":n.value.utf8String=t[s];break;case"universalString":n.value.universalString=t[s];break;case"bmpString":n.value.bmpString=t[s];break;case"printableString":n.value.printableString=t[s];break}else if(t[0]==="#")n.value.anyValue=ye.FromHex(t.slice(1));else{const s=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=s:ts.isPrintableString(s)?n.value.printableString=s:n.value.utf8String=s}return n}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return ce.serialize(this.asn)}async getThumbprint(...e){var t;let n,s="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(s=e[0]||s,n=e[1]||mr.get()):n=e[0]||mr.get(),await n.subtle.digest(s,this.toArrayBuffer())}}const HT="Cannot initialize GeneralName from ASN.1 data.",b9=`${HT} Unsupported string format in use.`,MJ=`${HT} Value doesn't match to GUID regular expression.`,v9=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,E9="1.3.6.1.4.1.311.25.1",S9="1.3.6.1.4.1.311.20.2.3",Ky="dns",qy="dn",Hy="email",zy="ip",Wy="url",jy="guid",Gy="upn",R1="id";class Bo extends fa{constructor(...e){let t;if(e.length===2)switch(e[0]){case qy:{const n=new ts(e[1]).toArrayBuffer(),s=ce.parse(n,Ht);t=new Ne({directoryName:s});break}case Ky:t=new Ne({dNSName:e[1]});break;case Hy:t=new Ne({rfc822Name:e[1]});break;case jy:{const n=new RegExp(v9,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const s=n.slice(1).map((i,o)=>o<3?ye.ToHex(new Uint8Array(ye.FromHex(i)).reverse()):i).join("");t=new Ne({otherName:new Wd({typeId:E9,value:ce.serialize(new Xe(ye.FromHex(s)))})});break}case zy:t=new Ne({iPAddress:e[1]});break;case R1:t=new Ne({registeredID:e[1]});break;case Gy:{t=new Ne({otherName:new Wd({typeId:S9,value:ce.serialize(oT.toASN(e[1]))})});break}case Wy:t=new Ne({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else le.isBufferSource(e[0])?t=ce.parse(e[0],Ne):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=Ky,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=Hy,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=zy,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=Wy,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=R1,this.value=e.registeredID;else if(e.directoryName!=null)this.type=qy,this.value=new ts(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===E9){this.type=jy;const t=ce.parse(e.otherName.value,Xe),n=new RegExp(v9,"i").exec(ye.ToHex(t));if(!n)throw new Error(MJ);this.value=n.slice(1).map((s,i)=>i<3?ye.ToHex(new Uint8Array(ye.FromHex(s)).reverse()):s).join("-")}else if(e.otherName.typeId===S9)this.type=Gy,this.value=ce.parse(e.otherName.value,Ar).toString();else throw new Error(b9);else throw new Error(b9)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case qy:case Ky:case jy:case zy:case R1:case Gy:case Wy:e=this.type.toUpperCase();break;case Hy:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===R1&&(t=da.toString(t)),new st(e,void 0,t)}}class Pc extends fa{constructor(e){let t;if(e instanceof $r)t=e;else if(Array.isArray(e)){const n=[];for(const s of e)if(s instanceof Ne)n.push(s);else{const i=ce.parse(new Bo(s.type,s.value).rawData,Ne);n.push(i)}t=new $r(n)}else if(le.isBufferSource(e))t=ce.parse(e,$r);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const n of e){let s=null;try{s=new Bo(n)}catch{continue}t.push(s)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const n=t.toTextObject();let s=e[n[st.NAME]];Array.isArray(s)||(s=[],e[n[st.NAME]]=s),s.push(n)}return e}}Pc.NAME="GeneralNames";const ld="-{5}",ef="\\n",BJ=`[^${ef}]+`,LJ=`${ld}BEGIN (${BJ}(?=${ld}))${ld}`,$J=`${ld}END \\1${ld}`,Cu="\\n",UJ=`[^:${ef}]+`,FJ=`(?:[^${ef}]+${Cu}(?: +[^${ef}]+${Cu})*)`,VJ="[a-zA-Z0-9=+/]+",KJ=`(?:${VJ}${Cu})+`,_9=`${LJ}${Cu}(?:((?:${UJ}: ${FJ})+))?${Cu}?(${KJ})${$J}`;class Pn{static isPem(e){return typeof e=="string"&&new RegExp(_9,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(_9,"g"),n=[];let s=null;for(;s=t.exec(e);){const i=s[3].replace(new RegExp(`[${ef}]+`,"g"),""),o={type:s[1],headers:[],rawData:ye.FromBase64(i)},a=s[2];if(a){const c=a.split(new RegExp(Cu,"g"));let l=null;for(const u of c){const[h,d]=u.split(/:(.*)/);if(d===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=h.trim()}else l&&o.headers.push(l),l={key:h,value:d.trim()}}l&&o.headers.push(l)}n.push(o)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const n=new Array;return t?e.forEach(s=>{if(!le.isBufferSource(s))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:le.toArrayBuffer(s)}))}):e.forEach(s=>{if(!("type"in s))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(s))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:le.toArrayBuffer(e)})}}static encodeStruct(e){var t;const n=e.type.toLocaleUpperCase(),s=[];if(s.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const l of e.headers)s.push(`${l.key}: ${l.value}`);s.push("")}const i=ye.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<i.length&&(i.length-a<64?o=i.substring(a):(o=i.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return s.push(...c),s.push(`-----END ${n}-----`),s.join(`
`)}}Pn.CertificateTag="CERTIFICATE";Pn.CrlTag="CRL";Pn.CertificateRequestTag="CERTIFICATE REQUEST";Pn.PublicKeyTag="PUBLIC KEY";Pn.PrivateKeyTag="PRIVATE KEY";class eo extends fa{static isAsnEncoded(e){return le.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(Pn.isPem(e))return Pn.decode(e)[0];if(ye.isHex(e))return ye.FromHex(e);if(ye.isBase64(e))return ye.FromBase64(e);if(ye.isBase64Url(e))return ye.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=ye.ToBinary(e);return Pn.isPem(t)?Pn.decode(t)[0]:ye.isHex(t)?ye.FromHex(t):ye.isBase64(t)?ye.FromBase64(t):ye.isBase64Url(t)?ye.FromBase64Url(t):le.toArrayBuffer(e)}}constructor(...e){eo.isAsnEncoded(e[0])?super(eo.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return Pn.encode(this.rawData,this.tag);default:return super.toString(e)}}}class Ds extends eo{static async create(e,t=mr.get()){if(e instanceof Ds)return e;if(Mo.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const n=await t.subtle.exportKey("spki",e);return new Ds(n)}else{if(e.publicKey)return e.publicKey;if(le.isBufferSource(e))return new Ds(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){eo.isAsnEncoded(e)?super(e,ks):super(e),this.tag=Pn.PublicKeyTag}async export(...e){let t,n=["verify"],s={hash:"SHA-256",...this.algorithm};e.length>1?(s=e[0]||s,n=e[1]||n,t=e[2]||mr.get()):t=e[0]||mr.get();let i=this.rawData;const o=ce.parse(this.rawData,ks);return o.algorithm.algorithm===cd&&(i=qJ(o,i)),t.subtle.importKey("spki",i,s,!0,n)}onInit(e){const t=Ir.resolve(Tc),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case Ac:{const s=ce.parse(e.subjectPublicKey,A5),i=le.toUint8Array(s.modulus);n.publicExponent=le.toUint8Array(s.publicExponent),n.modulusLength=(i[0]?i:i.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,s="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(s=e[0]||s,n=e[1]||mr.get()):n=e[0]||mr.get(),await n.subtle.digest(s,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=mr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=mr.get();const s=ce.parse(this.rawData,ks);return await t.subtle.digest(n,s.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=ce.parse(this.rawData,ks);switch(e.Algorithm=Cc.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case Yd:e["EC Point"]=t.subjectPublicKey;break;case Ac:default:e["Raw Data"]=t.subjectPublicKey}return e}}function qJ(r,e){return r.algorithm=new fe({algorithm:Ac,parameters:null}),e=ce.serialize(r),e}class tf extends Un{static async create(e,t=!1,n=mr.get()){if("name"in e&&"serialNumber"in e)return new tf(e,t);const i=await(await Ds.create(e,n)).getKeyIdentifier(n);return new tf(ye.ToHex(i),t)}constructor(...e){if(le.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new za({keyIdentifier:new o5(ye.FromHex(e[0]))});super(M3,e[1],ce.serialize(t))}else{const t=e[0],n=t.name instanceof Pc?ce.parse(t.name.rawData,$r):t.name,s=new za({authorityCertIssuer:n,authorityCertSerialNumber:ye.FromHex(t.serialNumber)});super(M3,e[1],ce.serialize(s))}}onInit(e){super.onInit(e);const t=ce.parse(e.extnValue,za);t.keyIdentifier&&(this.keyId=ye.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?ye.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ce.parse(this.value,za);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Pc(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}tf.NAME="Authority Key Identifier";class C5 extends Un{constructor(...e){if(le.isBufferSource(e[0])){super(e[0]);const t=ce.parse(this.value,b0);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new b0({cA:e[0],pathLenConstraint:e[1]});super(cT,e[2],ce.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}C5.NAME="Basic Constraints";var x9;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(x9||(x9={}));class zT extends Un{constructor(...e){if(le.isBufferSource(e[0])){super(e[0]);const t=ce.parse(this.value,_0);this.usages=t.map(n=>n)}else{const t=new _0(e[0]);super(hT,e[1],ce.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>da.toString(t)).join(", "),e}}zT.NAME="Extended Key Usages";var A9;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(A9||(A9={}));class WT extends Un{constructor(...e){if(le.isBufferSource(e[0])){super(e[0]);const t=ce.parse(this.value,Vy);this.usages=t.toNumber()}else{const t=new Vy(e[0]);super(fT,e[1],ce.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ce.parse(this.value,Vy);return e[""]=t.toJSON().join(", "),e}}WT.NAME="Key Usages";class D2 extends Un{static async create(e,t=!1,n=mr.get()){const i=await(await Ds.create(e,n)).getKeyIdentifier(n);return new D2(ye.ToHex(i),t)}constructor(...e){if(le.isBufferSource(e[0])){super(e[0]);const t=ce.parse(this.value,Vo);this.keyId=ye.ToHex(t)}else{const t=typeof e[0]=="string"?ye.FromHex(e[0]):e[0],n=new Vo(t);super(mT,e[1],ce.serialize(n)),this.keyId=ye.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ce.parse(this.value,Vo);return e[""]=t,e}}D2.NAME="Subject Key Identifier";class jT extends Un{constructor(...e){le.isBufferSource(e[0])?super(e[0]):super(yT,e[1],new Pc(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=ce.parse(e.extnValue,Y3);this.names=new Pc(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}jT.NAME="Subject Alternative Name";class Fn{static register(e,t){this.items.set(e,t)}static create(e){const t=new Un(e),n=this.items.get(t.type);return n?new n(e):t}}Fn.items=new Map;class GT extends Un{constructor(...e){var t;if(le.isBufferSource(e[0])){super(e[0]);const n=ce.parse(this.value,E0);this.policies=n.map(s=>s.policyIdentifier)}else{const n=e[0],s=(t=e[1])!==null&&t!==void 0?t:!1,i=new E0(n.map(o=>new c2({policyIdentifier:o})));super(lT,s,ce.serialize(i)),this.policies=n}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new st("",{},da.toString(t))),e}}GT.NAME="Certificate Policies";Fn.register(lT,GT);class QT extends Un{constructor(...e){var t;if(le.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const s=e[0].map(o=>new Zu({distributionPoint:new Ec({fullName:[new Ne({uniformResourceIdentifier:o})]})})),i=new Wl(s);super(F3,e[1],ce.serialize(i))}else{const n=new Wl(e[0]);super(F3,e[1],ce.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=ce.parse(e.extnValue,Wl);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;const s={};return t.distributionPoint&&(s[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(i=>new Bo(i).toString()).join(", ")),t.reasons&&(s.Reasons=t.reasons.toString()),t.cRLIssuer&&(s["CRL Issuer"]=t.cRLIssuer.map(i=>i.toString()).join(", ")),s}),e}}QT.NAME="CRL Distribution Points";class YT extends Un{constructor(...e){var t,n,s,i;if(le.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof Dl){const o=new Dl(e[0]);super(N3,e[1],ce.serialize(o))}else{const o=e[0],a=new Dl;N1(a,o,cv,"ocsp"),N1(a,o,lv,"caIssuers"),N1(a,o,uv,"timeStamping"),N1(a,o,hv,"caRepository"),super(N3,e[1],ce.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(s=this.timeStamping)!==null&&s!==void 0||(this.timeStamping=[]),(i=this.caRepository)!==null&&i!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],ce.parse(e.extnValue,Dl).forEach(n=>{switch(n.accessMethod){case cv:this.ocsp.push(new Bo(n.accessLocation));break;case lv:this.caIssuers.push(new Bo(n.accessLocation));break;case uv:this.timeStamping.push(new Bo(n.accessLocation));break;case hv:this.caRepository.push(new Bo(n.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&O1(e,"OCSP",this.ocsp),this.caIssuers.length&&O1(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&O1(e,"Time Stamping",this.timeStamping),this.caRepository.length&&O1(e,"CA Repository",this.caRepository),e}}YT.NAME="Authority Info Access";function O1(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{const n=new st("");t.forEach((s,i)=>{const o=s.toTextObject(),a=`${o[st.NAME]} ${i+1}`;let c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(o)}),r[e]=n}}function N1(r,e,t,n){const s=e[n];s&&(Array.isArray(s)?s:[s]).forEach(o=>{typeof o=="string"&&(o=new Bo("url",o)),r.push(new Of({accessMethod:t,accessLocation:ce.parse(o.rawData,Ne)}))})}class XT extends Un{constructor(...e){le.isBufferSource(e[0])?super(e[0]):super(dT,e[1],new Pc(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=ce.parse(e.extnValue,$r);this.names=new Pc(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}XT.NAME="Issuer Alternative Name";class ih extends fa{constructor(...e){let t;if(le.isBufferSource(e[0]))t=le.toArrayBuffer(e[0]);else{const n=e[0],s=Array.isArray(e[1])?e[1].map(i=>le.toArrayBuffer(i)):[];t=ce.serialize(new Xi({type:n,values:s}))}super(t,Xi)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new st("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[st.NAME]===ih.NAME&&(e[st.NAME]=da.toString(this.type)),e}}ih.NAME="Attribute";class ZT extends ih{constructor(...e){var t;if(le.isBufferSource(e[0]))super(e[0]);else{const n=new j0({printableString:e[0]});super(UT,[ce.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=ce.parse(this.values[0],j0);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[st.VALUE]=this.password,e}}ZT.NAME="Challenge Password";class P5 extends ih{constructor(...e){var t;if(le.isBufferSource(e[0]))super(e[0]);else{const n=e[0],s=new sa;for(const i of n)s.push(ce.parse(i.rawData,hs));super(T5,[ce.serialize(s)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=ce.parse(this.values[0],sa);this.items=t.map(n=>Fn.create(ce.serialize(n)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(const n of t)e[n[st.NAME]]=n;return e}}P5.NAME="Extensions";class R2{static register(e,t){this.items.set(e,t)}static create(e){const t=new ih(e),n=this.items.get(t.type);return n?new n(e):t}}R2.items=new Map;const Wf="crypto.signatureFormatter";class HJ{toAsnSignature(e,t){return le.toArrayBuffer(t)}toWebSignature(e,t){return le.toArrayBuffer(t)}}var ip;let F4=ip=class{static createPssParams(e,t){const n=ip.getHashAlgorithm(e);return n?new kc({hashAlgorithm:n,maskGenAlgorithm:new fe({algorithm:S2,parameters:ce.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){const t=Ir.resolve(Tc);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new fe({algorithm:L0,parameters:null});case"sha-256":return new fe({algorithm:m4,parameters:null});case"sha-384":return new fe({algorithm:$0,parameters:null});case"sha-512":return new fe({algorithm:U0,parameters:null})}}else return new fe({algorithm:Ac,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=ip.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new fe({algorithm:cd,parameters:ce.serialize(t)})}else return new fe({algorithm:cd,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case Ac:return{name:"RSASSA-PKCS1-v1_5"};case L0:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case m4:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case $0:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case U0:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case cd:if(e.parameters){const t=ce.parse(e.parameters,kc);return{name:"RSA-PSS",hash:Ir.resolve(Tc).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};F4=ip=b([I2()],F4);Ir.registerSingleton(zf,F4);let V4=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new fe({algorithm:F0});case"sha-256":return new fe({algorithm:V0});case"sha-384":return new fe({algorithm:K0});case"sha-512":return new fe({algorithm:q0})}return null}toWebAlgorithm(e){switch(e.algorithm){case F0:return{name:"SHA-1"};case V0:return{name:"SHA-256"};case K0:return{name:"SHA-384"};case q0:return{name:"SHA-512"}}return null}};V4=b([I2()],V4);Ir.registerSingleton(zf,V4);class rs{addPadding(e,t){const n=le.toUint8Array(t),s=new Uint8Array(e);return s.set(n,e-n.length),s}removePadding(e,t=!1){let n=le.toUint8Array(e);for(let s=0;s<n.length;s++)if(n[s]){n=n.slice(s);break}if(t&&n[0]>127){const s=new Uint8Array(n.length+1);return s.set(n,1),s.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const n=e.namedCurve,s=rs.namedCurveSize.get(n)||rs.defaultNamedCurveSize,i=new B0,o=le.toUint8Array(t);return i.r=this.removePadding(o.slice(0,s),!0),i.s=this.removePadding(o.slice(s,s+s),!0),ce.serialize(i)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const n=ce.parse(t,B0),s=e.namedCurve,i=rs.namedCurveSize.get(s)||rs.defaultNamedCurveSize,o=this.addPadding(i,this.removePadding(n.r)),a=this.addPadding(i,this.removePadding(n.s));return VW(o,a)}return null}}rs.namedCurveSize=new Map;rs.defaultNamedCurveSize=32;const Qy="1.3.101.110",I9="1.3.101.111",Yy="1.3.101.112",k9="1.3.101.113";let K4=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=Yy;break;case"x25519":t=Qy;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=Yy;break;case"ed448":t=k9;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=Qy;break;case"x448":t=I9;break}}return t?new fe({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case Yy:return{name:"Ed25519"};case k9:return{name:"EdDSA",namedCurve:"Ed448"};case Qy:return{name:"X25519"};case I9:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};K4=b([I2()],K4);Ir.registerSingleton(zf,K4);class zJ extends eo{constructor(e){eo.isAsnEncoded(e)?super(e,Zd):super(e),this.tag=Pn.CertificateRequestTag}onInit(e){this.tbs=ce.serialize(e.certificationRequestInfo),this.publicKey=new Ds(e.certificationRequestInfo.subjectPKInfo);const t=Ir.resolve(Tc);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(s=>R2.create(ce.serialize(s)));const n=this.getAttribute(T5);this.extensions=[],n instanceof P5&&(this.extensions=n.items),this.subjectName=new ts(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=mr.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),s=Ir.resolveAll(Wf).reverse();let i=null;for(const a of s)if(i=a.toWebSignature(t,this.signature),i)break;if(!i)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,i,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=ce.parse(this.rawData,Zd),n=t.certificationRequestInfo,s=new st("",{Version:`${Sc[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const i=new st("");for(const o of this.attributes){const a=o.toTextObject();i[a[st.NAME]]=a}s.Attributes=i}return e.Data=s,e.Signature=new st("",{Algorithm:Cc.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}zJ.NAME="PKCS#10 Certificate Request";class D5 extends eo{constructor(e){eo.isAsnEncoded(e)?super(e,_c):super(e),this.tag=Pn.CertificateTag}onInit(e){const t=e.tbsCertificate;this.tbs=ce.serialize(t);let n=new Uint8Array(t.serialNumber);n.length>1&&n[0]===0&&n[1]>127&&(n=n.slice(1)),this.serialNumber=ye.ToHex(n),this.subjectName=new ts(t.subject),this.subject=new ts(t.subject).toString(),this.issuerName=new ts(t.issuer),this.issuer=this.issuerName.toString();const s=Ir.resolve(Tc);this.signatureAlgorithm=s.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;const i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;const o=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!o)throw new Error("Cannot get 'notAfter' value");this.notAfter=o,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(a=>Fn.create(ce.serialize(a)))),this.publicKey=new Ds(t.subjectPublicKeyInfo)}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=mr.get()){let n,s;const i=e.publicKey;try{if(!i)n={...this.publicKey.algorithm,...this.signatureAlgorithm},s=await this.publicKey.export(n,["verify"],t);else if("publicKey"in i)n={...i.publicKey.algorithm,...this.signatureAlgorithm},s=await i.publicKey.export(n,["verify"],t);else if(i instanceof Ds)n={...i.algorithm,...this.signatureAlgorithm},s=await i.export(n,["verify"],t);else if(le.isBufferSource(i)){const l=new Ds(i);n={...l.algorithm,...this.signatureAlgorithm},s=await l.export(n,["verify"],t)}else n={...i.algorithm,...this.signatureAlgorithm},s=i}catch{return!1}const o=Ir.resolveAll(Wf).reverse();let a=null;for(const l of o)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,s,a,this.tbs);if(e.signatureOnly)return c;{const u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=mr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=mr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=ce.parse(this.rawData,_c),n=t.tbsCertificate,s=new st("",{Version:`${Sc[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":Cc.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new st("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(s["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(s["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){const i=new st("");for(const o of this.extensions){const a=o.toTextObject();i[a[st.NAME]]=a}s.Extensions=i}return e.Data=s,e.Signature=new st("",{Algorithm:Cc.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}D5.NAME="Certificate";class WJ{static async createSelfSigned(e,t=mr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=mr.get()){var n;let s;e.publicKey instanceof Ds?s=e.publicKey.rawData:"publicKey"in e.publicKey?s=e.publicKey.publicKey.rawData:le.isBufferSource(e.publicKey)?s=e.publicKey:s=await t.subtle.exportKey("spki",e.publicKey);let i=e.serialNumber?le.toUint8Array(ye.FromHex(e.serialNumber)):void 0;i=this.generateSerialNumber(i,t);const o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new _c({tbsCertificate:new $n({version:Sc.v3,serialNumber:i,validity:new Nf({notBefore:o,notAfter:a}),extensions:new sa(((n=e.extensions)===null||n===void 0?void 0:n.map(m=>ce.parse(m.rawData,hs)))||[]),subjectPublicKeyInfo:ce.parse(s,ks)})});if(e.subject){const m=e.subject instanceof ts?e.subject:new ts(e.subject);c.tbsCertificate.subject=ce.parse(m.toArrayBuffer(),Ht)}if(e.issuer){const m=e.issuer instanceof ts?e.issuer:new ts(e.issuer);c.tbsCertificate.issuer=ce.parse(m.toArrayBuffer(),Ht)}const l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},h=Ir.resolve(Tc);c.tbsCertificate.signature=c.signatureAlgorithm=h.toAsnAlgorithm(u);const d=ce.serialize(c.tbsCertificate),g="signingKey"in e?await t.subtle.sign(u,e.signingKey,d):e.signature,y=Ir.resolveAll(Wf).reverse();let w=null;for(const m of y)if(w=m.toAsnSignature(u,g),w)break;if(!w)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=w,new D5(ce.serialize(c))}static generateSerialNumber(e,t){let n=e&&e.length&&e.some(i=>i>0)?new Uint8Array(e):void 0;n||(n=t.getRandomValues(new Uint8Array(16)));let s=0;for(;s<n.length-1&&n[s]===0;)s++;if(n=n.slice(s),n[0]>127){const i=new Uint8Array(n.length+1);i[0]=0,i.set(n,1),n=i}return n}}var T9;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(T9||(T9={}));Fn.register(cT,C5);Fn.register(hT,zT);Fn.register(fT,WT);Fn.register(mT,D2);Fn.register(M3,tf);Fn.register(yT,jT);Fn.register(F3,QT);Fn.register(N3,YT);Fn.register(dT,XT);R2.register(UT,ZT);R2.register(T5,P5);Ir.registerSingleton(Wf,HJ);Ir.registerSingleton(Wf,rs);rs.namedCurveSize.set("P-256",32);rs.namedCurveSize.set("K-256",32);rs.namedCurveSize.set("P-384",48);rs.namedCurveSize.set("P-521",66);class jJ extends $t{async listen(){throw new fZ("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const JT=Object.values(Ep).map(r=>r.decoder).reduce((r,e)=>r.or(e)),GJ=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function QJ(r){return r?.match(GJ)?.groups?.fingerprint}function eC(r){const t=r.stringTuples().filter(n=>n[0]===RX).map(n=>n[1])[0];if(t===void 0||t==="")throw new re(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function YJ(r){return ur(JT.decode(r))}function XJ(r){const e=YJ(eC(r)),t=JJ(e.code),n=e.digest.reduce((i,o)=>i+o.toString(16).padStart(2,"0"),""),s=n.match(/.{1,2}/g);if(s==null)throw new dZ(n,r.toString());return`${t} ${s.join(":").toUpperCase()}`}function ZJ(r){const e=r.split(":").map(s=>parseInt(s,16)),t=Uint8Array.from(e),n=zi(fn.code,t);return De(`/certhash/${cf.encode(n.bytes)}`)}function JJ(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new pZ(r)}}function eee(r,e){const{host:t,port:n,family:s}=r.toOptions(),i=XJ(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${s} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${s} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${i}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${s2}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function tee(r,e){const{host:t,port:n,family:s}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${s} ${t}
s=-
c=IN IP${s} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${s2}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function C9(r,e){if(r.sdp===void 0)throw new re("Can't munge a missing SDP");const t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}const Xy=ie("libp2p-webrtc-noise:");function ree(r,e,t){const n=r.trim().toLowerCase().replaceAll(":",""),s=ie(n,"hex"),i=zi(fn.code,s),o=JT.decode(eC(e)),a=Xy.byteLength+i.bytes.byteLength+o.byteLength;return jr(t==="server"?[Xy,o,i.bytes]:[Xy,i.bytes,o],a)}const nee=Jw?"iceconnectionstatechange":"connectionstatechange";async function see(r,e,t){const n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");const h=await r.createOffer();t.log.trace("client created local offer %s",h.sdp);const d=C9(h,e);t.log.trace("client setting local offer %s",d.sdp),await r.setLocalDescription(d);const g=eee(t.remoteAddr,e);t.log.trace("client setting server description %s",g.sdp),await r.setRemoteDescription(g)}else{const h=tee(t.remoteAddr,e);t.log.trace("server setting client %s %s",h.type,h.sdp),await r.setRemoteDescription(h),t.log.trace("server creating local answer");const d=await r.createAnswer();t.log.trace("server created local answer");const g=C9(d,e);t.log.trace("server setting local description %s",d.sdp),await r.setLocalDescription(g)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await zr(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){const h=r.remoteFingerprint()?.value??"";t.remoteAddr=t.remoteAddr.encapsulate(ZJ(h))}const s=QJ(r.localDescription?.sdp);if(s==null)throw new Rf("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);const i=ree(s,t.remoteAddr,t.role),o=zw({prologueBytes:i})(t),a=m0({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),c=new T3(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(nee,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":c.close().catch(h=>{t.log.error("error closing connection",h),c.abort(h)});break;default:break}}),t.events?.increment({peer_connection:!0});const l=new e5(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await o.secureInbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal});t.log.trace("%s secure outbound",t.role);const u=await o.secureOutbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});c.remoteAddr=c.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal})}catch(s){throw n.close(),s}}async function iee(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const s=typeof t=="function"?await t():t;return new RTCPeerConnection({...s??{},certificates:[n]})}async function oee(r){const e=await T_(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...se(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}class aee{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new $t,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new re("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[ug]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[lr]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n;const s=e.getPeerId();s!=null&&(n=nr(s));const i=cZ(),o=await iee("client",i,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await see(o,i,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(a){throw o.close(),a}}createListener(e){if(this.certificate==null)throw new Jl;return new jJ(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(Wm.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(cee(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:s}=await this.loadOrCreateCertificate(t,e);return{privateKey:await oee(t),pem:n,certhash:s}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??VX,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new Zt;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await mg("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n;const s=new wt(this.init.certificateDatastoreKey??FX),i=await T_(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new Zt;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(s,i)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(s,i)}let o=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??Jb)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:n.toString("pem"),certhash:cf.encode((await fn.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){const n=await this.components.datastore.get(e),s=new D5(n),i=s.notAfter.getTime()-(this.init.certificateRenewalThreshold??Jb);if(Date.now()>i)throw this.log("stored TLS certificate has expired"),new Zt;this.log("loaded certificate, expires in %d ms",i);const o=await s.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!We(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new Zt;return this.log("loaded certificate, expiry time is %o",i),s}async createCertificate(e,t){const n=new Date,s=new Date(Date.now()+(this.init.certificateLifespan??KX));n.setMilliseconds(0),s.setMilliseconds(0);const i=await WJ.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:s,keys:t,extensions:[new C5(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,ie(i.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),i}getKeychain(){try{return this.components.keychain}catch{}}}function cee(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function lee(r){return e=>new aee(e,r)}function tC(r){return e=>new wZ(e,r)}const uee=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})},hee=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const s of n){try{await uee(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{r.close()})})});var O2={},N2={};Object.defineProperty(N2,"__esModule",{value:!0});class dee{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let rC=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const s=new dee;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};N2.EventIterator=rC;N2.default=rC;Object.defineProperty(O2,"__esModule",{value:!0});const R5=N2;var fee=O2.EventIterator=R5.EventIterator;function pee(r,e,t){return new R5.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}O2.subscribe=pee;O2.default=R5.EventIterator;function P9(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}const gee=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((i,o)=>{if(n){i();return}if(s!=null){o(s);return}const a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(i)},l=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){const i=new fee(({push:o,stop:a,fail:c})=>{const l=h=>{let d=null;typeof h.data=="string"&&(d=ie(h.data)),P9(h.data)&&(d=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(d=h.data),d!=null&&o(d)},u=h=>{c(h.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of i)yield P9(o)?new Uint8Array(o):o}();let n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},yee=(r,e)=>{e=e??{};const t=gee(r);let n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:hee(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}},mee=WebSocket,wee={"http:":"ws:","https:":"wss:"},D9="ws:",bee=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??D9}${r}`),r.startsWith("/")&&e!=null){const n=e.protocol??D9,s=e.host,i=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${s}${i}${r}`}const t=new URL(r);for(const[n,s]of Object.entries(wee))t.protocol===n&&(t.protocol=s);return t};function vee(r,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const n=bee(r,t),s=new mee(n.toString(),e.websocket);return yee(s,e)}function nC(r){return r.filter(e=>qp.exactMatch(e)||Rd.exactMatch(e))}function Eee(){throw new Error("WebSocket Servers can not be created in the browser!")}const See=500;function _ee(r,e,t){const n=t.logger.forComponent("libp2p:websockets:maconn"),s=t.metrics,i=t.metricPrefix??"",o={log:n,async sink(a){try{await r.sink(async function*(){for await(const c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){const c=Date.now();if(a.signal==null){const u=AbortSignal.timeout(See);a={...a,signal:u}}const l=()=>{const{host:u,port:h}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",u,h,Date.now()-c),this.abort(new qi("Socket close timeout"))};a.signal?.addEventListener("abort",l);try{await r.close()}catch(u){n.error("error closing WebSocket gracefully",u),this.abort(u)}finally{a.signal?.removeEventListener("abort",l),o.timeline.close=Date.now()}},abort(a){const{host:c,port:l}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),o.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return r.socket.addEventListener("close",()=>{s?.increment({[`${i}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}class xee{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[ug]=!0;[Symbol.toStringTag]="@libp2p/websockets";[lr]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=await this._connect(e,t),s=_ee(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const s=Qe(),i=vee(kw(e),this.init);i.socket.addEventListener("error",()=>{const o=new fS(`Could not connect to ${e.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),s.reject(o)});try{t.onProgress?.(new xe("websockets:open-connection")),await Et(Promise.race([i.connected(),s.promise]),t.signal)}catch(o){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return Eee({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):nC(e)}dialFilter(e){return this.listenFilter(e)}}function sC(r={}){return e=>new xee(e,r)}function Aee(r,e){const t=e.map((n,s)=>({record:If(n),index:s}));return t.sort((n,s)=>{const i=n.record.sequence,o=s.record.sequence;if(i>o)return-1;if(i<o)return 1;if(n.record.validityType===Ps.ValidityType.EOL&&s.record.validityType===Ps.ValidityType.EOL){const a=n3.fromString(n.record.validity).toDate(),c=n3.fromString(s.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const Iee="5.4.2",kee="helia",Tee={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function Cee(r={}){const e=`${kee}/${Iee} ${aA()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[$k(),tC(),lee(),sC()],connectionEncrypters:[zw()],streamMuxers:[Ak(),SX()],peerDiscovery:[Nk(Tee)],services:{autoNAT:kk(),dcutr:Uk(),delegatedRouting:()=>bz("https://delegated-ipfs.dev",vz()),dht:sX({clientMode:!0,validators:{ipns:iI},selectors:{ipns:Aee}}),identify:Kk(),identifyPush:kQ(),keychain:ak(r.keychain),ping:Qk()}}}async function Pee(r){const e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await yj(r.datastore,r.keychain));const t=Cee(e);return t.datastore=t.datastore??r.datastore,await cA({...t,...e,start:!1})}async function Dee(r={}){const e=r.datastore??new Ox,t=r.blockstore??new Wz;let n;return Ree(r.libp2p)?n=r.libp2p:n=await Pee({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[ZH(),MH()],routers:r.routers??[zz(n),qz()],metrics:n.metrics,start:r.start??!0}}function Ree(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}async function Oee(r={}){const e=await Dee(r),t=new rH(e);return r.start!==!1&&await t.start(),t}var O5={exports:{}},jl=typeof Reflect=="object"?Reflect:null,R9=jl&&typeof jl.apply=="function"?jl.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},op;jl&&typeof jl.ownKeys=="function"?op=jl.ownKeys:Object.getOwnPropertySymbols?op=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:op=function(e){return Object.getOwnPropertyNames(e)};function Nee(r){console&&console.warn&&console.warn(r)}var iC=Number.isNaN||function(e){return e!==e};function bt(){bt.init.call(this)}O5.exports=bt;O5.exports.once=$ee;bt.EventEmitter=bt;bt.prototype._events=void 0;bt.prototype._eventsCount=0;bt.prototype._maxListeners=void 0;var O9=10;function M2(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(bt,"defaultMaxListeners",{enumerable:!0,get:function(){return O9},set:function(r){if(typeof r!="number"||r<0||iC(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");O9=r}});bt.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};bt.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||iC(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function oC(r){return r._maxListeners===void 0?bt.defaultMaxListeners:r._maxListeners}bt.prototype.getMaxListeners=function(){return oC(this)};bt.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s=e==="error",i=this._events;if(i!==void 0)s=s&&i.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[e];if(c===void 0)return!1;if(typeof c=="function")R9(c,this,t);else for(var l=c.length,u=hC(c,l),n=0;n<l;++n)R9(u[n],this,t);return!0};function aC(r,e,t,n){var s,i,o;if(M2(t),i=r._events,i===void 0?(i=r._events=Object.create(null),r._eventsCount=0):(i.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),i=r._events),o=i[e]),o===void 0)o=i[e]=t,++r._eventsCount;else if(typeof o=="function"?o=i[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),s=oC(r),s>0&&o.length>s&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,Nee(a)}return r}bt.prototype.addListener=function(e,t){return aC(this,e,t,!1)};bt.prototype.on=bt.prototype.addListener;bt.prototype.prependListener=function(e,t){return aC(this,e,t,!0)};function Mee(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function cC(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},s=Mee.bind(n);return s.listener=t,n.wrapFn=s,s}bt.prototype.once=function(e,t){return M2(t),this.on(e,cC(this,e,t)),this};bt.prototype.prependOnceListener=function(e,t){return M2(t),this.prependListener(e,cC(this,e,t)),this};bt.prototype.removeListener=function(e,t){var n,s,i,o,a;if(M2(t),s=this._events,s===void 0)return this;if(n=s[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;i===0?n.shift():Bee(n,i),n.length===1&&(s[e]=n[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};bt.prototype.off=bt.prototype.removeListener;bt.prototype.removeAllListeners=function(e){var t,n,s;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var i=Object.keys(n),o;for(s=0;s<i.length;++s)o=i[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function lC(r,e,t){var n=r._events;if(n===void 0)return[];var s=n[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?Lee(s):hC(s,s.length)}bt.prototype.listeners=function(e){return lC(this,e,!0)};bt.prototype.rawListeners=function(e){return lC(this,e,!1)};bt.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):uC.call(r,e)};bt.prototype.listenerCount=uC;function uC(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}bt.prototype.eventNames=function(){return this._eventsCount>0?op(this._events):[]};function hC(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function Bee(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function Lee(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function $ee(r,e){return new Promise(function(t,n){function s(o){r.removeListener(e,i),n(o)}function i(){typeof r.removeListener=="function"&&r.removeListener("error",s),t([].slice.call(arguments))}dC(r,e,i,{once:!0}),e!=="error"&&Uee(r,s,{once:!0})})}function Uee(r,e,t){typeof r.on=="function"&&dC(r,"error",e,t)}function dC(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function s(i){n.once&&r.removeEventListener(e,s),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var B2=O5.exports,Fee=function(){return Date.now()};const M1=Fee;class Vee{constructor(e,t,n){const s=this;this._started=M1(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(M1()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=M1();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=M1(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function Kee(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new Vee(arguments[0],arguments[1],r)}var qee=Kee;const{AbortController:Hee}=globalThis,N9=qee;class N5 extends Hee{constructor(e){super(),this._ms=e,this._timer=N9(()=>this.abort(),e),Object.setPrototypeOf(this,N5.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=N9(()=>this.abort(),this._ms)}}var q4={TimeoutController:N5};const Ko=(...r)=>r.join("/").replace(/((?<=\/)\/+)|(^\.\/)|((?<=\/)\.\/)/g,"")||".";var H4={exports:{}};typeof Object.create=="function"?H4.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:H4.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}};var zee=H4.exports,fC=B2,Wee=zee,jee=Mn;function Mn(r){if(!(this instanceof Mn))return new Mn(r);typeof r=="number"&&(r={max:r}),r||(r={}),fC.EventEmitter.call(this),this.cache={},this.head=this.tail=null,this.length=0,this.max=r.max||1e3,this.maxAge=r.maxAge||0}Wee(Mn,fC.EventEmitter);Object.defineProperty(Mn.prototype,"keys",{get:function(){return Object.keys(this.cache)}});Mn.prototype.clear=function(){this.cache={},this.head=this.tail=null,this.length=0};Mn.prototype.remove=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];return delete this.cache[r],this._unlink(r,e.prev,e.next),e.value}};Mn.prototype._unlink=function(r,e,t){this.length--,this.length===0?this.head=this.tail=null:this.head===r?(this.head=e,this.cache[this.head].next=null):this.tail===r?(this.tail=t,this.cache[this.tail].prev=null):(this.cache[e].next=t,this.cache[t].prev=e)};Mn.prototype.peek=function(r){if(this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return e.value}};Mn.prototype.set=function(r,e){typeof r!="string"&&(r=""+r);var t;if(this.cache.hasOwnProperty(r)){if(t=this.cache[r],t.value=e,this.maxAge&&(t.modified=Date.now()),r===this.head)return e;this._unlink(r,t.prev,t.next)}else t={value:e,modified:0,next:null,prev:null},this.maxAge&&(t.modified=Date.now()),this.cache[r]=t,this.length===this.max&&this.evict();return this.length++,t.next=null,t.prev=this.head,this.head&&(this.cache[this.head].next=r),this.head=r,this.tail||(this.tail=r),e};Mn.prototype._checkAge=function(r,e){return this.maxAge&&Date.now()-e.modified>this.maxAge?(this.remove(r),this.emit("evict",{key:r,value:e.value}),!1):!0};Mn.prototype.get=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return this.head!==r&&(r===this.tail?(this.tail=e.next,this.cache[this.tail].prev=null):this.cache[e.prev].next=e.next,this.cache[e.next].prev=e.prev,this.cache[this.head].next=r,e.prev=this.head,e.next=null,this.head=r),e.value}};Mn.prototype.evict=function(){if(this.tail){var r=this.tail,e=this.remove(this.tail);this.emit("evict",{key:r,value:e})}};const z4=Mc(jee),Gee=(r,e)=>{const t=r.time-e.time;return t===0&&r.id!==e.id?r.id<e.id?-1:1:t},Qee=r=>M5(r.id,++r.time),M5=(r,e)=>(e=e||0,{id:r,time:e}),Yee=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},B5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};function Xee(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var w=0,m=0,_=0,k=y.length;_!==k&&y[_]===0;)_++,w++;for(var N=(k-_)*u+1>>>0,I=new Uint8Array(N);_!==k;){for(var T=y[_],x=0,D=N-1;(T!==0||x<m)&&D!==-1;D--,x++)T+=256*I[D]>>>0,I[D]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");m=x,_++}for(var F=N-m;F!==N&&I[F]===0;)F++;for(var R=c.repeat(w);F<N;++F)R+=r.charAt(I[F]);return R}function d(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var w=0;if(y[w]!==" "){for(var m=0,_=0;y[w]===c;)m++,w++;for(var k=(y.length-w)*l+1>>>0,N=new Uint8Array(k);y[w];){var I=t[y.charCodeAt(w)];if(I===255)return;for(var T=0,x=k-1;(I!==0||T<_)&&x!==-1;x--,T++)I+=a*N[x]>>>0,N[x]=I%256>>>0,I=I/256>>>0;if(I!==0)throw new Error("Non-zero carry");_=T,w++}if(y[w]!==" "){for(var D=k-_;D!==k&&N[D]===0;)D++;for(var F=new Uint8Array(m+(k-D)),R=m;D!==k;)F[R++]=N[D++];return F}}}function g(y){var w=d(y);if(w)return w;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:d,decode:g}}var Zee=Xee,Jee=Zee;class ete{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class tte{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return pC(this,e)}}class rte{constructor(e){this.decoders=e}or(e){return pC(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const pC=(r,e)=>new rte({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class nte{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new ete(e,t,n),this.decoder=new tte(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const gC=({name:r,prefix:e,encode:t,decode:n})=>new nte(r,e,t,n),yC=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Jee(t,e);return gC({prefix:r,name:e,encode:n,decode:i=>B5(s(i))})},ste=(r,e,t,n)=>{const s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,l=0;for(let u=0;u<i;++u){const h=s[r[u]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},ite=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ao=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>gC({prefix:e,name:r,encode(s){return ite(s,n,t)},decode(s){return ste(s,n,t,r)}}),ap=ao({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ao({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ao({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ao({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ao({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ao({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ao({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ao({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ao({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Mr=yC({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});yC({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var ote=mC,M9=128,ate=-128,cte=Math.pow(2,31);function mC(r,e,t){e=e||[],t=t||0;for(var n=t;r>=cte;)e[t++]=r&255|M9,r/=128;for(;r&ate;)e[t++]=r&255|M9,r>>>=7;return e[t]=r|0,mC.bytes=t-n+1,e}var lte=W4,ute=128,B9=127;function W4(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw W4.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&B9)<<s:(o&B9)*Math.pow(2,s),s+=7}while(o>=ute);return W4.bytes=i-n,t}var hte=Math.pow(2,7),dte=Math.pow(2,14),fte=Math.pow(2,21),pte=Math.pow(2,28),gte=Math.pow(2,35),yte=Math.pow(2,42),mte=Math.pow(2,49),wte=Math.pow(2,56),bte=Math.pow(2,63),vte=function(r){return r<hte?1:r<dte?2:r<fte?3:r<pte?4:r<gte?5:r<yte?6:r<mte?7:r<wte?8:r<bte?9:10},Ete={encode:ote,decode:lte,encodingLength:vte},Q0=Ete;const j4=(r,e=0)=>[Q0.decode(r,e),Q0.decode.bytes],Y0=(r,e,t=0)=>(Q0.encode(r,e,t),e),X0=r=>Q0.encodingLength(r),G4=(r,e)=>{const t=e.byteLength,n=X0(r),s=n+X0(t),i=new Uint8Array(s+t);return Y0(r,i,0),Y0(t,i,n),i.set(e,s),new L5(r,t,e,i)},Ste=r=>{const e=B5(r),[t,n]=j4(e),[s,i]=j4(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new L5(t,s,o,e)},_te=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Yee(r.bytes,t.bytes)}};class L5{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}const L9=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Ate(t,Q4(r),e||Mr.encoder);default:return Ite(t,Q4(r),e||ap.encoder)}},$9=new WeakMap,Q4=r=>{const e=$9.get(r);if(e==null){const t=new Map;return $9.set(r,t),t}return e};class mt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ah)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==kte)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return mt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=G4(e,t);return mt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return mt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&_te(e.multihash,n.multihash)}toString(e){return L9(this,e)}toJSON(){return{"/":L9(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof mt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new mt(n,s,i,o||U9(n,s,i.bytes))}else if(t[Tte]===!0){const{version:n,multihash:s,code:i}=t,o=Ste(s);return mt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ah)throw new Error(`Version 0 CID must use dag-pb (code: ${Ah}) block encoding`);return new mt(e,t,n,n.bytes)}case 1:{const s=U9(e,t,n.bytes);return new mt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return mt.create(0,Ah,e)}static createV1(e,t){return mt.create(1,e,t)}static decode(e){const[t,n]=mt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=mt.inspectBytes(e),n=t.size-t.multihashSize,s=B5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new L5(t.multihashCode,t.digestSize,i,s);return[t.version===0?mt.createV0(o):mt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,d]=j4(e.subarray(t));return t+=d,h};let s=n(),i=Ah;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){const[n,s]=xte(e,t),i=mt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Q4(i).set(n,e),i}}const xte=(r,e)=>{switch(r[0]){case"Q":{const t=e||Mr;return[Mr.prefix,t.decode(`${Mr.prefix}${r}`)]}case Mr.prefix:{const t=e||Mr;return[Mr.prefix,t.decode(r)]}case ap.prefix:{const t=e||ap;return[ap.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Ate=(r,e,t)=>{const{prefix:n}=t;if(n!==Mr.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Ite=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ah=112,kte=18,U9=(r,e,t)=>{const n=X0(r),s=n+X0(e),i=new Uint8Array(s+t.byteLength);return Y0(r,i,0),Y0(e,i,n),i.set(t,s),i},Tte=Symbol.for("@ipld/js-cid/CID"),Cte=({name:r,code:e,encode:t})=>new Pte(r,e,t);class Pte{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?G4(this.code,t):t.then(n=>G4(this.code,n))}else throw Error("Unknown type, must be binary type")}}function B1({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*Dte(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=mt.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*Y4(n,s))}else{const t=mt.asCID(e);t?yield[r.join("/"),t]:yield*Y4(e,r)}}function*Y4(r,e){if(r==null||r instanceof Uint8Array)return;const t=mt.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*Dte(i,s)}}function*Rte(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!mt.asCID(n)&&(yield*X4(n,s))}else yield*X4(e,r)}function*X4(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!mt.asCID(n)&&(yield*Rte(s,n))}}function Ote(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=mt.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}class wC{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:B1(),bytes:B1(),value:B1(),asBlock:B1()})}links(){return Y4(this.value,[])}tree(){return X4(this.value,[])}get(e="/"){return Ote(this.value,e.split("/").filter(Boolean))}}async function aa({value:r,codec:e,hasher:t}){if(typeof r>"u")throw new Error('Missing required argument "value"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.encode(r),s=await t.digest(n),i=mt.create(1,e.code,s);return new wC({value:r,bytes:n,cid:i})}async function Gl({bytes:r,codec:e,hasher:t}){if(!r)throw new Error('Missing required argument "bytes"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.decode(r),s=await t.digest(r),i=mt.create(1,e.code,s);return new wC({value:n,bytes:r,cid:i})}const Nte=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),L2=Cte({name:"sha2-256",code:18,encode:Nte("SHA-256")}),qo=_f,Ho=L2,bC=Mr,Mte=async(r,e,t,n,s=null,i=[],o=[])=>{if(r==null)throw new Error("Identity is required, cannot create entry");if(e==null)throw new Error("Entry requires an id");if(t==null)throw new Error("Entry requires a payload");if(i==null||!Array.isArray(i))throw new Error("'next' argument is not an array");s=s||M5(r.publicKey);let a;if(n){const{bytes:h}=await aa({value:t,codec:qo,hasher:Ho});a=await n(h)}const c={id:e,payload:a||t,next:i,refs:o,clock:s,v:2},{bytes:l}=await aa({value:c,codec:qo,hasher:Ho}),u=await r.sign(r,l);return c.key=r.publicKey,c.identity=r.hash,c.sig=u,c.payload=t,n&&(c._payload=a),c},Bte=async(r,e)=>{if(!r)throw new Error("Identities is required, cannot verify entry");if(!vC(e))throw new Error("Invalid Log entry");if(!e.key)throw new Error("Entry doesn't have a key");if(!e.sig)throw new Error("Entry doesn't have a signature");const t=Object.assign({},e),n={id:t.id,payload:t._payload||t.payload,next:t.next,refs:t.refs,clock:t.clock,v:t.v},{bytes:s}=await aa({value:n,codec:qo,hasher:Ho});return r.verify(e.sig,e.key,s)},vC=r=>r&&r.id!==void 0&&r.next!==void 0&&r.payload!==void 0&&r.v!==void 0&&r.clock!==void 0&&r.refs!==void 0,Lte=(r,e)=>r&&e&&r.hash&&r.hash===e.hash,$te=async(r,e,t)=>{let n;if(e)try{const a=await Gl({bytes:r,codec:qo,hasher:Ho});r=await e(a.value),n=a.cid}catch{throw new Error("Could not decrypt entry")}const s=await Gl({bytes:r,codec:qo,hasher:Ho}),i=s.value;if(t)try{const a=await t(i.payload),{value:c}=await Gl({bytes:a,codec:qo,hasher:Ho});i._payload=i.payload,i.payload=c}catch{throw new Error("Could not decrypt payload")}n=n||s.cid;const o=n.toString(bC);return{...i,hash:o}},Ute=async(r,e,t)=>{const n=Object.assign({},r);t&&(n.payload=n._payload),delete n._payload,delete n.hash;let{cid:s,bytes:i}=await aa({value:n,codec:qo,hasher:Ho});if(e){i=await e(i);const a=await aa({value:i,codec:qo,hasher:Ho});s=a.cid,i=a.bytes}return{hash:s.toString(bC),bytes:i}},Zs={create:Mte,verify:Bte,decode:$te,encode:Ute,isEntry:vC,isEqual:Lte};function Fte(r,e){const t=(i,o)=>i,n=(i,o)=>Kte(i,o,t);return((i,o)=>Vte(i,o,n))(r,e)}function Vte(r,e,t){const n=Gee(r.clock,e.clock);return n===0?t(r,e):n}function Kte(r,e,t){return r.clock.id===e.clock.id?t(r,e):r.clock.id<e.clock.id?-1:1}function qte(r){const e=`Your log's tiebreaker function, ${r.name}, has returned zero and therefore cannot be`;return(n,s)=>{const i=r(n,s);if(i===0)throw Error(e);return i}}const Hte={LastWriteWins:Fte,NoZeroes:qte},$5=async()=>{let r={};const e=async(c,l)=>{r[c]=l};return{put:e,del:async c=>{delete r[c]},get:async c=>r[c],iterator:async function*(){for await(const[c,l]of Object.entries(r))yield[c,l]},merge:async c=>{if(c)for await(const[l,u]of c.iterator())e(l,u)},clear:async()=>{r={}},close:async()=>{}}},zte=$5,Wte=async({storage:r,heads:e,decryptPayloadFn:t,decryptEntryFn:n})=>{r=r||await zte();const s=new TextEncoder,i=new TextDecoder,o=async g=>{g=F9(g);const y=g.map(m=>({hash:m.hash,next:m.next})),w=s.encode(JSON.stringify(y));await r.put("heads",w)},a=async g=>{const y=await u();if(y.find(m=>Zs.isEqual(m,g)))return;const w=F9([...y,g]);return await o(w),w},c=async g=>{const w=(await u()).filter(m=>m.hash!==g);await o(w)},l=async function*(){const g=await r.get("heads"),y=g?JSON.parse(i.decode(g)):[];for(const w of y)yield w},u=async()=>{const g=[];for await(const y of l())g.push(y);return g},h=async()=>{await r.clear()},d=async()=>{await r.close()};return e&&await o(e),{put:o,set:o,add:a,remove:c,iterator:l,all:u,clear:h,close:d}},F9=r=>{r=new Set(r);const e={};for(const n of r)for(const s of n.next)e[s]=n.hash;const t=[];for(const n of r)e[n.hash]||t.push(n);return t},Zy=$5,jte=async({logHeads:r,entryStorage:e,headsStorage:t,indexStorage:n,encryption:s})=>{const i=s?.replication?.encrypt,o=s?.replication?.decrypt,a=s?.data?.encrypt,c=s?.data?.decrypt,l=e||await Zy(),u=n||await Zy();t=t||await Zy();const h=await Wte({storage:t,heads:r,decryptPayloadFn:c,decryptEntryFn:o}),d=async x=>{const D=await l.get(x);if(D)return await Zs.decode(D,o,c)};return{get:d,getBytes:async x=>l.get(x),has:async x=>await u.get(x)!=null,heads:async()=>{const x=[];for(const{hash:D}of await h.all()){const F=await d(D);x.push(F)}return x},setHead:async x=>{const{hash:D,bytes:F}=await Zs.encode(x,i,a);return await l.put(D,F),await u.put(D,!0),await h.set([{hash:D,next:x.next}]),D},addHead:async x=>(await h.add(x),x.hash),removeHeads:async x=>{for(const D of x)await h.remove(D)},addVerified:async x=>{for(const D of x)await u.put(D,!0),l.persist&&await l.persist(D)},storage:l,clear:async()=>{await u.clear(),await h.clear(),await l.clear()},close:async()=>{await u.close(),await h.close(),await l.close()}}},{LastWriteWins:Gte,NoZeroes:Qte}=Hte,Yte=()=>new Date().getTime().toString(),Xte=(r,e)=>Math.max(r,e.clock.time),Zte=async()=>({canAppend:async r=>!0}),Jte=async(r,{logId:e,logHeads:t,access:n,entryStorage:s,headsStorage:i,indexStorage:o,sortFn:a,encryption:c}={})=>{if(r==null)throw new Error("Identity is required");if(t!=null&&!Array.isArray(t))throw new Error("'logHeads' argument must be an array");const l=e||Yte();c=c||{};const u=c.data?.encrypt;n=n||await Zte();const h=await jte({logHeads:t,entryStorage:s,indexStorage:o,headsStorage:i,encryption:c});a=Qte(a||Gte);const d=new ru({concurrency:1}),g=new ru({concurrency:1}),y=async()=>{const P=Math.max(0,(await w()).reduce(Xte,0));return M5(r.publicKey,P)},w=async()=>(await h.heads()).sort(a).reverse(),m=async()=>{const P=[];for await(const M of x())P.unshift(M);return P},_=async P=>{if(!P)throw new Error("hash is required");return h.get(P)},k=async P=>h.has(P),N=async(P,M={referencesCount:0})=>{const K=async()=>{const H=await w(),$=H.map(X=>X.hash),L=await O(H,M.referencesCount+H.length),z=await Zs.create(r,l,P,u,Qee(await y()),$,L);if(!await n.canAppend(z))throw new Error(`Could not append entry:
Key "${r.hash}" is not allowed to write to the log`);const Y=await h.setHead(z);return{...z,hash:Y}};return d.add(K)},I=async P=>{if(!P)throw new Error("Log instance not defined");if(!C(P))throw new Error("Given argument is not an instance of Log");await h.storage.merge(P.storage);const M=await P.heads();for(const K of M)await T(K)},T=async P=>{const M=async()=>{if(await k(P.hash))return!1;const H=async X=>{if(X.id!==l)throw new Error(`Entry's id (${X.id}) doesn't match the log's id (${l}).`);if(!await n.canAppend(X))throw new Error(`Could not append entry:
Key "${X.identity}" is not allowed to write to the log`);if(!await Zs.verify(r,X))throw new Error(`Could not validate signature for entry "${X.hash}"`)};await H(P);const $=(await w()).map(X=>X.hash),L=new Set([P.hash]),z=new Set([...P.next,...P.refs]),q=new Set,Y=async()=>{const X=Array.from(z.values()).filter(k).map(_),j=await Promise.all(X);for(const me of j){z.delete(me.hash),await H(me),L.add(me.hash);for(const de of[...me.next,...me.refs])!await k(de)&&!L.has(de)?z.add(de):$.includes(de)&&q.add(de)}z.size>0&&await Y()};return await Y(),await h.addVerified(L.values()),await h.removeHeads(q.values()),await h.addHead(P),!0};return g.add(M)},x=async function*(P,M){M=M||(()=>!1),P=P||await w();let H=P.sort(a);const $={};let L=[];const z={},q=X=>!($[X]||z[X]);let Y;for(;H.length>0;)if(H=H.sort(a),Y=H.pop(),Y){const{hash:X,next:j}=Y;if(!$[X]){if(yield Y,await M(Y)===!0)break;$[X]=!0,z[X]=!0,L=[...L,...j].filter(q);const de=J=>{if(!$[J]&&!z[J])return z[J]=!0,_(J)},Q=await Promise.all(L.map(de));L=Q.filter(J=>J!=null).reduce((J,ge)=>Array.from(new Set([...J,...ge.next])),[]).filter(q),H=[...Q,...H]}}},D=async function*({amount:P=-1,gt:M,gte:K,lt:H,lte:$}={}){if(P===0)return;if(typeof $=="string"&&($=[await _($)]),typeof H=="string"){const J=await _(H);H=await Promise.all(J.next.map(ke=>_(ke)))}if(H!=null&&!Array.isArray(H))throw new Error("lt must be a string or an array of Entries");if($!=null&&!Array.isArray($))throw new Error("lte must be a string or an array of Entries");const L=(H||$||await w()).filter(J=>J!=null),z=M||K?await _(M||K):null,q=z||P===-1?-1:P;let Y=0;const X=async J=>(Y++,J?!!(Y>=q&&q!==-1||z&&Zs.isEqual(J,z)):!1),j=z&&P!==-1&&!H&&!$,me=j?new z4(P+2):null;let de=0;const Q=x(L,X);for await(const J of Q){const ge=H&&Zs.isEqual(J,L),ke=M&&Zs.isEqual(J,z);ge||ke||(j?me.set(de++,J.hash):yield J)}if(j){const J=me.keys.length,ge=J>P?J-P:0,ke=me.keys.slice(ge,J);for(const Ue of ke){const Ke=me.get(Ue);yield await _(Ke)}}},F=async()=>{await d.clear(),await g.clear(),await h.clear()},R=async()=>{await d.onIdle(),await g.onIdle(),await h.close()},C=P=>P&&P.id!==void 0&&P.clock!==void 0&&P.heads!==void 0&&P.values!==void 0&&P.access!==void 0&&P.identity!==void 0&&P.storage!==void 0,O=async(P,M=0)=>{let K=[];const H=async $=>K.length>=M&&M!==-1;for await(const{hash:$}of x(P,H))K.push($);return K=K.slice(P.length+1,M),K};return{id:l,clock:y,heads:w,values:m,all:m,get:_,has:k,append:N,join:I,joinEntry:T,traverse:x,iterator:D,clear:F,close:R,access:n,identity:r,storage:h.storage,encryption:c}},ere=3e4,tre=async({ipfs:r,log:e,events:t,onSynced:n,start:s,timeout:i})=>{if(!r)throw new Error("An instance of ipfs is required.");if(!e)throw new Error("An instance of log is required.");const o=r.libp2p,a=r.libp2p.services.pubsub,c=e.id,l=Ko("/orbitdb/heads/",c),u=new ru({concurrency:1}),h=new Set;t=t||new B2.EventEmitter,i??=ere;let d=!1;const g=async D=>{const F=await e.heads();t.emit("join",D,F)},y=D=>async function*(){const F=await e.heads();for await(const{hash:R}of F)yield await e.storage.get(R)}(),w=D=>async F=>{for await(const R of F){const C=R.subarray();if(C&&n){const O=await Zs.decode(C,e.encryption.replication?.decrypt,e.encryption.data?.decrypt);await n(O)}}d&&await g(D)},m=async({connection:D,stream:F})=>{const R=String(D.remotePeer);try{h.add(R),await Nn(F,w(R),y,F)}catch(C){h.delete(R),t.emit("error",C)}},_=async D=>{const F=async()=>{const{peerId:R,subscriptions:C}=D.detail,O=String(R),P=C.find(M=>M.topic===c);if(P)if(P.subscribe){if(h.has(O))return;const M=new q4.TimeoutController(i),{signal:K}=M;try{h.add(O);const H=await o.dialProtocol(R,l,{signal:K});await Nn(y,H,w(O))}catch(H){h.delete(O),H.name==="UnsupportedProtocolError"||t.emit("error",H)}finally{M&&M.clear()}}else h.delete(O),t.emit("leave",O)};u.add(F)},k=async D=>{const{topic:F,data:R}=D.detail,C=async()=>{try{if(R&&n){const O=await Zs.decode(R,e.encryption.replication?.decrypt,e.encryption.data?.decrypt);await n(O)}}catch(O){t.emit("error",O)}};F===c&&u.add(C)},N=async D=>{h.delete(D.detail.toString())},I=async D=>{if(d&&D&&D.hash){const F=await e.storage.get(D.hash);await a.publish(c,F)}},T=async()=>{d&&(d=!1,await u.clear(),a.removeEventListener("subscription-change",_),a.removeEventListener("message",k),await o.unhandle(l),await a.unsubscribe(c),o.removeEventListener("peer:disconnect",N),h.clear())},x=async()=>{d||(a.addEventListener("subscription-change",_),a.addEventListener("message",k),await a.subscribe(c),await o.handle(l,m),o.addEventListener("peer:disconnect",N),d=!0)};return s!==!1&&await x(),{add:I,stop:T,start:x,events:t,peers:h}},ic=async(r,e)=>({put:async(u,h)=>{await r.put(u,h),await e.put(u,h)},get:async u=>{let h=await r.get(u);return h||(h=await e.get(u),h&&await r.put(u,h)),h},del:async u=>{await r.del(u),await e.del(u)},persist:async u=>{r.persist&&await r.persist(u),e.persist&&await e.persist(u)},iterator:async function*({amount:u,reverse:h}={}){const d=[],g={amount:u||-1,reverse:h||!1};for(const y of[r,e])for await(const[w,m]of y.iterator(g))d[w]||(d[w]=!0,yield[w,m])},merge:async u=>{await r.merge(u),await e.merge(u),await u.merge(r),await u.merge(e)},clear:async()=>{await r.clear(),await e.clear()},close:async()=>{await r.close(),await e.close()}}),V9=3e4,$2=async({ipfs:r,pin:e,timeout:t}={})=>{if(!r)throw new Error("An instance of ipfs is required.");const n=new Set,s=async(d,g)=>{const y=mt.parse(d,Mr),{signal:w}=new q4.TimeoutController(t||V9);await r.blockstore.put(y,g,{signal:w}),await a(d)},i=async d=>{},o=async d=>{const g=mt.parse(d,Mr),y=new q4.TimeoutController(t||V9);n.add(y);const w=await r.blockstore.get(g,{signal:y.signal});if(n.delete(y),w)return w},a=async d=>{const g=mt.parse(d,Mr);e&&!await r.pins.isPinned(g)&&await ji(r.pins.add(g))};return{put:s,del:i,get:o,persist:a,iterator:async function*(){},merge:async d=>{},clear:async()=>{},close:async()=>{for(const d in n)d.abort();n.clear()}}};var EC={},pa={},U2={},SC={};SC.supports=function(...e){const t=e.reduce((n,s)=>Object.assign(n,s),{});return Object.assign(t,{snapshots:t.snapshots||!1,permanence:t.permanence||!1,seek:t.seek||!1,clear:t.clear||!1,getMany:t.getMany||!1,keyIterator:t.keyIterator||!1,valueIterator:t.valueIterator||!1,iteratorNextv:t.iteratorNextv||!1,iteratorAll:t.iteratorAll||!1,status:t.status||!1,createIfMissing:t.createIfMissing||!1,errorIfExists:t.errorIfExists||!1,deferredOpen:t.deferredOpen||!1,promises:t.promises||!1,streams:t.streams||!1,encodings:Object.assign({},t.encodings),events:Object.assign({},t.events),additionalMethods:Object.assign({},t.additionalMethods)})};var _C={},pi=class extends Error{constructor(e,t){super(e||""),typeof t=="object"&&t!==null&&(t.code&&(this.code=String(t.code)),t.expected&&(this.expected=!0),t.transient&&(this.transient=!0),t.cause&&(this.cause=t.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},Gc={};const U5=hB(BW);let Jy=null;var xC=function(){return Jy===null&&(Jy={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),Jy},jf={},F5={};const em=pi,rre=new Set(["buffer","view","utf8"]);let nre=class{constructor(e){if(this.encode=e.encode||this.encode,this.decode=e.decode||this.decode,this.name=e.name||this.name,this.format=e.format||this.format,typeof this.encode!="function")throw new TypeError("The 'encode' property must be a function");if(typeof this.decode!="function")throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),typeof this.name!="string"||this.name==="")throw new TypeError("The 'name' property must be a string");if(typeof this.format!="string"||!rre.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");e.createViewTranscoder&&(this.createViewTranscoder=e.createViewTranscoder),e.createBufferTranscoder&&(this.createBufferTranscoder=e.createBufferTranscoder),e.createUTF8Transcoder&&(this.createUTF8Transcoder=e.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new em(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new em(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new em(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}};F5.Encoding=nre;const{Buffer:V5}=U5||{},{Encoding:K5}=F5,sre=xC;let q5=class extends K5{constructor(e){super({...e,format:"buffer"})}createViewTranscoder(){return new H5({encode:this.encode,decode:e=>this.decode(V5.from(e.buffer,e.byteOffset,e.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}},H5=class extends K5{constructor(e){super({...e,format:"view"})}createBufferTranscoder(){return new q5({encode:e=>{const t=this.encode(e);return V5.from(t.buffer,t.byteOffset,t.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}},ire=class extends K5{constructor(e){super({...e,format:"utf8"})}createBufferTranscoder(){return new q5({encode:e=>V5.from(this.encode(e),"utf8"),decode:e=>this.decode(e.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:e,textDecoder:t}=sre();return new H5({encode:n=>e.encode(this.encode(n)),decode:n=>this.decode(t.decode(n)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}};jf.BufferFormat=q5;jf.ViewFormat=H5;jf.UTF8Format=ire;const{Buffer:Br}=U5||{Buffer:{isBuffer:()=>!1}},{textEncoder:AC,textDecoder:K9}=xC(),{BufferFormat:Gf,ViewFormat:z5,UTF8Format:IC}=jf,Z0=r=>r;Gc.utf8=new IC({encode:function(r){return Br.isBuffer(r)?r.toString("utf8"):ArrayBuffer.isView(r)?K9.decode(r):String(r)},decode:Z0,name:"utf8",createViewTranscoder(){return new z5({encode:function(r){return ArrayBuffer.isView(r)?r:AC.encode(r)},decode:function(r){return K9.decode(r)},name:`${this.name}+view`})},createBufferTranscoder(){return new Gf({encode:function(r){return Br.isBuffer(r)?r:ArrayBuffer.isView(r)?Br.from(r.buffer,r.byteOffset,r.byteLength):Br.from(String(r),"utf8")},decode:function(r){return r.toString("utf8")},name:`${this.name}+buffer`})}});Gc.json=new IC({encode:JSON.stringify,decode:JSON.parse,name:"json"});Gc.buffer=new Gf({encode:function(r){return Br.isBuffer(r)?r:ArrayBuffer.isView(r)?Br.from(r.buffer,r.byteOffset,r.byteLength):Br.from(String(r),"utf8")},decode:Z0,name:"buffer",createViewTranscoder(){return new z5({encode:function(r){return ArrayBuffer.isView(r)?r:Br.from(String(r),"utf8")},decode:function(r){return Br.from(r.buffer,r.byteOffset,r.byteLength)},name:`${this.name}+view`})}});Gc.view=new z5({encode:function(r){return ArrayBuffer.isView(r)?r:AC.encode(r)},decode:Z0,name:"view",createBufferTranscoder(){return new Gf({encode:function(r){return Br.isBuffer(r)?r:ArrayBuffer.isView(r)?Br.from(r.buffer,r.byteOffset,r.byteLength):Br.from(String(r),"utf8")},decode:Z0,name:`${this.name}+buffer`})}});Gc.hex=new Gf({encode:function(r){return Br.isBuffer(r)?r:Br.from(String(r),"hex")},decode:function(r){return r.toString("hex")},name:"hex"});Gc.base64=new Gf({encode:function(r){return Br.isBuffer(r)?r:Br.from(String(r),"base64")},decode:function(r){return r.toString("base64")},name:"base64"});const q9=pi,J0=Gc,{Encoding:ore}=F5,{BufferFormat:are,ViewFormat:cre,UTF8Format:lre}=jf,Ih=Symbol("formats"),L1=Symbol("encodings"),ure=new Set(["buffer","view","utf8"]);let hre=class{constructor(e){if(Array.isArray(e)){if(!e.every(t=>ure.has(t)))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}else throw new TypeError("The first argument 'formats' must be an array");this[L1]=new Map,this[Ih]=new Set(e);for(const t in J0)try{this.encoding(t)}catch(n){if(n.code!=="LEVEL_ENCODING_NOT_SUPPORTED")throw n}}encodings(){return Array.from(new Set(this[L1].values()))}encoding(e){let t=this[L1].get(e);if(t===void 0){if(typeof e=="string"&&e!==""){if(t=gre[e],!t)throw new q9(`Encoding '${e}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if(typeof e!="object"||e===null)throw new TypeError("First argument 'encoding' must be a string or object");t=dre(e)}const{name:n,format:s}=t;if(!this[Ih].has(s))if(this[Ih].has("view"))t=t.createViewTranscoder();else if(this[Ih].has("buffer"))t=t.createBufferTranscoder();else if(this[Ih].has("utf8"))t=t.createUTF8Transcoder();else throw new q9(`Encoding '${n}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});for(const i of[e,n,t.name,t.commonName])this[L1].set(i,t)}return t}};_C.Transcoder=hre;function dre(r){if(r instanceof ore)return r;const e="type"in r&&typeof r.type=="string"?r.type:void 0,t=r.name||e||`anonymous-${yre++}`;switch(fre(r)){case"view":return new cre({...r,name:t});case"utf8":return new lre({...r,name:t});case"buffer":return new are({...r,name:t});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}function fre(r){return"format"in r&&r.format!==void 0?r.format:"buffer"in r&&typeof r.buffer=="boolean"?r.buffer?"buffer":"utf8":"code"in r&&Number.isInteger(r.code)?"view":"buffer"}const pre={binary:J0.buffer,"utf-8":J0.utf8},gre={...J0,...pre};let yre=0;var oh={},mre=typeof queueMicrotask=="function"?queueMicrotask:r=>Promise.resolve().then(r),H9=mre;oh.fromCallback=function(r,e){if(r===void 0){var t=new Promise(function(n,s){r=function(i,o){i?s(i):n(o)}});r[e!==void 0?e:"promise"]=t}else if(typeof r!="function")throw new TypeError("Callback must be a function");return r};oh.fromPromise=function(r,e){if(e===void 0)return r;r.then(function(t){H9(()=>e(null,t))}).catch(function(t){H9(()=>e(t))})};var gi={},Qf={};Qf.getCallback=function(r,e){return typeof r=="function"?r:e};Qf.getOptions=function(r,e){return typeof r=="object"&&r!==null?r:e!==void 0?e:{}};const{fromCallback:tm}=oh,In=pi,{getOptions:rm,getCallback:z9}=Qf,xa=Symbol("promise"),yl=Symbol("callback"),Fs=Symbol("working"),Wa=Symbol("handleOne"),Ci=Symbol("handleMany"),nm=Symbol("autoClose"),ca=Symbol("finishWork"),si=Symbol("returnMany"),_o=Symbol("closing"),kh=Symbol("handleClose"),$1=Symbol("closed"),Th=Symbol("closeCallbacks"),zo=Symbol("keyEncoding"),Dc=Symbol("valueEncoding"),sm=Symbol("abortOnClose"),U1=Symbol("legacy"),im=Symbol("keys"),om=Symbol("values"),xo=Symbol("limit"),Zn=Symbol("count"),F1=Object.freeze({}),wre=()=>{};let W9=!1;class W5{constructor(e,t,n){if(typeof e!="object"||e===null){const s=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${s}`)}if(typeof t!="object"||t===null)throw new TypeError("The second argument must be an options object");this[$1]=!1,this[Th]=[],this[Fs]=!1,this[_o]=!1,this[nm]=!1,this[yl]=null,this[Wa]=this[Wa].bind(this),this[Ci]=this[Ci].bind(this),this[kh]=this[kh].bind(this),this[zo]=t[zo],this[Dc]=t[Dc],this[U1]=n,this[xo]=Number.isInteger(t.limit)&&t.limit>=0?t.limit:1/0,this[Zn]=0,this[sm]=!!t.abortOnClose,this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get count(){return this[Zn]}get limit(){return this[xo]}next(e){let t;if(e===void 0)t=new Promise((n,s)=>{e=(i,o,a)=>{i?s(i):this[U1]?o===void 0&&a===void 0?n():n([o,a]):n(o)}});else if(typeof e!="function")throw new TypeError("Callback must be a function");return this[_o]?this.nextTick(e,new In("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[Fs]?this.nextTick(e,new In("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[Fs]=!0,this[yl]=e,this[Zn]>=this[xo]?this.nextTick(this[Wa],null):this._next(this[Wa])),t}_next(e){this.nextTick(e)}nextv(e,t,n){return n=z9(t,n),n=tm(n,xa),t=rm(t,F1),Number.isInteger(e)?(this[_o]?this.nextTick(n,new In("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[Fs]?this.nextTick(n,new In("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(e<1&&(e=1),this[xo]<1/0&&(e=Math.min(e,this[xo]-this[Zn])),this[Fs]=!0,this[yl]=n,e<=0?this.nextTick(this[Ci],null,[]):this._nextv(e,t,this[Ci])),n[xa]):(this.nextTick(n,new TypeError("The first argument 'size' must be an integer")),n[xa])}_nextv(e,t,n){const s=[],i=(o,a,c)=>{if(o)return n(o);if(this[U1]?a===void 0&&c===void 0:a===void 0)return n(null,s);s.push(this[U1]?[a,c]:a),s.length===e?n(null,s):this._next(i)};this._next(i)}all(e,t){return t=z9(e,t),t=tm(t,xa),e=rm(e,F1),this[_o]?this.nextTick(t,new In("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[Fs]?this.nextTick(t,new In("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[Fs]=!0,this[yl]=t,this[nm]=!0,this[Zn]>=this[xo]?this.nextTick(this[Ci],null,[]):this._all(e,this[Ci])),t[xa]}_all(e,t){let n=this[Zn];const s=[],i=()=>{const a=this[xo]<1/0?Math.min(1e3,this[xo]-n):1e3;a<=0?this.nextTick(t,null,s):this._nextv(a,F1,o)},o=(a,c)=>{a?t(a):c.length===0?t(null,s):(s.push.apply(s,c),n+=c.length,i())};i()}[ca](){const e=this[yl];return this[sm]&&e===null?wre:(this[Fs]=!1,this[yl]=null,this[_o]&&this._close(this[kh]),e)}[si](e,t,n){this[nm]?this.close(e.bind(null,t,n)):e(t,n)}seek(e,t){if(t=rm(t,F1),!this[_o]){if(this[Fs])throw new In("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const n=this.db.keyEncoding(t.keyEncoding||this[zo]),s=n.format;t.keyEncoding!==s&&(t={...t,keyEncoding:s});const i=this.db.prefixKey(n.encode(e),s);this._seek(i,t)}}}_seek(e,t){throw new In("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(e){return e=tm(e,xa),this[$1]?this.nextTick(e):this[_o]?this[Th].push(e):(this[_o]=!0,this[Th].push(e),this[Fs]?this[sm]&&this[ca]()(new In("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[kh])),e[xa]}_close(e){this.nextTick(e)}[kh](){this[$1]=!0,this.db.detachResource(this);const e=this[Th];this[Th]=[];for(const t of e)t()}async*[Symbol.asyncIterator](){try{let e;for(;(e=await this.next())!==void 0;)yield e}finally{this[$1]||await this.close()}}}let F2=class extends W5{constructor(e,t){super(e,t,!0),this[im]=t.keys!==!1,this[om]=t.values!==!1}[Wa](e,t,n){const s=this[ca]();if(e)return s(e);try{t=this[im]&&t!==void 0?this[zo].decode(t):void 0,n=this[om]&&n!==void 0?this[Dc].decode(n):void 0}catch(i){return s(new Pu("entry",i))}t===void 0&&n===void 0||this[Zn]++,s(null,t,n)}[Ci](e,t){const n=this[ca]();if(e)return this[si](n,e);try{for(const s of t){const i=s[0],o=s[1];s[0]=this[im]&&i!==void 0?this[zo].decode(i):void 0,s[1]=this[om]&&o!==void 0?this[Dc].decode(o):void 0}}catch(s){return this[si](n,new Pu("entries",s))}this[Zn]+=t.length,this[si](n,null,t)}end(e){return!W9&&typeof console<"u"&&(W9=!0,console.warn(new In("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(e)}},bre=class extends W5{constructor(e,t){super(e,t,!1)}[Wa](e,t){const n=this[ca]();if(e)return n(e);try{t=t!==void 0?this[zo].decode(t):void 0}catch(s){return n(new Pu("key",s))}t!==void 0&&this[Zn]++,n(null,t)}[Ci](e,t){const n=this[ca]();if(e)return this[si](n,e);try{for(let s=0;s<t.length;s++){const i=t[s];t[s]=i!==void 0?this[zo].decode(i):void 0}}catch(s){return this[si](n,new Pu("keys",s))}this[Zn]+=t.length,this[si](n,null,t)}},vre=class extends W5{constructor(e,t){super(e,t,!1)}[Wa](e,t){const n=this[ca]();if(e)return n(e);try{t=t!==void 0?this[Dc].decode(t):void 0}catch(s){return n(new Pu("value",s))}t!==void 0&&this[Zn]++,n(null,t)}[Ci](e,t){const n=this[ca]();if(e)return this[si](n,e);try{for(let s=0;s<t.length;s++){const i=t[s];t[s]=i!==void 0?this[Dc].decode(i):void 0}}catch(s){return this[si](n,new Pu("values",s))}this[Zn]+=t.length,this[si](n,null,t)}};class Pu extends In{constructor(e,t){super(`Iterator could not decode ${e}`,{code:"LEVEL_DECODE_ERROR",cause:t})}}for(const r of["_ended property","_nexting property","_end method"])Object.defineProperty(F2.prototype,r.split(" ")[0],{get(){throw new In(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new In(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})}});F2.keyEncoding=zo;F2.valueEncoding=Dc;gi.AbstractIterator=F2;gi.AbstractKeyIterator=bre;gi.AbstractValueIterator=vre;var j5={};const{AbstractKeyIterator:Ere,AbstractValueIterator:Sre}=gi,Ba=Symbol("iterator"),Ch=Symbol("callback"),Du=Symbol("handleOne"),oc=Symbol("handleMany");let Z4=class extends Ere{constructor(e,t){super(e,t),this[Ba]=e.iterator({...t,keys:!0,values:!1}),this[Du]=this[Du].bind(this),this[oc]=this[oc].bind(this)}},kC=class extends Sre{constructor(e,t){super(e,t),this[Ba]=e.iterator({...t,keys:!1,values:!0}),this[Du]=this[Du].bind(this),this[oc]=this[oc].bind(this)}};for(const r of[Z4,kC]){const e=r===Z4,t=e?n=>n[0]:n=>n[1];r.prototype._next=function(n){this[Ch]=n,this[Ba].next(this[Du])},r.prototype[Du]=function(n,s,i){const o=this[Ch];n?o(n):o(null,e?s:i)},r.prototype._nextv=function(n,s,i){this[Ch]=i,this[Ba].nextv(n,s,this[oc])},r.prototype._all=function(n,s){this[Ch]=s,this[Ba].all(n,this[oc])},r.prototype[oc]=function(n,s){const i=this[Ch];n?i(n):i(null,s.map(t))},r.prototype._seek=function(n,s){this[Ba].seek(n,s)},r.prototype._close=function(n){this[Ba].close(n)}}j5.DefaultKeyIterator=Z4;j5.DefaultValueIterator=kC;var V2={};const{AbstractIterator:_re,AbstractKeyIterator:xre,AbstractValueIterator:Are}=gi,am=pi,tn=Symbol("nut"),K2=Symbol("undefer"),q2=Symbol("factory");let TC=class extends _re{constructor(e,t){super(e,t),this[tn]=null,this[q2]=()=>e.iterator(t),this.db.defer(()=>this[K2]())}},CC=class extends xre{constructor(e,t){super(e,t),this[tn]=null,this[q2]=()=>e.keys(t),this.db.defer(()=>this[K2]())}},PC=class extends Are{constructor(e,t){super(e,t),this[tn]=null,this[q2]=()=>e.values(t),this.db.defer(()=>this[K2]())}};for(const r of[TC,CC,PC])r.prototype[K2]=function(){this.db.status==="open"&&(this[tn]=this[q2]())},r.prototype._next=function(e){this[tn]!==null?this[tn].next(e):this.db.status==="opening"?this.db.defer(()=>this._next(e)):this.nextTick(e,new am("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._nextv=function(e,t,n){this[tn]!==null?this[tn].nextv(e,t,n):this.db.status==="opening"?this.db.defer(()=>this._nextv(e,t,n)):this.nextTick(n,new am("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._all=function(e,t){this[tn]!==null?this[tn].all(t):this.db.status==="opening"?this.db.defer(()=>this._all(e,t)):this.nextTick(t,new am("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._seek=function(e,t){this[tn]!==null?this[tn]._seek(e,t):this.db.status==="opening"&&this.db.defer(()=>this._seek(e,t))},r.prototype._close=function(e){this[tn]!==null?this[tn].close(e):this.db.status==="opening"?this.db.defer(()=>this._close(e)):this.nextTick(e)};V2.DeferredIterator=TC;V2.DeferredKeyIterator=CC;V2.DeferredValueIterator=PC;var DC={},G5={};const{fromCallback:j9}=oh,V1=pi,{getCallback:Ire,getOptions:kre}=Qf,K1=Symbol("promise"),jn=Symbol("status"),ml=Symbol("operations"),Ph=Symbol("finishClose"),wl=Symbol("closeCallbacks");let Tre=class{constructor(e){if(typeof e!="object"||e===null){const t=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${t}`)}this[ml]=[],this[wl]=[],this[jn]="open",this[Ph]=this[Ph].bind(this),this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get length(){return this[ml].length}put(e,t,n){if(this[jn]!=="open")throw new V1("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const s=this.db._checkKey(e)||this.db._checkValue(t);if(s)throw s;const i=n&&n.sublevel!=null?n.sublevel:this.db,o=n,a=i.keyEncoding(n&&n.keyEncoding),c=i.valueEncoding(n&&n.valueEncoding),l=a.format;n={...n,keyEncoding:l,valueEncoding:c.format},i!==this.db&&(n.sublevel=null);const u=i.prefixKey(a.encode(e),l),h=c.encode(t);return this._put(u,h,n),this[ml].push({...o,type:"put",key:e,value:t}),this}_put(e,t,n){}del(e,t){if(this[jn]!=="open")throw new V1("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const n=this.db._checkKey(e);if(n)throw n;const s=t&&t.sublevel!=null?t.sublevel:this.db,i=t,o=s.keyEncoding(t&&t.keyEncoding),a=o.format;return t={...t,keyEncoding:a},s!==this.db&&(t.sublevel=null),this._del(s.prefixKey(o.encode(e),a),t),this[ml].push({...i,type:"del",key:e}),this}_del(e,t){}clear(){if(this[jn]!=="open")throw new V1("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[ml]=[],this}_clear(){}write(e,t){return t=Ire(e,t),t=j9(t,K1),e=kre(e),this[jn]!=="open"?this.nextTick(t,new V1("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):this.length===0?this.close(t):(this[jn]="writing",this._write(e,n=>{this[jn]="closing",this[wl].push(()=>t(n)),n||this.db.emit("batch",this[ml]),this._close(this[Ph])})),t[K1]}_write(e,t){}close(e){return e=j9(e,K1),this[jn]==="closing"?this[wl].push(e):this[jn]==="closed"?this.nextTick(e):(this[wl].push(e),this[jn]!=="writing"&&(this[jn]="closing",this._close(this[Ph]))),e[K1]}_close(e){this.nextTick(e)}[Ph](){this[jn]="closed",this.db.detachResource(this);const e=this[wl];this[wl]=[];for(const t of e)t()}};G5.AbstractChainedBatch=Tre;const{AbstractChainedBatch:Cre}=G5,Pre=pi,bl=Symbol("encoded");let Dre=class extends Cre{constructor(e){super(e),this[bl]=[]}_put(e,t,n){this[bl].push({...n,type:"put",key:e,value:t})}_del(e,t){this[bl].push({...t,type:"del",key:e})}_clear(){this[bl]=[]}_write(e,t){this.db.status==="opening"?this.db.defer(()=>this._write(e,t)):this.db.status==="open"?this[bl].length===0?this.nextTick(t):this.db._batch(this[bl],e,t):this.nextTick(t,new Pre("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}};DC.DefaultChainedBatch=Dre;const G9=pi,Rre=Object.prototype.hasOwnProperty,Ore=new Set(["lt","lte","gt","gte"]);var Nre=function(r,e){const t={};for(const n in r)if(Rre.call(r,n)&&!(n==="keyEncoding"||n==="valueEncoding")){if(n==="start"||n==="end")throw new G9(`The legacy range option '${n}' has been removed`,{code:"LEVEL_LEGACY"});if(n==="encoding")throw new G9("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});Ore.has(n)?t[n]=e.encode(r[n]):t[n]=r[n]}return t.reverse=!!t.reverse,t.limit=Number.isInteger(t.limit)&&t.limit>=0?t.limit:-1,t};/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let Q9;var RC=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:Rp):r=>(Q9||(Q9=Promise.resolve())).then(r).catch(e=>setTimeout(()=>{throw e},0)),cm,Y9;function Mre(){if(Y9)return cm;Y9=1;const r=RC;return cm=function(e,...t){t.length===0?r(e):r(()=>e(...t))},cm}var Dh={},X9;function Bre(){if(X9)return Dh;X9=1;const{AbstractIterator:r,AbstractKeyIterator:e,AbstractValueIterator:t}=gi,n=Symbol("unfix"),s=Symbol("iterator"),i=Symbol("handleOne"),o=Symbol("handleMany"),a=Symbol("callback");class c extends r{constructor(d,g,y,w){super(d,g),this[s]=y,this[n]=w,this[i]=this[i].bind(this),this[o]=this[o].bind(this),this[a]=null}[i](d,g,y){const w=this[a];if(d)return w(d);g!==void 0&&(g=this[n](g)),w(d,g,y)}[o](d,g){const y=this[a];if(d)return y(d);for(const w of g){const m=w[0];m!==void 0&&(w[0]=this[n](m))}y(d,g)}}class l extends e{constructor(d,g,y,w){super(d,g),this[s]=y,this[n]=w,this[i]=this[i].bind(this),this[o]=this[o].bind(this),this[a]=null}[i](d,g){const y=this[a];if(d)return y(d);g!==void 0&&(g=this[n](g)),y(d,g)}[o](d,g){const y=this[a];if(d)return y(d);for(let w=0;w<g.length;w++){const m=g[w];m!==void 0&&(g[w]=this[n](m))}y(d,g)}}class u extends t{constructor(d,g,y){super(d,g),this[s]=y}}for(const h of[c,l])h.prototype._next=function(d){this[a]=d,this[s].next(this[i])},h.prototype._nextv=function(d,g,y){this[a]=y,this[s].nextv(d,g,this[o])},h.prototype._all=function(d,g){this[a]=g,this[s].all(d,this[o])};for(const h of[u])h.prototype._next=function(d){this[s].next(d)},h.prototype._nextv=function(d,g,y){this[s].nextv(d,g,y)},h.prototype._all=function(d,g){this[s].all(d,g)};for(const h of[c,l,u])h.prototype._seek=function(d,g){this[s].seek(d,g)},h.prototype._close=function(d){this[s].close(d)};return Dh.AbstractSublevelIterator=c,Dh.AbstractSublevelKeyIterator=l,Dh.AbstractSublevelValueIterator=u,Dh}var lm,Z9;function Lre(){if(Z9)return lm;Z9=1;const r=pi,{Buffer:e}=U5||{},{AbstractSublevelIterator:t,AbstractSublevelKeyIterator:n,AbstractSublevelValueIterator:s}=Bre(),i=Symbol("prefix"),o=Symbol("upperBound"),a=Symbol("prefixRange"),c=Symbol("parent"),l=Symbol("unfix"),u=new TextEncoder,h={separator:"!"};lm=function({AbstractLevel:_}){class k extends _{static defaults(I){if(typeof I=="string")throw new r("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(I&&I.open)throw new r("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return I==null?h:I.separator?I:{...I,separator:"!"}}constructor(I,T,x){const{separator:D,manifest:F,...R}=k.defaults(x);T=m(T,D);const C=D.charCodeAt(0)+1,O=I[c]||I;if(!u.encode(T).every(K=>K>C&&K<127))throw new r(`Prefix must use bytes > ${C} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(d(O,F),R);const P=(I.prefix||"")+D+T+D,M=P.slice(0,-1)+String.fromCharCode(C);this[c]=O,this[i]=new y(P),this[o]=new y(M),this[l]=new w,this.nextTick=O.nextTick}prefixKey(I,T){if(T==="utf8")return this[i].utf8+I;if(I.byteLength===0)return this[i][T];if(T==="view"){const x=this[i].view,D=new Uint8Array(x.byteLength+I.byteLength);return D.set(x,0),D.set(I,x.byteLength),D}else{const x=this[i].buffer;return e.concat([x,I],x.byteLength+I.byteLength)}}[a](I,T){I.gte!==void 0?I.gte=this.prefixKey(I.gte,T):I.gt!==void 0?I.gt=this.prefixKey(I.gt,T):I.gte=this[i][T],I.lte!==void 0?I.lte=this.prefixKey(I.lte,T):I.lt!==void 0?I.lt=this.prefixKey(I.lt,T):I.lte=this[o][T]}get prefix(){return this[i].utf8}get db(){return this[c]}_open(I,T){this[c].open({passive:!0},T)}_put(I,T,x,D){this[c].put(I,T,x,D)}_get(I,T,x){this[c].get(I,T,x)}_getMany(I,T,x){this[c].getMany(I,T,x)}_del(I,T,x){this[c].del(I,T,x)}_batch(I,T,x){this[c].batch(I,T,x)}_clear(I,T){this[a](I,I.keyEncoding),this[c].clear(I,T)}_iterator(I){this[a](I,I.keyEncoding);const T=this[c].iterator(I),x=this[l].get(this[i].utf8.length,I.keyEncoding);return new t(this,I,T,x)}_keys(I){this[a](I,I.keyEncoding);const T=this[c].keys(I),x=this[l].get(this[i].utf8.length,I.keyEncoding);return new n(this,I,T,x)}_values(I){this[a](I,I.keyEncoding);const T=this[c].values(I);return new s(this,I,T)}}return{AbstractSublevel:k}};const d=function(_,k){return{..._.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...k,encodings:{utf8:g(_,"utf8"),buffer:g(_,"buffer"),view:g(_,"view")}}},g=function(_,k){return _.supports.encodings[k]?_.keyEncoding(k).name===k:!1};class y{constructor(k){this.utf8=k,this.view=u.encode(k),this.buffer=e?e.from(this.view.buffer,0,this.view.byteLength):{}}}class w{constructor(){this.cache=new Map}get(k,N){let I=this.cache.get(N);return I===void 0&&(N==="view"?I=function(T,x){return x.subarray(T)}.bind(null,k):I=function(T,x){return x.slice(T)}.bind(null,k),this.cache.set(N,I)),I}}const m=function(_,k){let N=0,I=_.length;for(;N<I&&_[N]===k;)N++;for(;I>N&&_[I-1]===k;)I--;return _.slice(N,I)};return lm}const{supports:$re}=SC,{Transcoder:Ure}=_C,{EventEmitter:Fre}=B2,{fromCallback:Ao}=oh,ws=pi,{AbstractIterator:Aa}=gi,{DefaultKeyIterator:Vre,DefaultValueIterator:Kre}=j5,{DeferredIterator:qre,DeferredKeyIterator:Hre,DeferredValueIterator:zre}=V2,{DefaultChainedBatch:J9}=DC,{getCallback:Ia,getOptions:Io}=Qf,q1=Nre,Be=Symbol("promise"),Ei=Symbol("landed"),ka=Symbol("resources"),um=Symbol("closeResources"),Rh=Symbol("operations"),Oh=Symbol("undefer"),H1=Symbol("deferOpen"),eE=Symbol("options"),qe=Symbol("status"),Ta=Symbol("defaultOptions"),vl=Symbol("transcoder"),z1=Symbol("keyEncoding"),hm=Symbol("valueEncoding"),Wre=()=>{};let Q5=class extends Fre{constructor(e,t){if(super(),typeof e!="object"||e===null)throw new TypeError("The first argument 'manifest' must be an object");t=Io(t);const{keyEncoding:n,valueEncoding:s,passive:i,...o}=t;this[ka]=new Set,this[Rh]=[],this[H1]=!0,this[eE]=o,this[qe]="opening",this.supports=$re(e,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:e.snapshots!==!1,permanence:e.permanence!==!1,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:e.encodings||{},events:Object.assign({},e.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[vl]=new Ure(jre(this)),this[z1]=this[vl].encoding(n||"utf8"),this[hm]=this[vl].encoding(s||"utf8");for(const a of this[vl].encodings())this.supports.encodings[a.commonName]||(this.supports.encodings[a.commonName]=!0);this[Ta]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[z1].commonName,valueEncoding:this[hm].commonName}),key:Object.freeze({keyEncoding:this[z1].commonName})},this.nextTick(()=>{this[H1]&&this.open({passive:!1},Wre)})}get status(){return this[qe]}keyEncoding(e){return this[vl].encoding(e??this[z1])}valueEncoding(e){return this[vl].encoding(e??this[hm])}open(e,t){t=Ia(e,t),t=Ao(t,Be),e={...this[eE],...Io(e)},e.createIfMissing=e.createIfMissing!==!1,e.errorIfExists=!!e.errorIfExists;const n=s=>{this[qe]==="closing"||this[qe]==="opening"?this.once(Ei,s?()=>n(s):n):this[qe]!=="open"?t(new ws("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:s})):t()};return e.passive?this[qe]==="opening"?this.once(Ei,n):this.nextTick(n):this[qe]==="closed"||this[H1]?(this[H1]=!1,this[qe]="opening",this.emit("opening"),this._open(e,s=>{if(s){this[qe]="closed",this[um](()=>{this.emit(Ei),n(s)}),this[Oh]();return}this[qe]="open",this[Oh](),this.emit(Ei),this[qe]==="open"&&this.emit("open"),this[qe]==="open"&&this.emit("ready"),n()})):this[qe]==="open"?this.nextTick(n):this.once(Ei,()=>this.open(e,t)),t[Be]}_open(e,t){this.nextTick(t)}close(e){e=Ao(e,Be);const t=n=>{this[qe]==="opening"||this[qe]==="closing"?this.once(Ei,n?t(n):t):this[qe]!=="closed"?e(new ws("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:n})):e()};if(this[qe]==="open"){this[qe]="closing",this.emit("closing");const n=s=>{this[qe]="open",this[Oh](),this.emit(Ei),t(s)};this[um](()=>{this._close(s=>{if(s)return n(s);this[qe]="closed",this[Oh](),this.emit(Ei),this[qe]==="closed"&&this.emit("closed"),t()})})}else this[qe]==="closed"?this.nextTick(t):this.once(Ei,()=>this.close(e));return e[Be]}[um](e){if(this[ka].size===0)return this.nextTick(e);let t=this[ka].size,n=!0;const s=()=>{--t===0&&(n?this.nextTick(e):e())};for(const i of this[ka])i.close(s);n=!1,this[ka].clear()}_close(e){this.nextTick(e)}get(e,t,n){if(n=Ia(t,n),n=Ao(n,Be),t=Io(t,this[Ta].entry),this[qe]==="opening")return this.defer(()=>this.get(e,t,n)),n[Be];if(El(this,n))return n[Be];const s=this._checkKey(e);if(s)return this.nextTick(n,s),n[Be];const i=this.keyEncoding(t.keyEncoding),o=this.valueEncoding(t.valueEncoding),a=i.format,c=o.format;return(t.keyEncoding!==a||t.valueEncoding!==c)&&(t=Object.assign({},t,{keyEncoding:a,valueEncoding:c})),this._get(this.prefixKey(i.encode(e),a),t,(l,u)=>{if(l)return(l.code==="LEVEL_NOT_FOUND"||l.notFound||/NotFound/i.test(l))&&(l.code||(l.code="LEVEL_NOT_FOUND"),l.notFound||(l.notFound=!0),l.status||(l.status=404)),n(l);try{u=o.decode(u)}catch(h){return n(new ws("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,u)}),n[Be]}_get(e,t,n){this.nextTick(n,new Error("NotFound"))}getMany(e,t,n){if(n=Ia(t,n),n=Ao(n,Be),t=Io(t,this[Ta].entry),this[qe]==="opening")return this.defer(()=>this.getMany(e,t,n)),n[Be];if(El(this,n))return n[Be];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'keys' must be an array")),n[Be];if(e.length===0)return this.nextTick(n,null,[]),n[Be];const s=this.keyEncoding(t.keyEncoding),i=this.valueEncoding(t.valueEncoding),o=s.format,a=i.format;(t.keyEncoding!==o||t.valueEncoding!==a)&&(t=Object.assign({},t,{keyEncoding:o,valueEncoding:a}));const c=new Array(e.length);for(let l=0;l<e.length;l++){const u=e[l],h=this._checkKey(u);if(h)return this.nextTick(n,h),n[Be];c[l]=this.prefixKey(s.encode(u),o)}return this._getMany(c,t,(l,u)=>{if(l)return n(l);try{for(let h=0;h<u.length;h++)u[h]!==void 0&&(u[h]=i.decode(u[h]))}catch(h){return n(new ws(`Could not decode one or more of ${u.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,u)}),n[Be]}_getMany(e,t,n){this.nextTick(n,null,new Array(e.length).fill(void 0))}put(e,t,n,s){if(s=Ia(n,s),s=Ao(s,Be),n=Io(n,this[Ta].entry),this[qe]==="opening")return this.defer(()=>this.put(e,t,n,s)),s[Be];if(El(this,s))return s[Be];const i=this._checkKey(e)||this._checkValue(t);if(i)return this.nextTick(s,i),s[Be];const o=this.keyEncoding(n.keyEncoding),a=this.valueEncoding(n.valueEncoding),c=o.format,l=a.format;(n.keyEncoding!==c||n.valueEncoding!==l)&&(n=Object.assign({},n,{keyEncoding:c,valueEncoding:l}));const u=this.prefixKey(o.encode(e),c),h=a.encode(t);return this._put(u,h,n,d=>{if(d)return s(d);this.emit("put",e,t),s()}),s[Be]}_put(e,t,n,s){this.nextTick(s)}del(e,t,n){if(n=Ia(t,n),n=Ao(n,Be),t=Io(t,this[Ta].key),this[qe]==="opening")return this.defer(()=>this.del(e,t,n)),n[Be];if(El(this,n))return n[Be];const s=this._checkKey(e);if(s)return this.nextTick(n,s),n[Be];const i=this.keyEncoding(t.keyEncoding),o=i.format;return t.keyEncoding!==o&&(t=Object.assign({},t,{keyEncoding:o})),this._del(this.prefixKey(i.encode(e),o),t,a=>{if(a)return n(a);this.emit("del",e),n()}),n[Be]}_del(e,t,n){this.nextTick(n)}batch(e,t,n){if(!arguments.length){if(this[qe]==="opening")return new J9(this);if(this[qe]!=="open")throw new ws("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(typeof e=="function"?n=e:n=Ia(t,n),n=Ao(n,Be),t=Io(t,this[Ta].empty),this[qe]==="opening")return this.defer(()=>this.batch(e,t,n)),n[Be];if(El(this,n))return n[Be];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'operations' must be an array")),n[Be];if(e.length===0)return this.nextTick(n),n[Be];const s=new Array(e.length),{keyEncoding:i,valueEncoding:o,...a}=t;for(let c=0;c<e.length;c++){if(typeof e[c]!="object"||e[c]===null)return this.nextTick(n,new TypeError("A batch operation must be an object")),n[Be];const l=Object.assign({},e[c]);if(l.type!=="put"&&l.type!=="del")return this.nextTick(n,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),n[Be];const u=this._checkKey(l.key);if(u)return this.nextTick(n,u),n[Be];const h=l.sublevel!=null?l.sublevel:this,d=h.keyEncoding(l.keyEncoding||i),g=d.format;if(l.key=h.prefixKey(d.encode(l.key),g),l.keyEncoding=g,l.type==="put"){const y=this._checkValue(l.value);if(y)return this.nextTick(n,y),n[Be];const w=h.valueEncoding(l.valueEncoding||o);l.value=w.encode(l.value),l.valueEncoding=w.format}h!==this&&(l.sublevel=null),s[c]=l}return this._batch(s,a,c=>{if(c)return n(c);this.emit("batch",e),n()}),n[Be]}_batch(e,t,n){this.nextTick(n)}sublevel(e,t){return this._sublevel(e,J4.defaults(t))}_sublevel(e,t){return new J4(this,e,t)}prefixKey(e,t){return e}clear(e,t){if(t=Ia(e,t),t=Ao(t,Be),e=Io(e,this[Ta].empty),this[qe]==="opening")return this.defer(()=>this.clear(e,t)),t[Be];if(El(this,t))return t[Be];const n=e,s=this.keyEncoding(e.keyEncoding);return e=q1(e,s),e.keyEncoding=s.format,e.limit===0?this.nextTick(t):this._clear(e,i=>{if(i)return t(i);this.emit("clear",n),t()}),t[Be]}_clear(e,t){this.nextTick(t)}iterator(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=q1(e,t),e.keys=e.keys!==!1,e.values=e.values!==!1,e[Aa.keyEncoding]=t,e[Aa.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[qe]==="opening")return new qre(this,e);if(this[qe]!=="open")throw new ws("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(e)}_iterator(e){return new Aa(this,e)}keys(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=q1(e,t),e[Aa.keyEncoding]=t,e[Aa.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[qe]==="opening")return new Hre(this,e);if(this[qe]!=="open")throw new ws("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(e)}_keys(e){return new Vre(this,e)}values(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=q1(e,t),e[Aa.keyEncoding]=t,e[Aa.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[qe]==="opening")return new zre(this,e);if(this[qe]!=="open")throw new ws("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(e)}_values(e){return new Kre(this,e)}defer(e){if(typeof e!="function")throw new TypeError("The first argument must be a function");this[Rh].push(e)}[Oh](){if(this[Rh].length===0)return;const e=this[Rh];this[Rh]=[];for(const t of e)t()}attachResource(e){if(typeof e!="object"||e===null||typeof e.close!="function")throw new TypeError("The first argument must be a resource object");this[ka].add(e)}detachResource(e){this[ka].delete(e)}_chainedBatch(){return new J9(this)}_checkKey(e){if(e==null)return new ws("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(e){if(e==null)return new ws("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}};Q5.prototype.nextTick=Mre();const{AbstractSublevel:J4}=Lre()({AbstractLevel:Q5});U2.AbstractLevel=Q5;U2.AbstractSublevel=J4;const El=function(r,e){return r[qe]!=="open"?(r.nextTick(e,new ws("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0):!1},jre=function(r){return Object.keys(r.supports.encodings).filter(e=>!!r.supports.encodings[e])};pa.AbstractLevel=U2.AbstractLevel;pa.AbstractSublevel=U2.AbstractSublevel;pa.AbstractIterator=gi.AbstractIterator;pa.AbstractKeyIterator=gi.AbstractKeyIterator;pa.AbstractValueIterator=gi.AbstractValueIterator;pa.AbstractChainedBatch=G5.AbstractChainedBatch;/*! run-parallel-limit. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var Gre=Yre;const Qre=RC;function Yre(r,e,t){if(typeof e!="number")throw new Error("second argument must be a Number");let n,s,i,o,a,c=!0,l;Array.isArray(r)?(n=[],i=s=r.length):(o=Object.keys(r),n={},i=s=o.length);function u(d){function g(){t&&t(d,n),t=null}c?Qre(g):g()}function h(d,g,y){if(n[d]=y,g&&(a=!0),--i===0||g)u(g);else if(!a&&l<s){let w;o?(w=o[l],l+=1,r[w](function(m,_){h(w,m,_)})):(w=l,l+=1,r[w](function(m,_){h(w,m,_)}))}}l=e,i?o?o.some(function(d,g){return r[d](function(y,w){h(d,y,w)}),g===e-1}):r.some(function(d,g){return d(function(y,w){h(g,y,w)}),g===e-1}):u(null),c=!1}var OC={},NC=function(e){const t=e.gte!==void 0?e.gte:e.gt!==void 0?e.gt:void 0,n=e.lte!==void 0?e.lte:e.lt!==void 0?e.lt:void 0,s=e.gte===void 0,i=e.lte===void 0;return t!==void 0&&n!==void 0?IDBKeyRange.bound(t,n,s,i):t!==void 0?IDBKeyRange.lowerBound(t,s):n!==void 0?IDBKeyRange.upperBound(n,i):null};const Xre=new TextEncoder;var MC=function(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):Xre.encode(r)};const{AbstractIterator:Zre}=pa,tE=NC,W1=MC,Vs=Symbol("cache"),Si=Symbol("finished"),Sn=Symbol("options"),_i=Symbol("currentOptions"),Ca=Symbol("position"),dm=Symbol("location"),Sl=Symbol("first"),rE={};let Jre=class extends Zre{constructor(e,t,n){super(e,n),this[Vs]=[],this[Si]=this.limit===0,this[Sn]=n,this[_i]={...n},this[Ca]=void 0,this[dm]=t,this[Sl]=!0}_nextv(e,t,n){if(this[Sl]=!1,this[Si])return this.nextTick(n,null,[]);if(this[Vs].length>0)return e=Math.min(e,this[Vs].length),this.nextTick(n,null,this[Vs].splice(0,e));this[Ca]!==void 0&&(this[Sn].reverse?(this[_i].lt=this[Ca],this[_i].lte=void 0):(this[_i].gt=this[Ca],this[_i].gte=void 0));let s;try{s=tE(this[_i])}catch{return this[Si]=!0,this.nextTick(n,null,[])}const i=this.db.db.transaction([this[dm]],"readonly"),o=i.objectStore(this[dm]),a=[];if(this[Sn].reverse){const c=!this[Sn].values&&o.openKeyCursor?"openKeyCursor":"openCursor";o[c](s,"prev").onsuccess=l=>{const u=l.target.result;if(u){const{key:h,value:d}=u;this[Ca]=h,a.push([this[Sn].keys&&h!==void 0?W1(h):void 0,this[Sn].values&&d!==void 0?W1(d):void 0]),a.length<e?u.continue():nE(i)}else this[Si]=!0}}else{let c,l;const u=()=>{if(c===void 0||l===void 0)return;const h=Math.max(c.length,l.length);h===0||e===1/0?this[Si]=!0:this[Ca]=c[h-1],a.length=h;for(let d=0;d<h;d++){const g=c[d],y=l[d];a[d]=[this[Sn].keys&&g!==void 0?W1(g):void 0,this[Sn].values&&y!==void 0?W1(y):void 0]}nE(i)};this[Sn].keys||e<1/0?o.getAllKeys(s,e<1/0?e:void 0).onsuccess=h=>{c=h.target.result,u()}:(c=[],this.nextTick(u)),this[Sn].values?o.getAll(s,e<1/0?e:void 0).onsuccess=h=>{l=h.target.result,u()}:(l=[],this.nextTick(u))}i.onabort=()=>{n(i.error||new Error("aborted by user")),n=null},i.oncomplete=()=>{n(null,a),n=null}}_next(e){if(this[Vs].length>0){const[t,n]=this[Vs].shift();this.nextTick(e,null,t,n)}else if(this[Si])this.nextTick(e);else{let t=Math.min(100,this.limit-this.count);this[Sl]&&(this[Sl]=!1,t=1),this._nextv(t,rE,(n,s)=>{if(n)return e(n);this[Vs]=s,this._next(e)})}}_all(e,t){this[Sl]=!1;const n=this[Vs].splice(0,this[Vs].length),s=this.limit-this.count-n.length;if(s<=0)return this.nextTick(t,null,n);this._nextv(s,rE,(i,o)=>{if(i)return t(i);n.length>0&&(o=n.concat(o)),t(null,o)})}_seek(e,t){this[Sl]=!0,this[Vs]=[],this[Si]=!1,this[Ca]=void 0,this[_i]={...this[Sn]};let n;try{n=tE(this[Sn])}catch{this[Si]=!0;return}n!==null&&!n.includes(e)?this[Si]=!0:this[Sn].reverse?this[_i].lte=e:this[_i].gte=e}};OC.Iterator=Jre;function nE(r){typeof r.commit=="function"&&r.commit()}var ene=function(e,t,n,s,i){if(s.limit===0)return e.nextTick(i);const o=e.db.transaction([t],"readwrite"),a=o.objectStore(t);let c=0;o.oncomplete=function(){i()},o.onabort=function(){i(o.error||new Error("aborted by user"))};const l=a.openKeyCursor?"openKeyCursor":"openCursor",u=s.reverse?"prev":"next";a[l](n,u).onsuccess=function(h){const d=h.target.result;d&&(a.delete(d.key).onsuccess=function(){(s.limit<=0||++c<s.limit)&&d.continue()})}};const{AbstractLevel:tne}=pa,sE=pi,rne=Gre,{fromCallback:nne}=oh,{Iterator:sne}=OC,iE=MC,ine=ene,one=NC,BC="level-js-",Nh=Symbol("idb"),fm=Symbol("namePrefix"),xi=Symbol("location"),pm=Symbol("version"),Pa=Symbol("store"),Mh=Symbol("onComplete"),oE=Symbol("promise");class LC extends tne{constructor(e,t,n){if(typeof t=="function"||typeof n=="function")throw new sE("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:s,version:i,...o}=t||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},o),typeof e!="string")throw new Error("constructor requires a location string argument");this[xi]=e,this[fm]=s??BC,this[pm]=parseInt(i||1,10),this[Nh]=null}get location(){return this[xi]}get namePrefix(){return this[fm]}get version(){return this[pm]}get db(){return this[Nh]}get type(){return"browser-level"}_open(e,t){const n=indexedDB.open(this[fm]+this[xi],this[pm]);n.onerror=function(){t(n.error||new Error("unknown error"))},n.onsuccess=()=>{this[Nh]=n.result,t()},n.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(this[xi])||i.createObjectStore(this[xi])}}[Pa](e){return this[Nh].transaction([this[xi]],e).objectStore(this[xi])}[Mh](e,t){const n=e.transaction;n.onabort=function(){t(n.error||new Error("aborted by user"))},n.oncomplete=function(){t(null,e.result)}}_get(e,t,n){const s=this[Pa]("readonly");let i;try{i=s.get(e)}catch(o){return this.nextTick(n,o)}this[Mh](i,function(o,a){if(o)return n(o);if(a===void 0)return n(new sE("Entry not found",{code:"LEVEL_NOT_FOUND"}));n(null,iE(a))})}_getMany(e,t,n){const s=this[Pa]("readonly"),i=e.map(o=>a=>{let c;try{c=s.get(o)}catch(l){return a(l)}c.onsuccess=()=>{const l=c.result;a(null,l===void 0?l:iE(l))},c.onerror=l=>{l.stopPropagation(),a(c.error)}});rne(i,16,n)}_del(e,t,n){const s=this[Pa]("readwrite");let i;try{i=s.delete(e)}catch(o){return this.nextTick(n,o)}this[Mh](i,n)}_put(e,t,n,s){const i=this[Pa]("readwrite");let o;try{o=i.put(t,e)}catch(a){return this.nextTick(s,a)}this[Mh](o,s)}_iterator(e){return new sne(this,this[xi],e)}_batch(e,t,n){const s=this[Pa]("readwrite"),i=s.transaction;let o=0,a;i.onabort=function(){n(a||i.error||new Error("aborted by user"))},i.oncomplete=function(){n()};function c(){const l=e[o++],u=l.key;let h;try{h=l.type==="del"?s.delete(u):s.put(l.value,u)}catch(d){a=d,i.abort();return}o<e.length?h.onsuccess=c:typeof i.commit=="function"&&i.commit()}c()}_clear(e,t){let n,s;try{n=one(e)}catch{return this.nextTick(t)}if(e.limit>=0)return ine(this,this[xi],n,e,t);try{const i=this[Pa]("readwrite");s=n?i.delete(n):i.clear()}catch(i){return this.nextTick(t,i)}this[Mh](s,t)}_close(e){this[Nh].close(),this.nextTick(e)}}LC.destroy=function(r,e,t){typeof e=="function"&&(t=e,e=BC),t=nne(t,oE);const n=indexedDB.deleteDatabase(e+r);return n.onsuccess=function(){t()},n.onerror=function(s){t(s)},t[oE]};EC.BrowserLevel=LC;var Y5=EC.BrowserLevel;const ane="./level",cne="view",e6=async({path:r,valueEncoding:e}={})=>{r=r||ane,e=e||cne;const t=new Y5(r,{valueEncoding:e,passive:!0});return await t.open(),{put:async(u,h)=>{await t.put(u,h)},del:async u=>{await t.del(u)},get:async u=>{try{const h=await t.get(u);if(h)return h}catch{}},iterator:async function*({amount:u,reverse:h}={}){const d={limit:u||-1,reverse:h||!1};for await(const[g,y]of t.iterator(d))yield[g,y]},merge:async u=>{},clear:async()=>{await t.clear()},close:async()=>{await t.close()}}},aE=1e6,ii=async({size:r}={})=>{let e=new z4(r||aE);return{put:async(l,u)=>{e.set(l,u)},del:async l=>{e.remove(l)},get:async l=>e.get(l),iterator:async function*(){for await(const l of e.keys){const u=e.get(l);yield[l,u]}},merge:async l=>{if(l)for await(const[u,h]of l.iterator())e.set(u,h)},clear:async()=>{e=new z4(r||aE)},close:async()=>{}}},lne=16,gm=1e3,X5=async({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d,encryption:g})=>{i=Ko(i||"./orbitdb",`./${t}/`),o=o||{},u=Number(u)>-1?u:lne,c=c||await ic(await ii({size:gm}),await $2({ipfs:r,pin:!0})),a=a||await ic(await ii({size:gm}),await e6({path:Ko(i,"/log/_heads/")})),l=l||await ic(await ii({size:gm}),await e6({path:Ko(i,"/log/_index/")})),g=g||{};const y=await Jte(e,{logId:t,access:s,entryStorage:c,headsStorage:a,indexStorage:l,encryption:g}),w=new B2.EventEmitter,m=new ru({concurrency:1}),_=async x=>{const D=async()=>{const R=await y.append(x,{referencesCount:u});return await T.add(R),d&&await d(y,R),w.emit("update",R),R.hash};return await m.add(D)},k=async x=>{const D=async()=>{try{x&&await y.joinEntry(x)&&(d&&await d(y,x),w.emit("update",x))}catch(F){console.error(F)}};await m.add(D)},N=async()=>{await T.stop(),await m.onIdle(),await y.close(),s&&s.close&&await s.close(),w.emit("close")},I=async()=>{await m.clear(),await y.clear(),s&&s.drop&&await s.drop(),w.emit("drop")},T=await tre({ipfs:r,log:y,events:w,onSynced:k,start:h});return{address:t,name:n,identity:e,meta:o,close:N,drop:I,addOperation:_,log:y,sync:T,peers:T.peers,events:w,access:s}},$C="documents",une={indexBy:"_id"},UC=({indexBy:r}=une)=>async({ipfs:e,identity:t,address:n,name:s,access:i,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:u,referencesCount:h,syncAutomatically:d,onUpdate:g,encrypt:y})=>{const w=await X5({ipfs:e,identity:t,address:n,name:s,access:i,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:u,referencesCount:h,syncAutomatically:d,encrypt:y}),{addOperation:m,log:_}=w,k=async F=>{const R=F[r];if(!R)throw new Error(`The provided document doesn't contain field '${r}'`);return m({op:"PUT",key:R,value:F})},N=async F=>{if(!await I(F))throw new Error(`No document with key '${F}' in the database`);return m({op:"DEL",key:F,value:null})},I=async F=>{for await(const R of x())if(F===R.key)return R},T=async F=>{const R=[];for await(const C of x())F(C.value)&&R.push(C.value);return R},x=async function*({amount:F}={}){const R={};let C=0;for await(const O of _.iterator()){const{op:P,key:M,value:K}=O.payload;if(P==="PUT"&&!R[M]?(R[M]=!0,C++,yield{hash:O.hash,key:M,value:K}):P==="DEL"&&!R[M]&&(R[M]=!0),C>=F)break}};return{...w,type:$C,put:k,del:N,get:I,iterator:x,query:T,indexBy:r,all:async()=>{const F=[];for await(const R of x())F.unshift(R);return F}}};UC.type=$C;const FC="events",VC=()=>async({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d,encryption:g})=>{const y=await X5({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d,encryption:g}),{addOperation:w,log:m}=y,_=async T=>w({op:"ADD",key:null,value:T}),k=async T=>(await m.get(T)).payload.value,N=async function*({gt:T,gte:x,lt:D,lte:F,amount:R}={}){const C=m.iterator({gt:T,gte:x,lt:D,lte:F,amount:R});for await(const O of C){const P=O.hash,M=O.payload.value;yield{hash:P,value:M}}};return{...y,type:FC,add:_,get:k,iterator:N,all:async()=>{const T=[];for await(const x of N())T.unshift(x);return T}}};VC.type=FC;const KC="keyvalue",qC=()=>async({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d,encryption:g})=>{const y=await X5({ipfs:r,identity:e,address:t,name:n,access:s,directory:i,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:u,syncAutomatically:h,onUpdate:d,encryption:g}),{addOperation:w,log:m}=y,_=async(x,D)=>w({op:"PUT",key:x,value:D}),k=async x=>w({op:"DEL",key:x,value:null}),N=async x=>{for await(const D of m.traverse()){const{op:F,key:R,value:C}=D.payload;if(F==="PUT"&&R===x)return C;if(F==="DEL"&&R===x)return}},I=async function*({amount:x}={}){const D={};let F=0;for await(const R of m.traverse()){const{op:C,key:O,value:P}=R.payload;if(C==="PUT"&&!D[O]){D[O]=!0,F++;const M=R.hash;yield{key:O,value:P,hash:M}}else C==="DEL"&&!D[O]&&(D[O]=!0);if(F>=x)break}};return{...y,type:KC,put:_,set:_,del:k,get:N,iterator:I,all:async()=>{const x=[];for await(const D of I())x.unshift(D);return x}}};qC.type=KC;const t6={},Z5=r=>{if(!r.type)throw new Error("Database type does not contain required field 'type'.");t6[r.type]=r},hne=r=>{if(!r)throw new Error("Type not specified");if(!t6[r])throw new Error(`Unsupported database type: '${r}'`);return t6[r]};Z5(VC);Z5(UC);Z5(qC);const dne=async(r,e,t)=>{if(!r)throw new Error("No signature given");if(!e)throw new Error("Given publicKey was undefined");if(!t)throw new Error("Given input data was undefined");t instanceof Uint8Array||(t=typeof t=="string"?ie(t):new Uint8Array(t));const n=(i,o,a)=>i.verify(o,a);let s=!1;try{const i=YM(ie(e,"base16"));s=await n(i,t,ie(r,"base16"))}catch{}return Promise.resolve(s)},r6=async(r,e)=>{if(!r)throw new Error("No signing key given");if(!e)throw new Error("Given input data was undefined");return e instanceof Uint8Array||(e=typeof e=="string"?ie(e):new Uint8Array(e)),se(await r.sign(e),"base16")},fne=ii({size:1e3}),HC=async(r,e,t)=>{const n=await fne,s=await n.get(r);let i=!1;if(s){const o=(a,c)=>c instanceof Uint8Array?Qj(a,c)===0:a.toString()===c.toString();i=s.publicKey===e&&o(s.data,t)}else{const o=await dne(r,e,t);i=o,o&&await n.put(r,{publicKey:e,data:t})}return i},pne="./keystore",zC=async({storage:r,path:e}={})=>{r=r||await ic(await ii({size:1e3}),await e6({path:e||pne}));const t=await ii({size:1e3}),n=async()=>{await r.close(),await t.close()},s=async()=>{await r.clear(),await t.clear()},i=async u=>{if(!u)throw new Error("id needed to check a key");let h=!1,d=await t.get(u);if(d)h=!0;else try{d=await r.get("private_"+u),h=d!=null}catch{console.error("Error: ENOENT: no such file or directory")}return h},o=async(u,h)=>{const{privateKey:d}=h;await r.put("private_"+u,d);const g=Vm(d);await t.put(u,g)};return{clear:s,close:n,hasKey:i,addKey:o,createKey:async u=>{if(!u)throw new Error("id needed to create a key");const h=await mg("secp256k1"),d={publicKey:h.publicKey.raw,privateKey:h.raw};return await o(u,d),h},getKey:async u=>{if(!u)throw new Error("id needed to get a key");let h=await t.get(u);if(!h){let d;try{d=await r.get("private_"+u)}catch{}if(!d)return;h=Vm(d),await t.put(u,h)}return h},getPublic:(u,h={})=>{const d=["hex","buffer"],g=h.format||"hex";if(d.indexOf(g)===-1)throw new Error("Supported formats are `hex` and `buffer`");const y=u.publicKey.raw;return g==="buffer"?y:se(y,"base16")}}},WC=_f,jC=L2,gne=Mr,GC=async({id:r,publicKey:e,signatures:t,type:n,sign:s,verify:i}={})=>{if(!r)throw new Error("Identity id is required");if(!e)throw new Error("Invalid public key");if(!t)throw new Error("Signatures object is required");if(!t.id)throw new Error("Signature of id is required");if(!t.publicKey)throw new Error("Signature of publicKey+id is required");if(!n)throw new Error("Identity type is required");t=Object.assign({},t);const o={id:r,publicKey:e,signatures:t,type:n,sign:s,verify:i},{hash:a,bytes:c}=await yne(o);return o.hash=a,o.bytes=c,o},yne=async r=>{const{id:e,publicKey:t,signatures:n,type:s}=r,i={id:e,publicKey:t,signatures:n,type:s},{cid:o,bytes:a}=await aa({value:i,codec:WC,hasher:jC});return{hash:o.toString(gne),bytes:Uint8Array.from(a)}},mne=async r=>{const{value:e}=await Gl({bytes:r,codec:WC,hasher:jC});return GC({...e})},wne=r=>!!(r.id&&r.hash&&r.bytes&&r.publicKey&&r.signatures&&r.signatures.id&&r.signatures.publicKey&&r.type),bne=(r,e)=>r.id===e.id&&r.hash===e.hash&&r.type===e.type&&r.publicKey===e.publicKey&&r.signatures.id===e.signatures.id&&r.signatures.publicKey===e.signatures.publicKey,QC="publickey",vne=async r=>{const{id:e,publicKey:t,signatures:n}=r;return HC(n.publicKey,e,t+n.id)},J5=({keystore:r})=>async()=>{if(!r)throw new Error("PublicKeyIdentityProvider requires a keystore parameter");return{type:QC,getId:async({id:n}={})=>{if(!n)throw new Error("id is required");const s=await r.getKey(n)||await r.createKey(n);return se(s.publicKey.raw,"base16")},signIdentity:async(n,{id:s}={})=>{if(!s)throw new Error("id is required");const i=await r.getKey(s);if(!i)throw new Error(`Signing key for '${s}' not found`);return r6(i,n)}}};J5.verifyIdentity=vne;J5.type=QC;const e8={},Ene=r=>Object.keys(e8).includes(r),ym=r=>{if(!Ene(r))throw new Error(`IdentityProvider type '${r}' is not supported`);return e8[r]},Sne=r=>{if(!r.type||typeof r.type!="string")throw new Error("Given IdentityProvider doesn't have a field 'type'.");if(!r.verifyIdentity)throw new Error("Given IdentityProvider doesn't have a function 'verifyIdentity'.");e8[r.type]=r};Sne(J5);const _ne=Ko("./orbitdb","identities"),xne=async({keystore:r,path:e,storage:t,ipfs:n}={})=>{r=r||await zC({path:e||_ne}),t||(t=n?await ic(await ii({size:1e3}),await $2({ipfs:n,pin:!0})):await $5());const s=await ii({size:1e3}),i=async u=>{const h=await t.get(u);if(h)return mne(h)},o=async(u={})=>{u.keystore=r;const h=ym("publickey"),g=await(u.provider||h({keystore:r}))();if(!ym(g.type))throw new Error("Identity provider is unknown. Use useIdentityProvider(provider) to register the identity provider");const y=await g.getId(u),w=await r.getKey(y)||await r.createKey(y),m=r.getPublic(w),_=await r6(w,y),k=await g.signIdentity(m+_,u),I=await GC({id:y,publicKey:m,signatures:{id:_,publicKey:k},type:g.type,sign:c,verify:l});return await t.put(I.hash,I.bytes),I},a=async u=>{if(!wne(u))return!1;const{id:h,publicKey:d,signatures:g}=u;if(!await l(g.id,d,h))return!1;const w=await s.get(g.id);if(w)return bne(u,w);const _=await ym(u.type).verifyIdentity(u);return _&&await s.put(g.id,u),_},c=async(u,h)=>{const d=await r.getKey(u.id);if(!d)throw new Error("Private signing key not found from KeyStore");return await r6(d,h)},l=async(u,h,d)=>await HC(u,h,d);return{createIdentity:o,verifyIdentity:a,getIdentity:i,sign:c,verify:l,keystore:r}},Ane=r=>{if(r=r.toString(),!r.startsWith("/orbitdb")&&!r.startsWith("\\orbitdb"))return!1;r=r.replaceAll("/orbitdb/",""),r=r.replaceAll("\\orbitdb\\",""),r=r.replaceAll("/",""),r=r.replaceAll("\\","");let e;try{e=mt.parse(r,Mr)}catch{return!1}return e!==void 0},cE=r=>{if(r&&r.protocol==="orbitdb"&&r.hash)return r;const e="orbitdb",t=r.replace("/orbitdb/","").replace("\\orbitdb\\","");return{protocol:e,hash:t,address:r,toString:()=>Ko("/",e,t)}},lE=_f,uE=L2,Ine=Mr,kne=async({ipfs:r,storage:e}={})=>(e=e||await ic(await ii({size:1e5}),await $2({ipfs:r,pin:!0})),{get:async i=>{const o=await e.get(i),{value:a}=await Gl({bytes:o,codec:lE,hasher:uE});return a&&await e.put(i,o),a},create:async({name:i,type:o,accessController:a,meta:c})=>{if(!i)throw new Error("name is required");if(!o)throw new Error("type is required");if(!a)throw new Error("accessController is required");const l=Object.assign({name:i,type:o,accessController:a},c!==void 0?{meta:c}:{}),{cid:u,bytes:h}=await aa({value:l,codec:lE,hasher:uE}),d=u.toString(Ine);return await e.put(d,h),{hash:d,manifest:l}},close:async()=>{await e.close()}}),YC=async(r=32)=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="",n=0;for(;n<r;)t+=e.charAt(Math.floor(Math.random()*e.length)),n+=1;return t},XC=_f,ZC=L2,Tne=Mr,Cne=async({storage:r,type:e,params:t})=>{const n={type:e,...t},{cid:s,bytes:i}=await aa({value:n,codec:XC,hasher:ZC}),o=s.toString(Tne);return await r.put(o,i),o},cp="ipfs",H2=({write:r,storage:e}={})=>async({orbitdb:t,identities:n,address:s})=>{if(e=e||await ic(await ii({size:1e3}),await $2({ipfs:t.ipfs,pin:!0})),r=r||[t.identity.id],s){const o=await e.get(s.replaceAll("/ipfs/","")),{value:a}=await Gl({bytes:o,codec:XC,hasher:ZC});r=a.write}else s=await Cne({storage:e,type:cp,params:{write:r}}),s=Ko("/",cp,s);return{type:cp,address:s,write:r,canAppend:async o=>{const a=await n.getIdentity(o.identity);if(!a)return!1;const{id:c}=a;return r.includes(c)||r.includes("*")?await n.verifyIdentity(a):!1}}};H2.type=cp;const JC="orbitdb",eP=({write:r}={})=>async({orbitdb:e,identities:t,address:n,name:s})=>{n=n||s||await YC(64),r=r||[e.identity.id];const i=await e.open(n,{type:"keyvalue",AccessController:H2({write:r})});n=i.address;const o=async y=>{const w=await t.getIdentity(y.identity);if(!w)return!1;const{id:m}=w;return await h("write",m)||await h("admin",m)?await t.verifyIdentity(w):!1},a=async()=>{const y=[];for await(const m of i.iterator())y[m.key]=m.value;const w=m=>{const _=m[0];y[_]=new Set([...y[_]||[],...m[1]])};return Object.entries({...y,admin:new Set([...y.admin||[],...i.access.write])}).forEach(w),y},c=async y=>(await a())[y]||new Set([]),l=async()=>{await i.close()},u=async()=>{await i.drop()},h=async(y,w)=>{const m=new Set(await c(y));return m.has(w)||m.has("*")};return{type:JC,address:n,write:r,canAppend:o,capabilities:a,get:c,grant:async(y,w)=>{const m=new Set([...await i.get(y)||[],w]);await i.put(y,Array.from(m.values()))},revoke:async(y,w)=>{const m=new Set(await i.get(y)||[]);m.delete(w),m.size>0?await i.put(y,Array.from(m.values())):await i.del(y)},close:l,drop:u,events:i.events}};eP.type=JC;const n6={},Pne=r=>{if(!n6[r])throw new Error(`AccessController type '${r}' is not supported`);return n6[r]},tP=r=>{if(!r.type)throw new Error("AccessController does not contain required field 'type'.");n6[r.type]=r};tP(H2);tP(eP);const Dne="events",Rne=H2,One=async({ipfs:r,id:e,identity:t,identities:n,directory:s}={})=>{if(r==null)throw new Error("IPFS instance is a required argument.");e=e||await YC();const i=r.libp2p.peerId;s=s||"./orbitdb";let o;n?o=n.keystore:(o=await zC({path:Ko(s,"./keystore")}),n=await xne({ipfs:r,keystore:o})),t?t.provider&&(t=await n.createIdentity({...t})):t=await n.createIdentity({id:e});const a=await kne({ipfs:r});let c={};const l=async(d,{type:g,meta:y,sync:w,Database:m,AccessController:_,headsStorage:k,entryStorage:N,indexStorage:I,referencesCount:T,encryption:x}={})=>{let D,F,R;if(c[d])return c[d];if(Ane(d)){const O=cE(d);F=await a.get(O.hash);const P=F.accessController.split("/",2).pop();_=Pne(P)(),R=await _({orbitdb:{open:l,identity:t,ipfs:r},identities:n,address:F.accessController}),D=F.name,g=g||F.type,y=F.meta}else{g=g||Dne,_=_||Rne(),R=await _({orbitdb:{open:l,identity:t,ipfs:r},identities:n,name:d});const O=await a.create({name:d,type:g,accessController:R.address,meta:y});if(F=O.manifest,d=cE(O.hash),D=F.name,y=F.meta,c[d])return c[d]}if(m=m||hne(g)(),!m)throw new Error(`Unsupported database type: '${g}'`);d=d.toString();const C=await m({ipfs:r,identity:t,address:d,name:D,access:R,directory:s,meta:y,syncAutomatically:w,headsStorage:k,entryStorage:N,indexStorage:I,referencesCount:T,encryption:x});return C.events.on("close",u(d)),c[d]=C,C},u=d=>()=>{delete c[d]};return{id:e,open:l,stop:async()=>{for(const d of Object.values(c))await d.close();o&&await o.close(),a&&await a.close(),c={}},ipfs:r,directory:s,keystore:o,identities:n,identity:t,peerId:i}};function rP(r){return r[Symbol.asyncIterator]!=null}const z2=r=>{const e=At(r),t=dn(e);return is(r,t),z2.bytes=e,t};z2.bytes=0;function t8(r,e){e=e??{};const t=e.lengthEncoder??z2;function*n(s){const i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return rP(r)?async function*(){for await(const s of r)yield*n(s)}():function*(){for(const s of r)yield*n(s)}()}t8.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??z2;return new Ve(t(r.byteLength),r)};class Nne extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class Mne extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class Bne extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}class hE extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}const Lne=8,$ne=1024*1024*4;var La;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(La||(La={}));const r8=r=>{const e=Nc(r);return r8.bytes=At(e),e};r8.bytes=0;function s6(r,e){const t=new Ve;let n=La.LENGTH,s=-1;const i=e?.lengthDecoder??r8,o=e?.maxLengthLength??Lne,a=e?.maxDataLength??$ne;function*c(){for(;t.byteLength>0;){if(n===La.LENGTH)try{if(s=i(t),s<0)throw new Nne("Invalid message length");if(s>a)throw new Mne("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=La.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new Bne("Message length length too long");break}throw l}if(n===La.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=La.LENGTH}}}return rP(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new hE("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new hE("Unexpected end of input")}()}s6.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return s6(n,{...e??{},onLength:i=>{t=i}})};const ah=1e3,n8=60*ah,dE="/floodsub/1.0.0",fE="/meshsub/1.0.0",Une="/meshsub/1.1.0",mm="/meshsub/1.2.0",Fne=6,Vne=4,Kne=12,qne=4,Hne=2,zne=5,Wne=3,jne=6,Gne=.25,Qne=3,pE=100,Yne=ah,Xne=n8,Zne=16,Jne=n8,ese=10*ah,tse=15,rse=300,nse=ah,sse=60,ise=2,ose=10*ah,_l=5e3,ase=10,cse=3*ah,lse=2*n8,use=120*1e3,hse="ERR_TOPIC_VALIDATOR_REJECT",dse="ERR_TOPIC_VALIDATOR_IGNORE",fse=0,pse=128,gse=1e3,yse=1e3,mse=1,wse=512,bse=512,vse={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var ac;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.subscribe=s.bool();break}case 2:{a.topic=s.string();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)})(r.SubOpts||(r.SubOpts={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.seqno!=null&&(i.uint32(26),i.bytes(s.seqno)),s.topic!=null&&s.topic!==""&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={topic:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.from=s.bytes();break}case 2:{a.data=s.bytes();break}case 3:{a.seqno=s.bytes();break}case 4:{a.topic=s.string();break}case 5:{a.signature=s.bytes();break}case 6:{a.key=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.Message||(r.Message={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.ihave!=null)for(const a of s.ihave)i.uint32(10),r.ControlIHave.codec().encode(a,i);if(s.iwant!=null)for(const a of s.iwant)i.uint32(18),r.ControlIWant.codec().encode(a,i);if(s.graft!=null)for(const a of s.graft)i.uint32(26),r.ControlGraft.codec().encode(a,i);if(s.prune!=null)for(const a of s.prune)i.uint32(34),r.ControlPrune.codec().encode(a,i);if(s.idontwant!=null)for(const a of s.idontwant)i.uint32(42),r.ControlIDontWant.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.ihave!=null&&a.ihave.length===o.limits.ihave)throw new ft('Decode error - map field "ihave" had too many elements');a.ihave.push(r.ControlIHave.codec().decode(s,s.uint32(),{limits:o.limits?.ihave$}));break}case 2:{if(o.limits?.iwant!=null&&a.iwant.length===o.limits.iwant)throw new ft('Decode error - map field "iwant" had too many elements');a.iwant.push(r.ControlIWant.codec().decode(s,s.uint32(),{limits:o.limits?.iwant$}));break}case 3:{if(o.limits?.graft!=null&&a.graft.length===o.limits.graft)throw new ft('Decode error - map field "graft" had too many elements');a.graft.push(r.ControlGraft.codec().decode(s,s.uint32(),{limits:o.limits?.graft$}));break}case 4:{if(o.limits?.prune!=null&&a.prune.length===o.limits.prune)throw new ft('Decode error - map field "prune" had too many elements');a.prune.push(r.ControlPrune.codec().decode(s,s.uint32(),{limits:o.limits?.prune$}));break}case 5:{if(o.limits?.idontwant!=null&&a.idontwant.length===o.limits.idontwant)throw new ft('Decode error - map field "idontwant" had too many elements');a.idontwant.push(r.ControlIDontWant.codec().decode(s,s.uint32(),{limits:o.limits?.idontwant$}));break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.ControlMessage||(r.ControlMessage={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new ft('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.ControlIHave||(r.ControlIHave={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new ft('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.ControlIWant||(r.ControlIWant={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.ControlGraft||(r.ControlGraft={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.peers!=null)for(const a of s.peers)i.uint32(18),r.PeerInfo.codec().encode(a,i);s.backoff!=null&&(i.uint32(24),i.uint64Number(s.backoff)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={peers:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.peers!=null&&a.peers.length===o.limits.peers)throw new ft('Decode error - map field "peers" had too many elements');a.peers.push(r.PeerInfo.codec().decode(s,s.uint32(),{limits:o.limits?.peers$}));break}case 3:{a.backoff=s.uint64Number();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.ControlPrune||(r.ControlPrune={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.peerID!=null&&(i.uint32(10),i.bytes(s.peerID)),s.signedPeerRecord!=null&&(i.uint32(18),i.bytes(s.signedPeerRecord)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.peerID=s.bytes();break}case 2:{a.signedPeerRecord=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.PeerInfo||(r.PeerInfo={})),function(t){let n;t.codec=()=>(n==null&&(n=Pe((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new ft('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>Ce(s,t.codec()),t.decode=(s,i)=>Te(s,t.codec(),i)}(r.ControlIDontWant||(r.ControlIDontWant={}));let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const i of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(i,n);if(t.messages!=null)for(const i of t.messages)n.uint32(18),r.Message.codec().encode(i,n);t.control!=null&&(n.uint32(26),r.ControlMessage.codec().encode(t.control,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new ft('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new ft('Decode error - map field "messages" had too many elements');i.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=r.ControlMessage.codec().decode(t,t.uint32(),{limits:s.limits?.control});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(ac||(ac={}));class Ese{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,n){this.gossip=e,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(n==null)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&e.has(s.topic)){let o=t.get(s.topic);o==null&&(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}}var gE;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(gE||(gE={}));var Ru;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(Ru||(Ru={}));var Rs;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Rs||(Rs={}));var rn;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(rn||(rn={}));var sn;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(sn||(sn={}));function yE(r){switch(r){case Jn.Ignore:return Rs.Ignore;case Jn.Reject:return Rs.Reject;default:throw new Error("Unreachable")}}var mE;(function(r){r.forward="forward",r.publish="publish"})(mE||(mE={}));var ln;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(ln||(ln={}));var Js;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(Js||(Js={}));var ud;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(ud||(ud={}));var hd;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(hd||(hd={}));var Rl;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Rl||(Rl={}));function Sse(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:r.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:r.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){const o=this.toTopic(n);switch(s){case ln.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case ln.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case ln.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case ln.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case ln.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case ln.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(n,s,i){const o=this.toTopic(n);switch(s){case Js.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case Js.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case Js.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case Js.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(n,s,i){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){const o=this.toTopic(n.message.topic);switch(s){case Jn.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case Jn.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case Jn.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(const[i,o]of n){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onIdontwantRcv(n,s){this.idontwantRcvMsgids.inc(n),this.idontwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){const i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o,a){const c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},i*o),this.msgPublishPeersByTopic.inc({topic:c},i),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){const s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){const s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(n,s){const i=this.toTopic(n);switch(s){case sn.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case sn.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case sn.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(n,s){const i=this.toTopic(n),o=s.reason===Rs.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(n,s,i){const o=this.toTopic(n);this.duplicateMsgDeliveryDelay.observe({topic:o},s/1e3),i&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(n){const s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){const i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0,l=n.control.idontwant?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),l>0&&this.rpcSentIDontWant.inc(l),(i>0||o>0||a>0||c>0||l>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(const l of n)l>=s.graylistThreshold&&i++,l>=s.publishThreshold&&o++,l>=s.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:Rl.graylist},i),this.peersByScoreThreshold.set({threshold:Rl.publish},o),this.peersByScoreThreshold.set({threshold:Rl.gossip},a),this.peersByScoreThreshold.set({threshold:Rl.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){const i=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let l=i.get(c);l==null&&(l=new Set,i.set(c,l)),o.forEach(u=>l?.add(u))});for(const[o,a]of i){const c=[];a.forEach(l=>{c.push(s.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}class vt extends Error{static name="InvalidPeerScoreParamsError";constructor(e="Invalid peer score params"){super(e),this.name="InvalidPeerScoreParamsError"}}const _se={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},xse={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function Ase(r={}){return{..._se,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=Ise(n),e),{}):{}}}function Ise(r={}){return{...xse,...r}}function kse(r){for(const[e,t]of Object.entries(r.topics))try{Tse(t)}catch(n){throw new vt(`invalid score parameters for topic ${e}: ${n.message}`)}if(r.topicScoreCap<0)throw new vt("invalid topic score cap; must be positive (or 0 for no cap)");if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new vt("missing application specific score function");if(r.IPColocationFactorWeight>0)throw new vt("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new vt("invalid IPColocationFactorThreshold; must be at least 1");if(r.behaviourPenaltyWeight>0)throw new vt("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new vt("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(r.decayInterval<1e3)throw new vt("invalid DecayInterval; must be at least 1s");if(r.decayToZero<=0||r.decayToZero>=1)throw new vt("invalid DecayToZero; must be between 0 and 1")}function Tse(r){if(r.topicWeight<0)throw new vt("invalid topic weight; must be >= 0");if(r.timeInMeshQuantum===0)throw new vt("invalid TimeInMeshQuantum; must be non zero");if(r.timeInMeshWeight<0)throw new vt("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new vt("invalid TimeInMeshQuantum; must be positive");if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new vt("invalid TimeInMeshCap; must be positive");if(r.firstMessageDeliveriesWeight<0)throw new vt("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new vt("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new vt("invalid FirstMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight>0)throw new vt("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new vt("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new vt("invalid MeshMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new vt("invalid MeshMessageDeliveriesThreshold; must be positive");if(r.meshMessageDeliveriesWindow<0)throw new vt("invalid MeshMessageDeliveriesWindow; must be non-negative");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new vt("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(r.meshFailurePenaltyWeight>0)throw new vt("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new vt("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(r.invalidMessageDeliveriesWeight>0)throw new vt("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new vt("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const Cse={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function Pse(r={}){return{...Cse,...r}}function i6(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function Dse(r,e){return i6(r,e,()=>!0)}class Rse extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}}function Ose(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let g=a.meshTime/c.timeInMeshQuantum;g>c.timeInMeshCap&&(g=c.timeInMeshCap),l+=g*c.timeInMeshWeight}let u=a.firstMessageDeliveries;if(u>c.firstMessageDeliveriesCap&&(u=c.firstMessageDeliveriesCap),l+=u*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const g=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,y=g*g;l+=y*c.meshMessageDeliveriesWeight}const h=a.meshFailurePenalty;l+=h*c.meshFailurePenaltyWeight;const d=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=d*c.invalidMessageDeliveriesWeight,s+=l*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);const i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){const l=c-t.IPColocationFactorThreshold,u=l*l;s+=u*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}function Ut(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}Ut.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};Ut.prototype.get=function(e){return this.peekAt(e)};Ut.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};Ut.prototype.peekFront=function(){return this.peek()};Ut.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(Ut.prototype,"length",{get:function(){return this.size()}});Ut.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ut.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ut.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};Ut.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ut.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};Ut.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var i=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};Ut.prototype.remove=function(e,t){var n=e,s,i=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=o)return s=this.toArray(),this.clear(),s;n+t>o&&(t=o-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;i>0;)this._list[n=n-1+a&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};Ut.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,a,c=arguments.length,l=this._list.length,u=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>u;)this.unshift(arguments[--c]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+t));var h=o.length;for(i=0;i<h;i++)o[i]=this._list[this._head+n+t+i&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-h+l&this._capacityMask);u<c;)this.push(arguments[u++]);for(i=0;i<h;i++)this.push(o[i])}return a}else return this.remove(n,t)}};Ut.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};Ut.prototype.isEmpty=function(){return this._head===this._tail};Ut.prototype.toArray=function(){return this._copyArray(!1)};Ut.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var s=0;s<t;s++)this._list[s]=e[s]};Ut.prototype._copyArray=function(e,t){var n=this._list,s=n.length,i=this.length;if(t=t|i,t==i&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<s;c++)o[a++]=n[c];for(c=0;c<this._tail;c++)o[a++]=n[c]}else for(c=this._head;c<this._tail;c++)o[a++]=n[c];return o};Ut.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};Ut.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};Ut.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};var Nse=Ut;const Mse=Mc(Nse);var nn;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(nn||(nn={}));class Bse{records;queue;constructor(){this.records=new Map,this.queue=new Mse}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:nn.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+use};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class Lse{params;metrics;peerStats=new Map;peerIPs=new Rse(()=>new Set);scoreCache=new Map;deliveryRecords=new Bse;_backgroundInterval;scoreCacheValidityMs;computeScore;log;constructor(e,t,n,s){this.params=e,this.metrics=t,kse(e),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??Ose,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(t==null)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s!=null&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){const s=this.peerStats.get(e);s!=null&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n?.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n?.knownIPs.delete(t);const s=this.peerIPs.get(t);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);if(s!=null){const i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==nn.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeenTsMs,nn[s.status]);return}s.status=nn.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Rs.Error:this.markInvalidMessageDelivery(e,n);return;case Rs.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status!==nn.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeenTsMs,nn[i.status]);return}if(s===Rs.Ignore){i.status=nn.ignored,i.peers.clear();return}i.status=nn.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case nn.unknown:s.peers.add(e);break;case nn.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case nn.invalid:this.markInvalidMessageDelivery(e,n);break;case nn.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);if(s!=null){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s!=null){const i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o!=null&&o.inMesh){const a=this.params.topics[t];if(n!==void 0){const l=i-n,u=l>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,l,u),u)return}const c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const s=this.peerIPs.get(n);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function $se(r,e,t,n,s){let i=0;const o=new Map;if(Object.entries(e.topics).forEach(([d,g])=>{const y=s.get(d)??"unknown",w=t.topics[d];if(w===void 0)return;let m=o.get(y);m==null&&(m={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(y,m));let _=0,k=0,N=0,I=0,T=0;if(g.inMesh){const R=Math.max(g.meshTime/w.timeInMeshQuantum,w.timeInMeshCap);_+=R*w.timeInMeshWeight}let x=g.firstMessageDeliveries;if(x>w.firstMessageDeliveriesCap&&(x=w.firstMessageDeliveriesCap),k+=x*w.firstMessageDeliveriesWeight,g.meshMessageDeliveriesActive&&g.meshMessageDeliveries<w.meshMessageDeliveriesThreshold){const R=w.meshMessageDeliveriesThreshold-g.meshMessageDeliveries,C=R*R;N+=C*w.meshMessageDeliveriesWeight}const D=g.meshFailurePenalty;I+=D*w.meshFailurePenaltyWeight;const F=g.invalidMessageDeliveries*g.invalidMessageDeliveries;T+=F*w.invalidMessageDeliveriesWeight,i+=(_+k+N+I+T)*w.topicWeight,m.p1w+=_,m.p2w+=k,m.p3w+=N,m.p3bw+=I,m.p4w+=T}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;const d=t.topicScoreCap/i;for(const g of o.values())g.p1w*=d,g.p2w*=d,g.p3w*=d,g.p3bw*=d,g.p4w*=d}let a=0,c=0,l=0;const u=t.appSpecificScore(r);a+=u*t.appSpecificWeight,e.knownIPs.forEach(d=>{if(t.IPColocationFactorWhitelist.has(d))return;const g=n.get(d),y=g!=null?g.size:0;if(y>t.IPColocationFactorThreshold){const w=y-t.IPColocationFactorThreshold,m=w*w;c+=m*t.IPColocationFactorWeight}});const h=e.behaviourPenalty*e.behaviourPenalty;return l+=h*t.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function Use(r,e,t,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a!=null){const c=$se(o,a,t,n,s);for(const[l,u]of c.byTopic){let h=i.byTopic.get(l);h==null&&(h={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(l,h)),h.p1w.push(u.p1w),h.p2w.push(u.p2w),h.p3w.push(u.p3w),h.p3bw.push(u.p3bw),h.p4w.push(u.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}class Fse{rawStream;pushable;closeController;maxBufferSize;constructor(e,t,n){this.rawStream=e,this.pushable=ls(),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(s=>{e.abort(s)})}),Nn(this.pushable,this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(t8.single(e))}pushPrefixed(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return()}}class Vse{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(n=>{e.abort(n)})}),this.source=Nn(this.rawStream,n=>s6(n,t))}async close(){this.closeController.abort()}}class Kse{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o==null&&(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size===0&&this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case Rs.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const nP=ie("libp2p-pubsub:");async function qse(r,e,t,n){switch(r.type){case Ru.Signing:{const s={from:r.author.toMultihash().bytes,data:n,seqno:Yo(8),topic:e,signature:void 0,key:void 0},i=jr([nP,ac.Message.encode(s)]);s.signature=await r.privateKey.sign(i),s.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${se(s.seqno??new Uint8Array(0),"base16")}`),topic:e,signature:s.signature,key:Qr(s.key)};return{raw:s,msg:o}}case Ru.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function Hse(r,e){switch(r){case x6:return e.signature!=null?{valid:!1,error:rn.SignaturePresent}:e.seqno!=null?{valid:!1,error:rn.SeqnoPresent}:e.key!=null?{valid:!1,error:rn.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case yp:{if(e.seqno==null)return{valid:!1,error:rn.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:rn.InvalidSeqno};if(e.signature==null)return{valid:!1,error:rn.InvalidSignature};if(e.from==null)return{valid:!1,error:rn.InvalidPeerId};let t;try{t=Bn(ur(e.from))}catch{return{valid:!1,error:rn.InvalidPeerId}}let n;if(e.key!=null){if(n=Qr(e.key),t.publicKey!==void 0&&!n.equals(t.publicKey))return{valid:!1,error:rn.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:rn.InvalidPeerId};n=t.publicKey}const s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=jr([nP,ac.Message.encode(s)]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${se(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key!=null?Qr(e.key):n}}:{valid:!1,error:rn.InvalidSignature}}default:throw new Error("Unreachable")}}function Ks(r=[],e){return{subscriptions:[],messages:r,control:e!==void 0?{graft:e.graft??[],prune:e.prune??[],ihave:e.ihave??[],iwant:e.iwant??[],idontwant:e.idontwant??[]}:void 0}}function wE(r){return r.control===void 0&&(r.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),r}function Ai(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function zse(r){return se(r,"base64")}function Wse(r,e,t){switch(r){case yp:return{type:Ru.Signing,author:e,key:Rn(t.publicKey),privateKey:t};case x6:return{type:Ru.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const jse=(r,e)=>{const t=ie(e.toString(16).padStart(16,"0"),"base16"),n=Rn(r),s=new Uint8Array(n.byteLength+t.length);return s.set(n,0),s.set(t,n.byteLength),s};function Gse(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return jse(r.from.publicKey??r.key,r.sequenceNumber)}async function Qse(r){return fn.encode(r.data)}var eg;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(eg||(eg={}));function Yse(r){for(const e of r.tuples())switch(e[0]){case eg.ip4:case eg.ip6:return xL(e[0],e[1])}return null}class wm{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var xn;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(xn||(xn={}));class Xse extends $t{globalSignaturePolicy;multicodecs=[mm,Une,fE];publishConfig;dataTransform;peers=new Map;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=ls({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;idontwantCounts=new Map;idontwants=new Map;components;directPeerInitial=null;static multicodec=mm;opts;decodeRpcLimits;metrics;status={code:xn.stopped};maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();const n={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:Fne,Dlo:Vne,Dhi:Kne,Dscore:qne,Dout:Hne,Dlazy:jne,heartbeatInterval:Yne,fanoutTTL:Xne,mcacheLength:zne,mcacheGossip:Wne,seenTTL:lse,gossipsubIWantFollowupMs:cse,prunePeers:Zne,pruneBackoff:Jne,unsubcribeBackoff:ese,graftFloodThreshold:ose,opportunisticGraftPeers:ise,opportunisticGraftTicks:sse,directConnectTicks:rse,gossipFactor:Gne,idontwantMinDataSize:wse,idontwantMaxMessages:bse,...t,scoreParams:Ase(t.scoreParams),scoreThresholds:Pse(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??vse,this.globalSignaturePolicy=n.globalSignaturePolicy??yp,n.fallbackToFloodsub&&this.multicodecs.push(dE),this.log=e.logger.forComponent(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new wm({validityMs:n.seenTTL}),this.publishedMessageIds=new wm({validityMs:n.seenTTL}),t.msgIdFn!=null)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case yp:this.msgIdFn=Gse;break;case x6:this.msgIdFn=Qse;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(t.fastMsgIdFn!=null&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new wm({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??zse,this.mcache=t.messageCache??new Ese(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform!=null&&(this.dataTransform=t.dataTransform),t.metricsRegister!=null){if(t.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),yse),i=Sse(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});i.mcacheSize.addCollect(()=>{this.onScrapeMetrics(i)});for(const o of this.multicodecs)i.protocolsEnabled.set({protocol:o},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new Kse(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new Lse(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.runOnLimitedConnection=t.runOnLimitedConnection,this.allowedTopics=n.allowedTopics!=null?new Set(n.allowedTopics):null}[Symbol.toStringTag]="@chainsafe/libp2p-gossipsub";[lr]=["@libp2p/pubsub"];[jo]=["@libp2p/identify"];getPeers(){return[...this.peers.values()]}isStarted(){return this.status.code===xn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=Wse(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=ls({objectMode:!0}),Nn(this.outboundInflightQueue,async i=>{for await(const{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>{this.log.error("outbound inflight queue error",i)}),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.merge(i.id,{multiaddrs:i.addrs})}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},n=await Promise.all(this.multicodecs.map(async i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,pE);this.status={code:xn.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+pE},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>this.connect(i)))}).catch(i=>{this.log(i)})},nse),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==xn.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:xn.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const t=this.components.registrar;await Promise.all(this.multicodecs.map(async s=>t.unhandle(s))),e.forEach(s=>{t.unregister(s)}),this.outboundInflightQueue.end();const n=[];for(const s of this.streamsOutbound.values())n.push(s.close());this.streamsOutbound.clear();for(const s of this.streamsInbound.values())n.push(s.close());this.streamsInbound.clear(),await Promise.all(n),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),!(!this.isStarted()||t.status!=="open")&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new Fse(await t.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),o=>{this.log.error("outbound pipe error",o)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const i=s.protocol;i===dE&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close().catch(o=>{this.log.error(o)})),this.log("create inbound stream %s",n);const i=new Vse(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>{this.log(o)})}addPeer(e,t,n){const s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.set(s,e),this.score.addPeer(s);const i=Yse(n);i!==null?this.score.addIP(s,i):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n!=null&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close().catch(i=>{this.log.error(i)}),s?.close().catch(i=>{this.log.error(i)}),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const i of this.topics.values())i.delete(t);for(const[i,o]of this.mesh)o.delete(t)&&this.metrics?.onRemoveFromMesh(i,Js.Dc,1);for(const i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.idontwantCounts.delete(t),this.idontwants.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===xn.started}getMeshPeers(e){const t=this.mesh.get(e);return t!=null?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t!=null?Array.from(t):[]).map(n=>this.peers.get(n)??nr(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await Nn(t,async n=>{for await(const s of n)try{const i=s.subarray(),o=ac.decode(i,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if(this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,o)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,o).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(i){this.metrics?.onRpcDataError(),this.log(i)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}const n=t.subscriptions!=null?t.subscriptions.length:0,s=t.messages!=null?t.messages.length:0;let i=0,o=0,a=0,c=0;if(t.control!=null&&(t.control.ihave!=null&&(i=t.control.ihave.length),t.control.iwant!=null&&(o=t.control.iwant.length),t.control.graft!=null&&(a=t.control.graft.length),t.control.prune!=null&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${s} ihave ${i} iwant ${o} graft ${a} prune ${c}`),t.subscriptions!=null&&t.subscriptions.length>0){const l=[];t.subscriptions.forEach(u=>{const h=u.topic,d=u.subscribe===!0;if(h!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(h))return;this.handleReceivedSubscription(e,h,d),l.push({topic:h,subscribe:d})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:l}})}for(const l of t.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(l.topic))continue;const u=this.handleReceivedMessage(e,l).catch(h=>{this.metrics?.onMsgRecvError(l.topic),this.log(h)});this.opts.awaitRpcMessageHandler&&await u}t.control!=null&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);this.metrics?.onPrevalidationResult(t.topic,n.code);const s=n.code;switch(s){case sn.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case sn.invalid:if(n.msgIdStr!=null){const i=n.msgIdStr;this.score.rejectMessage(e.toString(),i,t.topic,n.reason),this.gossipTracer.rejectMessage(i,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case sn.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString());break;default:throw new Error(`Invalid validation result: ${s}`)}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s!=null)return{code:sn.duplicate,msgIdStr:s};const i=await Hse(this.globalSignaturePolicy,t);if(!i.valid)return{code:sn.invalid,reason:Rs.Error,error:i.error};const o=i.message;try{this.dataTransform!=null&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(h){return this.log("Invalid message, transform failed",h),{code:sn.invalid,reason:Rs.Error,error:rn.TransformFailed}}const a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),l={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:sn.duplicate,msgIdStr:c};this.seenCache.put(c),(t.data?.length??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(a,t.topic,e.toString());const u=this.topicValidators.get(t.topic);if(u!=null){let h;try{h=await u(e,o)}catch(d){const g=d.code;g===dse&&(h=Jn.Ignore),g===hse?h=Jn.Reject:h=Jn.Ignore}if(h!==Jn.Accept)return{code:sn.invalid,reason:yE(h),msgIdStr:c}}return{code:sn.valid,messageId:l,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n})),messages:[]})}async handleControlMessage(e,t){if(t===void 0)return;const n=t.ihave?.length>0?this.handleIHave(e,t.ihave):[],s=t.iwant?.length>0?this.handleIWant(e,t.iwant):[],i=t.graft?.length>0?await this.handleGraft(e,t.graft):[];if(t.prune?.length>0&&await this.handlePrune(e,t.prune),t.idontwant?.length>0&&this.handleIdontwant(e,t.idontwant),n.length===0&&s.length===0&&i.length===0)return;const o=this.sendRpc(e,Ks(s,{iwant:n,prune:i})),a=n[0]?.messageIDs;a!=null&&(o?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n!=null&&n.messagesAccepted<pse&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=fse?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+gse}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(t.length===0)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:hd.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>ase)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:hd.MaxIhave}),[];const i=this.iasked.get(e)??0;if(i>=_l)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:hd.MaxIasked}),[];const o=new Map;if(t.forEach(({topicID:l,messageIDs:u})=>{if(l==null||u==null||!this.mesh.has(l))return;let h=0;u.forEach(d=>{const g=this.msgIdToStrFn(d);this.seenCache.has(g)||(o.set(g,d),h++)}),this.metrics?.onIhaveRcv(l,u.length,h)}),o.size===0)return[];let a=o.size;a+i>_l&&(a=_l-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return Ai(c),c=c.slice(0,a),this.iasked.set(e,i+a),[{messageIDs:c}]}handleIWant(e,t){if(t.length===0)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,i=new Map;let o=0;return t.forEach(({messageIDs:a})=>{a?.forEach(c=>{const l=this.msgIdToStrFn(c),u=this.mcache.getWithIWantCount(l,e);if(u==null){o++;return}if(i.set(u.msg.topic,1+(i.get(u.msg.topic)??0)),u.count>Qne){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(l,u.msg)})}),this.metrics?.onIwantRcv(i,o),s.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values()))}async handleGraft(e,t){const n=[],s=this.score.score(e),i=Date.now();let o=this.opts.doPX;if(t.forEach(({topicID:c})=>{if(c==null)return;const l=this.mesh.get(c);if(l==null){o=!1;return}if(l.has(e))return;const u=this.backoff.get(c)?.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),n.push(c),o=!1;else if(typeof u=="number"&&i<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,ud.GraftBackoff),o=!1;const h=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<h&&this.score.addPenalty(e,1,ud.GraftBackoff),this.addBackoff(e,c),n.push(c)}else s<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,c),n.push(c),o=!1,this.addBackoff(e,c)):l.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)?(n.push(c),this.addBackoff(e,c)):(this.log("GRAFT: Add mesh link from %s in %s",e,c),this.score.graft(e,c),l.add(e),this.metrics?.onAddToMesh(c,ln.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:c,direction:"inbound"}})}),n.length===0)return[];const a=!1;return Promise.all(n.map(async c=>this.makePrune(e,c,o,a)))}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;const a=this.mesh.get(s);if(a==null)return;this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,Js.Prune,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o!=null&&o.length>0&&(n<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s):await this.pxConnect(o)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:s,direction:"inbound"}})}}handleIdontwant(e,t){let n=this.idontwantCounts.get(e)??0;if(n>=this.opts.idontwantMaxMessages)return;const s=n;let i=this.idontwants.get(e);i==null&&(i=new Map,this.idontwants.set(e,i));let o=0;e:for(const{messageIDs:c}of t)for(const l of c){if(n>=this.opts.idontwantMaxMessages)break e;n++;const u=this.msgIdToStrFn(l);i.set(u,this.heartbeatTicks),this.mcache.msgs.has(u)||o++}this.idontwantCounts.set(e,n);const a=n-s;this.metrics?.onIdontwantRcv(a,o)}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s==null&&(s=new Map,this.backoff.set(t,s));const i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,ud.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%tse!==0)return;const e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s+mse*this.opts.heartbeatInterval<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(Ai(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async n=>{if(n.peerID==null)return;const s=Bn(ur(n.peerID)),i=s.toString();if(!this.peers.has(i)){if(n.signedPeerRecord==null){t.push(i);return}try{if(!await this.components.peerStore.consumePeerRecord(n.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(i)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length!==0&&await Promise.all(t.map(async n=>this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);const t=nr(e),n=await this.components.connectionManager.openConnection(t);for(const s of this.multicodecs)for(const i of this.components.registrar.getTopologies(s))i.onConnect?.(t,n)}subscribe(e){if(this.status.code!==xn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==xn.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==xn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.backoff.get(e),s=this.fanout.get(e);if(s!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),s.forEach(i=>{!this.direct.has(i)&&this.score.score(i)>=0&&n?.has(i)!==!0&&t.add(i)}),this.metrics?.onAddToMesh(e,ln.Fanout,t.size)),t.size<this.opts.D){const i=t.size;this.getRandomGossipPeers(e,this.opts.D,a=>!t.has(a)&&!this.direct.has(a)&&this.score.score(a)>=0&&n?.has(a)!==!0).forEach(a=>{t.add(a)}),this.metrics?.onAddToMesh(e,ln.Random,t.size-i)}this.mesh.set(e,t),t.forEach(i=>{this.log("JOIN: Add mesh link to %s in %s",i,e),this.sendGraft(i,e)})}leave(e){if(this.status.code!==xn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t!=null&&(Promise.all(Array.from(t).map(async n=>{this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)})).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,i=this.topics.get(e);i!=null&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!(n?.has(a)??!1)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!(n?.has(a)??!1)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));const o=this.mesh.get(e);return o!=null&&o.size>0&&o.forEach(a=>{t!==a&&!(n?.has(a)??!1)&&s.add(a)}),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s!=null)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});const i=this.mesh.get(e);if(i!=null&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++}),i.size<this.opts.D&&this.getRandomGossipPeers(e,this.opts.D-i.size,a=>!i.has(a)&&!this.direct.has(a)&&!this.floodsubPeers.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold).forEach(a=>{t.add(a),n.mesh++});else{const o=this.fanout.get(e);if(o!=null&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{const a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n!=null&&this.score.deliverMessage(n,e,t.topic);const i=this.selectPeersToForward(t.topic,n,s);i.forEach(o=>{this.sendRpc(o,Ks([t]))}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t,n){const s=Date.now(),i=this.dataTransform!=null?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:o,msg:a}=await qse(this.publishConfig,e,t,i),c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(l)){if(u)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:h,tosendCount:d}=this.selectPeersToPublish(e),g=this.opts.emitSelf&&this.subscriptions.has(e),y=n?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(h.size===0&&!y&&!g)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(l),this.mcache.put({msgId:c,msgIdStr:l},o,!0),this.publishedMessageIds.put(l);const w=n?.batchPublish??this.opts.batchPublish,m=Ks([o]);if(w)this.sendRpcInBatch(h,m);else for(const k of h)this.sendRpc(k,m)||h.delete(k);const _=Date.now()-s;return this.metrics?.onPublishMsg(e,d,h.size,o.data!=null?o.data.length:0,_),g&&(h.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:l,msg:a}})),super.dispatchEvent(new CustomEvent("message",{detail:a}))),{recipients:Array.from(h.values()).map(k=>this.peers.get(k)??nr(k))}}sendRpcInBatch(e,t){const n=ac.encode(t),s=t8.single(n);for(const i of e){const o=this.streamsOutbound.get(i);if(o==null){this.log(`Cannot send RPC to ${i} as there is no open stream to it available`),e.delete(i);continue}try{o.pushPrefixed(s)}catch(a){e.delete(i),this.log.error(`Cannot send rpc to ${i}`,a)}this.metrics?.onRpcSent(t,n.length)}}reportMessageValidationResult(e,t,n){let s;if(n===Jn.Accept){if(s=this.mcache.validate(e),s!=null){const{message:o,originatingPeers:a}=s;this.score.deliverMessage(t,e,o.topic),this.forwardMessage(e,s.message,t,a)}}else if(s=this.mcache.remove(e),s!=null){const o=yE(n),{message:a,originatingPeers:c}=s;this.score.rejectMessage(t,e,a.topic,o);for(const l of c)this.score.rejectMessage(l,e,a.topic,o)}const i=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(s,n,i)}sendGraft(e,t){const s=Ks([],{graft:[{topicID:t}]});this.sendRpc(e,s)}async sendPrune(e,t){const s=[await this.makePrune(e,t,this.opts.doPX,!0)],i=Ks([],{prune:s});this.sendRpc(e,i)}sendIDontWants(e,t,n){const s=this.mesh.get(t);if(s==null)return;const i=new Set(s);i.delete(n);for(const a of i)this.streamsOutbound.get(a)?.protocol!==mm&&i.delete(a);const o=Ks([],{idontwant:[{messageIDs:[e]}]});this.sendRpcInBatch(i,o)}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(n==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s!=null&&(this.piggybackControl(e,t,s),this.control.delete(e));const i=this.gossip.get(e);i!=null&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));const o=ac.encode(t);try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s!=null&&this.control.set(e,s),i!=null&&this.gossip.set(e,i),!1}if(this.metrics?.onRpcSent(t,o.length),t.control?.graft!=null)for(const a of t.control?.graft)a.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:a.topicID,direction:"outbound"}});if(t.control?.prune!=null)for(const a of t.control?.prune)a.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:a.topicID,direction:"outbound"}});return!0}piggybackControl(e,t,n){const s=wE(t);for(const i of n.graft)i.topicID!=null&&(this.mesh.get(i.topicID)?.has(e)??!1)&&s.control.graft.push(i);for(const i of n.prune)i.topicID!=null&&!(this.mesh.get(i.topicID)?.has(e)??!1)&&s.control.prune.push(i)}piggybackGossip(e,t,n){const s=wE(t);s.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX,i=!1;for(const[o,a]of e){const c=a.map(h=>({topicID:h}));let l=[];const u=t.get(o);u!=null&&(l=await Promise.all(u.map(async h=>this.makePrune(o,h,s&&!(n.get(o)??!1),i))),t.delete(o)),this.sendRpc(o,Ks([],{graft:c,prune:l}))}for(const[o,a]of t){const c=await Promise.all(a.map(async l=>this.makePrune(o,l,s&&!(n.get(o)??!1),i)));this.sendRpc(o,Ks([],{prune:c}))}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(n.length===0||(Ai(n),n.length>_l&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),t.size===0))return;let s=this.opts.Dlazy;const o=this.opts.gossipFactor*t.size;let a=t;o>s&&(s=o),s>a.size?s=a.size:a=Ai(Array.from(a)).slice(0,s),a.forEach(c=>{let l=n;n.length>_l&&(l=Ai(l.slice()).slice(0,_l)),this.pushGossip(c,{topicID:e,messageIDs:l})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,Ks([],{ihave:t}));for(const[e,t]of this.control.entries()){this.control.delete(e);const n=Ks([],{graft:t.graft,prune:t.prune});this.sendRpc(e,n)}}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)??[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n,s){if(this.score.prune(e,t),this.streamsOutbound.get(e)?.protocol===fE)return{topicID:t,peers:[]};const i=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,o=i/1e3;if(this.doAddBackoff(e,t,i),!n)return{topicID:t,peers:[],backoff:o};const a=this.getRandomGossipPeers(t,this.opts.prunePeers,l=>l!==e&&this.score.score(l)>=0),c=await Promise.all(Array.from(a).map(async l=>{const u=this.peers.get(l)??nr(l);let h;try{h=await this.components.peerStore.get(u)}catch(d){if(d.name!=="NotFoundError")throw d}return{peerID:u.toMultihash().bytes,signedPeerRecord:h?.peerRecordEnvelope}}));return{topicID:t,peers:c,backoff:o}}runHeartbeat=()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(t=>{this.log("Error running heartbeat",t)}).finally(()=>{if(e?.(),this.status.code===xn.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;t<this.opts.heartbeatInterval*.25&&(t+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}})};async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const a=new Map,c=y=>{let w=a.get(y);return w===void 0&&(w=this.score.score(y),a.set(y,w)),w},l=new Map,u=new Map,h=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const y of this.idontwants.values())for(const[w,m]of y)this.heartbeatTicks-m>=this.opts.mcacheLength&&y.delete(w);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const d=new Map;this.mesh.forEach((y,w)=>{const m=this.topics.get(w),_=new Set,k=new Set;if(d.set(w,k),m!=null){const T=Ai(Array.from(m)),x=this.backoff.get(w);for(const D of T){const F=this.streamsOutbound.get(D);if(F!=null&&this.multicodecs.includes(F.protocol)&&!y.has(D)&&!this.direct.has(D)){const R=c(D);x?.has(D)!==!0&&R>=0&&_.add(D),R>=this.opts.scoreThresholds.gossipThreshold&&k.add(D)}}}const N=(T,x)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",T,w),this.addBackoff(T,w),y.delete(T),c(T)>=this.opts.scoreThresholds.gossipThreshold&&k.add(T),this.metrics?.onRemoveFromMesh(w,x,1);const D=u.get(T);D==null?u.set(T,[w]):D.push(w)},I=(T,x)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",T,w),this.score.graft(T,w),y.add(T),k.delete(T),this.metrics?.onAddToMesh(w,x,1);const D=l.get(T);D==null?l.set(T,[w]):D.push(w)};if(y.forEach(T=>{const x=c(T);x<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",T,x,w),N(T,Js.BadScore),h.set(T,!0))}),y.size<t){const T=e-y.size;Dse(_,T).forEach(D=>{I(D,ln.NotEnough)})}if(y.size>n){let T=Array.from(y);T.sort((D,F)=>c(F)-c(D)),T=T.slice(0,s).concat(Ai(T.slice(s)));let x=0;if(T.slice(0,e).forEach(D=>{(this.outbound.get(D)??!1)&&x++}),x<i){const D=R=>{const C=T[R];for(let O=R;O>0;O--)T[O]=T[O-1];T[0]=C};if(x>0){let R=x;for(let C=1;C<e&&R>0;C++)(this.outbound.get(T[C])??!1)&&(D(C),R--)}let F=e-x;for(let R=e;R<T.length&&F>0;R++)(this.outbound.get(T[R])??!1)&&(D(R),F--)}T.slice(e).forEach(D=>{N(D,Js.Excess)})}if(y.size>=t){let T=0;if(y.forEach(x=>{(this.outbound.get(x)??!1)&&T++}),T<i){const x=i-T;i6(_,x,F=>this.outbound.get(F)===!0).forEach(F=>{I(F,ln.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&y.size>1){const T=Array.from(y).sort((F,R)=>c(F)-c(R)),x=Math.floor(y.size/2),D=c(T[x]);if(D<this.opts.scoreThresholds.opportunisticGraftThreshold){const F=this.opts.opportunisticGraftPeers,R=i6(_,F,C=>c(C)>D);for(const C of R)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",C,w),I(C,ln.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((y,w)=>{y+o<g&&(this.fanout.delete(w),this.fanoutLastpub.delete(w))}),this.fanout.forEach((y,w)=>{const m=this.topics.get(w);y.forEach(I=>{(!(m?.has(I)??!1)||c(I)<this.opts.scoreThresholds.publishThreshold)&&y.delete(I)});const _=this.topics.get(w),k=[],N=new Set;if(d.set(w,N),_!=null){const I=Ai(Array.from(_));for(const T of I){const x=this.streamsOutbound.get(T);if(x!=null&&this.multicodecs.includes(x.protocol)&&!y.has(T)&&!this.direct.has(T)){const D=c(T);D>=this.opts.scoreThresholds.publishThreshold&&k.push(T),D>=this.opts.scoreThresholds.gossipThreshold&&N.add(T)}}}if(y.size<e){const I=e-y.size;k.slice(0,I).forEach(T=>{y.add(T),N?.delete(T)})}}),this.emitGossip(d),await this.sendGraftPrune(l,u,h),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){const s=this.topics.get(e);if(s==null)return new Set;let i=[];return s.forEach(o=>{const a=this.streamsOutbound.get(o);a!=null&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=Ai(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;const n=Date.now();e.connectedPeersBackoffSec.reset();for(const c of this.backoff.values()){t+=c.size;for(const[l,u]of c.entries())this.peers.has(l)&&e.connectedPeersBackoffSec.observe(Math.max(0,u-n)/1e3)}e.cacheSize.set({cache:"backoff"},t);let s=0;for(const c of this.idontwants.values())s+=c.size;e.cacheSize.set({cache:"idontwants"},s);for(const[c,l]of this.topics)e.topicPeersCount.set({topicStr:c},l.size);for(const[c,l]of this.mesh)e.meshPeerCounts.set({topicStr:c},l.size);const i=[],o=new Map;e.behaviourPenalty.reset();for(const c of this.peers.keys()){const l=this.score.score(c);i.push(l),o.set(c,l),e.behaviourPenalty.observe(this.score.peerStats.get(c)?.behaviourPenalty??0)}e.registerScores(i,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,o);const a=Use(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(a)}tagMeshPeer=e=>{const{peerId:t,topic:n}=e.detail;this.components.peerStore.merge(this.peers.get(t)??nr(t),{tags:{[n]:{value:100}}}).catch(s=>{this.log.error("Error tagging peer %s with topic %s",t,n,s)})};untagMeshPeer=e=>{const{peerId:t,topic:n}=e.detail;this.components.peerStore.merge(this.peers.get(t)??nr(t),{tags:{[n]:void 0}}).catch(s=>{this.log.error("Error untagging peer %s with topic %s",t,n,s)})}}function Zse(r={}){return e=>new Xse(e,r)}var tg;(function(r){let e;r.codec=()=>(e==null&&(e=Pe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:ze(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Ce(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(tg||(tg={}));const Jse="_peer-discovery._p2p._pubsub";class eie extends $t{[wd]=!0;[Symbol.toStringTag]="@libp2p/pubsub-peer-discovery";interval;listenOnly;topics;intervalId;components;log;constructor(e,t={}){super();const{interval:n,topics:s,listenOnly:i}=t;this.components=e,this.interval=n??1e4,this.listenOnly=i??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(s)&&s.length>0?this.topics=s:this.topics=[Jse],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.subscribe(t),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.unsubscribe(t),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const t={publicKey:Rn(e.publicKey),addrs:this.components.addressManager.getAddresses().map(i=>i.bytes)},n=tg.encode(t),s=this.components.pubsub;if(s==null)throw new Error("PubSub not configured");for(const i of this.topics){if(s.getSubscribers(i).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",i);continue}this.log("broadcasting our peer data on topic %s",i),s.publish(i,n)}}_onMessage(e){if(!this.isStarted())return;const t=e.detail;if(this.topics.includes(t.topic))try{const n=tg.decode(t.data),s=Qr(n.publicKey),i=uc(s);if(i.equals(this.components.peerId))return;this.log("discovered peer %p on %s",i,t.topic),this.safeDispatchEvent("peer",{detail:{id:i,multiaddrs:n.addrs.map(o=>De(o))}})}catch(n){this.log.error("error handling incoming message",n)}}}function tie(r={}){return e=>new eie(e,r)}class rie extends Rx{db;opts;constructor(e,t={}){super(),this.db=typeof e=="string"?new Y5(e,{...t,keyEncoding:"utf8",valueEncoding:"view"}):e,this.opts={createIfMissing:!0,compression:!1,...t}}async open(){try{await this.db.open(this.opts)}catch(e){throw new kd(String(e))}}async put(e,t,n){try{return n?.signal?.throwIfAborted(),await Et(this.db.put(e.toString(),t),n?.signal),e}catch(s){throw new Td(String(s))}}async get(e,t){let n;try{t?.signal?.throwIfAborted(),n=await Et(this.db.get(e.toString()),t?.signal)}catch(s){throw s.notFound!=null?new Jo(String(s)):new Cd(String(s))}return n}async has(e,t){try{t?.signal?.throwIfAborted(),await Et(this.db.get(e.toString()),t?.signal)}catch(n){if(n.notFound!=null)return!1;throw n}return!0}async delete(e,t){try{t?.signal?.throwIfAborted(),await Et(this.db.del(e.toString()),t?.signal)}catch(n){throw new Pd(String(n))}}async close(){await this.db.close()}batch(){const e=[];return{put:(t,n)=>{e.push({type:"put",key:t.toString(),value:n})},delete:t=>{e.push({type:"del",key:t.toString()})},commit:async t=>{if(this.db.batch==null)throw new Error("Batch operations unsupported by underlying Level");t?.signal?.throwIfAborted(),await Et(this.db.batch(e),t?.signal)}}}query(e,t){let n=yc(this._query({values:!0,prefix:e.prefix}),o=>(t?.signal?.throwIfAborted(),o));Array.isArray(e.filters)&&(n=e.filters.reduce((o,a)=>xs(o,a),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,a)=>Vp(o,a),n));const{offset:s,limit:i}=e;if(s!=null){let o=0;n=xs(n,()=>o++>=s)}return i!=null&&(n=cu(n,i)),n}queryKeys(e,t){let n=yc(this._query({values:!1,prefix:e.prefix}),({key:o})=>(t?.signal?.throwIfAborted(),o));Array.isArray(e.filters)&&(n=e.filters.reduce((o,a)=>xs(o,a),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,a)=>Vp(o,a),n));const{offset:s,limit:i}=e;if(s!=null){let o=0;n=xs(n,()=>o++>=s)}return i!=null&&(n=cu(n,i)),n}_query(e){const t={keys:!0,keyEncoding:"buffer",values:e.values};if(e.prefix!=null){const s=e.prefix.toString();t.gte=s,t.lt=s+"ÿ"}const n=this.db.iterator(t);if(n[Symbol.asyncIterator]!=null)return nie(n);if(n.next!=null&&n.end!=null)return sie(n);throw new Error("Level returned incompatible iterator")}}async function*nie(r){for await(const[e,t]of r)yield{key:new wt(e,!1),value:t};await r.close()}function sie(r){return{[Symbol.asyncIterator](){return{next:async()=>new Promise((e,t)=>{r.next((n,s,i)=>{if(n!=null){t(n);return}if(s==null){r.end(o=>{if(o!=null){t(o);return}e({done:!0,value:void 0})});return}e({done:!1,value:{key:new wt(s,!1),value:i}})})}),return:async()=>new Promise((e,t)=>{r.end(n=>{if(n!=null){t(n);return}e({done:!0,value:void 0})})})}}}}class iie extends Aw{db;opts;base;constructor(e,t={}){super(),this.db=typeof e=="string"?new Y5(e,{...t,keyEncoding:"utf8",valueEncoding:"view"}):e,this.opts={createIfMissing:!0,compression:!1,...t},this.base=t.base??mS}#e(e){return`/${this.base.encoder.encode(e.multihash.bytes)}`}#t(e){return $e.createV1(lf,ur(this.base.decoder.decode(e.substring(1))))}async open(){try{await this.db.open(this.opts)}catch(e){throw new kd(String(e))}}async put(e,t,n){try{n?.signal?.throwIfAborted(),await Et(this.db.put(this.#e(e),t),n?.signal)}catch(s){throw new Td(String(s))}return e}async get(e,t){try{return t?.signal?.throwIfAborted(),await Et(this.db.get(this.#e(e)),t?.signal)}catch(n){throw n.notFound!=null?new Jo(String(n)):new Cd(String(n))}}async has(e,t){try{t?.signal?.throwIfAborted(),await Et(this.db.get(this.#e(e)),t?.signal)}catch(n){if(n.notFound!=null)return!1;throw n}return!0}async delete(e,t){try{t?.signal?.throwIfAborted(),await Et(this.db.del(this.#e(e)),t?.signal)}catch(n){throw new Pd(String(n))}}async close(){await this.db.close()}async*getAll(e){e?.signal?.throwIfAborted();for await(const{key:t,value:n}of this.#r({values:!0},e))yield{cid:this.#t(t),block:n}}async*#r(e,t){t?.signal?.throwIfAborted();const n={keys:!0,keyEncoding:"buffer",values:e.values};if(e.prefix!=null){const i=e.prefix.toString();n.gte=i,n.lt=i+"ÿ"}const s=this.db.iterator(n);try{for await(const[i,o]of s)t?.signal?.throwIfAborted(),yield{key:new TextDecoder().decode(i),value:o},t?.signal?.throwIfAborted()}finally{await s.close()}}}class sP{constructor(e="http://localhost:3000"){this.relayHttpUrl=e,this.cachedAddrs=null,this.lastFetch=null,this.cacheTTL=5*60*1e3,this.storageKey="libp2p-relay-discovery",this.loadFromStorage()}async discoverWebRTCAddrs(){if(this.cachedAddrs&&this.lastFetch&&Date.now()-this.lastFetch<this.cacheTTL)return this.cachedAddrs;try{console.log("🔍 Discovering WebRTC multiaddrs from relay server...");const e=await fetch(`${this.relayHttpUrl}/multiaddrs`);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.json(),n={peerId:t.peerId,timestamp:t.timestamp,all:t.all,webrtc:t.webrtc,direct:t.webrtc.find(s=>s.includes("/tcp/")&&s.includes("/webrtc")),circuitRelay:t.webrtc.find(s=>s.includes("/p2p-circuit/webrtc")),websocket:t.all.find(s=>s.includes("/ws"))};return this.cachedAddrs=n,this.lastFetch=Date.now(),this.saveToStorage(),console.log("✅ WebRTC addresses discovered:",{direct:n.direct,circuitRelay:n.circuitRelay,cached:"saved to localStorage"}),n}catch(e){throw console.error("❌ Failed to discover WebRTC addresses:",e),e}}async getBestWebRTCAddr(){try{const e=await this.discoverWebRTCAddrs();return e.direct?(console.log("🎯 Using direct WebRTC address:",e.direct),e.direct):e.circuitRelay?(console.log("🔄 Using circuit relay WebRTC address:",e.circuitRelay),e.circuitRelay):(console.warn("⚠️ No WebRTC addresses available"),null)}catch(e){return console.error("❌ Failed to get WebRTC address:",e),null}}async isRelayHealthy(){try{return(await fetch(`${this.relayHttpUrl}/health`)).ok}catch(e){return console.error("Health check failed:",e),!1}}loadFromStorage(){if(!(typeof window>"u"||!window.localStorage))try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);t.lastFetch&&Date.now()-t.lastFetch<this.cacheTTL?(this.cachedAddrs=t.addresses,this.lastFetch=t.lastFetch,console.log("📦 Loaded WebRTC addresses from localStorage cache")):(console.log("🕒 Cached WebRTC addresses expired, will fetch fresh ones"),this.clearStoredCache())}}catch(e){console.warn("Failed to load cached addresses:",e),this.clearStoredCache()}}saveToStorage(){if(!(typeof window>"u"||!window.localStorage||!this.cachedAddrs))try{const e={addresses:this.cachedAddrs,lastFetch:this.lastFetch};localStorage.setItem(this.storageKey,JSON.stringify(e)),console.log("💾 Saved WebRTC addresses to localStorage cache")}catch(e){console.warn("Failed to save addresses to cache:",e)}}clearCache(){this.cachedAddrs=null,this.lastFetch=null,this.clearStoredCache()}clearStoredCache(){typeof window<"u"&&window.localStorage&&localStorage.removeItem(this.storageKey)}}new sP;class oie{constructor(){this.healthChecks=[],this.recoveryActions=[]}async checkDatabaseHealth(e={}){const{libp2p:t=null,helia:n=null,orbitdb:s=null,todoDB:i=null,verbose:o=!0}=e,a={timestamp:new Date().toISOString(),overall:"unknown",checks:{},recommendations:[],errors:[]};return o&&console.log("🏥 Starting comprehensive database health check..."),a.checks.libp2p=await this.checkLibP2PHealth(t),a.checks.helia=await this.checkHeliaHealth(n),a.checks.orbitdb=await this.checkOrbitDBHealth(s),a.checks.todoDB=await this.checkTodoDBHealth(i),a.checks.storage=await this.checkStorageHealth(),a.checks.memory=await this.checkMemoryHealth(),this.generateOverallStatus(a),this.generateRecommendations(a),o&&console.log("🏥 Health check complete:",{overall:a.overall,issues:a.errors.length,recommendations:a.recommendations.length}),a}async checkLibP2PHealth(e){const t={status:"unknown",details:{},errors:[]};try{if(!e)return t.status="missing",t.errors.push("LibP2P instance is null or undefined"),t;if(!e.isStarted())return t.status="stopped",t.errors.push("LibP2P node is not started"),t;const n=e.getPeers();t.details.connectedPeers=n.length,t.details.peerId=e.peerId.toString();const s=Object.keys(e.services||{});t.details.services=s;const i=e.getMultiaddrs();t.details.addresses=i.map(o=>o.toString()),t.status="healthy"}catch(n){t.status="error",t.errors.push(`LibP2P error: ${n.message}`)}return t}async checkHeliaHealth(e){const t={status:"unknown",details:{},errors:[]};try{if(!e)return t.status="missing",t.errors.push("Helia instance is null or undefined"),t;if(!e.libp2p.isStarted())return t.status="stopped",t.errors.push("Helia libp2p is not started"),t;const n=new TextEncoder().encode("health-check-test");try{const s=await e.blockstore.put(n),i=await e.blockstore.get(s);if(!i||i.length!==n.length)throw new Error("Blockstore read/write test failed");t.details.blockstoreTest="passed"}catch(s){t.errors.push(`Blockstore test failed: ${s.message}`)}try{const s="/health-check-test",i=new TextEncoder().encode("test-value");await e.datastore.put(s,i);const o=await e.datastore.get(s);if(!o||o.length!==i.length)throw new Error("Datastore read/write test failed");await e.datastore.delete(s),t.details.datastoreTest="passed"}catch(s){t.errors.push(`Datastore test failed: ${s.message}`)}t.status=t.errors.length===0?"healthy":"degraded"}catch(n){t.status="error",t.errors.push(`Helia error: ${n.message}`)}return t}async checkOrbitDBHealth(e){const t={status:"unknown",details:{},errors:[]};try{if(!e)return t.status="missing",t.errors.push("OrbitDB instance is null or undefined"),t;t.details.id=e.id,t.details.directory=e.directory;try{const n=Object.keys(e.databases||{});t.details.openDatabases=n,t.details.databaseCount=n.length}catch(n){t.errors.push(`Failed to list databases: ${n.message}`)}t.status=t.errors.length===0?"healthy":"degraded"}catch(n){t.status="error",t.errors.push(`OrbitDB error: ${n.message}`)}return t}async checkTodoDBHealth(e){const t={status:"unknown",details:{},errors:[]};try{if(!e)return t.status="missing",t.errors.push("Todo database is null or undefined"),t;t.details.address=e.address,t.details.type=e.type,t.details.identity=e.identity?.id;try{const n=await e.all();t.details.entryCount=Object.keys(n||{}).length,t.details.readTest="passed"}catch(n){t.errors.push(`Database read test failed: ${n.message}`)}try{const n=`health-check-${Date.now()}`,s={test:!0,timestamp:new Date().toISOString()};await e.set(n,s);const i=await e.get(n);if(!i||i.test!==!0)throw new Error("Test entry was not properly stored/retrieved");await e.delete(n),t.details.writeTest="passed"}catch(n){t.errors.push(`Database write test failed: ${n.message}`)}t.status=t.errors.length===0?"healthy":"degraded"}catch(n){t.status="error",t.errors.push(`Todo database error: ${n.message}`)}return t}async checkStorageHealth(){const e={status:"unknown",details:{},errors:[]};try{if(typeof window<"u"&&window.localStorage)try{const t="health-check-storage",n=JSON.stringify({timestamp:Date.now()});localStorage.setItem(t,n);const s=localStorage.getItem(t);if(localStorage.removeItem(t),s!==n)throw new Error("localStorage read/write test failed");e.details.localStorage="available"}catch(t){e.errors.push(`localStorage error: ${t.message}`)}else e.details.localStorage="not available";typeof window<"u"&&window.indexedDB?e.details.indexedDB="available":e.details.indexedDB="not available",e.status=e.errors.length===0?"healthy":"degraded"}catch(t){e.status="error",e.errors.push(`Storage error: ${t.message}`)}return e}async checkMemoryHealth(){const e={status:"healthy",details:{},errors:[]};try{if(typeof performance<"u"&&performance.memory){const t=performance.memory;e.details.usedJSHeapSize=t.usedJSHeapSize,e.details.totalJSHeapSize=t.totalJSHeapSize,e.details.jsHeapSizeLimit=t.jsHeapSizeLimit,e.details.memoryPressure=(t.usedJSHeapSize/t.jsHeapSizeLimit*100).toFixed(2)+"%",t.usedJSHeapSize/t.jsHeapSizeLimit>.9&&(e.errors.push("High memory pressure detected"),e.status="warning")}else e.details.memoryInfo="not available"}catch(t){e.errors.push(`Memory check error: ${t.message}`)}return e}generateOverallStatus(e){const t=Object.values(e.checks),n=t.some(o=>o.status==="error"),s=t.some(o=>o.status==="degraded"||o.status==="warning"),i=t.some(o=>o.status==="missing");n||i?e.overall="critical":s?e.overall="degraded":e.overall="healthy",t.forEach(o=>{e.errors.push(...o.errors)})}generateRecommendations(e){const t=[];e.checks.libp2p?.status==="missing"&&t.push("Initialize LibP2P node"),e.checks.helia?.status==="missing"&&t.push("Initialize Helia IPFS node"),e.checks.orbitdb?.status==="missing"&&t.push("Initialize OrbitDB instance"),e.checks.todoDB?.status==="missing"&&t.push("Open Todo database"),e.checks.libp2p?.status==="stopped"&&t.push("Start LibP2P node"),e.checks.helia?.status==="stopped"&&t.push("Start Helia IPFS node"),e.checks.storage?.errors?.length>0&&t.push("Clear browser storage and restart application"),e.checks.memory?.status==="warning"&&t.push("Refresh page to free memory"),e.checks.todoDB?.errors?.some(n=>n.includes("read test failed"))&&t.push("Database may be corrupted - consider clearing OrbitDB directory"),e.checks.todoDB?.errors?.some(n=>n.includes("write test failed"))&&t.push("Database write access blocked - check permissions and storage"),e.overall==="critical"&&t.push("Consider full application reset and database recreation"),e.recommendations=t}async attemptRecovery(e,t={}){const{aggressive:n=!1,verbose:s=!0}=t,i=[];s&&console.log("🔧 Attempting automatic recovery...");try{e.checks.storage?.errors?.length>0&&(this.clearBrowserStorage(),i.push("Cleared browser storage")),e.checks.todoDB?.errors?.some(o=>o.includes("failed"))&&(this.clearOrbitDBCache(),i.push("Cleared OrbitDB cache")),e.checks.memory?.status==="warning"&&typeof window<"u"&&window.gc&&(window.gc(),i.push("Triggered garbage collection")),s&&i.length>0&&console.log("🔧 Recovery actions taken:",i)}catch(o){console.error("❌ Recovery attempt failed:",o)}return i}clearBrowserStorage(){if(!(typeof window>"u"))try{window.localStorage&&window.localStorage.clear(),window.sessionStorage&&window.sessionStorage.clear(),console.log("🧹 Cleared browser storage")}catch(e){console.warn("Failed to clear storage:",e)}}clearOrbitDBCache(){if(!(typeof window>"u"||!window.localStorage))try{const t=Object.keys(window.localStorage).filter(n=>n.includes("orbitdb")||n.includes("libp2p")||n.includes("helia"));t.forEach(n=>{window.localStorage.removeItem(n)}),console.log("🧹 Cleared OrbitDB cache keys:",t.length)}catch(e){console.warn("Failed to clear OrbitDB cache:",e)}}}const o6=new oie;async function aie(r={}){return o6.checkDatabaseHealth(r)}async function cie(r={},e={}){const t=await o6.checkDatabaseHealth(r),n=await o6.attemptRecovery(t,e);return{healthReport:t,recoveryActions:n,needsFullReset:t.overall==="critical"}}const bm=OD([]),iP=typeof window<"u";let He=null,Vi=null,cs=null,Sr=null,Da=null;const lie="/ip4/127.0.0.1/tcp/4001/ws/p2p/12D3KooWAJjbRkp8FPF5MKgMU53aUTxWkqvDrs4zc1VMbwRwfsbE",uie="/orbitdb/address/1.0.0";function hie(r){console.log("🔍 Setting up peer discovery event handlers...");const e=new Set,t=new Map,n=new Map;r.addEventListener("peer:discovery",async s=>{const{id:i,multiaddrs:o}=s.detail,a=i?.toString();if(console.log("🎯 Peer discovered:",qt(a),"Addresses:",o.map(u=>u.toString())),e.has(a)){console.log("⏭️ Peer already discovered, skipping:",qt(a));return}const c=r.getConnections(i);if(c&&c.length>0){console.log("🔗 Already connected to peer:",qt(a)),e.add(a),bm.set(Array.from(e));return}const l=t.get(a);if(l&&Date.now()-l<3e4){console.log("⏳ Recent connection attempt failed, waiting before retry:",qt(a));return}e.add(a),bm.set(Array.from(e));try{console.log("📞 Attempting to dial discovered peer:",qt(a)),await r.dial(i)&&console.log("✅ Successfully connected to peer:",qt(a))}catch(u){console.warn("❌ Failed to connect to discovered peer:",qt(a),"Error:",u.message),t.set(a,Date.now())}}),r.addEventListener("peer:connect",async s=>{const i=s.detail?.remotePeer||s.detail||s.peerId||s,o=typeof i.toString=="function"?i.toString():String(i),a=s.detail?.remoteAddr?.toString?.()||"unknown";console.log(`🤝 [peer:connect] PeerId: ${o} | Direct address: ${a}`);const c=r.getConnections(i);if(c.length>0)c.forEach(u=>{console.log(`   - Active connection address: ${u.remoteAddr?.toString()}`)});else try{const h=(await r.peerStore.get(i))?.addresses?.map(d=>d.multiaddr.toString())||[];h.length>0?console.log("   - Known addresses from peerStore:",h):console.log("   - No known addresses for this peer.")}catch(u){console.log("   - Could not retrieve addresses from peerStore:",u.message)}let l="unknown";a.includes("/ws")?l="websocket":a.includes("/webrtc")?l="webrtc":a.includes("/tcp")&&!a.includes("/ws")?l="tcp":a.includes("/p2p-circuit")&&(l="circuit-relay"),n.set(o,{peerId:o,peerIdFormatted:qt(o),address:a,transport:l,connectedAt:new Date().toISOString(),status:"connected"}),console.log(`🤝 [CLIENT CONNECT] ${qt(o)} via ${l.toUpperCase()} | Address: ${a}`),t.delete(o),window.dispatchEvent(new CustomEvent("p2p-peer-connected",{detail:{peerId:o,peerIdFormatted:qt(o),transport:l,address:a}}));try{const{stream:u}=await r.dialProtocol(i,uie),h=u.source;let d="";for await(const g of h)d+=new TextDecoder().decode(g);d&&(oP.set(o,d),window.dispatchEvent(new CustomEvent("orbitdb-address-update",{detail:{peerId:o,dbAddress:d}})),console.log(`[orbitdb-address] Received OrbitDB address from peer: ${o} → ${d}`))}catch(u){console.warn(`[orbitdb-address] Failed to fetch OrbitDB address from peer: ${o}`,u)}await announceOrbitDbAddress()}),r.addEventListener("peer:disconnect",s=>{const{remotePeer:i}=s.detail,o=i?.toString(),a=n.get(o);let c="unknown";if(a?.connectedAt){const l=new Date(a.connectedAt),u=Date.now()-l.getTime();c=`${Math.round(u/1e3)}s`}console.log(`👋 [CLIENT DISCONNECT] ${qt(o)} | Duration: ${c} | Transport: ${a?.transport||"unknown"}`),e.delete(o),bm.set(Array.from(e)),n.delete(o),window.dispatchEvent(new CustomEvent("p2p-peer-disconnected",{detail:{peerId:o}}))}),console.log("✅ Peer discovery handlers configured")}async function die(){const r=new Promise((t,n)=>setTimeout(()=>n(new Error("P2P initialization timed out after 30 seconds")),3e4)),e=async()=>{console.log("🚀 Starting P2P initialization..."),console.log("🔑 Setting up peer identity...");let t=null;console.log("🎲 Generating random peer ID"),console.log("🌐 Creating libp2p node...");const n=Date.now();He=await cA({...t,addresses:{listen:["/p2p-circuit","/webrtc","/webtransport","/wss","/ws"]},transports:[sC({filter:nC}),tC(),$k({discoverRelays:1})],connectionEncrypters:[zw()],connectionGater:{denyDialMultiaddr:()=>!1,denyDialPeer:()=>!1,denyInboundConnection:()=>!1,denyOutboundConnection:()=>!1,denyInboundEncryptedConnection:()=>!1,denyOutboundEncryptedConnection:()=>!1,denyInboundUpgradedConnection:()=>!1,denyOutboundUpgradedConnection:()=>!1},streamMuxers:[Ak()],peerDiscovery:[tie({interval:5e3,topics:["todo._peer-discovery._p2p._pubsub"],listenOnly:!1,emitSelf:!0})],services:{identify:Kk(),bootstrap:Nk({list:[lie]}),ping:Qk(),dcutr:Uk(),autonat:kk(),pubsub:Zse({emitSelf:!0,allowPublishToZeroTopicPeers:!0})}}),console.log(`✅ libp2p node created in ${Date.now()-n}ms`),hie(He),console.log("📁 Creating Helia instance...");const s=Date.now();let i=new iie("./helia-blocks"),o=new rie("./helia-data");Vi=await Oee({libp2p:He,blockstore:i,datastore:o}),console.log(`✅ Helia created in ${Date.now()-s}ms`),console.log("🛬 Creating OrbitDB instance...");const a=Date.now();return cs=await One({ipfs:Vi,id:"todo-p2p-app"}),console.log(`✅ OrbitDB created in ${Date.now()-a}ms`),setupOrbitDbAddressListener(),await Qc(),await announceOrbitDbAddress(),console.log(`🎉 P2P initialized successfully in ${Date.now()-n}ms! PeerId:`,He.peerId.toString()),He};return Promise.race([e(),r])}async function s8(){if(!iP||He)return He;try{return await die()}catch(r){if(console.error("❌ P2P initialization failed:",r),He)try{await He.stop()}catch(e){console.warn("Error stopping libp2p during cleanup:",e)}throw He=null,Vi=null,cs=null,Sr=null,r}}let dd=[];const oP=new Map;async function fie(r){cs||await s8();let e=oP.get(r);return e||(e="todo"),Sr=await cs.open(e,{type:"keyvalue",accessController:{type:"orbitdb",write:["*"]}}),Sr}function pie(){if(!Sr){console.warn("Cannot set up database event listeners - todoDB not available");return}console.log("🔄 Setting up OrbitDB event listeners..."),Sr.events.on("update",r=>{console.log("📝 OrbitDB update event:",{payload:r?.payload,operation:r?.payload?.op,key:r?.payload?.key,value:r?.payload?.value}),r?.payload?.op==="PUT"||r?.payload?.op==="SET"?(console.log("✅ Todo added/updated:",r.payload.key,r.payload.value),dd.forEach(e=>{try{e("update",{type:"PUT",key:r.payload.key,value:r.payload.value,entry:r})}catch(t){console.error("Error in database update callback:",t)}})):(r?.payload?.op==="DEL"||r?.payload?.op==="DELETE")&&(console.log("🗑️ Todo deleted:",r.payload.key),dd.forEach(e=>{try{e("update",{type:"DEL",key:r.payload.key,entry:r})}catch(t){console.error("Error in database update callback:",t)}}))}),console.log("✅ OrbitDB event listeners configured")}async function aP(r,e=null){const t=await Qc();try{if(!r||typeof r!="string")throw new Error("Todo text must be a non-empty string");if(e!==null&&typeof e!="string")throw new Error("Assignee must be a string or null");const n=Date.now().toString(),s={text:String(r).trim(),assignee:e?String(e).trim():null,completed:!1,createdAt:new Date().toISOString(),createdBy:He?.peerId?.toString()||"unknown"};if(console.log("🔍 Attempting to add todo:",{id:n,todo:s,todoType:typeof s,textType:typeof s.text,textLength:s.text.length}),!s.text||s.text.length===0)throw new Error("Todo text cannot be empty after trimming");try{const o=JSON.stringify(s),a=JSON.parse(o);console.log("✅ Todo serialization test passed:",a)}catch(o){throw console.error("❌ Todo serialization failed:",o),new Error(`Todo data is not serializable: ${o.message}`)}let i;try{console.log("💾 Storing todo in OrbitDB...",{id:n,data:s}),i=await t.set(n,s),console.log("✅ Todo stored successfully, hash:",i)}catch(o){throw console.error("❌ OrbitDB storage error:",{error:o,message:o.message,stack:o.stack,todoId:n,todoData:s}),new Error(`Failed to store todo in database: ${o.message}`)}return console.log("🎉 Todo added successfully:",{id:n,...s},"Hash:",i),{id:n,...s}}catch(n){throw console.error("❌ Error in addTodo:",{error:n,message:n.message,stack:n.stack,inputText:r,inputAssignee:e}),n}}async function a6(r,e){const t=await Qc(),n=await t.get(r);if(n){const s={...n,...e,updatedAt:new Date().toISOString(),updatedBy:He.peerId.toString()},i=await t.set(r,s);return console.log("Todo updated:",{id:r,...s},"Hash:",i),{id:r,...s}}throw new Error(`Todo with id ${r} not found`)}async function cP(r){const e=await Qc();if(await e.get(r)){const n=await e.delete(r);return console.log("Todo deleted:",r,"Hash:",n),!0}return!1}async function fd(){const r=await Qc();try{const e=await r.all();console.log("🔍 Raw OrbitDB data:",e),console.log("🔍 OrbitDB data type:",typeof e,"Is Array:",Array.isArray(e));let t=[];if(Array.isArray(e))console.log("📋 Processing array format data..."),t=e.map((n,s)=>{if(console.log(`Processing doc ${s}:`,n),!n||!n.value||typeof n.value!="object")return console.warn("⚠️ Invalid document structure:",n),null;const i=n.value,a={id:n.key,text:i.text||"",assignee:i.assignee||null,completed:!!i.completed,createdAt:i.createdAt||new Date().toISOString(),createdBy:i.createdBy||"unknown",updatedAt:i.updatedAt||null,updatedBy:i.updatedBy||null};return console.log("✅ Processed todo:",a),a}).filter(n=>n!==null);else if(e&&typeof e=="object")console.log("📋 Processing object format data..."),t=Object.entries(e).map(([n,s])=>!s||typeof s!="object"?(console.warn("⚠️ Invalid todo data for key:",n,"Value:",s),null):{id:n,text:s.text||"",assignee:s.assignee||null,completed:!!s.completed,createdAt:s.createdAt||new Date().toISOString(),createdBy:s.createdBy||"unknown",updatedAt:s.updatedAt||null,updatedBy:s.updatedBy||null}).filter(n=>n!==null);else return console.warn("⚠️ Unexpected OrbitDB data format:",e),[];return console.log("✅ Final processed todos:",t.length,t),t.sort((n,s)=>new Date(s.createdAt)-new Date(n.createdAt))}catch(e){return console.error("❌ Error fetching todos from OrbitDB:",e),[]}}async function zh(){if(!He)return[];const r=He.getConnections(),e=new Map;for(const t of r){const n=t.remotePeer.toString(),s=t.remoteAddr?t.remoteAddr.toString():"";let i="unknown";s.includes("/webrtc")?i="webrtc":s.includes("/p2p-circuit")?i="circuit-relay":s.includes("/ws")&&(i="websocket"),e.has(n)||e.set(n,new Set),e.get(n).add(i)}return Array.from(e.entries()).map(([t,n])=>({peerId:t,transports:Array.from(n)}))}function lP(){return He?.peerId?.toString()||null}function qt(r){if(!r||typeof r!="string")return"unknown";const e=r.slice(0,4),t=r.slice(-4);return`${e}...${t}`}function gie(r){return console.log("🔄 Registering database update callback"),dd.push(r),()=>{const e=dd.indexOf(r);e>-1&&(dd.splice(e,1),console.log("🗑️ Database update callback removed"))}}async function yie(){Da||(Da=new sP);try{const r=await Da.isRelayHealthy(),e=Da.cachedAddrs,t=Da.lastFetch;return{healthy:r,addresses:e,lastFetch:t,cacheAge:t?Date.now()-t:null,cacheValid:e&&t&&Date.now()-t<Da.cacheTTL}}catch(r){return{healthy:!1,error:r.message,addresses:null,lastFetch:null,cacheAge:null,cacheValid:!1}}}async function bE(){console.log("🏥 Running database health check...");const e=await aie({libp2p:He,helia:Vi,orbitdb:cs,todoDB:Sr,verbose:!0});return console.log("🏥 Health check results:",{overall:e.overall,errors:e.errors,recommendations:e.recommendations}),e}async function vE(r={}){console.log("🔧 Running database health check with recovery...");const t=await cie({libp2p:He,helia:Vi,orbitdb:cs,todoDB:Sr,verbose:!0},r);return console.log("🔧 Health check and recovery complete:",{overall:t.healthReport.overall,recoveryActions:t.recoveryActions,needsFullReset:t.needsFullReset}),t.needsFullReset&&(console.warn("⚠️ Critical database issues detected - full reset recommended"),He=null,Vi=null,cs=null,Sr=null),t}async function EE(){console.log("🔄 Force resetting all database components...");try{if(Sr)try{await Sr.drop(),await Sr.close()}catch(r){console.warn("Error closing todo database:",r)}if(cs)try{await cs.stop()}catch(r){console.warn("Error stopping OrbitDB:",r)}if(Vi)try{await Vi.stop()}catch(r){console.warn("Error stopping Helia:",r)}if(He)try{await He.stop()}catch(r){console.warn("Error stopping LibP2P:",r)}}catch(r){console.error("Error during component shutdown:",r)}finally{He=null,Vi=null,cs=null,Sr=null,Da=null,console.log("✅ Database reset complete")}}async function SE(){console.log("🧪 Starting OrbitDB operations test...");try{const r=await Qc();console.log("✅ Database obtained:",r.address);const e=`test-${Date.now()}`,t={message:"Hello OrbitDB",timestamp:new Date().toISOString(),number:42,boolean:!0,array:[1,2,3],nested:{key:"value"}};console.log("📋 Test 1: Storing test data...",{key:e,value:t});let n;try{n=await r.set(e,t),console.log("✅ Test 1 PASSED: Data stored successfully, hash:",n)}catch(s){return console.error("❌ Test 1 FAILED: Set operation failed:",s),{success:!1,error:"Set operation failed",details:s}}console.log("📋 Test 2: Retrieving test data...");try{const s=await r.get(e);console.log("✅ Test 2 PASSED: Data retrieved successfully:",s),JSON.stringify(s)===JSON.stringify(t)?console.log("✅ Test 2a PASSED: Data integrity verified"):console.warn("⚠️ Test 2a WARNING: Data integrity mismatch",{expected:t,actual:s})}catch(s){return console.error("❌ Test 2 FAILED: Get operation failed:",s),{success:!1,error:"Get operation failed",details:s}}console.log("📋 Test 3: Listing all entries...");try{const s=await r.all();console.log("✅ Test 3 PASSED: All entries retrieved:",Object.keys(s).length,"entries"),console.log("Sample entries:",s)}catch(s){return console.error("❌ Test 3 FAILED: All operation failed:",s),{success:!1,error:"All operation failed",details:s}}console.log("📋 Test 4: Deleting test data...");try{const s=await r.delete(e);console.log("✅ Test 4 PASSED: Data deleted successfully, result:",s)}catch(s){return console.error("❌ Test 4 FAILED: Delete operation failed:",s),{success:!1,error:"Delete operation failed",details:s}}return console.log("🎉 All OrbitDB tests passed successfully!"),{success:!0,message:"All OrbitDB operations working correctly",testHash:n}}catch(r){return console.error("❌ OrbitDB test suite failed:",r),{success:!1,error:"Test suite failed",details:r,message:r.message}}}async function _E(){console.log("🐛 === DEBUG TODOS START ===");try{const r=await Qc();console.log("📊 Database info:",{address:r.address,type:r.type,open:r.opened,writable:r.access.write}),console.log("🔍 Fetching raw database content...");const e=await r.all();console.log("📦 Raw OrbitDB data:",e),console.log("📈 Raw data stats:",{type:typeof e,isArray:Array.isArray(e),keys:Object.keys(e||{}),length:Array.isArray(e)?e.length:Object.keys(e||{}).length}),console.log("🔄 Processing todos...");const t=await fd();console.log("✅ Processed todos:",t),console.log("📊 Todos stats:",{count:t.length,sampleTodo:t[0]||"No todos found"})}catch(r){console.error("❌ Debug error:",r)}console.log("🐛 === DEBUG TODOS END ===")}function vm(){return Sr?.address?.toString?.()||null}function Em(){return Sr?.dbName||null}async function xE(){if(!He){console.warn("❌ libp2p not initialized yet. Please wait for P2P initialization to complete.");return}console.log("🧪 Testing pubsub self-message visibility...");const r=He.services.pubsub,e=He.getConnections();console.log("📊 Detailed pubsub state:",{peerId:He.peerId.toString(),subscriptions:Array.from(r.subscriptions),connectedPeers:e.length,peerConnections:e.map(c=>({peer:c.remotePeer.toString(),status:c.status,direction:c.stat?.direction||"unknown",address:c.remoteAddr?.toString()||"unknown"})),pubsubType:r.constructor.name,started:r.started,topics:r.getTopics?r.getTopics():"N/A",peers:r.getPeers?r.getPeers():"N/A"});try{r.mesh&&console.log("🕸️ Gossipsub mesh info:",{meshTopics:Array.from(r.mesh.keys()),fanout:r.fanout?Array.from(r.fanout.keys()):[],gossip:r.gossip?Array.from(r.gossip.keys()):[]})}catch(c){console.log("⚠️ Could not access gossipsub internals:",c.message)}let t=0;const n=[],s="pubsub-self-test";console.log(`📡 Subscribing to topic: ${s}`);const i=c=>{t++;const l=new TextDecoder().decode(c.data),u=He.peerId.toString();console.log(`📩 [${t}] Message received on ${s}:`,{from:c.from,topic:c.topic,data:l,isSelf:c.from===u,myPeerId:u}),n.push({from:c.from,topic:c.topic,data:l,isSelf:c.from===u,timestamp:Date.now()}),c.from===u&&console.log("🎯 SELF-MESSAGE detected! emitSelf is working!")};He.services.pubsub.subscribe(s,i),await new Promise(c=>setTimeout(c,500)),console.log("📤 Publishing test messages...");for(let c=1;c<=3;c++){const l=JSON.stringify({test:c,timestamp:new Date().toISOString(),peerId:He.peerId.toString(),message:`Test message ${c}`});console.log(`📤 Publishing message ${c}...`),await He.services.pubsub.publish(s,ie(l)),await new Promise(u=>setTimeout(u,200))}console.log("⏳ Waiting for message delivery..."),await new Promise(c=>setTimeout(c,2e3));const o=n.filter(c=>c.isSelf),a=n.filter(c=>!c.isSelf);return console.log("📊 TEST RESULTS:"),console.log("  - Messages published: 3"),console.log(`  - Messages received: ${t}`),console.log(`  - Self-messages received: ${o.length}`),console.log(`  - Other-messages received: ${a.length}`),o.length===3?console.log("✅ SUCCESS: All self-messages received! emitSelf is working correctly."):o.length>0?console.log("⚠️  PARTIAL: Some self-messages received, but not all."):console.log("❌ PROBLEM: No self-messages received. emitSelf might not be working."),He.services.pubsub.unsubscribe(s,i),console.log("🧹 Test complete, unsubscribed from test topic."),{published:3,received:t,selfMessages:o.length,otherMessages:a.length,success:o.length===3}}iP&&typeof window<"u"&&(window.app={addTodo:aP,updateTodo:a6,deleteTodo:cP,getAllTodos:fd,getConnectedPeers:zh,getMyPeerId:lP,runDatabaseHealthCheck:bE,runDatabaseHealthCheckAndRecover:vE,forceResetDatabase:EE,testOrbitDBOperations:SE,debugTodos:_E,testPubsubSelfMessages:xE},window.debugTodos=_E,window.testOrbitDB=SE,window.healthCheck=bE,window.healthRecover=vE,window.resetDB=EE,window.testPubsub=xE,window.debugPubsub=()=>{if(!He){console.log("❌ libp2p not initialized");return}const r=He.services.pubsub;if(console.log("🔍 PUBSUB DEBUG INFO:"),console.log("  - PeerId:",He.peerId.toString()),console.log("  - Pubsub started:",r.started),console.log("  - Subscriptions:",Array.from(r.subscriptions)),console.log("  - Connected peers:",He.getConnections().length),console.log("  - Pubsub peers:",r.getPeers?r.getPeers():"N/A"),console.log("  - Topics:",r.getTopics?r.getTopics():"N/A"),r.mesh){console.log("  - Mesh topics:",Array.from(r.mesh.keys())),console.log("  - Fanout topics:",r.fanout?Array.from(r.fanout.keys()):[]);for(const[e,t]of r.mesh)console.log(`  - Mesh peers for '${e}':`,t?Array.from(t).map(n=>n.toString()):"none")}try{console.log("  - emitSelf setting:",r.emitSelf)}catch{console.log("  - emitSelf setting: not accessible")}try{console.log("  - Gossipsub config:",{allowPublishToZeroTopicPeers:r.allowPublishToZeroTopicPeers,canRelayMessage:r.canRelayMessage,gossipIncoming:r.gossipIncoming,fallbackToFloodsub:r.fallbackToFloodsub,floodPublish:r.floodPublish})}catch(e){console.log("  - Gossipsub config: not accessible",e.message)}},window.testBasicPubsub=async()=>{if(!He){console.warn("❌ libp2p not initialized yet.");return}console.log("🧪 Testing basic pubsub (without emitSelf)...");const r=He.services.pubsub,e="basic-pubsub-test";let t=0;const n=s=>{t++;const i=new TextDecoder().decode(s.data);console.log("📩 Basic test message received:",{from:s.from,topic:s.topic,data:i,messageCount:t})};return r.subscribe(e,n),await new Promise(s=>setTimeout(s,500)),console.log("🔍 Topic subscription status:"),console.log("  - Subscribed topics:",Array.from(r.subscriptions)),console.log("  - Mesh topics:",r.mesh?Array.from(r.mesh.keys()):"N/A"),console.log("📤 Publishing to basic test topic..."),await r.publish(e,ie(JSON.stringify({test:"basic-test",timestamp:new Date().toISOString(),peerId:He.peerId.toString()}))),await new Promise(s=>setTimeout(s,2e3)),console.log(`📊 Basic test result: ${t} messages received`),r.unsubscribe(e,n),{messageCount:t,success:t>0}});async function Qc(){return cs||await s8(),Sr||(Sr=await cs.open("todos",{type:"keyvalue",accessController:{type:"orbitdb",write:["*"]}}),pie()),Sr}var mie=je('<div class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-300"> </div>'),wie=je("<option> </option>"),bie=je('<span class="text-xs text-gray-500">OrbitDB: <code class="bg-gray-100 px-1 rounded"> </code></span>'),vie=je('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div> <p class="mt-4 text-gray-600">Initializing P2P connection...</p></div>'),Eie=je('<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"> </div>'),Sie=je("<option> </option>"),_ie=je('Assigned to: <code class="bg-gray-100 px-1 rounded"> </code>',1),xie=je('<span class="text-orange-600">Unassigned</span>'),Aie=je("<option> </option>"),Iie=je('<select class="text-sm border border-gray-300 rounded px-2 py-1"><option>Assign to...</option><!></select>'),kie=je('<div class="flex items-center justify-between p-3 border border-gray-200 rounded-md hover:bg-gray-50"><div class="flex items-center space-x-3 flex-1"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"/> <div class="flex-1"><span> </span> <div class="text-sm text-gray-500 mt-1"><!> • Created by: <code class="bg-gray-100 px-1 rounded"> </code></div></div></div> <div class="flex space-x-2"><!> <button class="text-red-500 hover:text-red-700 px-3 py-1 rounded-md transition-colors">Delete</button></div></div>'),Tie=je('<div class="space-y-3"></div>'),Cie=je('<p class="text-gray-500 text-center py-8">No TODOs yet. Add one above!</p>'),Pie=je('<span class="badge bg-green-200 text-green-800">WebRTC</span>'),Die=je('<span class="badge bg-blue-200 text-blue-800">Relay</span>'),Rie=je('<span class="badge bg-purple-200 text-purple-800">WS</span>'),Oie=je('<span class="badge bg-gray-200 text-gray-800"> </span>'),Nie=je('<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> <code class="text-sm bg-gray-100 px-2 py-1 rounded"> </code> <!></div>'),Mie=je('<div class="space-y-2"></div>'),Bie=je('<p class="text-gray-500">No peers connected yet.</p>'),Lie=je('<div class="bg-blue-50 p-3 rounded-md"><code class="text-sm font-mono break-all"> </code></div> <p class="text-sm text-gray-600 mt-2">Share this ID with others to assign TODOs to you.</p>',1),$ie=je('<p class="text-gray-500">Loading...</p>'),Uie=je('<span class="text-green-600"> </span>'),Fie=je('<span class="text-orange-600">Expired or missing</span>'),Vie=je('<div class="bg-green-50 p-2 rounded border-l-4 border-green-400"><code class="text-xs"> </code> <span class="text-green-600 text-xs ml-2">(Direct WebRTC)</span></div>'),Kie=je('<div class="bg-blue-50 p-2 rounded border-l-4 border-blue-400"><code class="text-xs"> </code> <span class="text-blue-600 text-xs ml-2">(Circuit Relay)</span></div>'),qie=je('<div class="bg-purple-50 p-2 rounded border-l-4 border-purple-400"><code class="text-xs"> </code> <span class="text-purple-600 text-xs ml-2">(WebSocket)</span></div>'),Hie=je('<p class="mt-2"><strong>Available WebRTC Addresses:</strong></p> <div class="mt-1 space-y-1"><!> <!> <!></div>',1),zie=je('<p class="text-red-600">No cached addresses available</p>'),Wie=je('<p class="text-red-600 mt-2"><strong>Error:</strong> </p>'),jie=je('<div class="space-y-3"><div class="flex items-center space-x-2"><div></div> <span class="font-medium"> </span></div> <div class="text-sm text-gray-600"><p><strong>Cache Status:</strong> <!></p> <!> <!></div></div>'),Gie=je('<p class="text-gray-500">Click "Show Details" to check relay discovery status</p>'),Qie=je('<p class="text-sm text-gray-500">Relay discovery provides WebRTC addresses with smart caching to avoid unnecessary requests on page reload.</p>'),Yie=je('<div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="text-xl font-semibold mb-4">Add New TODO</h2> <div class="space-y-4"><input type="text" placeholder="What needs to be done?" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"/> <div class="flex gap-2"><select class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"><option>Assign to...</option><!></select> <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md font-medium transition-colors">Add TODO</button></div></div></div> <div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="text-xl font-semibold mb-4"> </h2> <!></div> <div class="grid md:grid-cols-2 gap-6"><div class="bg-white rounded-lg shadow-md p-6"><h2 class="text-xl font-semibold mb-4"> </h2> <!></div> <div class="bg-white rounded-lg shadow-md p-6"><h2 class="text-xl font-semibold mb-4">My Peer ID</h2> <!></div></div> <div class="bg-white rounded-lg shadow-md p-6 mt-6"><div class="flex items-center justify-between mb-4"><h2 class="text-xl font-semibold">Relay Discovery Status</h2> <button class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-md transition-colors"> </button></div> <!></div>',1),Xie=je('<div><strong>OrbitDB Address:</strong> <code class="bg-gray-100 px-1 rounded"> </code></div>'),Zie=je('<div><strong>DB Name:</strong> <code class="bg-gray-100 px-1 rounded"> </code></div>'),Jie=je('<!> <main class="container mx-auto p-6 max-w-4xl"><h1 class="text-3xl font-bold mb-6 text-center">P2P TODO List</h1> <div class="mb-6 flex items-center gap-4"><label for="peer-db-select" class="font-medium">View TODOs from:</label> <select id="peer-db-select" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"><option>My DB (default)</option><!></select> <!></div> <!></main> <footer class="mt-10 text-center text-xs text-gray-500"><!> <!></footer>',1);function eoe(r,e){RE(e,!1);let t=Kr([]),n=Kr(""),s=Kr(""),i=Kr([]),o=Kr(null),a=Kr(!0),c=Kr(null),l=Kr(null),u=Kr(!1),h=Kr(""),d,g=Kr(null),y=Kr(null),w=Kr(""),m=Kr(new Map);function _(Q){Le(h,Q),clearTimeout(d),d=setTimeout(()=>{Le(h,"")},1500)}bD(async()=>{try{let Ue=function(){zh().then(tt=>Le(i,tt))},Ke=function(tt){Ue(),console.log("handlePeerConnected",tt.detail);const yt=tt.detail?.peerId||"unknown";_(`Peer connected: ${qt(yt)}`)},at=function(tt){Ue();const yt=tt.detail?.peerId||"unknown";_(`Peer disconnected: ${qt(yt)}`)},et=function(tt){const{peerId:yt,dbAddress:hr}=tt.detail||{};yt&&yt!==ae(o)&&_(`Received OrbitDB address from peer: ${qt(yt)}`)};var Q=Ue,J=Ke,ge=at,ke=et;await s8(),Le(t,await fd()),Le(i,await zh()),Le(o,lP()),Le(g,vm()),Le(y,Em()),gie(async(tt,yt)=>{console.log("eventType",tt),console.log("eventData",yt),(tt==="update"||!tt)&&(Le(t,await fd()),Le(i,await zh()),Le(g,vm()),Le(y,Em()),tt==="update"&&(yt?.type==="PUT"?_("Todo added or updated!"):yt?.type==="DEL"?_("Todo deleted!"):_("Todo updated!")))}),window.addEventListener("p2p-peer-connected",Ke),window.addEventListener("p2p-peer-disconnected",at),window.addEventListener("orbitdb-address-update",et),Le(m,getPeerOrbitDbAddresses()),Le(a,!1)}catch(Ue){Le(c,Ue.message),Le(a,!1)}return()=>{window.removeEventListener("p2p-peer-connected",J),window.removeEventListener("p2p-peer-disconnected",ge),window.removeEventListener("orbitdb-address-update",ke)}});async function k(){if(ae(n).trim()!=="")try{await aP(ae(n),ae(s)||null),Le(n,""),Le(s,"")}catch(Q){Le(c,Q.message)}}async function N(Q){const J=ae(t).find(ge=>ge.id===Q);if(J)try{await a6(Q,{completed:!J.completed})}catch(ge){Le(c,ge.message)}}async function I(Q){try{await cP(Q)}catch(J){Le(c,J.message)}}async function T(Q,J){try{await a6(Q,{assignee:J})}catch(ge){Le(c,ge.message)}}async function x(){try{await fie(ae(w)),Le(t,await fd()),Le(g,vm()),Le(y,Em()),Le(i,await zh()),Le(m,getPeerOrbitDbAddresses()),_(ae(w)?"Switched to peer's DB":"Switched to default DB")}catch(Q){Le(c,Q.message)}}RD();var D=Jie(),F=ps(D);{var R=Q=>{var J=mie(),ge=Se(J);Ft(()=>Nt(ge,ae(h))),Oe(Q,J)};Mt(F,Q=>{ae(h)&&Q(R)})}var C=Me(F,2),O=Me(Se(C),2),P=Me(Se(O),2);Ft(()=>{ae(w),d8(()=>{ae(i),ae(m)})});var M=Se(P);M.value=M.__value="";var K=Me(M);il(K,1,()=>ae(i),sl,(Q,J)=>{let ge=()=>ae(J).peerId;var ke=rl(),Ue=ps(ke);{var Ke=at=>{var et=wie(),tt=Se(et),yt={};Ft((hr,Vr)=>{Nt(tt,`${hr??""}... (…${Vr??""})`),yt!==(yt=ge())&&(et.value=(et.__value=ge())??"")},[()=>qt(ge()),()=>ae(m).get(ge()).slice(-5)]),Oe(at,et)};Mt(Ue,at=>{ae(m).get(ge())&&at(Ke)})}Oe(Q,ke)});var H=Me(P,2);{var $=Q=>{var J=bie(),ge=Me(Se(J)),ke=Se(ge);Ft(Ue=>Nt(ke,`…${Ue??""}`),[()=>ae(m).get(ae(w)).slice(-5)]),Oe(Q,J)};Mt(H,Q=>{ae(w)&&ae(m).get(ae(w))&&Q($)})}var L=Me(O,2);{var z=Q=>{var J=vie();Oe(Q,J)},q=Q=>{var J=rl(),ge=ps(J);{var ke=Ke=>{var at=Eie(),et=Se(at);Ft(()=>Nt(et,`Error: ${ae(c)??""}`)),Oe(Ke,at)},Ue=Ke=>{var at=Yie(),et=ps(at),tt=Me(Se(et),2),yt=Se(tt),hr=Me(yt,2),Vr=Se(hr);Ft(()=>{ae(s),d8(()=>{ae(i)})});var Vn=Se(Vr);Vn.value=Vn.__value="";var Yc=Me(Vn);il(Yc,1,()=>ae(i),sl,(ve,Re)=>{let Ot=()=>ae(Re).peerId;var jt=Sie(),vn=Se(jt),dr={};Ft(qn=>{Nt(vn,`${qn??""}...`),dr!==(dr=Ot())&&(jt.value=(jt.__value=Ot())??"")},[()=>qt(Ot())]),Oe(ve,jt)});var Xc=Me(Vr,2),yi=Me(et,2),co=Se(yi),ch=Se(co),Zc=Me(co,2);{var lo=ve=>{var Re=Tie();il(Re,5,()=>ae(t),sl,(Ot,jt)=>{let vn=()=>ae(jt).id,dr=()=>ae(jt).text,qn=()=>ae(jt).completed,uo=()=>ae(jt).assignee,el=()=>ae(jt).createdBy;var tl=kie(),ho=Se(tl),Bs=Se(ho),ga=Me(Bs,2),ya=Se(ga),uh=Se(ya),hh=Me(ya,2),Hn=Se(hh);{var fo=Tr=>{var or=_ie(),zn=Me(ps(or)),ma=Se(zn);Ft(wa=>Nt(ma,wa),[()=>qt(uo())]),Oe(Tr,or)},dh=Tr=>{var or=xie();Oe(Tr,or)};Mt(Hn,Tr=>{uo()?Tr(fo):Tr(dh,!1)})}var fh=Me(Hn,2),ph=Se(fh),_t=Me(ho,2),Gt=Se(_t);{var mi=Tr=>{var or=Iie(),zn=Se(or);zn.value=zn.__value="";var ma=Me(zn);il(ma,1,()=>ae(i),sl,(wa,En)=>{let Wn=()=>ae(En).peerId;var Ls=Aie(),ba=Se(Ls),i8={};Ft(uP=>{Nt(ba,`${uP??""}...`),i8!==(i8=Wn())&&(Ls.value=(Ls.__value=Wn())??"")},[()=>qt(Wn())]),Oe(wa,Ls)}),va("change",or,wa=>T(vn(),wa.target.value)),Oe(Tr,or)};Mt(Gt,Tr=>{ae(i).length>0&&Tr(mi)})}var po=Me(Gt,2);Ft(Tr=>{CD(Bs,qn()),w8(ya,1,xD(qn()?"line-through text-gray-500":"text-gray-800")),Nt(uh,dr()),Nt(ph,Tr)},[()=>qt(el())]),va("change",Bs,()=>N(vn())),va("click",po,()=>I(vn())),Oe(Ot,tl)}),Oe(ve,Re)},Zr=ve=>{var Re=Cie();Oe(ve,Re)};Mt(Zc,ve=>{ae(t).length>0?ve(lo):ve(Zr,!1)})}var Kn=Me(yi,2),Jc=Se(Kn),bn=Se(Jc),lh=Se(bn),E=Me(bn,2);{var f=ve=>{var Re=Mie();il(Re,5,()=>ae(i),sl,(Ot,jt)=>{let vn=()=>ae(jt).peerId,dr=()=>ae(jt).transports;var qn=Nie(),uo=Me(Se(qn),2),el=Se(uo),tl=Me(uo,2);il(tl,1,dr,sl,(ho,Bs)=>{var ga=rl(),ya=ps(ga);{var uh=Hn=>{var fo=Pie();Oe(Hn,fo)},hh=Hn=>{var fo=rl(),dh=ps(fo);{var fh=_t=>{var Gt=Die();Oe(_t,Gt)},ph=_t=>{var Gt=rl(),mi=ps(Gt);{var po=or=>{var zn=Rie();Oe(or,zn)},Tr=or=>{var zn=Oie(),ma=Se(zn);Ft(()=>Nt(ma,ae(Bs))),Oe(or,zn)};Mt(mi,or=>{ae(Bs)==="websocket"?or(po):or(Tr,!1)},!0)}Oe(_t,Gt)};Mt(dh,_t=>{ae(Bs)==="circuit-relay"?_t(fh):_t(ph,!1)},!0)}Oe(Hn,fo)};Mt(ya,Hn=>{ae(Bs)==="webrtc"?Hn(uh):Hn(hh,!1)})}Oe(ho,ga)}),Ft(ho=>Nt(el,ho),[()=>qt(vn())]),Oe(Ot,qn)}),Oe(ve,Re)},p=ve=>{var Re=Bie();Oe(ve,Re)};Mt(E,ve=>{ae(i).length>0?ve(f):ve(p,!1)})}var v=Me(Jc,2),A=Me(Se(v),2);{var B=ve=>{var Re=Lie(),Ot=ps(Re),jt=Se(Ot),vn=Se(jt);Ft(dr=>Nt(vn,dr),[()=>qt(ae(o))]),Oe(ve,Re)},W=ve=>{var Re=$ie();Oe(ve,Re)};Mt(A,ve=>{ae(o)?ve(B):ve(W,!1)})}var Ee=Me(Kn,2),we=Se(Ee),Z=Me(Se(we),2),ne=Se(Z),ee=Me(we,2);{var be=ve=>{var Re=rl(),Ot=ps(Re);{var jt=dr=>{var qn=jie(),uo=Se(qn),el=Se(uo),tl=Me(el,2),ho=Se(tl),Bs=Me(uo,2),ga=Se(Bs),ya=Me(Se(ga),2);{var uh=_t=>{var Gt=Uie(),mi=Se(Gt);Ft(po=>Nt(mi,`Valid (age: ${po??""}s)`),[()=>Math.round(ae(l).cacheAge/1e3)]),Oe(_t,Gt)},hh=_t=>{var Gt=Fie();Oe(_t,Gt)};Mt(ya,_t=>{ae(l).cacheValid?_t(uh):_t(hh,!1)})}var Hn=Me(ga,2);{var fo=_t=>{var Gt=Hie(),mi=Me(ps(Gt),2),po=Se(mi);{var Tr=En=>{var Wn=Vie(),Ls=Se(Wn),ba=Se(Ls);Ft(()=>Nt(ba,ae(l).addresses.direct)),Oe(En,Wn)};Mt(po,En=>{ae(l).addresses.direct&&En(Tr)})}var or=Me(po,2);{var zn=En=>{var Wn=Kie(),Ls=Se(Wn),ba=Se(Ls);Ft(()=>Nt(ba,ae(l).addresses.circuitRelay)),Oe(En,Wn)};Mt(or,En=>{ae(l).addresses.circuitRelay&&En(zn)})}var ma=Me(or,2);{var wa=En=>{var Wn=qie(),Ls=Se(Wn),ba=Se(Ls);Ft(()=>Nt(ba,ae(l).addresses.websocket)),Oe(En,Wn)};Mt(ma,En=>{ae(l).addresses.websocket&&En(wa)})}Oe(_t,Gt)},dh=_t=>{var Gt=zie();Oe(_t,Gt)};Mt(Hn,_t=>{ae(l).addresses?_t(fo):_t(dh,!1)})}var fh=Me(Hn,2);{var ph=_t=>{var Gt=Wie(),mi=Me(Se(Gt));Ft(()=>Nt(mi,` ${ae(l).error??""}`)),Oe(_t,Gt)};Mt(fh,_t=>{ae(l).error&&_t(ph)})}Ft(()=>{w8(el,1,`w-3 h-3 rounded-full ${ae(l).healthy?"bg-green-500":"bg-red-500"}`),Nt(ho,`Relay Server: ${ae(l).healthy?"Healthy":"Unhealthy"}`)}),Oe(dr,qn)},vn=dr=>{var qn=Gie();Oe(dr,qn)};Mt(Ot,dr=>{ae(l)?dr(jt):dr(vn,!1)})}Oe(ve,Re)},Fe=ve=>{var Re=Qie();Oe(ve,Re)};Mt(ee,ve=>{ae(u)?ve(be):ve(Fe,!1)})}Ft(()=>{Nt(ch,`TODO Items (${ae(t).length??""})`),Nt(lh,`Connected Peers (${ae(i).length??""})`),Nt(ne,ae(u)?"Hide Details":"Show Details")}),DD(yt,()=>ae(n),ve=>Le(n,ve)),va("keydown",yt,ve=>ve.key==="Enter"&&k()),b8(Vr,()=>ae(s),ve=>Le(s,ve)),va("click",Xc,k),va("click",Z,async()=>{Le(l,await yie()),Le(u,!ae(u))}),Oe(Ke,at)};Mt(ge,Ke=>{ae(c)?Ke(ke):Ke(Ue,!1)},!0)}Oe(Q,J)};Mt(L,Q=>{ae(a)?Q(z):Q(q,!1)})}var Y=Me(C,2),X=Se(Y);{var j=Q=>{var J=Xie(),ge=Me(Se(J),2),ke=Se(ge);Ft(()=>Nt(ke,ae(g))),Oe(Q,J)};Mt(X,Q=>{ae(g)&&Q(j)})}var me=Me(X,2);{var de=Q=>{var J=Zie(),ge=Me(Se(J),2),ke=Se(ge);Ft(()=>Nt(ke,ae(y))),Oe(Q,J)};Mt(me,Q=>{ae(y)&&Q(de)})}b8(P,()=>ae(w),Q=>Le(w,Q)),va("change",P,x),Oe(r,D),OE()}yD(eoe,{target:document.getElementById("app")});typeof window<"u"&&(window.debugTodos=async function(){if(!window.app){console.error("❌ window.app not available. Make sure P2P is initialized.");return}try{console.log("🔍 Starting todo database diagnostics..."),console.log("📊 Getting all todos...");const r=await window.app.getAllTodos();if(console.log("📈 Total todos found:",r.length),r.length===0){console.log("❌ No todos found in database");return}return r.forEach((e,t)=>{console.log(`
--- Todo ${t+1} ---`),console.log("ID:",e.id),console.log("Text:",JSON.stringify(e.text)),console.log("Text type:",typeof e.text),console.log("Text length:",e.text?e.text.length:"N/A"),console.log("Assignee:",JSON.stringify(e.assignee)),console.log("Completed:",e.completed),console.log("Created At:",e.createdAt),console.log("Created By:",e.createdBy),console.log("Created By (formatted):",e.createdBy?`${e.createdBy.slice(0,5)}...`:"unknown"),console.log("Full Object:",JSON.stringify(e,null,2));const n=[];e.text||n.push("Missing text"),e.text===""&&n.push("Empty text"),e.id||n.push("Missing ID"),e.createdAt||n.push("Missing createdAt"),e.createdBy||n.push("Missing createdBy"),n.length>0?console.log("⚠️ Issues found:",n.join(", ")):console.log("✅ Todo appears healthy")}),r}catch(r){console.error("❌ Error during todo diagnostics:",r)}},console.log("🎯 Debug function loaded! Run debugTodos() in the console to diagnose todo issues."));
